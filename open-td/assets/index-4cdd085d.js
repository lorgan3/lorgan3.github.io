var On=Object.defineProperty;var Yn=(n,t,e)=>t in n?On(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var a=(n,t,e)=>(Yn(n,typeof t!="symbol"?t+"":t,e),e);import{A as Fn,c as Xn,H as Nn,d as J,a as M,b,g as m,t as B,h as C,j as F,u as A,n as W,k as Dt,l as Ct,m as P,q as Se,s as Je,F as ut,v as Rt,w as R,x as ki,y as Oe,z as Un,B as Wt,C as Wn,D as As,E as ue,G as Ri,I as Hn,J as Di,K as Gn,L as Ps,M as Vn,N as cs}from"./vendor-266d2a32.js";import{C as dt,S as tt,P as Ue,A as jt,R as we,M as jn,G as We,T as ks,L as zn,F as Kn,r as qn,h as Zn,a as Jn,b as Ci,s as Qn,c as ta,d as ea,V as sa}from"./pixi-375869f8.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerpolicy&&(r.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?r.credentials="include":i.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();let ia=1;class et{constructor(t,e,s){a(this,"id");a(this,"rotation",0);this.x=t,this.y=e,this.agent=s,this.id=ia++}getX(){return this.x}getAlignedX(){return this.x|0}getY(){return this.y}getAlignedY(){return this.y|0}getAgent(){return this.agent}getId(){return this.id}setX(t){this.x=t}setY(t){this.y=t}getRotation(){return this.rotation}setRotation(t){this.rotation=t}move(t,e,s){const i=(e.getX()-t.getX())*s+t.getX(),r=(e.getY()-t.getY())*s+t.getY();this.setX(i),this.setY(r),this.lookAt(e)}lookAt(t,e){let s,i;e!==void 0?(s=t-this.x,i=e-this.y):(s=t.getX()-this.x,i=t.getY()-this.y),(s||i)&&this.setRotation(Math.atan2(i,s)*180/Math.PI+90)}}const Tt=n=>n.constructor.scale,pt=n=>{const t=Tt(n),e=n.getTile();return[e.getX()+t/2,e.getY()+t/2]};function ws(n){return n?"getTile"in n:!1}class X extends et{constructor(t,e,s){super(t,e,s)}getAgent(){return this.agent}}var T=(n=>(n[n.Unknown=0]="Unknown",n[n.Player=1]="Player",n[n.Enemy=2]="Enemy",n))(T||{}),c=(n=>(n[n.None=0]="None",n[n.Tower=1]="Tower",n[n.Slime=2]="Slime",n[n.Base=3]="Base",n[n.Bullet=4]="Bullet",n[n.Wall=5]="Wall",n[n.Mortar=6]="Mortar",n[n.Flamethrower=7]="Flamethrower",n[n.Flame=8]="Flame",n[n.Railgun=9]="Railgun",n[n.Rail=10]="Rail",n[n.ElectricFence=11]="ElectricFence",n[n.Fence=12]="Fence",n[n.Freezer=13]="Freezer",n[n.Tree=14]="Tree",n[n.Rock=15]="Rock",n[n.Radar=16]="Radar",n[n.PowerPlant=17]="PowerPlant",n[n.Blueprint=18]="Blueprint",n[n.Shockwave=19]="Shockwave",n[n.Armory=20]="Armory",n[n.Market=21]="Market",n[n.SpeedBeacon=22]="SpeedBeacon",n[n.Runner=23]="Runner",n[n.DamageBeacon=24]="DamageBeacon",n[n.Laser=25]="Laser",n[n.LaserBeam=26]="LaserBeam",n[n.Flier=27]="Flier",n[n.Tank=28]="Tank",n[n.Rocket=29]="Rocket",n[n.WavePoint=30]="WavePoint",n[n.Barracks=31]="Barracks",n[n.Tesla=32]="Tesla",n[n.Spark=33]="Spark",n[n.Excavator=34]="Excavator",n[n.Convert=35]="Convert",n[n.Terraform=36]="Terraform",n[n.EmergencyRecharge=37]="EmergencyRecharge",n[n.EmergencyRepair=38]="EmergencyRepair",n))(c||{});const Rs=new Set([3,16,17,20,21,31]),Bi=new Set([...Rs,1,6,7,9,14,15,22,24,25,5,32]);var $=(n=>(n[n.Undiscovered=0]="Undiscovered",n[n.Pending=1]="Pending",n[n.Discovered=2]="Discovered",n))($||{}),f=(n=>(n[n.Void=0]="Void",n[n.Grass=1]="Grass",n[n.Stone=2]="Stone",n[n.Water=3]="Water",n[n.Obstructed=4]="Obstructed",n[n.Wall=5]="Wall",n[n.Spore=6]="Spore",n[n.ElectricFence=7]="ElectricFence",n[n.Fence=8]="Fence",n[n.Freezer=9]="Freezer",n[n.Bridge=10]="Bridge",n[n.Dirt=11]="Dirt",n[n.Snow=12]="Snow",n[n.Sand=13]="Sand",n[n.Ice=14]="Ice",n[n.PlayerBuilding=15]="PlayerBuilding",n[n.Tree=16]="Tree",n[n.Rock=17]="Rock",n[n.Base=18]="Base",n))(f||{});const Ds=new Set([1,2,11,13,12]),He=new Set([...Ds,3,14,10,16,17]),na=new Set([...He,9,7,8]),aa={[c.Tower]:4,[c.Wall]:5,[c.Mortar]:4,[c.Flamethrower]:4,[c.Railgun]:4,[c.ElectricFence]:7,[c.Fence]:8,[c.Freezer]:9,[c.Radar]:18,[c.PowerPlant]:18,[c.Tree]:16,[c.Rock]:17,[c.Armory]:18,[c.Base]:18,[c.Market]:18,[c.SpeedBeacon]:4,[c.DamageBeacon]:4,[c.Laser]:4,[c.Barracks]:18,[c.Tesla]:4};class st{constructor(t,e,s=f.Void){a(this,"staticEntity",null);a(this,"hash");a(this,"actualType");a(this,"towers",[]);a(this,"linkedAgents");a(this,"discoveryStatus",$.Undiscovered);this.x=t,this.y=e,this.type=s,this.hash=`[${this.x}, ${this.y}]`,this.actualType=s}serialize(){return{x:this.x,y:this.y,type:this.type}}getX(){return this.x}getY(){return this.y}getBaseType(){return this.type}getType(){return this.actualType}getStaticEntity(){return this.staticEntity}hasStaticEntity(){return this.staticEntity!==null}setStaticEntity(t){if(this.staticEntity!==null)throw new Error("A tile can only have 1 static entity.");const e=t.getAgent();ws(e)&&e.getTile().getHash()===this.getHash()&&(e.updateTile(this),this.linkedAgents&&e.updateLinkedAgents&&e.updateLinkedAgents(this.linkedAgents)),this.staticEntity=t,this.actualType=aa[t.getAgent().getType()]||this.type}clearStaticEntity(){this.staticEntity=null,this.actualType=this.type}isStaticEntityRoot(){var t;return((t=this.staticEntity)==null?void 0:t.getAgent().getTile())===this}addTower(t){this.towers.includes(t)||this.towers.push(t)}setDiscoveryStatus(t){this.discoveryStatus=t}isDiscovered(){return this.discoveryStatus===$.Discovered}getDiscoveryStatus(){return this.discoveryStatus}isCoveredByTower(){return this.isDiscovered()&&this.towers.length>0}removeTower(t){this.towers.splice(this.towers.indexOf(t),1)}getAvailableTowers(){return this.towers.filter(t=>t.getCooldown()<=0)}getTowers(){return this.towers}addLinkedAgent(t){var s;this.linkedAgents||(this.linkedAgents=new Set),this.linkedAgents.add(t);const e=(s=this.staticEntity)==null?void 0:s.getAgent();e&&e.updateLinkedAgents&&e.updateLinkedAgents(this.linkedAgents)}removeLinkedAgent(t){var s;if(!this.linkedAgents)return;this.linkedAgents.delete(t);const e=(s=this.staticEntity)==null?void 0:s.getAgent();ws(e)&&e.updateLinkedAgents&&e.updateLinkedAgents(this.linkedAgents)}getLinkedAgents(){return this.linkedAgents}getHash(){return this.hash}sync(t){this.towers=t.towers,this.discoveryStatus=t.discoveryStatus}}const Fs=class{constructor(){a(this,"eventHandlers");Fs.instance=this,this.eventHandlers=new Map}addEventListener(t,e){return this.eventHandlers.has(t)?this.eventHandlers.get(t).add(e):this.eventHandlers.set(t,new Set([e])),()=>this.removeEventListener(t,e)}addEventListeners(t,e){const s=t.map(i=>this.addEventListener(i,e));return()=>s.forEach(i=>i())}removeEventListener(t,e){var s;(s=this.eventHandlers.get(t))==null||s.delete(e)}triggerEvent(t,...e){var s;(s=this.eventHandlers.get(t))==null||s.forEach(i=>i(...e))}static get Instance(){return this.instance}};let x=Fs;a(x,"instance");const Xs=class{constructor(t,e,s,i){a(this,"level",0);this.difficulty=t,this.base=e,this.surface=s,this.messageFn=i,Xs.instance=this,new x}getSurface(){return this.surface}getBase(){return this.base}getLevel(){return this.level}update(t){this.messageFn=t}getDifficulty(){return this.difficulty}static get Instance(){return this.instance}};let u=Xs;a(u,"instance");class Li{constructor(t){a(this,"entity");a(this,"category",T.Unknown);a(this,"hp",30);a(this,"renderData",{});this.tile=t,this.entity=new X(t.getX(),t.getY(),this)}getType(){return c.Tree}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return this.tile.isDiscovered()}}a(Li,"scale",1);class $i{constructor(t){a(this,"entity");a(this,"category",T.Unknown);a(this,"hp",30);a(this,"renderData",{});this.tile=t,this.entity=new X(t.getX(),t.getY(),this)}getType(){return c.Rock}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return this.tile.isDiscovered()}}a($i,"scale",1);const ra=(n,t,e)=>{const s=Fn(n),i=Xn(s),r=i(1,0)*193,o=i(0,1)*197,h=.048,l=.0077,d=.0025,g=.0194,p=.039,w=13,v=w*2,I=.1,L=.95,D={top:[],right:[],bottom:[],left:[]};for(let S=0;S<t;S++){let _=0;S<v?_=(v-S)*I:S>t-v&&(_=(v-t+S)*I),D.top[S]=(i(S*p,0)+1+_)*w,D.bottom[S]=(i(S*p,e*p)+1+_)*w}for(let S=0;S<e;S++){let _=0;S<v?_=(v-S)*I:S>e-v&&(_=(v-e+S)*I),D.right[S]=(i(t*p,S*p)+1+_)*w,D.left[S]=(i(0,S*p)+1+_)*w}return(S,_)=>{if(_<D.top[S]||_>e-D.bottom[S]||S<D.left[_]||S>t-D.right[_])return new st(S,_,f.Void);const j=S+r,lt=_+o,At=i(j*h,lt*h),Lt=i(j*d,lt*d),rs=Math.abs(Lt),Cn=i(j*l,lt*l),os=1-Math.abs(Cn),Pe=i(j*g,lt*g),Bn=Math.abs(Pe),$t=(Lt+Pe/3)*.83,ke=$t+rs*9241%1/3,Ln=os>L+$t/10,$n=os+At/3+Pe-.4>L+$t/2;if(Ln||$n)return Lt+rs*1811%1/7<-.6?new st(S,_,f.Ice):new st(S,_,f.Water);if(os>L+$t/15)return new st(S,_,f.Dirt);let Et;$t>.3?Et=new st(S,_,f.Sand):$t<-.5?Et=new st(S,_,f.Snow):Et=new st(S,_,f.Grass);const si=(Pe+.5)*(At-.5)+rs*5419%1/10;if(si<.07&&si>.04&&ke>-.4&&ke<.6){const hs=new Li(Et);Et.setStaticEntity(hs.entity)}else if((ke<-.5||ke>.7)&&Bn*2791%1>.99){const hs=new $i(Et);Et.setStaticEntity(hs.entity)}return Et}};var E=(n=>(n[n.StatUpdate=0]="StatUpdate",n[n.SurfaceChange=1]="SurfaceChange",n[n.BlackOut=2]="BlackOut",n[n.OpenBuildMenu=3]="OpenBuildMenu",n[n.CloseBuildMenu=4]="CloseBuildMenu",n[n.SelectPlaceable=5]="SelectPlaceable",n[n.ToggleShowCoverage=6]="ToggleShowCoverage",n[n.StartWave=7]="StartWave",n[n.EndWave=8]="EndWave",n[n.Unlock=9]="Unlock",n[n.Discover=10]="Discover",n[n.Spawn=11]="Spawn",n[n.Buy=12]="Buy",n[n.Sell=13]="Sell",n[n.HitBase=14]="HitBase",n[n.Lose=15]="Lose",n))(E||{});const Ke=class{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"hp",50);a(this,"renderData",{});this.tile=t,this.entity=new X(t.getX(),t.getY(),this)}spawn(){u.Instance.getSurface().getAdjacentTiles(this.tile,Ke.scale).forEach(t=>t.addLinkedAgent(this))}despawn(){u.Instance.getSurface().getAdjacentTiles(this.tile,Ke.scale).forEach(t=>t.removeLinkedAgent(this))}getType(){return c.DamageBeacon}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}};let de=Ke;a(de,"scale",2);const qe=class{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"hp",50);a(this,"renderData",{});this.tile=t,this.entity=new X(t.getX(),t.getY(),this)}spawn(){u.Instance.getSurface().getAdjacentTiles(this.tile,qe.scale).forEach(t=>t.addLinkedAgent(this))}despawn(){u.Instance.getSurface().getAdjacentTiles(this.tile,qe.scale).forEach(t=>t.removeLinkedAgent(this))}getType(){return c.SpeedBeacon}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}};let ge=qe;a(ge,"scale",2);function ii(n){return"getCooldown"in n}const oa=n=>n.constructor.range,zt=(n,t,e)=>{const s=u.Instance.getSurface(),i=new Set,r=()=>{const h=new Set(s.getEntityTiles(n));s.forCircle(n.entity.getX()+1,n.entity.getY()+1,t,l=>{s.forLine(n.entity.getX(),n.entity.getY(),l.getX(),l.getY(),d=>{if(d.addTower(n),i.add(d),!h.has(d)&&e&&e(d))return!1},{connected:!0})},{edgeOnly:!0})};r();const o=x.Instance.addEventListener(E.SurfaceChange,({affectedTiles:h})=>{for(const l of h)if(i.has(l)){i.forEach(d=>d.removeTower(n)),i.clear(),r();return}});return[()=>{i.forEach(h=>h.removeTower(n)),o()},i]},Kt=n=>{let t=1;return n.forEach(e=>{e instanceof ge&&(t+=.5)}),t},qt=n=>{let t=1;return n.forEach(e=>{e instanceof de&&(t+=.5)}),t},Oi=[[1,0],[-1,0],[0,1],[0,-1]],ha=[...Oi,[1,1],[-1,-1],[-1,1],[1,-1]];class ca{constructor(t){a(this,"map");a(this,"entities",[]);a(this,"deletedEntities",[]);a(this,"staticEntities",[]);a(this,"entitiesMap",new Map);a(this,"towers",new Set);a(this,"width");a(this,"height");a(this,"dirty",!1);a(this,"changedTiles",new Set);a(this,"addedAgents",new Set);a(this,"removedAgents",new Set);this.width=t.width,this.height=t.height;const e="buffer"in t?t.buffer:t.generate;this.initialize(e??((s,i)=>new st(s,i)))}serialize(){const t=new Uint8Array(this.map.length*3);for(let e=0;e<this.map.length;e++){const s=this.map[e],i=e*3;t[i]=s.getX(),t[i+1]=s.getY(),t[i+2]=s.getType()}return{width:this.width,height:this.height,buffer:t}}initialize(t){if(this.map=new Array(this.width*this.height),t instanceof Uint8Array)for(let e=0;e<this.map.length;e++){const s=e*3;this.map[e]=new st(t[s],t[s+1],t[s+2])}else for(let e=0;e<this.height;e++)for(let s=0;s<this.width;s++)this.map[e*this.width+s]=t(s,e);this.entities=[],this.deletedEntities=[],this.staticEntities=[],this.entitiesMap.clear(),Object.values(T).filter(e=>typeof e!="string").forEach(e=>this.entitiesMap.set(e,new Set))}getTile(t,e,s=!1){return t>=this.width||t<0||e>=this.height||e<0?s?this.getTile(Math.max(Math.min(t,this.width-1),0),Math.max(Math.min(e,this.height-1),0)):void 0:this.map[e*this.width+t]}getEntityTiles(t,e,s){let i;if(e)i=t;else{const r=t;i=r.getTile().getX(),e=r.getTile().getY(),s=Tt(r)}switch(s){case 1:return[this.map[e*this.width+i]];case 2:return[this.map[e*this.width+i],this.map[e*this.width+i+1],this.map[(e+1)*this.width+i],this.map[(e+1)*this.width+i+1]];default:throw new Error("Unsupported agent scale!")}}getAdjacentTiles(t,e=1,s=!1){return(s?ha:Oi).map(([i,r])=>this.getTile(t.getX()+i*e,t.getY()+r*e)).filter(i=>!!i)}setTile(t){this.setTileInternal(t)}setTiles(t){t.map(e=>this.setTileInternal(e))}setTileInternal(t){this.dirty=!0;const e=this.map[t.getY()*this.width+t.getX()];return e.hasStaticEntity()&&!t.hasStaticEntity()?t.setStaticEntity(e.getStaticEntity()):e.hasStaticEntity()&&this.despawnStatic(e.getStaticEntity().getAgent()),t.sync(e),this.map[t.getY()*this.width+t.getX()]=t,this.changedTiles.add(e),e}processChangedTiles(){this.changedTiles.size&&(x.Instance.triggerEvent(E.SurfaceChange,{affectedTiles:this.changedTiles,addedStaticAgents:this.addedAgents,removedStaticAgents:this.removedAgents}),this.changedTiles.clear(),this.addedAgents.clear(),this.removedAgents.clear())}getRow(t){const e=t*this.width;return this.map.slice(e,e+this.width)}getColumn(t){const e=new Array(this.height);for(let s=0;s<this.height;s++)e[s]=this.getTile(t,s);return e}getWidth(){return this.width}getHeight(){return this.height}forLine(t,e,s,i,r,o){const h=(o==null?void 0:o.scale)??1;t=Math.floor(t/h)*h,e=Math.floor(e/h)*h,s=Math.floor(s/h)*h,i=Math.floor(i/h)*h;const l=Math.atan2(i-e,s-t);return this.forRay(t,e,l,(d,g)=>!(r(d,g)===!1)&&!(d.getX()===s&&d.getY()===i),o)}forRay(t,e,s,i,r){const o=(r==null?void 0:r.connected)??!1,h=(r==null?void 0:r.scale)??1,l=Math.cos(s),d=Math.sin(s),g=Math.abs(l)+Math.abs(d);let p=Math.abs(l/g),w=Math.abs(d/g),v=(1+(p>w?w/p:p/w))*h;p*=v*Math.sign(l),w*=v*Math.sign(d);let I,L,D=0;for(;;){let O=!1;const S=Math.round(t/h)*h;let _=Math.round(e/h)*h;o&&I!==void 0&&Math.round(I/h)*h!==S&&Math.round(L/h)*h!==_&&(_=Math.round(L),O=!0);const j=this.getTile(S,_);if(!j||!i(j,D))break;O||(t+=p,e+=w),I=S,L=_,D++}}forRect(t,e,s,i,r,o){const h=(o==null?void 0:o.scale)??1;t=Math.floor(t/h)*h,e=Math.floor(e/h)*h,s=Math.floor(s/h)*h,i=Math.floor(i/h)*h;const l=(g,p)=>{const w=this.getTile(g,p);w&&r(w)},d=g=>{if(s>t)for(let p=t;p<=s;p+=h)l(p,g);else for(let p=t;p>=s;p-=h)l(p,g)};if(i>e)for(let g=e;g<=i;g+=h)d(g);else for(let g=e;g>=i;g-=h)d(g)}forCircle(t,e,s,i,r){const o=(r==null?void 0:r.edgeOnly)??!1,h=(r==null?void 0:r.scale)??1;t=Math.floor(t/h),e=Math.floor(e/h);let l=s/2;const d=l*l,g=(l-1)*(l-1),p=(w,v,I=0)=>{const L=w+I,D=v+I,O=L*L+D*D;if(O<d&&!(o&&O<g)){const S=this.getTile((t+w)*h,(e+v)*h,o);S&&i(S)}};if(s%2===0)for(let w=-l;w<l;w+=1)for(let v=-l;v<l;v+=1)p(v,w,.5);else{l=l|0;for(let w=-l;w<l+1;w+=1)for(let v=-l;v<l+1;v+=1)p(v,w)}}spawn(t){this.entities.push(t.entity),this.entitiesMap.get(t.category).add(t.entity),t.spawn&&t.spawn()}spawnStatic(t){this.getEntityTiles(t).forEach(s=>{s.setStaticEntity(t.entity),this.changedTiles.add(s)}),this.addedAgents.add(t),this.spawn(t),this.dirty=!0,ii(t)&&oa(t)>1&&this.towers.add(t)}despawn(t){const e=this.entities.indexOf(t.entity);e>=0&&this.entities.splice(e,1);const s=this.entitiesMap.get(t.category).delete(t.entity);return this.deletedEntities.push(t.entity),t.despawn&&t.despawn(),s}despawnStatic(t){this.getEntityTiles(t).forEach(s=>{s.clearStaticEntity(),this.changedTiles.add(s)}),this.removedAgents.add(t),this.despawn(t),this.dirty=!0,ii(t)&&this.towers.delete(t)}getEntities(){return this.entities}getEntitiesForCategory(t){return this.entitiesMap.get(t)}getDeletedEntities(){return this.deletedEntities}getStaticEntities(){return this.staticEntities}getTowers(){return this.towers}getTiles(){return this.map}markPristine(){this.dirty=!1,this.deletedEntities=[]}forceRerender(){this.dirty=!0}isDirty(){return this.dirty}}const Zt=(n,t)=>{const e=[],s=Tt(n),i=s===2?1:0;u.Instance.getSurface().forCircle(n.getTile().getX()+i,n.getTile().getY()+i,t*s,r=>{if(He.has(r.getBaseType())){r.hasStaticEntity()&&r.getStaticEntity().getAgent().category!==T.Player&&u.Instance.getSurface().despawnStatic(r.getStaticEntity().getAgent());const o=new st(r.getX(),r.getY(),f.Stone);e.push(o)}}),u.Instance.getSurface().setTiles(e)};class Yi{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"renderData",{});this.tile=t,this.entity=new X(t.getX(),t.getY(),this)}spawn(){u.Instance.getBase().addPart(this),Zt(this,3)}despawn(){u.Instance.getBase().removePart(this)}getType(){return c.Armory}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){u.Instance.getBase().hit(t)}isVisible(){return!0}}a(Yi,"scale",2);const la=.625;class vs{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"isEnabled",!0);a(this,"renderData",{});this.tile=t,this.entity=new X(t.getX(),t.getY(),this),t.addTower(this)}getCooldown(){return this.isEnabled?0:1}fire(t,e){if(!u.Instance.consumeContinuous(this,e))return 0;const s=la*e;return t.AI.hit(s),s}despawn(){this.tile.removeTower(this)}getType(){return c.ElectricFence}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.isEnabled=!1}isVisible(){return!0}isSpeedBoosted(){return!1}isDamageBoosted(){return!1}}a(vs,"scale",1),a(vs,"range",1);class Fi{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"renderData",{});this.tile=t,this.entity=new X(t.getX(),t.getY(),this)}getType(){return c.Fence}getTile(){return this.tile}updateTile(t){this.tile=t}isVisible(){return!0}}a(Fi,"scale",1);class Xi{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"renderData",{});this.tile=t,this.entity=new X(t.getX(),t.getY(),this)}getType(){return c.Freezer}getTile(){return this.tile}updateTile(t){this.tile=t}isVisible(){return!0}}a(Xi,"scale",2);class Ni{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"renderData",{});this.tile=t,this.entity=new X(t.getX(),t.getY(),this)}spawn(){u.Instance.getBase().addPart(this),Zt(this,3)}despawn(){u.Instance.getBase().removePart(this)}getType(){return c.Market}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){u.Instance.getBase().hit(t)}isVisible(){return!0}}a(Ni,"scale",2);class Ui{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"renderData",{});this.tile=t,this.entity=new X(t.getX(),t.getY(),this)}getType(){return c.PowerPlant}getTile(){return this.tile}updateTile(t){this.tile=t}spawn(){u.Instance.getBase().addPart(this),Zt(this,3)}despawn(){u.Instance.getBase().removePart(this)}hit(t){u.Instance.getBase().hit(t)}isVisible(){return!0}}a(Ui,"scale",2);var k=(n=>(n[n.Normal=0]="Normal",n[n.OnFire=1]="OnFire",n[n.Stunned=2]="Stunned",n))(k||{});class ua{constructor(t){a(this,"isBlocking",!0);this.index=t}isCleared(t){return!t[this.index].hasStaticEntity()}process(t,e,s){e.AI.attack(t[this.index].getStaticEntity().getAgent())}}const Qe=(n=Bi)=>t=>{const e=[];return t.forEach((s,i)=>{s.hasStaticEntity()&&n.has(s.getStaticEntity().getAgent().getType())&&e.push(new ua(i))}),e},ni=(n,t)=>({...n,...t}),ts={[f.Grass]:3,[f.Water]:20,[f.Stone]:4,[f.Wall]:3,[f.Spore]:2,[f.ElectricFence]:5,[f.Fence]:20,[f.Freezer]:6,[f.Obstructed]:3,[f.Bridge]:5,[f.Dirt]:2.5,[f.Sand]:3.5,[f.Snow]:3.5,[f.Ice]:10,[f.PlayerBuilding]:3,[f.Tree]:5,[f.Rock]:5,[f.Base]:Number.EPSILON},es={[f.Fence]:5,[f.ElectricFence]:40,[f.Wall]:500,[f.Freezer]:.5,[f.Obstructed]:500,[f.PlayerBuilding]:-10},da={[f.Grass]:3,[f.Water]:3,[f.Stone]:3,[f.Wall]:3,[f.Spore]:3,[f.ElectricFence]:3,[f.Fence]:3,[f.Freezer]:6,[f.Obstructed]:3,[f.Bridge]:3,[f.Dirt]:3,[f.Sand]:3,[f.Snow]:3,[f.Ice]:3,[f.PlayerBuilding]:3,[f.Tree]:3,[f.Rock]:3,[f.Base]:Number.EPSILON},ga={[f.Fence]:3,[f.ElectricFence]:3,[f.Wall]:5,[f.Tree]:4,[f.Rock]:3,[f.Freezer]:.5,[f.Obstructed]:5,[f.PlayerBuilding]:-10},Z=600;class ss{constructor(t,e){a(this,"predictedHp");a(this,"cooldown",0);a(this,"callback");this.enemy=t,this.hp=e,this.predictedHp=e}tick(t){if(this.cooldown<t&&this.callback&&(this.callback(),this.callback=void 0),this.cooldown=Math.max(0,this.cooldown-t),this.enemy.getPath().isPaused(this.enemy)&&!this.isBusy()){const e=this.enemy.getPath().getTile();this.enemy.entity.setX(e.getX()),this.enemy.entity.setY(e.getY());const s=this.enemy.getPath().getNextCheckpoint();s&&s.process(this.enemy.getPath().getTiles(),this.enemy,t)}if(this.isBusy())this.getTargeted(this.enemy.getPath().getCurrentTile(),t);else{this.enemy.isVisible()||this.enemy.getPath().fastForward(this.enemy);const{from:e,to:s,step:i}=this.enemy.getPath().performStep(this.enemy,t);this.enemy.entity.move(e,s,i),this.getTargeted(e,t)}}attack(t){t.hit&&this.cooldown===0&&(t.hit(this.enemy.getDamage()*u.Instance.getDamageMultiplier()),this.cooldown=this.enemy.isVisible()?Z:0)}interact(t,e=Z){this.callback=t,this.cooldown===0&&this.enemy.isVisible()&&(this.cooldown=e)}getTargeted(t,e){if(this.predictedHp>0&&this.enemy.isVisible()){for(let s of t.getAvailableTowers())if(this.predictedHp-=s.fire(this.enemy,e),this.predictedHp<=0)break}}hit(t){this.hp-=t,this.hp<this.predictedHp&&(this.predictedHp=this.hp),this.hp<=0&&u.Instance.despawnEnemy(this.enemy)}miss(t){this.predictedHp+=t}isAttacking(){return this.cooldown!==0}isBusy(){return this.isAttacking()||this.enemy.getStatus()===k.Stunned}getFuturePosition(t){const e=this.enemy.getPath().getFuturePosition(t),s=this.enemy.getPath().getCheckpoints();for(let i=0;i<s.length;i++){let r=s[i];if(r.index>e)return e;if(r.isBlocking)return r.index-1}return e}}const Wi=new Set(Bi);Wi.delete(c.Tree);const pa=Qe(Wi),fa=3e3,ma=1e3,ya=.01,wa=.025,va=30;var mt;let Ht=(mt=class{constructor(t,e){a(this,"entity");a(this,"category",T.Enemy);a(this,"status",k.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new et(t.getX(),t.getY(),this),this.ai=new ss(this,va)}initializePath(){this.path.setSpeed(wa),this.path.setCheckpoints(pa(this.path.getTiles()))}get AI(){return this.ai}getDamage(){return 4}getType(){return mt.type}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status!==k.Normal&&(this.statusDuration-=t,this.statusDuration<=0?this.status=k.Normal:this.status===k.OnFire&&this.ai.hit(ya*t)),this.ai.tick(t)}isVisible(){return this.path.getTile().isDiscovered()}lightOnFire(){this.status=k.OnFire,this.statusDuration=fa}stun(){this.status=k.Stunned,this.statusDuration=ma}},a(mt,"pathCosts",ni(ts,{[f.Tree]:3})),a(mt,"pathMultipliers",ni(es,{[f.Water]:2})),a(mt,"type",c.Runner),a(mt,"cost",5),mt);class Mt{constructor(t,e,s,i,r,o=[]){a(this,"index",0);a(this,"sectionIndex",0);a(this,"tileSet");this.pathfinder=t,this.tiles=e,this.sections=s,this.speed=i,this.costs=r,this.checkpoints=o,this.tileSet=new Set(e)}performStep(t,e){const s=this.index%1,i=this.index|0,r=this.tiles[i],o=this.speed*e/(this.costs[i]??1);let h=this.index+o|0;i===h&&h++,h>=this.tiles.length-1&&(h=this.tiles.length-1);const l=this.tiles[h];for(;this.checkpoints.length>0;){const g=this.checkpoints[0];if(g&&h>=g.index)if(g.isCleared(this.tiles,t))this.checkpoints.shift();else return this.index=g.index-1,{from:this.tiles[this.index],to:l,step:0};else break}const d=this.costs[h]??1;for(this.index=Math.min(this.index+this.speed*e/d,this.tiles.length-1);this.index>this.sections[this.sectionIndex].to;)this.sectionIndex++;return{from:r,to:l,step:s}}getFuturePosition(t){let e=this.index,s=this.sectionIndex;for(;t>0;){const i=this.sections[s],r=i.to-e,o=r/this.speed*i.cost;if(t>o?(e+=r,s++,t-=o):(e+=r*t/o,t=0),e>=this.tiles.length-1)return this.tiles.length-1}return e}fastForward(t){let e=this.checkpoints[0];for(let s=(this.index|0)+1;s<this.tiles.length;s++){if(e&&s>=e.index)if(e.isCleared(this.tiles,t))this.checkpoints.shift(),e=this.checkpoints[0];else break;if(this.getTile(s).isDiscovered())break;this.index=s}}clone(){return new Mt(this.pathfinder,this.tiles,this.sections,this.speed,this.costs,[...this.checkpoints])}slice(t=0,e=Number.MAX_VALUE){const s=this.tiles.slice(t,e),i=this.costs.slice(t,e),r=Mt.calculateSections(s,i),o=this.checkpoints.filter(h=>h.index>=t&&h.index<e);return new Mt(this.pathfinder,s,r,this.speed,i,o)}setIndex(t){this.index=Math.max(Math.min(t,this.tiles.length-1),0),this.sectionIndex=this.sections.findIndex(({from:e,to:s})=>this.index>=e&&this.index<s)}getIndex(){return this.index}getTile(t=this.index){return this.tiles[t|0]}getTiles(){return this.tiles}getLength(){return this.tiles.length}getCoordinates(t=this.index){if(t>=this.tiles.length-1){const r=this.tiles[this.tiles.length-1];return{x:r.getX(),y:r.getY()}}const e=t%1,s=this.tiles[t|0],i=this.tiles[(t|0)+1];return{x:(i.getX()-s.getX())*e+s.getX(),y:(i.getY()-s.getY())*e+s.getY()}}getSpeed(){return this.speed}setSpeed(t){this.speed=t}isDone(){return this.index===this.tiles.length-1}isPaused(t){if(this.isDone())return!0;const e=this.getNextCheckpoint();return e&&e.index===this.index+1&&!e.isCleared(this.tiles,t)}getNextCheckpoint(){return this.checkpoints[0]||null}getCheckpoints(){return this.checkpoints}setCheckpoints(t){this.checkpoints=t}getCurrentTile(){return this.tiles[this.index|0]}recompute(){const t=this.pathfinder.getSurface();let e;for(let s=0;s<this.tiles.length;s++){const i=this.tiles[s],r=t.getTile(i.getX(),i.getY());this.tiles[s]=r,this.costs[s]=this.pathfinder.getCost(r,e)??1,e=r,i!==r&&(this.tileSet.delete(i),this.tileSet.add(r))}this.sections=Mt.calculateSections(this.tiles,this.costs)}isAffectedByTiles(t){for(let e of t)if(this.tileSet.has(e))return!0;return!1}static calculateSections(t,e){return t.reduce((s,i,r)=>{const o=s[s.length-1],h=e[r];return o?(o.cost===h?o.to++:s.push({from:r,to:r+1,cost:h}),s):[{from:r,to:r+1,cost:h}]},[])}static fromTiles(t,e,s=1){const i=new Mt(t,e,[],s,[]);return i.recompute(),i}static fromMapAndCosts(t,e,s,i,r=1){let o=s;const h=[o];for(;o!==e;)o=i.get(o.getHash()),h.push(o);return this.fromTiles(t,h.reverse(),r)}}function Sa(){return new Worker("/open-td/assets/worker-e304bf15.js")}class Ea{constructor(t,e,s){a(this,"paths");a(this,"promise");a(this,"worker");this.pathfinder=t,this.startPoints=e,this.target=s}getPaths(){return this.paths?this.paths:(this.promise||this.createPromise(),[])}getAsyncPaths(){return this.promise||this.createPromise(),this.promise}getPathsSync(){if(!this.paths){const t=this.startPoints.map(s=>this.pathfinder.getSurface().getTile(s.getX(),s.getY())),e=this.pathfinder.getSurface().getTile(this.target.getX(),this.target.getY());this.paths=this.pathfinder.getHivePath(t,e).filter(s=>!!s)}return this.promise=Promise.resolve(this.paths),this.paths}createPromise(){this.promise=new Promise(t=>{const e=this.pathfinder.getSurface(),{width:s,height:i,buffer:r}=e.serialize(),o={width:s,height:i,buffer:r.buffer,costs:this.pathfinder.costs,costMultiplier:this.pathfinder.costMultipliers,startPoints:this.startPoints.map(h=>h.serialize()),target:this.target.serialize()};this.worker=new Sa,this.worker.postMessage(o,[o.buffer]),this.worker.onmessage=({data:h})=>{this.paths=h.map(l=>Mt.fromTiles(this.pathfinder,l.map(({x:d,y:g})=>e.getTile(d,g)))),this.worker&&(this.worker.terminate(),this.worker=void 0),t(this.paths)}})}update(){this.paths=void 0,this.promise=void 0,this.worker&&(this.worker.terminate(),this.worker=void 0)}}const Ma=[[0,-1],[-1,0],[1,0],[0,1],[-1,-1],[1,-1],[-1,1],[1,1]],Ia=150;class ba{constructor(t,e=es,s=ts){this.surface=t,this.costMultipliers=e,this.costs=s}getPath(t,e,s){const i=s??(v=>this.costMultipliers[v.getType()]??1),r=new Set,h=(this.costs[t.getType()]??1)*i(t),l=new Map;l.set(t.getHash(),h);const d=new Map;d.set(t.getHash(),h);const g=new Map;g.set(t.getHash(),h+this.heuristic(t,e));const p=new Nn((v,I)=>(g.get(v.getHash())??1/0)-(g.get(I.getHash())??1/0));p.push(t);const w=new Map;for(;!p.empty();){let v=p.pop();if(e===v)return Mt.fromMapAndCosts(this,t,e,w);const I=v.getHash(),L=Ma.map(([O,S])=>this.surface.getTile(O+v.getX(),S+v.getY())),D=[];this.setCostAndMultiplier(0,D,i,L[0]),this.setCostAndMultiplier(1,D,i,L[1]),this.setCostAndMultiplier(2,D,i,L[2]),this.setCostAndMultiplier(3,D,i,L[3]),this.setDiagonalCostAndMultiplier(4,0,1,D,i,L[4]),this.setDiagonalCostAndMultiplier(5,0,2,D,i,L[5]),this.setDiagonalCostAndMultiplier(6,1,3,D,i,L[6]),this.setDiagonalCostAndMultiplier(7,2,3,D,i,L[7]),L.forEach((O,S)=>{if(!O)return;const _=D[S*2];if(!_||r.has(O))return;const j=O.getHash(),lt=d.get(I)+D[S*2+1];if(lt<(d.get(j)??1/0)){const At=l.get(I)+_;l.set(j,At),w.set(j,v),d.set(j,lt),g.set(j,lt+this.heuristic(O,e)),p.push(O),r.add(v)}})}}getHivePath(t,e){const s={},i=r=>(s[r.getHash()]??1)*(this.costMultipliers[r.getType()]??1);return t.reduce((r,o,h)=>{const l=this.getPath(o,e,i);return r.push(l),l&&t.length>h-1&&l.getTiles().forEach(d=>{d.hasStaticEntity()&&(s[d.getHash()]=.85),s[d.getHash()]=s[d.getHash()]+.1||1.1}),r},[])}getCost(t,e){const s=h=>this.costs[h.getType()]??null;if(!e)return s(t);const i=s(t),r=s(e);if(!i||!r)return null;const o=(i+r)/2;return!i||!r||t.getX()===e.getX()||t.getY()==e.getY()?o:o+(s(this.surface.getTile(t.getX(),e.getY()))+s(this.surface.getTile(e.getX(),t.getY())))/4}getSurface(){return this.surface}heuristic(t,e){return Math.abs(t.getX()-e.getX())+Math.abs(t.getY()-e.getY())}setCostAndMultiplier(t,e,s,i){if(!i)return;const r=this.costs[i.getType()];r&&(e[t*2]=r,e[t*2+1]=r*s(i))}setDiagonalCostAndMultiplier(t,e,s,i,r,o){if(!o||!i[e*2]||!i[s*2])return;const h=i[e*2+1]+i[s*2+1];if(h>Ia)return;const l=this.costs[o.getType()];l&&(i[t*2]=l+(i[e*2]+i[s*2])/4,i[t*2+1]=l*r(o)+h/4)}}const Ze=class{constructor(t,e,s){a(this,"index",0);a(this,"pathData",new Map);a(this,"strength",0);a(this,"unit",Ht);a(this,"energy",25);a(this,"spawnInterval",200);a(this,"spawnDelay",0);a(this,"burstSize",Number.POSITIVE_INFINITY);a(this,"burstInterval",1e3);a(this,"burst",0);a(this,"timer",0);a(this,"centerX",0);a(this,"centerY",0);this.spawnPoints=t,this.target=e,this.surface=s,t.forEach(i=>{this.centerX+=i.getX(),this.centerY+=i.getY()}),this.centerX/=t.length,this.centerY/=t.length}setUnit(t){this.unit=t}getUnitType(){return this.unit.type}setParameters(t,e,s,i,r){this.energy=t,this.spawnInterval=e,this.spawnDelay=s,this.burstSize=i,this.burstInterval=r,this.burst=0,this.timer=0}getEnergy(){return this.energy}tick(t){if(!(this.energy===0||!this.isReady())){if(this.timer+=t,this.spawnDelay>0)if(this.timer>this.spawnDelay)this.timer-=this.spawnDelay,this.spawnDelay=0;else return;if(this.burst>=this.burstSize)if(this.timer>=this.burstInterval)this.timer-=this.burstInterval,this.burst=0;else return;if(this.timer>=this.spawnInterval){this.timer-=this.spawnInterval,this.energy=Math.max(0,this.energy-this.unit.cost),this.burst++;const e=this.getNextUnit();u.Instance.spawnEnemy(e)}}}getCenter(){return[this.centerX,this.centerY]}getPathData(t){return this.pathData.has(t)||this.pathData.set(t,new Ea(new ba(this.surface,this.unit.pathMultipliers,this.unit.pathCosts),this.spawnPoints,this.target)),this.pathData.get(t)}isReady(){return!!this.getPathData(this.unit.type).getPaths().length}getSpawnPoints(){return this.getPathData(this.unit.type).getPaths()}getAsyncSpawnPoints(){return this.getPathData(this.unit.type).getAsyncPaths()}getNextSpawnPoint(){const t=this.getSpawnPoints(),e=t[this.index];return this.index=(this.index+1)%t.length,e}getNextUnit(){const t=this.getNextSpawnPoint().clone(),e=new this.unit(t.getTile(),t);return e.initializePath(),e}grow(){this.strength++}getStrength(){return this.strength}isExposed(){let t=0,e=0;return this.surface.forCircle(this.centerX,this.centerY,Ze.Radius,s=>{t++,s.getDiscoveryStatus()!==$.Undiscovered&&e++}),e/t}rePath(){this.pathData.forEach(t=>t.update())}static fromTiles(t,e,s){return new Ze(t,e,s)}};let It=Ze;a(It,"Radius",5);const Hi=(n,t)=>(n%t+t)%t,gt=(n,t,e)=>n+(t-n)*e,Ta=(n,t,e)=>{if(n===t)return t;const s=Hi(t-n+180,360)-180;return s<0?(n-Math.min(-s,e)+360)%360:n+Math.min(s,e)};let _a=class{constructor(t){a(this,"entity");a(this,"category",T.Unknown);a(this,"renderData",{});a(this,"targetX",0);a(this,"targetY",0);a(this,"travelTime",0);a(this,"time",0);a(this,"sourceX",0);a(this,"sourceY",0);this.tile=t,this.entity=new et(t.getX()+.5,t.getY()+.5,this),this.sourceX=this.entity.getX(),this.sourceY=this.entity.getY()}tick(t){if(this.travelTime>0&&this.time<this.travelTime){this.time+=t;const e=Math.min(1,this.time/this.travelTime);this.entity.setX(gt(this.tile.getX(),this.targetX,e)),this.entity.setY(gt(this.tile.getY(),this.targetY,e)),this.time>=this.travelTime&&u.Instance.getSurface().despawn(this)}}discover(){const t=u.Instance.getBase(),[e,s]=pt(t);this.targetX=e,this.targetY=s,this.travelTime=Math.sqrt((e-this.tile.getX())**2+(s-this.tile.getY())**2)*60}getType(){return c.WavePoint}isVisible(){return this.travelTime>0}};var H=(n=>(n.Easy="easy",n.Normal="normal",n.Hard="hard",n))(H||{});const ai={easy:{label:"Easy",description:"Allows checking which tiles are covered by tower sight lines. Shows the approximate path enemies will take and undiscovered nests do not become stronger."},normal:{label:"Normal",description:"Allows checking which tiles are covered by tower sight lines. Enemies are a bit stronger and undiscovered nests slowly gain more strength."},hard:{label:"Hard",description:"Checking tower sight lines is no longer possible, enemies are stronger and undiscovered nests gain strength more quickly."}};class Yt{constructor(t,e,s=[]){this.min=t,this.max=e,this.units=s}getRange(){return[this.min,this.max]}getCenter(){return(this.min+this.max)/2}getLength(){return this.max-this.min}getUnits(){return this.units}addUnit(t){this.units.includes(t)||this.units.push(t),this.units.sort((e,s)=>s-e)}equals(t){return this.min===t.min&&this.max===t.max}toString(){return`[${this.min}, ${this.max}]`}static forSpawnGroup(t){const[e,s]=t.getCenter(),i=u.Instance.getBase().getTile(),r=e-i.getX(),o=s-i.getY(),h=(Math.atan2(o,r)*180/Math.PI+360)%360;switch(u.Instance.getDifficulty()){case H.Easy:return new Yt(Math.floor(h/15)*15,Math.floor(h/15)*15+15,[t.getUnitType()]);case H.Normal:return new Yt(Math.floor(h/45)*45,Math.floor(h/45)*45+45,[t.getUnitType()]);case H.Hard:return new Yt(Math.floor(h/120)*120,Math.floor(h/120)*120+120,[t.getUnitType()])}}static forSpawnGroups(t){const e=new Map;return t.filter(s=>!s.isExposed()).forEach(s=>{const i=Yt.forSpawnGroup(s),r=e.get(i.toString());r?r.addUnit(s.getUnitType()):e.set(i.toString(),i)}),[...e.values()]}}const xa=(n,t)=>{const e=new Array(t).fill(0).map(Math.random),s=e.reduce((i,r)=>i+r);return e.map(i=>i/s*n)},Ft=()=>{let n=1-Math.random(),t=Math.random(),e=Math.sqrt(-2*Math.log(n))*Math.cos(2*Math.PI*t);return e=e/10+.5,e>1||e<0?Ft():e},Aa=Qe(Rs),Pa=3e3,ka=1e3,Ra=.01,Da=.006,Ca=80;var yt;let Ba=(yt=class{constructor(t,e){a(this,"entity");a(this,"category",T.Enemy);a(this,"status",k.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new et(t.getX(),t.getY(),this),this.ai=new ss(this,Ca)}initializePath(){this.path.setSpeed(Da),this.path.setCheckpoints(Aa(this.path.getTiles()))}get AI(){return this.ai}getDamage(){return 5}getType(){return yt.type}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status!==k.Normal&&(this.statusDuration-=t,this.statusDuration<=0?this.status=k.Normal:this.status===k.OnFire&&this.ai.hit(Ra*t)),this.ai.tick(t)}isVisible(){return this.path.getTile().isDiscovered()}lightOnFire(){this.status=k.OnFire,this.statusDuration=Pa}stun(){this.status=k.Stunned,this.statusDuration=ka}},a(yt,"pathCosts",da),a(yt,"pathMultipliers",ga),a(yt,"type",c.Flier),a(yt,"cost",12),yt);const Gi=(n,...t)=>{const e=[];return t.filter(Boolean).forEach(s=>e.push(...s(n))),e.sort((s,i)=>s.index-i.index),e},Ss=(n,t)=>{if(n>Math.random())return t},Es=new Set([f.Grass,f.Snow]);class La{constructor(t){a(this,"isBlocking",!1);this.index=t}isCleared(t,e){return!Es.has(t[this.index-1].getType())}process(t,e,s){const i=u.Instance.getSurface(),r=t[this.index-1];Es.has(r.getType())&&i.setTile(new st(r.getX(),r.getY(),f.Dirt))}}const Vi=n=>{const t=[],e=Math.random()*n.length/10,s=n.filter(i=>Es.has(i.getType()));for(let i=0;i<e&&s.length;i++){const r=s.splice(Math.floor(Math.random()*s.length),1)[0];t.push(new La(n.indexOf(r)+1))}return t};class ri{constructor(t){a(this,"isBlocking",!0);this.index=t}isCleared(t,e){return!this.getTiles(t[this.index],e).length}process(t,e,s){const i=u.Instance.getSurface(),r=t[this.index],o=this.getTiles(r,e);if(o.length>0){const h=o[0];e.entity.lookAt(h),e.AI.interact(()=>{i.getTile(h.getX(),h.getY()).getType()===f.Water&&i.setTile(new st(h.getX(),h.getY(),f.Bridge))})}}getTiles(t,e){const s=u.Instance.getSurface(),i=[];return t.getType()===f.Water&&i.push(t),e.entity.getAlignedX()!==t.getX()&&e.entity.getAlignedY()!==t.getY()&&[[e.entity.getAlignedX(),t.getY()],[t.getX(),e.entity.getAlignedY()]].forEach(([r,o])=>{const h=s.getTile(r,o);(h==null?void 0:h.getType())===f.Water&&i.push(h)}),i}}const $a=n=>{const t=[];for(let e=0;e<n.length;e++)n[e].getType()===f.Water&&(t.push(new ri(e)),e+1<n.length&&n[e+1].getType()!==f.Water&&t.push(new ri(e+1)));return t},Oa=Qe(),Ya=3e3,Fa=1e3,Xa=.01,Na=.01,Ua=100;var wt;let Wa=(wt=class{constructor(t,e){a(this,"entity");a(this,"category",T.Enemy);a(this,"status",k.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new et(t.getX(),t.getY(),this),this.ai=new ss(this,Ua)}initializePath(){this.path.setSpeed(Na),this.path.setCheckpoints(Gi(this.path.getTiles(),Oa,Ss(.5,Vi),Ss(.1,$a)))}get AI(){return this.ai}getDamage(){return 6}getType(){return wt.type}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status!==k.Normal&&(this.statusDuration-=t,this.statusDuration<=0?this.status=k.Normal:this.status===k.OnFire&&this.ai.hit(Xa*t)),this.ai.tick(t)}isVisible(){return this.path.getTile().isDiscovered()}lightOnFire(){this.status=k.OnFire,this.statusDuration=Ya}stun(){this.status=k.Stunned,this.statusDuration=Fa}},a(wt,"pathCosts",ts),a(wt,"pathMultipliers",es),a(wt,"type",c.Slime),a(wt,"cost",7),wt);const Ha=Qe(),Ga=3e3,Va=1e3,ja=.01,za=.008,Ka=200;var vt;let qa=(vt=class{constructor(t,e){a(this,"entity");a(this,"category",T.Enemy);a(this,"status",k.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new et(t.getX(),t.getY(),this),this.ai=new ss(this,Ka)}initializePath(){this.path.setSpeed(za),this.path.setCheckpoints(Gi(this.path.getTiles(),Ha,Ss(.5,Vi)))}get AI(){return this.ai}getDamage(){return 8}getType(){return vt.type}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status!==k.Normal&&(this.statusDuration-=t,this.statusDuration<=0?this.status=k.Normal:this.status===k.OnFire&&this.ai.hit(ja*t)),this.ai.tick(t)}isVisible(){return this.path.getTile().isDiscovered()}lightOnFire(){this.status=k.OnFire,this.statusDuration=Ga}stun(){this.status=k.Stunned,this.statusDuration=Va}},a(vt,"pathCosts",ts),a(vt,"pathMultipliers",es),a(vt,"type",c.Tank),a(vt,"cost",20),vt);const Za=4e3,Ja=150,Qa=550,tr=500,er=3e3,sr=3,ir=12,nr=1.1,ar={[H.Easy]:0,[H.Normal]:1.5*Ht.cost,[H.Hard]:3*Ht.cost};class pe{constructor(t){this.spawnGroups=t}isDone(){return!this.spawnGroups.find(t=>t.getEnergy()>0)}getSpawnGroups(){return this.spawnGroups}tick(t){this.spawnGroups.forEach(e=>e.tick(t))}static fromSpawnGroups(t,e){const s=(1+t**2)*Ht.cost,i=xa(s,e.length),r=ar[u.Instance.getDifficulty()];return e.forEach((o,h)=>{const l=i[h]*nr+r*o.getStrength(),d=h===0||Math.random()>.5?0:Ft()*Za,g=Math.random()>.5?Ft()*ir+sr:Number.POSITIVE_INFINITY;o.setParameters(l,Ft()*Qa/Math.max(1,t/3)+Ja,d,g,Ft()*er+tr)}),new pe(e)}static getUnitForLevel(t){if(t===0)return Ht;const e=Math.random();return e<Math.min(.2,.75-t**2/100)?Ht:t>=3&&e>Math.max(.7,1-t/50)?Ba:e>.1+t/25?Wa:qa}}const Ns=class{constructor(t,e){a(this,"spawnGroups",[]);a(this,"nextSpawnGroup");a(this,"initialNextSpawnGroup");a(this,"direction",Math.random()*Math.PI*2);a(this,"wave");a(this,"timeSinceLastExpansion",0);a(this,"onSurfaceChange",({affectedTiles:t,removedStaticAgents:e})=>{const s=this.isWaveInProgress();this.spawnGroups.forEach(r=>{s?r.getSpawnPoints().forEach(o=>{o.isAffectedByTiles(t)&&o.recompute()}):(e.size>0||r.getSpawnPoints().find(h=>h.isAffectedByTiles(t)))&&r.rePath()});const i=this.getNextSpawnGroup();!s&&i&&(e.size>0||i.getSpawnPoints().find(o=>o.isAffectedByTiles(t)))&&i.rePath()});this.base=t,this.surface=e,Ns.instance=this,x.Instance.addEventListener(E.SurfaceChange,this.onSurfaceChange)}tick(t){this.wave&&this.wave.tick(t)}startNewWave(){const t=u.Instance.getLevel();it.Instance.hasPendingAgents()&&(this.timeSinceLastExpansion=0),this.spawnGroups.forEach(i=>{i.grow(),i.rePath()}),this.direction+=(Math.random()>.5?1:-1)*Math.max(Math.PI/6*Ft()*Math.min(Math.PI*2,t+1));const e=[],s=this.getNextSpawnGroup();s&&e.push(s),s!==this.initialNextSpawnGroup&&e.push(this.initialNextSpawnGroup),e.forEach(i=>{this.timeSinceLastExpansion=0;const[r,o]=i.getCenter(),h=[];this.surface.forCircle(r,o,It.Radius,l=>{He.has(l.getType())&&(h.push(new st(l.getX(),l.getY(),f.Spore)),l.hasStaticEntity()&&this.surface.despawnStatic(l.getStaticEntity().getAgent()))}),this.surface.setTiles(h),this.spawnGroups.push(i)}),this.cleanupSpawnGroups(),this.nextSpawnGroup=void 0,this.initialNextSpawnGroup=void 0,this.wave=pe.fromSpawnGroups(t,[...this.spawnGroups])}processWave(){return this.isWaveInProgress()?!1:(this.timeSinceLastExpansion++,this.spawnGroups.forEach(t=>t.setUnit(pe.getUnitForLevel(u.Instance.getLevel()))),!0)}cleanupSpawnGroups(){for(let t=this.spawnGroups.length-1;t>=0;t--){const e=this.spawnGroups[t];if(e.isExposed()>0){this.spawnGroups.splice(t,1),it.Instance.uncoverSpawnGroup(e);const s=new _a(this.surface.getTile(...e.getCenter()));this.surface.spawn(s),s.discover()}}}getWave(){return this.wave}getSpawnGroups(){const t=this.spawnGroups.filter(e=>e.isExposed()===0);if(!this.isWaveInProgress()){const e=this.getNextSpawnGroup();e&&t.push(e)}return t}getSpawnAlertRanges(){return Yt.forSpawnGroups(this.getSpawnGroups())}isWaveInProgress(){return this.wave&&!this.wave.isDone()?!0:this.surface.getEntitiesForCategory(T.Enemy).size>0}shouldAddSpawnGroup(){if(this.initialNextSpawnGroup&&!this.initialNextSpawnGroup.isExposed())return!0;const t=Math.ceil(2**this.spawnGroups.length/3),e=it.Instance.hasPendingAgents()?0:this.timeSinceLastExpansion;return this.spawnGroups.filter(i=>i.isExposed()===0).length===0||e>=t}getNextSpawnGroup(){if(!this.shouldAddSpawnGroup())return;if(this.nextSpawnGroup&&!this.nextSpawnGroup.isExposed())return this.nextSpawnGroup;if(this.initialNextSpawnGroup&&!this.initialNextSpawnGroup.isExposed())return this.nextSpawnGroup=this.initialNextSpawnGroup,this.nextSpawnGroup;let t=!1,e=3;for(let s=0;s<20&&(this.surface.forRay(this.base.getTile().getX(),this.base.getTile().getY(),this.direction,i=>i.getDiscoveryStatus()!==$.Undiscovered?(e=4+Math.min(u.Instance.getLevel()/2,Math.floor(Math.random()*6)),!0):(e--,e>0?!0:(Math.random()>.66?!He.has(i.getType()):!Ds.has(i.getType()))?!(u.Instance.getLevel()===0&&s<10):(this.nextSpawnGroup=It.fromTiles([i,i,i,i],this.base.getTile(),this.surface),this.nextSpawnGroup.setUnit(pe.getUnitForLevel(u.Instance.getLevel())),t=!0,!1))),!t);s++)this.direction+=Math.PI/10;return this.initialNextSpawnGroup||(this.initialNextSpawnGroup=this.nextSpawnGroup),this.nextSpawnGroup}static get Instance(){return this.instance}};let q=Ns;a(q,"instance");const ls=n=>n.getType()===c.Base,Us=class{constructor(t){a(this,"discoveredSpawnGroups",new Set);a(this,"agents",new Set);a(this,"edgeMap",new Map);a(this,"pendingAgents",new Set);a(this,"base");a(this,"pendingRadius",0);a(this,"discoveredEdge",!1);a(this,"minX");a(this,"minY");a(this,"maxX");a(this,"maxY");this.surface=t,Us.instance=this}registerAgent(t){this.agents.add(t);let e=$.Pending;ls(t)?(this.base=t,e=$.Discovered):this.pendingAgents.add(t);const s=this.getVisibilityRange(t),i=this.getVisibilityEdge(t);this.edgeMap.set(t.entity.getId(),i),this.updateVisibility(...i,s,e)}removeAgent(t){if(!this.agents.has(t))return;ls(t)&&(this.base=void 0);const e=this.getVisibilityRange(t),s=this.edgeMap.get(t.entity.getId());this.surface.forCircle(...s,e,i=>i.setDiscoveryStatus($.Undiscovered)),this.agents.delete(t),this.pendingAgents.delete(t),this.edgeMap.delete(t.entity.getId()),this.update()}commit(){this.pendingAgents.clear(),this.pendingRadius=0,this.update()}update(){this.minX=void 0,this.minY=void 0,this.maxX=void 0,this.maxY=void 0,this.agents.forEach(s=>{const i=this.getVisibilityRange(s),r=this.edgeMap.get(s.entity.getId());this.surface.forCircle(...r,i,o=>o.setDiscoveryStatus($.Undiscovered))}),this.pendingRadius>0&&this.base&&this.updateVisibility(...this.getVisibilityEdge(this.base),this.pendingRadius,$.Pending),this.agents.forEach(s=>{const i=this.pendingAgents.has(s)?$.Pending:$.Discovered,r=this.getVisibilityRange(s),o=this.getVisibilityEdge(s);this.edgeMap.set(s.entity.getId(),o),this.updateVisibility(...o,r,i)});const t=[],e=q.Instance.getSpawnGroups();this.discoveredSpawnGroups.forEach(s=>{if(s.isExposed()===0){t.push(s);return}const i=s.getCenter();this.updateVisibility(...i,5,$.Discovered)}),e.forEach(s=>{const[i,r]=s.getCenter();this.surface.forCircle(i,r,It.Radius,o=>{o.getDiscoveryStatus()!==$.Undiscovered&&o.setDiscoveryStatus($.Undiscovered)})}),t.forEach(s=>this.discoveredSpawnGroups.delete(s))}updateBaseRange(){if(!this.base)throw new Error("Updating base range without a base");this.pendingRadius=this.getVisibilityRange(this.base),this.updateVisibility(...this.getVisibilityEdge(this.base),this.pendingRadius,$.Pending)}getBBox(){return[[this.minX,this.minY],[this.maxX,this.maxY]]}hasPendingAgents(){return this.pendingAgents.size>0}uncoverSpawnGroup(t){const e=q.Instance.getSpawnGroups();this.discoveredSpawnGroups.add(t);const[s,i]=t.getCenter();this.updateVisibility(s,i,It.Radius,$.Discovered),e.forEach(r=>{const[o,h]=r.getCenter();this.surface.forCircle(o,h,It.Radius,l=>{l.getDiscoveryStatus()!==$.Undiscovered&&l.setDiscoveryStatus($.Undiscovered)})}),x.Instance.triggerEvent(E.Discover,{x:s,y:i})}isEdgeDiscovered(){return this.discoveredEdge}getVisibilityRange(t){switch(t.getType()){case c.Base:return 35+(u.Instance.getLevel()-(this.pendingRadius>0?1:0))*2;case c.Radar:return 21;default:throw new Error("Entity has no visibility defined")}}getVisibilityEdge(t){if(ls(t)||!this.base)return[t.entity.getAlignedX(),t.entity.getAlignedY()];let e;const s=Math.atan2(t.entity.getAlignedY()-this.base.entity.getAlignedY(),t.entity.getAlignedX()-this.base.entity.getAlignedX());return this.surface.forRay(this.base.entity.getAlignedX(),this.base.entity.getAlignedY(),s,i=>i.getDiscoveryStatus()===$.Undiscovered?!1:(e=i,!0)),e?[e.getX(),e.getY()]:[t.entity.getAlignedX(),t.entity.getAlignedY()]}updateVisibility(t,e,s,i){(!this.minX||t-s/2<this.minX)&&(this.minX=t-s/2),(!this.minY||e-s/2<this.minY)&&(this.minY=e-s/2),(!this.maxX||t+s/2>this.maxX)&&(this.maxX=t+s/2),(!this.maxY||e+s/2>this.maxY)&&(this.maxY=e+s/2),this.surface.forCircle(t,e,s,r=>{i===$.Pending&&r.isDiscovered()||(i===$.Discovered&&r.getType()===f.Void&&(this.discoveredEdge=!0),r.setDiscoveryStatus(i))})}static get Instance(){return this.instance}};let Ye=Us;a(Ye,"instance");const it=Ye;class ji{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"renderData",{});this.tile=t,this.entity=new X(t.getX(),t.getY(),this)}getType(){return c.Radar}getTile(){return this.tile}updateTile(t){this.tile=t}spawn(){it.Instance.registerAgent(this),u.Instance.getBase().addPart(this),Zt(this,3)}despawn(){it.Instance.removeAgent(this),u.Instance.getBase().removePart(this)}hit(t){u.Instance.getBase().hit(t)}isVisible(){return!0}}a(ji,"scale",2);const rr=new Set([f.Obstructed,f.Wall,f.PlayerBuilding,f.Base]),Jt=n=>rr.has(n.getType()),Ms=250;let or=class{constructor(t){a(this,"entity");a(this,"category",T.Unknown);a(this,"time",0);a(this,"renderData",{});a(this,"sourceX");a(this,"sourceY");this.source=t;const[e,s]=pt(t);this.entity=new et(e,s,this),this.sourceX=e,this.sourceY=s}dealDamage(t,e){this.renderData.update=!0,this.time>Ms&&u.Instance.getSurface().spawn(this),this.time=0;const s=Math.atan2(t.entity.getX()+.5-this.sourceX,t.entity.getY()+.5-this.sourceY);this.entity.setRotation(s*180/Math.PI),this.source.entity.setRotation(-this.entity.getRotation()+180),this.entity.setX(t.entity.getAlignedX()),this.entity.setY(t.entity.getAlignedY()),t.AI.hit(e),t.lightOnFire&&t.lightOnFire()}tick(t){this.time+=t,this.time>Ms&&u.Instance.getSurface().despawn(this)}getType(){return c.Flame}isVisible(){return!0}};const oi=1,hr=.04,Ws=class{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"flame");a(this,"hp",160);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});this.tile=t,this.entity=new X(t.getX(),t.getY(),this)}tick(t){this.isEnabled&&(this.cooldown=Math.max(0,this.cooldown-t))}fire(t,e){this.cooldown=oi;const s=u.Instance.consumeContinuous(this,e,this.damageMultiplier*this.speedMultiplier),i=hr*(s?this.damageMultiplier*this.speedMultiplier:1)*e;return this.flame||(this.flame=new or(this),u.Instance.getSurface().spawn(this.flame)),this.flame.dealDamage(t,i),this.renderData.fired=!0,i}spawn(){[this.cleanupEventListener]=zt(this,Ws.range,Jt)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=Kt(t),this.damageMultiplier=qt(t)}getCooldown(){return this.cooldown}getType(){return c.Flamethrower}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=oi,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}};let ee=Ws;a(ee,"scale",2),a(ee,"range",6);class Cs{constructor(){a(this,"source");a(this,"target");a(this,"sourceX");a(this,"sourceY");a(this,"targetX");a(this,"targetY");a(this,"travelTime")}}function zi(n,t=0){const[e,s]=pt(this.source);this.sourceX=e,this.sourceY=s;const i=e-this.target.entity.getX()+.5,r=s-this.target.entity.getY()+.5,o=Math.sqrt(i*i+r*r)+t;this.travelTime=o/n;const h=this.target.AI.getFuturePosition(this.travelTime),{x:l,y:d}=this.target.getPath().getCoordinates(h);this.targetX=l+.5,this.targetY=d+.5}const cr=.01,hi=5,ci=2,lr=ci*ci;let ur=class extends Cs{constructor(e,s,i){super();a(this,"entity");a(this,"category",T.Unknown);a(this,"renderData",{});a(this,"time",0);a(this,"prevX");a(this,"prevY");a(this,"straightY",0);this.source=e,this.target=s,this.damage=i,zi.call(this,cr,hi*2),this.entity=new et(this.sourceX,this.sourceY,this),this.entity.lookAt(this.targetX,this.targetY),this.source.entity.setRotation(this.entity.getRotation()),this.entity=new et(this.sourceX,this.sourceY,this),this.entity.lookAt(this.targetX,this.targetY),this.source.entity.setRotation(this.entity.getRotation())}tick(e){if(this.time>=this.travelTime){u.Instance.getSurface().despawn(this);let r=!1;[...u.Instance.getSurface().getEntitiesForCategory(T.Enemy)].filter(o=>{const h=o.getX()-this.entity.getX(),l=o.getY()-this.entity.getY();return h*h+l*l<lr}).forEach(o=>{o.getAgent().AI.hit(this.damage),o.getAgent()===this.target&&(r=!0)}),r||this.target.AI.miss(this.damage)}this.time=Math.min(this.time+e,this.travelTime);const s=this.time/this.travelTime,i=Math.sin(s*Math.PI)*hi;if(this.straightY=gt(this.sourceY,this.targetY,s),this.entity.setX(gt(this.sourceX,this.targetX,s)),this.entity.setY(this.straightY-i),this.prevX&&this.prevY){const r=this.entity.getX()-this.prevX,o=this.entity.getY()-this.prevY;this.entity.setRotation(Math.atan2(o,r)*180/Math.PI+90)}this.prevX=this.entity.getX(),this.prevY=this.entity.getY()}getType(){return c.Rocket}isVisible(){return!0}getPercentage(){return this.time/this.travelTime}};const li=5e3,dr=50,Hs=class{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"hp",80);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});this.tile=t,this.entity=new X(t.getX(),t.getY(),this)}tick(t){!this.isEnabled||this.cooldown<=0||(this.cooldown-=t*this.speedMultiplier)}fire(t){if(this.cooldown+=li,!u.Instance.consume(this,this.speedMultiplier,this.damageMultiplier))return 0;const e=dr*this.damageMultiplier,s=new ur(this,t,e);return u.Instance.getSurface().spawn(s),this.renderData.fired=!0,e}spawn(){[this.cleanupEventListener]=zt(this,Hs.range)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=Kt(t),this.damageMultiplier=qt(t)}getCooldown(){return this.cooldown}getType(){return c.Mortar}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=li,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}};let se=Hs;a(se,"scale",2),a(se,"range",30);const gr=(n,t,e,s,i)=>{const r=Math.atan2(i-t,s-n);let o=Hi(r-e+Math.PI,Math.PI*2)-Math.PI;return Math.abs(o)>=Math.PI?Number.POSITIVE_INFINITY:Math.abs(Math.cos(e)*(t-i)-Math.sin(e)*(n-s))},ve=(n,t,e,s)=>(n-e)**2+(t-s)**2,Bs=1500;let pr=class{constructor(t,e,s){a(this,"entity");a(this,"category",T.Unknown);a(this,"renderData",{});a(this,"targetX");a(this,"targetY");a(this,"time",0);this.source=t,this.damage=s;const[i,r]=pt(t);this.entity=new et(i,r,this);const o=Math.atan2(e.entity.getY()+.5-this.entity.getY(),e.entity.getX()+.5-this.entity.getX());this.entity.setRotation(o*180/Math.PI),this.source.entity.setRotation(this.entity.getRotation()+90),u.Instance.getSurface().forRay(e.entity.getX(),e.entity.getY(),o,l=>(this.targetX=l.getX(),this.targetY=l.getY(),!Jt(l)));const h=ve(this.entity.getX(),this.entity.getY(),this.targetX,this.targetY);[...u.Instance.getSurface().getEntitiesForCategory(T.Enemy)].filter(l=>ve(this.entity.getX(),this.entity.getY(),l.getX()+.5,l.getY()+.5)<=h+1).filter(l=>gr(this.entity.getX(),this.entity.getY(),o,l.getX()+.5,l.getY()+.5)<=.5).forEach(l=>{l.getAgent().AI.hit(this.damage)})}tick(t){this.time+=t,this.time>Bs&&u.Instance.getSurface().despawn(this)}getType(){return c.Rail}isVisible(){return!0}};const ui=5e3,fr=70,Gs=class{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"hp",80);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});this.tile=t,this.entity=new X(t.getX(),t.getY(),this)}tick(t){!this.isEnabled||this.cooldown<=0||(this.cooldown-=t*this.speedMultiplier)}fire(t){if(this.cooldown+=ui,!u.Instance.consume(this,this.speedMultiplier,this.damageMultiplier))return 0;const e=fr*this.damageMultiplier,s=new pr(this,t,e);return u.Instance.getSurface().spawn(s),this.renderData.fired=!0,e}spawn(){[this.cleanupEventListener]=zt(this,Gs.range,Jt)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=Kt(t),this.damageMultiplier=qt(t)}getCooldown(){return this.cooldown}getType(){return c.Railgun}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=ui,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}};let ie=Gs;a(ie,"scale",2),a(ie,"range",30);const mr=.015;class yr extends Cs{constructor(e,s,i){super();a(this,"entity");a(this,"category",T.Unknown);a(this,"renderData",{});a(this,"time",0);this.source=e,this.target=s,this.damage=i,zi.call(this,mr),this.entity=new et(this.sourceX,this.sourceY,this),this.entity.lookAt(this.targetX,this.targetY),this.source.entity.setRotation(this.entity.getRotation())}tick(e){this.time>=this.travelTime&&(u.Instance.getSurface().despawn(this),this.target.AI.hit(this.damage)),this.time=Math.min(this.time+e,this.travelTime);const s=this.time/this.travelTime;this.entity.setX(gt(this.sourceX,this.targetX,s)),this.entity.setY(gt(this.sourceY,this.targetY,s))}getType(){return c.Bullet}isVisible(){return!0}}const di=500,wr=10;var kt;let vr=(kt=class{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"hp",50);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});this.tile=t,this.entity=new X(t.getX(),t.getY(),this)}tick(t){!this.isEnabled||this.cooldown<=0||(this.cooldown-=t*this.speedMultiplier)}fire(t){this.cooldown+=di;const e=u.Instance.consume(this,this.speedMultiplier,this.damageMultiplier),s=wr*(e?this.damageMultiplier:1),i=new yr(this,t,s);return u.Instance.getSurface().spawn(i),this.renderData.fired=!0,s}spawn(){[this.cleanupEventListener]=zt(this,kt.range,Jt)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=Kt(t),this.damageMultiplier=qt(t)}getCooldown(){return this.cooldown}getType(){return c.Tower}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=di,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}},a(kt,"scale",2),a(kt,"range",10),kt);class Ki{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"hp",50);a(this,"renderData",{});this.tile=t,this.entity=new X(t.getX(),t.getY(),this)}getType(){return c.Wall}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}}a(Ki,"scale",2);const Ge=250;let Sr=class{constructor(t){a(this,"entity");a(this,"category",T.Unknown);a(this,"renderData",{});a(this,"time",0);a(this,"targetX",0);a(this,"targetY",0);this.source=t;const[e,s]=pt(t);this.entity=new et(e,s,this)}dealDamage(t,e){this.time>Ge&&u.Instance.getSurface().spawn(this),this.time=0,this.targetX=t.entity.getX()+.5,this.targetY=t.entity.getY()+.5;const s=Math.atan2(this.targetY-this.entity.getY(),this.targetX-this.entity.getX());this.entity.setRotation(s*180/Math.PI),this.source.entity.setRotation(this.entity.getRotation()+90),t.AI.hit(e),t.lightOnFire&&t.lightOnFire()}tick(t){this.time+=t,this.time>Ge&&u.Instance.getSurface().despawn(this)}getType(){return c.LaserBeam}isVisible(){return!0}};const gi=1,Er=.06,Mr=500,Vs=class{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"laserBeam");a(this,"hp",80);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});a(this,"lastTarget");this.tile=t,this.entity=new X(t.getX(),t.getY(),this)}tick(t){!this.isEnabled||this.cooldown<=0||(!this.laserBeam&&this.lastTarget&&this.entity.lookAt(this.lastTarget.entity),this.cooldown=Math.max(0,this.cooldown-t))}fire(t,e){if(this.lastTarget!==t)return this.lastTarget=t,this.cooldown=Mr,0;if(this.cooldown=gi,!u.Instance.consumeContinuous(this,e,this.damageMultiplier*this.speedMultiplier))return 0;const s=Er*this.damageMultiplier*this.speedMultiplier*e;return this.laserBeam||(this.laserBeam=new Sr(this),u.Instance.getSurface().spawn(this.laserBeam)),this.laserBeam.dealDamage(t,s),this.renderData.fired=!0,s}spawn(){[this.cleanupEventListener]=zt(this,Vs.range,Jt)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=Kt(t),this.damageMultiplier=qt(t)}getCooldown(){return this.cooldown}getType(){return c.Laser}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=gi,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}};let ne=Vs;a(ne,"scale",2),a(ne,"range",16);class qi{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"renderData",{});this.tile=t,this.entity=new X(t.getX(),t.getY(),this)}spawn(){u.Instance.getBase().addPart(this),Zt(this,3)}despawn(){u.Instance.getBase().removePart(this)}getType(){return c.Barracks}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){u.Instance.getBase().hit(t)}isVisible(){return!0}}a(qi,"scale",2);const Ir=.01,Is=800;let br=class extends Cs{constructor(e,s,i){super();a(this,"entity");a(this,"category",T.Unknown);a(this,"renderData",{});a(this,"time",0);a(this,"sectionTime",0);a(this,"index",-1);this.source=e,this.chain=s;const[r,o]=pt(e);this.sourceX=r,this.sourceY=o,s.forEach(h=>{h.AI.hit(i),h.stun&&h.stun()}),this.entity=new et(this.sourceX,this.sourceY,this),this.nextTarget()}nextTarget(){this.index++,this.index>=this.chain.length&&(this.entity.setX(this.sourceX),this.entity.setY(this.sourceY),this.index=0);const e=this.chain[this.index];this.targetX=e.entity.getX(),this.targetY=e.entity.getY(),this.travelTime=Math.sqrt(ve(this.entity.getX(),this.entity.getY(),this.targetX,this.targetY))/Ir,this.sectionTime=0,this.entity.lookAt(this.targetX,this.targetY)}tick(e){this.time>=Is&&u.Instance.getSurface().despawn(this),this.time+=e,this.sectionTime+=e,this.sectionTime>this.travelTime&&this.nextTarget();const s=this.sectionTime/this.travelTime;this.entity.setX(gt(this.sourceX,this.targetX,s)),this.entity.setY(gt(this.sourceY,this.targetY,s))}getChain(){return this.chain}getType(){return c.Spark}isVisible(){return!0}};const us=4e3,Tr=700,_r=50,js=class{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"coveredTiles");a(this,"hp",160);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});a(this,"charging",!1);this.tile=t,this.entity=new X(t.getX(),t.getY(),this)}tick(t){if(!(!this.isEnabled||this.cooldown<=0)&&(this.cooldown-=t*(this.charging?1:this.speedMultiplier),this.charging&&us-this.cooldown>Tr)){this.charging=!1;const e=u.Instance.getSurface(),s=[...u.Instance.getSurface().getEntitiesForCategory(T.Enemy)].filter(h=>this.coveredTiles.has(e.getTile(h.getAlignedX(),h.getAlignedY()))),i=new Map;s.forEach(h=>i.set(h.getId(),ve(h.getX(),h.getY(),...pt(this))));const r=[];s.sort((h,l)=>i.get(h.getId())-i.get(l.getId())).forEach(h=>{let l=i.get(h.getId()),d;r.forEach(g=>{const p=g[g.length-1],w=ve(h.getX(),h.getY(),p.getX(),p.getY());w<l&&(l=w,d=g)}),d?d.push(h):r.push([this.entity,h])});const o=_r*this.damageMultiplier;r.forEach(h=>{const l=new br(this,h.slice(1,h.length).map(d=>d.getAgent()),o);u.Instance.getSurface().spawn(l)})}}fire(){return this.cooldown+=us,u.Instance.consume(this,this.speedMultiplier,this.damageMultiplier)&&(this.charging=!0,this.renderData.fired=!0),0}spawn(){[this.cleanupEventListener,this.coveredTiles]=zt(this,js.range,Jt)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=Kt(t),this.damageMultiplier=qt(t)}getCooldown(){return this.cooldown}getType(){return c.Tesla}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=us,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}};let ae=js;a(ae,"scale",2),a(ae,"range",8);const Zi={name:"Fence",description:"A simple fence that land-based enemies have to walk around. If the fence becomes too long however, they will climb over it. Fences are low to towers can shoot over them.",entity:Fi,entityType:c.Fence,htmlElement:""},Ji={name:"Wall",description:"A large solid wall that land-based enemies have to walk around. A wall is equivalent to a tower that does not shoot meaning enemies will avoid them but will destroy them if left with no other option.",entity:Ki,entityType:c.Wall,htmlElement:""},xr={name:"Electric fence",description:"Electric fences are similar to their normal counterpart but enemies are far less likely to climb over them. If they do they will also continuously receive damage, given that you have enough power stored.",entity:vs,entityType:c.ElectricFence,htmlElement:""},Qi={name:"Freezer",description:"A large pad that slows down land-based enemies that walk over it. The pad does not repel or attract enemies so they still have to be guided to walk over it.",entity:Xi,entityType:c.Freezer,htmlElement:""},Ls={name:"Tower",description:"The cheapest and most basic tower. It has poor range and deals little damage.",entity:vr,entityType:c.Tower,htmlElement:""},tn={name:"Mortar",description:"A powerful tower with a large range that can shoot over obstacles. It also deals splash damage, hurting all enemies near the impact. Reload speed and travel time of the projectile is slow though.",entity:se,entityType:c.Mortar,htmlElement:""},en={name:"Flamethrower",description:"A turret intended for close range combat. It continuously hurts a single enemy within range. Enemies that were lit on fire will also keep burning for a while.",entity:ee,entityType:c.Flamethrower,htmlElement:""},sn={name:"Railgun",description:"A powerful tower with a large range that can pierce enemies. It shoots relatively fast and deals massive damage to an enemy and all enemies behind it at the cost of consuming power.",entity:ie,entityType:c.Railgun,htmlElement:""},Gt={name:"Sell",description:"Sell parts or blueprints. Blueprints and parts placed before the start of a wave are fully refunded. Other parts give back half their original cost when sold, but this can be improved by placing markets.",entityType:c.None,htmlElement:""},nn={name:"Radar",description:"A part of your base that exposes a large area in the direction that it was placed in. Exposed enemy bases are immediately neutralized when exposed by a radar.",entity:ji,entityType:c.Radar,htmlElement:"",isBasePart:!0},an={name:"Power plant",description:"A part of your base that generates an amount power at the start of every wave. Power can be stored across waves and is consumed by various towers. More power plants will generate more power but there are diminishing returns.",entity:Ui,entityType:c.PowerPlant,htmlElement:"",isBasePart:!0},Ar={name:"Armory",description:"A part of your base that regenerates hit points at the end of every wave. More armories will regenerate more hit points but there are diminishing returns.",entity:Yi,entityType:c.Armory,htmlElement:"",isBasePart:!0},rn={name:"Barracks",description:"A part of your base mainly intended for being able to place more turrets. It also regenerates a bit of hit points at the end of every wave. More barracks will regenerate more hit points but there are diminishing returns.",entity:qi,entityType:c.Barracks,htmlElement:"",isBasePart:!0},on={name:"Market",description:"A part of your base that increases the amount of money you get per wave and increases the percentage you get back when selling a part. More markets will increase the multiplier but there are diminishing returns.",entity:Ni,entityType:c.Market,htmlElement:"",isBasePart:!0},hn={name:"Speed Beacon",description:"A building that increases the reload speed of cardinally adjacent towers at the cost of some power for every shot fired. If there is no power (left) the towers will continue working as normal without a speed boost. Keep in mind that the beacon also blocks tower sight lines.",entity:ge,entityType:c.SpeedBeacon,htmlElement:""},cn={name:"Damage Beacon",description:"A building that increases the damage of cardinally adjacent towers at the cost of some power for every shot fired. If there is no power (left) the towers will continue working as normal without a damage boost. Keep in mind that the beacon also blocks tower sight lines.",entity:de,entityType:c.DamageBeacon,htmlElement:""},ln={name:"Laser",description:"A reasonably powerful tower that lights enemies on fire, similar to the flamethrower. It has a larger range but consumes power in order to fire.",entity:ne,entityType:c.Laser,htmlElement:""},un={name:"Tesla",description:"A tower that starts charging when an enemy comes near and then damages all enemies within its range.",entity:ae,entityType:c.Tesla,htmlElement:""},Pr={name:"Excavator",description:"Allows building over trees and rocks.",entityType:c.Excavator,htmlElement:"",cost:1},kr={name:"Terraform",description:"Allows building over water, ice and enemy structures. Keep in mind a stone foundation is also built which replaces the original surface.",entityType:c.Terraform,htmlElement:"",cost:1},dn=100,Rr={name:"Convert",description:`Convert a wave point in a flat ${dn} gold.`,entityType:c.Convert,htmlElement:"",isRepeatable:!0,cost:1},Ve=1.5,Dr={name:"Emerg. recharge",description:`Generate power for every base tile built. This can also be done during a wave, but doing it between waves is ${Ve} as efficient.`,entityType:c.EmergencyRecharge,htmlElement:"",isRepeatable:!0,cost:1},Cr={name:"Emerg. repair",description:`Regenerate health for every base tile built. This can also be done during a wave, but doing it between waves is ${Ve} as efficient.`,entityType:c.EmergencyRepair,htmlElement:"",isRepeatable:!0,cost:1};var $s=(n=>(n.Construction="Construction",n.Defensive="Defensive buildings",n.BasicBuildings="Basic buildings",n.PoweredBuildings="Powered Buildings",n.BaseBuildings="Base Buildings",n.WildcardBuildings="Wildcard Buildings",n.Abilities="Abilities",n))($s||{});const gn={Construction:[Gt,Pr,kr],["Defensive buildings"]:[Zi,Ji,un],["Basic buildings"]:[Ls,en,tn],["Powered Buildings"]:[an,ln,sn],["Base Buildings"]:[rn,nn,on],["Wildcard Buildings"]:[Qi,hn,cn],Abilities:[Rr,Dr,Cr]},Br=[Gt,Zi,Ji,xr,Qi,Ls,tn,en,sn,nn,an,Ar,on,hn,cn,ln,rn,un],Re=new Set(Br.map(n=>n.entityType));let bs=class{constructor(t,e,s){a(this,"entity");a(this,"category",T.Player);a(this,"renderData",{});this.tile=t,this.placeable=e,this.scaleOverride=s,this.entity=new et(t.getX(),t.getY(),this)}getType(){return c.Blueprint}getTile(){return this.tile}isVisible(){return!0}getPlaceable(){return this.placeable}getScale(){var t;return((t=this.placeable.entity)==null?void 0:t.scale)||this.scaleOverride||1}isDelete(){return this.placeable.entityType===c.None}isBasePart(){return!!this.placeable.isBasePart}};const Lr=n=>n.getType()===c.Blueprint,De=(n,t,e,s)=>{const i=e.getTile(),r=new Set([i]),o=s.getAdjacentTiles(i,2);for(;o.length>0;){const h=o.pop();n.has(h)||r.has(h)||!t.has(h)&&(!h.hasStaticEntity()||!e.getParts().has(h.getStaticEntity().getAgent()))||(r.add(h),s.getAdjacentTiles(h,2).forEach(l=>o.push(l)))}return r.size===e.getParts().size+t.size-n.size},$r=(n,t,e,s=!1)=>{const i=new Set([n]),r=t.getAdjacentTiles(n,2,s);for(;r.length>0;){const o=r.pop();i.has(o)||!o.hasStaticEntity()||!e.has(o.getStaticEntity().getAgent().getType())||(i.add(o),t.getAdjacentTiles(o,2,s).forEach(h=>r.push(h)))}return i.size},fe={[c.Fence]:1,[c.Wall]:3,[c.ElectricFence]:9,[c.Freezer]:6,[c.Tower]:12,[c.Flamethrower]:18,[c.Mortar]:40,[c.Railgun]:60,[c.Radar]:20,[c.PowerPlant]:20,[c.Armory]:50,[c.Market]:30,[c.SpeedBeacon]:50,[c.DamageBeacon]:40,[c.Laser]:25,[c.Barracks]:15,[c.Tesla]:50},Nt=class{constructor(t=0,e=()=>1){a(this,"recentlyBought",new Set);this.money=t,this.multiplier=e,Nt.instance=this,x.Instance.addEventListener(E.Unlock,({placeable:s})=>{s.entityType===c.Convert&&(this.addMoney(dn),u.Instance.triggerStatUpdate())})}setMoney(t){this.money=t}addMoney(t){this.money+=t}removeMoney(t){if(t>this.money)throw new Error("Not enough money!");this.money-=t}addWaveBudget(t){this.addMoney(Math.ceil((Nt.waveBudget+Nt.waveBudget*t/3)*this.multiplier()))}buy(t){let e=t.getType();Lr(t)&&(e=t.getPlaceable().entityType);const s=fe[e]??0;if(s>this.money)throw new Error("Not enough money!");this.removeMoney(s),this.recentlyBought.add(t)}replaceBlueprint(t,e){this.recentlyBought.has(t)&&(this.recentlyBought.delete(t),this.recentlyBought.add(e))}sell(t){t instanceof bs?this.addMoney(fe[t.getPlaceable().entityType]??0):this.addMoney(this.getValue(t))}getMoney(){return this.money}getMultiplier(){return this.multiplier()}clearRecents(){this.recentlyBought.clear()}isRecent(t){return this.recentlyBought.has(t)}getValue(t){const e=Math.min(.9,Nt.sellMultiplier*u.Instance.getBase().getMoneyFactor()),s=fe[t.getType()]??0;return Math.ceil(s*(this.recentlyBought.has(t)?1:e))}static get Instance(){return this.instance}};let N=Nt;a(N,"waveBudget",20),a(N,"sellMultiplier",.5),a(N,"instance");const zs=class{constructor(){a(this,"unlockedTowers");a(this,"availableUnlocks");a(this,"unlockLinkedMap");a(this,"points",0);a(this,"unlockedAmount",0);zs.instance=this,this.unlockedTowers=new Set,this.availableUnlocks=new Set,this.unlockLinkedMap=new Map,Object.values($s).forEach(t=>{const e=gn[t];e.forEach((s,i)=>{if(i===0){this.availableUnlocks.add(s.entityType),this.unlockedTowers.add(s.entityType);return}this.unlockedTowers.has(e[i-1].entityType)&&(this.availableUnlocks.add(s.entityType),s.isRepeatable&&this.unlockedTowers.add(s.entityType)),e.length>i+1&&this.unlockLinkedMap.set(s.entityType,e[i+1])})})}addPoint(){this.points++}getPoints(){return this.points}canUnlock(t){return this.availableUnlocks.has(t.entityType)&&this.points>=(t.cost??1)}isUnlocked(t){return this.unlockedTowers.has(t.entityType)}getUnlockAmount(){return this.unlockedAmount}unlock(t){if(!this.canUnlock(t))throw new Error(`Can't unlock ${t.entityType}`);this.points-=t.cost??1,this.makeAvailable(t),x.Instance.triggerEvent(E.Unlock,{placeable:t})}makeAvailable(t){this.unlockedTowers.add(t.entityType),t.isRepeatable||(this.availableUnlocks.delete(t.entityType),this.unlockedAmount++);const e=this.unlockLinkedMap.get(t.entityType);e&&(this.availableUnlocks.add(e.entityType),e.isRepeatable&&this.makeAvailable(e))}static get Instance(){return this.instance}};let bt=zs;a(bt,"instance");const rt=class{constructor(t){a(this,"blueprints",new Map);a(this,"pendingBaseAdditions",[]);a(this,"pendingBaseRemovals",[]);a(this,"freeTiles");a(this,"ignoredEntities");this.surface=t,rt.instance=this,this.freeTiles=new Set(Ds),this.ignoredEntities=new Set,x.Instance.addEventListener(E.Unlock,({placeable:e})=>{e.entityType===c.Excavator&&(this.freeTiles.add(f.Tree),this.freeTiles.add(f.Rock),this.ignoredEntities.add(c.Tree),this.ignoredEntities.add(c.Rock)),e.entityType===c.Terraform&&(this.freeTiles.add(f.Water),this.freeTiles.add(f.Ice),this.freeTiles.add(f.Spore),this.freeTiles.add(f.Bridge))})}getMaxTowers(){return 1+(u.Instance.getBase().getParts().size+1)*rt.towersPerPart}build(t,e){if(e.entityType===c.None){u.Instance.getIsStarted()?this.sellBlueprints(t):this.sellEntities(t);return}!Re.has(e.entityType)||!bt.Instance.isUnlocked(e)||(u.Instance.getIsStarted()?this.placeBlueprints(t,e):this.placeEntities(t,e))}commit(){const t=[];this.blueprints.forEach(e=>{const s=e.getTile(),i=this.surface.getEntityTiles(s.getX(),s.getY(),e.getScale());if(this.surface.despawn(e),i.forEach(h=>{if(!h.hasStaticEntity())return;const l=h.getStaticEntity().getAgent();N.Instance.sell(l),this.surface.despawnStatic(l)}),e.isDelete())return;const r=e.getPlaceable().entity,o=new r(s);this.spawn(o),N.Instance.replaceBlueprint(e,o),t.push(s)}),this.pendingBaseAdditions=[],this.pendingBaseRemovals=[],this.blueprints.size!==0&&(this.blueprints.clear(),u.Instance.triggerStatUpdate(),t.length>0&&x.Instance.triggerEvent(E.Buy,{tiles:t}))}placeBlueprints(t,e){const s=t.filter(i=>this.checkIsFree(i,e.entity.scale,!0));if(e.isBasePart){const{pendingBaseAdditions:i,pendingBaseRemovals:r}=this.getPendingTiles(t);if(!De(r,i,u.Instance.getBase(),this.surface)){u.Instance.showMessage("Not all tiles connect to the base");return}}s.length===0||!u.Instance.canBuy(e,s.length)||(s.forEach(i=>{this.surface.getEntityTiles(i.getX(),i.getY(),e.entity.scale).forEach(h=>{const l=this.blueprints.get(h.getHash());l&&(N.Instance.sell(l),this.freeBlueprint(l),l.isBasePart()?this.pendingBaseAdditions.splice(this.pendingBaseAdditions.indexOf(l),1):h.hasStaticEntity()&&rt.baseParts.has(h.getStaticEntity().getAgent().getType())&&this.pendingBaseRemovals.splice(this.pendingBaseRemovals.indexOf(l),1),l.isDelete()&&h.hasStaticEntity()&&rt.baseParts.has(h.getStaticEntity().getAgent().getType())&&this.pendingBaseRemovals.splice(this.pendingBaseRemovals.indexOf(l),1))});const o=new bs(i,e);N.Instance.buy(o),this.reserveBlueprint(o),e.isBasePart&&(!i.hasStaticEntity()||!rt.baseParts.has(i.getStaticEntity().getAgent().getType()))&&this.pendingBaseAdditions.push(o)}),u.Instance.triggerStatUpdate())}sellBlueprints(t){const e=t.find(o=>this.blueprints.has(o.getHash()));let s=t.filter(o=>e?!!this.blueprints.has(o.getHash()):!!(o.hasStaticEntity()&&Re.has(o.getStaticEntity().getAgent().getType())));const{baseTiles:i,otherTiles:r}=this.splitTiles(s);if(i.length){const{pendingBaseAdditions:o,pendingBaseRemovals:h}=this.getPendingTiles(i,!0);De(h,o,u.Instance.getBase(),this.surface)||(s=r,u.Instance.showMessage("Not all base parts can be sold"))}s.length!==0&&(s.forEach(o=>{if(e){const h=this.blueprints.get(o.getHash());h&&(h.isDelete()||(N.Instance.sell(h),o.hasStaticEntity()&&rt.baseParts.has(o.getStaticEntity().getAgent().getType())&&this.pendingBaseRemovals.splice(this.pendingBaseRemovals.indexOf(h),1)),h.isBasePart()&&(!o.hasStaticEntity()||!rt.baseParts.has(o.getStaticEntity().getAgent().getType()))&&this.pendingBaseAdditions.splice(this.pendingBaseAdditions.indexOf(h),1),this.freeBlueprint(h),o.hasStaticEntity()&&rt.baseParts.has(o.getStaticEntity().getAgent().getType())&&this.pendingBaseRemovals.splice(this.pendingBaseRemovals.indexOf(h),1));return}if(o.hasStaticEntity()&&!this.blueprints.get(o.getHash())){const h=o.getStaticEntity().getAgent(),l=new bs(h.getTile(),Gt,Tt(h));this.reserveBlueprint(l),rt.baseParts.has(h.getType())&&this.pendingBaseRemovals.push(l)}}),u.Instance.triggerStatUpdate())}placeEntities(t,e){if(e.entity.range>1&&this.surface.getTowers().size>=this.getMaxTowers()){u.Instance.showMessage("The base needs to be extended to support additional towers");return}const i=t.filter(r=>this.checkIsFree(r,e.entity.scale));if(e.isBasePart&&!De(new Set,new Set(i),u.Instance.getBase(),this.surface)){u.Instance.showMessage("Not all tiles connect to the base");return}i.length===0||!u.Instance.canBuy(e,i.length)||(i.forEach(r=>{const o=new e.entity(r);this.surface.getEntityTiles(o).forEach(h=>{h.hasStaticEntity()&&this.surface.despawnStatic(h.getStaticEntity().getAgent())}),this.spawn(o),N.Instance.buy(o)}),u.Instance.triggerStatUpdate(),x.Instance.triggerEvent(E.Buy,{tiles:i}))}sellEntities(t){let e=t.filter(r=>!!(r.hasStaticEntity()&&Re.has(r.getStaticEntity().getAgent().getType())));const{baseTiles:s,otherTiles:i}=this.splitTiles(e);if(s.length){const{pendingBaseAdditions:r,pendingBaseRemovals:o}=this.getPendingTiles(s,!0);De(o,r,u.Instance.getBase(),this.surface)||(e=i,u.Instance.showMessage("Not all base parts can be sold"))}e.length!==0&&(e.forEach(r=>{if(r.hasStaticEntity()){const o=r.getStaticEntity().getAgent();this.surface.despawnStatic(o),N.Instance.sell(o)}}),u.Instance.triggerStatUpdate(),x.Instance.triggerEvent(E.Sell))}splitTiles(t){const e=new Set,s=[];return t.forEach(i=>{const r=this.blueprints.get(i.getHash());if(r&&r.isBasePart()){e.add(r.getTile());return}i.hasStaticEntity()&&rt.baseParts.has(i.getStaticEntity().getAgent().getType())?e.add(i.getStaticEntity().getAgent().getTile()):s.push(i)}),{baseTiles:[...e],otherTiles:s}}getPendingTiles(t,e=!1){const s=new Set(this.pendingBaseAdditions.map(o=>this.surface.getTile(o.entity.getAlignedX(),o.entity.getAlignedY()))),i=new Set(this.pendingBaseRemovals.map(o=>this.surface.getTile(o.entity.getAlignedX(),o.entity.getAlignedY())));let r=o=>{s.delete(o)||i.delete(o)||i.add(o)};return t.forEach(o=>{if(e){r(o);return}const h=this.blueprints.get(o.getHash());if(h){if(h.isDelete()){i.delete(o);return}s.add(o);return}s.add(o)}),{pendingBaseAdditions:s,pendingBaseRemovals:i}}checkIsFree(t,e,s=!1){return!this.surface.getEntityTiles(t.getX(),t.getY(),e).find(r=>{if(!this.freeTiles.has(r.getBaseType())||r.hasStaticEntity()&&!this.ignoredEntities.has(r.getStaticEntity().getAgent().getType())&&(!s||!Re.has(r.getStaticEntity().getAgent().getType())))return!0})}reserveBlueprint(t){this.surface.spawn(t);const e=t.getTile();this.surface.getEntityTiles(e.getX(),e.getY(),t.getScale()).forEach(s=>this.blueprints.set(s.getHash(),t))}freeBlueprint(t){this.surface.despawn(t);const e=t.getTile();this.surface.getEntityTiles(e.getX(),e.getY(),t.getScale()).forEach(s=>this.blueprints.delete(s.getHash()))}spawn(t){this.surface.getEntityTiles(t).forEach(e=>{rt.surfacesRequiringFoundation.has(e.getBaseType())&&this.surface.setTile(new st(e.getX(),e.getY(),f.Stone))}),this.surface.spawnStatic(t)}static get Instance(){return this.instance}};let ht=rt;a(ht,"instance"),a(ht,"towersPerPart",2),a(ht,"baseParts",new Set([c.Armory,c.Radar,c.Market,c.PowerPlant])),a(ht,"surfacesRequiringFoundation",new Set([f.Water,f.Ice,f.Spore,f.Bridge]));var K=(n=>(n.Shift="Shift",n.Control="Control",n.Meta="Meta",n.Plus="+",n.Minus="-",n.Equals="=",n.Up="ArrowUp",n.Left="ArrowLeft",n.Right="ArrowRight",n.Down="ArrowDown",n.Escape="Escape",n.W="w",n.A="a",n.S="s",n.D="d",n.Z="z",n.Q="q",n.B="b",n.E="e",n.F="f",n))(K||{}),pn=(n=>(n.Single="single",n.Line="line",n.StraightLine="straightLine",n.grid="grid",n))(pn||{});const Or=new Set(Object.values(K));function pi(n){return Or.has(n)}const Ks=class{constructor(t){a(this,"mouseDownX",0);a(this,"mouseDownY",0);a(this,"mouseX",0);a(this,"mouseY",0);a(this,"pressedKeys",{});a(this,"_isMouseDown",!1);a(this,"eventHandlers",new Map);a(this,"selectedPlacable",Gt);a(this,"previousSelectedPlacable",Ls);a(this,"buildMenuOpen",!1);a(this,"isPaused",!1);this.surface=t,Ks.instance=this}getPlacable(){return this.selectedPlacable}setPlaceable(t){this.selectedPlacable=t,x.Instance.triggerEvent(E.SelectPlaceable,{placeable:t})}mouseDown(t,e){this.mouseDownX=t,this.mouseDownY=e,this._isMouseDown=!0}mouseMove(t,e){this.mouseX=t,this.mouseY=e}getSelection(){var i,r,o,h;if(!this._isMouseDown)return[];let t=this.mouseX,e=this.mouseY;if(this.pressedKeys.Control||this.pressedKeys.Meta){let l=[];return this.surface.forRect(this.mouseDownX,this.mouseDownY,t,e,d=>{d.isDiscovered()&&l.push(d)},{scale:((r=(i=this.selectedPlacable)==null?void 0:i.entity)==null?void 0:r.scale)||1}),l}this.pressedKeys.Shift&&(Math.abs(t-this.mouseDownX)>Math.abs(e-this.mouseDownY)?e=this.mouseDownY:t=this.mouseDownX);let s=[];return this.surface.forLine(this.mouseDownX,this.mouseDownY,t,e,l=>{l.isDiscovered()&&s.push(l)},{scale:((h=(o=this.selectedPlacable)==null?void 0:o.entity)==null?void 0:h.scale)||1}),s}mouseUp(t,e){if(!this.selectedPlacable){this._isMouseDown=!1;return}const s=this.getSelection();ht.Instance.build(s,this.selectedPlacable),this._isMouseDown=!1}keyDown(t){pi(t)&&(this.pressedKeys[t]=!0)}keyUp(t){var e;if(pi(t)){if(this.pressedKeys[t]=!1,this.isPaused&&t!=="Escape")return;if((e=this.eventHandlers.get(t))==null||e.forEach(s=>s()),(t==="b"||t==="e")&&this.toggleBuildMenu(),t==="f")if(this.selectedPlacable!==Gt)this.previousSelectedPlacable=this.selectedPlacable,this.setPlaceable(Gt);else{const s=this.previousSelectedPlacable;this.previousSelectedPlacable=this.selectedPlacable,this.setPlaceable(s)}}}toggleBuildMenu(){this.buildMenuOpen=!this.buildMenuOpen,this.buildMenuOpen?x.Instance.triggerEvent(E.OpenBuildMenu):x.Instance.triggerEvent(E.CloseBuildMenu)}isKeyDown(t){return this.pressedKeys[t]??!1}addKeyListener(t,e){return this.eventHandlers.has(t)?this.eventHandlers.get(t).add(e):this.eventHandlers.set(t,new Set([e])),()=>this.removeKeyListener(t,e)}removeKeyListener(t,e){var s;(s=this.eventHandlers.get(t))==null||s.delete(e)}isMouseDown(){return this._isMouseDown}getMouse(t){var s,i;const e=t||((i=(s=this.selectedPlacable)==null?void 0:s.entity)==null?void 0:i.scale)||1;return[Math.floor(this.mouseX/e)*e,Math.floor(this.mouseY/e)*e]}getMode(){return this._isMouseDown?this.pressedKeys.Control||this.pressedKeys.Meta?"grid":this.pressedKeys.Shift?"straightLine":"line":"single"}pause(){this.isPaused=!0}unpause(){this.isPaused=!1}static get Instance(){return this.instance}};let St=Ks;a(St,"instance");const je=(n,t,e)=>new Promise(s=>{const i=x.Instance.addEventListener(t,(...r)=>{(!e||e(...r))&&(i(),s())})}).then(()=>n),fn=(n,t,e)=>new Promise(s=>{const i=x.Instance.addEventListeners(t,r=>{(!e||e(r))&&(i(),s())})}).then(()=>n),is=(n,...t)=>e=>fn(u.Instance.showMessage(n,{override:e,expires:0}),t),Yr=is("Welcome to Open Tower Defense! Open the build menu by pressing {key: e}. You can also quickly select the most basic tower by pressing {key: f}.",E.OpenBuildMenu,E.StartWave),Fr=n=>new Promise(t=>{if(u.Instance.getIsStarted()){je(n,E.EndWave).then(t);return}je(u.Instance.showMessage("Here you can choose which defenses to build. Consider picking the basic tower to beat the first wave. Towers in the 2nd and 3rd row can be unlocked later in the game.",{override:n,expires:0}),E.SurfaceChange,({affectedTiles:e})=>!!e.size).then(t)}),Xr=n=>new Promise(t=>{const e=u.Instance.getDifficulty();if(e===H.Hard){t(n);return}fn(u.Instance.showMessage(`If you're new to the game you can click the {key: } button to view tower sight lines${e===H.Easy?" and enemy paths":" "} to check how effective your layout is.`,{override:n,expires:0}),[E.ToggleShowCoverage,E.StartWave]).then(t)}),Nr=n=>new Promise(t=>{if(u.Instance.getIsStarted()){je(n,E.EndWave).then(t);return}je(u.Instance.showMessage("Start the wave when you are ready. Good luck!",{override:n,expires:0}),E.EndWave).then(t)}),Ur=is("Good job defeating the first wave! Things will quickly become more difficult from here on out! After every wave your visible radius will increase. When enemy spawn points are discovered they are disabled and you receive a point to unlock new technologies.",E.Discover),Wr=is("You gained a wave point by discovering a spawn point! Open the build menu in order to spend it.",E.OpenBuildMenu),Hr=is("There are both defensive and offensive upgrades, read the descriptions to understand their strengths! You can also trade wave points for bonuses in the last column.",E.CloseBuildMenu),fi=[Yr,Fr,Xr,Nr,Ur,Wr,Hr];class Gr{constructor(){a(this,"promise");a(this,"reject");a(this,"previousId",-1)}async start(){this.promise=new Promise(async(t,e)=>{this.reject=e,await Promise.resolve();for(let s=0;s<fi.length;s++){const i=fi[s];try{this.previousId=await Promise.race([i(this.previousId),this.promise])}catch{return}}t(-1)});try{await this.promise}catch{}}stop(){var t;(t=this.reject)==null||t.call(this),this.reject=void 0,this.promise=void 0}get isStarted(){return!!this.promise}}const Ts={[c.ElectricFence]:.05,[c.Laser]:.003,[c.Railgun]:5,[c.Tesla]:4,[c.Mortar]:2},me=class{constructor(){a(this,"generators",new Set);a(this,"consumption",0);a(this,"blackout",!1);a(this,"power",0);me.instance=this}registerGenerator(t){this.generators.add(t)}removeGenerator(t){this.generators.delete(t)}getProduction(){return u.Instance.getBase().getPartsCount(c.PowerPlant)*me.powerMultiplier}getConsumption(){return this.consumption}consume(t){return t===0?!0:this.blackout?!1:(this.power-=t,this.power<0?(this.power=0,this.blackout=!0,x.Instance.triggerEvent(E.BlackOut),u.Instance.triggerStatUpdate(),!1):(this.consumption+=t,!0))}processPower(){this.power=this.power+this.getProduction(),this.blackout=!1,this.power<0&&x.Instance.triggerEvent(E.BlackOut),u.Instance.getIsStarted()||(this.consumption=0)}emergencyRegenerate(t=1){this.power=this.power+u.Instance.getBase().getParts().size*me.powerMultiplier*t,this.blackout=!1}getPower(){return this.power}static get Instance(){return this.instance}};let V=me;a(V,"speedBeaconConsumption",1.1),a(V,"damageBeaconConsumption",1.2),a(V,"instance"),a(V,"powerMultiplier",5);const Os=n=>(Dt("data-v-f9603b0c"),n=n(),Ct(),n),Vr={class:"sprite"},jr={class:"name"},zr={key:0,class:"lock"},Kr={class:"data"},qr={key:0},Zr=Os(()=>m("span",{class:"emoji"},"",-1)),Jr={key:1},Qr=Os(()=>m("span",{class:"emoji"},"",-1)),to={key:2},eo={key:3},so={key:4},io={key:5},no=Os(()=>m("span",{class:"emoji"},"",-1)),ao=J({__name:"Placeable",props:{item:null,locked:{type:Boolean},onSelect:{type:Function},selected:{type:Boolean}},setup(n){const t=n,e=fe[t.item.entityType],s=t.item.entity&&t.item.entity.range;return(i,r)=>(M(),b("button",{class:W({placeable:!0,"placeable--locked":t.locked,"placeable--selected":t.selected}),onClick:r[0]||(r[0]=o=>t.onSelect(n.item))},[m("span",Vr,B(t.item.htmlElement),1),m("span",jr,[C(B(t.item.name)+" ",1),t.locked?(M(),b("span",zr,"")):F("",!0)]),m("ul",Kr,[A(e)?(M(),b("li",qr,[Zr,C(" "+B(A(e)),1)])):F("",!0),A(s)?(M(),b("li",Jr,[Qr,C(" "+B(A(s)),1)])):F("",!0),A(Ts)[t.item.entityType]?(M(),b("li",to,"")):F("",!0),t.item.isBasePart?(M(),b("li",eo,"")):F("",!0),t.item.isRepeatable?(M(),b("li",so,"")):F("",!0),t.item.cost?(M(),b("li",io,[no,C(" "+B(t.item.cost),1)])):F("",!0)])],2))}});const nt=(n,t)=>{const e=n.__vccOpts||n;for(const[s,i]of t)e[s]=i;return e},ro=nt(ao,[["__scopeId","data-v-f9603b0c"]]),oo={class:"marketplace"},ho={class:"info"},co={class:"description"},lo={class:"section"},uo=["disabled"],go={class:"grid"},po={class:"column"},fo={class:"header"},mo={class:"item"},yo=J({__name:"Marketplace",props:{controller:null,unlocksController:null,eventSystem:null,visible:{type:Boolean}},setup(n){const t=n,e=P(t.controller.getPlacable()),s=ki();let i;Se(()=>{i=t.eventSystem.addEventListener(E.SelectPlaceable,({placeable:d})=>e.value=d)}),Je(()=>{i&&i()});const r=d=>{if(d===t.controller.getPlacable()){if(t.unlocksController.isUnlocked(d)){t.controller.toggleBuildMenu();return}if(t.unlocksController.canUnlock(d)){h();return}}t.controller.setPlaceable(d)},o=Object.values($s),h=()=>{t.unlocksController.unlock(e.value),s.proxy.$forceUpdate()},l=()=>{t.controller.toggleBuildMenu()};return(d,g)=>(M(),b("div",{class:W({"marketplace-wrapper":!0,"marketplace-wrapper--visible":t.visible})},[m("div",oo,[m("div",ho,[m("p",co,B(e.value?e.value.description:"Select a tower below."),1),m("div",lo,[C(B(t.unlocksController.getPoints())+" wave points ",1),e.value&&(!t.unlocksController.isUnlocked(e.value)||e.value.isRepeatable)?(M(),b("button",{key:0,disabled:!t.unlocksController.canUnlock(e.value),onClick:h}," Unlock "+B(e.value.name),9,uo)):F("",!0)]),m("button",{onClick:l,class:"close-button"},"")]),m("div",go,[(M(!0),b(ut,null,Rt(A(o),p=>(M(),b("div",po,[m("div",fo,B(p),1),(M(!0),b(ut,null,Rt(A(gn)[p],w=>{var v;return M(),b("div",mo,[R(ro,{item:w,locked:!t.unlocksController.isUnlocked(w),selected:((v=e.value)==null?void 0:v.entityType)===w.entityType,onSelect:r},null,8,["item","locked","selected"])])}),256))]))),256))])])],2))}});const wo=nt(yo,[["__scopeId","data-v-0ef1469a"]]);var Fe=(n=>(n[n.Growing=0]="Growing",n[n.Fixed=1]="Fixed",n))(Fe||{});class ds{constructor(t,e=0,s=10){a(this,"size");a(this,"freeEntities",[]);a(this,"usedEntities",new Map);this.initializer=t,this.type=e,this.size=s;for(let i=0;i<s;i++)this.freeEntities.push(t(!1))}get(t){let e=this.usedEntities.get(t);if(e)return e;if(this.freeEntities.length===0){if(this.type===1)throw new Error("Pool is empty");this.size++}return e=this.initializer(!0,this.freeEntities.pop(),t),this.usedEntities.set(t,e),e}free(t){if(!this.usedEntities.has(t))return;let e=this.usedEntities.get(t);return this.usedEntities.delete(t),this.freeEntities.push(e),e}getSize(){return this.size}getUsed(){return this.usedEntities}}const vo=(n,t,e)=>{const s=t.entity,i=s.getX(),r=s.getY(),o=Math.sqrt((i-t.targetX)**2+(r-t.targetY)**2);e.style.transformOrigin="0 0",e.style.opacity=`${1-.9*(t.time/Bs)}`,e.style.transform=`translate(${i*n.xStep}px, ${r*n.yStep}px) rotate(${s.getRotation()}deg) scale(${o}, 0.1)`},So=(n,t,e)=>{const s=t.entity;e.style.opacity=`${1-.9*(t.time/Ms)}`,e.style.transform=`translate(${(s.getX()+Math.random()*.3-.15)*n.xStep}px, ${(s.getY()+Math.random()*.3-.15)*n.yStep}px) rotate(${-s.getRotation()+180+Math.random()*10-5}deg)`},mi=1/4,gs=(n,t,e)=>{const s=t.entity,i=s.getId()%13/26-mi,r=(s.getId()+5)%17/34-mi,o=n.getTime()%13/3;let h=s.getRotation();t.AI.isAttacking()&&(h+=Math.sin(n.getTime()%Z/Z*5)*20),t.getStatus()===k.OnFire?(e.style.color="transparent",e.style.textShadow=`${Math.random()-.5}px ${Math.random()-.5}px ${o+2}px #E25822`):t.getStatus()===k.Normal&&(e.style.color="initial",e.style.textShadow="none"),e.style.transform=`translate(${(s.getX()+i)*n.xStep}px, ${(s.getY()+r)*n.yStep}px) rotate(${h}deg)`},Eo=1/4,Mo=1/8,Io=.0015,bo=(n,t,e)=>{const s=t.entity,i=Io*(1+s.getId()%13/13),r=Math.sin((n.getTime()+s.getId())*i)/4-Mo,o=Math.cos((n.getTime()+s.getId())*i)/2-Eo,h=n.getTime()%13/3,l=(s.getRotation()+360)%360,d=l>0&&l<180?-1:1;let g=0;t.AI.isBusy()&&(g+=Math.sin(n.getTime()%Z/Z*5)*20),t.getStatus()===k.OnFire?(e.style.color="transparent",e.style.textShadow=`${Math.random()-.5}px ${Math.random()-.5}px ${h+2}px #E25822`):t.getStatus()===k.Normal&&(e.style.color="initial",e.style.textShadow="none"),e.style.transform=`translate(${(s.getX()+r)*n.xStep}px, ${(s.getY()+o)*n.yStep}px) rotate(${g}deg) scale(${d},1)`},To=(n,t,e)=>{const s=t.entity;e.children[0].textContent=n.getStaticEntityEmoji(t.getPlaceable().entityType),e.style.transformOrigin="0 0",e.style.opacity="0.5",e.style.filter="grayscale(0.6)",e.style.transform=`translate(${s.getX()*n.xStep}px, ${s.getY()*n.yStep}px) rotate(${s.getRotation()}deg) scale(${t.getScale()})`},_o=(n,t,e)=>{const s=t.entity,i=s.getX(),r=s.getY(),o=Math.sqrt((i-t.targetX)**2+(r-t.targetY)**2);e.style.color="transparent",e.style.textShadow="0 0 0 #E25822",e.style.transformOrigin="0 0",e.style.opacity=`${1-.9*(t.time/Ge)}`,e.style.transform=`translate(${i*n.xStep}px, ${r*n.yStep}px) rotate(${s.getRotation()}deg) scale(${o}, 0.1)`},ps=(n,t,e)=>{const s=t.entity;e.style.transform=`translate(${(s.getX()-.5)*n.xStep}px, ${(s.getY()-.5)*n.yStep}px) rotate(${s.getRotation()}deg)`},xo={[c.Rail]:vo,[c.Flame]:So,[c.Slime]:gs,[c.Runner]:gs,[c.Flier]:bo,[c.Tank]:gs,[c.Blueprint]:To,[c.LaserBeam]:_o,[c.Bullet]:ps,[c.Rocket]:ps,[c.Shockwave]:ps},Ao=5e3,Po=J({__name:"Key",props:{char:null,area:null},setup(n){const t=n,e=t.char>"A"&&t.char<"z";return(s,i)=>(M(),b("div",{class:W({key:!0,emoji:!A(e)}),style:Oe({gridArea:t.area})},B(t.char),7))}});const Y=nt(Po,[["__scopeId","data-v-8be0d2b3"]]),ko=J({__name:"mouse",props:{button:null},setup(n){const t=n;return(e,s)=>(M(),b("div",{class:W(`mouse button-${t.button}`)},null,2))}});const Xe=nt(ko,[["__scopeId","data-v-135d4a7c"]]),Ro=J({__name:"TextWithControls",props:{text:null},setup(n){const t=n,e={0:"left",1:"right",3:"middle"},s=P(t.text),i=P(""),r=P(""),o=P("");return Un(()=>t.text,h=>{const d=/^(?<left>.*?){(?<control>key|mouse): (?<type>.*?)}(?<right>.*)$/.exec(h);d?(s.value=d.groups.left,i.value=d.groups.control,r.value=d.groups.type,o.value=d.groups.right):(s.value=h,i.value="",r.value="",o.value="")},{immediate:!0}),(h,l)=>{const d=Wn("TextWithControls",!0);return M(),b(ut,null,[C(B(s.value)+" ",1),i.value==="key"?(M(),Wt(Y,{key:0,char:r.value},null,8,["char"])):F("",!0),i.value==="mouse"?(M(),Wt(Xe,{key:1,button:A(e)[r.value]},null,8,["button"])):F("",!0),o.value?(M(),Wt(d,{key:2,text:o.value},null,8,["text"])):F("",!0)],64)}}}),Do={class:"message-wrapper"},Co={class:"message-inner"},Bo=["onClick"],Lo=J({__name:"SimpleMessage",props:{register:{type:Function}},setup(n){const t=n;let e=1;const s=()=>({id:e++,content:"",closable:!0,open:!1,removing:!1}),i=P([s()]),r=P(new Map),o=ki(),h=(d,g)=>{let p,w=-1;if(g!=null&&g.override&&(w=i.value.findIndex(I=>I.id===g.override)),w!==-1){const I=i.value[w].id;window.clearTimeout(r.value.get(I)),r.value.delete(I),p=i.value[w]}else p=i.value.at(-1),i.value.push(s());p.closable=(g==null?void 0:g.closable)??!0,p.open=!0,p.content=d;const v=(g==null?void 0:g.expires)??Ao;if(v){const I=window.setTimeout(()=>{l(p)},v);r.value.set(p.id,I)}return Promise.resolve(p.id)},l=d=>{d.open=!1,d.removing=!0,o.proxy.$forceUpdate(),window.setTimeout(()=>{const g=i.value.indexOf(d);g>-1&&i.value.splice(g,1)},700)};return Se(()=>{t.register(h)}),(d,g)=>(M(),b("div",Do,[(M(!0),b(ut,null,Rt(i.value,p=>(M(),b("div",{key:p.id,class:W({message:!0,"message--visible":p.open,"message--removing":p.removing})},[m("div",Co,[p.closable?(M(),b("button",{key:0,class:"close-button",onClick:()=>l(p)},"  ",8,Bo)):F("",!0),R(Ro,{text:p.content},null,8,["text"])])],2))),128))]))}});const mn=nt(Lo,[["__scopeId","data-v-3ec9490a"]]),z=navigator.appVersion.indexOf("Win")!=-1,$o=42,Oo=4,Yo=20;let Ot=!1,Ys=class{constructor(t,e){a(this,"pool");a(this,"selectionPool");a(this,"scaledTilesPool");a(this,"messageFn");a(this,"resolveMessageFn");a(this,"removeEventListeners");a(this,"xStep",0);a(this,"yStep",0);a(this,"offsetX",0);a(this,"offsetY",0);a(this,"time",0);a(this,"fontSize",Yo);a(this,"hasMoved",!1);a(this,"_showCoverage",!1);a(this,"target",null);a(this,"app");a(this,"appContainer");a(this,"world",null);a(this,"rows",[]);a(this,"alertRanges",[]);a(this,"coverageMap",null);a(this,"coverageRows",[]);a(this,"showMessage",async(...t)=>(await this.messageFn)(...t));a(this,"getEmoji",t=>{const e=Ot||u.Instance.getIsBaseDestroyed();if(t.getDiscoveryStatus()===$.Pending&&!e)return"";if(!t.isDiscovered()&&!e)return"&nbsp;";if(t.hasStaticEntity()&&Tt(t.getStaticEntity().getAgent())!==2)return this.getStaticEntityEmoji(t.getStaticEntity().getAgent().getType());switch(t.getBaseType()){case f.Water:return"";case f.Stone:return"";case f.Grass:return"";case f.Spore:return"";case f.Bridge:return"";case f.Sand:return"";case f.Snow:return"";case f.Dirt:return"";case f.Ice:return"";default:return"&nbsp;"}});this.surface=t,this.controller=e,this.pool=new ds((s,i,r)=>{if(i)return i.style.display="block",i.style.opacity="1",i.style.transformOrigin="50% 50%",i.style.filter="none",i.style.color="initial",i.style.textShadow="none",i.children[0].textContent=this.getEntityEmoji(r),i;const o=document.createElement("span");return o.appendChild(document.createElement("span")),z&&(o.children[0].style.margin="-0.35ch"),o.children[0].textContent=r?this.getEntityEmoji(r):"",o.style.position="absolute",o.style.top=z?"-.125ch":"-.075ch",o.style.left=z?".35ch":"0",o.style.display=s?"block":"none",o.style.willChange="transform",this.world.appendChild(o),o},Fe.Growing,0),this.selectionPool=new ds((s,i)=>{if(i)return i.style.display="block",i;const r=document.createElement("span");return r.appendChild(document.createElement("span")),z&&(r.children[0].style.margin="-0.35ch"),r.children[0].textContent="",r.style.transformOrigin="0 0",r.style.opacity="0.7",r.style.position="absolute",r.style.top=z?"-.125ch":"-.075ch",r.style.left=z?".35ch":"0",r.style.display=s?"block":"none",r.style.willChange="transform",this.world.appendChild(r),r},Fe.Growing,0),this.scaledTilesPool=new ds((s,i,r)=>{if(i)return i.style.display="block",i.children[0].textContent=this.getStaticEntityEmoji(r.getAgent().getType()),i;const o=document.createElement("span");return o.appendChild(document.createElement("span")),z&&(o.children[0].style.margin="-0.35ch"),o.children[0].textContent=r?this.getStaticEntityEmoji(r.getAgent().getType()):"",o.style.transformOrigin="0 0",o.style.position="absolute",o.style.top=z?"-.125ch":"-.075ch",o.style.left=z?".35ch":"0",o.style.display=s?"block":"none",o.style.willChange="transform",this.world.appendChild(o),o},Fe.Growing,0),this.messageFn=new Promise(s=>this.resolveMessageFn=s),window.debug=()=>{Ot=!Ot,this.renderTiles()}}mount(t){this.target=t,this.appContainer=t.appendChild(document.createElement("div")),this.app=As(mn,{register:this.resolveMessageFn}),this.app.mount(this.appContainer),this.world=t.appendChild(document.createElement("div")),this.world.className="scrollable",this.world.style.lineHeight=z?"1.86ch":"1ch",this.world.style.whiteSpace="nowrap",this.world.style.cursor="crosshair",this.world.style.userSelect="none",this.world.style.position="relative",this.world.style.fontFamily='"Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Android Emoji","EmojiOne Mozilla","Twemoji Mozilla","Noto Emoji","Segoe UI Symbol",EmojiSymbols',this.world.style.backgroundColor="#000",z&&(this.world.style.letterSpacing="-0.7ch",this.world.style.wordSpacing="2.04ch"),this.renderTiles(),this.zoom();const{width:e,height:s}=this.world.getBoundingClientRect(),i=u.Instance.getBase().getTile();this.world.scrollLeft=i.getX()*this.xStep-e/2,this.world.scrollTop=i.getY()*this.yStep-s/2,this.rerender(0),this.registerEventHandlers(this.world)}zoom(){const t=(this.world.scrollLeft+this.world.clientWidth/2)/this.world.scrollWidth,e=(this.world.scrollTop+this.world.clientHeight/2)/this.world.scrollHeight;this.world.style.fontSize=`${this.fontSize}px`;const{width:s,height:i,x:r,y:o}=this.world.getBoundingClientRect(),h=this.world.scrollWidth,l=this.world.scrollHeight;this.xStep=h/this.surface.getWidth(),this.yStep=l/this.surface.getHeight(),this.offsetX=r,this.offsetY=o,this.world.scrollLeft=t*h-s/2,this.world.scrollTop=e*l-i/2}rerender(t){this.time+=t,this.surface.isDirty()&&this.renderTiles(),(this.surface.isDirty()||this.hasMoved)&&(this.renderStaticAgents(),this.renderAlertRanges());const e=this.surface.getEntities();for(let i of e){const r=xo[i.getAgent().getType()];if(!this.getEntityEmoji(i)&&!r)continue;const o=this.pool.get(i);o.style.display=i.getAgent().isVisible()?"block":"none",r?r(this,i.getAgent(),o):o.style.transform=`translate(${i.getX()*this.xStep}px, ${i.getY()*this.yStep}px) rotate(${i.getRotation()}deg)`}this.surface.getDeletedEntities().forEach(i=>{const r=this.pool.free(i);r&&(r.style.display="none")}),this.renderSelection(),this.surface.markPristine()}showCoverage(){this._showCoverage=!0,this.renderTiles()}hideCoverage(){this._showCoverage=!1,this.renderTiles()}renderTiles(){const t=this.surface.getHeight();for(let e=0;e<t;e++){let s=this.rows[e];s||(s=document.createElement("div"),z&&(s.style.letterSpacing="-0.7ch"),this.rows[e]=s,this.world.appendChild(s));const i=this.surface.getRow(e).map(this.getEmoji).join("");s.innerHTML=i}this.renderCoverage()}renderStaticAgents(){const t=this.surface.getEntitiesForCategory(T.Player);for(let s of t){const i=s.getAgent();if(ws(i)&&Tt(i)===2){const r=this.scaledTilesPool.get(s);r.style.transform=`translate(${s.getX()*this.xStep}px, ${s.getY()*this.yStep}px) scale(2)`}}this.surface.getDeletedEntities().forEach(s=>{const i=this.scaledTilesPool.free(s);i&&(i.style.display="none")})}async renderCoverage(){const t=Ot||u.Instance.getIsBaseDestroyed(),e=[];q.Instance.getSpawnGroups().forEach(o=>{e.push(o.getAsyncSpawnPoints())});const s=[];if((await Promise.all(e)).forEach(o=>s.push(o[0])),this.coverageMap||(this.coverageMap=document.createElement("div"),this.coverageMap.style.opacity="0.5",this.coverageMap.style.position="absolute",this.coverageMap.style.top="0",this.coverageMap.style.left=z?"-0.125ch":"0",z&&(this.coverageMap.style.letterSpacing="-0.7ch",this.coverageMap.style.wordSpacing="2.04ch"),this.world.appendChild(this.coverageMap)),this._showCoverage)this.coverageMap.style.display="block";else{this.coverageMap.style.display="none";return}const i=new Set;u.Instance.getDifficulty()===H.Easy&&s.forEach(o=>o.getTiles().forEach(h=>i.add(h)));const r=this.surface.getHeight();for(let o=0;o<r;o++){let h=this.coverageRows[o];h||(h=document.createElement("div"),this.coverageRows[o]=h,this.coverageMap.appendChild(h));const l=this.surface.getRow(o).map(d=>{if(!d.isDiscovered()&&!t)return"&nbsp;";const g=d.isCoveredByTower();return i.has(d)?g?"":"":g?"":"&nbsp;"}).join("");h.innerHTML=l}}renderSelection(){var i,r;const t=this.selectionPool.getUsed();let e=this.controller.getSelection();e.length===1&&(e=[]);const s=((r=(i=this.controller.getPlacable())==null?void 0:i.entity)==null?void 0:r.scale)||1;e.forEach((o,h)=>{const l=t.has(h)?t.get(h):this.selectionPool.get(h);l.style.transform=`translate(${o.getX()*this.xStep}px, ${o.getY()*this.yStep}px) scale(${s})`});for(let o=t.size-1;o>=e.length;o--){const h=this.selectionPool.free(o);h&&(h.style.display="none")}}renderAlertRanges(){const[t,e]=pt(u.Instance.getBase()),s=20*this.xStep,i=20*this.yStep,r=u.Instance.getIsStarted()?[]:q.Instance.getSpawnAlertRanges();r.forEach((o,h)=>{const l=o.getLength(),d=o.getCenter(),g=l/360;let p=this.alertRanges[h];if(!p){this.alertRanges[h]=p=document.createElementNS("http://www.w3.org/2000/svg","svg");const v=document.createElementNS("http://www.w3.org/2000/svg","circle");v.setAttribute("cx","50%"),v.setAttribute("cy","50%"),v.setAttribute("r","45%"),v.setAttribute("stroke","url(#alert)"),v.setAttribute("stroke-linecap","round"),v.setAttribute("fill","none"),p.appendChild(v);const I=document.createElementNS("http://www.w3.org/2000/svg","text");I.setAttribute("text-anchor","middle"),I.setAttribute("dominant-baseline","middle"),I.classList.add("alert"),(d>270||d<90)&&I.setAttribute("direction","rtl"),I.innerHTML=""+o.getUnits().map(this.getEntityTypeEmoji).join(""),p.appendChild(I),p.style.position="absolute",p.style.top=z?"-.125ch":"-.075ch",p.style.left=z?".35ch":"0",p.style.transformOrigin="50%",this.world.appendChild(p)}p.style.display="block",p.children[0].setAttribute("stroke-width",`${this.fontSize}`),p.children[1].style.transform=`translate(90%, 50%) rotate(-${d}deg)`;const w=s*.9*Math.PI;p.children[0].setAttribute("stroke-dasharray",`${w*g/2} ${w*(1-g)} ${w*g/2} 0`),p.style.width=`${s}px`,p.style.height=`${i}px`,p.style.transform=`translate(${t*this.xStep-s/2}px,${e*this.yStep-i/2}px) rotate(${d}deg)`});for(let o=r.length;o<this.alertRanges.length;o++)this.alertRanges[o].style.display="none"}unmount(){this.app&&(this.app.unmount(),this.target.removeChild(this.appContainer),this.target.removeChild(this.world),this.removeEventListeners())}getTime(){return this.time}canMove(t,e){if(Ot||u.Instance.getIsBaseDestroyed())return!0;const i=this.getBBox(),r=it.Instance.getBBox();if(Math.abs(t)>Math.abs(e)){if(t<0&&i[0][0]<=r[0][0]||t>0&&i[1][0]>=r[1][0])return!1}else if(e<0&&i[0][1]<=r[0][1]||e>0&&i[1][1]>=r[1][1])return!1;return!0}registerEventHandlers(t){const e=g=>(g.preventDefault(),!1);t.addEventListener("contextmenu",e);const s=(g,p,w)=>{Ot||u.Instance.getIsBaseDestroyed()||(this.getBBox(),it.Instance.getBBox(),this.canMove(g,p)||w.preventDefault())},i=g=>{s(g.deltaX,g.deltaY,g)};t.addEventListener("wheel",i,{passive:!1});const r=g=>{const p=Math.floor((g.pageX-this.offsetX+this.world.scrollLeft)/this.xStep),w=Math.floor((g.pageY-this.offsetY+this.world.scrollTop)/this.yStep);this.controller.mouseDown(p,w)};t.addEventListener("mousedown",r);const o=g=>{const p=Math.floor((g.pageX-this.offsetX+this.world.scrollLeft)/this.xStep),w=Math.floor((g.pageY-this.offsetY+this.world.scrollTop)/this.yStep);this.controller.mouseMove(p,w)};t.addEventListener("mousemove",o);const h=g=>{const p=Math.floor((g.pageX-this.offsetX+this.world.scrollLeft)/this.xStep),w=Math.floor((g.pageY-this.offsetY+this.world.scrollTop)/this.yStep);this.controller.mouseUp(p,w)};t.addEventListener("mouseup",h);const l=g=>{this.controller.keyDown(g.key),g.preventDefault()};window.addEventListener("keydown",l);const d=g=>{this.controller.keyUp(g.key),g.preventDefault()};window.addEventListener("keyup",d),this.removeEventListeners=()=>{t.removeEventListener("contextmenu",e),t.removeEventListener("wheel",i),t.removeEventListener("mousedown",r),t.removeEventListener("mousemove",o),t.removeEventListener("mouseup",h),window.removeEventListener("keydown",l),window.removeEventListener("keyup",d)}}move({x:t=0,y:e=0,zoom:s}){(t||e)&&this.canMove(t,e)&&(this.world.scrollLeft+=t*this.fontSize/2,this.world.scrollTop+=e*this.fontSize/2),s&&(s<0?this.fontSize=Math.max(Oo,this.fontSize*.9):this.fontSize=Math.min($o,this.fontSize*1.1),this.zoom(),this.hasMoved=!0)}getStaticEntityEmoji(t){switch(t){case c.Tower:return"";case c.Wall:return"";case c.Mortar:return"";case c.Flamethrower:return"";case c.Railgun:return"";case c.ElectricFence:return"";case c.Fence:return"";case c.Freezer:return"";case c.Base:return"";case c.Tree:return"";case c.Rock:return"";case c.Radar:return"";case c.PowerPlant:return"";case c.None:return"";case c.Armory:case c.Barracks:return"";case c.Market:return"";case c.SpeedBeacon:return"";case c.DamageBeacon:return"";case c.Laser:return"";case c.Tesla:return"";default:return""}}getEntityEmoji(t){return this.getEntityTypeEmoji(t.getAgent().getType())}getEntityTypeEmoji(t){switch(t){case c.Slime:return"";case c.Bullet:case c.Rocket:return"";case c.Rail:case c.LaserBeam:return"";case c.Flame:return"";case c.Shockwave:return"";case c.Runner:return"";case c.Flier:return"";case c.Tank:return"";case c.WavePoint:return"";case c.Spark:return"";default:return""}}getBBox(){const t=this.world.scrollTop/this.yStep,e=this.world.scrollLeft/this.xStep,s=this.world.clientHeight/this.yStep,i=this.world.clientWidth/this.xStep;return[[e,t],[e+i,t+s]]}};const ot="atlas";var G=(n=>(n.Grass="atlas4.png",n.Sand="atlas7.png",n.Water="atlas10.png",n.WaterAlt="atlas11.png",n.Tree="atlas8.png",n.Rock="atlas9.png",n.Ice="atlas2.png",n.Snow="atlas3.png",n.Dirt="atlas1.png",n.Stone="atlas12.png",n.Spore="atlas13.png",n.SporeParticle="atlas30.png",n.Up="atlas14.png",n.Left="atlas15.png",n.Down="atlas16.png",n.Right="atlas17.png",n.UpRight="atlas18.png",n.UpLeft="atlas19.png",n.DownLeft="atlas20.png",n.DownRight="atlas21.png",n.Multi="atlas22.png",n.ActiveCoverage="atlas23.png",n.Coverage="atlas24.png",n.Alert="atlas25.png",n.Fence="atlas26.png",n.ElectricFence="atlas27.png",n.Entity="atlas28.png",n.Unknown="atlas29.png",n.Bridge="atlas5.png",n.None="atlas0.png",n.Coin="atlas31.png",n.Runner="atlas32.png",n.Regular="atlas33.png",n.Flier="atlas34.png",n.Tank="atlas35.png",n))(G||{});const Fo={[f.Grass]:"atlas4.png",[f.Sand]:"atlas7.png",[f.Water]:"atlas10.png",[f.Ice]:"atlas2.png",[f.Snow]:"atlas3.png",[f.Dirt]:"atlas1.png",[f.Tree]:"atlas8.png",[f.Rock]:"atlas9.png",[f.Stone]:"atlas12.png",[f.Spore]:"atlas13.png",[f.Bridge]:"atlas5.png"},Ee=new dt;Ee.name="Floor";const xt=new dt;xt.name="Base";const Bt=new dt;Bt.name="Projectiles";const _t=new dt;_t.name="Towers";const Qt=new dt;Qt.name="UI";const yi=[Ee,xt,Bt,_t,Qt],y=32,wi=20,Xo=3,No=.5,_s=1,xs="buildings",Uo="buildings0.png",Wo=new Map([[c.Base,"buildings0.png"],[c.Armory,"buildings1.png"],[c.Barracks,"buildings1.png"],[c.PowerPlant,"buildings2.png"],[c.Radar,"buildings3.png"],[c.Market,"buildings4.png"],[c.DamageBeacon,"buildings5.png"],[c.SpeedBeacon,"buildings6.png"],[c.Freezer,"buildings12.png"]]);class yn extends tt{constructor(t,e){super(e.assets[xs].textures[Wo.get(t.getType())??Uo]),this.data=t}sync(){this.position.set(this.data.entity.getX()*y,this.data.entity.getY()*y),this.angle=this.data.entity.getRotation()}}a(yn,"layer",xt);const vi=new Map([[c.Armory,["buildings","buildings1.png"]],[c.Barracks,["buildings","buildings1.png"]],[c.PowerPlant,["buildings","buildings2.png"]],[c.Radar,["buildings","buildings3.png"]],[c.Market,["buildings","buildings4.png"]],[c.DamageBeacon,["buildings","buildings5.png"]],[c.SpeedBeacon,["buildings","buildings6.png"]],[c.Freezer,["buildings","buildings12.png"]],[c.Fence,[ot,G.Fence]],[c.Wall,["buildings","buildings13.png"]],[c.ElectricFence,[ot,G.ElectricFence]],[c.Tower,["turret","turret0.png"]],[c.Flamethrower,["flamethrower","flamethrower0.png"]],[c.Mortar,["mortar","mortar0.png"]],[c.Laser,["laser","laser0.png"]],[c.Railgun,["railgun","railgun0.png"]],[c.Tesla,["tesla","tesla0.png"]],[c.None,[ot,G.None]]]);class wn extends tt{constructor(t,e){const s=t.getPlaceable().entityType;if(!vi.has(s))throw new Error(`Missing blueprint sprite for ${s}`);const[i,r]=vi.get(s);super(e.assets[i].textures[r]),this.data=t,s===c.None&&this.scale.set(t.getScale()),this.alpha=.7,this.position.set(this.data.entity.getX()*y,this.data.entity.getY()*y)}sync(){}}a(wn,"layer",xt);const Me="projectiles",Ie="projectiles1.png",Si=20;class Ho extends tt{constructor(){super(...arguments);a(this,"speed",0);a(this,"lifetime",0);a(this,"direction",0)}}class vn extends Ue{constructor(t,e){super(Si,{position:!0,scale:!0,rotation:!0,alpha:!0}),this.data=t;for(let s=0;s<Si;s++){const i=new Ho(e.assets[Me].textures[Ie]);i.anchor.set(.5),i.scale.set(1+Math.random()*.3),i.speed=(4+Math.random()*2)*.0017,i.alpha=.8,i.lifetime=Math.floor(Math.random()*25),i.x=this.data.sourceX*y,i.y=this.data.sourceY*y,i.direction=(this.data.entity.getRotation()+20-Math.random()*40)*Math.PI/180,this.addChild(i)}}sync(t){this.children.forEach(e=>{e.x+=Math.sin(e.direction)*e.speed*t*y,e.y+=Math.cos(e.direction)*e.speed*t*y,e.lifetime+=1,e.lifetime>25&&(this.data.renderData.update?(e.lifetime=0,e.x=this.data.sourceX*y,e.y=this.data.sourceY*y,e.direction=(this.data.entity.getRotation()+20-Math.random()*40)*Math.PI/180,e.alpha=.8):(e.lifetime=Math.floor(Math.random()*25),e.alpha=0))}),this.data.renderData.update=!1}}a(vn,"layer",Bt);const Go="explosion",Vo=.2;class be extends jt{constructor(t,e,s,i=1){super(Object.values(t.assets[Go].textures)),this.anchor.set(.5),this.animationSpeed=Vo,this.loop=!1,this.position.set(e*y,s*y),this.scale.set(i),_t.addChild(this),this.onComplete=()=>{_t.removeChild(this)},this.play()}}const ft=class{constructor(t,e,s){a(this,"ref");a(this,"promise");this.alias=t,this.filter=e;const i=we.play(t,{...s,filters:[e],complete:()=>ft.soundInstanceCountMap.set(t,ft.soundInstanceCountMap.get(t)-1)});i instanceof Promise?(i.then(r=>this.ref=r),this.promise=i):this.ref=i}static rateLimitSound(t){const e=this.soundInstanceCountMap.get(t)||0,s=this.soundPlaytimeMap.get(t)||0;if(e>this.MAX_INSTANCES)return!0;const i=performance.now();return s+this.MIN_INTERVAL>i?!0:(this.soundInstanceCountMap.set(t,e+1),this.soundPlaytimeMap.set(t,i),!1)}static getSoundOptions(t){const{x:e,y:s,width:i,height:r,scale:o}=ct.Instance.getViewport(),h=(t.getX()*y-e)/(i/2),l=(t.getY()*y-s)/(r/2),d=1/(1+(Math.max(0,Math.abs(h)-1)+Math.max(0,Math.abs(l)-1))*3),g=Math.min(o,_s)/_s*d,p=Math.min(1,Math.max(0,Math.abs(h)-.5))*Math.sign(h);return{volume:g,pan:p}}static fromEntity(t,e,s){const{volume:i,pan:r}=ft.getSoundOptions(t);if(!(i<.25)&&!this.rateLimitSound(e))return new ft(e,new jn.StereoFilter(r),{...s,volume:i})}destroy(){var t;this.ref?(t=this.ref)==null||t.destroy():this.promise.then(e=>e.destroy()),ft.soundInstanceCountMap.set(this.alias,ft.soundInstanceCountMap.get(this.alias)-1)}update(t){if(this.ref){const{volume:e,pan:s}=ft.getSoundOptions(t);this.ref.volume=e,this.filter.pan=s}}fade(t,e=500){return this.ref?(this.ref.volume-=t/e*.8,this.ref.volume<.2?(this.destroy(),!0):!1):!1}};let Q=ft;a(Q,"soundInstanceCountMap",new Map),a(Q,"soundPlaytimeMap",new Map),a(Q,"MAX_INSTANCES",3),a(Q,"MIN_INTERVAL",100);var U=(n=>(n.Notification="notification",n.Shot="shot",n.Laser="laser",n.Flamethrower="flamethrower",n.Mortar="mortar",n.Railgun="railgun",n.Explosion="explosion",n.Firework="firework",n.Place="place",n.Destroy="destroy",n.Hit="hit",n.Sonar="sonar",n.Thunder="thunder",n))(U||{});const at=(n,t,e=1)=>{we.add(n,{url:`/open-td/${t}`,preload:!0,volume:e})},jo=()=>{at("notification","sounds/notification.ogg"),at("shot","sounds/shot.wav",.7),at("laser","sounds/laser.flac",.5),at("flamethrower","sounds/flamethrower.wav",.1),at("mortar","sounds/mortar.wav",.7),at("railgun","sounds/railgun.mp3",.7),at("explosion","sounds/explosion.wav"),at("firework","sounds/firework.wav"),at("place","sounds/place.wav",.7),at("destroy","sounds/destroy.wav",.7),at("hit","sounds/hit.wav"),at("sonar","sounds/sonar.wav",.7),at("thunder","sounds/thunder.wav",.7)},Ce=(n,t,e)=>x.Instance.addEventListener(n,()=>we.play(t,e));var te=(n=>(n[n.small=8]="small",n[n.medium=16]="medium",n))(te||{});const Te=n=>{const t=new We;return t.fill.color=0,t.fill.alpha=.4,t.fill.visible=!0,t.drawCircle(0,0,n),Ee.addChild(t),t},_e=n=>{Ee.removeChild(n)},zo=.2,Ko=1/4,qo=1/8,Zo=.0015,qs=class extends jt{constructor(e,s){super(Object.values(s.assets[qs.atlas].textures));a(this,"shadow");a(this,"flames",[]);a(this,"oldOffset",0);this.data=e,this.container=s,this.anchor.set(.5),this.animationSpeed=zo,this.shadow=Te(te.small),this.play(),this.on("removed",()=>{_e(this.shadow),new be(s,e.entity.getX()+.5,e.entity.getY()+.5)})}sync(){const e=Zo*(1+this.data.entity.getId()%13/13),s=.5+Math.sin((ct.Instance.getTime()+this.data.entity.getId())*e)/4-qo,i=.5+Math.cos((ct.Instance.getTime()+this.data.entity.getId())*e)/2-Ko;if(this.position.set((this.data.entity.getX()+s)*y,(this.data.entity.getY()+i)*y),this.shadow.position.set((this.data.entity.getX()+.5)*y,(this.data.entity.getY()+.5)*y),this.angle=this.data.entity.getRotation(),this.data.AI.isBusy()){const o=this.angle;this.angle+=Math.sin(ct.Instance.getTime()%Z/Z*5)*20,Math.sign(this.angle)!==Math.sign(o)&&Q.fromEntity(this.data.entity,U.Hit)}if(this.angle=this.data.entity.getRotation(),this.data.AI.isAttacking()){const o=Math.sin(ct.Instance.getTime()%Z/Z*5)*20;this.angle+=o,Math.sign(o)===1&&Math.sign(this.oldOffset)===-1&&Q.fromEntity(this.data.entity,U.Hit),this.oldOffset=o}else this.oldOffset=0;const r=y/2;if(this.flames.forEach(o=>{o.angle=-this.data.entity.getRotation(),o.position.set(Math.random()*r-r/2,Math.random()*r-r/2)}),this.data.getStatus()===k.OnFire&&!this.flames.length){this.tint=14833698;for(let o=0;o<2;o++){const h=new tt(this.container.assets[Me].textures[Ie]);h.alpha=.8,h.anchor.set(.5),h.position.set(Math.random()*r-r/2,Math.random()*r-r/2),this.addChild(h),this.flames.push(h)}}else this.data.getStatus()!==k.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[])}};let re=qs;a(re,"layer",_t),a(re,"atlas","flier");const Jo="projectiles",Qo="projectiles3.png",fs=16;class Sn extends ks{constructor(e,s){super(s.assets[Jo].textures[Qo],fs,fs);a(this,"tileOffset",0);this.data=e,this.pivot={x:fs/2,y:0}}sync(){this.tilePosition.y=this.tileOffset,this.tileOffset+=.5;const e=this.data.entity.getX(),s=this.data.entity.getY(),i=Math.sqrt((e-this.data.targetX)**2+(s-this.data.targetY)**2);this.height=i*y,this.alpha=Math.min(1,1-this.data.time/Ge+.1),this.position.set(this.data.entity.getX()*y,this.data.entity.getY()*y),this.angle=this.data.entity.getRotation()-90}}a(Sn,"layer",Bt);const th="projectiles",eh="projectiles4.png",ms=16;class En extends ks{constructor(t,e){super(e.assets[th].textures[eh],ms,ms),this.data=t,this.pivot={x:ms/2,y:0}}sync(){const t=this.data.entity.getX(),e=this.data.entity.getY(),s=Math.sqrt((t-this.data.targetX)**2+(e-this.data.targetY)**2);this.height=s*y,this.alpha=Math.min(1,1-this.data.time/Bs+.1),this.position.set(this.data.entity.getX()*y,this.data.entity.getY()*y),this.angle=this.data.entity.getRotation()-90}}a(En,"layer",Bt);const sh=.1,Ei=1/4,Zs=class extends jt{constructor(e,s){super(Object.values(s.assets[Zs.atlas].textures));a(this,"shadow");a(this,"flames",[]);a(this,"oldOffset",0);this.data=e,this.container=s,this.anchor.set(.5),this.animationSpeed=sh,this.shadow=Te(te.medium),this.on("removed",()=>{_e(this.shadow),new be(s,e.entity.getX()+.5,e.entity.getY()+.5)}),this.play()}sync(){const e=.5+this.data.entity.getId()%13/26-Ei,s=.5+(this.data.entity.getId()+5)%17/34-Ei;if(this.position.set((this.data.entity.getX()+e)*y,(this.data.entity.getY()+s)*y),this.shadow.position.copyFrom(this.position),this.angle=this.data.entity.getRotation(),this.data.AI.isAttacking()){const r=Math.sin(ct.Instance.getTime()%Z/Z*5)*20;this.angle+=r,Math.sign(r)===1&&Math.sign(this.oldOffset)===-1&&Q.fromEntity(this.data.entity,U.Hit),this.oldOffset=r}this.data.AI.isBusy()===this.playing&&(this.playing?this.stop():(this.play(),this.oldOffset=0));const i=y/2;if(this.flames.forEach(r=>{r.angle=-this.data.entity.getRotation(),r.position.set(Math.random()*i-i/2,Math.random()*i-i/2)}),this.data.getStatus()===k.OnFire&&!this.flames.length){this.tint=14833698;for(let r=0;r<2;r++){const o=new tt(this.container.assets[Me].textures[Ie]);o.alpha=.8,o.anchor.set(.5),o.position.set(Math.random()*i-i/2,Math.random()*i-i/2),this.addChild(o),this.flames.push(o)}}else this.data.getStatus()!==k.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[])}};let oe=Zs;a(oe,"layer",xt),a(oe,"atlas","regular");const ih=.1,Mi=1/4,Js=class extends jt{constructor(e,s){super(Object.values(s.assets[Js.atlas].textures));a(this,"shadow");a(this,"flames",[]);a(this,"oldOffset",0);this.data=e,this.container=s,this.anchor.set(.5),this.animationSpeed=ih,this.shadow=Te(te.medium),this.on("removed",()=>{_e(this.shadow),new be(s,e.entity.getX()+.5,e.entity.getY()+.5)}),this.play()}sync(){const e=.5+this.data.entity.getId()%13/26-Mi,s=.5+(this.data.entity.getId()+5)%17/34-Mi;if(this.position.set((this.data.entity.getX()+e)*y,(this.data.entity.getY()+s)*y),this.shadow.position.copyFrom(this.position),this.angle=this.data.entity.getRotation(),this.data.AI.isAttacking()){const r=Math.sin(ct.Instance.getTime()%Z/Z*5)*20;this.angle+=r,Math.sign(r)===1&&Math.sign(this.oldOffset)===-1&&Q.fromEntity(this.data.entity,U.Hit),this.oldOffset=r}this.data.AI.isBusy()===this.playing&&(this.playing?this.stop():(this.play(),this.oldOffset=0));const i=y/2;if(this.flames.forEach(r=>{r.angle=-this.data.entity.getRotation(),r.position.set(Math.random()*i-i/2,Math.random()*i-i/2)}),this.data.getStatus()===k.OnFire&&!this.flames.length){this.tint=14833698;for(let r=0;r<2;r++){const o=new tt(this.container.assets[Me].textures[Ie]);o.alpha=.8,o.anchor.set(.5),o.position.set(Math.random()*i-i/2,Math.random()*i-i/2),this.addChild(o),this.flames.push(o)}}else this.data.getStatus()!==k.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[])}};let he=Js;a(he,"layer",xt),a(he,"atlas","runner");const nh="projectiles",ah="projectiles0.png",rh=new Map([[c.Bullet,"projectiles0.png"],[c.Flame,"projectiles1.png"],[c.Rocket,"projectiles2.png"],[c.Shockwave,"projectiles5.png"]]);class ze extends tt{constructor(t,e){super(e.assets[nh].textures[rh.get(t.getType())??ah]),this.data=t,this.pivot={x:8,y:8}}sync(){this.position.set(this.data.entity.getX()*y,this.data.entity.getY()*y),this.angle=this.data.entity.getRotation()}}a(ze,"layer",Bt);const oh=.1,Ii=1/4,Qs=class extends jt{constructor(e,s){super(Object.values(s.assets[Qs.atlas].textures));a(this,"shadow");a(this,"flames",[]);a(this,"oldOffset",0);this.data=e,this.container=s,this.anchor.set(.5),this.animationSpeed=oh,this.shadow=Te(te.medium),this.on("removed",()=>{_e(this.shadow),new be(s,e.entity.getX()+.5,e.entity.getY()+.5)}),this.play()}sync(){const e=.5+this.data.entity.getId()%13/26-Ii,s=.5+(this.data.entity.getId()+5)%17/34-Ii;if(this.position.set((this.data.entity.getX()+e)*y,(this.data.entity.getY()+s)*y),this.shadow.position.copyFrom(this.position),this.angle=this.data.entity.getRotation(),this.data.AI.isAttacking()){const r=Math.sin(ct.Instance.getTime()%Z/Z*5)*20;this.angle+=r,Math.sign(r)===1&&Math.sign(this.oldOffset)===-1&&Q.fromEntity(this.data.entity,U.Hit),this.oldOffset=r}this.data.AI.isBusy()===this.playing&&(this.playing?this.stop():(this.play(),this.oldOffset=0));const i=y/2;if(this.flames.forEach(r=>{r.angle=-this.data.entity.getRotation(),r.position.set(Math.random()*i-i/2,Math.random()*i-i/2)}),this.data.getStatus()===k.OnFire&&!this.flames.length){this.tint=14833698;for(let r=0;r<2;r++){const o=new tt(this.container.assets[Me].textures[Ie]);o.alpha=.8,o.anchor.set(.5),o.position.set(Math.random()*i-i/2,Math.random()*i-i/2),this.addChild(o),this.flames.push(o)}}else this.data.getStatus()!==k.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[])}};let ce=Qs;a(ce,"layer",xt),a(ce,"atlas","tank");const hh=new Map([[c.Tower,"turret"],[c.Flamethrower,"flamethrower"],[c.Laser,"laser"],[c.Mortar,"mortar"],[c.Railgun,"railgun"],[c.Tesla,"tesla"]]),bi=new Map([[c.Tower,U.Shot],[c.Flamethrower,U.Flamethrower],[c.Laser,U.Laser],[c.Mortar,U.Mortar],[c.Railgun,U.Railgun],[c.Tesla,U.Thunder]]),ch=new Set([c.Flamethrower,c.Laser]),lh=.1,uh=.6,dh="buildings8.png",gh="buildings9.png",ph="buildings10.png",fh="buildings11.png",Ti=(n,t)=>n?t?dh:gh:t?ph:fh;class Pt extends tt{constructor(e,s){super(s.assets[xs].textures[Ti(e.isSpeedBoosted(),e.isDamageBoosted())]);a(this,"turret");a(this,"sound");this.data=e,this.container=s;const[i,r]=pt(e);this.position.set(i*y,r*y),this.pivot={x:y,y},this.createTurret()}createTurret(){const e=hh.get(this.data.getType());this.turret=new jt(Object.values(this.container.assets[e].textures)),this.turret.position.set(this.x,this.y),this.turret.pivot={x:y,y},this.turret.animationSpeed=lh,this.turret.loop=!1,this.turret.onComplete=()=>{this.turret.gotoAndStop(0)},_t.addChild(this.turret),this.on("removed",()=>_t.removeChild(this.turret))}sync(e,s){s&&(this.texture=this.container.assets[xs].textures[Ti(this.data.isSpeedBoosted(),this.data.isDamageBoosted())]),this.turret.angle=Ta(this.turret.angle,this.data.entity.getRotation(),uh*e),this.data.renderData.fired?(this.data.renderData.fired=!1,this.turret.play(),ch.has(this.data.getType())?this.sound?this.sound.update(this.data.entity):this.sound=Q.fromEntity(this.data.entity,bi.get(this.data.getType()),{loop:!0}):Q.fromEntity(this.data.entity,bi.get(this.data.getType()))):this.sound&&this.sound.fade(e)&&(this.sound=void 0)}}a(Pt,"layer",xt);class Mn extends ze{constructor(e,s){super(e,s);a(this,"shadow");this.data=e,this.shadow=Te(te.small),this.on("removed",()=>{_e(this.shadow),new be(s,e.entity.getX(),e.entity.getY(),2),Q.fromEntity(e.entity,U.Explosion)})}sync(){super.sync(),this.shadow.position.set(this.data.entity.getX()*y,this.data.straightY*y);const e=1-Math.abs(this.data.getPercentage()-.5)*.8;this.shadow.scale.set(e)}}a(Mn,"layer",_t);const _i=75,xi=1e3;class mh extends tt{constructor(){super(...arguments);a(this,"speed",Math.random()*.002)}}class In extends dt{constructor(e,s){super();a(this,"container");a(this,"sprite");a(this,"time",0);this.data=e,this.sprite=new tt(s.assets[ot].textures[G.Coin]),this.sprite.anchor.set(.5),this.container=new Ue(_i,{alpha:!0});for(let i=0;i<_i;i++){const r=new mh(s.assets[ot].textures[G.SporeParticle]),o=i%25/25*Math.PI*2,h=Math.floor(i/25)*.75+.25;r.anchor.set(.5),r.alpha=.9,r.x=(this.data.sourceX+Math.sin(o)*h)*y,r.y=(this.data.sourceY+Math.cos(o)*h)*y,this.container.addChild(r)}this.addChild(this.sprite,this.container),Q.fromEntity(this.data.entity,U.Firework)}sync(e){this.sprite.position.set(this.data.entity.getX()*y,this.data.entity.getY()*y),this.sprite.angle=this.data.entity.getRotation(),this.container.children.forEach((s,i)=>{const r=i%25/25*Math.PI*2;s.x+=Math.sin(r)*s.speed*e*y,s.y+=Math.cos(r)*s.speed*e*y,s.alpha=.9-this.time/xi*.8}),this.time+=e,this.time>xi&&this.removeChild(this.container)}}a(In,"layer",Qt);const yh="lightning",wh="lightning0.png",Ai=32,vh=96;class bn extends dt{constructor(e,s){super();a(this,"sprites",[]);this.data=e;let i=e.entity.getX(),r=e.entity.getY();for(let o of this.data.getChain()){const h=o.entity.getX()+.5,l=o.entity.getY()+.5,d=new ks(s.assets[yh].textures[wh],Ai,vh);d.pivot={x:Ai/2,y:0};const g=Math.sqrt((i-h)**2+(r-l)**2);d.height=g*y,d.position.set(i*y,r*y),d.rotation=Math.atan2(r-l,i-h)+Math.PI/2,i=h,r=l,this.addChild(d),this.sprites.push(d)}}sync(){this.alpha=Math.min(1,1-this.data.time/Is+.1),this.sprites.forEach(e=>e.tilePosition.y=Math.floor(this.data.time/Is*5)*32)}}a(bn,"layer",Bt);const Sh={runner:"/open-td/animations/runner.json",regular:"/open-td/animations/regular.json",flier:"/open-td/animations/flier.json",tank:"/open-td/animations/tank.json",buildings:"/open-td/tiles/buildings.json",turret:"/open-td/animations/turret.json",flamethrower:"/open-td/animations/flamethrower.json",laser:"/open-td/animations/laser.json",mortar:"/open-td/animations/mortar.json",railgun:"/open-td/animations/railgun.json",projectiles:"/open-td/tiles/projectiles.json",explosion:"/open-td/animations/explosion.json",lightning:"/open-td/tiles/lightning.json",tesla:"/open-td/animations/tesla.json"},Eh={[c.Runner]:he,[c.Slime]:oe,[c.Flier]:re,[c.Tank]:ce,[c.Tower]:Pt,[c.Flamethrower]:Pt,[c.Laser]:Pt,[c.Mortar]:Pt,[c.Railgun]:Pt,[c.Bullet]:ze,[c.Flame]:vn,[c.Rocket]:Mn,[c.Shockwave]:ze,[c.LaserBeam]:Sn,[c.Rail]:En,[c.Fence]:null,[c.Wall]:null,[c.ElectricFence]:null,[c.Blueprint]:wn,[c.WavePoint]:In,[c.Spark]:bn,[c.Tesla]:Pt},Mh={1:[[0,-1],[-1,0],[0,1],[1,0],[1,-1],[-1,-1],[-1,1],[1,1]],2:[[0,-1],[-1,0],[0,2],[2,0],[2,-1],[-1,-1],[-1,2],[2,2]]},Be=8,Tn=new Set([f.Fence,f.Wall,f.ElectricFence]),Ih={fences:"/open-td/tiles/fenceCombined.json",wall:"/open-td/tiles/bigWall.json",[ot]:"/open-td/tiles/atlas.json"};class bh{constructor(t,e,s){this.container=t,this.tilemap=e,this.surface=s}getWallSprite(t,e){switch(t){case c.Fence:return this.container.assets.fences.textures[`fenceCombined${e}.png`];case c.ElectricFence:return this.container.assets.fences.textures[`fenceCombined${9+e}.png`];case c.Wall:return this.container.assets.wall.textures[`bigWall${e}.png`];default:throw new Error("unknown wall type")}}render(t){const e=t.getStaticEntity().getAgent(),s=e.getType(),i=Tt(e);let r=0,o=0,h=0,l=!1;Mh[i].forEach(([d,g],p)=>{if(p>3&&(l||d===o||g===h))return;const w=this.surface.getTile(t.getX()+d,t.getY()+g);w&&Tn.has(w.getType())&&Tt(w.getStaticEntity().getAgent())===i&&(p<=3&&(o&&d||h&&g?l=!0:(o=o||d,h=h||g)),this.tilemap.tile(this.getWallSprite(s,p),t.getX()*y-Be*i,t.getY()*y-Be*i),r++)}),r<2&&this.tilemap.tile(this.getWallSprite(s,8),t.getX()*y-Be*i,t.getY()*y-Be*i)}}class Th extends tt{constructor(t,e,s){super(s),this.offset=t,this.path=e;const{x:i,y:r}=this.path.getCoordinates(this.offset%this.path.getLength());this.position.set(i*y,r*y)}move(){this.offset+=.1;const{x:t,y:e}=this.path.getCoordinates(this.offset%this.path.getLength());this.position.set(t*y,e*y)}}class _h extends tt{constructor(){super(...arguments);a(this,"originalAlpha",1)}}class xh{constructor(t,e){a(this,"coverageContainer");a(this,"pathContainer");a(this,"towers",new Map);a(this,"hoveredTile");a(this,"visible",!1);this.container=t,this.surface=e,this.coverageContainer=new Ue(void 0,{uvs:!0,alpha:!0},void 0,!0),Ee.addChild(this.coverageContainer),this.pathContainer=new Ue(void 0,{position:!0},void 0,!0),Qt.addChild(this.pathContainer)}show(){this.visible=!0,this.render()}hide(){this.visible=!1,this.coverageContainer.removeChildren(),this.pathContainer.removeChildren()}render(){this.visible&&(this.renderCoverage(),u.Instance.getDifficulty()===H.Easy&&!u.Instance.getIsStarted()&&this.renderPaths())}renderCoverage(){this.coverageContainer.removeChildren(),this.towers.clear(),this.hoveredTile=void 0;const t=this.surface.getHeight();for(let e=0;e<t;e++)this.surface.getRow(e).forEach(s=>{const i=s.getTowers();if(i.length===0||!s.isDiscovered())return;const r=new _h(this.container.assets[ot].textures[G.Coverage]);r.originalAlpha=Math.min(.15+.1*i.length,.55),r.alpha=r.originalAlpha,r.position.set(s.getX()*y,s.getY()*y),this.coverageContainer.addChild(r),i.forEach(o=>{const h=this.towers.get(o.getTile().getHash())||[];h.push(r),this.towers.set(o.getTile().getHash(),h)})})}async renderPaths(){this.pathContainer.removeChildren();const t=[];q.Instance.getSpawnGroups().forEach(s=>{t.push(s.getAsyncSpawnPoints())});const e=[];(await Promise.all(t)).forEach(s=>e.push(...s)),e.forEach((s,i)=>{const r=this.slicePath(s),o=Math.max(1,Math.floor(r.getLength()/5));for(let h=0;h<o;h++)this.pathContainer.addChild(new Th(i*2+h*5,r,this.container.assets[ot].textures[G.Entity]))})}slicePath(t){let e,s;for(let i=0;i<t.getLength();i++){const r=t.getTile(i);if(r.isDiscovered()||(e=i+1),r.hasStaticEntity()&&Rs.has(r.getStaticEntity().getAgent().getType())){s=i;break}}return t.slice(e,s)}update(){var i,r;if(!this.visible)return;u.Instance.getIsStarted()?this.pathContainer.removeChildren():this.pathContainer.children.forEach(o=>o.move());const[t,e]=St.Instance.getMouse(2),s=this.surface.getTile(t,e);s!==this.hoveredTile&&(this.hoveredTile&&((i=this.towers.get(this.hoveredTile.getHash()))==null||i.forEach(o=>{o.texture=this.container.assets[ot].textures[G.Coverage],o.alpha=o.originalAlpha})),s&&((r=this.towers.get(s.getHash()))==null||r.forEach(o=>{o.texture=this.container.assets[ot].textures[G.ActiveCoverage],o.alpha=.7})),this.hoveredTile=s)}}const Ut=class{constructor(t){a(this,"container");a(this,"alertSymbols",[]);a(this,"time",0);a(this,"permanent",!1);this.assetsContainer=t,this.container=new dt,Qt.addChild(this.container),x.Instance.addEventListener(E.EndWave,()=>this.reset())}enable(){this.permanent=!0,this.container.alpha=1,this.time=Ut.displayDuration}disable(){this.permanent=!1,this.time=Ut.displayDuration}reset(){this.time=0,this.container.alpha=1}render(t,e){this.alertSymbols=[],this.container.removeChildren();const[s,i]=t,r=Math.PI/128;e.forEach(o=>{const[h,l]=o.getRange(),d=new dt,g=new We;g.lineStyle({width:10,color:267386880,cap:zn.ROUND,alpha:.8,alignment:.5}),g.arc(s*y,i*y,10*y,h*Math.PI/180+r,l*Math.PI/180-r);const p=new tt(this.assetsContainer.assets[ot].textures[G.Alert]);p.anchor.set(.5),p.scale.set(2),this.alertSymbols.push(p);const w=new dt,v=o.getCenter(),I=v*Math.PI/180;w.position.set((s+Math.cos(I)*9.2)*y,(i+Math.sin(I)*9.2)*y),w.addChild(p),o.getUnits().forEach((L,D)=>{const O=new tt(this.assetsContainer.assets[ot].textures[Ut.enemySpriteMap.get(L)]),S=v>270||v<90?-1:1,_=S>0?16:-48;O.position.set(_+32*D*S,8),w.addChild(O)}),d.addChild(g,w),this.container.addChild(d)})}update(t,e){this.container.alpha<=0||(!this.permanent&&(this.time>Ut.displayDuration||e)&&(this.container.alpha-=t/500),this.alertSymbols.forEach(s=>{s.alpha=Math.abs(Math.cos(this.time/300))}),this.time+=t)}};let le=Ut;a(le,"displayDuration",20*1e3),a(le,"enemySpriteMap",new Map([[c.Runner,G.Runner],[c.Slime,G.Regular],[c.Tank,G.Tank],[c.Flier,G.Flier]]));const _n=(n,t,e)=>{const s=Number(n);return isNaN(s)||t&&s<t?t??0:e&&s>e?e:s},Ah=(n,t)=>n!==""?_n(t):t,Ph=(n,t)=>t,kh={True:!0,False:!1},Rh=(n,t,e)=>{var s;return((s=Object.entries(n).find(([i,r])=>t===r))==null?void 0:s[0])||e},Pi=(n,t,e)=>Object.values(n).find(s=>s===t)??e,Dh=(n,t)=>{if(n==="renderer"){const e={emojiRenderer:Ys,pixiRenderer:ct};return t in e?e[t]:e.pixiRenderer}return n==="difficulty"?Pi(H,t):n==="showTutorial"?Pi(kh,t):n==="volume"?_n(t,0,100):t},Ch=(n,t)=>n==="renderer"?Rh({emojiRenderer:Ys,pixiRenderer:ct},t,"pixiRenderer"):t,Bh={settings:Dh,achievements:Ah},Lh={settings:Ch,achievements:Ph},xe=n=>{let t;try{t=localStorage.getItem(n)}catch{return null}if(!t)return null;t.startsWith("{")||(t=window.atob(t));try{return JSON.parse(t,Bh[n])}catch{return null}},ns=(n,t,e=!1)=>{const s=xe(n)||{},i=JSON.stringify({...s,...t},Lh[n]);try{localStorage.setItem(n,e?window.btoa(i):i)}catch(r){console.warn("Failed to store data",r)}},$h=`varying vec2 vTextureCoord;
uniform sampler2D uSampler;

uniform vec2 thickness;
uniform vec4 outlineColor;
uniform vec4 filterClamp;

const float DOUBLE_PI = 3.14159265358979323846264 * 2.;

void main(void) {
    vec4 ownColor = texture2D(uSampler, vTextureCoord);
    vec4 curColor;
    float maxAlpha = 0.;
    vec2 displaced;
    for (float angle = 0.; angle <= DOUBLE_PI; angle += \${angleStep}) {
        displaced.x = vTextureCoord.x + thickness.x * cos(angle);
        displaced.y = vTextureCoord.y + thickness.y * sin(angle);
        curColor = texture2D(uSampler, clamp(displaced, filterClamp.xy, filterClamp.zw));
        maxAlpha = max(maxAlpha, curColor.a);
    }
    float resultAlpha = maxAlpha * step(ownColor.a, 0.0) > 0. ? 1. : 0.0;

    gl_FragColor = vec4(outlineColor.rgb * resultAlpha, resultAlpha);
}
`,ye=class extends Kn{constructor(e=1,s=0,i=.1){super(void 0,$h.replace(/\$\{angleStep\}/,ye.getAngleStep(i)));a(this,"_thickness",1);this.uniforms.thickness=new Float32Array([0,0]),this.uniforms.outlineColor=new Float32Array([0,0,0,1]),Object.assign(this,{thickness:e,color:s,quality:i})}static getAngleStep(e){if(e===0)return(Math.PI/2).toFixed(7);const s=Math.max(e*ye.MAX_SAMPLES,ye.MIN_SAMPLES);return(Math.PI*2/s).toFixed(7)}apply(e,s,i,r){this.uniforms.thickness[0]=this._thickness/s._frame.width,this.uniforms.thickness[1]=this._thickness/s._frame.height,e.applyFilter(this,s,i,r)}get color(){return qn(this.uniforms.outlineColor)}set color(e){Zn(e,this.uniforms.outlineColor)}get thickness(){return this._thickness}set thickness(e){this._thickness=e,this.padding=e}};let Xt=ye;a(Xt,"MIN_SAMPLES",1),a(Xt,"MAX_SAMPLES",100);const Oh=Intl.NumberFormat(void 0,{maximumFractionDigits:0});class Yh{constructor(){a(this,"container");a(this,"rangeGraphic");a(this,"text");a(this,"oldMousePosition","");a(this,"oldMode",pn.Line);a(this,"oldPlaceable",null);this.rangeGraphic=new We,this.rangeGraphic.filters=[new Xt(2,0,0)],this.container=new We,this.container.filters=[new Xt(2,0,0)],this.text=new Jn("",{fontFamily:"JupiterCrash",fontSize:24,fill:0,align:"left",dropShadow:!0,dropShadowColor:16777215,dropShadowDistance:2}),Qt.addChild(this.rangeGraphic,this.container,this.text)}render(){var g;const t=St.Instance,e=t.getMouse(),s=t.getMode(),i=t.getPlacable();if(e.join(",")===this.oldMousePosition&&s===this.oldMode&&i===this.oldPlaceable)return;this.oldMousePosition=e.join(","),this.oldMode=s,this.oldPlaceable=i;const r=y*(((g=i==null?void 0:i.entity)==null?void 0:g.scale)||1);this.rangeGraphic.clear(),this.container.clear(),this.container.fill.visible=!0;const o=new Set,h=new Set,l=u.Instance.getSurface();let d;if(i!=null&&i.entity&&(d=i.entity.range),t.isMouseDown())t.getSelection().forEach(p=>{this.container.drawRect(p.getX()*y,p.getY()*y,r,r),d&&l.forCircle(p.getX()+1,p.getY()+1,d,w=>h.add(w)),p.hasStaticEntity()&&o.add(p.getStaticEntity().getAgent())});else{const[p,w]=t.getMouse();this.container.drawRect(p*y,w*y,r,r),d&&l.forCircle(p+1,w+1,d,I=>h.add(I));const v=l.getTile(p,w);v&&v.hasStaticEntity()&&o.add(v.getStaticEntity().getAgent())}this.rangeGraphic.clear().beginFill();for(let p of h)this.rangeGraphic.drawRect(p.getX()*y,p.getY()*y,y,y);if(this.rangeGraphic.endFill(),(i==null?void 0:i.entityType)===c.None){const p=[...o].reduce((w,v)=>w+N.Instance.getValue(v),0);p>0?this.text.text=`Sell for  ${Oh.format(p)}`:this.text.text="",this.text.position.set(e[0]*y,e[1]*y-24)}else this.text.text=""}}Ci.addBundle("assets",{...Ih,...Sh});let Le;const xn=()=>Le||(Le=Ci.loadBundle("assets"),Le);class Fh{constructor(){a(this,"assets");a(this,"callback");xn().then(t=>{this.assets=t,this.callback&&this.callback()})}onComplete(t){this.assets&&t()}get loading(){return this.assets===void 0}}let $e=!1;Qn.use32bitIndex=!0;const ti=class{constructor(t,e){a(this,"messageFn");a(this,"resolveMessageFn");a(this,"removeEventListeners");a(this,"target");a(this,"app");a(this,"viewport");a(this,"tilemap");a(this,"vueApp");a(this,"sprites",new Map);a(this,"assets");a(this,"wallRenderer");a(this,"coverageRenderer");a(this,"alertRenderer");a(this,"cursorRenderer");a(this,"x",0);a(this,"y",0);a(this,"scale",_s);a(this,"width",0);a(this,"height",0);a(this,"time",0);a(this,"showMessage",async(...t)=>{const e=await this.messageFn;return we.play(U.Notification),e(...t)});this.surface=t,this.controller=e,ti.instance=this,this.messageFn=new Promise(s=>this.resolveMessageFn=s),this.tilemap=new ta,this.assets=new Fh,this.wallRenderer=new bh(this.assets,this.tilemap,this.surface),jo(),window.debug=()=>{$e=!$e,this.renderTilemap()}}static get Instance(){return this.instance}mount(t){this.target=t,this.app=new ea({resizeTo:window}),t.appendChild(this.app.view),this.width=this.surface.getWidth()*y,this.height=this.surface.getHeight()*y,this.viewport=new sa({screenWidth:window.innerWidth,screenHeight:window.innerHeight,worldWidth:this.width,worldHeight:this.height,interaction:this.app.renderer.plugins.interaction}).clamp({direction:"all",underflow:"center"}).drag({wheel:!0,clampWheel:!0,pressDrag:!1}).addListener("moved",({type:i})=>{i!=="animate"&&(this.x=this.viewport.center.x,this.y=this.viewport.center.y)}),this.app.stage.addChild(this.viewport),this.viewport.addChild(this.tilemap,...yi),this.coverageRenderer=new xh(this.assets,this.surface),this.alertRenderer=new le(this.assets),this.cursorRenderer=new Yh,this.assets.onComplete(()=>this.renderTilemap());const e=t.appendChild(document.createElement("div"));this.vueApp=As(mn,{register:this.resolveMessageFn}),this.vueApp.mount(e);const s=u.Instance.getBase().getTile();this.x=s.getX()*y,this.y=s.getY()*y,this.viewport.animate({time:0,position:{x:this.x,y:this.y}}),this.registerEventHandlers(),this.updateSettings()}updateSettings(){const t=xe("settings");we.volumeAll=((t==null?void 0:t.volume)??100)/100}renderTilemap(){this.tilemap.clear();const t=$e||u.Instance.getIsBaseDestroyed(),e=this.assets.assets[ot],s=this.surface.getHeight(),i=[];for(let h=0;h<s;h++)this.surface.getRow(h).forEach(l=>{if(!t){if(l.getDiscoveryStatus()===$.Undiscovered)return;if(l.getDiscoveryStatus()===$.Pending){this.tilemap.tile(e.textures[G.Unknown],l.getX()*y,l.getY()*y);return}}let d=Fo[l.getBaseType()];d&&(this.tilemap.tile(e.textures[d],l.getX()*y,l.getY()*y),l.getBaseType()===f.Water&&this.tilemap.tileAnimX(32,2)),l.hasStaticEntity()&&(l.getType()===f.Tree?this.tilemap.tile(e.textures[G.Tree],l.getX()*y,l.getY()*y):l.getType()===f.Rock?this.tilemap.tile(e.textures[G.Rock],l.getX()*y,l.getY()*y):Tn.has(l.getType())&&l.isStaticEntityRoot()&&i.push(l))});i.forEach(h=>this.wallRenderer.render(h)),this.coverageRenderer.render();const r=pt(u.Instance.getBase()),o=q.Instance.getSpawnAlertRanges();this.alertRenderer.render(r,o)}rerender(t){if(this.assets.loading)return;this.time+=t;const e=$e||u.Instance.getIsBaseDestroyed(),s=this.surface.isDirty();s&&this.renderTilemap(),this.app.renderer.plugins.tilemap.tileAnim[0]+=t/500;const i=this.surface.getEntities();for(let o of i){let h=this.sprites.get(o.getId());if(!h){const l=Eh[o.getAgent().getType()];if(l===null)continue;const d=l||yn;h=new d(o.getAgent(),this.assets),d.layer.addChild(h),this.sprites.set(o.getId(),h)}o.getAgent().isVisible()||e?(h.sync(t,s),h.visible=!0,h.shadow&&(h.shadow.visible=!0)):(h.visible=!1,h.shadow&&(h.shadow.visible=!1))}this.surface.getDeletedEntities().forEach(o=>{const h=this.sprites.get(o.getId());h&&(this.sprites.delete(o.getId()),h.constructor.layer.removeChild(h))}),this.cursorRenderer.render(),this.coverageRenderer.update(),this.alertRenderer.update(t,u.Instance.getIsStarted()),this.surface.markPristine()}showCoverage(){this.coverageRenderer.show(),this.alertRenderer.enable()}hideCoverage(){this.coverageRenderer.hide(),this.alertRenderer.disable()}unmount(){this.app&&(this.vueApp.unmount(),this.app.destroy(!0),this.removeEventListeners(),yi.forEach(t=>t.removeChildren()))}getTime(){return this.time}registerEventHandlers(){const t=p=>(p.preventDefault(),!1);this.target.addEventListener("contextmenu",t);const e=p=>{const w=Math.floor((p.data.global.x/this.viewport.scale.x+this.viewport.left)/y),v=Math.floor((p.data.global.y/this.viewport.scale.y+this.viewport.top)/y);this.controller.mouseDown(w,v)};this.viewport.addListener("mousedown",e);const s=p=>{const w=Math.floor((p.data.global.x/this.viewport.scale.x+this.viewport.left)/y),v=Math.floor((p.data.global.y/this.viewport.scale.y+this.viewport.top)/y);this.controller.mouseMove(w,v)};this.viewport.addListener("mousemove",s);const i=p=>{const w=Math.floor((p.data.global.x/this.viewport.scale.x+this.viewport.left)/y),v=Math.floor((p.data.global.y/this.viewport.scale.y+this.viewport.top)/y);this.controller.mouseUp(w,v)};this.viewport.addListener("mouseup",i);const r=p=>{this.controller.keyDown(p.key),p.preventDefault()};window.addEventListener("keydown",r);const o=p=>{this.controller.keyUp(p.key),p.preventDefault()};window.addEventListener("keyup",o);const h=Ce(E.StartWave,U.Sonar),l=Ce(E.Buy,U.Place),d=Ce(E.Sell,U.Destroy),g=Ce(E.HitBase,U.Destroy);this.removeEventListeners=()=>{window.removeEventListener("contextmenu",t),this.viewport.removeListener("mousedown",e),this.viewport.removeListener("mousemove",s),this.viewport.removeListener("mouseup",i),window.removeEventListener("keydown",r),window.removeEventListener("keyup",o),h(),l(),d(),g()}}move({x:t=0,y:e=0,zoom:s}){s&&(s<0?this.scale=Math.max(No,this.scale*.9):this.scale=Math.min(Xo,this.scale*1.1));const i=this.viewport.worldScreenWidth/2,r=this.viewport.worldScreenHeight/2;(t>0&&this.x<this.width-i||t<0&&this.x>i)&&(this.x+=t*wi/this.scale),(e>0&&this.y<this.height-r||e<0&&this.y>r)&&(this.y+=e*wi/this.scale),this.viewport.animate({time:200,position:{x:this.x,y:this.y},scale:this.scale})}getViewport(){var t,e;return{x:this.x,y:this.y,width:((t=this.viewport)==null?void 0:t.worldScreenWidth)||0,height:((e=this.viewport)==null?void 0:e.worldScreenHeight)||0,scale:this.scale}}};let Ne=ti;a(Ne,"instance");const ct=Ne,Xh={class:"horizontal"},Nh=["value"],Uh={class:"horizontal"},Wh={class:"horizontal"},Hh=J({__name:"Settings",props:{setSubmitter:{type:Function}},setup(n){const{setSubmitter:t}=n,e=[{label:"Pixi renderer",value:ct},{label:"Emoji renderer",value:Ys}],s=xe("settings"),i=P(s&&e.find(({value:l})=>l===s.renderer)||e[0]),r=P((s==null?void 0:s.showTutorial)??!0),o=P((s==null?void 0:s.volume)??50);return t(()=>({...s,renderer:i.value.value,showTutorial:r.value,volume:o.value})),(l,d)=>(M(),b(ut,null,[m("label",Xh,[C(" Renderer "),ue(m("select",{"onUpdate:modelValue":d[0]||(d[0]=g=>i.value=g)},[(M(),b(ut,null,Rt(e,g=>m("option",{value:g},B(g.label),9,Nh)),64))],512),[[Ri,i.value]])]),m("label",Uh,[C(" Show tutorial "),ue(m("input",{type:"checkbox","onUpdate:modelValue":d[1]||(d[1]=g=>r.value=g)},null,512),[[Hn,r.value]])]),m("label",Wh,[C(" Volume "),ue(m("input",{type:"range",min:"0",max:"100","onUpdate:modelValue":d[2]||(d[2]=g=>o.value=g)},null,512),[[Di,o.value]])])],64))}});const An=nt(Hh,[["__scopeId","data-v-1a5ad567"]]),Pn=n=>(Dt("data-v-55bb69eb"),n=n(),Ct(),n),Gh={class:"menu"},Vh=Pn(()=>m("h3",null,"Paused",-1)),jh=Pn(()=>m("span",{class:"divider"},null,-1)),zh=J({__name:"IngameMenu",props:{visible:{type:Boolean},mainMenu:{type:Function},resume:{type:Function}},setup(n){const{visible:t,mainMenu:e,resume:s}=n;let i;const r=h=>i=h,o=()=>{const h=i();ns("settings",h),s(h.renderer,h.showTutorial)};return(h,l)=>(M(),b("div",{class:W({"menu-wrapper":!0,"menu-wrapper--visible":n.visible})},[m("div",Gh,[Vh,m("button",{onClick:l[0]||(l[0]=(...d)=>n.mainMenu&&n.mainMenu(...d))},"Main menu"),jh,R(An,{setSubmitter:r}),m("button",{onClick:o},"Save and resume")])],2))}});const Kh=nt(zh,[["__scopeId","data-v-55bb69eb"]]),qh={class:"stats"},Zh={class:"meta"},Jh={class:"positive"},Qh={class:"meta"},tc={class:"positive"},ec={class:"negative"},sc={class:"meta"},ic={class:"positive"},nc={key:0,class:"negative"},ac={key:1},rc=J({__name:"Stats",props:{expanded:{type:Boolean}},setup(n){const t=n,e=Intl.NumberFormat(void 0,{maximumFractionDigits:0}),s=Intl.NumberFormat(void 0,{maximumFractionDigits:2}),i=Intl.NumberFormat(void 0,{style:"percent",maximumFractionDigits:0}),r=P(0),o=P(0),h=P(0),l=P(0),d=P(0),g=P(!1),p=P(0),w=P(0),v=P(0),I=P(0),L=P(0),D=S=>{r.value=S.money,o.value=S.moneyMultiplier,h.value=S.level,l.value=S.towers,d.value=S.maxTowers,g.value=S.inProgress,p.value=S.integrity,w.value=S.regeneration,v.value=S.power,I.value=S.production,L.value=S.consumption},O=Gn(()=>({stat:!0,"stat--expanded":t.expanded}));return Se(()=>{x.Instance.addEventListener(E.StatUpdate,D),u.Instance.triggerStatUpdate()}),Je(()=>{x.Instance.removeEventListener(E.StatUpdate,D)}),(S,_)=>(M(),b("div",qh,[m("span",{class:W(A(O))},[C("  "+B(A(e).format(r.value))+" ",1),m("span",Zh,[C("("),m("span",Jh,B(A(i).format(o.value)),1),C(")")])],2),m("span",{class:W(A(O))},[C("  "+B(A(e).format(v.value))+" ",1),m("span",Qh,[C("("),m("span",tc,"+"+B(A(s).format(I.value)),1),C("/"),m("span",ec,"-"+B(A(s).format(L.value)),1),C(")")])],2),m("span",{class:W(A(O))},[C("  "+B(A(e).format(p.value))+" ",1),m("span",sc,[C("("),m("span",ic,"+"+B(A(s).format(w.value)),1),C(")")])],2),m("span",{class:W(A(O))},[C("  "),l.value>d.value?(M(),b("span",nc,B(l.value),1)):(M(),b("span",ac,B(l.value),1)),C(" / "+B(d.value),1)],2)]))}});const oc=nt(rc,[["__scopeId","data-v-0a442d39"]]),hc=n=>(Dt("data-v-661c9c6d"),n=n(),Ct(),n),cc={class:"hud"},lc={class:"hud-positioner"},uc={class:"group"},dc=hc(()=>m("span",{class:"emoji"},"",-1)),gc={key:0},pc={key:1},fc=J({__name:"Hud",props:{renderer:null,controller:null},setup(n){const t=n,e=P(0),s=P(!1),i=P(!1),r=P(!1),o=g=>{e.value=g.level,s.value=g.inProgress};Se(()=>{x.Instance.addEventListener(E.StatUpdate,o),u.Instance.triggerStatUpdate()}),Je(()=>{x.Instance.removeEventListener(E.StatUpdate,o)});function h(){u.Instance.start()}function l(){r.value=!r.value}function d(){i.value?t.renderer.hideCoverage():t.renderer.showCoverage(),x.Instance.triggerEvent(E.ToggleShowCoverage),i.value=!i.value}return(g,p)=>(M(),b("div",cc,[m("div",lc,[R(oc,{expanded:r.value},null,8,["expanded"]),m("div",uc,[m("button",{class:W({"wave-toggle":!0,"wave-toggle--active":!s.value}),onClick:h},[dc,s.value?F("",!0):(M(),b("span",gc,"Start wave "+B(e.value+1),1)),s.value?(M(),b("span",pc,"Wave "+B(e.value),1)):F("",!0)],2),m("button",{class:"toggle",onClick:p[0]||(p[0]=(...w)=>t.controller.toggleBuildMenu&&t.controller.toggleBuildMenu(...w))},"  "),m("button",{class:W({toggle:!0,"toggle-toggled":r.value}),onClick:l},"  ",2),A(u).Instance.getDifficulty()!==A(H).Hard?(M(),b("button",{key:0,class:W({toggle:!0,"toggle-toggled":i.value}),onClick:d},"  ",2)):F("",!0)])])]))}});const mc=nt(fc,[["__scopeId","data-v-661c9c6d"]]),yc=.002;class wc{constructor(t,e,s){a(this,"entity");a(this,"category",T.Unknown);a(this,"renderData",{});a(this,"time",0);a(this,"travelTime");this.tile=t,this.target=e,this.damage=s,this.entity=new et(t.getX()+.5,t.getY()+.5,this);const i=t.getX()-e.getX(),r=t.getY()-e.getY(),o=Math.sqrt(i*i+r*r);this.travelTime=o/yc,this.time=this.travelTime/4,this.entity.lookAt(e)}tick(t){this.time>=this.travelTime&&(u.Instance.getSurface().despawn(this),[...u.Instance.getSurface().getEntitiesForCategory(T.Enemy)].filter(s=>s.getAlignedX()===this.target.getX()&&s.getAlignedY()===this.target.getY()).forEach(s=>{s.getAgent().AI.hit(this.damage)})),this.time=Math.min(this.time+t,this.travelTime);const e=this.time/this.travelTime;this.entity.setX(gt(this.tile.getX(),this.target.getX(),e)+.5),this.entity.setY(gt(this.tile.getY(),this.target.getY(),e)+.5)}getType(){return c.Shockwave}getTile(){return this.tile}isVisible(){return!0}}const vc=1e3,Sc=200,Ec=[[0,0],[1,0],[1,1],[0,1]],Mc=[[[-1,0],[-1,-1],[0,-1]],[[0,-1],[1,-1],[1,0]],[[1,0],[1,1],[0,1]],[[0,1],[-1,1],[-1,0]]];class kn{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"hp",30);a(this,"invincibleTime",0);a(this,"renderData",{});a(this,"baseParts",new Set);a(this,"basePartsByType",new Map);this.tile=t,this.entity=new X(t.getX(),t.getY(),this),this.baseParts.add(this)}tick(t){this.invincibleTime=Math.max(0,this.invincibleTime-t)}getType(){return c.Base}getTile(){return this.tile}updateTile(t){this.tile=t}getHp(){return this.hp}spawn(){it.Instance.registerAgent(this),Zt(this,4)}despawn(){it.Instance.removeAgent(this)}hit(t){this.invincibleTime>0||this.hp<=0||(this.hp-=t,this.hp<=0?(u.Instance.showMessage("You lose!",{closable:!1,expires:0}),u.Instance.getSurface().forceRerender(),x.Instance.triggerEvent(E.Lose)):(this.invincibleTime=vc,this.shockwave()),u.Instance.triggerStatUpdate(),x.Instance.triggerEvent(E.HitBase))}regenerate(t=1){this.hp+=this.getRegenerationFactor()*t}isVisible(){return!0}isDestroyed(){return this.hp<=0}addPart(t){this.baseParts.add(t),this.basePartsByType.set(t.getType(),(this.basePartsByType.get(t.getType())??0)+1)}removePart(t){this.baseParts.delete(t),this.basePartsByType.set(t.getType(),this.basePartsByType.get(t.getType())-1)}getParts(){return this.baseParts}getPartsCount(t){return this.basePartsByType.get(t)??0}getRegenerationFactor(){const t=this.getPartsCount(c.Armory),e=this.getPartsCount(c.Barracks);return t*50/(t+25)+e*50/(e+25)}getMoneyFactor(){const t=this.getPartsCount(c.Market);return 1+t*2.5/(t+25)}shockwave(){const t=u.Instance.getSurface(),e=new Map;this.baseParts.forEach(s=>{Ec.forEach(([i,r],o)=>{const h=t.getTile(s.getTile().getX()+i,s.getTile().getY()+r);Mc[o].forEach(([l,d])=>{const g=t.getTile(s.getTile().getX()+i+l,s.getTile().getY()+r+d);g&&!e.has(g.getHash())&&na.has(g.getType())&&e.set(g.getHash(),[h,g])})})}),e.forEach(([s,i])=>{const r=new wc(s,i,Sc);t.spawn(r)})}}a(kn,"scale",2);class Ic{constructor(t,e=0){a(this,"removeEventListeners");a(this,"done",!1);a(this,"steps");a(this,"highestProgress",0);a(this,"data",{});a(this,"initialProgress",0);a(this,"process",t=>{const e=Math.max(this.progress,this.initialProgress);this.progress=Math.max(this.definition.getProgress.call(this,t),this.progress),!this.isDone&&(this.updateProgress(),this.highestProgress>e&&(u.Instance.showMessage(` Achievement unlocked!
${this.title} - ${this.description}`),ns("achievements",{[Ps(this.definition.description)]:this.highestProgress},!0)))});this.definition=t,this.progress=e,this.initialProgress=e,this.steps=Object.keys(this.definition.thresholds).map(s=>parseFloat(s)),this.updateProgress()}get title(){return Object.values(this.definition.thresholds)[this.steps.indexOf(this.highestProgress)]}get description(){return this.definition.description}get thresholds(){return this.definition.thresholds}get stepValues(){return this.steps}get isDone(){return this.done}get internalProgress(){return this.progress}get completedThresholds(){return this.steps.indexOf(this.highestProgress)}get percentage(){const t=this.steps.at(-1);return this.progress/t}getPercentageForThreshold(t){const e=parseFloat(t),s=this.steps[this.steps.indexOf(e)-1]??0;return Math.min(Math.max(this.progress-s,0)/(e-s),1)}register(){this.removeEventListeners=x.Instance.addEventListeners(this.definition.triggers,this.process)}unRegister(){var t;(t=this.removeEventListeners)==null||t.call(this)}updateProgress(){for(let t=0;t<this.steps.length&&this.progress>=this.steps[t];t++)this.highestProgress=this.steps[t],t===this.steps.length-1&&(this.done=!0)}}const bc=[{description:"Reach a certain wave.",thresholds:{1:"Lvl 1 Street thug",5:"Lvl 5 Enforcer",10:"Lvl 10 Consigliere",15:"Lvl 15 Underboss",20:"Lvl 20 Don",30:"Lvl 30 Godfather"},getProgress:()=>u.Instance.getLevel(),triggers:[E.EndWave]},{description:"Discover the map.",thresholds:{"10%":"Settler","20%":"Trailblazer","40%":"Homesteader","60%":"Adventurer","90%":"Frontier explorer"},getProgress:()=>{const n=u.Instance.getSurface(),[t,e]=n.getTiles().reduce((s,i)=>(i.getType()===f.Void||(s[1]++,i.isDiscovered()&&s[0]++),s),[0,0]);return t/e*100},triggers:[E.StartWave]},{description:"Defeat enemies.",thresholds:{30:"Bot basher",100:"Circuit smasher",500:"Metal mauler",1e3:"Robo rampage",5e3:"Mechanic menace",1e4:"Robotic ruler"},getProgress:function(){const n=this.data.lastKilledEnemies??0,t=this.internalProgress+u.Instance.getKilledEnemies()-n;return this.data.lastKilledEnemies=u.Instance.getKilledEnemies(),t},triggers:[E.StatUpdate]},{description:"Discover the edge of the map.",thresholds:{1:"Edgelord"},getProgress:()=>it.Instance.isEdgeDiscovered()?1:0,triggers:[E.StartWave]},{description:"Reach level 10 on easy mode.",thresholds:{10:"Humble beginnings"},getProgress:()=>u.Instance.getDifficulty()===H.Easy?u.Instance.getLevel():0,triggers:[E.StartWave]},{description:"Reach level 10 on normal mode.",thresholds:{10:"Establishing dominance"},getProgress:()=>u.Instance.getDifficulty()===H.Normal?u.Instance.getLevel():0,triggers:[E.StartWave]},{description:"Reach level 10 on hard mode.",thresholds:{10:"A force to be reckoned with"},getProgress:()=>u.Instance.getDifficulty()===H.Hard?u.Instance.getLevel():0,triggers:[E.StartWave]},{description:"Build a wall of at least 30 tiles.",thresholds:{30:"Great wall of China"},getProgress:n=>{const t=n;return t.tiles[0].getType()!==f.Wall?0:$r(t.tiles[0],u.Instance.getSurface(),new Set([c.Wall]),!0)},triggers:[E.Buy]},{description:"Expand your base.",thresholds:{5:"Pompeii",12:"Alexandria",25:"Athens",50:"Rome"},getProgress:()=>u.Instance.getBase().getParts().size,triggers:[E.Buy]},{description:"Unlock new technologies.",thresholds:{2:"Innovator",5:"Visionary",8:"Groundbreaker",12:"Game-changer"},getProgress:()=>bt.Instance.getUnlockAmount(),triggers:[E.Unlock]}],Rn=()=>{const n=xe("achievements");return bc.map(t=>new Ic(t,(n==null?void 0:n[Ps(t.description)])??0)).sort((t,e)=>Number(e.isDone)-Number(t.isDone)||e.completedThresholds-t.completedThresholds||e.percentage-t.percentage)},ei=class{constructor(){a(this,"achievements");a(this,"unRegister",()=>{const t={};this.achievements.forEach(e=>{t[Ps(e.description)]=e.internalProgress,e.unRegister()}),ns("achievements",t,!0)});ei.instance=this,this.achievements=Rn(),this.achievements.forEach(t=>t.register()),window.addEventListener("beforeunload",this.unRegister)}static get Instance(){return this.instance}};let Vt=ei;a(Vt,"instance");class Tc extends u{constructor(e,s,i,r){super(e,s,i,r);a(this,"killedEnemies",0);a(this,"showMessage",(...e)=>this.messageFn(...e));a(this,"onUnlock",({placeable:e})=>{const s=this.getIsStarted();e.entityType===c.EmergencyRecharge&&(V.Instance.emergencyRegenerate(s?1:Ve),this.triggerStatUpdate()),e.entityType===c.EmergencyRepair&&(this.base.hp+=2*this.base.getParts().size*(s?1:Ve),this.triggerStatUpdate())});a(this,"onDiscover",()=>{bt.Instance.addPoint()});this.surface.getEntityTiles(this.base).map(o=>{o.hasStaticEntity()&&this.surface.despawnStatic(o.getStaticEntity().getAgent())}),i.spawnStatic(this.base),x.Instance.addEventListener(E.Unlock,this.onUnlock),x.Instance.addEventListener(E.Discover,this.onDiscover),console.log(this)}tick(e){if(this.surface.processChangedTiles(),this.base.isDestroyed())return;const s=this.surface.getEntities();for(let r of s)r.getAgent().tick&&r.getAgent().tick(e);const i=this.surface.getStaticEntities();for(let r of i)r.getAgent().tick&&r.getAgent().tick(e);q.Instance.tick(e)}triggerStatUpdate(){const e=this.getSurface().getEntitiesForCategory(T.Enemy).size;x.Instance.triggerEvent(E.StatUpdate,{integrity:this.base.getHp(),regeneration:this.base.getRegenerationFactor(),level:this.level,money:N.Instance.getMoney(),moneyMultiplier:N.Instance.getMultiplier(),production:V.Instance.getProduction(),consumption:V.Instance.getConsumption(),power:V.Instance.getPower(),remainingEnemies:e,inProgress:this.getIsStarted(),towers:this.surface.getTowers().size,maxTowers:ht.Instance.getMaxTowers()})}spawnEnemy(e){this.surface.spawn(e),this.triggerStatUpdate()}despawnEnemy(e){this.killedEnemies++,this.surface.despawn(e)&&(q.Instance.processWave()?this.end():this.triggerStatUpdate())}getKilledEnemies(){return this.killedEnemies}getIsStarted(){return q.Instance.isWaveInProgress()}canBuy(e,s=1){const i=(fe[e.entityType]??0)*s;return i>N.Instance.getMoney()?(this.showMessage(`You do not have enough money. This costs  ${i}`),!1):!0}start(){if(this.getIsStarted())throw new Error("Wave already in progress!");if(this.surface.getTowers().size>ht.Instance.getMaxTowers()){u.Instance.showMessage(`Your current base can support up to ${ht.Instance.getMaxTowers()} towers. Extend your base or sell towers before starting `);return}V.Instance.processPower(),N.Instance.clearRecents(),N.Instance.addWaveBudget(this.level),q.Instance.startNewWave(),it.Instance.commit(),this.level++,it.Instance.updateBaseRange(),x.Instance.triggerEvent(E.StartWave),this.triggerStatUpdate(),u.Instance.getSurface().forceRerender()}consume(e,s=1,i=1){return V.Instance.consume((Ts[e.getType()]??0)+(s-1)*V.speedBeaconConsumption+(i-1)*V.damageBeaconConsumption)}consumeContinuous(e,s,i=1){return V.Instance.consume((Ts[e.getType()]??0)*s+(i-1)*V.damageBeaconConsumption*s/160)}getDifficulty(){return this.difficulty}getIsBaseDestroyed(){return this.base.isDestroyed()}end(){ht.Instance.commit(),it.Instance.commit(),q.Instance.cleanupSpawnGroups(),this.base.regenerate(),this.triggerStatUpdate(),x.Instance.triggerEvent(E.EndWave),q.Instance.shouldAddSpawnGroup()&&(x.Instance.triggerEvent(E.Spawn),this.showMessage("Another spawn point has appeared!")),u.Instance.getSurface().forceRerender()}getDamageMultiplier(){let e=1;switch(this.difficulty){case H.Hard:e+=.2;case H.Normal:e+=.2}return e}}const _c=(n,t,e,s)=>{new it(e);const i=new kn(t),r=new Tc(n,i,e,s);return new q(i,e),new V,new N(100,()=>i.getMoneyFactor()),new ht(e),new bt,new Vt,r},xc=n=>(Dt("data-v-521809d4"),n=n(),Ct(),n),Ac={class:"wrapper"},Pc={height:"0",style:{position:"absolute"}},kc=xc(()=>m("defs",null,[m("radialGradient",{id:"alert"},[m("stop",{offset:"0%","stop-color":"red","stop-opacity":"0"}),m("stop",{offset:"95%","stop-color":"red","stop-opacity":"0"}),m("stop",{offset:"100%","stop-color":"red","stop-opacity":"0.8"})])],-1)),Rc=[kc],Dc={class:"canvas"},Cc=J({__name:"Game",props:{seed:null,difficulty:null,renderer:null,showTutorial:{type:Boolean},mainMenu:{type:Function}},setup(n){const t=n,e=P(null),s=P(!1),i=P(!1),r=new ca({width:160,height:160,generate:ra(t.seed,160,160)}),o=new St(r);let h=new t.renderer(r,o);const l=r.getTile(80,80),d=_c(t.difficulty,l,r,h.showMessage),g=new Gr;t.showTutorial&&g.start();let p=!1,w,v,I,L;Se(()=>{p=!0,h.mount(e.value),v=o.addKeyListener(K.Escape,()=>{if(i.value){St.Instance.toggleBuildMenu();return}s.value=!s.value,s.value?o.pause():o.unpause()}),I=x.Instance.addEventListener(E.OpenBuildMenu,()=>i.value=!0),L=x.Instance.addEventListener(E.CloseBuildMenu,()=>i.value=!1);const S=_=>{if(!p)return;const j=+o.isKeyDown(K.Right)+ +o.isKeyDown(K.D)-+o.isKeyDown(K.Left)-+o.isKeyDown(K.A)-+o.isKeyDown(K.Q),lt=+o.isKeyDown(K.Down)+ +o.isKeyDown(K.S)-+o.isKeyDown(K.Up)-+o.isKeyDown(K.W)-+o.isKeyDown(K.Z),At=+o.isKeyDown(K.Plus)+ +o.isKeyDown(K.Equals)-+o.isKeyDown(K.Minus);(j||lt||At)&&h.move({x:j,y:lt,zoom:At});const Lt=w?_-w:16;s.value||d.tick(Lt),h.rerender(Lt),w=_,window.requestAnimationFrame(S)};window.requestAnimationFrame(S)}),Je(()=>{h.unmount(),Vt.Instance.unRegister(),v(),I(),L(),p=!1});const D=(S,_)=>{S&&!(h instanceof S)?(h.unmount(),r.forceRerender(),h=new S(r,o),h.mount(e.value),d.update(h.showMessage)):h instanceof ct&&h.updateSettings(),!g.isStarted&&_&&g.start(),g.isStarted&&_===!1&&g.stop(),s.value=!1,o.unpause()},O=()=>{Vt.Instance.unRegister(),t.mainMenu()};return(S,_)=>(M(),b("div",Ac,[(M(),b("svg",Pc,Rc)),R(mc,{renderer:A(h),controller:A(St).Instance},null,8,["renderer","controller"]),m("div",Dc,[m("div",{class:"render-target",ref_key:"canvas",ref:e},null,512),R(wo,{controller:A(St).Instance,unlocksController:A(bt).Instance,eventSystem:A(x).Instance,visible:i.value},null,8,["controller","unlocksController","eventSystem","visible"]),R(Kh,{mainMenu:O,visible:s.value,resume:D},null,8,["visible"])])]))}});const Bc=nt(Cc,[["__scopeId","data-v-521809d4"]]);const Lc={},$c={class:"key-grid"};function Oc(n,t){return M(),b("div",$c,[Vn(n.$slots,"default",{},void 0,!0)])}const ys=nt(Lc,[["render",Oc],["__scopeId","data-v-ad6fcae2"]]),Ae=n=>(Dt("data-v-52ee7b24"),n=n(),Ct(),n),Yc=Ae(()=>m("h3",null,"Build menu",-1)),Fc={class:"flex"},Xc=Ae(()=>m("h3",null,"Building",-1)),Nc={class:"flex flex-justify"},Uc={class:"key-combination"},Wc={class:"key-combination"},Hc=Ae(()=>m("h3",null,"Moving",-1)),Gc={class:"flex flex-justify"},Vc=Ae(()=>m("h3",null,"Zooming",-1)),jc={class:"flex"},zc=Ae(()=>m("h3",null,"Toggle selling",-1)),Kc={class:"flex"},qc=J({__name:"ControlsList",setup(n){return(t,e)=>(M(),b(ut,null,[Yc,m("div",Fc,[R(Y,{char:"e"}),C(" / "),R(Y,{char:"b"})]),Xc,m("div",Nc,[R(Xe,{button:"left"}),C(" / "),m("span",Uc,[R(Y,{char:""}),C(" + "),R(Xe,{button:"left"})]),C(" / "),m("span",Wc,[R(Y,{char:""}),C(" + "),R(Xe,{button:"left"})])]),Hc,m("div",Gc,[R(ys,null,{default:cs(()=>[R(Y,{char:"w",area:"up"}),R(Y,{char:"a",area:"left"}),R(Y,{char:"s",area:"down"}),R(Y,{char:"d",area:"right"})]),_:1}),C(" / "),R(ys,null,{default:cs(()=>[R(Y,{char:"z",area:"up"}),R(Y,{char:"q",area:"left"}),R(Y,{char:"s",area:"down"}),R(Y,{char:"d",area:"right"})]),_:1}),C(" / "),R(ys,null,{default:cs(()=>[R(Y,{char:"",area:"up"}),R(Y,{char:"",area:"left"}),R(Y,{char:"",area:"down"}),R(Y,{char:"",area:"right"})]),_:1})]),Vc,m("div",jc,[R(Y,{char:"-"}),R(Y,{char:"+"})]),zc,m("div",Kc,[R(Y,{char:"f"})])],64))}});const Zc=nt(qc,[["__scopeId","data-v-52ee7b24"]]),Dn=n=>(Dt("data-v-55661321"),n=n(),Ct(),n),Jc={class:"achievement-title"},Qc={class:"achievement-description"},tl={key:0,class:"achievement-progress"},el={class:"achievement-line"},sl=["title"],il=Dn(()=>m("span",{class:"line"},null,-1)),nl={class:"marker"},al=Dn(()=>m("span",{class:"achievement-line-segment"},[m("span",{class:"line"})],-1)),rl=[al],ol={class:"achievement-percentage"},hl=J({__name:"Achievement",props:{achievement:null},setup(n){const{achievement:t}=n,e="???????",s=Intl.NumberFormat(void 0,{style:"percent",maximumFractionDigits:0}),i=t.stepValues.at(-1),r=t.percentage;return(o,h)=>(M(),b("div",{class:W({achievement:!0,"achievement--complete":n.achievement.isDone})},[m("h2",Jc,B(n.achievement.title??e),1),m("p",Qc,B(n.achievement.description),1),n.achievement.stepValues.length>1||A(i)!==1?(M(),b("div",tl,[m("span",el,[m("span",{class:"achievement-line-nominal",style:Oe({flex:A(i)})},[(M(!0),b(ut,null,Rt(n.achievement.thresholds,(l,d)=>(M(),b("span",{class:W({"achievement-line-segment":!0}),style:Oe({"--progress":`${n.achievement.getPercentageForThreshold(d)*100}%`}),title:n.achievement.internalProgress>=parseFloat(d)?l:n.achievement.internalProgress.toFixed()},[il,m("span",nl,B(d),1)],12,sl))),256))],4),n.achievement.internalProgress>A(i)?(M(),b("span",{key:0,class:"achievement-line-overflow",style:Oe({flex:n.achievement.internalProgress-A(i)})},rl,4)):F("",!0)]),m("p",ol,B(A(r)>1?n.achievement.internalProgress:A(s).format(A(r))),1)])):F("",!0)],2))}});const cl=nt(hl,[["__scopeId","data-v-55661321"]]),ll=J({__name:"AchievementsList",setup(n){const t=Rn();return(e,s)=>(M(!0),b(ut,null,Rt(A(t),i=>(M(),Wt(cl,{achievement:i},null,8,["achievement"]))),256))}}),ul="0.0.3",as=n=>(Dt("data-v-0d7d3862"),n=n(),Ct(),n),dl={class:"wrapper"},gl=as(()=>m("h1",null,"Open Tower Defense ",-1)),pl={class:"menu"},fl={class:"menu-main"},ml={class:"menu-main-inner"},yl=["value"],wl={class:"difficulty-description"},vl=as(()=>m("button",{type:"submit"},"Start!",-1)),Sl={class:"menu-controls-inner"},El={class:"menu-controls-inner"},Ml={class:"menu-settings-inner"},Il={class:"footer"},bl=as(()=>m("a",{class:"footer-link",href:"https://github.com/lorgan3/open-td/releases",target:"_blank",rel:"noopener noreferrer"},"Release notes",-1)),Tl={key:0},_l=as(()=>m("span",{class:"spinner"},"",-1)),xl=J({__name:"MainMenu",props:{onPlay:{type:Function}},setup(n){const t=n,e=P(0),s=P(""),i=P(null),r=xe("settings"),o=P((r==null?void 0:r.difficulty)||H.Easy),h=P(!0);xn().then(()=>h.value=!1);let l;const d=w=>l=w,g=w=>{var v;if(w===e.value){e.value=0;return}e.value=w,e.value===1&&((v=i.value)==null||v.focus())},p=w=>{w.preventDefault();const v=l();ns("settings",{...v,difficulty:o.value}),t.onPlay(s.value,o.value,v.renderer,v.showTutorial)};return(w,v)=>(M(),b("div",dl,[gl,m("div",pl,[m("div",fl,[m("div",ml,[m("button",{onClick:v[0]||(v[0]=I=>g(1))},"Play"),m("button",{onClick:v[1]||(v[1]=I=>g(2))},"Controls"),m("button",{onClick:v[2]||(v[2]=I=>g(3))},"Achievements"),m("button",{onClick:v[3]||(v[3]=I=>g(4))},"Settings")])]),m("div",{class:W({"menu-play":!0,"menu--hidden":e.value!==1})},[m("form",{onSubmit:p,class:"menu-play-inner"},[m("label",null,[C(" Which planet? "),ue(m("input",{ref_key:"seedInput",ref:i,"onUpdate:modelValue":v[4]||(v[4]=I=>s.value=I)},null,512),[[Di,s.value]])]),m("label",null,[C(" Difficulty "),ue(m("select",{"onUpdate:modelValue":v[5]||(v[5]=I=>o.value=I)},[(M(!0),b(ut,null,Rt(A(ai),({label:I},L)=>(M(),b("option",{value:L},B(I),9,yl))),256))],512),[[Ri,o.value]])]),m("p",wl,B(A(ai)[o.value].description),1),vl],32)],2),m("div",{class:W({"menu-controls":!0,"menu--hidden":e.value!==2})},[m("div",Sl,[R(Zc)])],2),m("div",{class:W({"menu-achievements":!0,"menu--hidden":e.value!==3})},[m("div",El,[R(ll)])],2),m("div",{class:W({"menu-settings":!0,"menu--hidden":e.value!==4})},[m("div",Ml,[R(An,{setSubmitter:d})])],2)]),m("div",Il,[m("span",null,B(A(ul)),1),bl,h.value?(M(),b("span",Tl,[_l,C(" Loading assets")])):F("",!0)])]))}});const Al=nt(xl,[["__scopeId","data-v-0d7d3862"]]),Pl=J({__name:"App",setup(n){const t=P(0),e=P(),s=P(),i=P(),r=P(),o=(l,d,g,p)=>{t.value=1,e.value=l,s.value=d,i.value=g,r.value=p},h=()=>t.value=0;return(l,d)=>(M(),b(ut,null,[t.value==0?(M(),Wt(Al,{key:0,onPlay:o})):F("",!0),t.value==1?(M(),Wt(Bc,{key:1,seed:e.value,difficulty:s.value,renderer:i.value,showTutorial:r.value,mainMenu:h},null,8,["seed","difficulty","renderer","showTutorial"])):F("",!0)],64))}});As(Pl).mount("#app");
