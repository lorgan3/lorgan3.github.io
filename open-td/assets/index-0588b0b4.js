var nr=Object.defineProperty;var ar=(i,t,e)=>t in i?nr(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var a=(i,t,e)=>(ar(i,typeof t!="symbol"?t+"":t,e),e);import{A as rr,c as or,H as cr,d as J,o as b,a as T,t as $,b as gt,u as P,g as Ae,h as _,j as hr,l as lr,m as F,q as At,s as H,F as ft,v as pe,x as Lt,y,z as C,B as Gn,C as Fi,D as Qs,G as fe,I as me,J as re,K as Hn,L as ur,M as Ps,N as Wn,O as dr,P as Pt,Q as $i,R as gr,S as pr,T as fr,U as mr}from"./vendor-88ce0dc8.js";import{C as Bt,P as os,S as G,A as ee,s as q,a as yr,G as cs,T as Xi,b as rn,U as wr,L as vr,F as Sr,c as on,d as Er,e as Vn,M as jn,f as Nt,g as Kn,B as qn,h as br,i as Ir,j as Mr,k as xr}from"./pixi-21338c76.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();let Cr=1;class at{constructor(t,e,s){a(this,"id");a(this,"rotation",0);this.x=t,this.y=e,this.agent=s,this.id=Cr++}getX(){return this.x}getAlignedX(){return this.x|0}getY(){return this.y}getAlignedY(){return this.y|0}getAgent(){return this.agent}getId(){return this.id}setX(t){this.x=t}setY(t){this.y=t}getRotation(){return this.rotation}setRotation(t){this.rotation=t}move(t,e,s){const n=(e.getX()-t.getX())*s+t.getX(),r=(e.getY()-t.getY())*s+t.getY();this.setX(n),this.setY(r),this.lookAt(e)}lookAt(t,e){let s,n;e!==void 0?(s=t-this.x,n=e-this.y):(s=t.getX()-this.x,n=t.getY()-this.y),(s||n)&&this.setRotation(Math.atan2(n,s)*180/Math.PI+90)}}const zt=i=>i.constructor.scale,bt=i=>{const t=zt(i),e=i.getTile();return[e.getX()+t/2,e.getY()+t/2]};function mi(i){return i?"getTile"in i:!1}class W extends at{constructor(t,e,s){super(t,e,s)}getAgent(){return this.agent}}var R=(i=>(i[i.Unknown=0]="Unknown",i[i.Player=1]="Player",i[i.Enemy=2]="Enemy",i))(R||{}),c=(i=>(i[i.None=0]="None",i[i.Tower=1]="Tower",i[i.Slime=2]="Slime",i[i.Base=3]="Base",i[i.Bullet=4]="Bullet",i[i.Wall=5]="Wall",i[i.Mortar=6]="Mortar",i[i.Flamethrower=7]="Flamethrower",i[i.Flame=8]="Flame",i[i.Railgun=9]="Railgun",i[i.Rail=10]="Rail",i[i.ElectricFence=11]="ElectricFence",i[i.Fence=12]="Fence",i[i.Freezer=13]="Freezer",i[i.Tree=14]="Tree",i[i.Pine=15]="Pine",i[i.Cactus=16]="Cactus",i[i.Stump=17]="Stump",i[i.Rock=18]="Rock",i[i.Rock2=19]="Rock2",i[i.Rock3=20]="Rock3",i[i.Radar=21]="Radar",i[i.PowerPlant=22]="PowerPlant",i[i.Blueprint=23]="Blueprint",i[i.Shockwave=24]="Shockwave",i[i.Armory=25]="Armory",i[i.Market=26]="Market",i[i.SpeedBeacon=27]="SpeedBeacon",i[i.Runner=28]="Runner",i[i.DamageBeacon=29]="DamageBeacon",i[i.Laser=30]="Laser",i[i.LaserBeam=31]="LaserBeam",i[i.Flier=32]="Flier",i[i.Tank=33]="Tank",i[i.Rocket=34]="Rocket",i[i.WavePoint=35]="WavePoint",i[i.Barracks=36]="Barracks",i[i.Tesla=37]="Tesla",i[i.Spark=38]="Spark",i[i.Behemoth=39]="Behemoth",i[i.Bore=40]="Bore",i[i.Excavator=41]="Excavator",i[i.Convert=42]="Convert",i[i.Terraform=43]="Terraform",i[i.EmergencyRecharge=44]="EmergencyRecharge",i[i.EmergencyRepair=45]="EmergencyRepair",i))(c||{}),Js=(i=>(i[i.Simple=0]="Simple",i[i.Pine=1]="Pine",i[i.Cactus=2]="Cactus",i))(Js||{}),ti=(i=>(i[i.Rock1=0]="Rock1",i[i.Rock2=1]="Rock2",i[i.Rock3=1]="Rock3",i))(ti||{});const fs=new Set([3,21,22,25,26,36]),de=new Set([...fs,1,6,7,9,14,15,16,18,19,20,27,29,30,5,37]);var z=(i=>(i[i.Undiscovered=0]="Undiscovered",i[i.Pending=1]="Pending",i[i.Discovered=2]="Discovered",i))(z||{}),f=(i=>(i[i.Void=0]="Void",i[i.Grass=1]="Grass",i[i.Stone=2]="Stone",i[i.Water=3]="Water",i[i.Obstructed=4]="Obstructed",i[i.Wall=5]="Wall",i[i.Spore=6]="Spore",i[i.ElectricFence=7]="ElectricFence",i[i.Fence=8]="Fence",i[i.Freezer=9]="Freezer",i[i.Bridge=10]="Bridge",i[i.Dirt=11]="Dirt",i[i.Snow=12]="Snow",i[i.Sand=13]="Sand",i[i.Ice=14]="Ice",i[i.PlayerBuilding=15]="PlayerBuilding",i[i.Tree=16]="Tree",i[i.Rock=17]="Rock",i[i.Base=18]="Base",i))(f||{}),dt=(i=>(i[i.WaterAlt=19]="WaterAlt",i[i.WaterStill=20]="WaterStill",i[i.GrassFlower=21]="GrassFlower",i[i.GrassAlt=22]="GrassAlt",i[i.GrassPlain=23]="GrassPlain",i[i.SandAlt=24]="SandAlt",i[i.SnowAlt=25]="SnowAlt",i[i.IceAlt=26]="IceAlt",i[i.Static1=27]="Static1",i[i.Static2=28]="Static2",i[i.Static3=29]="Static3",i))(dt||{});const Tr={19:3,20:3,21:1,22:1,23:1,24:13,25:12,26:14,27:0,28:0,29:0},Ni=new Set([1,2,11,13,12]),Ds=new Set([...Ni,3,14,10,16,17]),kr=new Set([...Ds,9,7,8]),Ar={[c.Tower]:4,[c.Wall]:5,[c.Mortar]:4,[c.Flamethrower]:4,[c.Railgun]:4,[c.ElectricFence]:7,[c.Fence]:8,[c.Freezer]:9,[c.Radar]:18,[c.PowerPlant]:18,[c.Tree]:16,[c.Rock]:17,[c.Armory]:18,[c.Base]:18,[c.Market]:18,[c.SpeedBeacon]:4,[c.DamageBeacon]:4,[c.Laser]:4,[c.Barracks]:18,[c.Tesla]:4};class et{constructor(t,e,s=f.Void){a(this,"staticEntity",null);a(this,"hash");a(this,"actualType");a(this,"type");a(this,"towers",[]);a(this,"linkedAgents");a(this,"discoveryStatus",z.Undiscovered);this.x=t,this.y=e,this.altType=s,this.hash=`[${this.x}, ${this.y}]`,this.type=Tr[s]??s,this.actualType=this.type}serialize(){return{x:this.x,y:this.y,type:this.type}}getX(){return this.x}getY(){return this.y}getBaseType(){return this.type}getAltType(){return this.altType}getAnimation(){return this.type===f.Water?[f.Water,dt.WaterAlt,dt.WaterStill]:[this.altType]}getType(){return this.actualType}getStaticEntity(){return this.staticEntity}hasStaticEntity(){return this.staticEntity!==null}setStaticEntity(t){if(t===this.staticEntity)return;if(this.staticEntity!==null)throw new Error("A tile can only have 1 static entity.");const e=t.getAgent();mi(e)&&e.getTile().getHash()===this.getHash()&&(e.updateTile(this),this.linkedAgents&&e.updateLinkedAgents&&e.updateLinkedAgents(this.linkedAgents)),this.staticEntity=t,this.actualType=Ar[t.getAgent().getType()]||this.type}clearStaticEntity(){this.staticEntity=null,this.actualType=this.type}isStaticEntityRoot(){var t;return((t=this.staticEntity)==null?void 0:t.getAgent().getTile())===this}addTower(t){this.towers.includes(t)||this.towers.push(t)}setDiscoveryStatus(t){this.discoveryStatus=t}isDiscovered(){return this.discoveryStatus===z.Discovered}getDiscoveryStatus(){return this.discoveryStatus}isCoveredByTower(){return this.isDiscovered()&&this.towers.length>0}removeTower(t){this.towers.splice(this.towers.indexOf(t),1)}getAvailableTowers(){return this.towers.filter(t=>t.getCooldown()<=0)}getTowers(){return this.towers}addLinkedAgent(t){var s;this.linkedAgents||(this.linkedAgents=new Set),this.linkedAgents.add(t);const e=(s=this.staticEntity)==null?void 0:s.getAgent();e&&e.updateLinkedAgents&&e.updateLinkedAgents(this.linkedAgents)}removeLinkedAgent(t){var s;if(!this.linkedAgents)return;this.linkedAgents.delete(t);const e=(s=this.staticEntity)==null?void 0:s.getAgent();mi(e)&&e.updateLinkedAgents&&e.updateLinkedAgents(this.linkedAgents)}getLinkedAgents(){return this.linkedAgents}getHash(){return this.hash}sync(t){this.towers=t.towers,this.discoveryStatus=t.discoveryStatus}}const Me=class Me{constructor(t,e,s,n){a(this,"level",0);this.difficulty=t,this.base=e,this.surface=s,this.messageFn=n,Me.instance&&Me.instance.cleanup(),Me.instance=this}getSurface(){return this.surface}getBase(){return this.base}getLevel(){return this.level}update(t){this.messageFn=t}getDifficulty(){return this.difficulty}static get Instance(){return this.instance}};a(Me,"instance");let u=Me;class ms{constructor(t){a(this,"entity");a(this,"category",R.Unknown);a(this,"hp",30);a(this,"renderData",{});this.tile=t,this.entity=new W(t.getX(),t.getY(),this),this.renderData.subType=Js.Simple}getType(){return c.Tree}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){this.hp-=t,this.hp<=0&&(this.renderData.chopped=!0,u.Instance.getSurface().despawnStatic(this))}isVisible(){return this.tile.isDiscovered()}}a(ms,"scale",1);class ys{constructor(t){a(this,"entity");a(this,"category",R.Unknown);a(this,"hp",30);a(this,"renderData",{});this.tile=t,this.entity=new W(t.getX(),t.getY(),this),this.renderData.subType=ti.Rock1}getType(){return c.Rock}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return this.tile.isDiscovered()}}a(ys,"scale",1);class Zn extends ys{constructor(t){super(t),this.renderData.subType=ti.Rock3}getType(){return c.Rock3}}class Qn extends ms{constructor(t){super(t),this.renderData.subType=Js.Cactus}getType(){return c.Cactus}}class Jn extends ms{constructor(t){super(t),this.renderData.subType=Js.Pine}getType(){return c.Pine}}const Pr=(i,t,e)=>{const s=rr(i),n=or(s),r=n(1,0)*193,o=n(0,1)*197,h=.048,l=.0077,d=.0025,g=.0194,p=.039,v=13,m=v*2,M=.1,A=.95,I={top:[],right:[],bottom:[],left:[]};for(let x=0;x<t;x++){let D=0;x<m?D=(m-x)*M:x>t-m&&(D=(m-t+x)*M),I.top[x]=(n(x*p,0)+1+D)*v,I.bottom[x]=(n(x*p,e*p)+1+D)*v}for(let x=0;x<e;x++){let D=0;x<m?D=(m-x)*M:x>e-m&&(D=(m-e+x)*M),I.right[x]=(n(t*p,x*p)+1+D)*v,I.left[x]=(n(0,x*p)+1+D)*v}return(x,D)=>{if(D<I.top[x]||D>e-I.bottom[x]||x<I.left[D]||x>t-I.right[D])return new et(x,D,f.Void);const U=x+r,ut=D+o,Rt=n(U*h,ut*h),Se=n(U*d,ut*d),ie=Math.abs(Se),Es=n(U*l,ut*l),ri=1-Math.abs(Es),bs=n(U*g,ut*g),an=Math.abs(bs),It=(Se+bs/3)*.83,Is=It+ie*9241%1/3,sr=ri>A+It/10,ir=ri+Rt/3+bs-.4>A+It/2;if(sr||ir)return Se+ie*1811%1/7<-.6?new et(x,D,ie*1439%1>.5?f.Ice:dt.IceAlt):new et(x,D,f.Water);if(ri>A+It/15)return new et(x,D,f.Dirt);let Mt;if(It>.3)Mt=new et(x,D,It*1439%1>.3?f.Sand:dt.SandAlt);else if(It<-.5)Mt=new et(x,D,It*-1439%1>.3?f.Snow:dt.SnowAlt);else{const ne=Math.abs(It)*4999%1;Mt=new et(x,D,ne<.05?dt.GrassFlower:ne<.1?dt.GrassAlt:ne<.6?dt.GrassPlain:f.Grass)}const oi=(bs+.5)*(Rt-.5)+ie*5419%1/10;if(oi<.07&&oi>.04&&Is>-.4&&Is<.6){const ne=It>.3?new Qn(Mt):It<-.4||oi<.045?new Jn(Mt):new ms(Mt);Mt.setStaticEntity(ne.entity)}else if((Is<-.5||Is>.7)&&an*2791%1>.99){const ne=an>.5?new ys(Mt):new Zn(Mt);Mt.setStaticEntity(ne.entity)}return Mt}};var E=(i=>(i[i.StatUpdate=0]="StatUpdate",i[i.SurfaceChange=1]="SurfaceChange",i[i.BlackOut=2]="BlackOut",i[i.OpenBuildMenu=3]="OpenBuildMenu",i[i.CloseBuildMenu=4]="CloseBuildMenu",i[i.SelectPlaceable=5]="SelectPlaceable",i[i.ToggleShowCoverage=6]="ToggleShowCoverage",i[i.StartWave=7]="StartWave",i[i.EndWave=8]="EndWave",i[i.Unlock=9]="Unlock",i[i.Discover=10]="Discover",i[i.Spawn=11]="Spawn",i[i.Buy=12]="Buy",i[i.Sell=13]="Sell",i[i.HitBase=14]="HitBase",i[i.Lose=15]="Lose",i[i.Kill=16]="Kill",i[i.Pierce=17]="Pierce",i[i.Bomb=18]="Bomb",i[i.Stun=19]="Stun",i))(E||{}),Ls=(i=>(i[i.Base=0]="Base",i[i.Radar=1]="Radar",i))(Ls||{});const js=class js{constructor(){a(this,"eventHandlers");js.instance=this,this.eventHandlers=new Map}addEventListener(t,e){return this.eventHandlers.has(t)?this.eventHandlers.get(t).add(e):this.eventHandlers.set(t,new Set([e])),()=>this.removeEventListener(t,e)}addEventListeners(t,e){const s=t.map(n=>this.addEventListener(n,e));return()=>s.forEach(n=>n())}removeEventListener(t,e){var s;(s=this.eventHandlers.get(t))==null||s.delete(e)}triggerEvent(t,...e){var s;(s=this.eventHandlers.get(t))==null||s.forEach(n=>n(...e))}static get Instance(){return this.instance}};a(js,"instance");let B=js;const Ve=class Ve{constructor(t){a(this,"entity");a(this,"category",R.Player);a(this,"hp",50);a(this,"renderData",{});this.tile=t,this.entity=new W(t.getX(),t.getY(),this)}spawn(){u.Instance.getSurface().getAdjacentTiles(this.tile,Ve.scale).forEach(t=>t.addLinkedAgent(this))}despawn(){u.Instance.getSurface().getAdjacentTiles(this.tile,Ve.scale).forEach(t=>t.removeLinkedAgent(this))}getType(){return c.DamageBeacon}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}};a(Ve,"scale",2);let hs=Ve;const je=class je{constructor(t){a(this,"entity");a(this,"category",R.Player);a(this,"hp",50);a(this,"renderData",{});this.tile=t,this.entity=new W(t.getX(),t.getY(),this)}spawn(){u.Instance.getSurface().getAdjacentTiles(this.tile,je.scale).forEach(t=>t.addLinkedAgent(this))}despawn(){u.Instance.getSurface().getAdjacentTiles(this.tile,je.scale).forEach(t=>t.removeLinkedAgent(this))}getType(){return c.SpeedBeacon}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}};a(je,"scale",2);let ls=je;function yi(i){return"getCooldown"in i}const Br=i=>i.constructor.range,De=(i,t,e)=>{const s=u.Instance.getSurface(),n=new Set,r=()=>{const l=s.getEntityTiles(i),d=new Set(l);s.forCircle(i.entity.getX()+1,i.entity.getY()+1,t,g=>{let p;g.getX()<=i.entity.getAlignedX()?g.getY()<=i.entity.getAlignedY()?p=l[0]:p=l[2]:g.getY()<=i.entity.getAlignedY()?p=l[1]:p=l[3],s.forLine(p.getX(),p.getY(),g.getX(),g.getY(),v=>{if(v.addTower(i),n.add(v),!d.has(v)&&e&&e(v))return!1},{connected:!0})},{edgeOnly:!0})};let o=!0;const h=B.Instance.addEventListener(E.SurfaceChange,({affectedTiles:l})=>{if(o){o=!1,r();return}for(const d of l)if(n.has(d)){n.forEach(g=>g.removeTower(i)),n.clear(),r();return}});return[()=>{n.forEach(l=>l.removeTower(i)),h()},n]},Le=i=>{let t=1;return i.forEach(e=>{e instanceof ls&&(t+=.5)}),t},Ye=i=>{let t=1;return i.forEach(e=>{e instanceof hs&&(t+=.5)}),t},ta=[[1,0],[-1,0],[0,1],[0,-1]],Rr=[...ta,[1,1],[-1,-1],[-1,1],[1,-1]],xe=class xe{constructor(t,e){a(this,"tileBufferSize");this.buffer=t,this.staticEntityConstructor=e,this.tileBufferSize=this.withEntities?2:1}get width(){return this.buffer[0]}get height(){return this.buffer[1]}get withEntities(){return this.buffer[2]}getTile(t){const e=xe.propertyCount+t*this.tileBufferSize,s=new et(t%this.width,Math.floor(t/this.width),this.buffer[e]);if(this.withEntities&&this.staticEntityConstructor){const n=this.staticEntityConstructor(this.buffer[e+1],s);n&&s.setStaticEntity(n)}return s}static serializeSurface(t,e){const s=e?2:1,n=new Uint8Array(xe.propertyCount+t.map.length*s);n[0]=t.getWidth(),n[1]=t.getHeight(),n[2]=e?1:0;for(let r=0;r<t.map.length;r++){const o=t.map[r],h=r*s+xe.propertyCount;if(n[h]=e?o.getAltType():o.getType(),e){const l=o.hasStaticEntity()&&o.getStaticEntity().getAgent().getTile()===o?o.getStaticEntity().getAgent():null;n[h+1]=(l==null?void 0:l.getType())??c.None}}return n}};a(xe,"propertyCount",3);let Zt=xe;class ea{constructor(t){a(this,"map");a(this,"entities",[]);a(this,"deletedEntities",[]);a(this,"tickingEntities",[]);a(this,"entitiesMap",new Map);a(this,"towers",new Set);a(this,"width");a(this,"height");a(this,"dirty",!1);a(this,"_version",0);a(this,"changedTiles",new Set);a(this,"addedAgents",new Set);a(this,"removedAgents",new Set);a(this,"initialized",!1);this.width=t.width,this.height=t.height;const e=t instanceof Zt?t:t.generate;this.initialize(e??((s,n)=>new et(s,n))),this.initialized=!0}serialize(t){return new Zt(Zt.serializeSurface(this,t))}initialize(t){this.entities=[],this.deletedEntities=[],this.entitiesMap.clear(),Object.values(R).filter(s=>typeof s!="string").forEach(s=>this.entitiesMap.set(s,new Set)),this.map=new Array(this.width*this.height);const e=[];if(t instanceof Zt)for(let s=0;s<this.map.length;s++){const n=t.getTile(s);this.map[s]=n,n.hasStaticEntity()&&e.push(n.getStaticEntity())}else for(let s=0;s<this.height;s++)for(let n=0;n<this.width;n++){const r=t(n,s);this.map[s*this.width+n]=r,r.hasStaticEntity()&&e.push(r.getStaticEntity())}for(let s of e)this.spawnStatic(s.getAgent())}getTile(t,e,s=!1){return t>=this.width||t<0||e>=this.height||e<0?s?this.getTile(Math.max(Math.min(t,this.width-1),0),Math.max(Math.min(e,this.height-1),0)):void 0:this.map[e*this.width+t]}getEntityTiles(t,e,s){let n;if(e!==void 0)n=t;else{const r=t;n=r.getTile().getX(),e=r.getTile().getY(),s=zt(r)}switch(s){case 1:return[this.map[e*this.width+n]];case 2:return[this.map[e*this.width+n],this.map[e*this.width+n+1],this.map[(e+1)*this.width+n],this.map[(e+1)*this.width+n+1]];default:throw new Error("Unsupported agent scale!")}}getAdjacentTiles(t,e=1,s=!1){return(s?Rr:ta).map(([n,r])=>this.getTile(t.getX()+n*e,t.getY()+r*e)).filter(n=>!!n)}setTile(t){this.setTileInternal(t)}setTiles(t){t.map(e=>this.setTileInternal(e))}setTileInternal(t){this.dirty=!0,this._version++;const e=this.map[t.getY()*this.width+t.getX()];return e.hasStaticEntity()&&!t.hasStaticEntity()?t.setStaticEntity(e.getStaticEntity()):e.hasStaticEntity()&&this.despawnStatic(e.getStaticEntity().getAgent()),t.sync(e),this.map[t.getY()*this.width+t.getX()]=t,this.changedTiles.add(e),e}processChangedTiles(){this.changedTiles.size&&(B.Instance.triggerEvent(E.SurfaceChange,{affectedTiles:this.changedTiles,addedStaticAgents:this.addedAgents,removedStaticAgents:this.removedAgents}),this.changedTiles.clear(),this.addedAgents.clear(),this.removedAgents.clear())}getRow(t){const e=t*this.width;return this.map.slice(e,e+this.width)}getColumn(t){const e=new Array(this.height);for(let s=0;s<this.height;s++)e[s]=this.getTile(t,s);return e}getWidth(){return this.width}getHeight(){return this.height}forLine(t,e,s,n,r,o){const h=(o==null?void 0:o.scale)??1;t=Math.floor(t/h)*h,e=Math.floor(e/h)*h,s=Math.floor(s/h)*h,n=Math.floor(n/h)*h;const l=Math.atan2(n-e,s-t);return this.forRay(t,e,l,(d,g)=>!(r(d,g)===!1)&&!(d.getX()===s&&d.getY()===n),o)}forRay(t,e,s,n,r){const o=(r==null?void 0:r.connected)??!1,h=(r==null?void 0:r.scale)??1,l=Math.cos(s),d=Math.sin(s),g=Math.abs(l)+Math.abs(d);let p=Math.abs(l/g),v=Math.abs(d/g),m=(1+(p>v?v/p:p/v))*h;p*=m*Math.sign(l),v*=m*Math.sign(d);let M,A,I=0;for(;;){let Y=!1;const x=Math.round(t/h)*h;let D=Math.round(e/h)*h;o&&M!==void 0&&Math.round(M/h)*h!==x&&Math.round(A/h)*h!==D&&(D=Math.round(A),Y=!0);const U=this.getTile(x,D);if(!U||!n(U,I))break;Y||(t+=p,e+=v),M=x,A=D,I++}}forRect(t,e,s,n,r,o){const h=(o==null?void 0:o.scale)??1;t=Math.floor(t/h)*h,e=Math.floor(e/h)*h,s=Math.floor(s/h)*h,n=Math.floor(n/h)*h;const l=(g,p)=>{const v=this.getTile(g,p);v&&r(v)},d=g=>{if(s>t)for(let p=t;p<=s;p+=h)l(p,g);else for(let p=t;p>=s;p-=h)l(p,g)};if(n>e)for(let g=e;g<=n;g+=h)d(g);else for(let g=e;g>=n;g-=h)d(g)}forCircle(t,e,s,n,r){const o=(r==null?void 0:r.edgeOnly)??!1,h=(r==null?void 0:r.scale)??1;t=Math.floor(t/h),e=Math.floor(e/h);let l=s/2;const d=l*l,g=(l-1)*(l-1),p=(v,m,M=0)=>{const A=v+M,I=m+M,Y=A*A+I*I;if(Y<d&&!(o&&Y<g)){const x=this.getTile((t+v)*h,(e+m)*h,o);x&&n(x)}};if(s%2===0)for(let v=-l;v<l;v+=1)for(let m=-l;m<l;m+=1)p(m,v,.5);else{l=l|0;for(let v=-l;v<l+1;v+=1)for(let m=-l;m<l+1;m+=1)p(m,v)}}spawn(t){this.entities.push(t.entity),this.entitiesMap.get(t.category).add(t.entity),t.tick?this.tickingEntities.push(t.entity):this.dirty=!0,t.spawn&&this.initialized&&t.spawn()}spawnStatic(t){this.getEntityTiles(t).forEach(s=>{s.setStaticEntity(t.entity),this.changedTiles.add(s)}),this.addedAgents.add(t),this.spawn(t),this.dirty=!0,yi(t)&&Br(t)>1&&this.towers.add(t)}despawn(t){const e=this.entities.indexOf(t.entity);e>=0&&(this.entities.splice(e,1),t.tick&&this.tickingEntities.splice(this.tickingEntities.indexOf(t.entity),1));const s=this.entitiesMap.get(t.category).delete(t.entity);return this.deletedEntities.push(t.entity),t.despawn&&t.despawn(),s}despawnStatic(t){this.getEntityTiles(t).forEach(s=>{s.clearStaticEntity(),this.changedTiles.add(s)}),this.removedAgents.add(t),this.despawn(t),this.dirty=!0,yi(t)&&this.towers.delete(t)}getEntities(){return this.entities}getTickingEntities(){return this.tickingEntities}getEntitiesForCategory(t){return this.entitiesMap.get(t)}getDeletedEntities(){return this.deletedEntities}getTowers(){return this.towers}getTowerDirection(t){let e=0,s=0;return this.towers.forEach(n=>{e+=n.entity.getX()-t.getX(),s+=n.entity.getY()-t.getY()}),Math.atan2(s,e)}getTiles(){return this.map}markPristine(){this.dirty=!1,this.deletedEntities=[]}forceRerender(){this.dirty=!0}isDirty(){return this.dirty}get version(){return this._version}}const Oe=(i,t)=>{const e=[],s=zt(i),n=s===2?1:0;u.Instance.getSurface().forCircle(i.getTile().getX()+n,i.getTile().getY()+n,t*s,r=>{var o;if(Ds.has(r.getBaseType())){const h=(o=r.getStaticEntity())==null?void 0:o.getAgent();h&&h.category!==R.Player&&(u.Instance.getSurface().despawnStatic(h),h.getType()===c.Tree&&(h.renderData.chopped=!0));const l=new et(r.getX(),r.getY(),f.Stone);e.push(l)}}),u.Instance.getSurface().setTiles(e)};class Ui{constructor(t){a(this,"entity");a(this,"category",R.Player);a(this,"renderData",{});this.tile=t,this.entity=new W(t.getX(),t.getY(),this)}spawn(){u.Instance.getBase().addPart(this),Oe(this,3)}despawn(){u.Instance.getBase().removePart(this)}getType(){return c.Armory}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){u.Instance.getBase().hit(t)}isVisible(){return!0}}a(Ui,"scale",2);const _r=.625;class Ys{constructor(t){a(this,"entity");a(this,"category",R.Player);a(this,"isEnabled",!0);a(this,"renderData",{});this.tile=t,this.entity=new W(t.getX(),t.getY(),this),t.addTower(this)}getCooldown(){return this.isEnabled?0:1}fire(t,e){if(!u.Instance.consumeContinuous(this,e))return 0;const s=_r*e;return t.AI.hit(s),s}despawn(){this.tile.removeTower(this)}getType(){return c.ElectricFence}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.isEnabled=!1}isVisible(){return!0}isSpeedBoosted(){return!1}isDamageBoosted(){return!1}}a(Ys,"scale",1),a(Ys,"range",1);class zi{constructor(t){a(this,"entity");a(this,"category",R.Player);a(this,"renderData",{});this.tile=t,this.entity=new W(t.getX(),t.getY(),this)}getType(){return c.Fence}getTile(){return this.tile}updateTile(t){this.tile=t}isVisible(){return!0}}a(zi,"scale",1);class Gi{constructor(t){a(this,"entity");a(this,"category",R.Player);a(this,"renderData",{});this.tile=t,this.entity=new W(t.getX(),t.getY(),this)}spawn(){const t=[];u.Instance.getSurface().getEntityTiles(this).forEach(e=>{t.push(new et(e.getX(),e.getY(),f.Freezer))}),u.Instance.getSurface().setTiles(t)}despawn(){const t=u.Instance.getSurface().getEntityTiles(this).map((e,s)=>new et(e.getX(),e.getY(),f.Dirt));u.Instance.getSurface().setTiles(t)}getType(){return c.Freezer}getTile(){return this.tile}updateTile(t){this.tile=t}isVisible(){return!0}}a(Gi,"scale",2);class Hi{constructor(t){a(this,"entity");a(this,"category",R.Player);a(this,"renderData",{});this.tile=t,this.entity=new W(t.getX(),t.getY(),this)}spawn(){u.Instance.getBase().addPart(this),Oe(this,3)}despawn(){u.Instance.getBase().removePart(this)}getType(){return c.Market}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){u.Instance.getBase().hit(t)}isVisible(){return!0}}a(Hi,"scale",2);class Wi{constructor(t){a(this,"entity");a(this,"category",R.Player);a(this,"renderData",{});this.tile=t,this.entity=new W(t.getX(),t.getY(),this)}getType(){return c.PowerPlant}getTile(){return this.tile}updateTile(t){this.tile=t}spawn(){u.Instance.getBase().addPart(this),Oe(this,3)}despawn(){u.Instance.getBase().removePart(this)}hit(t){u.Instance.getBase().hit(t)}isVisible(){return!0}}a(Wi,"scale",2);const Dr=i=>"AI"in i;var k=(i=>(i[i.Normal=0]="Normal",i[i.OnFire=1]="OnFire",i[i.Stunned=2]="Stunned",i))(k||{});class Lr{constructor(t){a(this,"isBlocking",!0);this.index=t}isCleared(t,e){const s=t[this.index];return e.getScale()===1?!s.hasStaticEntity()||!de.has(s.getStaticEntity().getAgent().getType()):!u.Instance.getSurface().getEntityTiles(s.getX(),s.getY(),e.getScale()).some(n=>n.hasStaticEntity()&&de.has(n.getStaticEntity().getAgent().getType()))}process(t,e,s){if(e.getScale()===1){e.AI.attack(t[this.index].getStaticEntity().getAgent());return}const n=u.Instance.getSurface().getEntityTiles(t[this.index].getX(),t[this.index].getY(),e.getScale());for(let r of n)if(!(!r.hasStaticEntity()||!de.has(r.getStaticEntity().getAgent().getType()))){e.AI.attack(r.getStaticEntity().getAgent());return}}}const Fe=(i=1,t=de)=>e=>{const s=u.Instance.getSurface(),n=[];for(let r=0;r<e.length;r++){const o=s.getEntityTiles(e[r].getX(),e[r].getY(),i);for(let h of o)if(h.hasStaticEntity()&&t.has(h.getStaticEntity().getAgent().getType())){n.push(new Lr(r));break}}return n},us=(i,t)=>({...i,...t}),$e={[f.Grass]:3,[f.Water]:20,[f.Stone]:4,[f.Wall]:3,[f.Spore]:2,[f.ElectricFence]:5,[f.Fence]:20,[f.Freezer]:6,[f.Obstructed]:3,[f.Bridge]:5,[f.Dirt]:2.5,[f.Sand]:3.5,[f.Snow]:3.5,[f.Ice]:10,[f.PlayerBuilding]:3,[f.Tree]:5,[f.Rock]:5,[f.Base]:Number.EPSILON},Xe={[f.Fence]:5,[f.ElectricFence]:40,[f.Wall]:500,[f.Freezer]:.5,[f.Obstructed]:500,[f.PlayerBuilding]:-10},Yr={[f.Grass]:3,[f.Water]:3,[f.Stone]:3,[f.Wall]:3,[f.Spore]:3,[f.ElectricFence]:3,[f.Fence]:3,[f.Freezer]:3,[f.Obstructed]:3,[f.Bridge]:3,[f.Dirt]:3,[f.Sand]:3,[f.Snow]:3,[f.Ice]:3,[f.PlayerBuilding]:3,[f.Tree]:3,[f.Rock]:3,[f.Base]:Number.EPSILON},Or={[f.Fence]:3,[f.ElectricFence]:3,[f.Wall]:5,[f.Tree]:4,[f.Rock]:3,[f.Obstructed]:5,[f.PlayerBuilding]:-10},st=600;class Ne{constructor(t,e,s=st){a(this,"predictedHp");a(this,"cooldown",0);a(this,"visibilities",[]);a(this,"maxHp");a(this,"callback");this.enemy=t,this.hp=e,this.attackSpeed=s,this.predictedHp=e,this.maxHp=e;const n=u.Instance.getSurface();this.visibilities=t.getPath().getTiles().map(r=>t.getScale()===1?r.isDiscovered():n.getEntityTiles(r.getX(),r.getY(),t.getScale()).some(o=>o.isDiscovered()))}tick(t){if(this.cooldown<t&&this.callback&&(this.callback(),this.callback=void 0),this.cooldown=Math.max(0,this.cooldown-t),this.enemy.getPath().isPaused(this.enemy)&&!this.isBusy()){const e=this.enemy.getPath().getCurrentTile();this.enemy.entity.setX(e.getX()),this.enemy.entity.setY(e.getY());const s=this.enemy.getPath().getNextCheckpoint();s&&s.process(this.enemy.getPath().getTiles(),this.enemy,t)}if(this.isBusy())this.getTargeted(this.enemy.getPath().getCurrentTile(),t);else{this.isVisible()||this.enemy.getPath().fastForward(this.enemy);const{from:e,to:s,step:n}=this.enemy.getPath().performStep(this.enemy,t);this.enemy.entity.move(e??s,s,n),e&&this.getTargeted(e,t)}}attack(t){t.hit&&this.cooldown===0&&(this.callback=()=>{t.hit(this.enemy.getDamage()*u.Instance.getDamageMultiplier())},this.cooldown=this.isVisible()?this.attackSpeed:0)}interact(t,e=this.attackSpeed){this.callback=t,this.cooldown===0&&this.isVisible()&&(this.cooldown=e)}cancel(){this.cooldown=0,this.callback=void 0}getTargeted(t,e){if(this.predictedHp>0&&this.isVisible()){if(this.enemy.getScale()===1){for(let n of t.getAvailableTowers())if(this.predictedHp-=n.fire(this.enemy,e),this.predictedHp<=0)return;return}const s=u.Instance.getSurface().getEntityTiles(t.getX(),t.getY(),this.enemy.getScale());for(let n of s)for(let r of n.getAvailableTowers())if(this.predictedHp-=r.fire(this.enemy,e),this.predictedHp<=0)return}}hit(t){this.hp-=t,this.hp<this.predictedHp&&(this.predictedHp=this.hp),this.hp<=0&&u.Instance.despawnEnemy(this.enemy)}miss(t){this.predictedHp+=t}isAttacking(){return this.cooldown!==0}isBusy(){return this.isAttacking()||this.enemy.getStatus()===k.Stunned}getFuturePosition(t){const e=this.enemy.getPath().getFuturePosition(t),s=this.enemy.getPath().getCheckpoints();for(let n=0;n<s.length;n++){let r=s[n];if(r.index>e)return e;if(r.isBlocking)return r.index-1}return e}isVisible(){return this.visibilities[this.enemy.getPath().getIndex()|0]??!0}getHpPercent(){return this.hp/this.maxHp}}const ei=new Set(de);ei.delete(c.Tree);ei.delete(c.Pine);ei.delete(c.Cactus);const Fr=Fe(1,ei),$r=3e3,Xr=1e3,Nr=.01,Ur=.025,zr=30;var xt;let ge=(xt=class{constructor(t,e){a(this,"entity");a(this,"category",R.Enemy);a(this,"status",k.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new at(t.getX(),t.getY(),this),this.ai=new Ne(this,zr)}initializePath(){this.path.setSpeed(Ur),this.path.setCheckpoints(Fr(this.path.getTiles()))}get AI(){return this.ai}getDamage(){return 4}getType(){return xt.type}getScale(){return xt.scale}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status!==k.Normal&&(this.statusDuration-=t,this.statusDuration<=0?this.status=k.Normal:this.status===k.OnFire&&this.ai.hit(Nr*t)),this.ai.tick(t)}isVisible(){return this.ai.isVisible()}lightOnFire(){this.status=k.OnFire,this.statusDuration=$r}stun(){this.status=k.Stunned,this.statusDuration=Xr}getOffsetX(){return this.entity.getX()}getOffsetY(){return this.entity.getY()}},a(xt,"pathCosts",us($e,{[f.Tree]:3})),a(xt,"pathMultipliers",us(Xe,{[f.Water]:2})),a(xt,"type",c.Runner),a(xt,"cost",5),a(xt,"scale",1),xt);class _t{constructor(t,e,s,n,r,o=[]){a(this,"index",0);a(this,"sectionIndex",0);a(this,"tileSet");this.pathfinder=t,this.tiles=e,this.sections=s,this.speed=n,this.costs=r,this.checkpoints=o,this.tileSet=new Set(e)}performStep(t,e){const s=this.index%1,n=this.index|0,r=this.tiles[n],o=this.speed*e/(this.costs[n]??1);let h=this.index+o|0;n===h&&h++,h>=this.tiles.length-1&&(h=this.tiles.length-1);const l=this.tiles[h];for(;this.checkpoints.length>0;){const g=this.checkpoints[0];if(g&&h>=g.index)if(g.isCleared(this.tiles,t))this.checkpoints.shift();else return this.index=g.index-1,{from:this.tiles[this.index],to:l,step:0};else break}const d=this.costs[h]??1;for(this.index=Math.min(this.index+this.speed*e/d,this.tiles.length-1);this.index>this.sections[this.sectionIndex].to;)this.sectionIndex++;return{from:r,to:l,step:s}}getFuturePosition(t){let e=this.index,s=this.sectionIndex;for(;t>0;){const n=this.sections[s],r=n.to-e,o=r/this.speed*n.cost;if(t>o?(e+=r,s++,t-=o):(e+=r*t/o,t=0),e>=this.tiles.length-1)return this.tiles.length-1}return e}fastForward(t){let e=this.checkpoints[0];for(let s=(this.index|0)+1;s<this.tiles.length;s++){if(e&&s>=e.index)if(e.isCleared(this.tiles,t))this.checkpoints.shift(),e=this.checkpoints[0];else break;if(this.getTile(s).isDiscovered())break;this.index=s}}clone(){return new _t(this.pathfinder,this.tiles,this.sections,this.speed,this.costs,[...this.checkpoints])}slice(t=0,e=Number.MAX_VALUE){const s=this.tiles.slice(t,e),n=this.costs.slice(t,e),r=_t.calculateSections(s,n),o=this.checkpoints.filter(h=>h.index>=t&&h.index<e);return new _t(this.pathfinder,s,r,this.speed,n,o)}setIndex(t){this.index=Math.max(Math.min(t,this.tiles.length-1),0),this.sectionIndex=this.sections.findIndex(({from:e,to:s})=>this.index>=e&&this.index<s)}getIndex(){return this.index}getTile(t=this.index){return this.tiles[t|0]}getTiles(){return this.tiles}getLength(){return this.tiles.length}getCoordinates(t=this.index){if(t>=this.tiles.length-1){const r=this.tiles[this.tiles.length-1];return{x:r.getX(),y:r.getY()}}const e=t%1,s=this.tiles[t|0],n=this.tiles[(t|0)+1];return{x:(n.getX()-s.getX())*e+s.getX(),y:(n.getY()-s.getY())*e+s.getY()}}getSpeed(){return this.speed}setSpeed(t){this.speed=t}isDone(){return this.index===this.tiles.length-1}isPaused(t){if(this.isDone())return!0;const e=this.getNextCheckpoint();return e&&e.index===this.index+1&&!e.isCleared(this.tiles,t)}getNextCheckpoint(){return this.checkpoints[0]||null}getCheckpoints(){return this.checkpoints}setCheckpoints(t){this.checkpoints=t}getCurrentTile(){return this.index<0?this.tiles[0]:this.tiles[this.index|0]}getScale(){return this.pathfinder.scale}recompute(){const t=this.pathfinder.getSurface();let e;for(let s=0;s<this.tiles.length;s++){const n=this.tiles[s],r=t.getTile(n.getX(),n.getY());this.tiles[s]=r,this.costs[s]=this.pathfinder.getCost(r,e)??1,e=r,n!==r&&(this.tileSet.delete(n),this.tileSet.add(r))}this.sections=_t.calculateSections(this.tiles,this.costs)}isAffectedByTiles(t){for(let e of t)if(this.tileSet.has(e))return!0;return!1}static calculateSections(t,e){return t.reduce((s,n,r)=>{const o=s[s.length-1],h=e[r];return o?(o.cost===h?o.to++:s.push({from:r,to:r+1,cost:h}),s):[{from:r,to:r+1,cost:h}]},[])}static fromTiles(t,e,s=1){const n=new _t(t,e,[],s,[]);return n.recompute(),n}static fromMapAndCosts(t,e,s,n,r=1){let o=s;const h=[o];for(;o!==e;)o=n.get(o.getHash()),h.push(o);return this.fromTiles(t,h.reverse(),r)}static fromPaths(t,e){const s=e.map(l=>l.getTiles()),n=e.map(l=>l.getCheckpoints()),r=s[0],o=n[0];for(let l=1;l<s.length;l++){const d=s[l];if(r[r.length-1]!==d[0])throw new Error("Cannot merge paths because they don't start and end at the same point");const g=n[l].filter(p=>p.index!==0);g.forEach(p=>p.index+=r.length),o.push(...g),d.shift(),r.push(...d)}const h=_t.fromTiles(t,r,e[0].getSpeed());return h.setCheckpoints(o),h}}function Gr(){return new Worker("/open-td/assets/worker-5bafe1fc.js")}class Hr{constructor(t,e,s){a(this,"paths");a(this,"promise");a(this,"worker");this.pathfinder=t,this.startPoints=e,this.target=s}getPaths(){return this.paths?this.paths:(this.promise||this.createPromise(),[])}getAsyncPaths(){return this.promise||this.createPromise(),this.promise}getPathsSync(){if(!this.paths){const t=this.startPoints.map(s=>this.pathfinder.getSurface().getTile(s.getX(),s.getY())),e=this.pathfinder.getSurface().getTile(this.target.getX(),this.target.getY());this.paths=this.pathfinder.getHivePath(t,e).filter(s=>!!s)}return this.promise=Promise.resolve(this.paths),this.paths}createPromise(){this.promise=new Promise(t=>{const e=this.pathfinder.getSurface(),n={buffer:Zt.serializeSurface(e,!1).buffer,costs:this.pathfinder.costs,costMultiplier:this.pathfinder.costMultipliers,scale:this.pathfinder.scale,maxDiagonalCost:this.pathfinder.maxDiagonalCost,startPoints:this.startPoints.map(r=>r.serialize()),target:this.target.serialize()};this.worker=new Gr,this.worker.postMessage(n,[n.buffer]),this.worker.onmessage=({data:r})=>{this.paths=r.map(o=>_t.fromTiles(this.pathfinder,o.map(({x:h,y:l})=>e.getTile(h,l)))),this.worker&&(this.worker.terminate(),this.worker=void 0),t(this.paths)}})}update(){this.paths=void 0,this.promise=void 0,this.worker&&(this.worker.terminate(),this.worker=void 0)}}const Wr=[[0,-1],[-1,0],[1,0],[0,1],[-1,-1],[1,-1],[-1,1],[1,1]],Vr=150;class jr{constructor(t,e=Xe,s=$e,n=1,r=Vr){a(this,"neighbors");a(this,"computedCosts");a(this,"computedMultipliers");a(this,"scaledWidth");a(this,"scaledHeight");a(this,"computedVersion",-1);this.surface=t,this.costMultipliers=e,this.costs=s,this.scale=n,this.maxDiagonalCost=r,this.neighbors=Wr.map(([o,h])=>[o*n,h*n])}getPath(t,e,s){this.computedVersion!==this.surface.version&&this.computeCosts(),t=this.surface.getTile(Math.floor(t.getX()/this.scale)*this.scale,Math.floor(t.getY()/this.scale)*this.scale),e=this.surface.getTile(Math.floor(e.getX()/this.scale)*this.scale,Math.floor(e.getY()/this.scale)*this.scale);const n=s?m=>s(this.computedMultipliers[this.getIndex(m)],m):m=>this.computedMultipliers[this.getIndex(m)],r=new Set,h=(this.computedCosts[this.getIndex(t)]??1)*n(t),l=new Map;l.set(t.getHash(),h);const d=new Map;d.set(t.getHash(),h);const g=new Map;g.set(t.getHash(),h+this.heuristic(t,e));const p=new cr((m,M)=>(g.get(m.getHash())??1/0)-(g.get(M.getHash())??1/0));p.push(t);const v=new Map;for(;!p.empty();){let m=p.pop();if(e===m)return _t.fromMapAndCosts(this,t,e,v);const M=m.getHash(),A=this.neighbors.map(([Y,x])=>this.surface.getTile(Y+m.getX(),x+m.getY())),I=[];this.setCostAndMultiplier(0,I,n,A[0]),this.setCostAndMultiplier(1,I,n,A[1]),this.setCostAndMultiplier(2,I,n,A[2]),this.setCostAndMultiplier(3,I,n,A[3]),this.setDiagonalCostAndMultiplier(4,0,1,I,n,A[4]),this.setDiagonalCostAndMultiplier(5,0,2,I,n,A[5]),this.setDiagonalCostAndMultiplier(6,1,3,I,n,A[6]),this.setDiagonalCostAndMultiplier(7,2,3,I,n,A[7]),A.forEach((Y,x)=>{if(!Y)return;const D=I[x*2];if(!D||r.has(Y))return;const U=Y.getHash(),ut=d.get(M)+I[x*2+1];if(ut<(d.get(U)??1/0)){const Rt=l.get(M)+D;l.set(U,Rt),v.set(U,m),d.set(U,ut),g.set(U,ut+this.heuristic(Y,e)),p.push(Y),r.add(m)}})}}getHivePath(t,e){const s={},n=(r,o)=>(s[o.getHash()]??1)*r;return t.reduce((r,o,h)=>{const l=this.getPath(o,e,n);return r.push(l),l&&t.length>h-1&&l.getTiles().forEach(d=>{if(d.getType()===f.Fence){s[d.getHash()]=1.2;return}if(d.getType()===f.Obstructed){s[d.getHash()]=.85;return}s[d.getHash()]=s[d.getHash()]+.1||1.1}),r},[])}getWaypointPath(t){const e=[];for(let s=0;s<t.length-1;s++)e.push(this.getPath(t[s],t[s+1]));return _t.fromPaths(this,e)}getCost(t,e){this.computedVersion!==this.surface.version&&this.computeCosts();const s=this.computedCosts[this.getIndex(t)];if(!e)return s;const n=this.computedCosts[this.getIndex(e)];if(!s||!n)return null;const r=(s+n)/2;return!s||!n||t.getX()===e.getX()||t.getY()==e.getY()?r:r+(this.computedCosts[(e.getY()/this.scale|0)*this.scaledWidth+(t.getX()/this.scale|0)]+this.computedCosts[(t.getY()/this.scale|0)*this.scaledWidth+(e.getX()/this.scale|0)])/4}getSurface(){return this.surface}heuristic(t,e){return Math.abs(t.getX()-e.getX())+Math.abs(t.getY()-e.getY())}setCostAndMultiplier(t,e,s,n){if(!n)return;const r=this.computedCosts[this.getIndex(n)];r&&(e[t*2]=r,e[t*2+1]=r*s(n))}setDiagonalCostAndMultiplier(t,e,s,n,r,o){if(!o||!n[e*2]||!n[s*2])return;const h=n[e*2+1]+n[s*2+1];if(h>this.maxDiagonalCost)return;const l=this.computedCosts[this.getIndex(o)];l&&(n[t*2]=l+(n[e*2]+n[s*2])/4,n[t*2+1]=l*r(o)+h/4)}computeCosts(){this.computedVersion=this.surface.version;const t=this.scale**2;this.scaledWidth=Math.floor(this.surface.getWidth()/this.scale),this.scaledHeight=Math.floor(this.surface.getHeight()/this.scale);const e=this.scaledWidth*this.scaledHeight;this.computedCosts=new Array(e),this.computedMultipliers=new Array(e);for(let s=0;s<this.scaledWidth;s++)for(let n=0;n<this.scaledHeight;n++){const r=this.surface.getEntityTiles(s*this.scale,n*this.scale,this.scale);let o=0,h=0;for(let d=0;d<r.length;d++){let g=r[d].getType();if(!this.costs[g]){o=null,h=t;break}o+=this.costs[g],h+=this.costMultipliers[g]??1}const l=n*this.scaledWidth+s;this.computedCosts[l]=o===null?null:o/t,this.computedMultipliers[l]=h/t}}getIndex(t){return(t.getY()/this.scale|0)*this.scaledWidth+(t.getX()/this.scale|0)}}const si=(i,...t)=>{const e=[];return t.filter(Boolean).forEach(s=>e.push(...s(i))),e.sort((s,n)=>s.index-n.index),e},wi=(i,t)=>{if(i>Math.random())return t},Ge=new Set([f.Grass,f.Snow]);class cn{constructor(t){a(this,"isBlocking",!1);this.index=t}isCleared(t,e){return e.getScale()===1?!Ge.has(t[this.index-1].getType()):u.Instance.getSurface().getEntityTiles(t[this.index-1].getX(),t[this.index-1].getY(),e.getScale()).every(s=>!Ge.has(s.getType()))}process(t,e,s){const n=u.Instance.getSurface(),r=t[this.index-1],o=u.Instance.getSurface().getEntityTiles(r.getX(),r.getY(),e.getScale());for(let h of o)Ge.has(h.getType())&&n.setTile(new et(h.getX(),h.getY(),f.Dirt))}}const Vi=(i=1)=>t=>{const e=[];if(i>1){const r=u.Instance.getSurface();return t.forEach((o,h)=>{r.getEntityTiles(o.getX(),o.getY(),i).some(d=>Ge.has(d.getBaseType()))&&e.push(new cn(h+1))}),e}const s=Math.random()*t.length/10,n=t.filter(r=>Ge.has(r.getBaseType()));for(let r=0;r<s&&n.length;r++){const o=n.splice(Math.floor(Math.random()*n.length),1)[0];e.push(new cn(t.indexOf(o)+1))}return e};class hn{constructor(t){a(this,"isBlocking",!0);this.index=t}isCleared(t,e){return!this.getTiles(t[this.index],e).length}process(t,e,s){const n=u.Instance.getSurface(),r=t[this.index],o=this.getTiles(r,e);if(o.length>0){const h=o[0];e.entity.lookAt(h),e.AI.interact(()=>{n.getTile(h.getX(),h.getY()).getType()===f.Water&&n.setTile(new et(h.getX(),h.getY(),f.Bridge))})}}getTiles(t,e){const s=u.Instance.getSurface(),n=[];return t.getType()===f.Water&&n.push(t),e.entity.getAlignedX()!==t.getX()&&e.entity.getAlignedY()!==t.getY()&&[[e.entity.getAlignedX(),t.getY()],[t.getX(),e.entity.getAlignedY()]].forEach(([r,o])=>{const h=s.getTile(r,o);(h==null?void 0:h.getType())===f.Water&&n.push(h)}),n}}const Kr=i=>{const t=[];for(let e=0;e<i.length;e++)i[e].getType()===f.Water&&(t.push(new hn(e)),e+1<i.length&&i[e+1].getType()!==f.Water&&t.push(new hn(e+1)));return t},qr=Fe(),Zr=Vi(),Qr=3e3,Jr=1e3,to=.01,eo=.01,so=100;var Ct;let sa=(Ct=class{constructor(t,e){a(this,"entity");a(this,"category",R.Enemy);a(this,"status",k.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new at(t.getX(),t.getY(),this),this.ai=new Ne(this,so)}initializePath(){this.path.setSpeed(eo),this.path.setCheckpoints(si(this.path.getTiles(),qr,wi(.5,Zr),wi(.1,Kr)))}get AI(){return this.ai}getDamage(){return 6}getType(){return Ct.type}getScale(){return Ct.scale}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status!==k.Normal&&(this.statusDuration-=t,this.statusDuration<=0?this.status=k.Normal:this.status===k.OnFire&&this.ai.hit(to*t)),this.ai.tick(t)}isVisible(){return this.ai.isVisible()}lightOnFire(){this.status=k.OnFire,this.statusDuration=Qr}stun(){this.status=k.Stunned,this.statusDuration=Jr}getOffsetX(){return this.entity.getX()}getOffsetY(){return this.entity.getY()}},a(Ct,"pathCosts",$e),a(Ct,"pathMultipliers",Xe),a(Ct,"type",c.Slime),a(Ct,"cost",7),a(Ct,"scale",1),Ct);const io=Fe(),no=Vi(),ao=3e3,ro=1e3,oo=.01,co=.008,ho=200;var Tt;let ia=(Tt=class{constructor(t,e){a(this,"entity");a(this,"category",R.Enemy);a(this,"status",k.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new at(t.getX(),t.getY(),this),this.ai=new Ne(this,ho)}initializePath(){this.path.setSpeed(co),this.path.setCheckpoints(si(this.path.getTiles(),io,wi(.5,no)))}get AI(){return this.ai}getDamage(){return 8}getType(){return Tt.type}getScale(){return Tt.scale}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status!==k.Normal&&(this.statusDuration-=t,this.statusDuration<=0?this.status=k.Normal:this.status===k.OnFire&&this.ai.hit(oo*t)),this.ai.tick(t)}isVisible(){return this.ai.isVisible()}lightOnFire(){this.status=k.OnFire,this.statusDuration=ao}stun(){this.status=k.Stunned,this.statusDuration=ro}getOffsetX(){return this.entity.getX()}getOffsetY(){return this.entity.getY()}},a(Tt,"pathCosts",$e),a(Tt,"pathMultipliers",Xe),a(Tt,"type",c.Tank),a(Tt,"cost",20),a(Tt,"scale",1),Tt);const lo=Fe(1,fs),uo=3e3,go=1e3,po=.01,fo=.006,mo=50;var kt;let na=(kt=class{constructor(t,e){a(this,"entity");a(this,"category",R.Enemy);a(this,"status",k.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new at(t.getX(),t.getY(),this),this.ai=new Ne(this,mo)}initializePath(){this.path.setSpeed(fo),this.path.setCheckpoints(lo(this.path.getTiles()))}get AI(){return this.ai}getDamage(){return 5}getType(){return kt.type}getScale(){return kt.scale}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status!==k.Normal&&(this.statusDuration-=t,this.statusDuration<=0?this.status=k.Normal:this.status===k.OnFire&&this.ai.hit(po*t)),this.ai.tick(t)}isVisible(){return this.ai.isVisible()}lightOnFire(){this.status=k.OnFire,this.statusDuration=uo}stun(){this.status=k.Stunned,this.statusDuration=go}getOffsetX(){return this.entity.getX()}getOffsetY(){return this.entity.getY()}},a(kt,"pathCosts",Yr),a(kt,"pathMultipliers",Or),a(kt,"type",c.Flier),a(kt,"cost",12),a(kt,"scale",1),kt);const Ke=class Ke{constructor(t){a(this,"isBlocking",!1);this.index=t}isCleared(t,e){const s=t[this.index];return!u.Instance.getSurface().getEntityTiles(s.getX(),s.getY(),e.getScale()).some(n=>n.hasStaticEntity()&&Ke.treeTypes.has(n.getStaticEntity().getAgent().getType()))}process(t,e,s){const n=u.Instance.getSurface().getEntityTiles(t[this.index].getX(),t[this.index].getY(),2);for(let r of n)r.hasStaticEntity()&&Ke.treeTypes.has(r.getStaticEntity().getAgent().getType())&&r.getStaticEntity().getAgent().hit(100)}};a(Ke,"treeTypes",new Set([c.Tree,c.Pine,c.Cactus]));let Os=Ke;const aa=i=>{const t=u.Instance.getSurface(),e=[];for(let s=0;s<i.length;s++){const n=t.getEntityTiles(i[s].getX(),i[s].getY(),2);for(let r of n)if(r.hasStaticEntity()&&Os.treeTypes.has(r.getStaticEntity().getAgent().getType())){e.push(new Os(s));break}}return e},ra=new Set(de);ra.delete(c.Tree);const yo=Fe(2,ra),wo=3e3,vo=1500,So=.01,Eo=.01,bo=350;var Et;let oa=(Et=class{constructor(t,e){a(this,"entity");a(this,"category",R.Enemy);a(this,"status",k.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new at(t.getX(),t.getY(),this),this.ai=new Ne(this,bo)}initializePath(){this.path.setSpeed(Eo/Et.scale),this.path.setCheckpoints(si(this.path.getTiles(),aa,yo))}get AI(){return this.ai}getDamage(){return 10}getType(){return Et.type}getScale(){return Et.scale}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status!==k.Normal&&(this.statusDuration-=t,this.statusDuration<=0?this.status=k.Normal:this.status===k.OnFire&&this.ai.hit(So*t)),this.ai.tick(t)}isVisible(){return this.ai.isVisible()}lightOnFire(){this.status=k.OnFire,this.statusDuration=wo}stun(){this.status=k.Stunned,this.statusDuration=vo}getOffsetX(){return this.entity.getX()+.5}getOffsetY(){return this.entity.getY()+.5}},a(Et,"pathCosts",$e),a(Et,"pathMultipliers",us(Xe,{[f.Water]:2})),a(Et,"type",c.Behemoth),a(Et,"cost",32),a(Et,"scale",2),Et);const ca=new Set(de);ca.delete(c.Tree);const Io=Fe(2,ca),Mo=Vi(2),xo=3e3,Co=500,To=.01,ko=.005,Ao=1e3,Po=1e3;var wt;let ji=(wt=class{constructor(t,e){a(this,"entity");a(this,"category",R.Enemy);a(this,"status",k.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new at(t.getX(),t.getY(),this),this.ai=new Ne(this,Ao,Po)}initializePath(){this.path.setSpeed(ko/wt.scale),this.path.setCheckpoints(si(this.path.getTiles(),aa,Io,Mo))}get AI(){return this.ai}getDamage(){return 1e3}getType(){return wt.type}getScale(){return wt.scale}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status!==k.Normal&&(this.statusDuration-=t,this.statusDuration<=0?this.status=k.Normal:this.status===k.OnFire&&this.ai.hit(To*t)),this.ai.tick(t)}isVisible(){return this.ai.isVisible()}lightOnFire(){this.status=k.OnFire,this.statusDuration=xo}stun(){this.status=k.Stunned,this.statusDuration=Co}getOffsetX(){return this.entity.getX()+.5}getOffsetY(){return this.entity.getY()+.5}},a(wt,"pathCosts",us($e,{[f.Fence]:1,[f.Freezer]:8})),a(wt,"pathMultipliers",us(Xe,{[f.Obstructed]:3.5,[f.Wall]:25,[f.Fence]:1,[f.Water]:5,[f.Freezer]:.375})),a(wt,"type",c.Bore),a(wt,"cost",300),a(wt,"scale",2),a(wt,"maxDiagonalCost",0),wt);const Vt=class Vt{constructor(t,e,s){a(this,"index",0);a(this,"pathData",new Map);a(this,"strength",0);a(this,"unit",ge);a(this,"energy",25);a(this,"spawnInterval",200);a(this,"spawnDelay",0);a(this,"burstSize",Number.POSITIVE_INFINITY);a(this,"burstInterval",1e3);a(this,"burst",0);a(this,"timer",0);a(this,"centerX",0);a(this,"centerY",0);this.spawnPoints=t,this.target=e,this.surface=s,t.forEach(n=>{this.centerX+=n.getX(),this.centerY+=n.getY()}),this.centerX/=t.length,this.centerY/=t.length}setUnit(t){this.unit=t}getUnitType(){return this.unit.type}setParameters(t,e,s,n,r){this.energy=t,this.spawnInterval=e,this.spawnDelay=s,this.burstSize=n,this.burstInterval=r,this.burst=0,this.timer=e}getEnergy(){return this.energy}tick(t){if(!(this.energy===0||!this.isReady())){if(this.timer+=t,this.spawnDelay>0)if(this.timer>this.spawnDelay)this.timer-=this.spawnDelay,this.spawnDelay=0;else return;if(this.burst>=this.burstSize)if(this.timer>=this.burstInterval)this.timer-=this.burstInterval,this.burst=0;else return;for(;this.timer>=this.spawnInterval;){this.timer-=this.spawnInterval,this.energy=Math.max(0,this.energy-this.unit.cost),this.burst++;const e=this.getNextUnit();u.Instance.spawnEnemy(e)}}}getCenter(){return[this.centerX,this.centerY]}isReady(){return!!this.getPathData(this.unit.type).getPaths().length}getSpawnPoints(){return this.getPathData(this.unit.type).getPaths()}getAsyncSpawnPoints(){return this.getPathData(this.unit.type).getAsyncPaths()}getNextSpawnPoint(){const t=this.getSpawnPoints(),e=t[this.index];return this.index=(this.index+1)%t.length,e}getNextUnit(){const t=this.getNextSpawnPoint().clone(),e=new this.unit(t.getTile(),t);return e.initializePath(),e}grow(){this.strength++}getStrength(){return this.strength}isExposed(){let t=0,e=0;return this.surface.forCircle(this.centerX,this.centerY,Vt.size,s=>{t++,s.getDiscoveryStatus()!==z.Undiscovered&&e++}),e/t}rePath(){this.pathData.forEach(t=>t.update())}serialize(){return{spawnPoints:this.spawnPoints.map(t=>({x:t.getX(),y:t.getY()})),unit:this.unit.type,energy:this.energy,spawnInterval:this.spawnInterval,spawnDelay:this.spawnDelay,burstSize:this.burstSize,burstInterval:this.burstInterval}}static deserialize(t,e,s){const n=new Vt(s.spawnPoints.map(({x:r,y:o})=>t.getTile(r,o)),e,t);return n.setUnit(Vt.unitMap[s.unit]),n.setParameters(s.energy,s.spawnInterval,s.spawnDelay,s.burstSize??Number.POSITIVE_INFINITY,s.burstInterval),n}getPathData(t){return this.pathData.has(t)||this.pathData.set(t,new Hr(new jr(this.surface,this.unit.pathMultipliers,this.unit.pathCosts,this.unit.scale,this.unit.maxDiagonalCost),this.spawnPoints,this.target)),this.pathData.get(t)}static fromTiles(t,e,s){return new Vt(t,e,s)}};a(Vt,"size",5),a(Vt,"unitMap",{[c.Runner]:ge,[c.Slime]:sa,[c.Tank]:ia,[c.Flier]:na,[c.Behemoth]:oa,[c.Bore]:ji});let Dt=Vt;var N=(i=>(i.Practice="practice",i.Easy="easy",i.Normal="normal",i.Hard="hard",i))(N||{});const ln={practice:{label:"Practice",description:"Like easy mode but with infinite money. Great for getting to know the game mechanics but achievements are disabled."},easy:{label:"Easy",description:"Allows checking which tiles are covered by tower sight lines. Shows the approximate path enemies will take and undiscovered nests do not become stronger."},normal:{label:"Normal",description:"Allows checking which tiles are covered by tower sight lines. Enemies are a bit stronger and undiscovered nests slowly gain more strength."},hard:{label:"Hard",description:"Checking tower sight lines is no longer possible, enemies are stronger and undiscovered nests gain strength more quickly."}};class be{constructor(t,e,s=[]){this.min=t,this.max=e,this.units=s}getRange(){return[this.min,this.max]}getCenter(){return(this.min+this.max)/2}getLength(){return this.max-this.min}getUnits(){return this.units}addUnit(t){this.units.includes(t)||this.units.push(t),this.units.sort((e,s)=>s-e)}equals(t){return this.min===t.min&&this.max===t.max}toString(){return`[${this.min}, ${this.max}]`}static forSpawnGroup(t){const[e,s]=t.getCenter(),n=u.Instance.getBase().getTile(),r=e-n.getX(),o=s-n.getY(),h=(Math.atan2(o,r)*180/Math.PI+360)%360;switch(u.Instance.getDifficulty()){case N.Easy:case N.Practice:return new be(Math.floor(h/15)*15,Math.floor(h/15)*15+15,[t.getUnitType()]);case N.Normal:return new be(Math.floor(h/45)*45,Math.floor(h/45)*45+45,[t.getUnitType()]);case N.Hard:return new be(Math.floor(h/120)*120,Math.floor(h/120)*120+120,[t.getUnitType()])}}static forSpawnGroups(t){const e=new Map;return t.filter(s=>!s.isExposed()).forEach(s=>{const n=be.forSpawnGroup(s),r=e.get(n.toString());r?r.addUnit(s.getUnitType()):e.set(n.toString(),n)}),[...e.values()]}}const Bo=(i,t)=>{const e=new Array(t).fill(0).map(Math.random),s=e.reduce((n,r)=>n+r);return e.map(n=>n/s*i)},Ie=()=>{let i=1-Math.random(),t=Math.random(),e=Math.sqrt(-2*Math.log(i))*Math.cos(2*Math.PI*t);return e=e/10+.5,e>1||e<0?Ie():e},Ro=4e3,_o=20,Do=550,Lo=500,Yo=3e3,Oo=3,Fo=4,$o=1.1,Xo={[N.Practice]:0,[N.Easy]:0,[N.Normal]:1.5*ge.cost,[N.Hard]:3*ge.cost},No={[c.Runner]:.5,[c.Slime]:1,[c.Flier]:1,[c.Tank]:1.2,[c.Behemoth]:1.6,[c.Bore]:10};class He{constructor(t){this.spawnGroups=t}isDone(){return!this.spawnGroups.find(t=>t.getEnergy()>0)}getSpawnGroups(){return this.spawnGroups}tick(t){this.spawnGroups.forEach(e=>e.tick(t))}static fromSpawnGroups(t,e){const s=(1+t**2.6/3)*ge.cost,n=Bo(s,e.length),r=Xo[u.Instance.getDifficulty()];return e.forEach((o,h)=>{const l=n[h]*$o+r*o.getStrength(),d=h===0||Math.random()>.5?0:Ie()*Ro,g=Math.random()>.5?Ie()*Fo*Math.log(l)+Oo:Number.POSITIVE_INFINITY;o.setParameters(l,(Ie()*Do/(t*.1+1)+_o)*No[o.getUnitType()],d,g,Ie()*Yo+Lo)}),new He(e)}static getUnitForLevel(t){if(t===0)return ge;if(t!==1&&(t+1)%10===0)return ji;const e=Math.random();return e<.2-t/200?ge:t>=3&&e<.3?na:t>=8&&e<.6?oa:Math.random()>Math.min(.7,.1+t/30)?sa:ia}}const oe=class oe{constructor(t,e){a(this,"spawnGroups",[]);a(this,"nextSpawnGroup");a(this,"initialNextSpawnGroup");a(this,"direction",Math.random()*Math.PI*2);a(this,"nextUnit");a(this,"wave");a(this,"timeSinceLastExpansion",0);a(this,"removeSurfaceChangeEventListener");a(this,"onSurfaceChange",({affectedTiles:t,removedStaticAgents:e})=>{const s=this.isWaveInProgress();this.spawnGroups.forEach(r=>{s?r.getSpawnPoints().forEach(o=>{o.isAffectedByTiles(t)&&o.recompute()}):(e.size>0||r.getSpawnPoints().find(h=>h.isAffectedByTiles(t)))&&r.rePath()});const n=this.getNextSpawnGroup();!s&&n&&(e.size>0||n.getSpawnPoints().find(o=>o.isAffectedByTiles(t)))&&n.rePath()});this.base=t,this.surface=e,oe.instance&&oe.instance.removeSurfaceChangeEventListener(),oe.instance=this,this.removeSurfaceChangeEventListener=B.Instance.addEventListener(E.SurfaceChange,this.onSurfaceChange)}tick(t){this.wave&&this.wave.tick(t)}startNewWave(){const t=u.Instance.getLevel();it.Instance.hasPendingAgents()&&(this.timeSinceLastExpansion=0),this.spawnGroups.forEach(n=>{n.grow(),n.rePath()});const e=[],s=this.getNextSpawnGroup();s&&e.push(s),s!==this.initialNextSpawnGroup&&e.push(this.initialNextSpawnGroup),e.forEach(n=>{this.timeSinceLastExpansion=0;const[r,o]=n.getCenter(),h=[];this.surface.forCircle(r,o,Dt.size,l=>{Ds.has(l.getType())&&(h.push(new et(l.getX(),l.getY(),f.Spore)),l.hasStaticEntity()&&this.surface.despawnStatic(l.getStaticEntity().getAgent()))}),this.surface.setTiles(h),this.spawnGroups.push(n)}),this.cleanupSpawnGroups(Ls.Radar),this.nextUnit=void 0,this.nextSpawnGroup=void 0,this.initialNextSpawnGroup=void 0,this.wave=He.fromSpawnGroups(t,t===9?[this.spawnGroups[0]]:[...this.spawnGroups])}processWave(){return this.isWaveInProgress()?!1:(this.timeSinceLastExpansion++,this.spawnGroups.forEach(t=>t.setUnit(He.getUnitForLevel(u.Instance.getLevel()))),!0)}cleanupSpawnGroups(t){for(let e=this.spawnGroups.length-1;e>=0;e--){const s=this.spawnGroups[e];s.isExposed()>0&&(this.spawnGroups.splice(e,1),it.Instance.uncoverSpawnGroup(s,t))}}getWave(){return this.wave}getSpawnGroups(){const t=this.spawnGroups.filter(e=>e.isExposed()===0);if(!this.isWaveInProgress()){const e=this.getNextSpawnGroup();e&&t.push(e)}return u.Instance.getLevel()===9+(this.isWaveInProgress()?1:0)?[t[0]]:t}getSpawnAlertRanges(){return be.forSpawnGroups(this.getSpawnGroups())}isWaveInProgress(){return this.wave&&!this.wave.isDone()?!0:this.surface.getEntitiesForCategory(R.Enemy).size>0}shouldAddSpawnGroup(){if(this.initialNextSpawnGroup&&!this.initialNextSpawnGroup.isExposed())return!0;const t=Math.ceil(2**this.spawnGroups.length/3),e=it.Instance.hasPendingAgents()?0:this.timeSinceLastExpansion;return this.spawnGroups.filter(n=>n.isExposed()===0).length===0||e>=t}serialize(){return{spawnGroups:this.spawnGroups.map(t=>t.serialize()),nextSpawnGroup:this.nextSpawnGroup?this.nextSpawnGroup.serialize():null,direction:this.direction,timeSinceLastExpansion:this.timeSinceLastExpansion}}static deserialize(t,e,s){const n=new oe(e,t);return n.spawnGroups=s.spawnGroups.map(r=>Dt.deserialize(t,e.getTile(),r)),s.nextSpawnGroup&&(n.nextSpawnGroup=Dt.deserialize(t,e.getTile(),s.nextSpawnGroup),n.initialNextSpawnGroup=n.nextSpawnGroup),n.direction=s.direction,n.timeSinceLastExpansion=s.timeSinceLastExpansion,n}getNextSpawnGroup(){if(!this.shouldAddSpawnGroup())return;if(this.nextSpawnGroup&&!this.nextSpawnGroup.isExposed())return this.nextSpawnGroup;if(this.initialNextSpawnGroup&&!this.initialNextSpawnGroup.isExposed())return this.nextSpawnGroup=this.initialNextSpawnGroup,this.nextSpawnGroup;const t=u.Instance.getLevel();this.nextUnit||(this.nextUnit=He.getUnitForLevel(t)),this.nextUnit===ji?this.direction=this.surface.getTowerDirection(this.base.getTile()):this.direction+=(Math.random()>.5?1:-1)*Math.max(Math.PI/6*Ie()*Math.min(Math.PI*2,t+1));let e=!1,s=3;for(let n=0;n<20&&(this.surface.forRay(this.base.getTile().getX(),this.base.getTile().getY(),this.direction,r=>r.getDiscoveryStatus()!==z.Undiscovered?(s=4+Math.min(u.Instance.getLevel()/2,Math.floor(Math.random()*6)),!0):(s--,s>0?!0:(Math.random()>.66?!Ds.has(r.getType()):!Ni.has(r.getType()))?!(u.Instance.getLevel()===0&&n<10):(this.nextSpawnGroup=Dt.fromTiles([r,r,r,r],this.base.getTile(),this.surface),this.nextSpawnGroup.setUnit(this.nextUnit),e=!0,!1))),!e);n++)this.direction+=Math.PI/10;return this.initialNextSpawnGroup||(this.initialNextSpawnGroup=this.nextSpawnGroup),this.nextSpawnGroup}static get Instance(){return this.instance}};a(oe,"instance");let K=oe;const Ms=i=>i.getType()===c.Base,qe=class qe{constructor(t){a(this,"discoveredSpawnGroups",new Set);a(this,"agents",new Set);a(this,"edgeMap",new Map);a(this,"pendingAgents",new Set);a(this,"base");a(this,"pendingRadius",0);a(this,"discoveredEdge",!1);a(this,"minX");a(this,"minY");a(this,"maxX");a(this,"maxY");this.surface=t,qe.instance=this}registerAgent(t){this.agents.add(t);let e=z.Pending;Ms(t)?(this.base=t,e=z.Discovered):this.pendingAgents.add(t);const s=this.getVisibilityRange(t),n=this.getVisibilityEdge(t);this.edgeMap.set(t.entity.getId(),n),this.updateVisibility(...n,s,e)}removeAgent(t){if(!this.agents.has(t))return;Ms(t)&&(this.base=void 0);const e=this.getVisibilityRange(t),s=this.edgeMap.get(t.entity.getId());this.surface.forCircle(...s,e,n=>n.setDiscoveryStatus(z.Undiscovered)),this.agents.delete(t),this.pendingAgents.delete(t),this.edgeMap.delete(t.entity.getId()),this.update()}commit(){this.pendingAgents.clear(),this.pendingRadius=0,this.update()}updateBaseRange(){if(!this.base)throw new Error("Updating base range without a base");this.pendingRadius=this.getVisibilityRange(this.base),this.updateVisibility(...this.getVisibilityEdge(this.base),this.pendingRadius,z.Pending)}getBBox(){return[[this.minX,this.minY],[this.maxX,this.maxY]]}hasPendingAgents(){return this.pendingAgents.size>0}uncoverSpawnGroup(t,e){const s=K.Instance.getSpawnGroups();this.discoveredSpawnGroups.add(t);const[n,r]=t.getCenter();this.updateVisibility(n,r,Dt.size,z.Discovered),s.forEach(o=>{const[h,l]=o.getCenter();this.surface.forCircle(h,l,Dt.size,d=>{d.getDiscoveryStatus()!==z.Undiscovered&&d.setDiscoveryStatus(z.Undiscovered)})}),B.Instance.triggerEvent(E.Discover,{x:n,y:r,method:e})}isEdgeDiscovered(){return this.discoveredEdge}serialize(){return{tiles:[...this.agents].map(e=>{const s=e.getTile(),n=this.edgeMap.get(e.entity.getId());return{x:s.getX(),y:s.getY(),edge:n}}),discoveredSpawnGroups:[...this.discoveredSpawnGroups].map(e=>e.serialize())}}static deserialize(t,e){const s=new qe(t);for(let n of e.tiles){const r=t.getTile(n.x,n.y).getStaticEntity().getAgent();Ms(r)&&(s.base=r),s.agents.add(r),s.edgeMap.set(r.entity.getId(),n.edge)}for(let n of e.discoveredSpawnGroups)s.discoveredSpawnGroups.add(Dt.deserialize(t,s.base.getTile(),n));return s}update(){this.minX=void 0,this.minY=void 0,this.maxX=void 0,this.maxY=void 0,this.agents.forEach(s=>{const n=this.getVisibilityRange(s),r=this.edgeMap.get(s.entity.getId());this.surface.forCircle(...r,n,o=>o.setDiscoveryStatus(z.Undiscovered))}),this.pendingRadius>0&&this.base&&this.updateVisibility(...this.getVisibilityEdge(this.base),this.pendingRadius,z.Pending),this.agents.forEach(s=>{const n=this.pendingAgents.has(s)?z.Pending:z.Discovered,r=this.getVisibilityRange(s),o=this.getVisibilityEdge(s);this.edgeMap.set(s.entity.getId(),o),this.updateVisibility(...o,r,n)});const t=[],e=K.Instance.getSpawnGroups();this.discoveredSpawnGroups.forEach(s=>{if(s.isExposed()===0){t.push(s);return}const n=s.getCenter();this.updateVisibility(...n,5,z.Discovered)}),e.forEach(s=>{const[n,r]=s.getCenter();this.surface.forCircle(n,r,Dt.size,o=>{o.getDiscoveryStatus()!==z.Undiscovered&&o.setDiscoveryStatus(z.Undiscovered)})}),t.forEach(s=>this.discoveredSpawnGroups.delete(s))}getVisibilityRange(t){switch(t.getType()){case c.Base:return 35+(u.Instance.getLevel()-(this.pendingRadius>0?1:0))*2;case c.Radar:return 21;default:throw new Error("Entity has no visibility defined")}}getVisibilityEdge(t){if(Ms(t)||!this.base)return[t.entity.getAlignedX(),t.entity.getAlignedY()];let e;const s=Math.atan2(t.entity.getAlignedY()-this.base.entity.getAlignedY(),t.entity.getAlignedX()-this.base.entity.getAlignedX());return this.surface.forRay(this.base.entity.getAlignedX(),this.base.entity.getAlignedY(),s,n=>n.getDiscoveryStatus()===z.Undiscovered?!1:(e=n,!0)),e?[e.getX(),e.getY()]:[t.entity.getAlignedX(),t.entity.getAlignedY()]}updateVisibility(t,e,s,n){(!this.minX||t-s/2<this.minX)&&(this.minX=t-s/2),(!this.minY||e-s/2<this.minY)&&(this.minY=e-s/2),(!this.maxX||t+s/2>this.maxX)&&(this.maxX=t+s/2),(!this.maxY||e+s/2>this.maxY)&&(this.maxY=e+s/2),this.surface.forCircle(t,e,s,r=>{n===z.Pending&&r.isDiscovered()||(n===z.Discovered&&r.getType()===f.Void&&(this.discoveredEdge=!0),r.setDiscoveryStatus(n))})}static get Instance(){return this.instance}};a(qe,"instance");let vi=qe;const it=vi;class Ki{constructor(t){a(this,"entity");a(this,"category",R.Player);a(this,"renderData",{});this.tile=t,this.entity=new W(t.getX(),t.getY(),this)}getType(){return c.Radar}getTile(){return this.tile}updateTile(t){this.tile=t}spawn(){it.Instance.registerAgent(this),u.Instance.getBase().addPart(this),Oe(this,3)}despawn(){it.Instance.removeAgent(this),u.Instance.getBase().removePart(this)}hit(t){u.Instance.getBase().hit(t)}isVisible(){return!0}}a(Ki,"scale",2);const Uo=new Set([f.Obstructed,f.Wall,f.PlayerBuilding,f.Base]),Ue=i=>Uo.has(i.getType()),Si=250;let zo=class{constructor(t){a(this,"entity");a(this,"category",R.Unknown);a(this,"time",0);a(this,"renderData",{});a(this,"sourceX");a(this,"sourceY");this.source=t;const[e,s]=bt(t);this.entity=new at(e,s,this),this.sourceX=e,this.sourceY=s}dealDamage(t,e){this.renderData.update=!0,this.time>Si&&u.Instance.getSurface().spawn(this),this.time=0;const s=Math.atan2(t.getOffsetX()+.5-this.sourceX,t.getOffsetY()+.5-this.sourceY);this.entity.setRotation(s*180/Math.PI),this.source.entity.setRotation(-this.entity.getRotation()+180),this.entity.setX(t.entity.getAlignedX()),this.entity.setY(t.entity.getAlignedY()),t.AI.hit(e),t.lightOnFire&&t.lightOnFire()}tick(t){this.time+=t,this.time>Si&&u.Instance.getSurface().despawn(this)}getType(){return c.Flame}isVisible(){return!0}};const un=1,Go=.04,Ze=class Ze{constructor(t){a(this,"entity");a(this,"category",R.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"flame");a(this,"hp",160);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});this.tile=t,this.entity=new W(t.getX(),t.getY(),this)}tick(t){this.isEnabled&&(this.cooldown=Math.max(0,this.cooldown-t))}fire(t,e){this.cooldown=un;const s=u.Instance.consumeContinuous(this,e,this.damageMultiplier*this.speedMultiplier),n=Go*(s?this.damageMultiplier*this.speedMultiplier:1)*e;return this.flame||(this.flame=new zo(this),u.Instance.getSurface().spawn(this.flame)),this.flame.dealDamage(t,n),this.renderData.fired=!0,n}spawn(){[this.cleanupEventListener]=De(this,Ze.range,Ue)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=Le(t),this.damageMultiplier=Ye(t)}getCooldown(){return this.cooldown}getType(){return c.Flamethrower}hit(t){this.hp-=t,this.hp<=0&&(this.renderData.destroyed=!0,u.Instance.getSurface().despawnStatic(this))}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=un,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}};a(Ze,"scale",2),a(Ze,"range",6);let Fs=Ze;class qi{constructor(){a(this,"source");a(this,"target");a(this,"sourceX");a(this,"sourceY");a(this,"targetX");a(this,"targetY");a(this,"travelTime")}}function ha(i,t=0){const[e,s]=bt(this.source);this.sourceX=e,this.sourceY=s;const n=e-this.target.getOffsetX()+.5,r=s-this.target.getOffsetY()+.5,o=Math.sqrt(n*n+r*r)+t;this.travelTime=o/i;const h=this.target.AI.getFuturePosition(this.travelTime),{x:l,y:d}=this.target.getPath().getCoordinates(h);this.targetX=l+this.target.getScale()/2,this.targetY=d+this.target.getScale()/2}function la(i,t){const e=i.getOffsetX()-this.entity.getX(),s=i.getOffsetY()-this.entity.getY();return e*e+s*s<=t}const ua=(i,t)=>(i%t+t)%t,Yt=(i,t,e)=>i+(t-i)*e,Ho=(i,t,e)=>{if(i===t)return t;const s=ua(t-i+180,360)-180;return s<0?(i-Math.min(-s,e)+360)%360:i+Math.min(s,e)},Wo=.01,dn=5,gn=2,Vo=gn*gn;let jo=class extends qi{constructor(e,s,n){super();a(this,"entity");a(this,"category",R.Unknown);a(this,"renderData",{});a(this,"time",0);a(this,"prevX");a(this,"prevY");a(this,"straightY",0);this.source=e,this.target=s,this.damage=n,ha.call(this,Wo,dn*2),this.entity=new at(this.sourceX,this.sourceY,this),this.entity.lookAt(this.targetX,this.targetY),this.source.entity.setRotation(this.entity.getRotation()),this.entity=new at(this.sourceX,this.sourceY,this),this.entity.lookAt(this.targetX,this.targetY),this.source.entity.setRotation(this.entity.getRotation())}tick(e){if(this.time>=this.travelTime){u.Instance.getSurface().despawn(this);let r=!1;const o=[...u.Instance.getSurface().getEntitiesForCategory(R.Enemy)].filter(h=>la.call(this,h.getAgent(),Vo));o.forEach(h=>{h.getAgent().AI.hit(this.damage),h.getAgent()===this.target&&(r=!0)}),o.length>$s.maxBombedEnemies&&($s.maxBombedEnemies=o.length,B.Instance.triggerEvent(E.Bomb,{amount:o.length})),r||this.target.AI.miss(this.damage)}this.time=Math.min(this.time+e,this.travelTime);const s=this.time/this.travelTime,n=Math.sin(s*Math.PI)*dn;if(this.straightY=Yt(this.sourceY,this.targetY,s),this.entity.setX(Yt(this.sourceX,this.targetX,s)),this.entity.setY(this.straightY-n),this.prevX&&this.prevY){const r=this.entity.getX()-this.prevX,o=this.entity.getY()-this.prevY;this.entity.setRotation(Math.atan2(o,r)*180/Math.PI+90)}this.prevX=this.entity.getX(),this.prevY=this.entity.getY()}getType(){return c.Rocket}isVisible(){return!0}getPercentage(){return this.time/this.travelTime}};const pn=5e3,Ko=50,Ce=class Ce{constructor(t){a(this,"entity");a(this,"category",R.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"hp",80);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});this.tile=t,this.entity=new W(t.getX(),t.getY(),this)}tick(t){!this.isEnabled||this.cooldown<=0||(this.cooldown-=t*this.speedMultiplier)}fire(t){if(this.cooldown+=pn,!u.Instance.consume(this,this.speedMultiplier,this.damageMultiplier))return 0;const e=Ko*this.damageMultiplier,s=new jo(this,t,e);return u.Instance.getSurface().spawn(s),this.renderData.fired=!0,e}spawn(){[this.cleanupEventListener]=De(this,Ce.range)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=Le(t),this.damageMultiplier=Ye(t)}getCooldown(){return this.cooldown}getType(){return c.Mortar}hit(t){this.hp-=t,this.hp<=0&&(this.renderData.destroyed=!0,u.Instance.getSurface().despawnStatic(this))}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=pn,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}};a(Ce,"scale",2),a(Ce,"range",24),a(Ce,"maxBombedEnemies",0);let Ei=Ce;const $s=Ei,qo=(i,t,e,s,n)=>{const r=Math.atan2(n-t,s-i);let o=ua(r-e+Math.PI,Math.PI*2)-Math.PI;return Math.abs(o)>=Math.PI?Number.POSITIVE_INFINITY:Math.abs(Math.cos(e)*(t-n)-Math.sin(e)*(i-s))},ds=(i,t,e,s)=>(i-e)**2+(t-s)**2,Zi=1500;let Zo=class{constructor(t,e,s){a(this,"entity");a(this,"category",R.Unknown);a(this,"renderData",{});a(this,"targetX");a(this,"targetY");a(this,"time",0);this.source=t,this.damage=s;const[n,r]=bt(t);this.entity=new at(n,r,this);const o=Math.atan2(e.getOffsetY()+.5-this.entity.getY(),e.getOffsetX()+.5-this.entity.getX());this.entity.setRotation(o*180/Math.PI),this.source.entity.setRotation(this.entity.getRotation()+90),u.Instance.getSurface().forRay(e.entity.getX(),e.entity.getY(),o,d=>(this.targetX=d.getX(),this.targetY=d.getY(),!Ue(d)));const h=ds(this.entity.getX(),this.entity.getY(),this.targetX,this.targetY),l=[...u.Instance.getSurface().getEntitiesForCategory(R.Enemy)].filter(d=>ds(this.entity.getX(),this.entity.getY(),d.getX()+.5,d.getY()+.5)<=h+1).filter(d=>qo(this.entity.getX(),this.entity.getY(),o,d.getX()+.5,d.getY()+.5)<=d.getAgent().getScale()/2);l.forEach(d=>{d.getAgent().AI.hit(this.damage)}),l.length>Xs.maxPierceEnemies&&(Xs.maxPierceEnemies=l.length,B.Instance.triggerEvent(E.Pierce,{amount:l.length}))}tick(t){this.time+=t,this.time>Zi&&u.Instance.getSurface().despawn(this)}getType(){return c.Rail}isVisible(){return!0}};const fn=5e3,Qo=70,Te=class Te{constructor(t){a(this,"entity");a(this,"category",R.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"hp",80);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});this.tile=t,this.entity=new W(t.getX(),t.getY(),this)}tick(t){!this.isEnabled||this.cooldown<=0||(this.cooldown-=t*this.speedMultiplier)}fire(t){if(this.cooldown+=fn,!u.Instance.consume(this,this.speedMultiplier,this.damageMultiplier))return 0;const e=Qo*this.damageMultiplier,s=new Zo(this,t,e);return u.Instance.getSurface().spawn(s),this.renderData.fired=!0,e}spawn(){[this.cleanupEventListener]=De(this,Te.range,Ue)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=Le(t),this.damageMultiplier=Ye(t)}getCooldown(){return this.cooldown}getType(){return c.Railgun}hit(t){this.hp-=t,this.hp<=0&&(this.renderData.destroyed=!0,u.Instance.getSurface().despawnStatic(this))}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=fn,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}};a(Te,"scale",2),a(Te,"range",30),a(Te,"maxPierceEnemies",0);let bi=Te;const Xs=bi,Jo=.015;class tc extends qi{constructor(e,s,n){super();a(this,"entity");a(this,"category",R.Unknown);a(this,"renderData",{});a(this,"time",0);this.source=e,this.target=s,this.damage=n,ha.call(this,Jo),this.entity=new at(this.sourceX,this.sourceY,this),this.entity.lookAt(this.targetX,this.targetY),this.source.entity.setRotation(this.entity.getRotation())}tick(e){this.time>=this.travelTime&&(u.Instance.getSurface().despawn(this),this.target.AI.hit(this.damage)),this.time=Math.min(this.time+e,this.travelTime);const s=this.time/this.travelTime;this.entity.setX(Yt(this.sourceX,this.targetX,s)),this.entity.setY(Yt(this.sourceY,this.targetY,s))}getType(){return c.Bullet}isVisible(){return!0}}const mn=500,ec=10;var le;let da=(le=class{constructor(t){a(this,"entity");a(this,"category",R.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"hp",50);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});this.tile=t,this.entity=new W(t.getX(),t.getY(),this)}tick(t){!this.isEnabled||this.cooldown<=0||(this.cooldown-=t*this.speedMultiplier)}fire(t){this.cooldown+=mn;const e=u.Instance.consume(this,this.speedMultiplier,this.damageMultiplier),s=ec*(e?this.damageMultiplier:1),n=new tc(this,t,s);return u.Instance.getSurface().spawn(n),this.renderData.fired=!0,s}spawn(){[this.cleanupEventListener]=De(this,le.range,Ue)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=Le(t),this.damageMultiplier=Ye(t)}getCooldown(){return this.cooldown}getType(){return c.Tower}hit(t){this.hp-=t,this.hp<=0&&(this.renderData.destroyed=!0,u.Instance.getSurface().despawnStatic(this))}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=mn,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}},a(le,"scale",2),a(le,"range",10),le);var pi;let ga=(pi=class{constructor(t){a(this,"entity");a(this,"category",R.Player);a(this,"hp",50);a(this,"renderData",{});this.tile=t,this.entity=new W(t.getX(),t.getY(),this)}getType(){return c.Wall}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}},a(pi,"scale",2),pi);const Ns=250;let sc=class{constructor(t){a(this,"entity");a(this,"category",R.Unknown);a(this,"renderData",{});a(this,"time",0);a(this,"targetX",0);a(this,"targetY",0);this.source=t;const[e,s]=bt(t);this.entity=new at(e,s,this)}dealDamage(t,e){this.time>Ns&&u.Instance.getSurface().spawn(this),this.time=0,this.targetX=t.getOffsetX()+.5,this.targetY=t.getOffsetY()+.5;const s=Math.atan2(this.targetY-this.entity.getY(),this.targetX-this.entity.getX());this.entity.setRotation(s*180/Math.PI),this.source.entity.setRotation(this.entity.getRotation()+90),t.AI.hit(e),t.lightOnFire&&t.lightOnFire()}tick(t){this.time+=t,this.time>Ns&&u.Instance.getSurface().despawn(this)}getType(){return c.LaserBeam}isVisible(){return!0}};const yn=1,ic=.06,nc=500,Qe=class Qe{constructor(t){a(this,"entity");a(this,"category",R.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"laserBeam");a(this,"hp",80);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});a(this,"lastTarget");this.tile=t,this.entity=new W(t.getX(),t.getY(),this)}tick(t){!this.isEnabled||this.cooldown<=0||(!this.laserBeam&&this.lastTarget&&this.entity.lookAt(this.lastTarget.entity),this.cooldown=Math.max(0,this.cooldown-t))}fire(t,e){if(this.lastTarget!==t)return this.lastTarget=t,this.cooldown=nc,0;if(this.cooldown=yn,!u.Instance.consumeContinuous(this,e,this.damageMultiplier*this.speedMultiplier))return 0;const s=ic*this.damageMultiplier*this.speedMultiplier*e;return this.laserBeam||(this.laserBeam=new sc(this),u.Instance.getSurface().spawn(this.laserBeam)),this.laserBeam.dealDamage(t,s),this.renderData.fired=!0,s}spawn(){[this.cleanupEventListener]=De(this,Qe.range,Ue)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=Le(t),this.damageMultiplier=Ye(t)}getCooldown(){return this.cooldown}getType(){return c.Laser}hit(t){this.hp-=t,this.hp<=0&&(this.renderData.destroyed=!0,u.Instance.getSurface().despawnStatic(this))}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=yn,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}};a(Qe,"scale",2),a(Qe,"range",16);let Us=Qe;class Qi{constructor(t){a(this,"entity");a(this,"category",R.Player);a(this,"renderData",{});this.tile=t,this.entity=new W(t.getX(),t.getY(),this)}spawn(){u.Instance.getBase().addPart(this),Oe(this,3)}despawn(){u.Instance.getBase().removePart(this)}getType(){return c.Barracks}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){u.Instance.getBase().hit(t)}isVisible(){return!0}}a(Qi,"scale",2);const ac=.01,Ii=800;let rc=class extends qi{constructor(e,s,n){super();a(this,"entity");a(this,"category",R.Unknown);a(this,"renderData",{});a(this,"time",0);a(this,"sectionTime",0);a(this,"index",-1);this.source=e,this.chain=s;const[r,o]=bt(e);this.sourceX=r,this.sourceY=o,s.forEach(h=>{h.AI.hit(n),h.stun&&h.stun()}),this.entity=new at(this.sourceX,this.sourceY,this),this.nextTarget()}nextTarget(){this.index++,this.index>=this.chain.length&&(this.entity.setX(this.sourceX),this.entity.setY(this.sourceY),this.index=0);const e=this.chain[this.index];this.targetX=e.getOffsetX(),this.targetY=e.getOffsetY(),this.travelTime=Math.sqrt(ds(this.entity.getX(),this.entity.getY(),this.targetX,this.targetY))/ac,this.sectionTime=0,this.entity.lookAt(this.targetX,this.targetY)}tick(e){this.time>=Ii&&u.Instance.getSurface().despawn(this),this.time+=e,this.sectionTime+=e,this.sectionTime>this.travelTime&&this.nextTarget();const s=this.sectionTime/this.travelTime;this.entity.setX(Yt(this.sourceX,this.targetX,s)),this.entity.setY(Yt(this.sourceY,this.targetY,s))}getChain(){return this.chain}getType(){return c.Spark}isVisible(){return!0}};const ci=4e3,oc=700,cc=50,jt=class jt{constructor(t){a(this,"entity");a(this,"category",R.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"coveredTiles");a(this,"hp",160);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});a(this,"charging",!1);this.tile=t,this.entity=new W(t.getX(),t.getY(),this)}tick(t){if(!(!this.isEnabled||this.cooldown<=0)&&(this.cooldown-=t*(this.charging?1:this.speedMultiplier),this.charging&&ci-this.cooldown>oc)){this.charging=!1;const e=u.Instance.getSurface(),s=[...u.Instance.getSurface().getEntitiesForCategory(R.Enemy)].filter(h=>this.coveredTiles.has(e.getTile(h.getAlignedX(),h.getAlignedY())));s.length>jt.maxStunnedEnemies&&(jt.maxStunnedEnemies=s.length,B.Instance.triggerEvent(E.Stun,{amount:s.length}));const n=new Map;s.forEach(h=>n.set(h.getId(),ds(h.getX(),h.getY(),...bt(this))));const r=[];s.sort((h,l)=>n.get(h.getId())-n.get(l.getId())).forEach(h=>{let l=n.get(h.getId()),d;r.forEach(g=>{const p=g[g.length-1],v=ds(h.getX(),h.getY(),p.getX(),p.getY());v<l&&(l=v,d=g)}),d?d.push(h):r.push([this.entity,h])});const o=cc*this.damageMultiplier;r.forEach(h=>{const l=new rc(this,h.slice(1,h.length).map(d=>d.getAgent()),o);u.Instance.getSurface().spawn(l)})}}fire(){return this.cooldown+=ci,u.Instance.consume(this,this.speedMultiplier,this.damageMultiplier)&&(this.charging=!0,this.renderData.fired=!0),0}spawn(){[this.cleanupEventListener,this.coveredTiles]=De(this,jt.range,Ue)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=Le(t),this.damageMultiplier=Ye(t)}getCooldown(){return this.cooldown}getType(){return c.Tesla}hit(t){this.hp-=t,this.hp<=0&&(this.renderData.destroyed=!0,u.Instance.getSurface().despawnStatic(this))}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=ci,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}};a(jt,"scale",2),a(jt,"range",8),a(jt,"maxStunnedEnemies",0);let zs=jt;const Mi={[c.ElectricFence]:.05,[c.Laser]:.003,[c.Railgun]:5,[c.Tesla]:4,[c.Mortar]:2},mt=class mt{constructor(){a(this,"generators",new Set);a(this,"consumption",0);a(this,"blackout",!1);a(this,"power",0);mt.instance=this}registerGenerator(t){this.generators.add(t)}removeGenerator(t){this.generators.delete(t)}getProduction(){return u.Instance.getBase().getPartsCount(c.PowerPlant)*mt.powerMultiplier}getConsumption(){return this.consumption}consume(t){return t===0?!0:this.blackout?!1:(this.power-=t,this.power<0?(this.power=0,this.blackout=!0,B.Instance.triggerEvent(E.BlackOut),u.Instance.triggerStatUpdate(),!1):(this.consumption+=t,!0))}processPower(){this.power=this.power+this.getProduction(),this.blackout=!1,this.power<0&&B.Instance.triggerEvent(E.BlackOut),u.Instance.getIsStarted()||(this.consumption=0)}emergencyRegenerate(t=1){this.power=this.power+(mt.baseEmergencyRegenerate+u.Instance.getBase().getParts().size*mt.emergencyRegenerateMultiplier)*t,this.blackout=!1}getPower(){return this.power}serialize(){return{power:this.power,consumption:this.consumption,generators:[...this.generators].map(t=>{const e=t.getTile();return{x:e.getX(),y:e.getY()}})}}static get Instance(){return this.instance}static deserialize(t,e){const s=new mt;s.power=e.power,s.consumption=e.consumption,s.generators=new Set(e.generators.map(({x:n,y:r})=>t.getTile(n,r).getStaticEntity().getAgent()))}};a(mt,"speedBeaconConsumption",1.1),a(mt,"damageBeaconConsumption",1.2),a(mt,"instance"),a(mt,"powerMultiplier",5),a(mt,"baseEmergencyRegenerate",30),a(mt,"emergencyRegenerateMultiplier",2);let tt=mt;const hc=.002;class lc{constructor(t,e,s){a(this,"entity");a(this,"category",R.Unknown);a(this,"renderData",{});a(this,"time",0);a(this,"travelTime");this.tile=t,this.target=e,this.damage=s,this.entity=new at(t.getX()+.5,t.getY()+.5,this);const n=t.getX()-e.getX(),r=t.getY()-e.getY(),o=Math.sqrt(n*n+r*r);this.travelTime=o/hc,this.time=this.travelTime/4,this.entity.lookAt(e)}tick(t){this.time>=this.travelTime&&(u.Instance.getSurface().despawn(this),[...u.Instance.getSurface().getEntitiesForCategory(R.Enemy)].filter(s=>la.call(this,s.getAgent(),1)).forEach(s=>{s.getAgent().AI.hit(this.damage)})),this.time=Math.min(this.time+t,this.travelTime);const e=this.time/this.travelTime;this.entity.setX(Yt(this.tile.getX(),this.target.getX(),e)+.5),this.entity.setY(Yt(this.tile.getY(),this.target.getY(),e)+.5)}getType(){return c.Shockwave}getTile(){return this.tile}isVisible(){return!0}}const uc=1e3,dc=200,gc=[[0,0],[1,0],[1,1],[0,1]],pc=[[[-1,0],[-1,-1],[0,-1]],[[0,-1],[1,-1],[1,0]],[[1,0],[1,1],[0,1]],[[0,1],[-1,1],[-1,0]]];var As;let ii=(As=class{constructor(t){a(this,"entity");a(this,"category",R.Player);a(this,"hp",30);a(this,"invincibleTime",0);a(this,"renderData",{});a(this,"baseParts",new Set);a(this,"basePartsByType",new Map);this.tile=t,this.entity=new W(t.getX(),t.getY(),this),this.baseParts.add(this)}tick(t){this.invincibleTime=Math.max(0,this.invincibleTime-t)}getType(){return c.Base}getTile(){return this.tile}updateTile(t){this.tile=t}getHp(){return this.hp}spawn(){it.Instance.registerAgent(this),Oe(this,4)}despawn(){it.Instance.removeAgent(this)}hit(t){this.invincibleTime>0||this.hp<=0||(this.hp-=t,this.hp<=0?(u.Instance.showMessage("You lose!",{closable:!1,expires:0}),u.Instance.getSurface().forceRerender(),B.Instance.triggerEvent(E.Lose)):(this.invincibleTime=uc,this.shockwave()),u.Instance.triggerStatUpdate(),B.Instance.triggerEvent(E.HitBase))}regenerate(t=1){this.hp+=this.getRegenerationFactor()*t}isVisible(){return!0}isDestroyed(){return this.hp<=0}addPart(t){this.baseParts.add(t),this.basePartsByType.set(t.getType(),(this.basePartsByType.get(t.getType())??0)+1)}removePart(t){this.baseParts.delete(t),this.basePartsByType.set(t.getType(),this.basePartsByType.get(t.getType())-1)}getParts(){return this.baseParts}getPartsCount(t){return this.basePartsByType.get(t)??0}getRegenerationFactor(){const t=this.getPartsCount(c.Armory),e=this.getPartsCount(c.Barracks);return t*50/(t+25)+e*50/(e+25)}getMoneyFactor(){const t=this.getPartsCount(c.Market);return 1+t*2.5/(t+25)}shockwave(){const t=u.Instance.getSurface(),e=new Map;this.baseParts.forEach(s=>{gc.forEach(([n,r],o)=>{const h=t.getTile(s.getTile().getX()+n,s.getTile().getY()+r);pc[o].forEach(([l,d])=>{const g=t.getTile(s.getTile().getX()+n+l,s.getTile().getY()+r+d);g&&!e.has(g.getHash())&&kr.has(g.getType())&&e.set(g.getHash(),[h,g])})})}),e.forEach(([s,n])=>{const r=new lc(s,n,dc);t.spawn(r)})}},a(As,"scale",2),a(As,"baseEmergencyRepair",15),As);const pa={name:"Fence",description:"A simple fence that land-based enemies have to walk around. If the fence becomes too long however, they will climb over it. Fences are low to towers can shoot over them.",entity:zi,entityType:c.Fence,htmlElement:"🥅"},fa={name:"Wall",description:"A large solid wall that land-based enemies have to walk around. A wall is equivalent to a tower that does not shoot meaning enemies will avoid them but will destroy them if left with no other option.",entity:ga,entityType:c.Wall,htmlElement:"🚧"},fc={name:"Electric fence",description:"Electric fences are similar to their normal counterpart but enemies are far less likely to climb over them. If they do they will also continuously receive damage, given that you have enough power stored.",entity:Ys,entityType:c.ElectricFence,htmlElement:"⚡"},ma={name:"Tar",description:"A large area of sticky goo that slows down land-based enemies that walk over it. The area does not repel or attract enemies so they still have to be guided to walk over it.",entity:Gi,entityType:c.Freezer,htmlElement:"🦠"},Ji={name:"Tower",description:"The cheapest and most basic tower. It has poor range and deals little damage.",entity:da,entityType:c.Tower,htmlElement:"🗼"},ya={name:"Mortar",description:"A powerful tower with a large range that can shoot over obstacles. It also deals splash damage, hurting all enemies near the impact. Reload speed and travel time of the projectile is slow though.",entity:$s,entityType:c.Mortar,htmlElement:"🛰️"},wa={name:"Flamethrower",description:"A turret intended for close range combat. It continuously hurts a single enemy within range. Enemies that were lit on fire will also keep burning for a while.",entity:Fs,entityType:c.Flamethrower,htmlElement:"🧯"},va={name:"Railgun",description:"A powerful tower with a large range that can pierce enemies. It shoots relatively fast and deals massive damage to an enemy and all enemies behind it at the cost of consuming power.",entity:Xs,entityType:c.Railgun,htmlElement:"🌡️"},Pe={name:"Sell",description:"Sell parts or blueprints. Blueprints and parts placed before the start of a wave are fully refunded. Other parts give back half their original cost when sold, but this can be improved by placing markets.",entityType:c.None,htmlElement:"❌"},Sa={name:"Radar",description:"A part of your base that exposes a large area in the direction that it was placed in. Exposed enemy bases are immediately neutralized when exposed by a radar.",entity:Ki,entityType:c.Radar,htmlElement:"📡",isBasePart:!0},Ea={name:"Power plant",description:"A part of your base that generates an amount power at the start of every wave. Power can be stored across waves and is consumed by various towers. More power plants will generate more power but there are diminishing returns.",entity:Wi,entityType:c.PowerPlant,htmlElement:"🏭",isBasePart:!0},mc={name:"Armory",description:"A part of your base that regenerates hit points at the end of every wave. More armories will regenerate more hit points but there are diminishing returns.",entity:Ui,entityType:c.Armory,htmlElement:"🏰",isBasePart:!0},ba={name:"Barracks",description:"A part of your base mainly intended for being able to place more turrets. It also regenerates a bit of hit points at the end of every wave. More barracks will regenerate more hit points but there are diminishing returns.",entity:Qi,entityType:c.Barracks,htmlElement:"🏰",isBasePart:!0},Ia={name:"Market",description:"A part of your base that increases the amount of money you get per wave and increases the percentage you get back when selling a part. More markets will increase the multiplier but there are diminishing returns.",entity:Hi,entityType:c.Market,htmlElement:"🏪",isBasePart:!0},Ma={name:"Speed Beacon",description:"A building that increases the reload speed of cardinally adjacent towers at the cost of some power for every shot fired. If there is no power (left) the towers will continue working as normal without a speed boost. Keep in mind that the beacon also blocks tower sight lines.",entity:ls,entityType:c.SpeedBeacon,htmlElement:"⏰"},xa={name:"Damage Beacon",description:"A building that increases the damage of cardinally adjacent towers at the cost of some power for every shot fired. If there is no power (left) the towers will continue working as normal without a damage boost. Keep in mind that the beacon also blocks tower sight lines.",entity:hs,entityType:c.DamageBeacon,htmlElement:"🚨"},Ca={name:"Laser",description:"A reasonably powerful tower that lights enemies on fire, similar to the flamethrower. It has a larger range but consumes power in order to fire.",entity:Us,entityType:c.Laser,htmlElement:"🔭"},Ta={name:"Tesla",description:"A tower that starts charging when an enemy comes near and then damages and stuns all enemies within its range.",entity:zs,entityType:c.Tesla,htmlElement:"💡"},yc={name:"Excavator",description:"Allows building over trees and rocks.",entityType:c.Excavator,htmlElement:"🚜",cost:1},wc={name:"Terraform",description:"Allows building over water, ice and enemy structures. Keep in mind a stone foundation is also built which replaces the original surface.",entityType:c.Terraform,htmlElement:"🏗️",cost:1},ka=100,vc={name:"Convert",description:`Convert a wave point in a flat ${ka} gold.`,entityType:c.Convert,htmlElement:"🪙",isRepeatable:!0,cost:1},Gs=1.5,Sc={name:"Emerg. recharge",description:`Generate power ${tt.baseEmergencyRegenerate} power + ${tt.emergencyRegenerateMultiplier} power for every base tile built. This can also be done during a wave, but doing it between waves is ${Gs} as efficient.`,entityType:c.EmergencyRecharge,htmlElement:"🔌",isRepeatable:!0,cost:1},Ec={name:"Emerg. repair",description:`Regenerate ${ii.baseEmergencyRepair} health + 1 health for every base tile built. This can also be done during a wave, but doing it between waves is ${Gs} as efficient.`,entityType:c.EmergencyRepair,htmlElement:"🛠",isRepeatable:!0,cost:1};var tn=(i=>(i.Construction="Construction",i.Defensive="Defensive buildings",i.BasicBuildings="Basic buildings",i.PoweredBuildings="Powered Buildings",i.BaseBuildings="Base Buildings",i.WildcardBuildings="Wildcard Buildings",i.Abilities="Abilities",i))(tn||{});const Aa={Construction:[Pe,yc,wc],"Defensive buildings":[pa,fa,Ta],"Basic buildings":[Ji,wa,ya],"Powered Buildings":[Ea,Ca,va],"Base Buildings":[ba,Sa,Ia],"Wildcard Buildings":[ma,Ma,xa],Abilities:[vc,Sc,Ec]},bc=[Pe,pa,fa,fc,ma,Ji,ya,wa,va,Sa,Ea,mc,Ia,Ma,xa,Ca,ba,Ta],wn=new Set(bc.map(i=>i.entityType));let xi=class{constructor(t,e,s){a(this,"entity");a(this,"category",R.Player);a(this,"renderData",{});this.tile=t,this.placeable=e,this.scaleOverride=s,this.entity=new at(t.getX(),t.getY(),this)}getType(){return c.Blueprint}getTile(){return this.tile}isVisible(){return!0}getPlaceable(){return this.placeable}getScale(){var t;return((t=this.placeable.entity)==null?void 0:t.scale)||this.scaleOverride||1}isDelete(){return this.placeable.entityType===c.None}isBasePart(){return!!this.placeable.isBasePart}};const Ic=i=>i.getType()===c.Blueprint,xs=(i,t,e,s)=>{const n=e.getTile(),r=new Set([n]),o=s.getAdjacentTiles(n,2);for(;o.length>0;){const h=o.pop();i.has(h)||r.has(h)||!t.has(h)&&(!h.hasStaticEntity()||!e.getParts().has(h.getStaticEntity().getAgent()))||(r.add(h),s.getAdjacentTiles(h,2).forEach(l=>o.push(l)))}return r.size===e.getParts().size+t.size-i.size},Mc=(i,t,e,s=!1)=>{const n=new Set([i]),r=t.getAdjacentTiles(i,2,s);for(;r.length>0;){const o=r.pop();n.has(o)||!o.hasStaticEntity()||!e.has(o.getStaticEntity().getAgent().getType())||(n.add(o),t.getAdjacentTiles(o,2,s).forEach(h=>r.push(h)))}return n.size},Be={[c.Fence]:1,[c.Wall]:3,[c.ElectricFence]:9,[c.Freezer]:6,[c.Tower]:12,[c.Flamethrower]:18,[c.Mortar]:40,[c.Railgun]:60,[c.Radar]:20,[c.PowerPlant]:20,[c.Armory]:50,[c.Market]:30,[c.SpeedBeacon]:50,[c.DamageBeacon]:40,[c.Laser]:25,[c.Barracks]:15,[c.Tesla]:50},St=class St{constructor(t=0,e=()=>1){a(this,"recentlyBought",new Set);a(this,"removeUnlockEventListener");this.money=t,this.multiplier=e,St.instance&&St.instance.removeUnlockEventListener(),St.instance=this,this.removeUnlockEventListener=B.Instance.addEventListener(E.Unlock,({placeable:s})=>{s.entityType===c.Convert&&(this.addMoney(ka),u.Instance.triggerStatUpdate())})}setMoney(t){this.money=t}addMoney(t){this.money+=t}addWaveBudget(t){this.addMoney(Math.ceil((St.waveBudget+St.waveBudget*t/3)*this.multiplier()))}buy(t){if(u.Instance.getDifficulty()===N.Practice)return;let e=t.getType();Ic(t)&&(e=t.getPlaceable().entityType);const s=Be[e]??0;if(s>this.money)throw new Error("Not enough money!");this.money-=s,this.recentlyBought.add(t)}replaceBlueprint(t,e){this.recentlyBought.has(t)&&(this.recentlyBought.delete(t),this.recentlyBought.add(e))}sell(t){u.Instance.getDifficulty()!==N.Practice&&(t instanceof xi?this.addMoney(Be[t.getPlaceable().entityType]??0):this.addMoney(this.getValue(t)))}getMoney(){return this.money}getMultiplier(){return this.multiplier()}clearRecents(){this.recentlyBought.clear()}isRecent(t){return this.recentlyBought.has(t)}getValue(t){const e=Math.min(.9,St.sellMultiplier*u.Instance.getBase().getMoneyFactor()),s=Be[t.getType()]??0;return Math.ceil(s*(this.recentlyBought.has(t)?1:e))}serialize(){return{money:this.money}}static get Instance(){return this.instance}static deserialize(t,e){return new St(e.money===null?Number.POSITIVE_INFINITY:e.money,t)}};a(St,"waveBudget",20),a(St,"sellMultiplier",.5),a(St,"instance");let Z=St;const Je=class Je{constructor(){a(this,"unlockedTowers");a(this,"availableUnlocks");a(this,"unlockLinkedMap");a(this,"points",0);a(this,"unlockedAmount",0);Je.instance=this,this.unlockedTowers=new Set,this.availableUnlocks=new Set,this.unlockLinkedMap=new Map,Object.values(tn).forEach(t=>{const e=Aa[t];e.forEach((s,n)=>{if(n===0){this.unlockedTowers.add(s.entityType),s.isRepeatable&&this.availableUnlocks.add(s.entityType);return}this.unlockedTowers.has(e[n-1].entityType)&&(this.availableUnlocks.add(s.entityType),s.isRepeatable&&this.unlockedTowers.add(s.entityType)),e.length>n+1&&this.unlockLinkedMap.set(s.entityType,e[n+1])})})}addPoints(t=1){this.points+=t}getPoints(){return this.points}canUnlock(t){return this.availableUnlocks.has(t.entityType)&&this.points>=(t.cost??1)}isUnlocked(t){return this.unlockedTowers.has(t.entityType)}getUnlockAmount(){return this.unlockedAmount}unlock(t){if(!this.canUnlock(t))throw new Error(`Can't unlock ${t.entityType}`);this.points-=t.cost??1,this.makeAvailable(t),B.Instance.triggerEvent(E.Unlock,{placeable:t})}serialize(){return{points:this.points,unlockedAmount:this.unlockedAmount,unlockedTowers:[...this.unlockedTowers],availableUnlocks:[...this.availableUnlocks]}}makeAvailable(t){t.isRepeatable||(this.unlockedTowers.add(t.entityType),this.availableUnlocks.delete(t.entityType),this.unlockedAmount++);const e=this.unlockLinkedMap.get(t.entityType);e&&(this.availableUnlocks.add(e.entityType),e.isRepeatable&&this.makeAvailable(e))}static get Instance(){return this.instance}static deserialize(t){const e=new Je;e.points=t.points,e.unlockedAmount=t.unlockedAmount,e.availableUnlocks=new Set(t.availableUnlocks),e.unlockedTowers=new Set(t.unlockedTowers)}};a(Je,"instance");let Ot=Je;const j=class j{constructor(t){a(this,"blueprints",new Map);a(this,"pendingBaseAdditions",[]);a(this,"pendingBaseRemovals",[]);a(this,"freeTiles");a(this,"ignoredEntities");a(this,"clearableEntities");a(this,"removeUnlockEventListener");this.surface=t,j.instance&&j.instance.removeUnlockEventListener(),j.instance=this,this.freeTiles=new Set(Ni),this.ignoredEntities=new Set,this.clearableEntities=new Set(wn),this.removeUnlockEventListener=B.Instance.addEventListener(E.Unlock,({placeable:e})=>{e.entityType===c.Excavator&&(this.ignoredEntities.add(c.Tree),this.ignoredEntities.add(c.Pine),this.ignoredEntities.add(c.Cactus),this.ignoredEntities.add(c.Rock),this.ignoredEntities.add(c.Rock2),this.ignoredEntities.add(c.Rock3),this.ignoredEntities.add(c.Stump),this.clearableEntities.add(c.Tree),this.clearableEntities.add(c.Pine),this.clearableEntities.add(c.Cactus),this.clearableEntities.add(c.Rock),this.clearableEntities.add(c.Rock2),this.clearableEntities.add(c.Rock3),this.clearableEntities.add(c.Stump)),e.entityType===c.Terraform&&(this.freeTiles.add(f.Water),this.freeTiles.add(f.Ice),this.freeTiles.add(f.Spore),this.freeTiles.add(f.Bridge))})}getMaxTowers(){return 1+(u.Instance.getBase().getParts().size+1)*j.towersPerPart}build(t,e){if(e.entityType===c.None||e.entityType===c.Excavator){u.Instance.getIsStarted()?this.sellBlueprints(t):this.sellEntities(t);return}if(!u.Instance.getIsStarted()&&e.entityType===c.Terraform&&Ot.Instance.isUnlocked(e)){const s=t.map(n=>{var o;const r=(o=n.getStaticEntity())==null?void 0:o.getAgent();return r&&r.category!==R.Player&&(u.Instance.getSurface().despawnStatic(r),r.getType()===c.Tree&&(r.renderData.chopped=!0)),new et(n.getX(),n.getY(),f.Stone)});u.Instance.getSurface().setTiles(s);return}!wn.has(e.entityType)||!Ot.Instance.isUnlocked(e)||(u.Instance.getIsStarted()?this.placeBlueprints(t,e):this.placeEntities(t,e))}commit(){const t=[];this.blueprints.forEach(e=>{const s=e.getTile(),n=this.surface.getEntityTiles(s.getX(),s.getY(),e.getScale());if(this.surface.despawn(e),n.forEach(h=>{if(!h.hasStaticEntity())return;const l=h.getStaticEntity().getAgent();Z.Instance.sell(l),this.surface.despawnStatic(l),l.getType()===c.Tree&&(l.renderData.chopped=!0)}),e.isDelete())return;const r=e.getPlaceable().entity,o=new r(s);this.spawn(o),Z.Instance.replaceBlueprint(e,o),t.push(s)}),this.pendingBaseAdditions=[],this.pendingBaseRemovals=[],this.blueprints.size!==0&&(this.blueprints.clear(),u.Instance.triggerStatUpdate(),t.length>0&&B.Instance.triggerEvent(E.Buy,{tiles:t}))}getPendingTiles(t,e=!1){const s=new Set(this.pendingBaseAdditions.map(o=>this.surface.getTile(o.entity.getAlignedX(),o.entity.getAlignedY()))),n=new Set(this.pendingBaseRemovals.map(o=>this.surface.getTile(o.entity.getAlignedX(),o.entity.getAlignedY())));let r=o=>{s.delete(o)||n.delete(o)||n.add(o)};return t.forEach(o=>{if(e){r(o);return}const h=this.blueprints.get(o.getHash());if(h){if(h.isDelete()){n.delete(o);return}s.add(o);return}s.add(o)}),{pendingBaseAdditions:s,pendingBaseRemovals:n}}serialize(){return{freeTiles:[...this.freeTiles],ignoredEntities:[...this.ignoredEntities],clearableEntities:[...this.clearableEntities]}}placeBlueprints(t,e){const s=t.filter(n=>this.checkIsFree(n,e.entity.scale,!0));if(e.isBasePart){const{pendingBaseAdditions:n,pendingBaseRemovals:r}=this.getPendingTiles(t);if(!xs(r,n,u.Instance.getBase(),this.surface)){u.Instance.showMessage("Not all tiles connect to the base");return}}s.length===0||!u.Instance.canBuy(e,s.length)||(s.forEach(n=>{this.surface.getEntityTiles(n.getX(),n.getY(),e.entity.scale).forEach(h=>{const l=this.blueprints.get(h.getHash());l&&(Z.Instance.sell(l),this.freeBlueprint(l),l.isBasePart()?this.pendingBaseAdditions.splice(this.pendingBaseAdditions.indexOf(l),1):h.hasStaticEntity()&&j.baseParts.has(h.getStaticEntity().getAgent().getType())&&this.pendingBaseRemovals.splice(this.pendingBaseRemovals.indexOf(l),1),l.isDelete()&&h.hasStaticEntity()&&j.baseParts.has(h.getStaticEntity().getAgent().getType())&&this.pendingBaseRemovals.splice(this.pendingBaseRemovals.indexOf(l),1))});const o=new xi(n,e);Z.Instance.buy(o),this.reserveBlueprint(o),e.isBasePart&&(!n.hasStaticEntity()||!j.baseParts.has(n.getStaticEntity().getAgent().getType()))&&this.pendingBaseAdditions.push(o)}),u.Instance.triggerStatUpdate())}sellBlueprints(t){const e=t.find(o=>this.blueprints.has(o.getHash()));let s=t.filter(o=>e?!!this.blueprints.has(o.getHash()):!!(o.hasStaticEntity()&&this.clearableEntities.has(o.getStaticEntity().getAgent().getType())));const{baseTiles:n,otherTiles:r}=this.splitTiles(s);if(n.length){const{pendingBaseAdditions:o,pendingBaseRemovals:h}=this.getPendingTiles(n,!0);xs(h,o,u.Instance.getBase(),this.surface)||(s=r,u.Instance.showMessage("Not all base parts can be sold"))}s.length!==0&&(s.forEach(o=>{if(e){const h=this.blueprints.get(o.getHash());h&&(h.isDelete()||(Z.Instance.sell(h),o.hasStaticEntity()&&j.baseParts.has(o.getStaticEntity().getAgent().getType())&&this.pendingBaseRemovals.splice(this.pendingBaseRemovals.indexOf(h),1)),h.isBasePart()&&(!o.hasStaticEntity()||!j.baseParts.has(o.getStaticEntity().getAgent().getType()))&&this.pendingBaseAdditions.splice(this.pendingBaseAdditions.indexOf(h),1),this.freeBlueprint(h),o.hasStaticEntity()&&j.baseParts.has(o.getStaticEntity().getAgent().getType())&&this.pendingBaseRemovals.splice(this.pendingBaseRemovals.indexOf(h),1));return}if(o.hasStaticEntity()&&!this.blueprints.get(o.getHash())){const h=o.getStaticEntity().getAgent(),l=new xi(h.getTile(),Pe,zt(h));this.reserveBlueprint(l),j.baseParts.has(h.getType())&&this.pendingBaseRemovals.push(l)}}),u.Instance.triggerStatUpdate())}placeEntities(t,e){if(e.entity.range>1&&this.surface.getTowers().size>=this.getMaxTowers()){u.Instance.showMessage("The base needs to be extended to support additional towers");return}const n=t.filter(r=>this.checkIsFree(r,e.entity.scale));if(e.isBasePart&&!xs(new Set,new Set(n),u.Instance.getBase(),this.surface)){u.Instance.showMessage("Not all tiles connect to the base");return}n.length===0||!u.Instance.canBuy(e,n.length)||(n.forEach(r=>{const o=new e.entity(r);this.surface.getEntityTiles(o).forEach(h=>{if(h.hasStaticEntity()){const l=h.getStaticEntity().getAgent();l.getType()===c.Tree&&(l.renderData.chopped=!0),this.surface.despawnStatic(l)}}),this.spawn(o),Z.Instance.buy(o)}),u.Instance.triggerStatUpdate(),B.Instance.triggerEvent(E.Buy,{tiles:n}))}sellEntities(t){let e=t.filter(r=>!!(r.hasStaticEntity()&&this.clearableEntities.has(r.getStaticEntity().getAgent().getType())));const{baseTiles:s,otherTiles:n}=this.splitTiles(e);if(s.length){const{pendingBaseAdditions:r,pendingBaseRemovals:o}=this.getPendingTiles(s,!0);xs(o,r,u.Instance.getBase(),this.surface)||(e=n,u.Instance.showMessage("Not all base parts can be sold"))}e.length!==0&&(e.forEach(r=>{if(r.hasStaticEntity()){const o=r.getStaticEntity().getAgent();this.surface.despawnStatic(o),Z.Instance.sell(o),(o.getType()===c.Tree||o.getType()===c.Pine)&&(o.renderData.chopped=!0)}}),u.Instance.triggerStatUpdate(),B.Instance.triggerEvent(E.Sell))}splitTiles(t){const e=new Set,s=[];return t.forEach(n=>{const r=this.blueprints.get(n.getHash());if(r&&r.isBasePart()){e.add(r.getTile());return}n.hasStaticEntity()&&j.baseParts.has(n.getStaticEntity().getAgent().getType())?e.add(n.getStaticEntity().getAgent().getTile()):s.push(n)}),{baseTiles:[...e],otherTiles:s}}checkIsFree(t,e,s=!1){return!this.surface.getEntityTiles(t.getX(),t.getY(),e).find(r=>{if(!this.freeTiles.has(r.getBaseType())||r.hasStaticEntity()&&!this.ignoredEntities.has(r.getStaticEntity().getAgent().getType())&&(!s||!this.clearableEntities.has(r.getStaticEntity().getAgent().getType())))return!0})}reserveBlueprint(t){this.surface.spawn(t);const e=t.getTile();this.surface.getEntityTiles(e.getX(),e.getY(),t.getScale()).forEach(s=>this.blueprints.set(s.getHash(),t))}freeBlueprint(t){this.surface.despawn(t);const e=t.getTile();this.surface.getEntityTiles(e.getX(),e.getY(),t.getScale()).forEach(s=>this.blueprints.delete(s.getHash()))}spawn(t){this.surface.getEntityTiles(t).forEach(e=>{j.surfacesRequiringFoundation.has(e.getBaseType())&&this.surface.setTile(new et(e.getX(),e.getY(),f.Stone))}),this.surface.spawnStatic(t)}static get Instance(){return this.instance}static deserialize(t,e){const s=new j(t);return s.freeTiles=new Set(e.freeTiles),s.ignoredEntities=new Set(e.ignoredEntities),s.clearableEntities=new Set(e.clearableEntities),s}};a(j,"instance"),a(j,"towersPerPart",2),a(j,"baseParts",new Set([c.Barracks,c.Armory,c.Radar,c.Market,c.PowerPlant])),a(j,"surfacesRequiringFoundation",new Set([f.Water,f.Ice,f.Spore,f.Bridge]));let pt=j;var ot=(i=>(i.Shift="Shift",i.Control="Control",i.Meta="Meta",i.Plus="+",i.Minus="-",i.Equals="=",i.Up="ArrowUp",i.Left="ArrowLeft",i.Right="ArrowRight",i.Down="ArrowDown",i.Escape="Escape",i.W="w",i.A="a",i.S="s",i.D="d",i.Z="z",i.Q="q",i.B="b",i.E="e",i.F="f",i))(ot||{}),Pa=(i=>(i.Single="single",i.Line="line",i.StraightLine="straightLine",i.grid="grid",i))(Pa||{});const xc=new Set(Object.values(ot));function vn(i){return xc.has(i)}const Ks=class Ks{constructor(){a(this,"mouseDownX",0);a(this,"mouseDownY",0);a(this,"mouseX",0);a(this,"mouseY",0);a(this,"pressedKeys",{});a(this,"touches",0);a(this,"canBuild",!0);a(this,"eventHandlers",new Map);a(this,"surface");a(this,"selectedPlacable",Pe);a(this,"previousSelectedPlacable",Ji);a(this,"buildMenuOpen",!1);a(this,"isPaused",!1);Ks.instance=this}initialize(t){this.surface=t}getPlacable(){return this.selectedPlacable}setPlaceable(t){this.selectedPlacable=t,B.Instance.triggerEvent(E.SelectPlaceable,{placeable:t})}mouseDown(t,e){this.mouseDownX=t,this.mouseDownY=e,this.mouseX=t,this.mouseY=e,this.touches++,this.touches>1&&(this.canBuild=!1)}mouseMove(t,e){this.mouseX=t,this.mouseY=e}getSelection(){var n,r,o,h;if(this.touches===0||!this.canBuild)return[];let t=this.mouseX,e=this.mouseY;if(this.pressedKeys.Control||this.pressedKeys.Meta){let l=[];return this.surface.forRect(this.mouseDownX,this.mouseDownY,t,e,d=>{d.isDiscovered()&&l.push(d)},{scale:((r=(n=this.selectedPlacable)==null?void 0:n.entity)==null?void 0:r.scale)||1}),l}this.pressedKeys.Shift&&(Math.abs(t-this.mouseDownX)>Math.abs(e-this.mouseDownY)?e=this.mouseDownY:t=this.mouseDownX);let s=[];return this.surface.forLine(this.mouseDownX,this.mouseDownY,t,e,l=>{l.isDiscovered()&&s.push(l)},{scale:((h=(o=this.selectedPlacable)==null?void 0:o.entity)==null?void 0:h.scale)||1}),s}mouseUp(t,e,s){if(!this.selectedPlacable){this.touches=Math.max(0,this.touches-1);return}if(this.touches===1)if(this.canBuild){const n=this.getSelection();pt.Instance.build(n,this.selectedPlacable)}else this.canBuild=!0;this.touches--,s&&(this.mouseX=0,this.mouseY=0)}keyDown(t){vn(t)&&(this.pressedKeys[t]=!0)}keyUp(t){var e;if(vn(t)){if(this.pressedKeys[t]=!1,this.isPaused&&t!=="Escape")return;if((e=this.eventHandlers.get(t))==null||e.forEach(s=>s()),(t==="b"||t==="e")&&this.toggleBuildMenu(),t==="f")if(this.selectedPlacable!==Pe)this.previousSelectedPlacable=this.selectedPlacable,this.setPlaceable(Pe);else{const s=this.previousSelectedPlacable;this.previousSelectedPlacable=this.selectedPlacable,this.setPlaceable(s)}}}toggleBuildMenu(){this.buildMenuOpen=!this.buildMenuOpen,this.buildMenuOpen?B.Instance.triggerEvent(E.OpenBuildMenu):(this.touches=0,B.Instance.triggerEvent(E.CloseBuildMenu))}isKeyDown(t){return this.pressedKeys[t]??!1}addKeyListener(t,e){return this.eventHandlers.has(t)?this.eventHandlers.get(t).add(e):this.eventHandlers.set(t,new Set([e])),()=>this.removeKeyListener(t,e)}removeKeyListener(t,e){var s;(s=this.eventHandlers.get(t))==null||s.delete(e)}isMouseDown(){return this.touches>0}getMouse(t){var s,n;const e=t||((n=(s=this.selectedPlacable)==null?void 0:s.entity)==null?void 0:n.scale)||1;return[Math.floor(this.mouseX/e)*e,Math.floor(this.mouseY/e)*e]}getMode(){return this.touches===0?"single":this.pressedKeys.Control||this.pressedKeys.Meta?"grid":this.pressedKeys.Shift?"straightLine":"line"}pause(){this.isPaused=!0}unpause(){this.isPaused=!1}static get Instance(){return this.instance}};a(Ks,"instance");let Qt=Ks;const Hs=(i,t,e)=>new Promise(s=>{const n=B.Instance.addEventListener(t,(...r)=>{(!e||e(...r))&&(n(),s())})}).then(()=>i),Ba=(i,t,e)=>new Promise(s=>{const n=B.Instance.addEventListeners(t,r=>{(!e||e(r))&&(n(),s())})}).then(()=>i),ni=(i,...t)=>e=>Ba(u.Instance.showMessage(i,{override:e,expires:0}),t),Cc=ni("Welcome to Open Tower Defense! Open the build menu by pressing {key: e}. You can also quickly select the most basic tower by pressing {key: f}.",E.OpenBuildMenu,E.StartWave),Tc=i=>new Promise(t=>{if(u.Instance.getIsStarted()){Hs(i,E.EndWave).then(t);return}Hs(u.Instance.showMessage("Here you can choose which defenses to build. Consider picking the basic tower to beat the first wave. More towers can be unlocked later.",{override:i,expires:0}),E.SurfaceChange,({affectedTiles:e})=>!!e.size).then(t)}),kc=i=>new Promise(t=>{const e=u.Instance.getDifficulty();if(e===N.Hard){t(i);return}Ba(u.Instance.showMessage(`If you're new to the game you can click the {icon: Radar} button to view tower sight lines${e===N.Easy||e===N.Practice?" and enemy paths":" "} to check how effective your layout is.`,{override:i,expires:0}),[E.ToggleShowCoverage,E.StartWave]).then(t)}),Ac=i=>new Promise(t=>{if(u.Instance.getIsStarted()){Hs(i,E.EndWave).then(t);return}Hs(u.Instance.showMessage("Start the wave when you are ready. Good luck!",{override:i,expires:0}),E.EndWave).then(t)}),Pc=ni("Good job defeating the first wave! Things will quickly become more difficult from here on out! After every wave your visible radius will increase. When enemy spawn points are discovered they are disabled and you receive points to unlock new technologies.",E.Discover),Bc=ni("You gained wave points by discovering a spawn point! Open the build menu in order to spend it.",E.OpenBuildMenu),Rc=ni("There are both defensive and offensive upgrades, read the descriptions to understand their strengths! You can also trade wave points for bonus abilities.",E.CloseBuildMenu),Sn=[Cc,Tc,kc,Ac,Pc,Bc,Rc];class _c{constructor(){a(this,"promise");a(this,"reject");a(this,"previousId",-1)}async start(){this.promise=new Promise(async(t,e)=>{this.reject=e,await Promise.resolve();for(let s=0;s<Sn.length;s++){const n=Sn[s];try{this.previousId=await Promise.race([n(this.previousId),this.promise])}catch{return}}t(-1)});try{await this.promise}catch{}}stop(){var t;(t=this.reject)==null||t.call(this),this.reject=void 0,this.promise=void 0}get isStarted(){return!!this.promise}}const Bs=(i,t,e)=>{const s=Number(i);return isNaN(s)||t&&s<t?t??0:e&&s>e?e:s},Dc=(i,t)=>i!==""?Bs(t):t,Lc=(i,t)=>t,Yc=(i,t)=>t,Oc=(i,t)=>t;var Rs=(i=>(i[i.Growing=0]="Growing",i[i.Fixed=1]="Fixed",i))(Rs||{});class hi{constructor(t,e=0,s=10){a(this,"size");a(this,"freeEntities",[]);a(this,"usedEntities",new Map);this.initializer=t,this.type=e,this.size=s;for(let n=0;n<s;n++)this.freeEntities.push(t(!1))}get(t){let e=this.usedEntities.get(t);if(e)return e;if(this.freeEntities.length===0){if(this.type===1)throw new Error("Pool is empty");this.size++}return e=this.initializer(!0,this.freeEntities.pop(),t),this.usedEntities.set(t,e),e}free(t){if(!this.usedEntities.has(t))return;let e=this.usedEntities.get(t);return this.usedEntities.delete(t),this.freeEntities.push(e),e}getSize(){return this.size}getUsed(){return this.usedEntities}}const Fc=(i,t,e)=>{const s=t.entity,n=s.getX(),r=s.getY(),o=Math.sqrt((n-t.targetX)**2+(r-t.targetY)**2);e.style.transformOrigin="0 0",e.style.opacity=`${1-.9*(t.time/Zi)}`,e.style.transform=`translate(${n*i.xStep}px, ${r*i.yStep}px) rotate(${s.getRotation()}deg) scale(${o}, 0.1)`},$c=(i,t,e)=>{const s=t.entity;e.style.opacity=`${1-.9*(t.time/Si)}`,e.style.transform=`translate(${(s.getX()+Math.random()*.3-.15)*i.xStep}px, ${(s.getY()+Math.random()*.3-.15)*i.yStep}px) rotate(${-s.getRotation()+180+Math.random()*10-5}deg)`},En=1/4,ze=(i,t,e)=>{const s=t.entity,n=s.getId()%13/26-En,r=(s.getId()+5)%17/34-En,o=i.getTime()%13/3;let h=s.getRotation();t.AI.isAttacking()&&(h+=Math.sin(i.getTime()%st/st*5)*20),t.getStatus()===k.OnFire?(e.style.color="transparent",e.style.textShadow=`${Math.random()-.5}px ${Math.random()-.5}px ${o+2}px #E25822`):t.getStatus()===k.Normal&&(e.style.color="initial",e.style.textShadow="none"),e.style.transform=`translate(${(t.getOffsetX()+n)*i.xStep}px, ${(t.getOffsetY()+r)*i.yStep}px) rotate(${h}deg) scale(${t.getScale()})`},Xc=1/4,Nc=1/8,Uc=.0015,zc=(i,t,e)=>{const s=t.entity,n=Uc*(1+s.getId()%13/13),r=Math.sin((i.getTime()+s.getId())*n)/4-Nc,o=Math.cos((i.getTime()+s.getId())*n)/2-Xc,h=i.getTime()%13/3,l=(s.getRotation()+360)%360,d=l>0&&l<180?-1:1;let g=0;t.AI.isBusy()&&(g+=Math.sin(i.getTime()%st/st*5)*20),t.getStatus()===k.OnFire?(e.style.color="transparent",e.style.textShadow=`${Math.random()-.5}px ${Math.random()-.5}px ${h+2}px #E25822`):t.getStatus()===k.Normal&&(e.style.color="initial",e.style.textShadow="none"),e.style.transform=`translate(${(s.getX()+r)*i.xStep}px, ${(s.getY()+o)*i.yStep}px) rotate(${g}deg) scale(${d},1)`},Gc=(i,t,e)=>{const s=t.entity;e.children[0].textContent=i.getStaticEntityEmoji(t.getPlaceable().entityType),e.style.transformOrigin="0 0",e.style.opacity="0.5",e.style.filter="grayscale(0.6)",e.style.transform=`translate(${s.getX()*i.xStep}px, ${s.getY()*i.yStep}px) rotate(${s.getRotation()}deg) scale(${t.getScale()})`},Hc=(i,t,e)=>{const s=t.entity,n=s.getX(),r=s.getY(),o=Math.sqrt((n-t.targetX)**2+(r-t.targetY)**2);e.style.color="transparent",e.style.textShadow="0 0 0 #E25822",e.style.transformOrigin="0 0",e.style.opacity=`${1-.9*(t.time/Ns)}`,e.style.transform=`translate(${n*i.xStep}px, ${r*i.yStep}px) rotate(${s.getRotation()}deg) scale(${o}, 0.1)`},li=(i,t,e)=>{const s=t.entity;e.style.transform=`translate(${(s.getX()-.5)*i.xStep}px, ${(s.getY()-.5)*i.yStep}px) rotate(${s.getRotation()}deg)`},Wc={[c.Rail]:Fc,[c.Flame]:$c,[c.Slime]:ze,[c.Runner]:ze,[c.Flier]:zc,[c.Tank]:ze,[c.Blueprint]:Gc,[c.LaserBeam]:Hc,[c.Bullet]:li,[c.Rocket]:li,[c.Shockwave]:li,[c.Behemoth]:ze,[c.Bore]:ze},Vc=5e3,jc=J({__name:"Key",props:{char:{},area:{}},setup(i){const t=i,e=t.char>"A"&&t.char<"z";return(s,n)=>(b(),T("div",{class:gt({key:!0,emoji:!P(e)}),style:Ae({gridArea:t.area})},$(t.char),7))}});const lt=(i,t)=>{const e=i.__vccOpts||i;for(const[s,n]of t)e[s]=n;return e},V=lt(jc,[["__scopeId","data-v-8be0d2b3"]]),Kc=J({__name:"mouse",props:{button:{}},setup(i){const t=i;return(e,s)=>(b(),T("div",{class:gt(`mouse button-${t.button}`)},null,2))}});const _s=lt(Kc,[["__scopeId","data-v-135d4a7c"]]);var O=(i=>(i[i.Hammer=0]="Hammer",i[i.Radar=1]="Radar",i[i.Gear=2]="Gear",i[i.Shield=3]="Shield",i[i.Money=4]="Money",i[i.Battery=5]="Battery",i[i.Battle=6]="Battle",i[i.Lock=7]="Lock",i[i.Binoculars=8]="Binoculars",i[i.Pacifier=9]="Pacifier",i[i.Turret=10]="Turret",i[i.Castle=11]="Castle",i[i.Wall=12]="Wall",i[i.Up=13]="Up",i[i.Down=14]="Down",i[i.Recycle=15]="Recycle",i[i.Cross=16]="Cross",i[i.Trophy=17]="Trophy",i))(O||{});const bn=4,In=16,qc=J({__name:"Icon",props:{type:{}},setup(i){const t=i;return(e,s)=>(b(),T("span",{class:"icon",style:Ae({"--row":`-${Math.floor(t.type/bn)*In}px`,"--column":`-${t.type%bn*In}px`})},null,4))}});const Q=lt(qc,[["__scopeId","data-v-48e05fb6"]]),Zc=J({__name:"TextWithControls",props:{text:{}},setup(i){const t=i,e={0:"left",1:"right",3:"middle"},s=_(t.text),n=_(""),r=_(""),o=_("");return hr(()=>t.text,h=>{const d=/^(?<left>.*?)?{(?<control>key|mouse|icon): (?<type>.*?)}(?<right>.*)$/s.exec(h);d?(s.value=d.groups.left,n.value=d.groups.control,r.value=d.groups.type,o.value=d.groups.right):(s.value=h,n.value="",r.value="",o.value="")},{immediate:!0}),(h,l)=>{const d=lr("TextWithControls",!0);return b(),T(ft,null,[F($(s.value)+" ",1),n.value==="key"?(b(),At(V,{key:0,char:r.value},null,8,["char"])):H("",!0),n.value==="mouse"?(b(),At(_s,{key:1,button:e[r.value]},null,8,["button"])):H("",!0),n.value==="icon"?(b(),At(Q,{key:2,type:P(O)[r.value]},null,8,["type"])):H("",!0),o.value?(b(),At(d,{key:3,text:o.value},null,8,["text"])):H("",!0)],64)}}}),Qc={class:"message-wrapper"},Jc={class:"message-inner"},th=["onClick"],eh=J({__name:"SimpleMessage",props:{register:{type:Function}},setup(i){const t=i;let e=1;const s=()=>({id:e++,content:"",closable:!0,open:!1,removing:!1}),n=_([s()]),r=_(new Map),o=Gn(),h=(d,g)=>{let p,v=-1;if(g!=null&&g.override&&(v=n.value.findIndex(M=>M.id===g.override)),v!==-1){const M=n.value[v].id;window.clearTimeout(r.value.get(M)),r.value.delete(M),p=n.value[v]}else p=n.value.at(-1),n.value.push(s());p.closable=(g==null?void 0:g.closable)??!0,p.open=!0,p.content=d;const m=(g==null?void 0:g.expires)??Vc;if(m){const M=window.setTimeout(()=>{l(p)},m);r.value.set(p.id,M)}return Promise.resolve(p.id)},l=d=>{d.open=!1,d.removing=!0,o.proxy.$forceUpdate(),window.setTimeout(()=>{const g=n.value.indexOf(d);g>-1&&n.value.splice(g,1)},700)};return pe(()=>{t.register(h)}),(d,g)=>(b(),T("div",Qc,[(b(!0),T(ft,null,Lt(n.value,p=>(b(),T("div",{key:p.id,class:gt({message:!0,"message--visible":p.open,"message--removing":p.removing})},[y("div",Jc,[p.closable?(b(),T("button",{key:0,class:"close-button",onClick:()=>l(p)},[C(Q,{type:P(O).Cross},null,8,["type"])],8,th)):H("",!0),C(Zc,{text:p.content},null,8,["text"])])],2))),128))]))}});const Ra=lt(eh,[["__scopeId","data-v-1428b9ea"]]),rt=navigator.appVersion.indexOf("Win")!=-1,sh=42,ih=4,nh=20;let Ee=!1,en=class{constructor(t){a(this,"pool");a(this,"selectionPool");a(this,"scaledTilesPool");a(this,"messageFn");a(this,"resolveMessageFn");a(this,"removeEventListeners");a(this,"surface");a(this,"xStep",0);a(this,"yStep",0);a(this,"offsetX",0);a(this,"offsetY",0);a(this,"time",0);a(this,"fontSize",nh);a(this,"hasMoved",!1);a(this,"_showCoverage",!1);a(this,"target",null);a(this,"app");a(this,"appContainer");a(this,"world",null);a(this,"rows",[]);a(this,"alertRanges",[]);a(this,"coverageMap",null);a(this,"coverageRows",[]);a(this,"showMessage",async(...t)=>(await this.messageFn)(...t));a(this,"getEmoji",t=>{const e=Ee||u.Instance.getIsBaseDestroyed();if(t.getDiscoveryStatus()===z.Pending&&!e)return"🔍";if(!t.isDiscovered()&&!e)return"&nbsp;";if(t.hasStaticEntity()&&zt(t.getStaticEntity().getAgent())!==2)return this.getStaticEntityEmoji(t.getStaticEntity().getAgent().getType());switch(t.getBaseType()){case f.Water:return"🟦";case f.Stone:return"⬜";case f.Grass:return"🟩";case f.Spore:return"🟪";case f.Bridge:return"📜";case f.Sand:return"🟨";case f.Snow:return"🌫️";case f.Dirt:return"🟫";case f.Ice:return"🧊";case f.Freezer:return"🦠";default:return"&nbsp;"}});this.controller=t,this.pool=new hi((e,s,n)=>{if(s)return s.style.display="block",s.style.opacity="1",s.style.transformOrigin="50% 50%",s.style.filter="none",s.style.color="initial",s.style.textShadow="none",s.children[0].textContent=this.getEntityEmoji(n),s;const r=document.createElement("span");return r.appendChild(document.createElement("span")),rt&&(r.children[0].style.margin="-0.35ch"),r.children[0].textContent=n?this.getEntityEmoji(n):"",r.style.position="absolute",r.style.top=rt?"-.125ch":"-.075ch",r.style.left=rt?".35ch":"0",r.style.display=e?"block":"none",r.style.willChange="transform",this.world.appendChild(r),r},Rs.Growing,0),this.selectionPool=new hi((e,s)=>{if(s)return s.style.display="block",s;const n=document.createElement("span");return n.appendChild(document.createElement("span")),rt&&(n.children[0].style.margin="-0.35ch"),n.children[0].textContent="🟧",n.style.transformOrigin="0 0",n.style.opacity="0.7",n.style.position="absolute",n.style.top=rt?"-.125ch":"-.075ch",n.style.left=rt?".35ch":"0",n.style.display=e?"block":"none",n.style.willChange="transform",this.world.appendChild(n),n},Rs.Growing,0),this.scaledTilesPool=new hi((e,s,n)=>{if(s)return s.style.display="block",s.children[0].textContent=this.getStaticEntityEmoji(n.getAgent().getType()),s;const r=document.createElement("span");return r.appendChild(document.createElement("span")),rt&&(r.children[0].style.margin="-0.35ch"),r.children[0].textContent=n?this.getStaticEntityEmoji(n.getAgent().getType()):"",r.style.transformOrigin="0 0",r.style.position="absolute",r.style.top=rt?"-.125ch":"-.075ch",r.style.left=rt?".35ch":"0",r.style.display=e?"block":"none",r.style.willChange="transform",this.world.appendChild(r),r},Rs.Growing,0),this.messageFn=new Promise(e=>this.resolveMessageFn=e),window.debug=()=>{Ee=!Ee,this.renderTiles()}}mount(t,e){this.surface=t,this.target=e,this.appContainer=e.appendChild(document.createElement("div")),this.app=Fi(Ra,{register:this.resolveMessageFn}),this.app.mount(this.appContainer),this.world=e.appendChild(document.createElement("div")),this.world.className="scrollable",this.world.style.lineHeight=rt?"1.86ch":"1ch",this.world.style.whiteSpace="nowrap",this.world.style.cursor="crosshair",this.world.style.userSelect="none",this.world.style.position="relative",this.world.style.fontFamily='"Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Android Emoji","EmojiOne Mozilla","Twemoji Mozilla","Noto Emoji","Segoe UI Symbol",EmojiSymbols',this.world.style.backgroundColor="#000",rt&&(this.world.style.letterSpacing="-0.7ch",this.world.style.wordSpacing="2.04ch"),this.renderTiles(),this.zoom();const{width:s,height:n}=this.world.getBoundingClientRect(),r=u.Instance.getBase().getTile();this.world.scrollLeft=r.getX()*this.xStep-s/2,this.world.scrollTop=r.getY()*this.yStep-n/2,this.rerender(0),this.registerEventHandlers(this.world)}zoom(){const t=(this.world.scrollLeft+this.world.clientWidth/2)/this.world.scrollWidth,e=(this.world.scrollTop+this.world.clientHeight/2)/this.world.scrollHeight;this.world.style.fontSize=`${this.fontSize}px`;const{width:s,height:n,x:r,y:o}=this.world.getBoundingClientRect(),h=this.world.scrollWidth,l=this.world.scrollHeight;this.xStep=h/this.surface.getWidth(),this.yStep=l/this.surface.getHeight(),this.offsetX=r,this.offsetY=o,this.world.scrollLeft=t*h-s/2,this.world.scrollTop=e*l-n/2}rerender(t){this.time+=t,this.surface.isDirty()&&this.renderTiles(),(this.surface.isDirty()||this.hasMoved)&&(this.renderStaticAgents(),this.renderAlertRanges());const e=this.surface.getEntities();for(let n of e){const r=Wc[n.getAgent().getType()];if(!this.getEntityEmoji(n)&&!r)continue;const o=this.pool.get(n);o.style.display=n.getAgent().isVisible()?"block":"none",r?r(this,n.getAgent(),o):o.style.transform=`translate(${n.getX()*this.xStep}px, ${n.getY()*this.yStep}px) rotate(${n.getRotation()}deg)`}this.surface.getDeletedEntities().forEach(n=>{const r=this.pool.free(n);r&&(r.style.display="none")}),this.renderSelection(),this.surface.markPristine()}showCoverage(){this._showCoverage=!0,this.renderTiles()}hideCoverage(){this._showCoverage=!1,this.renderTiles()}renderTiles(){const t=this.surface.getHeight();for(let e=0;e<t;e++){let s=this.rows[e];s||(s=document.createElement("div"),rt&&(s.style.letterSpacing="-0.7ch"),this.rows[e]=s,this.world.appendChild(s));const n=this.surface.getRow(e).map(this.getEmoji).join("");s.innerHTML=n}this.renderCoverage()}renderStaticAgents(){const t=this.surface.getEntitiesForCategory(R.Player);for(let s of t){const n=s.getAgent();if(mi(n)&&zt(n)===2){const r=this.scaledTilesPool.get(s);r.style.transform=`translate(${s.getX()*this.xStep}px, ${s.getY()*this.yStep}px) scale(2)`}}this.surface.getDeletedEntities().forEach(s=>{const n=this.scaledTilesPool.free(s);n&&(n.style.display="none")})}async renderCoverage(){const t=Ee||u.Instance.getIsBaseDestroyed(),e=[];K.Instance.getSpawnGroups().forEach(o=>{e.push(o.getAsyncSpawnPoints())});const s=[];if((await Promise.all(e)).forEach(o=>s.push(o[0])),this.coverageMap||(this.coverageMap=document.createElement("div"),this.coverageMap.style.opacity="0.5",this.coverageMap.style.position="absolute",this.coverageMap.style.top="0",this.coverageMap.style.left=rt?"-0.125ch":"0",rt&&(this.coverageMap.style.letterSpacing="-0.7ch",this.coverageMap.style.wordSpacing="2.04ch"),this.world.appendChild(this.coverageMap)),this._showCoverage)this.coverageMap.style.display="block";else{this.coverageMap.style.display="none";return}const n=new Set;(u.Instance.getDifficulty()===N.Easy||u.Instance.getDifficulty()===N.Practice)&&s.forEach(o=>o.getTiles().forEach(h=>n.add(h)));const r=this.surface.getHeight();for(let o=0;o<r;o++){let h=this.coverageRows[o];h||(h=document.createElement("div"),this.coverageRows[o]=h,this.coverageMap.appendChild(h));const l=this.surface.getRow(o).map(d=>{if(!d.isDiscovered()&&!t)return"&nbsp;";const g=d.isCoveredByTower();return n.has(d)?g?"⚔️":"🐾":g?"🎯":"&nbsp;"}).join("");h.innerHTML=l}}renderSelection(){var n,r;const t=this.selectionPool.getUsed();let e=this.controller.getSelection();e.length===1&&(e=[]);const s=((r=(n=this.controller.getPlacable())==null?void 0:n.entity)==null?void 0:r.scale)||1;e.forEach((o,h)=>{const l=t.has(h)?t.get(h):this.selectionPool.get(h);l.style.transform=`translate(${o.getX()*this.xStep}px, ${o.getY()*this.yStep}px) scale(${s})`});for(let o=t.size-1;o>=e.length;o--){const h=this.selectionPool.free(o);h&&(h.style.display="none")}}renderAlertRanges(){const[t,e]=bt(u.Instance.getBase()),s=20*this.xStep,n=20*this.yStep,r=u.Instance.getIsStarted()?[]:K.Instance.getSpawnAlertRanges();r.forEach((o,h)=>{const l=o.getLength(),d=o.getCenter(),g=l/360;let p=this.alertRanges[h];if(!p){this.alertRanges[h]=p=document.createElementNS("http://www.w3.org/2000/svg","svg");const m=document.createElementNS("http://www.w3.org/2000/svg","circle");m.setAttribute("cx","50%"),m.setAttribute("cy","50%"),m.setAttribute("r","45%"),m.setAttribute("stroke","url(#alert)"),m.setAttribute("stroke-linecap","round"),m.setAttribute("fill","none"),p.appendChild(m);const M=document.createElementNS("http://www.w3.org/2000/svg","text");M.setAttribute("text-anchor","middle"),M.setAttribute("dominant-baseline","middle"),M.classList.add("alert"),p.appendChild(M),p.style.position="absolute",p.style.top=rt?"-.125ch":"-.075ch",p.style.left=rt?".35ch":"0",p.style.transformOrigin="50%",this.world.appendChild(p)}p.style.display="block",p.children[0].setAttribute("stroke-width",`${this.fontSize}`),p.children[1].style.transform=`translate(90%, 50%) rotate(-${d}deg)`,p.children[1].setAttribute("direction",d>270||d<90?"rtl":"ltr"),p.children[1].innerHTML="⚠️"+o.getUnits().map(this.getEntityTypeEmoji).join("");const v=s*.9*Math.PI;p.children[0].setAttribute("stroke-dasharray",`${v*g/2} ${v*(1-g)} ${v*g/2} 0`),p.style.width=`${s}px`,p.style.height=`${n}px`,p.style.transform=`translate(${t*this.xStep-s/2}px,${e*this.yStep-n/2}px) rotate(${d}deg)`});for(let o=r.length;o<this.alertRanges.length;o++)this.alertRanges[o].style.display="none"}unmount(){this.app&&(this.app.unmount(),this.target.removeChild(this.appContainer),this.target.removeChild(this.world),this.removeEventListeners(),this.messageFn=new Promise(t=>this.resolveMessageFn=t))}getTime(){return this.time}canMove(t,e){if(Ee||u.Instance.getIsBaseDestroyed())return!0;const n=this.getBBox(),r=it.Instance.getBBox();if(Math.abs(t)>Math.abs(e)){if(t<0&&n[0][0]<=r[0][0]||t>0&&n[1][0]>=r[1][0])return!1}else if(e<0&&n[0][1]<=r[0][1]||e>0&&n[1][1]>=r[1][1])return!1;return!0}registerEventHandlers(t){const e=g=>(g.preventDefault(),!1);t.addEventListener("contextmenu",e);const s=(g,p,v)=>{Ee||u.Instance.getIsBaseDestroyed()||(this.getBBox(),it.Instance.getBBox(),this.canMove(g,p)||v.preventDefault())},n=g=>{s(g.deltaX,g.deltaY,g)};t.addEventListener("wheel",n,{passive:!1});const r=g=>{const p=Math.floor((g.pageX-this.offsetX+this.world.scrollLeft)/this.xStep),v=Math.floor((g.pageY-this.offsetY+this.world.scrollTop)/this.yStep);this.controller.mouseDown(p,v)};t.addEventListener("pointerdown",r);const o=g=>{const p=Math.floor((g.pageX-this.offsetX+this.world.scrollLeft)/this.xStep),v=Math.floor((g.pageY-this.offsetY+this.world.scrollTop)/this.yStep);this.controller.mouseMove(p,v)};t.addEventListener("pointermove",o);const h=g=>{const p=Math.floor((g.pageX-this.offsetX+this.world.scrollLeft)/this.xStep),v=Math.floor((g.pageY-this.offsetY+this.world.scrollTop)/this.yStep);this.controller.mouseUp(p,v,g.pointerType==="touch")};t.addEventListener("pointerup",h);const l=g=>{this.controller.keyDown(g.key),g.preventDefault()};window.addEventListener("keydown",l);const d=g=>{this.controller.keyUp(g.key),g.preventDefault()};window.addEventListener("keyup",d),this.removeEventListeners=()=>{t.removeEventListener("contextmenu",e),t.removeEventListener("wheel",n),t.removeEventListener("pointerdown",r),t.removeEventListener("pointermove",o),t.removeEventListener("pointerup",h),window.removeEventListener("keydown",l),window.removeEventListener("keyup",d)}}move({x:t=0,y:e=0,zoom:s}){(t||e)&&this.canMove(t,e)&&(this.world.scrollLeft+=t*this.fontSize/2,this.world.scrollTop+=e*this.fontSize/2),s&&(s<0?this.fontSize=Math.max(ih,this.fontSize*.9):this.fontSize=Math.min(sh,this.fontSize*1.1),this.zoom(),this.hasMoved=!0)}getStaticEntityEmoji(t){switch(t){case c.Tower:return"🗼";case c.Wall:return"🧱";case c.Mortar:return"🛰️";case c.Flamethrower:return"🧯";case c.Railgun:return"🌡️";case c.ElectricFence:return"⚡";case c.Fence:return"🥅";case c.Freezer:return"🦠";case c.Base:return"⛺";case c.Tree:return"🌳";case c.Pine:return"🌲";case c.Cactus:return"🌵";case c.Stump:return"🪵";case c.Rock:case c.Rock2:case c.Rock3:return"🪨";case c.Radar:return"📡";case c.PowerPlant:return"🏭";case c.None:return"❌";case c.Armory:case c.Barracks:return"🏰";case c.Market:return"🏪";case c.SpeedBeacon:return"⏰";case c.DamageBeacon:return"🚨";case c.Laser:return"🔭";case c.Tesla:return"💡";default:return"❓"}}getEntityEmoji(t){return this.getEntityTypeEmoji(t.getAgent().getType())}getEntityTypeEmoji(t){switch(t){case c.Slime:return"🐞";case c.Bullet:case c.Rocket:return"▪";case c.Rail:case c.LaserBeam:return"⬛";case c.Flame:return"🔥";case c.Shockwave:return"🌀";case c.Runner:return"🪳";case c.Flier:return"🐝";case c.Tank:return"🦀";case c.WavePoint:return"🪙";case c.Spark:return"⚡️";case c.Behemoth:return"🦎";case c.Bore:return"🐙";default:return""}}getBBox(){const t=this.world.scrollTop/this.yStep,e=this.world.scrollLeft/this.xStep,s=this.world.clientHeight/this.yStep,n=this.world.clientWidth/this.xStep;return[[e,t],[e+n,t+s]]}};const ws=new Bt;ws.name="Floor";const ai=new os(void 0,{position:!1},void 0,!0);ai.name="Static";const $t=new Bt;$t.name="Base";const Re=new Bt;Re.name="Foliage";const ye=new Bt;ye.name="Projectiles";const Ft=new Bt;Ft.name="Towers";const te=new Bt;te.name="UI";const Mn=[ws,ai,$t,Re,ye,Ft,te],w=32,xn=20,ah=3,rh=.5,Ci=1,L="atlas";var S=(i=>(i.SporeParticle="atlas5.png",i.ActiveCoverage="atlas1.png",i.Coverage="atlas2.png",i.Alert="atlas3.png",i.Entity="atlas4.png",i.None="atlas0.png",i.Coin="atlas6.png",i.Runner="atlas7.png",i.Regular="atlas8.png",i.Flier="atlas9.png",i.Tank="atlas10.png",i.Behemoth="atlas11.png",i.Bore="atlas12.png",i.Fence="fence-00000000",i.ElectricFence="fence-00000000",i.Wall="wall-00000000",i.Tar="buildings11.png",i.DamageBeacon="buildings5.png",i.SpeedBeacon="buildings6.png",i.Base="buildings0.png",i.Barracks="buildings1.png",i.PowerPlant="buildings2.png",i.Radar="buildings3.png",i.Market="buildings4.png",i.Bullet="projectiles0.png",i.Fire="projectiles1.png",i.Rocket="projectiles2.png",i.Laser="projectiles3.png",i.Rail="projectiles4.png",i.Shockwave="projectiles5.png",i.Pine="foliage0.png",i.Tree="foliage1.png",i.Stump="foliage2.png",i.Cactus="foliage3.png",i.Rock="foliage5.png",i.RockAlt="foliage7.png",i.Lightning="lightning0.png",i.Frame="buildings10.png",i.FrameSpeed="buildings8.png",i.FrameDamage="buildings9.png",i.FrameSpeedDamage="buildings7.png",i.BarracksBlueprint="buildings12.png",i.PowerPlantBlueprint="buildings13.png",i.RadarBlueprint="buildings14.png",i.MarketBlueprint="buildings15.png",i.TowerBlueprint="buildings16.png",i.FlamethrowerBlueprint="buildings17.png",i.LaserBlueprint="buildings18.png",i.MortarBlueprint="buildings19.png",i.RailgunBlueprint="buildings20.png",i.TeslaBlueprint="buildings21.png",i.WallBlueprint="buildings22.png",i.FenceBlueprint="atlas13.png",i))(S||{});const oh="base-1111",ch=new Map([[c.DamageBeacon,S.DamageBeacon],[c.SpeedBeacon,S.SpeedBeacon],[c.Freezer,S.Tar]]);class _a extends G{constructor(t,e){super(e.assets[L].textures[ch.get(t.getType())??oh]),this.data=t}sync(){this.position.set(this.data.entity.getX()*w,this.data.entity.getY()*w),this.angle=this.data.entity.getRotation()}}a(_a,"layer",$t);const Cn=new Map([[c.Armory,[L,S.BarracksBlueprint]],[c.Barracks,[L,S.BarracksBlueprint]],[c.PowerPlant,[L,S.PowerPlantBlueprint]],[c.Radar,[L,S.RadarBlueprint]],[c.Market,[L,S.MarketBlueprint]],[c.DamageBeacon,[L,S.DamageBeacon]],[c.SpeedBeacon,[L,S.SpeedBeacon]],[c.Freezer,[L,S.Tar]],[c.Fence,[L,S.FenceBlueprint]],[c.Wall,[L,S.WallBlueprint]],[c.ElectricFence,[L,S.FenceBlueprint]],[c.Tower,[L,S.TowerBlueprint]],[c.Flamethrower,[L,S.FlamethrowerBlueprint]],[c.Mortar,[L,S.MortarBlueprint]],[c.Laser,[L,S.LaserBlueprint]],[c.Railgun,[L,S.RailgunBlueprint]],[c.Tesla,[L,S.TeslaBlueprint]],[c.None,[L,S.None]]]);class Da extends G{constructor(t,e){const s=t.getPlaceable().entityType;if(!Cn.has(s))throw new Error(`Missing blueprint sprite for ${s}`);const[n,r]=Cn.get(s);super(e.assets[n].textures[r]),this.data=t,s===c.None&&this.scale.set(t.getScale()),this.alpha=.7,this.position.set(this.data.entity.getX()*w,this.data.entity.getY()*w)}sync(){}}a(Da,"layer",Re);const Tn=20;class hh extends G{constructor(){super(...arguments);a(this,"speed",0);a(this,"lifetime",0);a(this,"direction",0)}}class La extends os{constructor(t,e){super(Tn,{position:!0,scale:!0,rotation:!0,alpha:!0}),this.data=t;for(let s=0;s<Tn;s++){const n=new hh(e.assets[L].textures[S.Fire]);n.anchor.set(.5),n.scale.set(1+Math.random()*.3),n.speed=(4+Math.random()*2)*.0017,n.alpha=.8,n.lifetime=Math.floor(Math.random()*25),n.x=this.data.sourceX*w,n.y=this.data.sourceY*w,n.direction=(this.data.entity.getRotation()+20-Math.random()*40)*Math.PI/180,this.addChild(n)}}sync(t){this.children.forEach(e=>{e.x+=Math.sin(e.direction)*e.speed*t*w,e.y+=Math.cos(e.direction)*e.speed*t*w,e.lifetime+=t/16,e.lifetime>25&&(this.data.renderData.update?(e.lifetime=0,e.x=this.data.sourceX*w,e.y=this.data.sourceY*w,e.direction=(this.data.entity.getRotation()+20-Math.random()*40)*Math.PI/180,e.alpha=.8):(e.lifetime=Math.floor(Math.random()*25),e.alpha=0))}),this.data.renderData.update=!1}}a(La,"layer",ye);const lh="explosion",uh=.2;class Ht extends ee{constructor(t,e,s,n=1){super(Object.values(t.assets[lh].textures)),this.anchor.set(.5),this.animationSpeed=uh,this.loop=!1,this.position.set(e*w,s*w),this.scale.set(n),Ft.addChild(this),this.onComplete=()=>{Ft.removeChild(this)},this.play()}}var X=(i=>(i.Notification="notificationSnd",i.Shot="shotSnd",i.Laser="laserSnd",i.Flamethrower="flamethrowerSnd",i.Mortar="mortarSnd",i.Railgun="railgunSnd",i.Explosion="explosionSnd",i.Firework="fireworkSnd",i.Place="placeSnd",i.Destroy="destroySnd",i.Hit="hitSnd",i.Sonar="sonarSnd",i.Thunder="thunderSnd",i.Bush="bushSnd",i.Tank="tankSnd",i.Drill="drillSnd",i.Lock="lockSnd",i.TitleMusic="titleMusic",i.BossMusic="bossMusic",i.FogOfWar="fogOfWar",i.MarchingOnward="marchingOnward",i.ForHonor="forHonor",i.Heroic="heroic",i))(X||{});const Ya={notificationSnd:"/open-td/sounds/notification.mp3",shotSnd:"/open-td/sounds/shot.wav",laserSnd:"/open-td/sounds/laser.mp3",flamethrowerSnd:"/open-td/sounds/flamethrower.wav",mortarSnd:"/open-td/sounds/mortar.wav",railgunSnd:"/open-td/sounds/railgun.mp3",explosionSnd:"/open-td/sounds/explosion.wav",fireworkSnd:"/open-td/sounds/firework.wav",placeSnd:"/open-td/sounds/place.wav",destroySnd:"/open-td/sounds/destroy.wav",hitSnd:"/open-td/sounds/hit.wav",sonarSnd:"/open-td/sounds/sonar.wav",thunderSnd:"/open-td/sounds/thunder.wav",bushSnd:"/open-td/sounds/bush.mp3",tankSnd:"/open-td/sounds/tank.wav",drillSnd:"/open-td/sounds/drill.wav",lockSnd:"/open-td/sounds/lock.mp3"},Oa={titleMusic:"/open-td/music/Title.mp3",bossMusic:"/open-td/music/Boss.mp3",fogOfWar:"/open-td/music/Fog of War.mp3",marchingOnward:"/open-td/music/Marching Onward.mp3",forHonor:"/open-td/music/For Honor.mp3",heroic:"/open-td/music/Heroic.mp3"},Fa=["fogOfWar","marchingOnward","forHonor","heroic"],gs={shotSnd:.7,laserSnd:.5,flamethrowerSnd:.1,mortarSnd:.7,railgunSnd:.7,placeSnd:.7,destroySnd:.7,sonarSnd:.7,thunderSnd:.7,tankSnd:.1,lockSnd:1,notificationSnd:1,fireworkSnd:1,explosionSnd:1,hitSnd:1,bushSnd:1,drillSnd:1,titleMusic:1,bossMusic:1,fogOfWar:1,marchingOnward:1,forHonor:1,heroic:1},$a=(i,t)=>{q.volume(i,gs[i]*t)},dh=(i,t,e)=>B.Instance.addEventListener(i,()=>{q.exists(t)&&q.play(t,e)}),gh=(i,t=.5)=>new Promise(e=>{const s=q.find(i),r=s.volume/t/20,o=window.setInterval(()=>{s.volume-=r,s.volume<=0&&(s.stop(),window.clearInterval(o),e())},50)}),yt=class yt{constructor(t,e,s){a(this,"ref");a(this,"promise");this.alias=t,this.filter=e;const n=q.play(t,{...s,filters:[e],speed:.9+Math.random()/5,complete:()=>yt.soundInstanceCountMap.set(t,yt.soundInstanceCountMap.get(t)-1)});n instanceof Promise?(n.then(r=>this.ref=r),this.promise=n):this.ref=n}static rateLimitSound(t){const e=this.soundInstanceCountMap.get(t)||0,s=this.soundPlaytimeMap.get(t)||0;if(e>this.MAX_INSTANCES)return!0;const n=performance.now();return s+this.MIN_INTERVAL>n?!0:(this.soundInstanceCountMap.set(t,e+1),this.soundPlaytimeMap.set(t,n),!1)}static getSoundOptions(t){const{x:e,y:s,width:n,height:r,scale:o}=ht.Instance.getViewport(),h=(t.getX()*w-e)/(n/2),l=(t.getY()*w-s)/(r/2),d=1/(1+(Math.max(0,Math.abs(h)-1)+Math.max(0,Math.abs(l)-1))*3),g=Math.min(o,Ci)/Ci*d,p=Math.min(1,Math.max(0,Math.abs(h)-.5))*Math.sign(h);return{volume:g,pan:p}}static fromEntity(t,e,s){const{volume:n,pan:r}=yt.getSoundOptions(t);if(!(n<.25*gs[e])&&!this.rateLimitSound(e))return new yt(e,new yr(r),{...s,volume:n})}destroy(){var t;this.ref?(t=this.ref)==null||t.destroy():this.promise.then(e=>e.destroy()),yt.soundInstanceCountMap.set(this.alias,yt.soundInstanceCountMap.get(this.alias)-1)}update(t){if(this.ref){const{volume:e,pan:s}=yt.getSoundOptions(t);this.ref.volume=e,this.filter.pan=s}}fade(t,e=500){return this.ref?(this.ref.volume-=t/e*.8,this.ref.volume<.2*gs[this.alias]?(this.destroy(),!0):!1):!1}};a(yt,"soundInstanceCountMap",new Map),a(yt,"soundPlaytimeMap",new Map),a(yt,"MAX_INSTANCES",3),a(yt,"MIN_INTERVAL",100);let nt=yt;var se=(i=>(i[i.small=8]="small",i[i.medium=16]="medium",i[i.large=32]="large",i))(se||{});const we=i=>{const t=new cs;return t.fill.color=0,t.fill.alpha=.4,t.fill.visible=!0,t.drawCircle(0,0,i),ws.addChild(t),t},ve=i=>{ws.removeChild(i)},ph=.2,fh=1/4,mh=1/8,yh=.0015,ts=class ts extends ee{constructor(e,s){super(Object.values(s.assets[ts.atlas].textures));a(this,"shadow");a(this,"flames",[]);a(this,"oldOffset",0);this.data=e,this.container=s,this.anchor.set(.5),this.animationSpeed=ph,this.shadow=we(se.small),this.play(),this.on("removed",()=>{ve(this.shadow),e.AI.hp<=0&&new Ht(s,e.entity.getX()+.5,e.entity.getY()+.5)})}sync(){const e=yh*(1+this.data.entity.getId()%13/13),s=.5+Math.sin((ht.Instance.getTime()+this.data.entity.getId())*e)/4-mh,n=.5+Math.cos((ht.Instance.getTime()+this.data.entity.getId())*e)/2-fh;if(this.position.set((this.data.entity.getX()+s)*w,(this.data.entity.getY()+n)*w),this.shadow.position.set((this.data.entity.getX()+.5)*w,(this.data.entity.getY()+.5)*w),this.angle=this.data.entity.getRotation(),this.data.AI.isBusy()){const o=this.angle;this.angle+=Math.sin(ht.Instance.getTime()%st/st*5)*20,Math.sign(this.angle)!==Math.sign(o)&&nt.fromEntity(this.data.entity,X.Hit)}if(this.angle=this.data.entity.getRotation(),this.data.AI.isAttacking()){const o=Math.sin(ht.Instance.getTime()%st/st*5)*20;this.angle+=o,Math.sign(o)===1&&Math.sign(this.oldOffset)===-1&&nt.fromEntity(this.data.entity,X.Hit),this.oldOffset=o}else this.oldOffset=0;const r=w/2;if(this.flames.forEach(o=>{o.angle=-this.data.entity.getRotation(),o.position.set(Math.random()*r-r/2,Math.random()*r-r/2)}),this.data.getStatus()===k.OnFire&&!this.flames.length){this.tint=14833698;for(let o=0;o<2;o++){const h=new G(this.container.assets[L].textures[S.Fire]);h.alpha=.8,h.anchor.set(.5),h.position.set(Math.random()*r-r/2,Math.random()*r-r/2),this.addChild(h),this.flames.push(h)}}else this.data.getStatus()!==k.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[])}};a(ts,"layer",Ft),a(ts,"atlas","flier");let Ti=ts;const ui=16;class Xa extends Xi{constructor(e,s){super(s.assets[L].textures[S.Laser],ui,ui);a(this,"tileOffset",0);this.data=e,this.pivot={x:ui/2,y:0}}sync(){this.tilePosition.y=this.tileOffset,this.tileOffset+=.5;const e=this.data.entity.getX(),s=this.data.entity.getY(),n=Math.sqrt((e-this.data.targetX)**2+(s-this.data.targetY)**2);this.height=n*w,this.alpha=Math.min(1,1-this.data.time/Ns+.1),this.position.set(this.data.entity.getX()*w,this.data.entity.getY()*w),this.angle=this.data.entity.getRotation()-90}}a(Xa,"layer",ye);const di=16;class Na extends Xi{constructor(t,e){super(e.assets[L].textures[S.Rail],di,di),this.data=t,this.pivot={x:di/2,y:0}}sync(){const t=this.data.entity.getX(),e=this.data.entity.getY(),s=Math.sqrt((t-this.data.targetX)**2+(e-this.data.targetY)**2);this.height=s*w,this.alpha=Math.min(1,1-this.data.time/Zi+.1),this.position.set(this.data.entity.getX()*w,this.data.entity.getY()*w),this.angle=this.data.entity.getRotation()-90}}a(Na,"layer",ye);const wh=.1,kn=1/4,es=class es extends ee{constructor(e,s){super(Object.values(s.assets[es.atlas].textures));a(this,"shadow");a(this,"flames",[]);a(this,"oldOffset",0);this.data=e,this.container=s,this.anchor.set(.5),this.animationSpeed=wh,this.shadow=we(se.medium),this.on("removed",()=>{ve(this.shadow),e.AI.hp<=0&&new Ht(s,e.entity.getX()+.5,e.entity.getY()+.5)}),this.play()}sync(){const e=.5+this.data.entity.getId()%13/26-kn,s=.5+(this.data.entity.getId()+5)%17/34-kn;if(this.position.set((this.data.entity.getX()+e)*w,(this.data.entity.getY()+s)*w),this.shadow.position.copyFrom(this.position),this.angle=this.data.entity.getRotation(),this.data.AI.isAttacking()){const r=Math.sin(ht.Instance.getTime()%st/st*5)*20;this.angle+=r,Math.sign(r)===1&&Math.sign(this.oldOffset)===-1&&nt.fromEntity(this.data.entity,X.Hit),this.oldOffset=r}this.data.AI.isBusy()===this.playing&&(this.playing?this.stop():(this.play(),this.oldOffset=0));const n=w/2;if(this.flames.forEach(r=>{r.angle=-this.data.entity.getRotation(),r.position.set(Math.random()*n-n/2,Math.random()*n-n/2)}),this.data.getStatus()===k.OnFire&&!this.flames.length){this.tint=14833698;for(let r=0;r<2;r++){const o=new G(this.container.assets[L].textures[S.Fire]);o.alpha=.8,o.anchor.set(.5),o.position.set(Math.random()*n-n/2,Math.random()*n-n/2),this.addChild(o),this.flames.push(o)}}else this.data.getStatus()!==k.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[])}};a(es,"layer",$t),a(es,"atlas","regular");let ki=es;const vh=.1,An=1/4,ss=class ss extends ee{constructor(e,s){super(Object.values(s.assets[ss.atlas].textures));a(this,"shadow");a(this,"flames",[]);a(this,"oldOffset",0);this.data=e,this.container=s,this.anchor.set(.5),this.animationSpeed=vh,this.shadow=we(se.medium),this.on("removed",()=>{ve(this.shadow),e.AI.hp<=0&&new Ht(s,e.entity.getX()+.5,e.entity.getY()+.5)}),this.play()}sync(){const e=.5+this.data.entity.getId()%13/26-An,s=.5+(this.data.entity.getId()+5)%17/34-An;if(this.position.set((this.data.entity.getX()+e)*w,(this.data.entity.getY()+s)*w),this.shadow.position.copyFrom(this.position),this.angle=this.data.entity.getRotation(),this.data.AI.isAttacking()){const r=Math.sin(ht.Instance.getTime()%st/st*5)*20;this.angle+=r,Math.sign(r)===1&&Math.sign(this.oldOffset)===-1&&nt.fromEntity(this.data.entity,X.Hit),this.oldOffset=r}this.data.AI.isBusy()===this.playing&&(this.playing?this.stop():(this.play(),this.oldOffset=0));const n=w/2;if(this.flames.forEach(r=>{r.angle=-this.data.entity.getRotation(),r.position.set(Math.random()*n-n/2,Math.random()*n-n/2)}),this.data.getStatus()===k.OnFire&&!this.flames.length){this.tint=14833698;for(let r=0;r<2;r++){const o=new G(this.container.assets[L].textures[S.Fire]);o.alpha=.8,o.anchor.set(.5),o.position.set(Math.random()*n-n/2,Math.random()*n-n/2),this.addChild(o),this.flames.push(o)}}else this.data.getStatus()!==k.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[])}};a(ss,"layer",$t),a(ss,"atlas","runner");let Ai=ss;const Sh=S.Bullet,Eh=new Map([[c.Bullet,S.Bullet],[c.Flame,S.Fire],[c.Rocket,S.Rocket],[c.Shockwave,S.Shockwave]]);class Ws extends G{constructor(t,e){super(e.assets[L].textures[Eh.get(t.getType())??Sh]),this.data=t,this.pivot={x:8,y:8}}sync(){this.position.set(this.data.entity.getX()*w,this.data.entity.getY()*w),this.angle=this.data.entity.getRotation()}}a(Ws,"layer",ye);const bh=.1,Pn=1/4,is=class is extends ee{constructor(e,s){super(Object.values(s.assets[is.atlas].textures));a(this,"shadow");a(this,"flames",[]);a(this,"oldOffset",0);this.data=e,this.container=s,this.anchor.set(.5),this.animationSpeed=bh,this.shadow=we(se.medium),this.on("removed",()=>{ve(this.shadow),e.AI.hp<=0&&new Ht(s,e.entity.getX()+.5,e.entity.getY()+.5)}),this.play()}sync(){const e=.5+this.data.entity.getId()%13/26-Pn,s=.5+(this.data.entity.getId()+5)%17/34-Pn;if(this.position.set((this.data.entity.getX()+e)*w,(this.data.entity.getY()+s)*w),this.shadow.position.copyFrom(this.position),this.angle=this.data.entity.getRotation(),this.data.AI.isAttacking()){const r=Math.sin(ht.Instance.getTime()%st/st*5)*20;this.angle+=r,Math.sign(r)===1&&Math.sign(this.oldOffset)===-1&&nt.fromEntity(this.data.entity,X.Hit),this.oldOffset=r}this.data.AI.isBusy()===this.playing&&(this.playing?this.stop():(this.play(),this.oldOffset=0));const n=w/2;if(this.flames.forEach(r=>{r.angle=-this.data.entity.getRotation(),r.position.set(Math.random()*n-n/2,Math.random()*n-n/2)}),this.data.getStatus()===k.OnFire&&!this.flames.length){this.tint=14833698;for(let r=0;r<2;r++){const o=new G(this.container.assets[L].textures[S.Fire]);o.alpha=.8,o.anchor.set(.5),o.position.set(Math.random()*n-n/2,Math.random()*n-n/2),this.addChild(o),this.flames.push(o)}}else this.data.getStatus()!==k.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[])}};a(is,"layer",$t),a(is,"atlas","tank");let Pi=is;const Ih=new Map([[c.Tower,"turret"],[c.Flamethrower,"flamethrower"],[c.Laser,"laser"],[c.Mortar,"mortar"],[c.Railgun,"railgun"],[c.Tesla,"tesla"]]),Bn=new Map([[c.Tower,X.Shot],[c.Flamethrower,X.Flamethrower],[c.Laser,X.Laser],[c.Mortar,X.Mortar],[c.Railgun,X.Railgun],[c.Tesla,X.Thunder]]),Mh=new Set([c.Flamethrower,c.Laser]),xh=.1,Ch=.6,Rn=(i,t)=>i?t?S.FrameSpeedDamage:S.FrameSpeed:t?S.FrameDamage:S.Frame;class ae extends G{constructor(e,s){super(s.assets[L].textures[Rn(e.isSpeedBoosted(),e.isDamageBoosted())]);a(this,"turret");a(this,"sound");this.data=e,this.container=s;const[n,r]=bt(e);this.position.set(n*w,r*w),this.pivot={x:w,y:w},this.createTurret(),this.on("removed",()=>{e.renderData.destroyed&&(ht.Instance.shake(),new Ht(s,...bt(e),2)),Ft.removeChild(this.turret),this.sound&&this.sound.destroy()})}createTurret(){const e=Ih.get(this.data.getType());this.turret=new ee(Object.values(this.container.assets[e].textures)),this.turret.position.set(this.x,this.y),this.turret.pivot={x:w,y:w},this.turret.animationSpeed=xh,this.turret.loop=!1,this.turret.onComplete=()=>{this.turret.gotoAndStop(0)},Ft.addChild(this.turret)}sync(e,s){s&&(this.texture=this.container.assets[L].textures[Rn(this.data.isSpeedBoosted(),this.data.isDamageBoosted())]),this.turret.angle=Ho(this.turret.angle,this.data.entity.getRotation(),Ch*e),this.data.renderData.fired?(this.data.renderData.fired=!1,this.turret.play(),Mh.has(this.data.getType())?this.sound?this.sound.update(this.data.entity):this.sound=nt.fromEntity(this.data.entity,Bn.get(this.data.getType()),{loop:!0}):nt.fromEntity(this.data.entity,Bn.get(this.data.getType()))):this.sound&&this.sound.fade(e)&&(this.sound=void 0)}}a(ae,"layer",$t);class Ua extends Ws{constructor(e,s){super(e,s);a(this,"shadow");this.data=e,this.shadow=we(se.small),this.on("removed",()=>{ve(this.shadow),new Ht(s,e.entity.getX(),e.entity.getY(),2),nt.fromEntity(e.entity,X.Explosion)})}sync(){super.sync(),this.shadow.position.set(this.data.entity.getX()*w,this.data.straightY*w);const e=1-Math.abs(this.data.getPercentage()-.5)*.8;this.shadow.scale.set(e)}}a(Ua,"layer",Ft);const _n=75,Dn=1e3;class Th extends G{constructor(){super(...arguments);a(this,"speed",Math.random()*.002)}}var fi;let kh=(fi=class extends Bt{constructor(e,s){super();a(this,"container");a(this,"sprite");a(this,"time",0);if(this.data=e,this.sprite=new G(s.assets[L].textures[S.Coin]),this.sprite.anchor.set(.5),e.amount>1){const n=new G(s.assets[L].textures[S.Coin]);n.anchor.set(.25),this.sprite.addChild(n)}this.container=new os(_n,{alpha:!0});for(let n=0;n<_n;n++){const r=new Th(s.assets[L].textures[S.SporeParticle]),o=n%25/25*Math.PI*2,h=Math.floor(n/25)*.75+.25;r.anchor.set(.5),r.alpha=.9,r.x=(this.data.sourceX+Math.sin(o)*h)*w,r.y=(this.data.sourceY+Math.cos(o)*h)*w,this.container.addChild(r)}this.addChild(this.sprite,this.container),nt.fromEntity(this.data.entity,X.Firework)}sync(e){this.sprite.position.set(this.data.entity.getX()*w,this.data.entity.getY()*w),this.sprite.angle=this.data.entity.getRotation(),this.container.children.forEach((s,n)=>{const r=n%25/25*Math.PI*2;s.x+=Math.sin(r)*s.speed*e*w,s.y+=Math.cos(r)*s.speed*e*w,s.alpha=.9-this.time/Dn*.8}),this.time+=e,this.time>Dn&&this.removeChild(this.container)}},a(fi,"layer",te),fi);const Ln=32,Ah=96;class za extends Bt{constructor(e,s){super();a(this,"sprites",[]);this.data=e;let n=e.entity.getX(),r=e.entity.getY();for(let o of this.data.getChain()){const h=o.entity.getX()+.5,l=o.entity.getY()+.5,d=new Xi(s.assets[L].textures[S.Lightning],Ln,Ah);d.pivot={x:Ln/2,y:0};const g=Math.sqrt((n-h)**2+(r-l)**2);d.height=g*w,d.position.set(n*w,r*w),d.rotation=Math.atan2(r-l,n-h)+Math.PI/2,n=h,r=l,this.addChild(d),this.sprites.push(d)}}sync(){this.alpha=Math.min(1,1-this.data.time/Ii+.1),this.sprites.forEach(e=>e.tilePosition.y=Math.floor(this.data.time/Ii*5)*32)}}a(za,"layer",ye);const ct=class ct extends G{constructor(e,s){super();a(this,"_x");a(this,"_y");a(this,"entityScale");a(this,"prefix");this.container=s,this._x=e.entity.getAlignedX(),this._y=e.entity.getAlignedY(),this.entityScale=zt(e),this.prefix=ct.entityMap.get(e.getType()),this.position.set(this._x*w-ct.padding*this.entityScale,this._y*w-ct.padding*this.entityScale)}sync(e,s){s&&this.updateTexture()}updateTexture(){const e=u.Instance.getSurface(),s=new Array(8);for(let n=0;n<8;n+=2){const r=e.getTile(this._x+ct.neighbors[n][0]*this.entityScale,this._y+ct.neighbors[n][1]*this.entityScale);s[n]=r&&ct.types.has(r.getType())&&zt(r.getStaticEntity().getAgent())===this.entityScale?"1":"0"}for(let n=1;n<8;n+=2){if(s[(n+1)%8]==="1"||s[(n+7)%8]==="1"){s[n]="0";continue}const r=e.getTile(this._x+ct.neighbors[n][0]*this.entityScale,this._y+ct.neighbors[n][1]*this.entityScale);s[n]=r&&ct.types.has(r.getType())&&zt(r.getStaticEntity().getAgent())===this.entityScale?"1":"0"}this.texture=this.container.assets[L].textures[this.prefix+s.join("")]}};a(ct,"layer",ai),a(ct,"entityMap",new Map([[c.Wall,"wall-"],[c.Fence,"fence-"],[c.ElectricFence,"fence-"]])),a(ct,"neighbors",[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]]),a(ct,"padding",4),a(ct,"types",new Set([f.Fence,f.Wall,f.ElectricFence]));let We=ct;const Xt=class Xt extends G{constructor(e,s,n){super(e);a(this,"direction");a(this,"velocity",0);a(this,"bounceForce",10);a(this,"time",0);a(this,"tick",e=>{if(this.time+=e,this.time>Xt.lifetime){Ft.removeChild(this),rn.shared.remove(this.tick);return}this.time>Xt.fadeTime&&(this.alpha=1-(this.time-Xt.fadeTime)/Xt.fadeTime),this.bounceForce>2&&(this.velocity+=this.direction,this.rotation+=this.velocity,(this.rotation>Math.PI/2||this.rotation<-Math.PI/2)&&(this.velocity=-this.direction*this.bounceForce,this.bounceForce/=2))});this.anchor.set(.5,1),this.position.set((s+.5)*w,(n+1)*w),this.direction=Math.sign(Math.random()-.5)/80,this.velocity=0,rn.shared.add(this.tick,void 0,wr.LOW),Ft.addChild(this)}};a(Xt,"lifetime",40),a(Xt,"fadeTime",Xt.lifetime*.8);let Bi=Xt;const ce=class ce extends G{constructor(t,e){super(e.assets[L].textures[ce.entityMap.get(t.getType())[t.renderData.subType||0]]),this.position.set(t.entity.getX()*w,(t.entity.getY()+ce.verticalOffset)*w),this.on("removed",()=>{t.renderData.chopped&&(t.getType()===c.Tree||t.getType()===c.Pine)&&(nt.fromEntity(t.entity,X.Bush),new Bi(this.texture,t.entity.getX(),t.entity.getY()))})}sync(){}};a(ce,"layer",Re),a(ce,"entityMap",new Map([[c.Tree,[S.Tree,S.Pine,S.Cactus]],[c.Pine,[S.Tree,S.Pine,S.Cactus]],[c.Cactus,[S.Tree,S.Pine,S.Cactus]],[c.Stump,[S.Stump]],[c.Rock,[S.Rock,S.RockAlt]],[c.Rock2,[S.Rock,S.RockAlt]],[c.Rock3,[S.Rock,S.RockAlt]]])),a(ce,"verticalOffset",-.5);let Wt=ce;var ue;let Ph=(ue=class extends G{constructor(t,e){super(e.assets[L].textures[S.Stump]),this.position.set(t.entity.getX()*w,(t.entity.getY()+ue.verticalOffset)*w)}sync(){}},a(ue,"layer",ai),a(ue,"verticalOffset",-.5),ue);const Kt=class Kt extends G{constructor(e,s){super();a(this,"_x");a(this,"_y");this.container=s,this._x=e.entity.getAlignedX(),this._y=e.entity.getAlignedY();const n=Kt.entityToAtlasMap.get(e.getType());if(n){const r=new G(this.container.assets[L].textures[n]);r.anchor.set(.5),r.position.set(w,w),this.addChild(r)}this.position.set(this._x*w,this._y*w),this.updateTexture()}sync(e,s){s&&this.updateTexture()}updateTexture(){const e=u.Instance.getSurface();let s="base-";for(let n=0;n<4;n++){const r=e.getTile(this._x+Kt.neighbors[n][0],this._y+Kt.neighbors[n][1]);s+=r!=null&&r.hasStaticEntity()&&fs.has(r.getStaticEntity().getAgent().getType())?"0":"1"}this.texture=this.container.assets[L].textures[s]}};a(Kt,"layer",$t),a(Kt,"neighbors",[[0,-2],[2,0],[0,2],[-2,0]]),a(Kt,"entityToAtlasMap",new Map([[c.Base,S.Base],[c.Armory,S.Barracks],[c.Barracks,S.Barracks],[c.PowerPlant,S.PowerPlant],[c.Radar,S.Radar],[c.Market,S.Market]]));let Ri=Kt;const Bh=.075,Yn=1/4,ns=class ns extends ee{constructor(e,s){super(Object.values(s.assets[ns.atlas].textures));a(this,"shadow");a(this,"flames",[]);a(this,"oldOffset",0);this.data=e,this.container=s,this.anchor.set(.5),this.animationSpeed=Bh,this.shadow=we(se.large),this.scale.set(2),this.on("removed",()=>{ve(this.shadow),e.AI.hp<=0&&new Ht(s,e.entity.getX()+1,e.entity.getY()+1,2)}),this.play()}sync(){const e=1+this.data.entity.getId()%13/26-Yn,s=1+(this.data.entity.getId()+5)%17/34-Yn;if(this.position.set((this.data.entity.getX()+e)*w,(this.data.entity.getY()+s)*w),this.shadow.position.copyFrom(this.position),this.angle=this.data.entity.getRotation(),this.data.AI.isAttacking()){const r=Math.sin(ht.Instance.getTime()%st/st*5)*20;this.angle+=r,Math.sign(r)===1&&Math.sign(this.oldOffset)===-1&&nt.fromEntity(this.data.entity,X.Hit),this.oldOffset=r}this.data.AI.isBusy()===this.playing&&(this.playing?this.stop():(this.play(),this.oldOffset=0));const n=w/2;if(this.flames.forEach(r=>{r.angle=-this.data.entity.getRotation(),r.position.set(Math.random()*n-n/2,Math.random()*n-n/2)}),this.data.getStatus()===k.OnFire&&!this.flames.length){this.tint=14833698;for(let r=0;r<2;r++){const o=new G(this.container.assets[L].textures[S.Fire]);o.alpha=.8,o.anchor.set(.5),o.position.set(Math.random()*n-n/2,Math.random()*n-n/2),this.addChild(o),this.flames.push(o)}}else this.data.getStatus()!==k.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[])}};a(ns,"layer",$t),a(ns,"atlas","runner");let _i=ns;class Rh extends cs{constructor(t){super(),this.enemy=t,this.fill.alpha=.6,this.fill.visible=!0,te.addChild(this)}update(t,e){const s=this.enemy.getScale();this.fill.color=0,this.drawRect(0,0,32*s,6*s),this.fill.color=16711680,this.drawRect(1,1,(32*s-2)*this.enemy.AI.getHpPercent(),6*s-2),this.position.set(t-16*s,e-16*s)}remove(){te.removeChild(this)}}const _h=.075,On=1/4,as=class as extends ee{constructor(e,s){super(Object.values(s.assets[as.atlas].textures));a(this,"shadow");a(this,"flames",[]);a(this,"sound");a(this,"wasAttacking",!1);a(this,"healthBar");this.data=e,this.container=s,this.anchor.set(.5),this.animationSpeed=_h,this.shadow=we(se.large),this.scale.set(2),this.sound=nt.fromEntity(this.data.entity,X.Tank,{loop:!0}),this.on("removed",()=>{var n,r;(n=this.sound)==null||n.destroy(),ve(this.shadow),(r=this.healthBar)==null||r.remove(),e.AI.hp<=0&&new Ht(s,e.entity.getX()+1,e.entity.getY()+1,2)}),this.play()}sync(){var o;this.sound&&this.sound.update(this.data.entity),this.data.AI.isAttacking()&&!this.wasAttacking&&((o=this.sound)==null||o.destroy(),nt.fromEntity(this.data.entity,X.Drill)),!this.data.AI.isAttacking()&&this.wasAttacking&&!u.Instance.getIsBaseDestroyed()&&(this.sound=nt.fromEntity(this.data.entity,X.Tank,{loop:!0})),this.wasAttacking=this.data.AI.isAttacking();const e=this.data.AI.isAttacking()?Math.sin(ht.Instance.getTime()%200/200*5)*.05:0,s=1+this.data.entity.getId()%13/26-On+Math.cos(this.rotation+Math.PI/2)*e,n=1+(this.data.entity.getId()+5)%17/34-On+Math.sin(this.rotation+Math.PI/2)*e;this.position.set((this.data.entity.getX()+s)*w,(this.data.entity.getY()+n)*w),this.shadow.position.copyFrom(this.position),this.angle=this.data.entity.getRotation();const r=w/2;if(this.flames.forEach(h=>{h.angle=-this.data.entity.getRotation(),h.position.set(Math.random()*r-r/2,Math.random()*r-r/2)}),this.data.getStatus()===k.OnFire&&!this.flames.length){this.tint=14833698;for(let h=0;h<2;h++){const l=new G(this.container.assets[L].textures[S.Fire]);l.alpha=.8,l.anchor.set(.5),l.position.set(Math.random()*r-r/2,Math.random()*r-r/2),this.addChild(l),this.flames.push(l)}}else this.data.getStatus()!==k.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[]);this.data.AI.getHpPercent()<1&&(this.healthBar||(this.healthBar=new Rh(this.data)),this.healthBar.update(this.position.x,this.position.y))}};a(as,"layer",$t),a(as,"atlas","bore");let Di=as;const Dh={runner:"/open-td/animations/runner.json",regular:"/open-td/animations/regular.json",flier:"/open-td/animations/flier.json",tank:"/open-td/animations/tank.json",turret:"/open-td/animations/turret.json",flamethrower:"/open-td/animations/flamethrower.json",laser:"/open-td/animations/laser.json",mortar:"/open-td/animations/mortar.json",railgun:"/open-td/animations/railgun.json",explosion:"/open-td/animations/explosion.json",tesla:"/open-td/animations/tesla.json",bore:"/open-td/animations/bore.json"},Lh={[c.Runner]:Ai,[c.Slime]:ki,[c.Flier]:Ti,[c.Tank]:Pi,[c.Behemoth]:_i,[c.Bore]:Di,[c.Tower]:ae,[c.Flamethrower]:ae,[c.Laser]:ae,[c.Mortar]:ae,[c.Railgun]:ae,[c.Bullet]:Ws,[c.Flame]:La,[c.Rocket]:Ua,[c.Shockwave]:Ws,[c.LaserBeam]:Xa,[c.Rail]:Na,[c.Fence]:We,[c.Wall]:We,[c.ElectricFence]:We,[c.Blueprint]:Da,[c.WavePoint]:kh,[c.Spark]:za,[c.Tesla]:ae,[c.Tree]:Wt,[c.Pine]:Wt,[c.Cactus]:Wt,[c.Stump]:Ph,[c.Rock]:Wt,[c.Rock2]:Wt,[c.Rock3]:Wt,[c.Freezer]:null,...[...fs].reduce((i,t)=>({...i,[t]:Ri}),{})};class Yh extends G{constructor(t,e,s){super(s),this.offset=t,this.path=e;const{x:n,y:r}=this.path.getCoordinates(this.offset%this.path.getLength());this.position.set(n*w,r*w)}move(t){this.offset+=t/100/this.path.getScale();const{x:e,y:s}=this.path.getCoordinates(this.offset%this.path.getLength());this.position.set(e*w,s*w)}}class Oh extends G{constructor(){super(...arguments);a(this,"originalAlpha",1)}}class Fh{constructor(t,e){a(this,"coverageContainer");a(this,"pathContainer");a(this,"towers",new Map);a(this,"hoveredTile");a(this,"visible",!1);this.container=t,this.surface=e,this.coverageContainer=new os(void 0,{uvs:!0,alpha:!0},void 0,!0),ws.addChild(this.coverageContainer),this.pathContainer=new os(void 0,{position:!0},void 0,!0),te.addChild(this.pathContainer)}show(){this.visible=!0,this.render()}hide(){this.visible=!1,this.coverageContainer.removeChildren(),this.pathContainer.removeChildren()}render(){this.visible&&(this.renderCoverage(),(u.Instance.getDifficulty()===N.Easy||u.Instance.getDifficulty()===N.Practice)&&!u.Instance.getIsStarted()&&this.renderPaths())}renderCoverage(){this.coverageContainer.removeChildren(),this.towers.clear(),this.hoveredTile=void 0;const t=this.surface.getHeight();for(let e=0;e<t;e++)this.surface.getRow(e).forEach(s=>{const n=s.getTowers();if(n.length===0||!s.isDiscovered())return;const r=new Oh(this.container.assets[L].textures[S.Coverage]);r.originalAlpha=Math.min(.15+.1*n.length,.55),r.alpha=r.originalAlpha,r.position.set(s.getX()*w,s.getY()*w),this.coverageContainer.addChild(r),n.forEach(o=>{const h=this.towers.get(o.getTile().getHash())||[];h.push(r),this.towers.set(o.getTile().getHash(),h)})})}async renderPaths(){this.pathContainer.removeChildren();const t=[];K.Instance.getSpawnGroups().forEach(s=>{t.push(s.getAsyncSpawnPoints())});const e=[];(await Promise.all(t)).forEach(s=>e.push(...s)),e.forEach((s,n)=>{const r=this.slicePath(s),o=Math.max(1,Math.floor(r.getLength()/5));for(let h=0;h<o;h++)this.pathContainer.addChild(new Yh(n*2+h*5,r,this.container.assets[L].textures[S.Entity]))})}slicePath(t){let e,s;for(let n=0;n<t.getLength();n++){const r=t.getTile(n);if(r.isDiscovered()||(e=n+1),r.hasStaticEntity()&&fs.has(r.getStaticEntity().getAgent().getType())){s=n;break}}return t.slice(e,s)}update(t){var r,o;if(!this.visible)return;u.Instance.getIsStarted()?this.pathContainer.removeChildren():this.pathContainer.children.forEach(h=>h.move(t));const[e,s]=Qt.Instance.getMouse(2),n=this.surface.getTile(e,s);n!==this.hoveredTile&&(this.hoveredTile&&((r=this.towers.get(this.hoveredTile.getHash()))==null||r.forEach(h=>{h.texture=this.container.assets[L].textures[S.Coverage],h.alpha=h.originalAlpha})),n&&((o=this.towers.get(n.getHash()))==null||o.forEach(h=>{h.texture=this.container.assets[L].textures[S.ActiveCoverage],h.alpha=.7})),this.hoveredTile=n)}}const qt=class qt{constructor(t){a(this,"container");a(this,"alertSymbols",[]);a(this,"time",0);a(this,"permanent",!1);a(this,"removeEndWaveEventListener");this.assetsContainer=t,this.container=new Bt,te.addChild(this.container),this.removeEndWaveEventListener=B.Instance.addEventListener(E.EndWave,()=>this.reset())}enable(){this.permanent=!0,this.container.alpha=1,this.time=qt.displayDuration}disable(){this.permanent=!1,this.time=qt.displayDuration}reset(){this.time=0,this.container.alpha=1}render(t,e){this.alertSymbols=[],this.container.removeChildren();const[s,n]=t,r=Math.PI/128;e.forEach(o=>{const[h,l]=o.getRange(),d=new Bt,g=new cs;g.lineStyle({width:10,color:16711680,cap:vr.ROUND,alpha:.6,alignment:.5}),g.arc(s*w,n*w,10*w,h*Math.PI/180+r,l*Math.PI/180-r);const p=new G(this.assetsContainer.assets[L].textures[S.Alert]);p.anchor.set(.5),p.scale.set(2),this.alertSymbols.push(p);const v=new Bt,m=o.getCenter(),M=m*Math.PI/180;v.position.set((s+Math.cos(M)*9.2)*w,(n+Math.sin(M)*9.2)*w),v.addChild(p),o.getUnits().forEach((A,I)=>{const Y=new G(this.assetsContainer.assets[L].textures[qt.enemySpriteMap.get(A)]),x=m>270||m<90?-1:1,D=x>0?16:-48;Y.position.set(D+32*I*x,8),v.addChild(Y)}),d.addChild(g,v),this.container.addChild(d)})}update(t,e){this.container.alpha<=0||((e||!this.permanent&&this.time>qt.displayDuration)&&(this.container.alpha-=t/500),this.alertSymbols.forEach(s=>{s.alpha=Math.abs(Math.cos(this.time/300))}),this.time+=t)}unmount(){this.removeEndWaveEventListener()}};a(qt,"displayDuration",20*1e3),a(qt,"enemySpriteMap",new Map([[c.Runner,S.Runner],[c.Slime,S.Regular],[c.Tank,S.Tank],[c.Flier,S.Flier],[c.Behemoth,S.Behemoth],[c.Bore,S.Bore]]));let Li=qt;const $h=`varying vec2 vTextureCoord;
uniform sampler2D uSampler;

uniform vec2 thickness;
uniform vec4 outlineColor;
uniform vec4 filterClamp;

const float DOUBLE_PI = 3.14159265358979323846264 * 2.;

void main(void) {
    vec4 ownColor = texture2D(uSampler, vTextureCoord);
    vec4 curColor;
    float maxAlpha = 0.;
    vec2 displaced;
    for (float angle = 0.; angle <= DOUBLE_PI; angle += \${angleStep}) {
        displaced.x = vTextureCoord.x + thickness.x * cos(angle);
        displaced.y = vTextureCoord.y + thickness.y * sin(angle);
        curColor = texture2D(uSampler, clamp(displaced, filterClamp.xy, filterClamp.zw));
        maxAlpha = max(maxAlpha, curColor.a);
    }
    float resultAlpha = maxAlpha * step(ownColor.a, 0.0) > 0. ? 1. : 0.0;

    gl_FragColor = vec4(outlineColor.rgb * resultAlpha, resultAlpha);
}
`,he=class he extends Sr{constructor(e=1,s=0,n=.1){super(void 0,$h.replace(/\$\{angleStep\}/,he.getAngleStep(n)));a(this,"_thickness",1);this.uniforms.thickness=new Float32Array([0,0]),this.uniforms.outlineColor=new Float32Array([0,0,0,1]),Object.assign(this,{thickness:e,color:s,quality:n})}static getAngleStep(e){if(e===0)return(Math.PI/2).toFixed(7);const s=Math.max(e*he.MAX_SAMPLES,he.MIN_SAMPLES);return(Math.PI*2/s).toFixed(7)}apply(e,s,n,r){this.uniforms.thickness[0]=this._thickness/s._frame.width,this.uniforms.thickness[1]=this._thickness/s._frame.height,e.applyFilter(this,s,n,r)}get color(){return new on(this.uniforms.outlineColor).toNumber()}set color(e){this.uniforms.outlineColor=new on(e).toRgbArray()}get thickness(){return this._thickness}set thickness(e){this._thickness=e,this.padding=e}};a(he,"MIN_SAMPLES",1),a(he,"MAX_SAMPLES",100);let Vs=he;const Xh=Intl.NumberFormat(void 0,{maximumFractionDigits:0});class Nh{constructor(){a(this,"container");a(this,"rangeGraphic");a(this,"text");a(this,"containerFilter");a(this,"oldMousePosition","");a(this,"oldMode",Pa.Line);a(this,"oldPlaceable",null);this.rangeGraphic=new cs,this.rangeGraphic.filters=[new Vs(2,0,0)],this.container=new cs,this.containerFilter=new Vs(2,0,0),this.container.filters=[this.containerFilter],this.text=new Er("",{fontFamily:"JupiterCrash",fontSize:24,fill:0,align:"left",dropShadow:!0,dropShadowColor:16777215,dropShadowDistance:2}),te.addChild(this.rangeGraphic,this.container,this.text)}render(){var g;const t=Qt.Instance,e=t.getMouse(),s=t.getMode(),n=t.getPlacable();if(e.join(",")===this.oldMousePosition&&s===this.oldMode&&n===this.oldPlaceable)return;this.oldMousePosition=e.join(","),this.oldMode=s,this.oldPlaceable=n;const r=w*(((g=n==null?void 0:n.entity)==null?void 0:g.scale)||1);this.rangeGraphic.clear(),this.container.clear(),this.container.fill.visible=!0,this.containerFilter.color=n.entityType===c.None?16711680:0;const o=new Set,h=new Set,l=u.Instance.getSurface();let d;if(n!=null&&n.entity&&(d=n.entity.range),t.isMouseDown())t.getSelection().forEach(p=>{this.container.drawRect(p.getX()*w,p.getY()*w,r,r),d&&l.forCircle(p.getX()+1,p.getY()+1,d,v=>h.add(v)),p.hasStaticEntity()&&o.add(p.getStaticEntity().getAgent())});else{const[p,v]=t.getMouse();this.container.drawRect(p*w,v*w,r,r),d&&l.forCircle(p+1,v+1,d,M=>h.add(M));const m=l.getTile(p,v);m&&m.hasStaticEntity()&&o.add(m.getStaticEntity().getAgent())}this.rangeGraphic.clear().beginFill();for(let p of h)this.rangeGraphic.drawRect(p.getX()*w,p.getY()*w,w,w);if(this.rangeGraphic.endFill(),(n==null?void 0:n.entityType)===c.None){const p=[...o].reduce((v,m)=>v+Z.Instance.getValue(m),0);p>0?this.text.text=`Sell for 🪙 ${Xh.format(p)}`:this.text.text="",this.text.position.set(e[0]*w,e[1]*w-24)}else this.text.text=""}}const Uh={[L]:"/open-td/atlas.json",terrain:"/open-td/tiles/terrain.png",mask:"/open-td/tiles/mask.png"};Vn.addBundle("assets",{...Ya,...Uh,...Dh,...Oa});let Cs;const vs=()=>Cs||(Cs=Vn.loadBundle("assets"),Cs);class zh{constructor(){a(this,"assets");a(this,"callback");vs().then(t=>{this.assets=t,this.callback&&this.callback()})}onComplete(t){if(this.assets){t();return}this.callback=t}get loading(){return this.assets===void 0}}const Ga=`#version 300 es

precision highp float;

in vec2 vTextureCoord;
uniform sampler2D world;
uniform sampler2D atlas;
uniform sampler2D mask;

uniform float tileSize;
uniform bool textured;
uniform bool blended;
uniform float time;

uniform int bridgeId; // Bridges should not get blended

out vec4 fragmentColor;

void main(){
    // Get dimensions of all textures.
	highp ivec2 worldSize = textureSize(world, 0);
    highp ivec2 maskSize = textureSize(mask, 0);
    highp ivec2 atlasSize = textureSize(atlas, 0);

    // Get number of atlas columns and rows.
    int atlasColumns = atlasSize.x / int(tileSize);
    int atlasRows = atlasSize.y / int(tileSize);

    // Get position in world texture.
    float wx = vTextureCoord.x * float(worldSize.x);
    float wy = vTextureCoord.y * float(worldSize.y);
    
    // Get position in mask texture.
    float maskRepeat = float(worldSize.x) * tileSize;

    vec4 maskTexel = vec4(0.5);
    if (blended) {
        int mx = int(floor(vTextureCoord.x * maskRepeat)) % maskSize.x;
        int my = int(floor(vTextureCoord.y * maskRepeat)) % maskSize.y;
        maskTexel = texelFetch(mask, ivec2(mx, my), 0);
    }

    // Get atlas id from word texture: world position + mask offset.
    int x = int(floor(wx + (maskTexel.r - 0.5)));
	int y = int(floor(wy + (maskTexel.g - 0.5)));
	int atlasId = int(texelFetch(world, ivec2(x, y), 0)[int(mod(time + float(x) + float(y), 3.0))] * 255.0);

    int unblentAtlasId = int(texelFetch(world, ivec2(int(floor(wx)), int(floor(wy))), 0)[int(mod(time + float(x) + float(y), 3.0))] * 255.0);

    if (unblentAtlasId == bridgeId) {
        atlasId = unblentAtlasId;
    }

    if (atlasId == bridgeId) {
        atlasId = unblentAtlasId;
    }

    if (!textured) {
         wx = floor(wx / tileSize) * tileSize;
         wy = floor(wy / tileSize) * tileSize;
    }

    // Get position in atlas texture.
    float dx = (mod(wx, 1.0) + float(atlasId % atlasColumns)) / float(atlasColumns);
    float dy = (mod(wy, 1.0) + float(atlasId / atlasColumns)) / float(atlasRows);
    ivec2 atlasPos = ivec2(int(dx * float(atlasSize.x)), int(dy * float(atlasSize.y)));

    fragmentColor = texelFetch(atlas, atlasPos, 0);
}
`,Ha=`#version 300 es
  
precision highp float;

in vec2 aVertexPosition;
in vec2 aTextureCoord;

uniform mat3 projectionMatrix;
uniform mat3 translationMatrix;
uniform mat3 uTextureMatrix;

out vec2 vTextureCoord;

void main(void) 
{
	gl_Position = vec4((projectionMatrix * translationMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);

	vTextureCoord = (uTextureMatrix * vec3(aTextureCoord, 1.0)).xy; 
}
`;class Gh extends jn{constructor(e,s=!0,n=!0){super(Nt.EMPTY,{program:new Kn(Ha,Ga),uniforms:{tileSize:w,bridgeId:f.Bridge,time:0,textured:s,blended:n}});a(this,"canvas");a(this,"context");a(this,"imageData");a(this,"getTileTypes",e=>{switch(e.getDiscoveryStatus()){case z.Discovered:return e.getAnimation();case z.Pending:return[dt.Static1,dt.Static2,dt.Static3];default:return[f.Obstructed]}});this.surface=e,this.canvas=document.createElement("canvas"),this.canvas.width=this.surface.getWidth(),this.canvas.height=this.surface.getHeight(),this.context=this.canvas.getContext("2d"),this.imageData=this.context.createImageData(this.surface.getWidth(),this.surface.getHeight()),this.uniforms.world=Nt.from(this.canvas),this.uniforms.atlas=Nt.from(this.canvas),this.uniforms.mask=Nt.from(this.canvas),vs().then(r=>{this.uniforms.atlas=r.terrain.baseTexture,this.uniforms.mask=r.mask.baseTexture})}render(e=!1){this.surface.getTiles().forEach((s,n)=>{let r=e?s.getAnimation():this.getTileTypes(s);this.imageData.data[n*4]=r[0],this.imageData.data[n*4+1]=r[1]||r[0],this.imageData.data[n*4+2]=r[2]||r[0],this.imageData.data[n*4+3]=255}),this.context.putImageData(this.imageData,0,0),this.uniforms.world.update()}setBlended(e){this.uniforms.blended=e}setTextured(e){this.uniforms.textured=e}setTime(e){this.uniforms.time=e/600}}const Hh=`precision highp float;

varying vec2 vTextureCoord;

uniform sampler2D world;
uniform vec2 worldSize;

uniform sampler2D atlas;
uniform vec2 atlasSize;

uniform sampler2D mask;
uniform vec2 maskSize;

uniform float tileSize;

uniform float time;
uniform float bridgeId; // Bridges should not get blended
 
void main(void) {
    // Get position in mask texture.
    float maskRepeat = float(worldSize.x) * tileSize;
    float mx = mod(floor(vTextureCoord.x * maskRepeat), maskSize.x);
    float my = mod(floor(vTextureCoord.y * maskRepeat), maskSize.y);

    // Look up the required offset in the mask texture.
    vec4 offset = texture2D(mask, vec2(mx / maskSize.x, my / maskSize.y)) - 0.5;
    float x = vTextureCoord.x *  worldSize.x + offset.r;
    float y = vTextureCoord.y *  worldSize.y + offset.g;
    vec4 source = texture2D(world, vec2(x / worldSize.x, y / worldSize.y));

    // Convert the source an atlasId (can't index using the vec4 using [] so using if checks)
    float atlasId;
    float frame = mod(time + floor(x) + floor(y), 3.0);
    if (frame < 1.0) {
        atlasId = source.r * 255.0;
    } else if (frame < 2.0) {
        atlasId = source.g * 255.0;
    } else {
        atlasId = source.b * 255.0;
    }
    
    // Ensure bridges are not blended.
    float unblentAtlasId = floor(texture2D(world, vTextureCoord).r * 255.0);

    if (unblentAtlasId == bridgeId) {
        atlasId = unblentAtlasId;
    }

    if (atlasId == bridgeId) {
        atlasId = unblentAtlasId;
    }

    // Get number of atlas columns and rows.
    float atlasColumns = atlasSize.x / tileSize;
    float atlasRows = atlasSize.y / tileSize;

    // Get position in atlas texture.
    float dx = mod(atlasId, atlasColumns) / atlasColumns;
    float dy = floor(atlasId / atlasColumns) / atlasRows;

    // This is probably working by accident.
    vec2 size = tileSize / atlasSize;
    gl_FragColor = texture2D(atlas, vec2(dx, dy) + (mod((vTextureCoord * worldSize), 1.0) * size));
}
`,Wh=`attribute vec2 aVertexPosition;
attribute vec2 aTextureCoord;

uniform mat3 projectionMatrix;
uniform mat3 translationMatrix;
uniform mat3 uTextureMatrix;

varying vec2 vTextureCoord;

void main(void)
{
    gl_Position = vec4((projectionMatrix * translationMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);

    vTextureCoord = (uTextureMatrix * vec3(aTextureCoord, 1.0)).xy;
}
`;class Vh extends jn{constructor(e){super(Nt.EMPTY,{program:new Kn(Wh,Hh),uniforms:{tileSize:w,bridgeId:f.Bridge,time:0,worldSize:[e.getWidth(),e.getHeight()],atlasSize:[160,192],maskSize:[192,192]}});a(this,"canvas");a(this,"context");a(this,"imageData");a(this,"getTileTypes",e=>{switch(e.getDiscoveryStatus()){case z.Discovered:return e.getAnimation();case z.Pending:return[dt.Static1,dt.Static2,dt.Static3];default:return[f.Obstructed]}});this.surface=e,this.canvas=document.createElement("canvas"),this.canvas.width=this.surface.getWidth(),this.canvas.height=this.surface.getHeight(),this.context=this.canvas.getContext("2d"),this.imageData=this.context.createImageData(this.surface.getWidth(),this.surface.getHeight()),this.uniforms.world=Nt.from(this.canvas),this.uniforms.atlas=Nt.from(this.canvas),this.uniforms.mask=Nt.from(this.canvas),vs().then(s=>{this.uniforms.atlas=s.terrain.baseTexture,this.uniforms.mask=s.mask.baseTexture})}render(e=!1){this.surface.getTiles().forEach((s,n)=>{let r=e?s.getAnimation():this.getTileTypes(s);this.imageData.data[n*4]=r[0],this.imageData.data[n*4+1]=r[1]||r[0],this.imageData.data[n*4+2]=r[2]||r[0],this.imageData.data[n*4+3]=255}),this.context.putImageData(this.imageData,0,0),this.uniforms.world.update()}setTime(e){this.uniforms.time=e/600}}const jh=()=>{const i=document.createElement("canvas").getContext("webgl2");if(!i)return!1;const t=i.createShader(i.VERTEX_SHADER);if(i.shaderSource(t,Ha),i.compileShader(t),!i.getShaderParameter(t,i.COMPILE_STATUS))return!1;const e=i.createShader(i.FRAGMENT_SHADER);if(i.shaderSource(e,Ga),i.compileShader(e),!i.getShaderParameter(e,i.COMPILE_STATUS))return!1;const s=i.createProgram();return i.attachShader(s,t),i.attachShader(s,e),i.linkProgram(s),!!i.getProgramParameter(s,i.LINK_STATUS)},Kh=jh(),qs=class qs{constructor(){a(this,"currentSounds",[]);a(this,"currentSound",null);a(this,"volume",1);qs.instance=this}static get Instance(){return this.instance}queue(t){this.currentSounds.some(e=>t.includes(e))||(this.currentSounds=t,this.currentSound?gh(this.currentSound).then(()=>this.playNextSound()):this.playNextSound()),this.currentSounds=t}play(){if(!this.currentSound){this.playNextSound();return}const t=q.find(this.currentSound);if(!t.isPlaying){t.play();return}}pause(){this.currentSound&&q.pause(this.currentSound)}stop(){this.currentSound&&(q.stop(this.currentSound),this.currentSound=null)}updateVolume(t){this.volume=t,this.currentSound&&q.volume(this.currentSound,this.volume*gs[this.currentSound])}get isPlaying(){return this.currentSound?q.find(this.currentSound).isPlaying:!1}playNextSound(){const t=this.currentSounds.length===1?this.currentSounds:this.currentSounds.filter(e=>e!==this.currentSound);this.currentSound=t[Math.floor(Math.random()*t.length)],q.volume(this.currentSound,this.volume*gs[this.currentSound]),q.play(this.currentSound,{complete:()=>{this.playNextSound()}})}};a(qs,"instance");let vt=qs;const qh=10,Ts=12,Fn=25,Zh=300,Qh=500,Jh=.3;let ks=!1;qn.defaultOptions.scaleMode=br.NEAREST;const Zs=class Zs{constructor(t){a(this,"messageFn");a(this,"resolveMessageFn");a(this,"removeEventListeners");a(this,"intervalId",-1);a(this,"surface");a(this,"target");a(this,"app");a(this,"viewport");a(this,"vueApp");a(this,"sprites",new Map);a(this,"assets");a(this,"coverageRenderer");a(this,"alertRenderer");a(this,"cursorRenderer");a(this,"worldShader");a(this,"x",0);a(this,"y",0);a(this,"scale",Ci);a(this,"width",0);a(this,"height",0);a(this,"time",0);a(this,"nextExplosionTime",0);a(this,"explosions",0);a(this,"lockedTowers",!1);a(this,"showMessage",async(...t)=>{const e=await this.messageFn;return q.exists(X.Notification)&&q.play(X.Notification),e(...t)});this.controller=t,Zs.instance=this,this.messageFn=new Promise(e=>this.resolveMessageFn=e),this.assets=new zh,window.debug=()=>{ks=!ks,this.surface.forceRerender(),this.renderWorld()}}static get Instance(){return this.instance}mount(t,e){this.surface=t,this.target=e,this.lockedTowers=t.getTowers().size>=pt.Instance.getMaxTowers(),this.worldShader=Kh?new Gh(t):new Vh(t),this.app=new Ir({resizeTo:window}),e.appendChild(this.app.view),this.width=this.surface.getWidth()*w,this.height=this.surface.getHeight()*w,this.viewport=new Mr({screenWidth:window.innerWidth,screenHeight:window.innerHeight,worldWidth:this.width,worldHeight:this.height,events:this.app.renderer.events}).clamp({direction:"all",underflow:"center"}).drag({wheel:!0,clampWheel:!0,pressDrag:!1}).pinch().addListener("moved",({type:h})=>{h!=="animate"&&(this.x=this.viewport.center.x,this.y=this.viewport.center.y)}),this.app.stage.addChild(this.viewport);const s=new Nt(new qn(void 0,{width:1,height:1})),n=new xr(s,2,2);n.width=this.surface.getWidth()*w,n.height=this.surface.getWidth()*w,n.shader=this.worldShader,this.viewport.addChild(n,...Mn),this.coverageRenderer=new Fh(this.assets,this.surface),this.alertRenderer=new Li(this.assets),this.cursorRenderer=new Nh,this.assets.onComplete(()=>{this.renderWorld(),this.updateSettings()});const r=e.appendChild(document.createElement("div"));this.vueApp=Fi(Ra,{register:this.resolveMessageFn}),this.vueApp.mount(r);const o=u.Instance.getBase().getTile();this.x=o.getX()*w,this.y=o.getY()*w,this.viewport.animate({time:0,position:{x:this.x,y:this.y}}),this.registerEventHandlers()}updateSettings(){const t=Gt("settings");Object.keys(Ya).forEach(e=>$a(e,((t==null?void 0:t.volume)??50)/100)),vt.Instance.updateVolume(((t==null?void 0:t.musicVolume)??66)/100)}renderWorld(){const t=ks||u.Instance.getIsBaseDestroyed();this.worldShader.render(t),this.coverageRenderer.render();const e=bt(u.Instance.getBase()),s=K.Instance.getSpawnAlertRanges();this.alertRenderer.render(e,s)}rerender(t){if(this.assets.loading)return;this.time+=t;const e=ks||u.Instance.getIsBaseDestroyed(),s=this.surface.isDirty();s&&this.renderWorld(),this.worldShader.setTime(this.time);const n=s?this.surface.getEntities():this.surface.getTickingEntities(),r=[...this.surface.getDeletedEntities()];let o=!1;for(let h of n){let l=this.sprites.get(h.getId());const d=h.getAgent().isVisible()||e;if(!l){const g=Lh[h.getAgent().getType()];if(g===null||!d)continue;const p=g||_a;l=new p(h.getAgent(),this.assets),l.zIndex=h.getAlignedY(),p.layer.addChild(l),p.layer===Re&&(o=!0),this.sprites.set(h.getId(),l)}d?l.sync(t,s):r.push(h)}if(r.forEach(h=>{const l=this.sprites.get(h.getId());l&&(this.sprites.delete(h.getId()),l.constructor.layer.removeChild(l))}),o&&Re.sortChildren(),this.cursorRenderer.render(),this.coverageRenderer.update(t),this.alertRenderer.update(t,u.Instance.getIsStarted()),this.surface.markPristine(),u.Instance.getIsBaseDestroyed()&&this.time>this.nextExplosionTime&&this.explosions<Jh*u.Instance.getBase().getParts().size){const h=[...u.Instance.getBase().getParts()],l=h[Math.floor(Math.random()*h.length)];this.explosions++,this.nextExplosionTime=this.time+Zh+Qh/h.length,new Ht(this.assets,...bt(l),2),this.shake(),nt.fromEntity(l.entity,X.Explosion)}}showCoverage(){this.coverageRenderer.show(),this.alertRenderer.enable()}hideCoverage(){this.coverageRenderer.hide(),this.alertRenderer.disable()}unmount(){this.app&&(this.vueApp.unmount(),this.app.destroy(!0),this.removeEventListeners(),Mn.forEach(t=>t.removeChildren()),this.alertRenderer.unmount(),this.messageFn=new Promise(t=>this.resolveMessageFn=t))}getTime(){return this.time}registerEventHandlers(){const t=m=>(m.preventDefault(),!1);this.target.addEventListener("contextmenu",t);const e=m=>{const M=Math.floor((m.data.global.x/this.viewport.scale.x+this.viewport.left)/w),A=Math.floor((m.data.global.y/this.viewport.scale.y+this.viewport.top)/w);this.controller.mouseDown(M,A)};this.viewport.addListener("pointerdown",e);const s=m=>{const M=Math.floor((m.data.global.x/this.viewport.scale.x+this.viewport.left)/w),A=Math.floor((m.data.global.y/this.viewport.scale.y+this.viewport.top)/w);this.controller.mouseMove(M,A)};this.viewport.addListener("pointermove",s);const n=m=>{const M=Math.floor((m.data.global.x/this.viewport.scale.x+this.viewport.left)/w),A=Math.floor((m.data.global.y/this.viewport.scale.y+this.viewport.top)/w);this.controller.mouseUp(M,A,m.pointerType==="touch")};this.viewport.addListener("pointerup",n);const r=m=>{this.controller.keyDown(m.key),m.preventDefault()};window.addEventListener("keydown",r);const o=m=>{this.controller.keyUp(m.key),m.preventDefault()};window.addEventListener("keyup",o);const h=dh(E.StartWave,X.Sonar),l=B.Instance.addEventListener(E.Buy,()=>{q.play(X.Place);const m=this.surface.getTowers().size>=pt.Instance.getMaxTowers();m!==this.lockedTowers&&(window.setTimeout(()=>q.play(X.Lock),150),this.lockedTowers=m)}),d=B.Instance.addEventListener(E.Sell,()=>{q.play(X.Destroy);const m=this.surface.getTowers().size>=pt.Instance.getMaxTowers();m!==this.lockedTowers&&(window.setTimeout(()=>q.play(X.Lock),150),this.lockedTowers=m)}),g=B.Instance.addEventListener(E.HitBase,()=>{q.play(X.Destroy),this.shake()}),p=B.Instance.addEventListener(E.StartWave,({wave:m})=>{m%10===0&&vt.Instance.queue([X.BossMusic])}),v=B.Instance.addEventListener(E.EndWave,()=>{vt.Instance.queue(Fa)});this.removeEventListeners=()=>{window.removeEventListener("contextmenu",t),this.viewport.removeListener("pointerdown",e),this.viewport.removeListener("pointermove",s),this.viewport.removeListener("pointerup",n),window.removeEventListener("keydown",r),window.removeEventListener("keyup",o),h(),l(),d(),g(),p(),v()}}move({x:t=0,y:e=0,zoom:s}){s&&(s<0?this.scale=Math.max(rh,this.scale*.9):this.scale=Math.min(ah,this.scale*1.1));const n=this.viewport.worldScreenWidth/2,r=this.viewport.worldScreenHeight/2;(t>0&&this.x<this.width-n||t<0&&this.x>n)&&(this.x+=t*xn/this.scale),(e>0&&this.y<this.height-r||e<0&&this.y>r)&&(this.y+=e*xn/this.scale),window.clearInterval(this.intervalId),this.viewport.animate({time:200,position:{x:this.x,y:this.y},scale:this.scale})}shake(){window.clearInterval(this.intervalId);let t=qh;this.intervalId=window.setInterval(()=>{this.viewport.animate({time:Fn,position:{x:this.x+Math.floor(Math.random()*Ts/2)-Ts,y:this.y+Math.floor(Math.random()*Ts/2)-Ts}}),t--,t<=0&&(window.clearInterval(this.intervalId),this.intervalId=-1)},Fn)}getViewport(){var t,e;return{x:this.x,y:this.y,width:((t=this.viewport)==null?void 0:t.worldScreenWidth)||0,height:((e=this.viewport)==null?void 0:e.worldScreenHeight)||0,scale:this.scale}}};a(Zs,"instance");let Yi=Zs;const ht=Yi,tl={True:!0,False:!1},el=(i,t,e)=>{var s;return((s=Object.entries(i).find(([n,r])=>t===r))==null?void 0:s[0])||e},$n=(i,t,e)=>Object.values(i).find(s=>s===t)??e,sl=(i,t)=>{if(i==="renderer"){const e={emojiRenderer:en,pixiRenderer:ht};return t in e?e[t]:e.pixiRenderer}return i==="difficulty"?$n(N,t):i==="showTutorial"?$n(tl,t):i==="volume"||i==="musicVolume"?Bs(t,0,100):i==="simulation"?Bs(t,1,3):t},il=(i,t)=>i==="renderer"?el({emojiRenderer:en,pixiRenderer:ht},t,"pixiRenderer"):t,nl={settings:sl,achievements:Dc,save:Yc},al={settings:il,achievements:Lc,save:Oc},Gt=i=>{let t;try{t=localStorage.getItem(i)}catch{return null}if(!t)return null;t.startsWith("{")||(t=window.atob(t));try{return JSON.parse(t,nl[i])}catch{return null}},_e=(i,t,e=!1)=>{const s=Gt(i)||{},n=JSON.stringify({...s,...t},al[i]);try{localStorage.setItem(i,e?window.btoa(n):n)}catch(r){console.warn("Failed to store data",r)}},rl=i=>!!localStorage.getItem(i),ol=i=>{localStorage.removeItem(i)},sn=i=>(fe("data-v-e7510ce0"),i=i(),me(),i),cl={class:"marketplace"},hl={class:"inner"},ll={class:"menu"},ul={class:"group"},dl={class:"title"},gl={class:"items"},pl={class:"item-wrapper"},fl=["onClick"],ml={class:"truncate"},yl={key:0},wl={class:"detail"},vl={class:"detail-name"},Sl={class:"detail-summary"},El=["src"],bl={class:"hints"},Il={key:0},Ml=sn(()=>y("strong",null,"Ranged",-1)),xl={key:1},Cl=sn(()=>y("strong",null,"Powered",-1)),Tl={key:2},kl=sn(()=>y("strong",null,"Base",-1)),Al={class:"detail-description"},Pl={class:"wavepoints"},Bl=["disabled"],Rl=J({__name:"Shop",props:{controller:{},unlocksController:{},eventSystem:{},visible:{type:Boolean}},setup(i){var m;const t=i,e={[c.Barracks]:"barracks.png",[c.Convert]:"convert.png",[c.DamageBeacon]:"damagebeacon.png",[c.Excavator]:"excavator.png",[c.Fence]:"fence.png",[c.Flamethrower]:"flamethrower.png",[c.Laser]:"laser.png",[c.Market]:"market.png",[c.Mortar]:"mortar.png",[c.PowerPlant]:"powerplant.png",[c.Radar]:"radar.png",[c.Railgun]:"railgun.png",[c.EmergencyRecharge]:"recharge.png",[c.EmergencyRepair]:"repair.png",[c.None]:"sell.png",[c.SpeedBeacon]:"speedbeacon.png",[c.Freezer]:"tar.png",[c.Terraform]:"terraform.png",[c.Tesla]:"tesla.png",[c.Tower]:"tower.png",[c.Wall]:"wall.png"},s={[c.Barracks]:O.Castle,[c.Convert]:O.Recycle,[c.DamageBeacon]:O.Up,[c.Excavator]:O.Hammer,[c.Fence]:O.Wall,[c.Flamethrower]:O.Turret,[c.Laser]:O.Turret,[c.Market]:O.Castle,[c.Mortar]:O.Turret,[c.PowerPlant]:O.Castle,[c.Radar]:O.Castle,[c.Railgun]:O.Turret,[c.EmergencyRecharge]:O.Recycle,[c.EmergencyRepair]:O.Recycle,[c.None]:O.Hammer,[c.SpeedBeacon]:O.Up,[c.Freezer]:O.Down,[c.Terraform]:O.Hammer,[c.Tesla]:O.Turret,[c.Tower]:O.Turret,[c.Wall]:O.Wall},n=_(t.controller.getPlacable()),r=Gn(),o=_((m=Gt("settings"))==null?void 0:m.showTutorial);let h;pe(()=>{h=t.eventSystem.addEventListener(E.SelectPlaceable,({placeable:M})=>n.value=M)}),Qs(()=>{h&&h()});const l=M=>{if(M===t.controller.getPlacable()){if(t.unlocksController.canUnlock(M)){g();return}if(t.unlocksController.isUnlocked(M)){t.controller.toggleBuildMenu();return}}t.controller.setPlaceable(M)},d=Object.values(tn),g=()=>{t.unlocksController.unlock(n.value),r.proxy.$forceUpdate()},p=()=>{t.controller.toggleBuildMenu()},v=()=>{o.value=!o.value};return(M,A)=>(b(),T("div",{class:gt({"marketplace-wrapper":!0,"marketplace-wrapper--visible":t.visible})},[y("div",cl,[y("button",{onClick:p,class:"close-button"},[C(Q,{type:P(O).Cross},null,8,["type"])]),y("button",{onClick:v,class:"view-mode-button"},[C(Q,{type:o.value?P(O).Pacifier:P(O).Binoculars},null,8,["type"])]),y("div",hl,[y("div",ll,[(b(!0),T(ft,null,Lt(P(d),I=>(b(),T("div",ul,[y("div",dl,$(I),1),y("div",gl,[(b(!0),T(ft,null,Lt(P(Aa)[I],Y=>{var x;return b(),T("div",pl,[!o.value||t.unlocksController.isUnlocked(Y)||t.unlocksController.canUnlock(Y)?(b(),T("button",{key:0,class:gt({item:!0,"item--locked":!t.unlocksController.isUnlocked(Y),"item--selected":((x=n.value)==null?void 0:x.entityType)===Y.entityType}),onClick:()=>l(Y)},[y("span",ml,[C(Q,{type:s[Y.entityType]},null,8,["type"]),F(" "+$(Y.name),1)]),P(Be)[Y.entityType]?(b(),T("span",yl,[F($(P(Be)[Y.entityType])+" ",1),C(Q,{type:P(O).Money},null,8,["type"])])):H("",!0)],10,fl)):H("",!0)])}),256))])]))),256))]),y("div",wl,[y("h2",vl,$(n.value.name),1),y("div",Sl,[y("img",{src:"portraits/"+e[n.value.entityType]},null,8,El),y("div",bl,[n.value.entity&&n.value.entity.range?(b(),T("span",Il,[C(Q,{type:P(O).Turret},null,8,["type"]),F(),Ml,F(" This building attacks enemies within "+$(n.value.entity.range)+" tiles.",1)])):H("",!0),P(Mi)[n.value.entityType]?(b(),T("span",xl,[C(Q,{type:P(O).Battery},null,8,["type"]),F(),Cl,F(" This building requires power to function. Be sure to build some power plants first.")])):H("",!0),n.value.isBasePart?(b(),T("span",Tl,[C(Q,{type:P(O).Castle},null,8,["type"]),F(),kl,F(" This building is part of your base and must be built next to an adjacent base building. Be sure to protect it from enemies!")])):H("",!0)])]),y("article",Al,$(n.value.description),1),y("aside",Pl,[y("button",{disabled:!t.unlocksController.canUnlock(n.value),onclick:g},$(n.value.isRepeatable?"Activate":t.unlocksController.isUnlocked(n.value)?"Unlocked":"Unlock"),9,Bl),F(" ("+$(t.unlocksController.getPoints())+" wave points remaining) ",1)])])])])],2))}});const _l=lt(Rl,[["__scopeId","data-v-e7510ce0"]]),Dl={class:"horizontal"},Ll=["value"],Yl={class:"horizontal"},Ol={class:"horizontal"},Fl={class:"horizontal"},$l={class:"horizontal"},Xl=J({__name:"Settings",props:{setSubmitter:{type:Function},updateMusic:{type:Function}},setup(i){const{setSubmitter:t,updateMusic:e}=i,s=[{label:"Pixi renderer",value:ht},{label:"Emoji renderer",value:en}],n=Gt("settings"),r=_(n&&s.find(({value:p})=>p===n.renderer)||s[0]),o=_((n==null?void 0:n.showTutorial)??!0),h=_((n==null?void 0:n.volume)??50),l=_((n==null?void 0:n.musicVolume)??66),d=_((n==null?void 0:n.simulation)??1);return t(()=>({...n,renderer:r.value.value,showTutorial:o.value,volume:h.value,musicVolume:l.value,simulation:d.value})),(p,v)=>(b(),T(ft,null,[y("label",Dl,[F(" Renderer "),re(y("select",{"onUpdate:modelValue":v[0]||(v[0]=m=>r.value=m)},[(b(),T(ft,null,Lt(s,m=>y("option",{value:m},$(m.label),9,Ll)),64))],512),[[Hn,r.value]])]),y("label",Yl,[F(" Show tutorial "),re(y("input",{type:"checkbox","onUpdate:modelValue":v[1]||(v[1]=m=>o.value=m)},null,512),[[ur,o.value]])]),y("label",Ol,[F(" SFX Volume "),re(y("input",{type:"range",min:"0",max:"100","onUpdate:modelValue":v[2]||(v[2]=m=>h.value=m)},null,512),[[Ps,h.value]])]),y("label",Fl,[F(" Music volume "),re(y("input",{type:"range",min:"0",max:"100","onUpdate:modelValue":v[3]||(v[3]=m=>l.value=m),onChange:v[4]||(v[4]=m=>p.updateMusic(m.target.valueAsNumber))},null,544),[[Ps,l.value]])]),y("label",$l,[F(" Simulation speed "),re(y("input",{type:"range",min:"1",max:"3","onUpdate:modelValue":v[5]||(v[5]=m=>d.value=m)},null,512),[[Ps,d.value]])])],64))}});const Wa=lt(Xl,[["__scopeId","data-v-1f76010d"]]),Va=i=>(fe("data-v-199e170e"),i=i(),me(),i),Nl={class:"menu"},Ul=Va(()=>y("h3",null,"Paused",-1)),zl=Va(()=>y("span",{class:"divider"},null,-1)),Gl=J({__name:"IngameMenu",props:{visible:{type:Boolean},onMainMenu:{type:Function},resume:{type:Function}},setup(i){const{visible:t,onMainMenu:e,resume:s}=i;let n;const r=l=>n=l,o=()=>{const l=n();_e("settings",l),s(l.renderer,l.showTutorial,l.simulation)},h=l=>{Object.keys(Oa).forEach(d=>$a(d,l/100))};return(l,d)=>(b(),T("div",{class:gt({"menu-wrapper":!0,"menu-wrapper--visible":l.visible})},[y("div",Nl,[Ul,y("button",{onClick:d[0]||(d[0]=(...g)=>l.onMainMenu&&l.onMainMenu(...g))},"Main menu"),zl,C(Wa,{setSubmitter:r,updateMusic:h}),y("button",{onClick:o},"Save and resume")])],2))}});const Hl=lt(Gl,[["__scopeId","data-v-199e170e"]]),Wl=["is"],Vl=J({__name:"UiElement",props:{onClick:{type:Function},active:{type:Boolean},className:{},style:{}},setup(i){const t=i;return(e,s)=>(b(),T("button",{is:t.onClick?"button":"div",onClick:s[0]||(s[0]=(...n)=>e.onClick&&e.onClick(...n)),class:gt({"ui-element":!0,"ui-element--interactive":t.onClick,"ui-element--active":t.active,...t.className}),style:Ae(t.style)},[Wn(e.$slots,"default",{},void 0,!0)],14,Wl))}});const Jt=lt(Vl,[["__scopeId","data-v-67b09611"]]),jl={class:"money"},Kl={class:"meta"},ql={class:"positive"},Zl={class:"meta"},Ql={class:"positive"},Jl={key:0,class:"negative"},tu={key:1},eu={class:"meta"},su={class:"positive"},iu={class:"negative"},nu=J({__name:"Stats",setup(i){const t=Intl.NumberFormat(void 0,{maximumFractionDigits:0}),e=Intl.NumberFormat(void 0,{maximumFractionDigits:2}),s=Intl.NumberFormat(void 0,{style:"percent",maximumFractionDigits:0}),n=_(0),r=_(0),o=_(0),h=_(0),l=_(0),d=_(!1),g=_(0),p=_(0),v=_(0),m=_(0),M=_(0),A=_(!0);function I(){A.value=!A.value}const Y=D=>{n.value=D.money,r.value=D.moneyMultiplier,o.value=D.level,h.value=D.towers,l.value=D.maxTowers,d.value=D.inProgress,g.value=D.integrity,p.value=D.regeneration,v.value=D.power,m.value=D.production,M.value=D.consumption},x=dr(()=>({stats:!0,"stats--collapsed":!A.value}));return pe(()=>{B.Instance.addEventListener(E.StatUpdate,Y),u.Instance.triggerStatUpdate()}),Qs(()=>{B.Instance.removeEventListener(E.StatUpdate,Y)}),(D,U)=>(b(),T("div",{class:gt(x.value)},[C(Jt,{onClick:I,"class-name":{circle:!0}},{default:Pt(()=>[y("span",jl,[C(Q,{type:P(O).Money},null,8,["type"]),F(" "+$(P(t).format(n.value)),1)]),y("span",Kl,[F("("),y("span",ql,$(P(s).format(r.value)),1),F(")")])]),_:1}),C(Jt,{"class-name":{"minor-stat":!0},style:{"--i":"145deg"}},{default:Pt(()=>[C(Q,{type:P(O).Shield},null,8,["type"]),F(" "+$(P(t).format(g.value))+" ",1),y("span",Zl,[F("("),y("span",Ql,"+"+$(P(e).format(p.value)),1),F(")")])]),_:1}),C(Jt,{"class-name":{"minor-stat":!0},style:{"--i":"90deg"}},{default:Pt(()=>[C(Q,{type:P(O).Turret},null,8,["type"]),h.value>=l.value?(b(),T("span",Jl,$(h.value),1)):(b(),T("span",tu,$(h.value),1)),F(" / "+$(l.value),1)]),_:1}),C(Jt,{"class-name":{"minor-stat":!0},style:{"--i":"35deg"}},{default:Pt(()=>[C(Q,{type:P(O).Battery},null,8,["type"]),F(" "+$(P(t).format(v.value))+" ",1),y("span",eu,[F("("),y("span",su,"+"+$(P(e).format(m.value)),1),F("/"),y("span",iu,"-"+$(P(e).format(M.value)),1),F(")")])]),_:1})],2))}});const au=lt(nu,[["__scopeId","data-v-e453b358"]]),ru={class:"hud"},ou={class:"group"},cu={key:2,class:"wave-text"},hu={key:3,class:"wave-text"},lu={key:4,class:"wave-text"},uu={class:"sub-buttons"},du=J({__name:"Hud",props:{renderer:{},controller:{},restart:{type:Function},toggleMenu:{type:Function}},setup(i){const t=i,e=_(0),s=_(!1),n=_(!1),r=_(0),o=_(!1),h=g=>{e.value=g.level,s.value=g.inProgress&&g.integrity>0,r.value=g.integrity,o.value=g.towers<=g.maxTowers};pe(()=>{B.Instance.addEventListener(E.StatUpdate,h),u.Instance.triggerStatUpdate()}),Qs(()=>{B.Instance.removeEventListener(E.StatUpdate,h)});function l(){r.value>0?u.Instance.start():t.restart()}function d(){n.value?t.renderer.hideCoverage():t.renderer.showCoverage(),B.Instance.triggerEvent(E.ToggleShowCoverage),n.value=!n.value}return(g,p)=>(b(),T("div",ru,[C(au),y("div",ou,[C(Jt,{onClick:l,active:s.value||!o.value},{default:Pt(()=>[o.value?(b(),At(Q,{key:0,type:P(O).Battle},null,8,["type"])):(b(),At(Q,{key:1,type:P(O).Lock},null,8,["type"])),!s.value&&r.value>0?(b(),T("span",cu,"Start wave "+$(e.value+1),1)):!s.value&&r.value<=0?(b(),T("span",hu,"Restart wave "+$(e.value),1)):(b(),T("span",lu,"Wave "+$(e.value),1))]),_:1},8,["active"]),y("div",uu,[C(Jt,{onClick:p[0]||(p[0]=()=>t.controller.toggleBuildMenu()),"class-name":{circle:!0}},{default:Pt(()=>[C(Q,{type:P(O).Hammer},null,8,["type"])]),_:1}),P(u).Instance.getDifficulty()!==P(N).Hard?(b(),At(Jt,{key:0,onClick:d,active:n.value,"class-name":{circle:!0}},{default:Pt(()=>[C(Q,{type:P(O).Radar},null,8,["type"])]),_:1},8,["active"])):H("",!0),C(Jt,{onClick:t.toggleMenu,"class-name":{circle:!0}},{default:Pt(()=>[C(Q,{type:P(O).Gear},null,8,["type"])]),_:1},8,["onClick"])])])]))}});const gu=lt(du,[["__scopeId","data-v-4dcd0909"]]);class pu{constructor(t,e=0){a(this,"removeEventListeners");a(this,"done",!1);a(this,"steps");a(this,"highestProgress",0);a(this,"data",{});a(this,"initialProgress",0);a(this,"process",t=>{const e=Math.max(this.progress,this.initialProgress);this.progress=Math.max(this.definition.getProgress.call(this,t),this.progress),!this.isDone&&(this.updateProgress(),this.highestProgress>e&&(u.Instance.showMessage(`{icon: Trophy} Achievement unlocked!
${this.title} - ${this.description}`),_e("achievements",{[$i(this.definition.description)]:this.highestProgress},!0)))});this.definition=t,this.progress=e,this.initialProgress=e,this.steps=Object.keys(this.definition.thresholds).map(s=>parseFloat(s)),this.updateProgress()}get title(){return Object.values(this.definition.thresholds)[this.steps.indexOf(this.highestProgress)]}get description(){return this.definition.description}get thresholds(){return this.definition.thresholds}get stepValues(){return this.steps}get isDone(){return this.done}get internalProgress(){return this.progress}get completedThresholds(){return this.steps.indexOf(this.highestProgress)}get percentage(){const t=this.steps.at(-1);return this.progress/t}getPercentageForThreshold(t){const e=parseFloat(t),s=this.steps[this.steps.indexOf(e)-1]??0;return Math.min(Math.max(this.progress-s,0)/(e-s),1)}register(){this.removeEventListeners=B.Instance.addEventListeners(this.definition.triggers,this.process)}unRegister(){var t;(t=this.removeEventListeners)==null||t.call(this)}updateProgress(){for(let t=0;t<this.steps.length&&this.progress>=this.steps[t];t++)this.highestProgress=this.steps[t],t===this.steps.length-1&&(this.done=!0)}}const fu=[{description:"Reach a certain wave.",thresholds:{1:"Lvl 1 Street thug",5:"Lvl 5 Enforcer",10:"Lvl 10 Consigliere",15:"Lvl 15 Underboss",20:"Lvl 20 Don",30:"Lvl 30 Godfather"},getProgress:()=>u.Instance.getLevel(),triggers:[E.EndWave]},{description:"Discover the map.",thresholds:{"10%":"Settler","20%":"Trailblazer","40%":"Homesteader","60%":"Adventurer","90%":"Frontier explorer"},getProgress:()=>{const i=u.Instance.getSurface(),[t,e]=i.getTiles().reduce((s,n)=>(n.getType()===f.Void||(s[1]++,n.isDiscovered()&&s[0]++),s),[0,0]);return t/e*100},triggers:[E.StartWave]},{description:"Defeat enemies.",thresholds:{30:"Bot basher",100:"Circuit smasher",500:"Metal mauler",1e3:"Robo rampage",5e3:"Mechanic menace",1e4:"Robotic ruler"},getProgress:function(){const i=this.data.lastKilledEnemies??0,t=this.internalProgress+u.Instance.getKilledEnemies()-i;return this.data.lastKilledEnemies=u.Instance.getKilledEnemies(),t},triggers:[E.Kill]},{description:"Discover the edge of the map.",thresholds:{1:"Edgelord"},getProgress:()=>it.Instance.isEdgeDiscovered()?1:0,triggers:[E.StartWave]},{description:"Reach level 10 on easy mode.",thresholds:{10:"Humble beginnings"},getProgress:()=>u.Instance.getDifficulty()===N.Easy?u.Instance.getLevel():0,triggers:[E.EndWave]},{description:"Reach level 10 on normal mode.",thresholds:{10:"Establishing dominance"},getProgress:()=>u.Instance.getDifficulty()===N.Normal?u.Instance.getLevel():0,triggers:[E.EndWave]},{description:"Reach level 10 on hard mode.",thresholds:{10:"A force to be reckoned with"},getProgress:()=>u.Instance.getDifficulty()===N.Hard?u.Instance.getLevel():0,triggers:[E.EndWave]},{description:"Build a wall of at least 30 tiles.",thresholds:{30:"Great wall of China"},getProgress:i=>{const t=i;return t.tiles[0].getType()!==f.Wall?0:Mc(t.tiles[0],u.Instance.getSurface(),new Set([c.Wall]),!0)},triggers:[E.Buy]},{description:"Expand your base.",thresholds:{5:"Pompeii",12:"Alexandria",25:"Athens",50:"Rome"},getProgress:()=>u.Instance.getBase().getParts().size,triggers:[E.Buy]},{description:"Unlock new technologies.",thresholds:{2:"Innovator",5:"Visionary",8:"Groundbreaker",12:"Game-changer"},getProgress:()=>Ot.Instance.getUnlockAmount(),triggers:[E.Unlock]},{description:"Hit enemies using a single mortar shell.",thresholds:{5:"Bomberman"},getProgress:i=>i.amount,triggers:[E.Bomb]},{description:"Hit enemies using a single tesla coil discharge.",thresholds:{10:"Thunderstruck"},getProgress:i=>i.amount,triggers:[E.Stun]},{description:"Pierce enemies using a single railgun shot.",thresholds:{15:"Penetrator"},getProgress:i=>i.amount,triggers:[E.Pierce]}],ja=()=>{const i=Gt("achievements");return fu.map(t=>new pu(t,(i==null?void 0:i[$i(t.description)])??0)).sort((t,e)=>Number(e.isDone)-Number(t.isDone)||e.completedThresholds-t.completedThresholds||e.percentage-t.percentage)},rs=class rs{constructor(){a(this,"achievements");a(this,"unRegister",()=>{const t={};this.achievements.forEach(e=>{t[$i(e.description)]=e.internalProgress,e.unRegister()}),_e("achievements",t,!0)});rs.instance=this,this.achievements=ja(),this.achievements.forEach(t=>t.register()),window.addEventListener("beforeunload",this.unRegister)}cleanup(){window.removeEventListener("beforeunload",this.unRegister),rs.instance=null}static get Instance(){return this.instance}};a(rs,"instance");let Ut=rs;class mu{constructor(t,e=1){a(this,"entity");a(this,"category",R.Unknown);a(this,"renderData",{});a(this,"targetX",0);a(this,"targetY",0);a(this,"travelTime",0);a(this,"time",0);a(this,"sourceX",0);a(this,"sourceY",0);this.tile=t,this.amount=e,this.entity=new at(t.getX()+.5,t.getY()+.5,this),this.sourceX=this.entity.getX(),this.sourceY=this.entity.getY()}tick(t){if(this.travelTime>0&&this.time<this.travelTime){this.time+=t;const e=Math.min(1,this.time/this.travelTime);this.entity.setX(Yt(this.tile.getX(),this.targetX,e)),this.entity.setY(Yt(this.tile.getY(),this.targetY,e)),this.time>=this.travelTime&&u.Instance.getSurface().despawn(this)}}discover(){const t=u.Instance.getBase(),[e,s]=bt(t);this.targetX=e,this.targetY=s,this.travelTime=Math.sqrt((e-this.tile.getX())**2+(s-this.tile.getY())**2)*60}getType(){return c.WavePoint}isVisible(){return this.travelTime>0}}const yu={apiKey:"AIzaSyCUua4XIvRX14AI5zAQe1OynmeSxe57f0A",authDomain:"open-td-ac8be.firebaseapp.com",projectId:"open-td-ac8be",storageBucket:"open-td-ac8be.appspot.com",messagingSenderId:"351731826193",appId:"1:351731826193:web:072686940fc4909b337bb0",measurementId:"G-D9LVZGMF6F"},wu=gr(yu),vu=pr(wu),Oi=(i,t)=>{fr(vu,i,t)};class Ka{constructor(t){a(this,"entity");a(this,"category",R.Unknown);a(this,"renderData",{});this.tile=t,this.entity=new W(t.getX(),t.getY(),this)}getType(){return c.Stump}getTile(){return this.tile}updateTile(t){this.tile=t}isVisible(){return this.tile.isDiscovered()}}a(Ka,"scale",1);class Su extends ys{constructor(t){super(t),this.renderData.subType=ti.Rock2}getType(){return c.Rock2}}const Eu={[c.Tower]:da,[c.Base]:ii,[c.Wall]:ga,[c.Mortar]:$s,[c.Flamethrower]:Fs,[c.Railgun]:Xs,[c.ElectricFence]:Ys,[c.Fence]:zi,[c.Freezer]:Gi,[c.Tree]:ms,[c.Pine]:Jn,[c.Cactus]:Qn,[c.Stump]:Ka,[c.Rock]:ys,[c.Rock2]:Su,[c.Rock3]:Zn,[c.Radar]:Ki,[c.PowerPlant]:Wi,[c.Armory]:Ui,[c.Market]:Hi,[c.SpeedBeacon]:ls,[c.DamageBeacon]:hs,[c.Laser]:Us,[c.Barracks]:Qi,[c.Tesla]:zs},bu=(i,t)=>{const e=Eu[i];return e?new e(t).entity:null},ke=class ke extends u{constructor(e,s,n,r){super(e,s,n,r);a(this,"killedEnemies",0);a(this,"lastKilledEnemies",0);a(this,"removeUnlockEventListener");a(this,"removeDiscoverEventListener");a(this,"removeLostEventListener");a(this,"showMessage",(...e)=>this.messageFn(...e));a(this,"onUnlock",({placeable:e})=>{const s=this.getIsStarted();e.entityType===c.EmergencyRecharge&&(tt.Instance.emergencyRegenerate(s?1:Gs),this.triggerStatUpdate()),e.entityType===c.EmergencyRepair&&(this.base.hp+=(ii.baseEmergencyRepair+this.base.getParts().size)*(s?1:Gs),this.triggerStatUpdate())});a(this,"onDiscover",e=>{const s=e.method===Ls.Base?2:1;Ot.Instance.addPoints(s);const n=new mu(this.surface.getTile(e.x,e.y),s);this.surface.spawn(n),n.discover()});a(this,"onLose",()=>{this.surface.getEntitiesForCategory(R.Enemy).forEach(e=>{const s=e.getAgent();Dr(s)&&s.AI.cancel()})});s&&(this.surface.getEntityTiles(this.base).map(o=>{o.hasStaticEntity()&&this.surface.despawnStatic(o.getStaticEntity().getAgent())}),n.spawnStatic(this.base)),this.removeUnlockEventListener=B.Instance.addEventListener(E.Unlock,this.onUnlock),this.removeDiscoverEventListener=B.Instance.addEventListener(E.Discover,this.onDiscover),this.removeLostEventListener=B.Instance.addEventListener(E.Lose,()=>window.setTimeout(this.onLose,0)),console.log(this)}cleanup(){this.removeUnlockEventListener(),this.removeDiscoverEventListener(),this.removeLostEventListener()}tick(e){if(this.surface.processChangedTiles(),this.base.isDestroyed())return;const s=this.surface.getTickingEntities();for(let n of s)n.getAgent().tick(e);K.Instance.tick(e),this.lastKilledEnemies!==this.killedEnemies&&(this.lastKilledEnemies=this.killedEnemies,B.Instance.triggerEvent(E.Kill),this.triggerStatUpdate())}triggerStatUpdate(){const e=this.getSurface().getEntitiesForCategory(R.Enemy).size;B.Instance.triggerEvent(E.StatUpdate,{integrity:this.base.getHp(),regeneration:this.base.getRegenerationFactor(),level:this.level,money:Z.Instance.getMoney(),moneyMultiplier:Z.Instance.getMultiplier(),production:tt.Instance.getProduction(),consumption:tt.Instance.getConsumption(),power:tt.Instance.getPower(),remainingEnemies:e,inProgress:this.getIsStarted(),towers:this.surface.getTowers().size,maxTowers:pt.Instance.getMaxTowers()})}spawnEnemy(e){this.surface.spawn(e)}despawnEnemy(e){this.killedEnemies++,this.surface.despawn(e)&&K.Instance.processWave()&&this.end()}getKilledEnemies(){return this.killedEnemies}getIsStarted(){return K.Instance.isWaveInProgress()||K.Instance.getSpawnGroups().length===0}canBuy(e,s=1){if(this.difficulty===N.Practice)return!0;const n=(Be[e.entityType]??0)*s;return n>Z.Instance.getMoney()?(this.showMessage(`You do not have enough money. This costs 🪙 ${n}`),!1):!0}start(){if(this.getIsStarted())throw new Error("Wave already in progress!");if(this.surface.getTowers().size>pt.Instance.getMaxTowers()){u.Instance.showMessage(`Your current base can support up to ${pt.Instance.getMaxTowers()} towers. Extend your base or sell towers before starting `);return}tt.Instance.processPower(),Z.Instance.clearRecents(),Z.Instance.addWaveBudget(this.level),K.Instance.startNewWave(),it.Instance.commit(),this.level++,it.Instance.updateBaseRange(),B.Instance.triggerEvent(E.StartWave,{wave:this.level}),this.triggerStatUpdate(),u.Instance.getSurface().forceRerender()}consume(e,s=1,n=1){return tt.Instance.consume((Mi[e.getType()]??0)+(s-1)*tt.speedBeaconConsumption+(n-1)*tt.damageBeaconConsumption)}consumeContinuous(e,s,n=1){return tt.Instance.consume((Mi[e.getType()]??0)*s+(n-1)*tt.damageBeaconConsumption*s/160)}getDifficulty(){return this.difficulty}getIsBaseDestroyed(){return this.base.isDestroyed()}getDamageMultiplier(){let e=1;switch(this.difficulty){case N.Hard:e+=.2;case N.Normal:e+=.2}return e}serialize(){const e=this.base.getTile(),s=this.surface.serialize(!0);return{killedEnemies:this.killedEnemies,difficulty:this.difficulty,base:{x:e.getX(),y:e.getY(),hp:this.base.getHp()},level:this.level,surface:[...s.buffer].map(n=>String.fromCharCode(n+ke.serializeStartChar)).join("")}}end(){pt.Instance.commit(),it.Instance.commit(),K.Instance.cleanupSpawnGroups(Ls.Base),this.base.regenerate(),this.triggerStatUpdate(),B.Instance.triggerEvent(E.EndWave),K.Instance.getSpawnGroups().length===0?this.showMessage("World conquered. You win!",{closable:!1,expires:0}):this.level===9?this.showMessage("Something is rumbling in the distance."):K.Instance.shouldAddSpawnGroup()&&(B.Instance.triggerEvent(E.Spawn),this.showMessage("Another spawn point has appeared!")),u.Instance.getSurface().forceRerender(),_e("save",Mu()),Oi("defeat_wave",{difficulty:this.difficulty,wave:this.level})}static deserialize(e,s){const n=new Zt(Uint8Array.from(s.surface.split("").map(h=>h.charCodeAt(0)-ke.serializeStartChar)),bu),r=new ea(n),o=new ke(s.difficulty,null,r,e);return o.level=s.level,o.base=r.getTile(s.base.x,s.base.y).getStaticEntity().getAgent(),o.base.hp=s.base.hp,o}};a(ke,"serializeStartChar","À".charCodeAt(0));let ps=ke;const qa="1.2.0",Iu=(i,t,e,s)=>{new B,i!==N.Practice&&new Ut,new it(e);const n=new ii(t),r=new ps(i,n,e,s);return new K(n,e),new tt,new Z(i===N.Practice?Number.POSITIVE_INFINITY:100,()=>n.getMoneyFactor()),new pt(e),new Ot,r},Mu=()=>({version:qa,manager:ps.Instance.serialize(),visibilityController:it.Instance.serialize(),waveController:K.Instance.serialize(),powerController:tt.Instance.serialize(),moneyController:Z.Instance.serialize(),buildController:pt.Instance.serialize(),unlocksController:Ot.Instance.serialize()}),Xn=(i,t)=>{B.Instance||new B;const e=ps.deserialize(i,t.manager),s=e.getSurface(),n=e.getBase();u.Instance.getDifficulty()===N.Practice?Ut.Instance&&Ut.Instance.cleanup():Ut.Instance||new Ut,it.deserialize(s,t.visibilityController),K.deserialize(s,n,t.waveController),tt.deserialize(s,t.powerController),Z.deserialize(()=>n.getMoneyFactor(),t.moneyController),pt.deserialize(s,t.buildController),Ot.deserialize(t.unlocksController),it.Instance.commit();const r=s.getEntitiesForCategory(R.Player);for(const o of r){const h=o.getAgent();if(yi(h)){h.spawn();continue}pt.baseParts.has(h.getType())&&n.addPart(h)}return e.triggerStatUpdate(),e},xu=i=>(fe("data-v-df4cf09c"),i=i(),me(),i),Cu={class:"wrapper"},Tu={height:"0",style:{position:"absolute"}},ku=xu(()=>y("defs",null,[y("radialGradient",{id:"alert"},[y("stop",{offset:"0%","stop-color":"red","stop-opacity":"0"}),y("stop",{offset:"95%","stop-color":"red","stop-opacity":"0"}),y("stop",{offset:"100%","stop-color":"red","stop-opacity":"0.8"})])],-1)),Au=[ku],Pu={class:"canvas"},Bu=J({__name:"Game",props:{seed:{},difficulty:{},renderer:{},showTutorial:{type:Boolean},initialSpeed:{},onMainMenu:{type:Function}},setup(i){const t=i,e=_(null),s=_(!1),n=_(!1),r=_(t.initialSpeed),o=new Qt;let h=new t.renderer(o),l,d;if(t.seed){console.log(`Seed: ${t.seed}`),d=new ea({width:160,height:160,generate:Pr(t.seed,160,160)});const U=d.getTile(80,80);l=Iu(t.difficulty,U,d,h.showMessage)}else console.log("Loading save"),l=Xn(h.showMessage,Gt("save")),d=l.getSurface();const g=new _c;t.showTutorial&&g.start();let p=!1,v,m,M,A;const I=()=>{s.value=!s.value,s.value?o.pause():o.unpause()};pe(()=>{p=!0,o.initialize(d),h.mount(d,e.value),m=o.addKeyListener(ot.Escape,()=>{if(n.value){Qt.Instance.toggleBuildMenu();return}I()}),M=B.Instance.addEventListener(E.OpenBuildMenu,()=>n.value=!0),A=B.Instance.addEventListener(E.CloseBuildMenu,()=>n.value=!1);const U=ut=>{if(!p)return;const Rt=+o.isKeyDown(ot.Right)+ +o.isKeyDown(ot.D)-+o.isKeyDown(ot.Left)-+o.isKeyDown(ot.A)-+o.isKeyDown(ot.Q),Se=+o.isKeyDown(ot.Down)+ +o.isKeyDown(ot.S)-+o.isKeyDown(ot.Up)-+o.isKeyDown(ot.W)-+o.isKeyDown(ot.Z),ie=+o.isKeyDown(ot.Plus)+ +o.isKeyDown(ot.Equals)-+o.isKeyDown(ot.Minus);(Rt||Se||ie)&&h.move({x:Rt,y:Se,zoom:ie});const Es=v?ut-v:16;s.value||l.tick(Es*r.value),h.rerender(Es),v=ut,window.requestAnimationFrame(U)};window.requestAnimationFrame(U)}),Qs(()=>{var U;h.unmount(),(U=Ut.Instance)==null||U.unRegister(),m(),M(),A(),p=!1,u.Instance.getBase().isDestroyed()&&ol("save")});const Y=(U,ut,Rt)=>{U&&!(h instanceof U)?(h.unmount(),d.forceRerender(),h=new U(o),h.mount(d,e.value),l.update(h.showMessage)):h instanceof ht&&h.updateSettings(),!g.isStarted&&ut&&g.start(),g.isStarted&&ut===!1&&g.stop(),Rt&&(r.value=Rt),s.value=!1,o.unpause()},x=()=>{l=Xn(h.showMessage,Gt("save")),d=l.getSurface(),o.initialize(d),h.unmount(),h.mount(d,e.value)},D=()=>{var U;(U=Ut.Instance)==null||U.unRegister(),t.onMainMenu()};return(U,ut)=>(b(),T("div",Cu,[(b(),T("svg",Tu,Au)),C(gu,{renderer:P(h),controller:P(Qt).Instance,restart:x,toggleMenu:I},null,8,["renderer","controller"]),y("div",Pu,[y("div",{class:"render-target",ref_key:"canvas",ref:e},null,512),C(_l,{controller:P(Qt).Instance,unlocksController:P(Ot).Instance,eventSystem:P(B).Instance,visible:n.value},null,8,["controller","unlocksController","eventSystem","visible"]),C(Hl,{onMainMenu:D,visible:s.value,resume:Y},null,8,["visible"])])]))}});const Ru=lt(Bu,[["__scopeId","data-v-df4cf09c"]]);const _u={},Du={class:"key-grid"};function Lu(i,t){return b(),T("div",Du,[Wn(i.$slots,"default",{},void 0,!0)])}const gi=lt(_u,[["render",Lu],["__scopeId","data-v-ad6fcae2"]]),Ss=i=>(fe("data-v-52ee7b24"),i=i(),me(),i),Yu=Ss(()=>y("h3",null,"Build menu",-1)),Ou={class:"flex"},Fu=Ss(()=>y("h3",null,"Building",-1)),$u={class:"flex flex-justify"},Xu={class:"key-combination"},Nu={class:"key-combination"},Uu=Ss(()=>y("h3",null,"Moving",-1)),zu={class:"flex flex-justify"},Gu=Ss(()=>y("h3",null,"Zooming",-1)),Hu={class:"flex"},Wu=Ss(()=>y("h3",null,"Toggle selling",-1)),Vu={class:"flex"},ju=J({__name:"ControlsList",setup(i){return(t,e)=>(b(),T(ft,null,[Yu,y("div",Ou,[C(V,{char:"e"}),F(" / "),C(V,{char:"b"})]),Fu,y("div",$u,[C(_s,{button:"left"}),F(" / "),y("span",Xu,[C(V,{char:"⇧"}),F(" + "),C(_s,{button:"left"})]),F(" / "),y("span",Nu,[C(V,{char:"⌘"}),F(" + "),C(_s,{button:"left"})])]),Uu,y("div",zu,[C(gi,null,{default:Pt(()=>[C(V,{char:"w",area:"up"}),C(V,{char:"a",area:"left"}),C(V,{char:"s",area:"down"}),C(V,{char:"d",area:"right"})]),_:1}),F(" / "),C(gi,null,{default:Pt(()=>[C(V,{char:"z",area:"up"}),C(V,{char:"q",area:"left"}),C(V,{char:"s",area:"down"}),C(V,{char:"d",area:"right"})]),_:1}),F(" / "),C(gi,null,{default:Pt(()=>[C(V,{char:"↑",area:"up"}),C(V,{char:"←",area:"left"}),C(V,{char:"↓",area:"down"}),C(V,{char:"→",area:"right"})]),_:1})]),Gu,y("div",Hu,[C(V,{char:"-"}),C(V,{char:"+"})]),Wu,y("div",Vu,[C(V,{char:"f"})])],64))}});const Ku=lt(ju,[["__scopeId","data-v-52ee7b24"]]),Za=i=>(fe("data-v-55661321"),i=i(),me(),i),qu={class:"achievement-title"},Zu={class:"achievement-description"},Qu={key:0,class:"achievement-progress"},Ju={class:"achievement-line"},td=["title"],ed=Za(()=>y("span",{class:"line"},null,-1)),sd={class:"marker"},id=Za(()=>y("span",{class:"achievement-line-segment"},[y("span",{class:"line"})],-1)),nd=[id],ad={class:"achievement-percentage"},rd="???????",od=J({__name:"Achievement",props:{achievement:{}},setup(i){const{achievement:t}=i,e=Intl.NumberFormat(void 0,{style:"percent",maximumFractionDigits:0}),s=t.stepValues.at(-1),n=t.percentage;return(r,o)=>(b(),T("div",{class:gt({achievement:!0,"achievement--complete":r.achievement.isDone})},[y("h2",qu,$(r.achievement.title??rd),1),y("p",Zu,$(r.achievement.description),1),r.achievement.stepValues.length>1||P(s)!==1?(b(),T("div",Qu,[y("span",Ju,[y("span",{class:"achievement-line-nominal",style:Ae({flex:P(s)})},[(b(!0),T(ft,null,Lt(r.achievement.thresholds,(h,l)=>(b(),T("span",{class:gt({"achievement-line-segment":!0}),style:Ae({"--progress":`${r.achievement.getPercentageForThreshold(l)*100}%`}),title:r.achievement.internalProgress>=parseFloat(l)?h:r.achievement.internalProgress.toFixed()},[ed,y("span",sd,$(l),1)],12,td))),256))],4),r.achievement.internalProgress>P(s)?(b(),T("span",{key:0,class:"achievement-line-overflow",style:Ae({flex:r.achievement.internalProgress-P(s)})},nd,4)):H("",!0)]),y("p",ad,$(P(n)>1?r.achievement.internalProgress:P(e).format(P(n))),1)])):H("",!0)],2))}});const cd=lt(od,[["__scopeId","data-v-55661321"]]),hd=J({__name:"AchievementsList",setup(i){const t=ja();return(e,s)=>(b(!0),T(ft,null,Lt(P(t),n=>(b(),At(cd,{achievement:n},null,8,["achievement"]))),256))}}),Nn=["a","e","i","o","u"],Un=["b","c","d","f","g","h","j","k","l","m","n","p","q","r","s","t","v","w","x","y","z"],Qa=()=>Nn[Math.floor(Math.random()*Nn.length)],Ja=()=>Un[Math.floor(Math.random()*Un.length)],tr=()=>Ja()+Qa(),ld=()=>tr()+Ja(),zn=[Qa,tr,ld],ud=()=>zn[Math.floor(Math.random()*zn.length)](),dd=()=>{const i=[],t=Math.random()>.5?3:2;for(let e=0;e<t;e++)i.push(ud());return i.join("")},gd="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAABMtJREFUeF7tm01IVUEUx8dVRCQIFZGlRBRCZCChRIGrFlG6sSioFgmBBmJQ0UIiJVpIBUaUgWCrokBbaNGilVCEES6EwLICNSMiEoKKVi/Os3OZN87HOTNz39N8d/PUOx/n/zv/OTP3vWeJWOZXyTLXL4oAig5YYgTu9d7MdP+6JcbPTkRxb5RB8smw+npVBueLASGvAA6cGU2Ct0F70lNnjQshLHoAVMEuB6lAYrogFQeECq+svqtlsufPdrGxfINom+xI7oe6ICqAtISjWgAAF0CAC0AsCgChwkGMKeuqFVQI9Y1NQUkM6gzBhYqnCjeBONbaFqQhqDNHvI/QI2v2ZXU//PbMWidvN9/x1uHdkSreRzioBfGfZj+LmtrL4utsb2oQvABwxYMYVxblFLftfJST8bFXF8WLFW+sLuhu2CtWrz3O1sPu4CP+6pZ2cf7DDTKEgdJ2MbK5PhFMcQA09oHgBABnbyw0VPFyVZ+ue5wIqRg96DrzJPdx/a8rbxVUB2BnjhOsAHzFIwAQgdnnugDGwIMPdfmAA7gQjABmTuxIzu0fD3dmC9L9t7WkDMqFD/dt6Civ46nxkzlj+RZLHEQWD3+jusAJAMTjVqQGbaLhEkMZxzWGPLcqnuMCLQBd9iF7lMBdpzrqGDq4DzomxYXh59liB6/f3zcLUTXfsuHnaPa18VAZaxlYAcjZx1EpAkzZs/UFcabr6JWtQnf/1NNtQkyIBAL079v/LmcY11KwFsGRocEMrH11D6ZAMImxCfUCAJ3+QQAXyA6g1ALnLqA7gPgA8BEOAiD7cOn6Dw3MieFVdckSUMVTaoEVwOn+lgXv4HDF+wrH4BGADgIC0GVedpNtGaQKIFS87ACTC1RQujmjAaBmnyJ87OVKUbP7t7HwyTdsy4DSzgtAiP1NAMCycOE7OvAzBQIXAELBOKC/6Y1W4xJQAVCzbytY1zp/ZGPr6ZvfvCniXYVQtZBcM+R7QQA44ikAoM25ztIFW5ZtG1SzSmn73wBQi6EJsin70L7gDoAgsAbAz6Y921YVbQJd1XRRAHAFSbnvCyGvAPBZAB9aYr7qlgMFXEEAQGCxxMsiuUU5qAb4TMZ5lqdkT23jE5O3A3wmg4DTguAbDxsAiJAPQ7tmhHi9SQh4HZzLfTvLlMU0IPgAsH3cznoYQgicIGJC4MxLOQRBGzIAHwdgECYI8pjgLtdVUAAQHMf+rmWhisffTf18xdt2AKcD5DrgY39bRpvKcr8EgfXF5ARf+K6v2zg/GVILIbUAuuxsA6BzB4ynzi2PYYorGAC6ILYDYFwqBITJBeAST1oC6jKI5QAdAJtruOJdax/nci4BbNjf1ZLhngO4y4AKQHWOLimU7JMdkNYyUIWYAKSVfRYAGYKuILmyrbtPAWATb4qDmn02AOgA3xGAg03IvowwuABiWp9dA+QMQj2IUQxdALjW52Q+CAA6wcf2ch8uANt8PuK9loAcBOcrM6bgTRA4DvMVHwwglhNCnBQiPgqAQkIIFR8NAGYwxpKguCGG8OAiaAs0LRAxhacKQHVE76X1lMRq27R2fTF+quM9qNSR/CwQY7LpuSnSv8xUlFXmLa68TRQDYBpjFAGkQXUpjVl0wFLKVhqxLnsH/AU7Wtlfb8AWCgAAAABJRU5ErkJgggAA",nn=i=>(fe("data-v-9dd7bf3a"),i=i(),me(),i),pd={class:"wrapper"},fd={class:"main-title"},md=["src"],yd={class:"menu"},wd={class:"menu-main"},vd={class:"menu-main-inner"},Sd=["value"],Ed={class:"difficulty-description"},bd=nn(()=>y("button",{type:"submit"},"Start!",-1)),Id={class:"menu-controls-inner"},Md={class:"menu-controls-inner"},xd={class:"menu-settings-inner"},Cd={class:"footer"},Td=nn(()=>y("a",{class:"footer-link",href:"https://github.com/lorgan3/open-td/releases",target:"_blank",rel:"noopener noreferrer"},"Release notes",-1)),kd={key:0},Ad=nn(()=>y("span",{class:"spinner"},"߷",-1)),Pd=J({__name:"MainMenu",props:{onPlay:{type:Function},onCredits:{type:Function}},setup(i){const t=i,e=_(0),s=_(dd()),n=_(null),r=_(!1);pe(()=>{window.setTimeout(()=>{r.value=rl("save")},0)});const o=Gt("settings"),h=_((o==null?void 0:o.difficulty)||N.Easy),l=_(!0);vs().then(()=>{l.value=!1});let d;const g=A=>d=A,p=A=>{var I;if(A===e.value){e.value=0;return}e.value=A,e.value===1&&((I=n.value)==null||I.select())},v=A=>{l.value||vt.Instance.updateVolume(A/100)},m=A=>{A.preventDefault();const I=d();_e("settings",{...I,difficulty:h.value}),t.onPlay(s.value,h.value,I.renderer,I.showTutorial,I.simulation),Oi("play",{difficulty:h.value})},M=A=>{A.preventDefault();const I=d();_e("settings",I),t.onPlay(null,h.value,I.renderer,!1,I.simulation),Oi("play_save")};return(A,I)=>(b(),T("div",pd,[y("h1",fd,[y("img",{src:P(gd),alt:"Open Tower Defense"},null,8,md),F(" Open Tower Defense ")]),y("div",yd,[y("div",wd,[y("div",vd,[r.value?(b(),T("button",{key:0,onClick:M},"Continue")):H("",!0),y("button",{onClick:I[0]||(I[0]=Y=>p(1))},"Play"),y("button",{onClick:I[1]||(I[1]=Y=>p(2))},"Controls"),y("button",{onClick:I[2]||(I[2]=Y=>p(3))},"Achievements"),y("button",{onClick:I[3]||(I[3]=Y=>p(4))},"Settings"),y("button",{onClick:I[4]||(I[4]=Y=>A.onCredits())},"Credits")])]),y("div",{class:gt({"menu-play":!0,"menu--hidden":e.value!==1})},[y("form",{onSubmit:m,class:"menu-play-inner"},[y("label",null,[F(" Which world? "),re(y("input",{ref_key:"seedInput",ref:n,"onUpdate:modelValue":I[5]||(I[5]=Y=>s.value=Y)},null,512),[[Ps,s.value]])]),y("label",null,[F(" Difficulty "),re(y("select",{"onUpdate:modelValue":I[6]||(I[6]=Y=>h.value=Y)},[(b(!0),T(ft,null,Lt(P(ln),({label:Y},x)=>(b(),T("option",{value:x},$(Y),9,Sd))),256))],512),[[Hn,h.value]])]),y("p",Ed,$(P(ln)[h.value].description),1),bd],32)],2),y("div",{class:gt({"menu-controls":!0,"menu--hidden":e.value!==2})},[y("div",Id,[C(Ku)])],2),y("div",{class:gt({"menu-achievements":!0,"menu--hidden":e.value!==3})},[y("div",Md,[C(hd)])],2),y("div",{class:gt({"menu-settings":!0,"menu--hidden":e.value!==4})},[y("div",xd,[C(Wa,{setSubmitter:g,updateMusic:v})])],2)]),y("div",Cd,[y("span",null,$(P(qa)),1),Td,l.value?(b(),T("span",kd,[Ad,F(" Loading assets")])):H("",!0)])]))}});const Bd=lt(Pd,[["__scopeId","data-v-9dd7bf3a"]]),Rd=[{author:"Lorgan3",authorUrl:"https://github.com/lorgan3",subjects:[{name:"Code and many sprites",url:"https://github.com/lorgan3/open-td",license:["GPL 3.0"]}]},{author:"Arthur Lee Brown",authorUrl:"https://www.reddit.com/user/arthurlbrown/",subjects:[{name:"Title music"},{name:"Fog of War (level music 1)"},{name:"Marching Onward (level music 2)"},{name:"For Honor (level music 3)"},{name:"Heroic (level music 4)"},{name:"Boss music"}]},{author:"sogomn",authorUrl:"https://opengameart.org/users/sogomn",subjects:[{name:"Explosion animation",url:"https://opengameart.org/content/explosion-3",license:["CC0"]}]},{author:"b_o",subjects:[{name:"Pine Tree Tiles",url:"https://opengameart.org/content/pine-tree-tiles",license:["CC-BY-SA 3.0","GPL 2.0"]}]},{author:"Lanea Zimmerman (aka Sharm), Eliza Wyatt",subjects:[{name:"Flat Shingle Roof A",url:"https://opengameart.org/content/liberated-pixel-cup-lpc-base-assets-sprites-map-tiles",license:["CC-BY-SA 3.0","GPL 3.0"]}]},{author:"bluecarrot16",authorUrl:"https://opengameart.org/users/bluecarrot16",subjects:[{name:"[LPC] Rocks",url:"https://opengameart.org/content/lpc-rocks",description:`[LPC] Rocks by bluecarrot16, Johann Charlot, Yar, Hyptosis, Evert, Lanea Zimmerman (Sharm), Guillaume Lecollinet, Richard Kettering (Jetrel), Zachariah Husiar (Zabin), Jetrel, Hyptosis, Redshrike, Rayane Félix (RayaneFLX), Michele Bucelli (Buch) <https://opengameart.org/users/buch>

	Based on:

	Shoot'em up graphic kit
	Johann Charlot
	CC-BY-SA 3.0 / GPL 3.0
	https://opengameart.org/content/shootem-up-graphic-kit

	Isometric 64x64 Outside Tileset
	Yar
	CC-BY 3.0
	https://opengameart.org/content/isometric-64x64-outside-tileset

	Lots of Hyptosis' tiles organized!
	Hyptosis
	CC-BY 3.0
	https://opengameart.org/content/lots-of-hyptosis-tiles-organized

	Hyptosis rocks adapted by Evert
	CC-BY 3.0
	https://opengameart.org/comment/86070#comment-86070

	Liberated Pixel Cup (LPC) Base Assets
	Lanea Zimmerman (Sharm)
	CC-BY-SA 3.0 / CC-BY 3.0 / GPL 3.0
	https://opengameart.org/content/liberated-pixel-cup-lpc-base-assets-sprites-map-tiles

	BrowserQuest Sprites and Tiles
	Guillaume Lecollinet
	CC-BY-SA 3.0
	http://opengameart.org/content/browserquest-sprites-and-tiles

	ZRPG Tiles
	Richard Kettering aka (Jetrel),Zachariah Husiar aka (Zabin), Hyptosis, Sharm and Open Pixel Project.
	CC-BY-SA 3.0+
	https://opengameart.org/content/zrpg-tiles

	2d Lost Garden Zelda style tiles resized to 32x32 with additions
	Daniel Cook, Jetrel, Saphy (TMW), Zabin, Bertram
	CC-BY 3.0
	https://opengameart.org/content/2d-lost-garden-zelda-style-tiles-resized-to-32x32-with-additions
	Credit goes to Daniel Cook's 2d Circle Graphic Archive, Jetrel's mockups resized 32x32, Bertram's improvements, Zabin's modification and additions, Saphy (TMW) tall grass and please provide a link back to OGA and this submission.

	32x32 (and 16x16) RPG Tiles--Forest and some Interior Tiles
	Stephen Challener and the Open Surge team (http://opensnc.sourceforge.net)commissioned by Gaurav Munjal
	CC-BY 3.0
	https://opengameart.org/content/32x32-and-16x16-rpg-tiles-forest-and-some-interior-tiles

	16x16 Game Assets
	George Bailey
	CC-BY 4.0
	https://opengameart.org/content/16x16-game-assets

	RPG Terrains
	Rayane Félix (RayaneFLX)
	CC-BY-SA 3.0
	https://opengameart.org/content/rpg-terrains

	Outdoor 32x32 tileset
	Buch <https://opengameart.org/users/buch>
	CC0
	https://opengameart.org/content/outdoor-32x32-tileset

	Cute dungeon LPC edit
	Evert, Buch <https://opengameart.org/users/buch>
	CC-BY 3.0
	https://opengameart.org/content/cute-dungeon-lpc-edit
	https://opengameart.org/content/a-cute-dungeon`,license:["CC-BY-SA 4.0","CC-BY-SA 3.0"]},{name:"[LPC] Trees",url:"https://opengameart.org/content/lpc-trees",description:`[LPC] Trees Mega-Pack by bluecarrot16, Jetrel, Zabin, Hyptosis, Surt, Buch, Johann Charlot, Stephen Challener and the Open Surge team (http://opensnc.sourceforge.net), Gaurav Munjal, Ivan Voirol (Silver IV)
	Guido Bos, Yar, Paulina Riva (PauR), William.Thompsonj, Casper Nilsson, Hyptosis, ansimuz, qubodup, Bart K., Blarumyrran, Lanea Zimmerman (Sharm), Leonard Pabin, Chris Phillips, Barbara Rivera, and Talosaurus.
	CC-BY-SA 3.0


	Lots of trees and plants from OGA (DB32) tilesets pack 1
	Jetrel, Zabin, Hyptosis, Surt
	CC0
	https://opengameart.org/content/lots-of-trees-and-plants-from-oga-db32-tilesets-pack-1

	The Field of the Floating Islands
	Buch <https://opengameart.org/users/buch>
	CC0
	https://opengameart.org/content/the-field-of-the-floating-islands

	Outdoor tiles, again
	Buch <https://opengameart.org/users/buch>
	CC-BY 2.0
	https://opengameart.org/content/outdoor-tiles-again

	Shoot'em up graphic kit
	Johann Charlot
	CC-BY-SA 3.0 / GPL 3.0
	https://opengameart.org/content/shootem-up-graphic-kit

	32x32 (and 16x16) RPG Tiles--Forest and some Interior Tiles
	Stephen Challener and the Open Surge team (http://opensnc.sourceforge.net)commissioned by Gaurav Munjal
	CC-BY 3.0
	https://opengameart.org/content/32x32-and-16x16-rpg-tiles-forest-and-some-interior-tiles

	Orthographic outdoor tiles
	Buch
	CC0
	https://opengameart.org/content/orthographic-outdoor-tiles

	Basic map 32x32 by Silver IV
	Ivan Voirol (Silver IV)
	CC-BY 3.0 / GPL 3.0 / GPL 2.0
	https://opengameart.org/content/basic-map-32x32-by-silver-iv

	old frogatto tile art
	Guido Bos
	CC0
	https://opengameart.org/content/old-frogatto-tile-art

	Generic Platformer Tiles
	surt
	CC0
	http://opengameart.org/content/generic-platformer-tiles

	Isometric 64x64 Outside Tileset
	Yar
	CC-BY 3.0
	https://opengameart.org/content/isometric-64x64-outside-tileset

	Nature tileset
	Paulina Riva (PauR)
	CC-BY 3.0
	https://opengameart.org/content/nature-tileset

	[LPC] Tree Recolors
	William.Thompsonj
	CC-BY-SA 3.0 / GPL 3.0
	https://opengameart.org/content/lpc-tree-recolors

	LPC C.Nilsson
	Casper Nilsson
	CC-BY-SA 3.0 / GPL 3.0
	https://opengameart.org/content/lpc-cnilsson

	Lots of Hyptosis' tiles organized!
	Hyptosis
	CC-BY 3.0
	https://opengameart.org/content/lots-of-hyptosis-tiles-organized

	Trees & Bushes
	ansimuz
	CC0
	http://opengameart.org/content/trees-bushes

	OGA Community Tileset: Nature
	qubodup, Bart K., Blarumyrran
	GPL 2.0 / GPL 3.0 / CC-BY-SA 3.0
	https://opengameart.org/content/oga-community-tileset-nature

	Liberated Pixel Cup (LPC) Base Assets
	Lanea Zimmerman (Sharm)
	CC-BY-SA 3.0 / CC-BY 3.0 / GPL 3.0
	https://opengameart.org/content/liberated-pixel-cup-lpc-base-assets-sprites-map-tiles

	Whispers of Avalon: Grassland Tileset
	Leonard Pabin
	CC-BY 3.0 / GPL 3.0 / GPL 2.0
	https://opengameart.org/content/whispers-of-avalon-grassland-tileset

	Team River Fox
	Chris Phillips, Barbara Rivera
	CC-BY-SA 3.0 / GPL 3.0
	https://opengameart.org/content/team-river-fox

	Concept Art for LPC Entry
	Barbara Rivera
	CC-BY-SA 3.0 / GPL 3.0
	https://opengameart.org/content/concept-art-for-lpc-entry

	Old Eastern Themed Building Tiles + Tree
	Talosaurus
	CC0
	https://opengameart.org/content/old-eastern-themed-building-tiles-tree`,license:["CC-BY-SA 3.0"]},{name:"[LPC] Rocks",url:"https://opengameart.org/content/lpc-beach-desert",description:`[LPC] Beach/Desert by bluecarrot16, Guillaume Lecollinet, Johann Charlot, cynicmusic, Surt, vk, Yar, Buch, Jetrel, Zabin, Hyptosis, and Sharm.
	CC-BY-SA 3.0

	BrowserQuest Sprites and Tiles
	Guillaume Lecollinet
	CC-BY-SA 3.0
	http://opengameart.org/content/browserquest-sprites-and-tiles

	Shoot'em up graphic kit
	Johann Charlot
	CC-BY-SA 3.0 / GPL 3.0
	https://opengameart.org/content/shootem-up-graphic-kit

	Pixelsphere 32x32 Tileset + Grass + Trees
	cynicmusic
	CC0
	http://opengameart.org/content/pixelsphere-32x32-tileset-grass-trees

	trees
	Surt, vk
	CC0
	https://opengameart.org/content/trees-1

	Isometric 64x64 Outside Tileset
	Yar
	CC-BY 3.0
	https://opengameart.org/content/isometric-64x64-outside-tileset

	Tuxemon tileset
	Buch
	CC-BY-SA 3.0
	https://opengameart.org/content/tuxemon-tileset

	Lots of trees and plants from OGA (DB32) tilesets pack 1
	Jetrel, Zabin, Hyptosis, Surt
	CC0
	https://opengameart.org/content/lots-of-trees-and-plants-from-oga-db32-tilesets-pack-1

	Bone Planet
	Hyptosis
	CC0
	https://opengameart.org/content/bone-planet

	Whispers of Avalon: Desert Tileset
	Leonard Pabin, Ali-G
	CC-BY 3.0 / GPL 3.0 / GPL 2.0
	https://opengameart.org/content/whispers-of-avalon-desert-tileset

	[LPC] Arabic Elements
	Lanea Zimmerman (Sharm), William Thompson
	CC-BY 3.0 / GPL 3.0 / GPL 2.0 / OGA-BY 3.0
	https://opengameart.org/content/lpc-arabic-elements

	Lots of free 2d tiles and sprites by Hyptosis
	Hyptosis, Zabin
	CC-BY 3.0
	https://opengameart.org/content/lots-of-free-2d-tiles-and-sprites-by-hyptosis`,license:["CC-BY-SA 3.0"]},{name:"[LPC] Terrains",url:"https://opengameart.org/content/lpc-terrains",description:`[LPC] Terrains by bluecarrot16, Lanea Zimmerman (Sharm), Daniel Eddeland (Daneeklu), Richard Kettering (Jetrel), Zachariah Husiar (Zabin), Hyptosis, Casper Nilsson, Buko Studios, Nushio, ZaPaper, billknye, William Thompson, caeles, Redshrike, Bertram, and Rayane Félix (RayaneFLX)

	Liberated Pixel Cup (LPC) Base Assets (sprites & map tiles)
	Lanea Zimmerman (Sharm)
	CC-BY 3.0 / CC-BY-SA 3.0 / GPL 3.0
	https://opengameart.org/content/liberated-pixel-cup-lpc-base-assets-sprites-map-tiles

	[LPC] Farming tilesets, magic animations and UI elements
	Daniel Eddeland (Daneeklu)
	CC-BY-SA 3.0 / GPL 3.0
	https://opengameart.org/content/lpc-farming-tilesets-magic-animations-and-ui-elements

	ZRPG Tiles
	Richard Kettering (Jetrel), Zachariah Husiar (Zabin), Hyptosis, Lanea Zimmerman (Sharm), and Open Pixel Project.
	CC-BY-SA 3.0+
	https://opengameart.org/content/zrpg-tiles

	LPC C.Nilsson
	Casper Nilsson
	CC-BY-SA 3.0 / GPL 3.0
	https://opengameart.org/content/lpc-cnilsson

	Frozen Lake [LPC]
	Buko Studios (http://www.buko-studios.com/) Commissioned by PlayCraft: (www.playcraftapp.com)
	CC-BY 3.0
	https://opengameart.org/content/frozen-lake-lpc


	LPC Animated Water and waterfalls
	ZaPaper
	CC-BY-SA 3.0
	https://opengameart.org/content/lpc-animated-water-and-waterfalls

	LPC More Water Transitions
	billknye
	CC-BY-SA 3.0 / GPL 3.0
	https://opengameart.org/content/lpc-more-water-transitions

	[LPC] Sand+Rock Alt Colors
	William.Thompsonj, Daniel Eddeland
	CC-BY-SA 3.0 / GPL 3.0
	https://opengameart.org/content/lpc-sandrock-alt-colors

	[LPC] Colorful Sand + Deep Water!
	Nushio
	CC-BY-SA 3.0 / GPL 3.0
	https://opengameart.org/content/lpc-colorful-sand-deep-water

	LPC terrain extension
	caeles
	CC-BY-SA 3.0 / GPL 3.0
	https://opengameart.org/content/lpc-terrain-extension

	RPG Tiles: Cobble stone paths & town objects
	Zachariah Husiar (Zabin), Daniel Eddeland (Daneeklu), Richard Kettering (Jetrel), Hyptosis, Redshrike, Bertram
	CC-BY-SA 3.0
	https://opengameart.org/content/rpg-tiles-cobble-stone-paths-town-objects

	RPG Terrains
	Rayane Félix (RayaneFLX)
	CC-BY-SA 3.0
	https://opengameart.org/content/rpg-terrains`,license:["CC-BY-SA 4.0","CC-BY-SA 3.0"]}]},{author:"zzwerty",authorUrl:"https://freesound.org/people/zzwerty/sounds/315878/",subjects:[{name:"notification.mp3",url:"https://freesound.org/people/zzwerty/sounds/315878/",license:["CC BY-NC 3.0"]}]},{author:"Tobiasz 'unfa' Karoń",authorUrl:"https://freesound.org/people/unfa/",subjects:[{name:"laser.mp3",url:"https://freesound.org/people/unfa/sounds/584191/",license:["CC0"]}]},{author:"Olivier Girardot",authorUrl:"https://freesound.org/people/OGsoundFX/",subjects:[{name:"mortar.wav",url:"https://freesound.org/people/OGsoundFX/sounds/423108/",license:["CC BY 4.0"]}]},{author:"Emin",authorUrl:"https://freesound.org/people/EminYILDIRIM/",subjects:[{name:"explosion.wav",url:"https://freesound.org/people/EminYILDIRIM/sounds/553153/",license:["CC BY 4.0"]}]},{author:"Timo Schmied",authorUrl:"https://freesound.org/people/TimoSchmied/",subjects:[{name:"firework.wav",url:"https://freesound.org/people/TimoSchmied/sounds/530972/",license:["CC BY 4.0"]}]},{author:"FxProSound",authorUrl:"https://freesound.org/people/Robinhood76/",subjects:[{name:"place.wav",url:"https://freesound.org/people/Robinhood76/sounds/254079/",license:["CC BY 4.0"]},{name:"destroy.wav",url:"https://freesound.org/people/Robinhood76/sounds/503554/",license:["CC BY 4.0"]}]},{author:"BMacZero",authorUrl:"https://freesound.org/people/BMacZero/",subjects:[{name:"hit.wav",url:"https://freesound.org/people/BMacZero/sounds/96138/",license:["CC0"]}]},{author:"SamsterBirdies",authorUrl:"https://freesound.org/people/SamsterBirdies/",subjects:[{name:"sonar.wav",url:"https://freesound.org/people/SamsterBirdies/sounds/371178/",license:["CC0"]}]},{author:"doudar41",authorUrl:"https://freesound.org/people/doudar41/",subjects:[{name:"thunder.wav",url:"https://freesound.org/people/doudar41/sounds/535952/",license:["CC0"]}]},{author:"Herkules92",authorUrl:"https://freesound.org/people/Herkules92/",subjects:[{name:"bush.wav",url:"https://freesound.org/people/Herkules92/sounds/518799/",license:["CC0"]}]},{author:"rabbydaw",authorUrl:"https://freesound.org/people/rabbydaw/",subjects:[{name:"drill.wav",url:"https://freesound.org/people/rabbydaw/sounds/504182/",license:["CC0"]}]},{author:"LordForklift",authorUrl:"https://freesound.org/people/LordForklift/",subjects:[{name:"lock.mp3",url:"https://freesound.org/people/LordForklift/sounds/448416/",license:["CC0"]}]},{author:"Brian Kent",subjects:[{name:"Jupiter Crash font",url:"https://www.dafont.com/jupiter-crash.font"}]},{subjects:[{name:"flamethrower.wav",url:"https://freesound.org/people/deleted_user_13668154/sounds/616093/",license:["CC BY-NC 3.0"]},{name:"railgun.mp3",url:"https://freesound.org/people/deleted_user_1941307/sounds/155790/",license:["CC0"]},{name:"tank.wav"}]}],_d=i=>(fe("data-v-0d08cd12"),i=i(),me(),i),Dd={class:"wrapper"},Ld=_d(()=>y("div",{class:"wrapper-top"},[y("h1",null,"Credits")],-1)),Yd={class:"credit"},Od={key:0},Fd=["is","href"],$d={class:"subject"},Xd={class:"subject-name"},Nd=["is","href"],Ud={class:"badge"},zd=["onClick"],Gd={key:0,class:"description",disabled:"",rows:"10",cols:"80"},Hd={class:"wrapper-bottom"},Wd=J({__name:"Credits",props:{onMainMenu:{type:Function}},setup(i){const t=_({}),e=_(null),s=o=>{t.value[o]=!t.value[o]};let n=!1;const r=()=>{n=!0};return pe(()=>{let o,h=0;const l=d=>{if(n||!e.value)return;if(!o){o=d,window.requestAnimationFrame(l);return}const g=d-o;h+=5/g,e.value.scrollTop+=Math.floor(h),h%=1,e.value.scrollTop<e.value.scrollHeight&&(o=d,window.requestAnimationFrame(l))};e.value.addEventListener("wheel",r),window.requestAnimationFrame(l)}),mr(()=>{r&&e.value.removeEventListener("wheel",r)}),(o,h)=>(b(),T("div",Dd,[Ld,y("ul",{class:"credits-list",ref_key:"list",ref:e},[(b(!0),T(ft,null,Lt(P(Rd),(l,d)=>(b(),T("li",Yd,[l.author?(b(),T("h3",Od,[y("a",{is:l.authorUrl?"a":"span",href:l.authorUrl,target:"_blank",rel:"noreferrer noopener"},$(l.author),9,Fd)])):H("",!0),y("ul",null,[(b(!0),T(ft,null,Lt(l.subjects,(g,p)=>(b(),T("li",$d,[y("span",Xd,[y("a",{is:l.authorUrl?"a":"span",href:g.url,target:"_blank",rel:"noreferrer noopener"},$(g.name),9,Nd),(b(!0),T(ft,null,Lt(g.license,v=>(b(),T("span",Ud,$(v),1))),256)),"description"in g?(b(),T("button",{key:0,class:"more-details-button badge",onClick:v=>s(`${d}-${p}`)}," More ",8,zd)):H("",!0)]),t.value[`${d}-${p}`]?(b(),T("textarea",Gd,`
              `+$(g.description)+`
            `,1)):H("",!0)]))),256))])]))),256))],512),y("div",Hd,[y("button",{onClick:h[0]||(h[0]=(...l)=>o.onMainMenu&&o.onMainMenu(...l)),class:"menu-button"},"Main menu")])]))}});const Vd=lt(Wd,[["__scopeId","data-v-0d08cd12"]]);var er=(i=>(i.Menu="menu",i.Game="game",i.Credits="credits",i))(er||{});const jd=J({__name:"App",setup(i){vt.Instance||new vt;const e=new URL(window.location.href).hash.slice(1),s=_(Object.values(er).includes(e)?e:"menu"),n=Gt("settings");(s.value==="menu"||s.value==="credits")&&vs().then(()=>{vt.Instance.updateVolume(((n==null?void 0:n.musicVolume)??66)/100),vt.Instance.queue([X.TitleMusic])});const r=_(),o=_((n==null?void 0:n.difficulty)||N.Easy),h=_((n==null?void 0:n.renderer)||ht),l=_((n==null?void 0:n.showTutorial)||!0),d=_((n==null?void 0:n.simulation)||1),g=(m,M,A,I,Y)=>{s.value="game",r.value=m,o.value=M,h.value=A,l.value=I,d.value=Y,vt.Instance.queue(Fa)},p=()=>{s.value="menu",vt.Instance.queue([X.TitleMusic])},v=()=>{s.value="credits",vt.Instance.queue([X.TitleMusic])};return(m,M)=>(b(),T(ft,null,[s.value=="menu"?(b(),At(Bd,{key:0,onPlay:g,onCredits:v})):H("",!0),s.value=="game"?(b(),At(Ru,{key:1,seed:r.value,difficulty:o.value,renderer:h.value,showTutorial:l.value,initialSpeed:d.value,onMainMenu:p},null,8,["seed","difficulty","renderer","showTutorial","initialSpeed"])):H("",!0),s.value=="credits"?(b(),At(Vd,{key:2,onMainMenu:p})):H("",!0)],64))}});Fi(jd).mount("#app");
