var za=Object.defineProperty;var Wa=(n,t,e)=>t in n?za(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var a=(n,t,e)=>(Wa(n,typeof t!="symbol"?t+"":t,e),e);import{A as Ha,c as Ga,H as Va,d as at,o as x,a as _,t as F,b as ct,u as Y,g as Ke,h as R,j as ja,l as Ka,m as L,q as ee,s as nt,F as At,v as ke,x as ne,y,z as D,B as Yn,C as Ei,D as Ws,G as Pe,I as Ce,J as ge,K as Xn,L as qa,M as hi,N as $n,O as Qa,P as Mt,Q as Ii,R as Za,S as Ja,T as tr}from"./vendor-53da9fa0.js";import{C as Tt,P as as,S as z,A as Ht,s as Pt,a as er,G as rs,T as bi,b as en,U as sr,L as ir,F as nr,c as sn,d as ar,e as Nn,M as rr,f as li,g as or,B as Mi,h as cr,i as hr,j as lr,k as ur}from"./pixi-403abff2.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();let dr=1;class tt{constructor(t,e,s){a(this,"id");a(this,"rotation",0);this.x=t,this.y=e,this.agent=s,this.id=dr++}getX(){return this.x}getAlignedX(){return this.x|0}getY(){return this.y}getAlignedY(){return this.y|0}getAgent(){return this.agent}getId(){return this.id}setX(t){this.x=t}setY(t){this.y=t}getRotation(){return this.rotation}setRotation(t){this.rotation=t}move(t,e,s){const i=(e.getX()-t.getX())*s+t.getX(),r=(e.getY()-t.getY())*s+t.getY();this.setX(i),this.setY(r),this.lookAt(e)}lookAt(t,e){let s,i;e!==void 0?(s=t-this.x,i=e-this.y):(s=t.getX()-this.x,i=t.getY()-this.y),(s||i)&&this.setRotation(Math.atan2(i,s)*180/Math.PI+90)}}const $t=n=>n.constructor.scale,pt=n=>{const t=$t(n),e=n.getTile();return[e.getX()+t/2,e.getY()+t/2]};function ui(n){return n?"getTile"in n:!1}class V extends tt{constructor(t,e,s){super(t,e,s)}getAgent(){return this.agent}}var k=(n=>(n[n.Unknown=0]="Unknown",n[n.Player=1]="Player",n[n.Enemy=2]="Enemy",n))(k||{}),c=(n=>(n[n.None=0]="None",n[n.Tower=1]="Tower",n[n.Slime=2]="Slime",n[n.Base=3]="Base",n[n.Bullet=4]="Bullet",n[n.Wall=5]="Wall",n[n.Mortar=6]="Mortar",n[n.Flamethrower=7]="Flamethrower",n[n.Flame=8]="Flame",n[n.Railgun=9]="Railgun",n[n.Rail=10]="Rail",n[n.ElectricFence=11]="ElectricFence",n[n.Fence=12]="Fence",n[n.Freezer=13]="Freezer",n[n.Tree=14]="Tree",n[n.Pine=15]="Pine",n[n.Cactus=16]="Cactus",n[n.Stump=17]="Stump",n[n.Rock=18]="Rock",n[n.Rock2=19]="Rock2",n[n.Rock3=20]="Rock3",n[n.Radar=21]="Radar",n[n.PowerPlant=22]="PowerPlant",n[n.Blueprint=23]="Blueprint",n[n.Shockwave=24]="Shockwave",n[n.Armory=25]="Armory",n[n.Market=26]="Market",n[n.SpeedBeacon=27]="SpeedBeacon",n[n.Runner=28]="Runner",n[n.DamageBeacon=29]="DamageBeacon",n[n.Laser=30]="Laser",n[n.LaserBeam=31]="LaserBeam",n[n.Flier=32]="Flier",n[n.Tank=33]="Tank",n[n.Rocket=34]="Rocket",n[n.WavePoint=35]="WavePoint",n[n.Barracks=36]="Barracks",n[n.Tesla=37]="Tesla",n[n.Spark=38]="Spark",n[n.Behemoth=39]="Behemoth",n[n.Bore=40]="Bore",n[n.Excavator=41]="Excavator",n[n.Convert=42]="Convert",n[n.Terraform=43]="Terraform",n[n.EmergencyRecharge=44]="EmergencyRecharge",n[n.EmergencyRepair=45]="EmergencyRepair",n))(c||{}),Hs=(n=>(n[n.Simple=0]="Simple",n[n.Pine=1]="Pine",n[n.Cactus=2]="Cactus",n))(Hs||{}),Gs=(n=>(n[n.Rock1=0]="Rock1",n[n.Rock2=1]="Rock2",n[n.Rock3=1]="Rock3",n))(Gs||{});const hs=new Set([3,21,22,25,26,36]),se=new Set([...hs,1,6,7,9,14,15,16,18,19,20,27,29,30,5,37]);var U=(n=>(n[n.Undiscovered=0]="Undiscovered",n[n.Pending=1]="Pending",n[n.Discovered=2]="Discovered",n))(U||{}),f=(n=>(n[n.Void=0]="Void",n[n.Grass=1]="Grass",n[n.Stone=2]="Stone",n[n.Water=3]="Water",n[n.Obstructed=4]="Obstructed",n[n.Wall=5]="Wall",n[n.Spore=6]="Spore",n[n.ElectricFence=7]="ElectricFence",n[n.Fence=8]="Fence",n[n.Freezer=9]="Freezer",n[n.Bridge=10]="Bridge",n[n.Dirt=11]="Dirt",n[n.Snow=12]="Snow",n[n.Sand=13]="Sand",n[n.Ice=14]="Ice",n[n.PlayerBuilding=15]="PlayerBuilding",n[n.Tree=16]="Tree",n[n.Rock=17]="Rock",n[n.Base=18]="Base",n))(f||{}),dt=(n=>(n[n.WaterAlt=19]="WaterAlt",n[n.WaterStill=20]="WaterStill",n[n.GrassFlower=21]="GrassFlower",n[n.GrassAlt=22]="GrassAlt",n[n.GrassPlain=23]="GrassPlain",n[n.SandAlt=24]="SandAlt",n[n.SnowAlt=25]="SnowAlt",n[n.IceAlt=26]="IceAlt",n[n.Static1=27]="Static1",n[n.Static2=28]="Static2",n[n.Static3=29]="Static3",n))(dt||{});const gr={[19]:3,[20]:3,[21]:1,[22]:1,[23]:1,[24]:13,[25]:12,[26]:14,[27]:0,[28]:0,[29]:0},Ti=new Set([1,2,11,13,12]),ks=new Set([...Ti,3,14,10,16,17]),pr=new Set([...ks,9,7,8]),fr={[c.Tower]:4,[c.Wall]:5,[c.Mortar]:4,[c.Flamethrower]:4,[c.Railgun]:4,[c.ElectricFence]:7,[c.Fence]:8,[c.Freezer]:9,[c.Radar]:18,[c.PowerPlant]:18,[c.Tree]:16,[c.Rock]:17,[c.Armory]:18,[c.Base]:18,[c.Market]:18,[c.SpeedBeacon]:4,[c.DamageBeacon]:4,[c.Laser]:4,[c.Barracks]:18,[c.Tesla]:4};class Q{constructor(t,e,s=f.Void){a(this,"staticEntity",null);a(this,"hash");a(this,"actualType");a(this,"type");a(this,"towers",[]);a(this,"linkedAgents");a(this,"discoveryStatus",U.Undiscovered);this.x=t,this.y=e,this.altType=s,this.hash=`[${this.x}, ${this.y}]`,this.type=gr[s]??s,this.actualType=this.type}serialize(){return{x:this.x,y:this.y,type:this.type}}getX(){return this.x}getY(){return this.y}getBaseType(){return this.type}getAltType(){return this.altType}getAnimation(){return this.type===f.Water?[f.Water,dt.WaterAlt,dt.WaterStill]:[this.altType]}getType(){return this.actualType}getStaticEntity(){return this.staticEntity}hasStaticEntity(){return this.staticEntity!==null}setStaticEntity(t){if(t===this.staticEntity)return;if(this.staticEntity!==null)throw new Error("A tile can only have 1 static entity.");const e=t.getAgent();ui(e)&&e.getTile().getHash()===this.getHash()&&(e.updateTile(this),this.linkedAgents&&e.updateLinkedAgents&&e.updateLinkedAgents(this.linkedAgents)),this.staticEntity=t,this.actualType=fr[t.getAgent().getType()]||this.type}clearStaticEntity(){this.staticEntity=null,this.actualType=this.type}isStaticEntityRoot(){var t;return((t=this.staticEntity)==null?void 0:t.getAgent().getTile())===this}addTower(t){this.towers.includes(t)||this.towers.push(t)}setDiscoveryStatus(t){this.discoveryStatus=t}isDiscovered(){return this.discoveryStatus===U.Discovered}getDiscoveryStatus(){return this.discoveryStatus}isCoveredByTower(){return this.isDiscovered()&&this.towers.length>0}removeTower(t){this.towers.splice(this.towers.indexOf(t),1)}getAvailableTowers(){return this.towers.filter(t=>t.getCooldown()<=0)}getTowers(){return this.towers}addLinkedAgent(t){var s;this.linkedAgents||(this.linkedAgents=new Set),this.linkedAgents.add(t);const e=(s=this.staticEntity)==null?void 0:s.getAgent();e&&e.updateLinkedAgents&&e.updateLinkedAgents(this.linkedAgents)}removeLinkedAgent(t){var s;if(!this.linkedAgents)return;this.linkedAgents.delete(t);const e=(s=this.staticEntity)==null?void 0:s.getAgent();ui(e)&&e.updateLinkedAgents&&e.updateLinkedAgents(this.linkedAgents)}getLinkedAgents(){return this.linkedAgents}getHash(){return this.hash}sync(t){this.towers=t.towers,this.discoveryStatus=t.discoveryStatus}}const Je=class{constructor(t,e,s,i){a(this,"level",0);this.difficulty=t,this.base=e,this.surface=s,this.messageFn=i,Je.instance&&Je.instance.cleanup(),Je.instance=this}getSurface(){return this.surface}getBase(){return this.base}getLevel(){return this.level}update(t){this.messageFn=t}getDifficulty(){return this.difficulty}static get Instance(){return this.instance}};let u=Je;a(u,"instance");class ls{constructor(t){a(this,"entity");a(this,"category",k.Unknown);a(this,"hp",30);a(this,"renderData",{});this.tile=t,this.entity=new V(t.getX(),t.getY(),this),this.renderData.subType=Hs.Simple}getType(){return c.Tree}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){this.hp-=t,this.hp<=0&&(this.renderData.chopped=!0,u.Instance.getSurface().despawnStatic(this))}isVisible(){return this.tile.isDiscovered()}}a(ls,"scale",1);class us{constructor(t){a(this,"entity");a(this,"category",k.Unknown);a(this,"hp",30);a(this,"renderData",{});this.tile=t,this.entity=new V(t.getX(),t.getY(),this),this.renderData.subType=Gs.Rock1}getType(){return c.Rock}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return this.tile.isDiscovered()}}a(us,"scale",1);class Un extends us{constructor(t){super(t),this.renderData.subType=Gs.Rock3}getType(){return c.Rock3}}class zn extends ls{constructor(t){super(t),this.renderData.subType=Hs.Cactus}getType(){return c.Cactus}}class Wn extends ls{constructor(t){super(t),this.renderData.subType=Hs.Pine}getType(){return c.Pine}}const mr=(n,t,e)=>{const s=Ha(n),i=Ga(s),r=i(1,0)*193,o=i(0,1)*197,h=.048,l=.0077,p=.0025,g=.0194,d=.039,w=13,S=w*2,I=.1,M=.95,B={top:[],right:[],bottom:[],left:[]};for(let b=0;b<t;b++){let P=0;b<S?P=(S-b)*I:b>t-S&&(P=(S-t+b)*I),B.top[b]=(i(b*d,0)+1+P)*w,B.bottom[b]=(i(b*d,e*d)+1+P)*w}for(let b=0;b<e;b++){let P=0;b<S?P=(S-b)*I:b>e-S&&(P=(S-e+b)*I),B.right[b]=(i(t*d,b*d)+1+P)*w,B.left[b]=(i(0,b*d)+1+P)*w}return(b,P)=>{if(P<B.top[b]||P>e-B.bottom[b]||b<B.left[P]||b>t-B.right[P])return new Q(b,P,f.Void);const X=b+r,rt=P+o,kt=i(X*h,rt*h),ce=i(X*p,rt*p),Vt=Math.abs(ce),fs=i(X*l,rt*l),Js=1-Math.abs(fs),ms=i(X*g,rt*g),tn=Math.abs(ms),ft=(ce+ms/3)*.83,ys=ft+Vt*9241%1/3,Na=Js>M+ft/10,Ua=Js+kt/3+ms-.4>M+ft/2;if(Na||Ua)return ce+Vt*1811%1/7<-.6?new Q(b,P,Vt*1439%1>.5?f.Ice:dt.IceAlt):new Q(b,P,f.Water);if(Js>M+ft/15)return new Q(b,P,f.Dirt);let mt;if(ft>.3)mt=new Q(b,P,ft*1439%1>.3?f.Sand:dt.SandAlt);else if(ft<-.5)mt=new Q(b,P,ft*-1439%1>.3?f.Snow:dt.SnowAlt);else{const jt=Math.abs(ft)*4999%1;mt=new Q(b,P,jt<.05?dt.GrassFlower:jt<.1?dt.GrassAlt:jt<.6?dt.GrassPlain:f.Grass)}const ti=(ms+.5)*(kt-.5)+Vt*5419%1/10;if(ti<.07&&ti>.04&&ys>-.4&&ys<.6){const jt=ft>.3?new zn(mt):ft<-.4||ti<.045?new Wn(mt):new ls(mt);mt.setStaticEntity(jt.entity)}else if((ys<-.5||ys>.7)&&tn*2791%1>.99){const jt=tn>.5?new us(mt):new Un(mt);mt.setStaticEntity(jt.entity)}return mt}};var E=(n=>(n[n.StatUpdate=0]="StatUpdate",n[n.SurfaceChange=1]="SurfaceChange",n[n.BlackOut=2]="BlackOut",n[n.OpenBuildMenu=3]="OpenBuildMenu",n[n.CloseBuildMenu=4]="CloseBuildMenu",n[n.SelectPlaceable=5]="SelectPlaceable",n[n.ToggleShowCoverage=6]="ToggleShowCoverage",n[n.StartWave=7]="StartWave",n[n.EndWave=8]="EndWave",n[n.Unlock=9]="Unlock",n[n.Discover=10]="Discover",n[n.Spawn=11]="Spawn",n[n.Buy=12]="Buy",n[n.Sell=13]="Sell",n[n.HitBase=14]="HitBase",n[n.Lose=15]="Lose",n[n.Kill=16]="Kill",n[n.Pierce=17]="Pierce",n[n.Bomb=18]="Bomb",n[n.Stun=19]="Stun",n))(E||{}),Ps=(n=>(n[n.Base=0]="Base",n[n.Radar=1]="Radar",n))(Ps||{});const Ni=class{constructor(){a(this,"eventHandlers");Ni.instance=this,this.eventHandlers=new Map}addEventListener(t,e){return this.eventHandlers.has(t)?this.eventHandlers.get(t).add(e):this.eventHandlers.set(t,new Set([e])),()=>this.removeEventListener(t,e)}addEventListeners(t,e){const s=t.map(i=>this.addEventListener(i,e));return()=>s.forEach(i=>i())}removeEventListener(t,e){var s;(s=this.eventHandlers.get(t))==null||s.delete(e)}triggerEvent(t,...e){var s;(s=this.eventHandlers.get(t))==null||s.forEach(i=>i(...e))}static get Instance(){return this.instance}};let A=Ni;a(A,"instance");const Fs=class{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"hp",50);a(this,"renderData",{});this.tile=t,this.entity=new V(t.getX(),t.getY(),this)}spawn(){u.Instance.getSurface().getAdjacentTiles(this.tile,Fs.scale).forEach(t=>t.addLinkedAgent(this))}despawn(){u.Instance.getSurface().getAdjacentTiles(this.tile,Fs.scale).forEach(t=>t.removeLinkedAgent(this))}getType(){return c.DamageBeacon}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}};let Ie=Fs;a(Ie,"scale",2);const Ys=class{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"hp",50);a(this,"renderData",{});this.tile=t,this.entity=new V(t.getX(),t.getY(),this)}spawn(){u.Instance.getSurface().getAdjacentTiles(this.tile,Ys.scale).forEach(t=>t.addLinkedAgent(this))}despawn(){u.Instance.getSurface().getAdjacentTiles(this.tile,Ys.scale).forEach(t=>t.removeLinkedAgent(this))}getType(){return c.SpeedBeacon}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}};let be=Ys;a(be,"scale",2);function di(n){return"getCooldown"in n}const yr=n=>n.constructor.range,_e=(n,t,e)=>{const s=u.Instance.getSurface(),i=new Set,r=()=>{const l=s.getEntityTiles(n),p=new Set(l);s.forCircle(n.entity.getX()+1,n.entity.getY()+1,t,g=>{let d;g.getX()<=n.entity.getAlignedX()?g.getY()<=n.entity.getAlignedY()?d=l[0]:d=l[2]:g.getY()<=n.entity.getAlignedY()?d=l[1]:d=l[3],s.forLine(d.getX(),d.getY(),g.getX(),g.getY(),w=>{if(w.addTower(n),i.add(w),!p.has(w)&&e&&e(w))return!1},{connected:!0})},{edgeOnly:!0})};let o=!0;const h=A.Instance.addEventListener(E.SurfaceChange,({affectedTiles:l})=>{if(o){o=!1,r();return}for(const p of l)if(i.has(p)){i.forEach(g=>g.removeTower(n)),i.clear(),r();return}});return[()=>{i.forEach(l=>l.removeTower(n)),h()},i]},Be=n=>{let t=1;return n.forEach(e=>{e instanceof be&&(t+=.5)}),t},Re=n=>{let t=1;return n.forEach(e=>{e instanceof Ie&&(t+=.5)}),t},Hn=[[1,0],[-1,0],[0,1],[0,-1]],wr=[...Hn,[1,1],[-1,-1],[-1,1],[1,-1]],ts=class{constructor(t,e){a(this,"tileBufferSize");this.buffer=t,this.staticEntityConstructor=e,this.tileBufferSize=this.withEntities?2:1}get width(){return this.buffer[0]}get height(){return this.buffer[1]}get withEntities(){return this.buffer[2]}getTile(t){const e=ts.propertyCount+t*this.tileBufferSize,s=new Q(t%this.width,Math.floor(t/this.width),this.buffer[e]);if(this.withEntities&&this.staticEntityConstructor){const i=this.staticEntityConstructor(this.buffer[e+1],s);i&&s.setStaticEntity(i)}return s}static serializeSurface(t,e){const s=e?2:1,i=new Uint8Array(ts.propertyCount+t.map.length*s);i[0]=t.getWidth(),i[1]=t.getHeight(),i[2]=e?1:0;for(let r=0;r<t.map.length;r++){const o=t.map[r],h=r*s+ts.propertyCount;if(i[h]=e?o.getAltType():o.getType(),e){const l=o.hasStaticEntity()&&o.getStaticEntity().getAgent().getTile()===o?o.getStaticEntity().getAgent():null;i[h+1]=(l==null?void 0:l.getType())??c.None}}return i}};let Yt=ts;a(Yt,"propertyCount",3);class Gn{constructor(t){a(this,"map");a(this,"entities",[]);a(this,"deletedEntities",[]);a(this,"tickingEntities",[]);a(this,"entitiesMap",new Map);a(this,"towers",new Set);a(this,"width");a(this,"height");a(this,"dirty",!1);a(this,"_version",0);a(this,"changedTiles",new Set);a(this,"addedAgents",new Set);a(this,"removedAgents",new Set);a(this,"initialized",!1);this.width=t.width,this.height=t.height;const e=t instanceof Yt?t:t.generate;this.initialize(e??((s,i)=>new Q(s,i))),this.initialized=!0}serialize(t){return new Yt(Yt.serializeSurface(this,t))}initialize(t){this.entities=[],this.deletedEntities=[],this.entitiesMap.clear(),Object.values(k).filter(s=>typeof s!="string").forEach(s=>this.entitiesMap.set(s,new Set)),this.map=new Array(this.width*this.height);const e=[];if(t instanceof Yt)for(let s=0;s<this.map.length;s++){const i=t.getTile(s);this.map[s]=i,i.hasStaticEntity()&&e.push(i.getStaticEntity())}else for(let s=0;s<this.height;s++)for(let i=0;i<this.width;i++){const r=t(i,s);this.map[s*this.width+i]=r,r.hasStaticEntity()&&e.push(r.getStaticEntity())}for(let s of e)this.spawnStatic(s.getAgent())}getTile(t,e,s=!1){return t>=this.width||t<0||e>=this.height||e<0?s?this.getTile(Math.max(Math.min(t,this.width-1),0),Math.max(Math.min(e,this.height-1),0)):void 0:this.map[e*this.width+t]}getEntityTiles(t,e,s){let i;if(e!==void 0)i=t;else{const r=t;i=r.getTile().getX(),e=r.getTile().getY(),s=$t(r)}switch(s){case 1:return[this.map[e*this.width+i]];case 2:return[this.map[e*this.width+i],this.map[e*this.width+i+1],this.map[(e+1)*this.width+i],this.map[(e+1)*this.width+i+1]];default:throw new Error("Unsupported agent scale!")}}getAdjacentTiles(t,e=1,s=!1){return(s?wr:Hn).map(([i,r])=>this.getTile(t.getX()+i*e,t.getY()+r*e)).filter(i=>!!i)}setTile(t){this.setTileInternal(t)}setTiles(t){t.map(e=>this.setTileInternal(e))}setTileInternal(t){this.dirty=!0,this._version++;const e=this.map[t.getY()*this.width+t.getX()];return e.hasStaticEntity()&&!t.hasStaticEntity()?t.setStaticEntity(e.getStaticEntity()):e.hasStaticEntity()&&this.despawnStatic(e.getStaticEntity().getAgent()),t.sync(e),this.map[t.getY()*this.width+t.getX()]=t,this.changedTiles.add(e),e}processChangedTiles(){this.changedTiles.size&&(A.Instance.triggerEvent(E.SurfaceChange,{affectedTiles:this.changedTiles,addedStaticAgents:this.addedAgents,removedStaticAgents:this.removedAgents}),this.changedTiles.clear(),this.addedAgents.clear(),this.removedAgents.clear())}getRow(t){const e=t*this.width;return this.map.slice(e,e+this.width)}getColumn(t){const e=new Array(this.height);for(let s=0;s<this.height;s++)e[s]=this.getTile(t,s);return e}getWidth(){return this.width}getHeight(){return this.height}forLine(t,e,s,i,r,o){const h=(o==null?void 0:o.scale)??1;t=Math.floor(t/h)*h,e=Math.floor(e/h)*h,s=Math.floor(s/h)*h,i=Math.floor(i/h)*h;const l=Math.atan2(i-e,s-t);return this.forRay(t,e,l,(p,g)=>!(r(p,g)===!1)&&!(p.getX()===s&&p.getY()===i),o)}forRay(t,e,s,i,r){const o=(r==null?void 0:r.connected)??!1,h=(r==null?void 0:r.scale)??1,l=Math.cos(s),p=Math.sin(s),g=Math.abs(l)+Math.abs(p);let d=Math.abs(l/g),w=Math.abs(p/g),S=(1+(d>w?w/d:d/w))*h;d*=S*Math.sign(l),w*=S*Math.sign(p);let I,M,B=0;for(;;){let O=!1;const b=Math.round(t/h)*h;let P=Math.round(e/h)*h;o&&I!==void 0&&Math.round(I/h)*h!==b&&Math.round(M/h)*h!==P&&(P=Math.round(M),O=!0);const X=this.getTile(b,P);if(!X||!i(X,B))break;O||(t+=d,e+=w),I=b,M=P,B++}}forRect(t,e,s,i,r,o){const h=(o==null?void 0:o.scale)??1;t=Math.floor(t/h)*h,e=Math.floor(e/h)*h,s=Math.floor(s/h)*h,i=Math.floor(i/h)*h;const l=(g,d)=>{const w=this.getTile(g,d);w&&r(w)},p=g=>{if(s>t)for(let d=t;d<=s;d+=h)l(d,g);else for(let d=t;d>=s;d-=h)l(d,g)};if(i>e)for(let g=e;g<=i;g+=h)p(g);else for(let g=e;g>=i;g-=h)p(g)}forCircle(t,e,s,i,r){const o=(r==null?void 0:r.edgeOnly)??!1,h=(r==null?void 0:r.scale)??1;t=Math.floor(t/h),e=Math.floor(e/h);let l=s/2;const p=l*l,g=(l-1)*(l-1),d=(w,S,I=0)=>{const M=w+I,B=S+I,O=M*M+B*B;if(O<p&&!(o&&O<g)){const b=this.getTile((t+w)*h,(e+S)*h,o);b&&i(b)}};if(s%2===0)for(let w=-l;w<l;w+=1)for(let S=-l;S<l;S+=1)d(S,w,.5);else{l=l|0;for(let w=-l;w<l+1;w+=1)for(let S=-l;S<l+1;S+=1)d(S,w)}}spawn(t){this.entities.push(t.entity),this.entitiesMap.get(t.category).add(t.entity),t.tick?this.tickingEntities.push(t.entity):this.dirty=!0,t.spawn&&this.initialized&&t.spawn()}spawnStatic(t){this.getEntityTiles(t).forEach(s=>{s.setStaticEntity(t.entity),this.changedTiles.add(s)}),this.addedAgents.add(t),this.spawn(t),this.dirty=!0,di(t)&&yr(t)>1&&this.towers.add(t)}despawn(t){const e=this.entities.indexOf(t.entity);e>=0&&(this.entities.splice(e,1),t.tick&&this.tickingEntities.splice(this.tickingEntities.indexOf(t.entity),1));const s=this.entitiesMap.get(t.category).delete(t.entity);return this.deletedEntities.push(t.entity),t.despawn&&t.despawn(),s}despawnStatic(t){this.getEntityTiles(t).forEach(s=>{s.clearStaticEntity(),this.changedTiles.add(s)}),this.removedAgents.add(t),this.despawn(t),this.dirty=!0,di(t)&&this.towers.delete(t)}getEntities(){return this.entities}getTickingEntities(){return this.tickingEntities}getEntitiesForCategory(t){return this.entitiesMap.get(t)}getDeletedEntities(){return this.deletedEntities}getTowers(){return this.towers}getTiles(){return this.map}markPristine(){this.dirty=!1,this.deletedEntities=[]}forceRerender(){this.dirty=!0}isDirty(){return this.dirty}get version(){return this._version}}const De=(n,t)=>{const e=[],s=$t(n),i=s===2?1:0;u.Instance.getSurface().forCircle(n.getTile().getX()+i,n.getTile().getY()+i,t*s,r=>{var o;if(ks.has(r.getBaseType())){const h=(o=r.getStaticEntity())==null?void 0:o.getAgent();h&&h.category!==k.Player&&(u.Instance.getSurface().despawnStatic(h),h.getType()===c.Tree&&(h.renderData.chopped=!0));const l=new Q(r.getX(),r.getY(),f.Stone);e.push(l)}}),u.Instance.getSurface().setTiles(e)};class xi{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"renderData",{});this.tile=t,this.entity=new V(t.getX(),t.getY(),this)}spawn(){u.Instance.getBase().addPart(this),De(this,3)}despawn(){u.Instance.getBase().removePart(this)}getType(){return c.Armory}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){u.Instance.getBase().hit(t)}isVisible(){return!0}}a(xi,"scale",2);const vr=.625;class Cs{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"isEnabled",!0);a(this,"renderData",{});this.tile=t,this.entity=new V(t.getX(),t.getY(),this),t.addTower(this)}getCooldown(){return this.isEnabled?0:1}fire(t,e){if(!u.Instance.consumeContinuous(this,e))return 0;const s=vr*e;return t.AI.hit(s),s}despawn(){this.tile.removeTower(this)}getType(){return c.ElectricFence}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.isEnabled=!1}isVisible(){return!0}isSpeedBoosted(){return!1}isDamageBoosted(){return!1}}a(Cs,"scale",1),a(Cs,"range",1);class Ai{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"renderData",{});this.tile=t,this.entity=new V(t.getX(),t.getY(),this)}getType(){return c.Fence}getTile(){return this.tile}updateTile(t){this.tile=t}isVisible(){return!0}}a(Ai,"scale",1);class ki{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"renderData",{});this.tile=t,this.entity=new V(t.getX(),t.getY(),this)}spawn(){const t=[];u.Instance.getSurface().getEntityTiles(this).forEach(e=>{t.push(new Q(e.getX(),e.getY(),f.Freezer))}),u.Instance.getSurface().setTiles(t)}despawn(){const t=u.Instance.getSurface().getEntityTiles(this).map((e,s)=>new Q(e.getX(),e.getY(),f.Dirt));u.Instance.getSurface().setTiles(t)}getType(){return c.Freezer}getTile(){return this.tile}updateTile(t){this.tile=t}isVisible(){return!0}}a(ki,"scale",2);class Pi{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"renderData",{});this.tile=t,this.entity=new V(t.getX(),t.getY(),this)}spawn(){u.Instance.getBase().addPart(this),De(this,3)}despawn(){u.Instance.getBase().removePart(this)}getType(){return c.Market}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){u.Instance.getBase().hit(t)}isVisible(){return!0}}a(Pi,"scale",2);class Ci{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"renderData",{});this.tile=t,this.entity=new V(t.getX(),t.getY(),this)}getType(){return c.PowerPlant}getTile(){return this.tile}updateTile(t){this.tile=t}spawn(){u.Instance.getBase().addPart(this),De(this,3)}despawn(){u.Instance.getBase().removePart(this)}hit(t){u.Instance.getBase().hit(t)}isVisible(){return!0}}a(Ci,"scale",2);const Sr=n=>"AI"in n;var T=(n=>(n[n.Normal=0]="Normal",n[n.OnFire=1]="OnFire",n[n.Stunned=2]="Stunned",n))(T||{});class Er{constructor(t){a(this,"isBlocking",!0);this.index=t}isCleared(t,e){const s=t[this.index];return e.getScale()===1?!s.hasStaticEntity()||!se.has(s.getStaticEntity().getAgent().getType()):!u.Instance.getSurface().getEntityTiles(s.getX(),s.getY(),e.getScale()).some(i=>i.hasStaticEntity()&&se.has(i.getStaticEntity().getAgent().getType()))}process(t,e,s){if(e.getScale()===1){e.AI.attack(t[this.index].getStaticEntity().getAgent());return}const i=u.Instance.getSurface().getEntityTiles(t[this.index].getX(),t[this.index].getY(),e.getScale());for(let r of i)if(!(!r.hasStaticEntity()||!se.has(r.getStaticEntity().getAgent().getType()))){e.AI.attack(r.getStaticEntity().getAgent());return}}}const Le=(n=1,t=se)=>e=>{const s=u.Instance.getSurface(),i=[];for(let r=0;r<e.length;r++){const o=s.getEntityTiles(e[r].getX(),e[r].getY(),n);for(let h of o)if(h.hasStaticEntity()&&t.has(h.getStaticEntity().getAgent().getType())){i.push(new Er(r));break}}return i},os=(n,t)=>({...n,...t}),Oe={[f.Grass]:3,[f.Water]:20,[f.Stone]:4,[f.Wall]:3,[f.Spore]:2,[f.ElectricFence]:5,[f.Fence]:20,[f.Freezer]:6,[f.Obstructed]:3,[f.Bridge]:5,[f.Dirt]:2.5,[f.Sand]:3.5,[f.Snow]:3.5,[f.Ice]:10,[f.PlayerBuilding]:3,[f.Tree]:5,[f.Rock]:5,[f.Base]:Number.EPSILON},Fe={[f.Fence]:5,[f.ElectricFence]:40,[f.Wall]:500,[f.Freezer]:.5,[f.Obstructed]:500,[f.PlayerBuilding]:-10},Ir={[f.Grass]:3,[f.Water]:3,[f.Stone]:3,[f.Wall]:3,[f.Spore]:3,[f.ElectricFence]:3,[f.Fence]:3,[f.Freezer]:3,[f.Obstructed]:3,[f.Bridge]:3,[f.Dirt]:3,[f.Sand]:3,[f.Snow]:3,[f.Ice]:3,[f.PlayerBuilding]:3,[f.Tree]:3,[f.Rock]:3,[f.Base]:Number.EPSILON},br={[f.Fence]:3,[f.ElectricFence]:3,[f.Wall]:5,[f.Tree]:4,[f.Rock]:3,[f.Obstructed]:5,[f.PlayerBuilding]:-10},Z=600;class Ye{constructor(t,e,s=Z){a(this,"predictedHp");a(this,"cooldown",0);a(this,"visibilities",[]);a(this,"maxHp");a(this,"callback");this.enemy=t,this.hp=e,this.attackSpeed=s,this.predictedHp=e,this.maxHp=e;const i=u.Instance.getSurface();this.visibilities=t.getPath().getTiles().map(r=>t.getScale()===1?r.isDiscovered():i.getEntityTiles(r.getX(),r.getY(),t.getScale()).some(o=>o.isDiscovered()))}tick(t){if(this.cooldown<t&&this.callback&&(this.callback(),this.callback=void 0),this.cooldown=Math.max(0,this.cooldown-t),this.enemy.getPath().isPaused(this.enemy)&&!this.isBusy()){const e=this.enemy.getPath().getCurrentTile();this.enemy.entity.setX(e.getX()),this.enemy.entity.setY(e.getY());const s=this.enemy.getPath().getNextCheckpoint();s&&s.process(this.enemy.getPath().getTiles(),this.enemy,t)}if(this.isBusy())this.getTargeted(this.enemy.getPath().getCurrentTile(),t);else{this.isVisible()||this.enemy.getPath().fastForward(this.enemy);const{from:e,to:s,step:i}=this.enemy.getPath().performStep(this.enemy,t);this.enemy.entity.move(e??s,s,i),e&&this.getTargeted(e,t)}}attack(t){t.hit&&this.cooldown===0&&(this.callback=()=>{t.hit(this.enemy.getDamage()*u.Instance.getDamageMultiplier())},this.cooldown=this.isVisible()?this.attackSpeed:0)}interact(t,e=this.attackSpeed){this.callback=t,this.cooldown===0&&this.isVisible()&&(this.cooldown=e)}cancel(){this.cooldown=0,this.callback=void 0}getTargeted(t,e){if(this.predictedHp>0&&this.isVisible()){if(this.enemy.getScale()===1){for(let i of t.getAvailableTowers())if(this.predictedHp-=i.fire(this.enemy,e),this.predictedHp<=0)return;return}const s=u.Instance.getSurface().getEntityTiles(t.getX(),t.getY(),this.enemy.getScale());for(let i of s)for(let r of i.getAvailableTowers())if(this.predictedHp-=r.fire(this.enemy,e),this.predictedHp<=0)return}}hit(t){this.hp-=t,this.hp<this.predictedHp&&(this.predictedHp=this.hp),this.hp<=0&&u.Instance.despawnEnemy(this.enemy)}miss(t){this.predictedHp+=t}isAttacking(){return this.cooldown!==0}isBusy(){return this.isAttacking()||this.enemy.getStatus()===T.Stunned}getFuturePosition(t){const e=this.enemy.getPath().getFuturePosition(t),s=this.enemy.getPath().getCheckpoints();for(let i=0;i<s.length;i++){let r=s[i];if(r.index>e)return e;if(r.isBlocking)return r.index-1}return e}isVisible(){return this.visibilities[this.enemy.getPath().getIndex()|0]??!0}getHpPercent(){return this.hp/this.maxHp}}const Vs=new Set(se);Vs.delete(c.Tree);Vs.delete(c.Pine);Vs.delete(c.Cactus);const Mr=Le(1,Vs),Tr=3e3,xr=1e3,Ar=.01,kr=.025,Pr=30;var vt;let ie=(vt=class{constructor(t,e){a(this,"entity");a(this,"category",k.Enemy);a(this,"status",T.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new tt(t.getX(),t.getY(),this),this.ai=new Ye(this,Pr)}initializePath(){this.path.setSpeed(kr),this.path.setCheckpoints(Mr(this.path.getTiles()))}get AI(){return this.ai}getDamage(){return 4}getType(){return vt.type}getScale(){return vt.scale}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status!==T.Normal&&(this.statusDuration-=t,this.statusDuration<=0?this.status=T.Normal:this.status===T.OnFire&&this.ai.hit(Ar*t)),this.ai.tick(t)}isVisible(){return this.ai.isVisible()}lightOnFire(){this.status=T.OnFire,this.statusDuration=Tr}stun(){this.status=T.Stunned,this.statusDuration=xr}getOffsetX(){return this.entity.getX()}getOffsetY(){return this.entity.getY()}},a(vt,"pathCosts",os(Oe,{[f.Tree]:3})),a(vt,"pathMultipliers",os(Fe,{[f.Water]:2})),a(vt,"type",c.Runner),a(vt,"cost",5),a(vt,"scale",1),vt);class _t{constructor(t,e,s,i,r,o=[]){a(this,"index",0);a(this,"sectionIndex",0);a(this,"tileSet");this.pathfinder=t,this.tiles=e,this.sections=s,this.speed=i,this.costs=r,this.checkpoints=o,this.tileSet=new Set(e)}performStep(t,e){const s=this.index%1,i=this.index|0,r=this.tiles[i],o=this.speed*e/(this.costs[i]??1);let h=this.index+o|0;i===h&&h++,h>=this.tiles.length-1&&(h=this.tiles.length-1);const l=this.tiles[h];for(;this.checkpoints.length>0;){const g=this.checkpoints[0];if(g&&h>=g.index)if(g.isCleared(this.tiles,t))this.checkpoints.shift();else return this.index=g.index-1,{from:this.tiles[this.index],to:l,step:0};else break}const p=this.costs[h]??1;for(this.index=Math.min(this.index+this.speed*e/p,this.tiles.length-1);this.index>this.sections[this.sectionIndex].to;)this.sectionIndex++;return{from:r,to:l,step:s}}getFuturePosition(t){let e=this.index,s=this.sectionIndex;for(;t>0;){const i=this.sections[s],r=i.to-e,o=r/this.speed*i.cost;if(t>o?(e+=r,s++,t-=o):(e+=r*t/o,t=0),e>=this.tiles.length-1)return this.tiles.length-1}return e}fastForward(t){let e=this.checkpoints[0];for(let s=(this.index|0)+1;s<this.tiles.length;s++){if(e&&s>=e.index)if(e.isCleared(this.tiles,t))this.checkpoints.shift(),e=this.checkpoints[0];else break;if(this.getTile(s).isDiscovered())break;this.index=s}}clone(){return new _t(this.pathfinder,this.tiles,this.sections,this.speed,this.costs,[...this.checkpoints])}slice(t=0,e=Number.MAX_VALUE){const s=this.tiles.slice(t,e),i=this.costs.slice(t,e),r=_t.calculateSections(s,i),o=this.checkpoints.filter(h=>h.index>=t&&h.index<e);return new _t(this.pathfinder,s,r,this.speed,i,o)}setIndex(t){this.index=Math.max(Math.min(t,this.tiles.length-1),0),this.sectionIndex=this.sections.findIndex(({from:e,to:s})=>this.index>=e&&this.index<s)}getIndex(){return this.index}getTile(t=this.index){return this.tiles[t|0]}getTiles(){return this.tiles}getLength(){return this.tiles.length}getCoordinates(t=this.index){if(t>=this.tiles.length-1){const r=this.tiles[this.tiles.length-1];return{x:r.getX(),y:r.getY()}}const e=t%1,s=this.tiles[t|0],i=this.tiles[(t|0)+1];return{x:(i.getX()-s.getX())*e+s.getX(),y:(i.getY()-s.getY())*e+s.getY()}}getSpeed(){return this.speed}setSpeed(t){this.speed=t}isDone(){return this.index===this.tiles.length-1}isPaused(t){if(this.isDone())return!0;const e=this.getNextCheckpoint();return e&&e.index===this.index+1&&!e.isCleared(this.tiles,t)}getNextCheckpoint(){return this.checkpoints[0]||null}getCheckpoints(){return this.checkpoints}setCheckpoints(t){this.checkpoints=t}getCurrentTile(){return this.index<0?this.tiles[0]:this.tiles[this.index|0]}getScale(){return this.pathfinder.scale}recompute(){const t=this.pathfinder.getSurface();let e;for(let s=0;s<this.tiles.length;s++){const i=this.tiles[s],r=t.getTile(i.getX(),i.getY());this.tiles[s]=r,this.costs[s]=this.pathfinder.getCost(r,e)??1,e=r,i!==r&&(this.tileSet.delete(i),this.tileSet.add(r))}this.sections=_t.calculateSections(this.tiles,this.costs)}isAffectedByTiles(t){for(let e of t)if(this.tileSet.has(e))return!0;return!1}static calculateSections(t,e){return t.reduce((s,i,r)=>{const o=s[s.length-1],h=e[r];return o?(o.cost===h?o.to++:s.push({from:r,to:r+1,cost:h}),s):[{from:r,to:r+1,cost:h}]},[])}static fromTiles(t,e,s=1){const i=new _t(t,e,[],s,[]);return i.recompute(),i}static fromMapAndCosts(t,e,s,i,r=1){let o=s;const h=[o];for(;o!==e;)o=i.get(o.getHash()),h.push(o);return this.fromTiles(t,h.reverse(),r)}static fromPaths(t,e){const s=e.map(l=>l.getTiles()),i=e.map(l=>l.getCheckpoints()),r=s[0],o=i[0];for(let l=1;l<s.length;l++){const p=s[l];if(r[r.length-1]!==p[0])throw new Error("Cannot merge paths because they don't start and end at the same point");const g=i[l].filter(d=>d.index!==0);g.forEach(d=>d.index+=r.length),o.push(...g),p.shift(),r.push(...p)}const h=_t.fromTiles(t,r,e[0].getSpeed());return h.setCheckpoints(o),h}}function Cr(){return new Worker("/open-td/assets/worker-2feaf3b7.js")}class _r{constructor(t,e,s){a(this,"paths");a(this,"promise");a(this,"worker");this.pathfinder=t,this.startPoints=e,this.target=s}getPaths(){return this.paths?this.paths:(this.promise||this.createPromise(),[])}getAsyncPaths(){return this.promise||this.createPromise(),this.promise}getPathsSync(){if(!this.paths){const t=this.startPoints.map(s=>this.pathfinder.getSurface().getTile(s.getX(),s.getY())),e=this.pathfinder.getSurface().getTile(this.target.getX(),this.target.getY());this.paths=this.pathfinder.getHivePath(t,e).filter(s=>!!s)}return this.promise=Promise.resolve(this.paths),this.paths}createPromise(){this.promise=new Promise(t=>{const e=this.pathfinder.getSurface(),i={buffer:Yt.serializeSurface(e,!1).buffer,costs:this.pathfinder.costs,costMultiplier:this.pathfinder.costMultipliers,scale:this.pathfinder.scale,startPoints:this.startPoints.map(r=>r.serialize()),target:this.target.serialize()};this.worker=new Cr,this.worker.postMessage(i,[i.buffer]),this.worker.onmessage=({data:r})=>{this.paths=r.map(o=>_t.fromTiles(this.pathfinder,o.map(({x:h,y:l})=>e.getTile(h,l)))),this.worker&&(this.worker.terminate(),this.worker=void 0),t(this.paths)}})}update(){this.paths=void 0,this.promise=void 0,this.worker&&(this.worker.terminate(),this.worker=void 0)}}const Br=[[0,-1],[-1,0],[1,0],[0,1],[-1,-1],[1,-1],[-1,1],[1,1]],Rr=150;class Dr{constructor(t,e=Fe,s=Oe,i=1){a(this,"neighbors");a(this,"computedCosts");a(this,"computedMultipliers");a(this,"scaledWidth");a(this,"scaledHeight");a(this,"computedVersion",-1);this.surface=t,this.costMultipliers=e,this.costs=s,this.scale=i,this.neighbors=Br.map(([r,o])=>[r*i,o*i])}getPath(t,e,s){this.computedVersion!==this.surface.version&&this.computeCosts(),t=this.surface.getTile(Math.floor(t.getX()/this.scale)*this.scale,Math.floor(t.getY()/this.scale)*this.scale),e=this.surface.getTile(Math.floor(e.getX()/this.scale)*this.scale,Math.floor(e.getY()/this.scale)*this.scale);const i=s?S=>s(this.computedMultipliers[this.getIndex(S)],S):S=>this.computedMultipliers[this.getIndex(S)],r=new Set,h=(this.computedCosts[this.getIndex(t)]??1)*i(t),l=new Map;l.set(t.getHash(),h);const p=new Map;p.set(t.getHash(),h);const g=new Map;g.set(t.getHash(),h+this.heuristic(t,e));const d=new Va((S,I)=>(g.get(S.getHash())??1/0)-(g.get(I.getHash())??1/0));d.push(t);const w=new Map;for(;!d.empty();){let S=d.pop();if(e===S)return _t.fromMapAndCosts(this,t,e,w);const I=S.getHash(),M=this.neighbors.map(([O,b])=>this.surface.getTile(O+S.getX(),b+S.getY())),B=[];this.setCostAndMultiplier(0,B,i,M[0]),this.setCostAndMultiplier(1,B,i,M[1]),this.setCostAndMultiplier(2,B,i,M[2]),this.setCostAndMultiplier(3,B,i,M[3]),this.setDiagonalCostAndMultiplier(4,0,1,B,i,M[4]),this.setDiagonalCostAndMultiplier(5,0,2,B,i,M[5]),this.setDiagonalCostAndMultiplier(6,1,3,B,i,M[6]),this.setDiagonalCostAndMultiplier(7,2,3,B,i,M[7]),M.forEach((O,b)=>{if(!O)return;const P=B[b*2];if(!P||r.has(O))return;const X=O.getHash(),rt=p.get(I)+B[b*2+1];if(rt<(p.get(X)??1/0)){const kt=l.get(I)+P;l.set(X,kt),w.set(X,S),p.set(X,rt),g.set(X,rt+this.heuristic(O,e)),d.push(O),r.add(S)}})}}getHivePath(t,e){const s={},i=(r,o)=>(s[o.getHash()]??1)*r;return t.reduce((r,o,h)=>{const l=this.getPath(o,e,i);return r.push(l),l&&t.length>h-1&&l.getTiles().forEach(p=>{p.hasStaticEntity()&&(s[p.getHash()]=.85),s[p.getHash()]=s[p.getHash()]+.1||1.1}),r},[])}getWaypointPath(t){const e=[];for(let s=0;s<t.length-1;s++)e.push(this.getPath(t[s],t[s+1]));return _t.fromPaths(this,e)}getCost(t,e){this.computedVersion!==this.surface.version&&this.computeCosts();const s=this.computedCosts[this.getIndex(t)];if(!e)return s;const i=this.computedCosts[this.getIndex(e)];if(!s||!i)return null;const r=(s+i)/2;return!s||!i||t.getX()===e.getX()||t.getY()==e.getY()?r:r+(this.computedCosts[(e.getY()/this.scale|0)*this.scaledWidth+(t.getX()/this.scale|0)]+this.computedCosts[(t.getY()/this.scale|0)*this.scaledWidth+(e.getX()/this.scale|0)])/4}getSurface(){return this.surface}heuristic(t,e){return Math.abs(t.getX()-e.getX())+Math.abs(t.getY()-e.getY())}setCostAndMultiplier(t,e,s,i){if(!i)return;const r=this.computedCosts[this.getIndex(i)];r&&(e[t*2]=r,e[t*2+1]=r*s(i))}setDiagonalCostAndMultiplier(t,e,s,i,r,o){if(!o||!i[e*2]||!i[s*2])return;const h=i[e*2+1]+i[s*2+1];if(h>Rr)return;const l=this.computedCosts[this.getIndex(o)];l&&(i[t*2]=l+(i[e*2]+i[s*2])/4,i[t*2+1]=l*r(o)+h/4)}computeCosts(){this.computedVersion=this.surface.version;const t=this.scale**2;this.scaledWidth=Math.floor(this.surface.getWidth()/this.scale),this.scaledHeight=Math.floor(this.surface.getHeight()/this.scale);const e=this.scaledWidth*this.scaledHeight;this.computedCosts=new Array(e),this.computedMultipliers=new Array(e);for(let s=0;s<this.scaledWidth;s++)for(let i=0;i<this.scaledHeight;i++){const r=this.surface.getEntityTiles(s*this.scale,i*this.scale,this.scale);let o=0,h=0;for(let p=0;p<r.length;p++){let g=r[p].getType();if(!this.costs[g]){o=null,h=t;break}o+=this.costs[g],h+=this.costMultipliers[g]??1}const l=i*this.scaledWidth+s;this.computedCosts[l]=o===null?null:o/t,this.computedMultipliers[l]=h/t}}getIndex(t){return(t.getY()/this.scale|0)*this.scaledWidth+(t.getX()/this.scale|0)}}const js=(n,...t)=>{const e=[];return t.filter(Boolean).forEach(s=>e.push(...s(n))),e.sort((s,i)=>s.index-i.index),e},gi=(n,t)=>{if(n>Math.random())return t},qe=new Set([f.Grass,f.Snow]);class nn{constructor(t){a(this,"isBlocking",!1);this.index=t}isCleared(t,e){return e.getScale()===1?!qe.has(t[this.index-1].getType()):u.Instance.getSurface().getEntityTiles(t[this.index-1].getX(),t[this.index-1].getY(),e.getScale()).every(s=>!qe.has(s.getType()))}process(t,e,s){const i=u.Instance.getSurface(),r=t[this.index-1],o=u.Instance.getSurface().getEntityTiles(r.getX(),r.getY(),e.getScale());for(let h of o)qe.has(h.getType())&&i.setTile(new Q(h.getX(),h.getY(),f.Dirt))}}const _i=(n=1)=>t=>{const e=[];if(n>1){const r=u.Instance.getSurface();return t.forEach((o,h)=>{r.getEntityTiles(o.getX(),o.getY(),n).some(p=>qe.has(p.getBaseType()))&&e.push(new nn(h+1))}),e}const s=Math.random()*t.length/10,i=t.filter(r=>qe.has(r.getBaseType()));for(let r=0;r<s&&i.length;r++){const o=i.splice(Math.floor(Math.random()*i.length),1)[0];e.push(new nn(t.indexOf(o)+1))}return e};class an{constructor(t){a(this,"isBlocking",!0);this.index=t}isCleared(t,e){return!this.getTiles(t[this.index],e).length}process(t,e,s){const i=u.Instance.getSurface(),r=t[this.index],o=this.getTiles(r,e);if(o.length>0){const h=o[0];e.entity.lookAt(h),e.AI.interact(()=>{i.getTile(h.getX(),h.getY()).getType()===f.Water&&i.setTile(new Q(h.getX(),h.getY(),f.Bridge))})}}getTiles(t,e){const s=u.Instance.getSurface(),i=[];return t.getType()===f.Water&&i.push(t),e.entity.getAlignedX()!==t.getX()&&e.entity.getAlignedY()!==t.getY()&&[[e.entity.getAlignedX(),t.getY()],[t.getX(),e.entity.getAlignedY()]].forEach(([r,o])=>{const h=s.getTile(r,o);(h==null?void 0:h.getType())===f.Water&&i.push(h)}),i}}const Lr=n=>{const t=[];for(let e=0;e<n.length;e++)n[e].getType()===f.Water&&(t.push(new an(e)),e+1<n.length&&n[e+1].getType()!==f.Water&&t.push(new an(e+1)));return t},Or=Le(),Fr=_i(),Yr=3e3,Xr=1e3,$r=.01,Nr=.01,Ur=100;var St;let Vn=(St=class{constructor(t,e){a(this,"entity");a(this,"category",k.Enemy);a(this,"status",T.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new tt(t.getX(),t.getY(),this),this.ai=new Ye(this,Ur)}initializePath(){this.path.setSpeed(Nr),this.path.setCheckpoints(js(this.path.getTiles(),Or,gi(.5,Fr),gi(.1,Lr)))}get AI(){return this.ai}getDamage(){return 6}getType(){return St.type}getScale(){return St.scale}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status!==T.Normal&&(this.statusDuration-=t,this.statusDuration<=0?this.status=T.Normal:this.status===T.OnFire&&this.ai.hit($r*t)),this.ai.tick(t)}isVisible(){return this.ai.isVisible()}lightOnFire(){this.status=T.OnFire,this.statusDuration=Yr}stun(){this.status=T.Stunned,this.statusDuration=Xr}getOffsetX(){return this.entity.getX()}getOffsetY(){return this.entity.getY()}},a(St,"pathCosts",Oe),a(St,"pathMultipliers",Fe),a(St,"type",c.Slime),a(St,"cost",7),a(St,"scale",1),St);const zr=Le(),Wr=_i(),Hr=3e3,Gr=1e3,Vr=.01,jr=.008,Kr=200;var Et;let jn=(Et=class{constructor(t,e){a(this,"entity");a(this,"category",k.Enemy);a(this,"status",T.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new tt(t.getX(),t.getY(),this),this.ai=new Ye(this,Kr)}initializePath(){this.path.setSpeed(jr),this.path.setCheckpoints(js(this.path.getTiles(),zr,gi(.5,Wr)))}get AI(){return this.ai}getDamage(){return 8}getType(){return Et.type}getScale(){return Et.scale}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status!==T.Normal&&(this.statusDuration-=t,this.statusDuration<=0?this.status=T.Normal:this.status===T.OnFire&&this.ai.hit(Vr*t)),this.ai.tick(t)}isVisible(){return this.ai.isVisible()}lightOnFire(){this.status=T.OnFire,this.statusDuration=Hr}stun(){this.status=T.Stunned,this.statusDuration=Gr}getOffsetX(){return this.entity.getX()}getOffsetY(){return this.entity.getY()}},a(Et,"pathCosts",Oe),a(Et,"pathMultipliers",Fe),a(Et,"type",c.Tank),a(Et,"cost",20),a(Et,"scale",1),Et);const qr=Le(1,hs),Qr=3e3,Zr=1e3,Jr=.01,to=.006,eo=50;var It;let Kn=(It=class{constructor(t,e){a(this,"entity");a(this,"category",k.Enemy);a(this,"status",T.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new tt(t.getX(),t.getY(),this),this.ai=new Ye(this,eo)}initializePath(){this.path.setSpeed(to),this.path.setCheckpoints(qr(this.path.getTiles()))}get AI(){return this.ai}getDamage(){return 5}getType(){return It.type}getScale(){return It.scale}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status!==T.Normal&&(this.statusDuration-=t,this.statusDuration<=0?this.status=T.Normal:this.status===T.OnFire&&this.ai.hit(Jr*t)),this.ai.tick(t)}isVisible(){return this.ai.isVisible()}lightOnFire(){this.status=T.OnFire,this.statusDuration=Qr}stun(){this.status=T.Stunned,this.statusDuration=Zr}getOffsetX(){return this.entity.getX()}getOffsetY(){return this.entity.getY()}},a(It,"pathCosts",Ir),a(It,"pathMultipliers",br),a(It,"type",c.Flier),a(It,"cost",12),a(It,"scale",1),It);const Xs=class{constructor(t){a(this,"isBlocking",!1);this.index=t}isCleared(t,e){const s=t[this.index];return!u.Instance.getSurface().getEntityTiles(s.getX(),s.getY(),e.getScale()).some(i=>i.hasStaticEntity()&&Xs.treeTypes.has(i.getStaticEntity().getAgent().getType()))}process(t,e,s){const i=u.Instance.getSurface().getEntityTiles(t[this.index].getX(),t[this.index].getY(),2);for(let r of i)r.hasStaticEntity()&&Xs.treeTypes.has(r.getStaticEntity().getAgent().getType())&&r.getStaticEntity().getAgent().hit(100)}};let Qe=Xs;a(Qe,"treeTypes",new Set([c.Tree,c.Pine,c.Cactus]));const qn=n=>{const t=u.Instance.getSurface(),e=[];for(let s=0;s<n.length;s++){const i=t.getEntityTiles(n[s].getX(),n[s].getY(),2);for(let r of i)if(r.hasStaticEntity()&&Qe.treeTypes.has(r.getStaticEntity().getAgent().getType())){e.push(new Qe(s));break}}return e},Qn=new Set(se);Qn.delete(c.Tree);const so=Le(2,Qn),io=3e3,no=1500,ao=.01,ro=.01,oo=350;var lt;let Zn=(lt=class{constructor(t,e){a(this,"entity");a(this,"category",k.Enemy);a(this,"status",T.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new tt(t.getX(),t.getY(),this),this.ai=new Ye(this,oo)}initializePath(){this.path.setSpeed(ro/lt.scale),this.path.setCheckpoints(js(this.path.getTiles(),qn,so))}get AI(){return this.ai}getDamage(){return 10}getType(){return lt.type}getScale(){return lt.scale}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status!==T.Normal&&(this.statusDuration-=t,this.statusDuration<=0?this.status=T.Normal:this.status===T.OnFire&&this.ai.hit(ao*t)),this.ai.tick(t)}isVisible(){return this.ai.isVisible()}lightOnFire(){this.status=T.OnFire,this.statusDuration=io}stun(){this.status=T.Stunned,this.statusDuration=no}getOffsetX(){return this.entity.getX()+.5}getOffsetY(){return this.entity.getY()+.5}},a(lt,"pathCosts",Oe),a(lt,"pathMultipliers",os(Fe,{[f.Water]:2})),a(lt,"type",c.Behemoth),a(lt,"cost",32),a(lt,"scale",2),lt);const Jn=new Set(se);Jn.delete(c.Tree);const co=Le(2,Jn),ho=_i(2),lo=3e3,uo=500,go=.01,po=.005,fo=1e3,mo=1e3;var ut;let ta=(ut=class{constructor(t,e){a(this,"entity");a(this,"category",k.Enemy);a(this,"status",T.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new tt(t.getX(),t.getY(),this),this.ai=new Ye(this,fo,mo)}initializePath(){this.path.setSpeed(po/ut.scale),this.path.setCheckpoints(js(this.path.getTiles(),qn,co,ho))}get AI(){return this.ai}getDamage(){return 1e3}getType(){return ut.type}getScale(){return ut.scale}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status!==T.Normal&&(this.statusDuration-=t,this.statusDuration<=0?this.status=T.Normal:this.status===T.OnFire&&this.ai.hit(go*t)),this.ai.tick(t)}isVisible(){return this.ai.isVisible()}lightOnFire(){this.status=T.OnFire,this.statusDuration=lo}stun(){this.status=T.Stunned,this.statusDuration=uo}getOffsetX(){return this.entity.getX()+.5}getOffsetY(){return this.entity.getY()+.5}},a(ut,"pathCosts",os(Oe,{[f.Fence]:1,[f.Freezer]:8})),a(ut,"pathMultipliers",os(Fe,{[f.Obstructed]:4,[f.Wall]:30,[f.Fence]:1,[f.Water]:5,[f.Freezer]:.375})),a(ut,"type",c.Bore),a(ut,"cost",300),a(ut,"scale",2),ut);const ve=class{constructor(t,e,s){a(this,"index",0);a(this,"pathData",new Map);a(this,"strength",0);a(this,"unit",ie);a(this,"energy",25);a(this,"spawnInterval",200);a(this,"spawnDelay",0);a(this,"burstSize",Number.POSITIVE_INFINITY);a(this,"burstInterval",1e3);a(this,"burst",0);a(this,"timer",0);a(this,"centerX",0);a(this,"centerY",0);this.spawnPoints=t,this.target=e,this.surface=s,t.forEach(i=>{this.centerX+=i.getX(),this.centerY+=i.getY()}),this.centerX/=t.length,this.centerY/=t.length}setUnit(t){this.unit=t}getUnitType(){return this.unit.type}setParameters(t,e,s,i,r){this.energy=t,this.spawnInterval=e,this.spawnDelay=s,this.burstSize=i,this.burstInterval=r,this.burst=0,this.timer=e}getEnergy(){return this.energy}tick(t){if(!(this.energy===0||!this.isReady())){if(this.timer+=t,this.spawnDelay>0)if(this.timer>this.spawnDelay)this.timer-=this.spawnDelay,this.spawnDelay=0;else return;if(this.burst>=this.burstSize)if(this.timer>=this.burstInterval)this.timer-=this.burstInterval,this.burst=0;else return;if(this.timer>=this.spawnInterval){this.timer-=this.spawnInterval,this.energy=Math.max(0,this.energy-this.unit.cost),this.burst++;const e=this.getNextUnit();u.Instance.spawnEnemy(e)}}}getCenter(){return[this.centerX,this.centerY]}isReady(){return!!this.getPathData(this.unit.type).getPaths().length}getSpawnPoints(){return this.getPathData(this.unit.type).getPaths()}getAsyncSpawnPoints(){return this.getPathData(this.unit.type).getAsyncPaths()}getNextSpawnPoint(){const t=this.getSpawnPoints(),e=t[this.index];return this.index=(this.index+1)%t.length,e}getNextUnit(){const t=this.getNextSpawnPoint().clone(),e=new this.unit(t.getTile(),t);return e.initializePath(),e}grow(){this.strength++}getStrength(){return this.strength}isExposed(){let t=0,e=0;return this.surface.forCircle(this.centerX,this.centerY,ve.size,s=>{t++,s.getDiscoveryStatus()!==U.Undiscovered&&e++}),e/t}rePath(){this.pathData.forEach(t=>t.update())}serialize(){return{spawnPoints:this.spawnPoints.map(t=>({x:t.getX(),y:t.getY()})),unit:this.unit.type,energy:this.energy,spawnInterval:this.spawnInterval,spawnDelay:this.spawnDelay,burstSize:this.burstSize,burstInterval:this.burstInterval}}static deserialize(t,e,s){const i=new ve(s.spawnPoints.map(({x:r,y:o})=>t.getTile(r,o)),e,t);return i.setUnit(ve.unitMap[s.unit]),i.setParameters(s.energy,s.spawnInterval,s.spawnDelay,s.burstSize??Number.POSITIVE_INFINITY,s.burstInterval),i}getPathData(t){return this.pathData.has(t)||this.pathData.set(t,new _r(new Dr(this.surface,this.unit.pathMultipliers,this.unit.pathCosts,this.unit.scale),this.spawnPoints,this.target)),this.pathData.get(t)}static fromTiles(t,e,s){return new ve(t,e,s)}};let gt=ve;a(gt,"size",5),a(gt,"unitMap",{[c.Runner]:ie,[c.Slime]:Vn,[c.Tank]:jn,[c.Flier]:Kn,[c.Behemoth]:Zn,[c.Bore]:ta});var $=(n=>(n.Practice="practice",n.Easy="easy",n.Normal="normal",n.Hard="hard",n))($||{});const rn={practice:{label:"Practice",description:"Like easy mode but with infinite money. Great for getting to know the game mechanics but achievements are disabled."},easy:{label:"Easy",description:"Allows checking which tiles are covered by tower sight lines. Shows the approximate path enemies will take and undiscovered nests do not become stronger."},normal:{label:"Normal",description:"Allows checking which tiles are covered by tower sight lines. Enemies are a bit stronger and undiscovered nests slowly gain more strength."},hard:{label:"Hard",description:"Checking tower sight lines is no longer possible, enemies are stronger and undiscovered nests gain strength more quickly."}};class pe{constructor(t,e,s=[]){this.min=t,this.max=e,this.units=s}getRange(){return[this.min,this.max]}getCenter(){return(this.min+this.max)/2}getLength(){return this.max-this.min}getUnits(){return this.units}addUnit(t){this.units.includes(t)||this.units.push(t),this.units.sort((e,s)=>s-e)}equals(t){return this.min===t.min&&this.max===t.max}toString(){return`[${this.min}, ${this.max}]`}static forSpawnGroup(t){const[e,s]=t.getCenter(),i=u.Instance.getBase().getTile(),r=e-i.getX(),o=s-i.getY(),h=(Math.atan2(o,r)*180/Math.PI+360)%360;switch(u.Instance.getDifficulty()){case $.Easy:case $.Practice:return new pe(Math.floor(h/15)*15,Math.floor(h/15)*15+15,[t.getUnitType()]);case $.Normal:return new pe(Math.floor(h/45)*45,Math.floor(h/45)*45+45,[t.getUnitType()]);case $.Hard:return new pe(Math.floor(h/120)*120,Math.floor(h/120)*120+120,[t.getUnitType()])}}static forSpawnGroups(t){const e=new Map;return t.filter(s=>!s.isExposed()).forEach(s=>{const i=pe.forSpawnGroup(s),r=e.get(i.toString());r?r.addUnit(s.getUnitType()):e.set(i.toString(),i)}),[...e.values()]}}const yo=(n,t)=>{const e=new Array(t).fill(0).map(Math.random),s=e.reduce((i,r)=>i+r);return e.map(i=>i/s*n)},fe=()=>{let n=1-Math.random(),t=Math.random(),e=Math.sqrt(-2*Math.log(n))*Math.cos(2*Math.PI*t);return e=e/10+.5,e>1||e<0?fe():e},wo=4e3,vo=100,So=550,Eo=500,Io=3e3,bo=3,Mo=4,To=1.1,xo={[$.Practice]:0,[$.Easy]:0,[$.Normal]:1.5*ie.cost,[$.Hard]:3*ie.cost},Ao={[c.Runner]:.8,[c.Slime]:1,[c.Flier]:1,[c.Tank]:1.2,[c.Behemoth]:1.6,[c.Bore]:10};class Ze{constructor(t){this.spawnGroups=t}isDone(){return!this.spawnGroups.find(t=>t.getEnergy()>0)}getSpawnGroups(){return this.spawnGroups}tick(t){this.spawnGroups.forEach(e=>e.tick(t))}static fromSpawnGroups(t,e){const s=(1+t**2)*ie.cost,i=yo(s,e.length),r=xo[u.Instance.getDifficulty()];return e.forEach((o,h)=>{const l=i[h]*To+r*o.getStrength(),p=h===0||Math.random()>.5?0:fe()*wo,g=Math.random()>.5?fe()*Mo*Math.log(l)+bo:Number.POSITIVE_INFINITY;o.setParameters(l,(fe()*So/Math.max(1,t/3)+vo)*Ao[o.getUnitType()],p,g,fe()*Io+Eo)}),new Ze(e)}static getUnitForLevel(t){if(t===0)return ie;if(t!==1&&(t+1)%10===0)return ta;const e=Math.random();return e<.2-t/200?ie:t>=3&&e<.3?Kn:t>=8&&e<.6?Zn:Math.random()>Math.min(.7,.1+t/30)?Vn:jn}}const Se=class{constructor(t,e){a(this,"spawnGroups",[]);a(this,"nextSpawnGroup");a(this,"initialNextSpawnGroup");a(this,"direction",Math.random()*Math.PI*2);a(this,"nextUnit");a(this,"wave");a(this,"timeSinceLastExpansion",0);a(this,"removeSurfaceChangeEventListener");a(this,"onSurfaceChange",({affectedTiles:t,removedStaticAgents:e})=>{const s=this.isWaveInProgress();this.spawnGroups.forEach(r=>{s?r.getSpawnPoints().forEach(o=>{o.isAffectedByTiles(t)&&o.recompute()}):(e.size>0||r.getSpawnPoints().find(h=>h.isAffectedByTiles(t)))&&r.rePath()});const i=this.getNextSpawnGroup();!s&&i&&(e.size>0||i.getSpawnPoints().find(o=>o.isAffectedByTiles(t)))&&i.rePath()});this.base=t,this.surface=e,Se.instance&&Se.instance.removeSurfaceChangeEventListener(),Se.instance=this,this.removeSurfaceChangeEventListener=A.Instance.addEventListener(E.SurfaceChange,this.onSurfaceChange)}tick(t){this.wave&&this.wave.tick(t)}startNewWave(){const t=u.Instance.getLevel();J.Instance.hasPendingAgents()&&(this.timeSinceLastExpansion=0),this.spawnGroups.forEach(i=>{i.grow(),i.rePath()});const e=[],s=this.getNextSpawnGroup();s&&e.push(s),s!==this.initialNextSpawnGroup&&e.push(this.initialNextSpawnGroup),e.forEach(i=>{this.timeSinceLastExpansion=0;const[r,o]=i.getCenter(),h=[];this.surface.forCircle(r,o,gt.size,l=>{ks.has(l.getType())&&(h.push(new Q(l.getX(),l.getY(),f.Spore)),l.hasStaticEntity()&&this.surface.despawnStatic(l.getStaticEntity().getAgent()))}),this.surface.setTiles(h),this.spawnGroups.push(i)}),this.cleanupSpawnGroups(Ps.Radar),this.nextUnit=void 0,this.nextSpawnGroup=void 0,this.initialNextSpawnGroup=void 0,this.wave=Ze.fromSpawnGroups(t,t===9?[this.spawnGroups[0]]:[...this.spawnGroups])}processWave(){return this.isWaveInProgress()?!1:(this.timeSinceLastExpansion++,this.spawnGroups.forEach(t=>t.setUnit(Ze.getUnitForLevel(u.Instance.getLevel()))),!0)}cleanupSpawnGroups(t){for(let e=this.spawnGroups.length-1;e>=0;e--){const s=this.spawnGroups[e];s.isExposed()>0&&(this.spawnGroups.splice(e,1),J.Instance.uncoverSpawnGroup(s,t))}}getWave(){return this.wave}getSpawnGroups(){const t=this.spawnGroups.filter(e=>e.isExposed()===0);if(!this.isWaveInProgress()){const e=this.getNextSpawnGroup();e&&t.push(e)}return u.Instance.getLevel()===9+(this.isWaveInProgress()?1:0)?[t[0]]:t}getSpawnAlertRanges(){return pe.forSpawnGroups(this.getSpawnGroups())}isWaveInProgress(){return this.wave&&!this.wave.isDone()?!0:this.surface.getEntitiesForCategory(k.Enemy).size>0}shouldAddSpawnGroup(){if(this.initialNextSpawnGroup&&!this.initialNextSpawnGroup.isExposed())return!0;const t=Math.ceil(2**this.spawnGroups.length/3),e=J.Instance.hasPendingAgents()?0:this.timeSinceLastExpansion;return this.spawnGroups.filter(i=>i.isExposed()===0).length===0||e>=t}serialize(){return{spawnGroups:this.spawnGroups.map(t=>t.serialize()),nextSpawnGroup:this.nextSpawnGroup?this.nextSpawnGroup.serialize():null,direction:this.direction,timeSinceLastExpansion:this.timeSinceLastExpansion}}static deserialize(t,e,s){const i=new Se(e,t);return i.spawnGroups=s.spawnGroups.map(r=>gt.deserialize(t,e.getTile(),r)),s.nextSpawnGroup&&(i.nextSpawnGroup=gt.deserialize(t,e.getTile(),s.nextSpawnGroup),i.initialNextSpawnGroup=i.nextSpawnGroup),i.direction=s.direction,i.timeSinceLastExpansion=s.timeSinceLastExpansion,i}getNextSpawnGroup(){if(!this.shouldAddSpawnGroup())return;if(this.nextSpawnGroup&&!this.nextSpawnGroup.isExposed())return this.nextSpawnGroup;if(this.initialNextSpawnGroup&&!this.initialNextSpawnGroup.isExposed())return this.nextSpawnGroup=this.initialNextSpawnGroup,this.nextSpawnGroup;const t=u.Instance.getLevel();this.nextUnit||(this.nextUnit=Ze.getUnitForLevel(t)),this.direction+=(Math.random()>.5?1:-1)*Math.max(Math.PI/6*fe()*Math.min(Math.PI*2,t+1));let e=!1,s=3;for(let i=0;i<20&&(this.surface.forRay(this.base.getTile().getX(),this.base.getTile().getY(),this.direction,r=>r.getDiscoveryStatus()!==U.Undiscovered?(s=4+Math.min(u.Instance.getLevel()/2,Math.floor(Math.random()*6)),!0):(s--,s>0?!0:(Math.random()>.66?!ks.has(r.getType()):!Ti.has(r.getType()))?!(u.Instance.getLevel()===0&&i<10):(this.nextSpawnGroup=gt.fromTiles([r,r,r,r],this.base.getTile(),this.surface),this.nextSpawnGroup.setUnit(this.nextUnit),e=!0,!1))),!e);i++)this.direction+=Math.PI/10;return this.initialNextSpawnGroup||(this.initialNextSpawnGroup=this.nextSpawnGroup),this.nextSpawnGroup}static get Instance(){return this.instance}};let K=Se;a(K,"instance");const ws=n=>n.getType()===c.Base,$s=class{constructor(t){a(this,"discoveredSpawnGroups",new Set);a(this,"agents",new Set);a(this,"edgeMap",new Map);a(this,"pendingAgents",new Set);a(this,"base");a(this,"pendingRadius",0);a(this,"discoveredEdge",!1);a(this,"minX");a(this,"minY");a(this,"maxX");a(this,"maxY");this.surface=t,$s.instance=this}registerAgent(t){this.agents.add(t);let e=U.Pending;ws(t)?(this.base=t,e=U.Discovered):this.pendingAgents.add(t);const s=this.getVisibilityRange(t),i=this.getVisibilityEdge(t);this.edgeMap.set(t.entity.getId(),i),this.updateVisibility(...i,s,e)}removeAgent(t){if(!this.agents.has(t))return;ws(t)&&(this.base=void 0);const e=this.getVisibilityRange(t),s=this.edgeMap.get(t.entity.getId());this.surface.forCircle(...s,e,i=>i.setDiscoveryStatus(U.Undiscovered)),this.agents.delete(t),this.pendingAgents.delete(t),this.edgeMap.delete(t.entity.getId()),this.update()}commit(){this.pendingAgents.clear(),this.pendingRadius=0,this.update()}updateBaseRange(){if(!this.base)throw new Error("Updating base range without a base");this.pendingRadius=this.getVisibilityRange(this.base),this.updateVisibility(...this.getVisibilityEdge(this.base),this.pendingRadius,U.Pending)}getBBox(){return[[this.minX,this.minY],[this.maxX,this.maxY]]}hasPendingAgents(){return this.pendingAgents.size>0}uncoverSpawnGroup(t,e){const s=K.Instance.getSpawnGroups();this.discoveredSpawnGroups.add(t);const[i,r]=t.getCenter();this.updateVisibility(i,r,gt.size,U.Discovered),s.forEach(o=>{const[h,l]=o.getCenter();this.surface.forCircle(h,l,gt.size,p=>{p.getDiscoveryStatus()!==U.Undiscovered&&p.setDiscoveryStatus(U.Undiscovered)})}),A.Instance.triggerEvent(E.Discover,{x:i,y:r,method:e})}isEdgeDiscovered(){return this.discoveredEdge}serialize(){return{tiles:[...this.agents].map(e=>{const s=e.getTile(),i=this.edgeMap.get(e.entity.getId());return{x:s.getX(),y:s.getY(),edge:i}}),discoveredSpawnGroups:[...this.discoveredSpawnGroups].map(e=>e.serialize())}}static deserialize(t,e){const s=new $s(t);for(let i of e.tiles){const r=t.getTile(i.x,i.y).getStaticEntity().getAgent();ws(r)&&(s.base=r),s.agents.add(r),s.edgeMap.set(r.entity.getId(),i.edge)}for(let i of e.discoveredSpawnGroups)s.discoveredSpawnGroups.add(gt.deserialize(t,s.base.getTile(),i));return s}update(){this.minX=void 0,this.minY=void 0,this.maxX=void 0,this.maxY=void 0,this.agents.forEach(s=>{const i=this.getVisibilityRange(s),r=this.edgeMap.get(s.entity.getId());this.surface.forCircle(...r,i,o=>o.setDiscoveryStatus(U.Undiscovered))}),this.pendingRadius>0&&this.base&&this.updateVisibility(...this.getVisibilityEdge(this.base),this.pendingRadius,U.Pending),this.agents.forEach(s=>{const i=this.pendingAgents.has(s)?U.Pending:U.Discovered,r=this.getVisibilityRange(s),o=this.getVisibilityEdge(s);this.edgeMap.set(s.entity.getId(),o),this.updateVisibility(...o,r,i)});const t=[],e=K.Instance.getSpawnGroups();this.discoveredSpawnGroups.forEach(s=>{if(s.isExposed()===0){t.push(s);return}const i=s.getCenter();this.updateVisibility(...i,5,U.Discovered)}),e.forEach(s=>{const[i,r]=s.getCenter();this.surface.forCircle(i,r,gt.size,o=>{o.getDiscoveryStatus()!==U.Undiscovered&&o.setDiscoveryStatus(U.Undiscovered)})}),t.forEach(s=>this.discoveredSpawnGroups.delete(s))}getVisibilityRange(t){switch(t.getType()){case c.Base:return 35+(u.Instance.getLevel()-(this.pendingRadius>0?1:0))*2;case c.Radar:return 21;default:throw new Error("Entity has no visibility defined")}}getVisibilityEdge(t){if(ws(t)||!this.base)return[t.entity.getAlignedX(),t.entity.getAlignedY()];let e;const s=Math.atan2(t.entity.getAlignedY()-this.base.entity.getAlignedY(),t.entity.getAlignedX()-this.base.entity.getAlignedX());return this.surface.forRay(this.base.entity.getAlignedX(),this.base.entity.getAlignedY(),s,i=>i.getDiscoveryStatus()===U.Undiscovered?!1:(e=i,!0)),e?[e.getX(),e.getY()]:[t.entity.getAlignedX(),t.entity.getAlignedY()]}updateVisibility(t,e,s,i){(!this.minX||t-s/2<this.minX)&&(this.minX=t-s/2),(!this.minY||e-s/2<this.minY)&&(this.minY=e-s/2),(!this.maxX||t+s/2>this.maxX)&&(this.maxX=t+s/2),(!this.maxY||e+s/2>this.maxY)&&(this.maxY=e+s/2),this.surface.forCircle(t,e,s,r=>{i===U.Pending&&r.isDiscovered()||(i===U.Discovered&&r.getType()===f.Void&&(this.discoveredEdge=!0),r.setDiscoveryStatus(i))})}static get Instance(){return this.instance}};let Ms=$s;a(Ms,"instance");const J=Ms;class Bi{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"renderData",{});this.tile=t,this.entity=new V(t.getX(),t.getY(),this)}getType(){return c.Radar}getTile(){return this.tile}updateTile(t){this.tile=t}spawn(){J.Instance.registerAgent(this),u.Instance.getBase().addPart(this),De(this,3)}despawn(){J.Instance.removeAgent(this),u.Instance.getBase().removePart(this)}hit(t){u.Instance.getBase().hit(t)}isVisible(){return!0}}a(Bi,"scale",2);const ko=new Set([f.Obstructed,f.Wall,f.PlayerBuilding,f.Base]),Xe=n=>ko.has(n.getType()),pi=250;let Po=class{constructor(t){a(this,"entity");a(this,"category",k.Unknown);a(this,"time",0);a(this,"renderData",{});a(this,"sourceX");a(this,"sourceY");this.source=t;const[e,s]=pt(t);this.entity=new tt(e,s,this),this.sourceX=e,this.sourceY=s}dealDamage(t,e){this.renderData.update=!0,this.time>pi&&u.Instance.getSurface().spawn(this),this.time=0;const s=Math.atan2(t.getOffsetX()+.5-this.sourceX,t.getOffsetY()+.5-this.sourceY);this.entity.setRotation(s*180/Math.PI),this.source.entity.setRotation(-this.entity.getRotation()+180),this.entity.setX(t.entity.getAlignedX()),this.entity.setY(t.entity.getAlignedY()),t.AI.hit(e),t.lightOnFire&&t.lightOnFire()}tick(t){this.time+=t,this.time>pi&&u.Instance.getSurface().despawn(this)}getType(){return c.Flame}isVisible(){return!0}};const on=1,Co=.04,Ui=class{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"flame");a(this,"hp",160);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});this.tile=t,this.entity=new V(t.getX(),t.getY(),this)}tick(t){this.isEnabled&&(this.cooldown=Math.max(0,this.cooldown-t))}fire(t,e){this.cooldown=on;const s=u.Instance.consumeContinuous(this,e,this.damageMultiplier*this.speedMultiplier),i=Co*(s?this.damageMultiplier*this.speedMultiplier:1)*e;return this.flame||(this.flame=new Po(this),u.Instance.getSurface().spawn(this.flame)),this.flame.dealDamage(t,i),this.renderData.fired=!0,i}spawn(){[this.cleanupEventListener]=_e(this,Ui.range,Xe)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=Be(t),this.damageMultiplier=Re(t)}getCooldown(){return this.cooldown}getType(){return c.Flamethrower}hit(t){this.hp-=t,this.hp<=0&&(this.renderData.destroyed=!0,u.Instance.getSurface().despawnStatic(this))}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=on,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}};let me=Ui;a(me,"scale",2),a(me,"range",6);class Ri{constructor(){a(this,"source");a(this,"target");a(this,"sourceX");a(this,"sourceY");a(this,"targetX");a(this,"targetY");a(this,"travelTime")}}function ea(n,t=0){const[e,s]=pt(this.source);this.sourceX=e,this.sourceY=s;const i=e-this.target.getOffsetX()+.5,r=s-this.target.getOffsetY()+.5,o=Math.sqrt(i*i+r*r)+t;this.travelTime=o/n;const h=this.target.AI.getFuturePosition(this.travelTime),{x:l,y:p}=this.target.getPath().getCoordinates(h);this.targetX=l+this.target.getScale()/2,this.targetY=p+this.target.getScale()/2}function sa(n,t){const e=n.getOffsetX()-this.entity.getX(),s=n.getOffsetY()-this.entity.getY();return e*e+s*s<=t}const ia=(n,t)=>(n%t+t)%t,Rt=(n,t,e)=>n+(t-n)*e,_o=(n,t,e)=>{if(n===t)return t;const s=ia(t-n+180,360)-180;return s<0?(n-Math.min(-s,e)+360)%360:n+Math.min(s,e)},Bo=.01,cn=5,hn=2,Ro=hn*hn;let Do=class extends Ri{constructor(e,s,i){super();a(this,"entity");a(this,"category",k.Unknown);a(this,"renderData",{});a(this,"time",0);a(this,"prevX");a(this,"prevY");a(this,"straightY",0);this.source=e,this.target=s,this.damage=i,ea.call(this,Bo,cn*2),this.entity=new tt(this.sourceX,this.sourceY,this),this.entity.lookAt(this.targetX,this.targetY),this.source.entity.setRotation(this.entity.getRotation()),this.entity=new tt(this.sourceX,this.sourceY,this),this.entity.lookAt(this.targetX,this.targetY),this.source.entity.setRotation(this.entity.getRotation())}tick(e){if(this.time>=this.travelTime){u.Instance.getSurface().despawn(this);let r=!1;const o=[...u.Instance.getSurface().getEntitiesForCategory(k.Enemy)].filter(h=>sa.call(this,h.getAgent(),Ro));o.forEach(h=>{h.getAgent().AI.hit(this.damage),h.getAgent()===this.target&&(r=!0)}),o.length>_s.maxBombedEnemies&&(_s.maxBombedEnemies=o.length,A.Instance.triggerEvent(E.Bomb,{amount:o.length})),r||this.target.AI.miss(this.damage)}this.time=Math.min(this.time+e,this.travelTime);const s=this.time/this.travelTime,i=Math.sin(s*Math.PI)*cn;if(this.straightY=Rt(this.sourceY,this.targetY,s),this.entity.setX(Rt(this.sourceX,this.targetX,s)),this.entity.setY(this.straightY-i),this.prevX&&this.prevY){const r=this.entity.getX()-this.prevX,o=this.entity.getY()-this.prevY;this.entity.setRotation(Math.atan2(o,r)*180/Math.PI+90)}this.prevX=this.entity.getX(),this.prevY=this.entity.getY()}getType(){return c.Rocket}isVisible(){return!0}getPercentage(){return this.time/this.travelTime}};const ln=5e3,Lo=50,zi=class{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"hp",80);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});this.tile=t,this.entity=new V(t.getX(),t.getY(),this)}tick(t){!this.isEnabled||this.cooldown<=0||(this.cooldown-=t*this.speedMultiplier)}fire(t){if(this.cooldown+=ln,!u.Instance.consume(this,this.speedMultiplier,this.damageMultiplier))return 0;const e=Lo*this.damageMultiplier,s=new Do(this,t,e);return u.Instance.getSurface().spawn(s),this.renderData.fired=!0,e}spawn(){[this.cleanupEventListener]=_e(this,zi.range)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=Be(t),this.damageMultiplier=Re(t)}getCooldown(){return this.cooldown}getType(){return c.Mortar}hit(t){this.hp-=t,this.hp<=0&&(this.renderData.destroyed=!0,u.Instance.getSurface().despawnStatic(this))}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=ln,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}};let le=zi;a(le,"scale",2),a(le,"range",30),a(le,"maxBombedEnemies",0);const _s=le,Oo=(n,t,e,s,i)=>{const r=Math.atan2(i-t,s-n);let o=ia(r-e+Math.PI,Math.PI*2)-Math.PI;return Math.abs(o)>=Math.PI?Number.POSITIVE_INFINITY:Math.abs(Math.cos(e)*(t-i)-Math.sin(e)*(n-s))},cs=(n,t,e,s)=>(n-e)**2+(t-s)**2,Di=1500;let Fo=class{constructor(t,e,s){a(this,"entity");a(this,"category",k.Unknown);a(this,"renderData",{});a(this,"targetX");a(this,"targetY");a(this,"time",0);this.source=t,this.damage=s;const[i,r]=pt(t);this.entity=new tt(i,r,this);const o=Math.atan2(e.getOffsetY()+.5-this.entity.getY(),e.getOffsetX()+.5-this.entity.getX());this.entity.setRotation(o*180/Math.PI),this.source.entity.setRotation(this.entity.getRotation()+90),u.Instance.getSurface().forRay(e.entity.getX(),e.entity.getY(),o,p=>(this.targetX=p.getX(),this.targetY=p.getY(),!Xe(p)));const h=cs(this.entity.getX(),this.entity.getY(),this.targetX,this.targetY),l=[...u.Instance.getSurface().getEntitiesForCategory(k.Enemy)].filter(p=>cs(this.entity.getX(),this.entity.getY(),p.getX()+.5,p.getY()+.5)<=h+1).filter(p=>Oo(this.entity.getX(),this.entity.getY(),o,p.getX()+.5,p.getY()+.5)<=.5);l.forEach(p=>{p.getAgent().AI.hit(this.damage)}),l.length>Bs.maxPierceEnemies&&(Bs.maxPierceEnemies=l.length,A.Instance.triggerEvent(E.Pierce,{amount:l.length}))}tick(t){this.time+=t,this.time>Di&&u.Instance.getSurface().despawn(this)}getType(){return c.Rail}isVisible(){return!0}};const un=5e3,Yo=70,Wi=class{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"hp",80);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});this.tile=t,this.entity=new V(t.getX(),t.getY(),this)}tick(t){!this.isEnabled||this.cooldown<=0||(this.cooldown-=t*this.speedMultiplier)}fire(t){if(this.cooldown+=un,!u.Instance.consume(this,this.speedMultiplier,this.damageMultiplier))return 0;const e=Yo*this.damageMultiplier,s=new Fo(this,t,e);return u.Instance.getSurface().spawn(s),this.renderData.fired=!0,e}spawn(){[this.cleanupEventListener]=_e(this,Wi.range,Xe)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=Be(t),this.damageMultiplier=Re(t)}getCooldown(){return this.cooldown}getType(){return c.Railgun}hit(t){this.hp-=t,this.hp<=0&&(this.renderData.destroyed=!0,u.Instance.getSurface().despawnStatic(this))}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=un,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}};let ue=Wi;a(ue,"scale",2),a(ue,"range",30),a(ue,"maxPierceEnemies",0);const Bs=ue,Xo=.015;class $o extends Ri{constructor(e,s,i){super();a(this,"entity");a(this,"category",k.Unknown);a(this,"renderData",{});a(this,"time",0);this.source=e,this.target=s,this.damage=i,ea.call(this,Xo),this.entity=new tt(this.sourceX,this.sourceY,this),this.entity.lookAt(this.targetX,this.targetY),this.source.entity.setRotation(this.entity.getRotation())}tick(e){this.time>=this.travelTime&&(u.Instance.getSurface().despawn(this),this.target.AI.hit(this.damage)),this.time=Math.min(this.time+e,this.travelTime);const s=this.time/this.travelTime;this.entity.setX(Rt(this.sourceX,this.targetX,s)),this.entity.setY(Rt(this.sourceY,this.targetY,s))}getType(){return c.Bullet}isVisible(){return!0}}const dn=500,No=10;var Jt;let na=(Jt=class{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"hp",50);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});this.tile=t,this.entity=new V(t.getX(),t.getY(),this)}tick(t){!this.isEnabled||this.cooldown<=0||(this.cooldown-=t*this.speedMultiplier)}fire(t){this.cooldown+=dn;const e=u.Instance.consume(this,this.speedMultiplier,this.damageMultiplier),s=No*(e?this.damageMultiplier:1),i=new $o(this,t,s);return u.Instance.getSurface().spawn(i),this.renderData.fired=!0,s}spawn(){[this.cleanupEventListener]=_e(this,Jt.range,Xe)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=Be(t),this.damageMultiplier=Re(t)}getCooldown(){return this.cooldown}getType(){return c.Tower}hit(t){this.hp-=t,this.hp<=0&&(this.renderData.destroyed=!0,u.Instance.getSurface().despawnStatic(this))}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=dn,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}},a(Jt,"scale",2),a(Jt,"range",10),Jt);var oi;let aa=(oi=class{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"hp",50);a(this,"renderData",{});this.tile=t,this.entity=new V(t.getX(),t.getY(),this)}getType(){return c.Wall}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}},a(oi,"scale",2),oi);const Rs=250;let Uo=class{constructor(t){a(this,"entity");a(this,"category",k.Unknown);a(this,"renderData",{});a(this,"time",0);a(this,"targetX",0);a(this,"targetY",0);this.source=t;const[e,s]=pt(t);this.entity=new tt(e,s,this)}dealDamage(t,e){this.time>Rs&&u.Instance.getSurface().spawn(this),this.time=0,this.targetX=t.getOffsetX()+.5,this.targetY=t.getOffsetY()+.5;const s=Math.atan2(this.targetY-this.entity.getY(),this.targetX-this.entity.getX());this.entity.setRotation(s*180/Math.PI),this.source.entity.setRotation(this.entity.getRotation()+90),t.AI.hit(e),t.lightOnFire&&t.lightOnFire()}tick(t){this.time+=t,this.time>Rs&&u.Instance.getSurface().despawn(this)}getType(){return c.LaserBeam}isVisible(){return!0}};const gn=1,zo=.06,Wo=500,Hi=class{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"laserBeam");a(this,"hp",80);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});a(this,"lastTarget");this.tile=t,this.entity=new V(t.getX(),t.getY(),this)}tick(t){!this.isEnabled||this.cooldown<=0||(!this.laserBeam&&this.lastTarget&&this.entity.lookAt(this.lastTarget.entity),this.cooldown=Math.max(0,this.cooldown-t))}fire(t,e){if(this.lastTarget!==t)return this.lastTarget=t,this.cooldown=Wo,0;if(this.cooldown=gn,!u.Instance.consumeContinuous(this,e,this.damageMultiplier*this.speedMultiplier))return 0;const s=zo*this.damageMultiplier*this.speedMultiplier*e;return this.laserBeam||(this.laserBeam=new Uo(this),u.Instance.getSurface().spawn(this.laserBeam)),this.laserBeam.dealDamage(t,s),this.renderData.fired=!0,s}spawn(){[this.cleanupEventListener]=_e(this,Hi.range,Xe)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=Be(t),this.damageMultiplier=Re(t)}getCooldown(){return this.cooldown}getType(){return c.Laser}hit(t){this.hp-=t,this.hp<=0&&(this.renderData.destroyed=!0,u.Instance.getSurface().despawnStatic(this))}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=gn,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}};let ye=Hi;a(ye,"scale",2),a(ye,"range",16);class Li{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"renderData",{});this.tile=t,this.entity=new V(t.getX(),t.getY(),this)}spawn(){u.Instance.getBase().addPart(this),De(this,3)}despawn(){u.Instance.getBase().removePart(this)}getType(){return c.Barracks}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){u.Instance.getBase().hit(t)}isVisible(){return!0}}a(Li,"scale",2);const Ho=.01,fi=800;let Go=class extends Ri{constructor(e,s,i){super();a(this,"entity");a(this,"category",k.Unknown);a(this,"renderData",{});a(this,"time",0);a(this,"sectionTime",0);a(this,"index",-1);this.source=e,this.chain=s;const[r,o]=pt(e);this.sourceX=r,this.sourceY=o,s.forEach(h=>{h.AI.hit(i),h.stun&&h.stun()}),this.entity=new tt(this.sourceX,this.sourceY,this),this.nextTarget()}nextTarget(){this.index++,this.index>=this.chain.length&&(this.entity.setX(this.sourceX),this.entity.setY(this.sourceY),this.index=0);const e=this.chain[this.index];this.targetX=e.getOffsetX(),this.targetY=e.getOffsetY(),this.travelTime=Math.sqrt(cs(this.entity.getX(),this.entity.getY(),this.targetX,this.targetY))/Ho,this.sectionTime=0,this.entity.lookAt(this.targetX,this.targetY)}tick(e){this.time>=fi&&u.Instance.getSurface().despawn(this),this.time+=e,this.sectionTime+=e,this.sectionTime>this.travelTime&&this.nextTarget();const s=this.sectionTime/this.travelTime;this.entity.setX(Rt(this.sourceX,this.targetX,s)),this.entity.setY(Rt(this.sourceY,this.targetY,s))}getChain(){return this.chain}getType(){return c.Spark}isVisible(){return!0}};const ei=4e3,Vo=700,jo=50,es=class{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"coveredTiles");a(this,"hp",160);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});a(this,"charging",!1);this.tile=t,this.entity=new V(t.getX(),t.getY(),this)}tick(t){if(!(!this.isEnabled||this.cooldown<=0)&&(this.cooldown-=t*(this.charging?1:this.speedMultiplier),this.charging&&ei-this.cooldown>Vo)){this.charging=!1;const e=u.Instance.getSurface(),s=[...u.Instance.getSurface().getEntitiesForCategory(k.Enemy)].filter(h=>this.coveredTiles.has(e.getTile(h.getAlignedX(),h.getAlignedY())));s.length>es.maxStunnedEnemies&&(es.maxStunnedEnemies=s.length,A.Instance.triggerEvent(E.Stun,{amount:s.length}));const i=new Map;s.forEach(h=>i.set(h.getId(),cs(h.getX(),h.getY(),...pt(this))));const r=[];s.sort((h,l)=>i.get(h.getId())-i.get(l.getId())).forEach(h=>{let l=i.get(h.getId()),p;r.forEach(g=>{const d=g[g.length-1],w=cs(h.getX(),h.getY(),d.getX(),d.getY());w<l&&(l=w,p=g)}),p?p.push(h):r.push([this.entity,h])});const o=jo*this.damageMultiplier;r.forEach(h=>{const l=new Go(this,h.slice(1,h.length).map(p=>p.getAgent()),o);u.Instance.getSurface().spawn(l)})}}fire(){return this.cooldown+=ei,u.Instance.consume(this,this.speedMultiplier,this.damageMultiplier)&&(this.charging=!0,this.renderData.fired=!0),0}spawn(){[this.cleanupEventListener,this.coveredTiles]=_e(this,es.range,Xe)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=Be(t),this.damageMultiplier=Re(t)}getCooldown(){return this.cooldown}getType(){return c.Tesla}hit(t){this.hp-=t,this.hp<=0&&(this.renderData.destroyed=!0,u.Instance.getSurface().despawnStatic(this))}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=ei,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}};let qt=es;a(qt,"scale",2),a(qt,"range",8),a(qt,"maxStunnedEnemies",0);const mi={[c.ElectricFence]:.05,[c.Laser]:.003,[c.Railgun]:5,[c.Tesla]:4,[c.Mortar]:2},Qt=class{constructor(){a(this,"generators",new Set);a(this,"consumption",0);a(this,"blackout",!1);a(this,"power",0);Qt.instance=this}registerGenerator(t){this.generators.add(t)}removeGenerator(t){this.generators.delete(t)}getProduction(){return u.Instance.getBase().getPartsCount(c.PowerPlant)*Qt.powerMultiplier}getConsumption(){return this.consumption}consume(t){return t===0?!0:this.blackout?!1:(this.power-=t,this.power<0?(this.power=0,this.blackout=!0,A.Instance.triggerEvent(E.BlackOut),u.Instance.triggerStatUpdate(),!1):(this.consumption+=t,!0))}processPower(){this.power=this.power+this.getProduction(),this.blackout=!1,this.power<0&&A.Instance.triggerEvent(E.BlackOut),u.Instance.getIsStarted()||(this.consumption=0)}emergencyRegenerate(t=1){this.power=this.power+(Qt.baseEmergencyRegenerate+u.Instance.getBase().getParts().size*Qt.emergencyRegenerateMultiplier)*t,this.blackout=!1}getPower(){return this.power}serialize(){return{power:this.power,consumption:this.consumption,generators:[...this.generators].map(t=>{const e=t.getTile();return{x:e.getX(),y:e.getY()}})}}static get Instance(){return this.instance}static deserialize(t,e){const s=new Qt;s.power=e.power,s.consumption=e.consumption,s.generators=new Set(e.generators.map(({x:i,y:r})=>t.getTile(i,r).getStaticEntity().getAgent()))}};let W=Qt;a(W,"speedBeaconConsumption",1.1),a(W,"damageBeaconConsumption",1.2),a(W,"instance"),a(W,"powerMultiplier",5),a(W,"baseEmergencyRegenerate",30),a(W,"emergencyRegenerateMultiplier",2);const Ko=.002;class qo{constructor(t,e,s){a(this,"entity");a(this,"category",k.Unknown);a(this,"renderData",{});a(this,"time",0);a(this,"travelTime");this.tile=t,this.target=e,this.damage=s,this.entity=new tt(t.getX()+.5,t.getY()+.5,this);const i=t.getX()-e.getX(),r=t.getY()-e.getY(),o=Math.sqrt(i*i+r*r);this.travelTime=o/Ko,this.time=this.travelTime/4,this.entity.lookAt(e)}tick(t){this.time>=this.travelTime&&(u.Instance.getSurface().despawn(this),[...u.Instance.getSurface().getEntitiesForCategory(k.Enemy)].filter(s=>sa.call(this,s.getAgent(),1)).forEach(s=>{s.getAgent().AI.hit(this.damage)})),this.time=Math.min(this.time+t,this.travelTime);const e=this.time/this.travelTime;this.entity.setX(Rt(this.tile.getX(),this.target.getX(),e)+.5),this.entity.setY(Rt(this.tile.getY(),this.target.getY(),e)+.5)}getType(){return c.Shockwave}getTile(){return this.tile}isVisible(){return!0}}const Qo=1e3,Zo=200,Jo=[[0,0],[1,0],[1,1],[0,1]],tc=[[[-1,0],[-1,-1],[0,-1]],[[0,-1],[1,-1],[1,0]],[[1,0],[1,1],[0,1]],[[0,1],[-1,1],[-1,0]]];var bs;let Ks=(bs=class{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"hp",30);a(this,"invincibleTime",0);a(this,"renderData",{});a(this,"baseParts",new Set);a(this,"basePartsByType",new Map);this.tile=t,this.entity=new V(t.getX(),t.getY(),this),this.baseParts.add(this)}tick(t){this.invincibleTime=Math.max(0,this.invincibleTime-t)}getType(){return c.Base}getTile(){return this.tile}updateTile(t){this.tile=t}getHp(){return this.hp}spawn(){J.Instance.registerAgent(this),De(this,4)}despawn(){J.Instance.removeAgent(this)}hit(t){this.invincibleTime>0||this.hp<=0||(this.hp-=t,this.hp<=0?(u.Instance.showMessage("You lose!",{closable:!1,expires:0}),u.Instance.getSurface().forceRerender(),A.Instance.triggerEvent(E.Lose)):(this.invincibleTime=Qo,this.shockwave()),u.Instance.triggerStatUpdate(),A.Instance.triggerEvent(E.HitBase))}regenerate(t=1){this.hp+=this.getRegenerationFactor()*t}isVisible(){return!0}isDestroyed(){return this.hp<=0}addPart(t){this.baseParts.add(t),this.basePartsByType.set(t.getType(),(this.basePartsByType.get(t.getType())??0)+1)}removePart(t){this.baseParts.delete(t),this.basePartsByType.set(t.getType(),this.basePartsByType.get(t.getType())-1)}getParts(){return this.baseParts}getPartsCount(t){return this.basePartsByType.get(t)??0}getRegenerationFactor(){const t=this.getPartsCount(c.Armory),e=this.getPartsCount(c.Barracks);return t*50/(t+25)+e*50/(e+25)}getMoneyFactor(){const t=this.getPartsCount(c.Market);return 1+t*2.5/(t+25)}shockwave(){const t=u.Instance.getSurface(),e=new Map;this.baseParts.forEach(s=>{Jo.forEach(([i,r],o)=>{const h=t.getTile(s.getTile().getX()+i,s.getTile().getY()+r);tc[o].forEach(([l,p])=>{const g=t.getTile(s.getTile().getX()+i+l,s.getTile().getY()+r+p);g&&!e.has(g.getHash())&&pr.has(g.getType())&&e.set(g.getHash(),[h,g])})})}),e.forEach(([s,i])=>{const r=new qo(s,i,Zo);t.spawn(r)})}},a(bs,"scale",2),a(bs,"baseEmergencyRepair",15),bs);const ra={name:"Fence",description:"A simple fence that land-based enemies have to walk around. If the fence becomes too long however, they will climb over it. Fences are low to towers can shoot over them.",entity:Ai,entityType:c.Fence,htmlElement:"🥅"},oa={name:"Wall",description:"A large solid wall that land-based enemies have to walk around. A wall is equivalent to a tower that does not shoot meaning enemies will avoid them but will destroy them if left with no other option.",entity:aa,entityType:c.Wall,htmlElement:"🚧"},ec={name:"Electric fence",description:"Electric fences are similar to their normal counterpart but enemies are far less likely to climb over them. If they do they will also continuously receive damage, given that you have enough power stored.",entity:Cs,entityType:c.ElectricFence,htmlElement:"⚡"},ca={name:"Tar",description:"A large area of sticky goo that slows down land-based enemies that walk over it. The area does not repel or attract enemies so they still have to be guided to walk over it.",entity:ki,entityType:c.Freezer,htmlElement:"🦠"},Oi={name:"Tower",description:"The cheapest and most basic tower. It has poor range and deals little damage.",entity:na,entityType:c.Tower,htmlElement:"🗼"},ha={name:"Mortar",description:"A powerful tower with a large range that can shoot over obstacles. It also deals splash damage, hurting all enemies near the impact. Reload speed and travel time of the projectile is slow though.",entity:_s,entityType:c.Mortar,htmlElement:"🛰️"},la={name:"Flamethrower",description:"A turret intended for close range combat. It continuously hurts a single enemy within range. Enemies that were lit on fire will also keep burning for a while.",entity:me,entityType:c.Flamethrower,htmlElement:"🧯"},ua={name:"Railgun",description:"A powerful tower with a large range that can pierce enemies. It shoots relatively fast and deals massive damage to an enemy and all enemies behind it at the cost of consuming power.",entity:Bs,entityType:c.Railgun,htmlElement:"🌡️"},Me={name:"Sell",description:"Sell parts or blueprints. Blueprints and parts placed before the start of a wave are fully refunded. Other parts give back half their original cost when sold, but this can be improved by placing markets.",entityType:c.None,htmlElement:"❌"},da={name:"Radar",description:"A part of your base that exposes a large area in the direction that it was placed in. Exposed enemy bases are immediately neutralized when exposed by a radar.",entity:Bi,entityType:c.Radar,htmlElement:"📡",isBasePart:!0},ga={name:"Power plant",description:"A part of your base that generates an amount power at the start of every wave. Power can be stored across waves and is consumed by various towers. More power plants will generate more power but there are diminishing returns.",entity:Ci,entityType:c.PowerPlant,htmlElement:"🏭",isBasePart:!0},sc={name:"Armory",description:"A part of your base that regenerates hit points at the end of every wave. More armories will regenerate more hit points but there are diminishing returns.",entity:xi,entityType:c.Armory,htmlElement:"🏰",isBasePart:!0},pa={name:"Barracks",description:"A part of your base mainly intended for being able to place more turrets. It also regenerates a bit of hit points at the end of every wave. More barracks will regenerate more hit points but there are diminishing returns.",entity:Li,entityType:c.Barracks,htmlElement:"🏰",isBasePart:!0},fa={name:"Market",description:"A part of your base that increases the amount of money you get per wave and increases the percentage you get back when selling a part. More markets will increase the multiplier but there are diminishing returns.",entity:Pi,entityType:c.Market,htmlElement:"🏪",isBasePart:!0},ma={name:"Speed Beacon",description:"A building that increases the reload speed of cardinally adjacent towers at the cost of some power for every shot fired. If there is no power (left) the towers will continue working as normal without a speed boost. Keep in mind that the beacon also blocks tower sight lines.",entity:be,entityType:c.SpeedBeacon,htmlElement:"⏰"},ya={name:"Damage Beacon",description:"A building that increases the damage of cardinally adjacent towers at the cost of some power for every shot fired. If there is no power (left) the towers will continue working as normal without a damage boost. Keep in mind that the beacon also blocks tower sight lines.",entity:Ie,entityType:c.DamageBeacon,htmlElement:"🚨"},wa={name:"Laser",description:"A reasonably powerful tower that lights enemies on fire, similar to the flamethrower. It has a larger range but consumes power in order to fire.",entity:ye,entityType:c.Laser,htmlElement:"🔭"},va={name:"Tesla",description:"A tower that starts charging when an enemy comes near and then damages and stuns all enemies within its range.",entity:qt,entityType:c.Tesla,htmlElement:"💡"},ic={name:"Excavator",description:"Allows building over trees and rocks.",entityType:c.Excavator,htmlElement:"🚜",cost:1},nc={name:"Terraform",description:"Allows building over water, ice and enemy structures. Keep in mind a stone foundation is also built which replaces the original surface.",entityType:c.Terraform,htmlElement:"🏗️",cost:1},Sa=100,ac={name:"Convert",description:`Convert a wave point in a flat ${Sa} gold.`,entityType:c.Convert,htmlElement:"🪙",isRepeatable:!0,cost:1},Ds=1.5,rc={name:"Emerg. recharge",description:`Generate power ${W.baseEmergencyRegenerate} power + ${W.emergencyRegenerateMultiplier} power for every base tile built. This can also be done during a wave, but doing it between waves is ${Ds} as efficient.`,entityType:c.EmergencyRecharge,htmlElement:"🔌",isRepeatable:!0,cost:1},oc={name:"Emerg. repair",description:`Regenerate ${Ks.baseEmergencyRepair} health + 1 health for every base tile built. This can also be done during a wave, but doing it between waves is ${Ds} as efficient.`,entityType:c.EmergencyRepair,htmlElement:"🛠",isRepeatable:!0,cost:1};var Fi=(n=>(n.Construction="Construction",n.Defensive="Defensive buildings",n.BasicBuildings="Basic buildings",n.PoweredBuildings="Powered Buildings",n.BaseBuildings="Base Buildings",n.WildcardBuildings="Wildcard Buildings",n.Abilities="Abilities",n))(Fi||{});const Ea={Construction:[Me,ic,nc],["Defensive buildings"]:[ra,oa,va],["Basic buildings"]:[Oi,la,ha],["Powered Buildings"]:[ga,wa,ua],["Base Buildings"]:[pa,da,fa],["Wildcard Buildings"]:[ca,ma,ya],Abilities:[ac,rc,oc]},cc=[Me,ra,oa,ec,ca,Oi,ha,la,ua,da,ga,sc,fa,ma,ya,wa,pa,va],pn=new Set(cc.map(n=>n.entityType));let yi=class{constructor(t,e,s){a(this,"entity");a(this,"category",k.Player);a(this,"renderData",{});this.tile=t,this.placeable=e,this.scaleOverride=s,this.entity=new tt(t.getX(),t.getY(),this)}getType(){return c.Blueprint}getTile(){return this.tile}isVisible(){return!0}getPlaceable(){return this.placeable}getScale(){var t;return((t=this.placeable.entity)==null?void 0:t.scale)||this.scaleOverride||1}isDelete(){return this.placeable.entityType===c.None}isBasePart(){return!!this.placeable.isBasePart}};const hc=n=>n.getType()===c.Blueprint,vs=(n,t,e,s)=>{const i=e.getTile(),r=new Set([i]),o=s.getAdjacentTiles(i,2);for(;o.length>0;){const h=o.pop();n.has(h)||r.has(h)||!t.has(h)&&(!h.hasStaticEntity()||!e.getParts().has(h.getStaticEntity().getAgent()))||(r.add(h),s.getAdjacentTiles(h,2).forEach(l=>o.push(l)))}return r.size===e.getParts().size+t.size-n.size},lc=(n,t,e,s=!1)=>{const i=new Set([n]),r=t.getAdjacentTiles(n,2,s);for(;r.length>0;){const o=r.pop();i.has(o)||!o.hasStaticEntity()||!e.has(o.getStaticEntity().getAgent().getType())||(i.add(o),t.getAdjacentTiles(o,2,s).forEach(h=>r.push(h)))}return i.size},Te={[c.Fence]:1,[c.Wall]:3,[c.ElectricFence]:9,[c.Freezer]:6,[c.Tower]:12,[c.Flamethrower]:18,[c.Mortar]:40,[c.Railgun]:60,[c.Radar]:20,[c.PowerPlant]:20,[c.Armory]:50,[c.Market]:30,[c.SpeedBeacon]:50,[c.DamageBeacon]:40,[c.Laser]:25,[c.Barracks]:15,[c.Tesla]:50},Ot=class{constructor(t=0,e=()=>1){a(this,"recentlyBought",new Set);a(this,"removeUnlockEventListener");this.money=t,this.multiplier=e,Ot.instance&&Ot.instance.removeUnlockEventListener(),Ot.instance=this,this.removeUnlockEventListener=A.Instance.addEventListener(E.Unlock,({placeable:s})=>{s.entityType===c.Convert&&(this.addMoney(Sa),u.Instance.triggerStatUpdate())})}setMoney(t){this.money=t}addMoney(t){this.money+=t}addWaveBudget(t){this.addMoney(Math.ceil((Ot.waveBudget+Ot.waveBudget*t/3)*this.multiplier()))}buy(t){if(u.Instance.getDifficulty()===$.Practice)return;let e=t.getType();hc(t)&&(e=t.getPlaceable().entityType);const s=Te[e]??0;if(s>this.money)throw new Error("Not enough money!");this.money-=s,this.recentlyBought.add(t)}replaceBlueprint(t,e){this.recentlyBought.has(t)&&(this.recentlyBought.delete(t),this.recentlyBought.add(e))}sell(t){u.Instance.getDifficulty()!==$.Practice&&(t instanceof yi?this.addMoney(Te[t.getPlaceable().entityType]??0):this.addMoney(this.getValue(t)))}getMoney(){return this.money}getMultiplier(){return this.multiplier()}clearRecents(){this.recentlyBought.clear()}isRecent(t){return this.recentlyBought.has(t)}getValue(t){const e=Math.min(.9,Ot.sellMultiplier*u.Instance.getBase().getMoneyFactor()),s=Te[t.getType()]??0;return Math.ceil(s*(this.recentlyBought.has(t)?1:e))}serialize(){return{money:this.money}}static get Instance(){return this.instance}static deserialize(t,e){return new Ot(e.money===null?Number.POSITIVE_INFINITY:e.money,t)}};let H=Ot;a(H,"waveBudget",20),a(H,"sellMultiplier",.5),a(H,"instance");const Ns=class{constructor(){a(this,"unlockedTowers");a(this,"availableUnlocks");a(this,"unlockLinkedMap");a(this,"points",0);a(this,"unlockedAmount",0);Ns.instance=this,this.unlockedTowers=new Set,this.availableUnlocks=new Set,this.unlockLinkedMap=new Map,Object.values(Fi).forEach(t=>{const e=Ea[t];e.forEach((s,i)=>{if(i===0){this.unlockedTowers.add(s.entityType),s.isRepeatable&&this.availableUnlocks.add(s.entityType);return}this.unlockedTowers.has(e[i-1].entityType)&&(this.availableUnlocks.add(s.entityType),s.isRepeatable&&this.unlockedTowers.add(s.entityType)),e.length>i+1&&this.unlockLinkedMap.set(s.entityType,e[i+1])})})}addPoints(t=1){this.points+=t}getPoints(){return this.points}canUnlock(t){return this.availableUnlocks.has(t.entityType)&&this.points>=(t.cost??1)}isUnlocked(t){return this.unlockedTowers.has(t.entityType)}getUnlockAmount(){return this.unlockedAmount}unlock(t){if(!this.canUnlock(t))throw new Error(`Can't unlock ${t.entityType}`);this.points-=t.cost??1,this.makeAvailable(t),A.Instance.triggerEvent(E.Unlock,{placeable:t})}serialize(){return{points:this.points,unlockedAmount:this.unlockedAmount,unlockedTowers:[...this.unlockedTowers],availableUnlocks:[...this.availableUnlocks]}}makeAvailable(t){t.isRepeatable||(this.unlockedTowers.add(t.entityType),this.availableUnlocks.delete(t.entityType),this.unlockedAmount++);const e=this.unlockLinkedMap.get(t.entityType);e&&(this.availableUnlocks.add(e.entityType),e.isRepeatable&&this.makeAvailable(e))}static get Instance(){return this.instance}static deserialize(t){const e=new Ns;e.points=t.points,e.unlockedAmount=t.unlockedAmount,e.availableUnlocks=new Set(t.availableUnlocks),e.unlockedTowers=new Set(t.unlockedTowers)}};let xt=Ns;a(xt,"instance");const it=class{constructor(t){a(this,"blueprints",new Map);a(this,"pendingBaseAdditions",[]);a(this,"pendingBaseRemovals",[]);a(this,"freeTiles");a(this,"ignoredEntities");a(this,"clearableEntities");a(this,"removeUnlockEventListener");this.surface=t,it.instance&&it.instance.removeUnlockEventListener(),it.instance=this,this.freeTiles=new Set(Ti),this.ignoredEntities=new Set,this.clearableEntities=new Set(pn),this.removeUnlockEventListener=A.Instance.addEventListener(E.Unlock,({placeable:e})=>{e.entityType===c.Excavator&&(this.ignoredEntities.add(c.Tree),this.ignoredEntities.add(c.Pine),this.ignoredEntities.add(c.Cactus),this.ignoredEntities.add(c.Rock),this.ignoredEntities.add(c.Rock2),this.ignoredEntities.add(c.Rock3),this.ignoredEntities.add(c.Stump),this.clearableEntities.add(c.Tree),this.clearableEntities.add(c.Pine),this.clearableEntities.add(c.Cactus),this.clearableEntities.add(c.Rock),this.clearableEntities.add(c.Rock2),this.clearableEntities.add(c.Rock3),this.clearableEntities.add(c.Stump)),e.entityType===c.Terraform&&(this.freeTiles.add(f.Water),this.freeTiles.add(f.Ice),this.freeTiles.add(f.Spore),this.freeTiles.add(f.Bridge))})}getMaxTowers(){return 1+(u.Instance.getBase().getParts().size+1)*it.towersPerPart}build(t,e){if(e.entityType===c.None||e.entityType===c.Excavator){u.Instance.getIsStarted()?this.sellBlueprints(t):this.sellEntities(t);return}if(!u.Instance.getIsStarted()&&e.entityType===c.Terraform&&xt.Instance.isUnlocked(e)){const s=t.map(i=>{var o;const r=(o=i.getStaticEntity())==null?void 0:o.getAgent();return r&&r.category!==k.Player&&(u.Instance.getSurface().despawnStatic(r),r.getType()===c.Tree&&(r.renderData.chopped=!0)),new Q(i.getX(),i.getY(),f.Stone)});u.Instance.getSurface().setTiles(s);return}!pn.has(e.entityType)||!xt.Instance.isUnlocked(e)||(u.Instance.getIsStarted()?this.placeBlueprints(t,e):this.placeEntities(t,e))}commit(){const t=[];this.blueprints.forEach(e=>{const s=e.getTile(),i=this.surface.getEntityTiles(s.getX(),s.getY(),e.getScale());if(this.surface.despawn(e),i.forEach(h=>{if(!h.hasStaticEntity())return;const l=h.getStaticEntity().getAgent();H.Instance.sell(l),this.surface.despawnStatic(l),l.getType()===c.Tree&&(l.renderData.chopped=!0)}),e.isDelete())return;const r=e.getPlaceable().entity,o=new r(s);this.spawn(o),H.Instance.replaceBlueprint(e,o),t.push(s)}),this.pendingBaseAdditions=[],this.pendingBaseRemovals=[],this.blueprints.size!==0&&(this.blueprints.clear(),u.Instance.triggerStatUpdate(),t.length>0&&A.Instance.triggerEvent(E.Buy,{tiles:t}))}getPendingTiles(t,e=!1){const s=new Set(this.pendingBaseAdditions.map(o=>this.surface.getTile(o.entity.getAlignedX(),o.entity.getAlignedY()))),i=new Set(this.pendingBaseRemovals.map(o=>this.surface.getTile(o.entity.getAlignedX(),o.entity.getAlignedY())));let r=o=>{s.delete(o)||i.delete(o)||i.add(o)};return t.forEach(o=>{if(e){r(o);return}const h=this.blueprints.get(o.getHash());if(h){if(h.isDelete()){i.delete(o);return}s.add(o);return}s.add(o)}),{pendingBaseAdditions:s,pendingBaseRemovals:i}}serialize(){return{freeTiles:[...this.freeTiles],ignoredEntities:[...this.ignoredEntities],clearableEntities:[...this.clearableEntities]}}placeBlueprints(t,e){const s=t.filter(i=>this.checkIsFree(i,e.entity.scale,!0));if(e.isBasePart){const{pendingBaseAdditions:i,pendingBaseRemovals:r}=this.getPendingTiles(t);if(!vs(r,i,u.Instance.getBase(),this.surface)){u.Instance.showMessage("Not all tiles connect to the base");return}}s.length===0||!u.Instance.canBuy(e,s.length)||(s.forEach(i=>{this.surface.getEntityTiles(i.getX(),i.getY(),e.entity.scale).forEach(h=>{const l=this.blueprints.get(h.getHash());l&&(H.Instance.sell(l),this.freeBlueprint(l),l.isBasePart()?this.pendingBaseAdditions.splice(this.pendingBaseAdditions.indexOf(l),1):h.hasStaticEntity()&&it.baseParts.has(h.getStaticEntity().getAgent().getType())&&this.pendingBaseRemovals.splice(this.pendingBaseRemovals.indexOf(l),1),l.isDelete()&&h.hasStaticEntity()&&it.baseParts.has(h.getStaticEntity().getAgent().getType())&&this.pendingBaseRemovals.splice(this.pendingBaseRemovals.indexOf(l),1))});const o=new yi(i,e);H.Instance.buy(o),this.reserveBlueprint(o),e.isBasePart&&(!i.hasStaticEntity()||!it.baseParts.has(i.getStaticEntity().getAgent().getType()))&&this.pendingBaseAdditions.push(o)}),u.Instance.triggerStatUpdate())}sellBlueprints(t){const e=t.find(o=>this.blueprints.has(o.getHash()));let s=t.filter(o=>e?!!this.blueprints.has(o.getHash()):!!(o.hasStaticEntity()&&this.clearableEntities.has(o.getStaticEntity().getAgent().getType())));const{baseTiles:i,otherTiles:r}=this.splitTiles(s);if(i.length){const{pendingBaseAdditions:o,pendingBaseRemovals:h}=this.getPendingTiles(i,!0);vs(h,o,u.Instance.getBase(),this.surface)||(s=r,u.Instance.showMessage("Not all base parts can be sold"))}s.length!==0&&(s.forEach(o=>{if(e){const h=this.blueprints.get(o.getHash());h&&(h.isDelete()||(H.Instance.sell(h),o.hasStaticEntity()&&it.baseParts.has(o.getStaticEntity().getAgent().getType())&&this.pendingBaseRemovals.splice(this.pendingBaseRemovals.indexOf(h),1)),h.isBasePart()&&(!o.hasStaticEntity()||!it.baseParts.has(o.getStaticEntity().getAgent().getType()))&&this.pendingBaseAdditions.splice(this.pendingBaseAdditions.indexOf(h),1),this.freeBlueprint(h),o.hasStaticEntity()&&it.baseParts.has(o.getStaticEntity().getAgent().getType())&&this.pendingBaseRemovals.splice(this.pendingBaseRemovals.indexOf(h),1));return}if(o.hasStaticEntity()&&!this.blueprints.get(o.getHash())){const h=o.getStaticEntity().getAgent(),l=new yi(h.getTile(),Me,$t(h));this.reserveBlueprint(l),it.baseParts.has(h.getType())&&this.pendingBaseRemovals.push(l)}}),u.Instance.triggerStatUpdate())}placeEntities(t,e){if(e.entity.range>1&&this.surface.getTowers().size>=this.getMaxTowers()){u.Instance.showMessage("The base needs to be extended to support additional towers");return}const i=t.filter(r=>this.checkIsFree(r,e.entity.scale));if(e.isBasePart&&!vs(new Set,new Set(i),u.Instance.getBase(),this.surface)){u.Instance.showMessage("Not all tiles connect to the base");return}i.length===0||!u.Instance.canBuy(e,i.length)||(i.forEach(r=>{const o=new e.entity(r);this.surface.getEntityTiles(o).forEach(h=>{if(h.hasStaticEntity()){const l=h.getStaticEntity().getAgent();l.getType()===c.Tree&&(l.renderData.chopped=!0),this.surface.despawnStatic(l)}}),this.spawn(o),H.Instance.buy(o)}),u.Instance.triggerStatUpdate(),A.Instance.triggerEvent(E.Buy,{tiles:i}))}sellEntities(t){let e=t.filter(r=>!!(r.hasStaticEntity()&&this.clearableEntities.has(r.getStaticEntity().getAgent().getType())));const{baseTiles:s,otherTiles:i}=this.splitTiles(e);if(s.length){const{pendingBaseAdditions:r,pendingBaseRemovals:o}=this.getPendingTiles(s,!0);vs(o,r,u.Instance.getBase(),this.surface)||(e=i,u.Instance.showMessage("Not all base parts can be sold"))}e.length!==0&&(e.forEach(r=>{if(r.hasStaticEntity()){const o=r.getStaticEntity().getAgent();this.surface.despawnStatic(o),H.Instance.sell(o),(o.getType()===c.Tree||o.getType()===c.Pine)&&(o.renderData.chopped=!0)}}),u.Instance.triggerStatUpdate(),A.Instance.triggerEvent(E.Sell))}splitTiles(t){const e=new Set,s=[];return t.forEach(i=>{const r=this.blueprints.get(i.getHash());if(r&&r.isBasePart()){e.add(r.getTile());return}i.hasStaticEntity()&&it.baseParts.has(i.getStaticEntity().getAgent().getType())?e.add(i.getStaticEntity().getAgent().getTile()):s.push(i)}),{baseTiles:[...e],otherTiles:s}}checkIsFree(t,e,s=!1){return!this.surface.getEntityTiles(t.getX(),t.getY(),e).find(r=>{if(!this.freeTiles.has(r.getBaseType())||r.hasStaticEntity()&&!this.ignoredEntities.has(r.getStaticEntity().getAgent().getType())&&(!s||!this.clearableEntities.has(r.getStaticEntity().getAgent().getType())))return!0})}reserveBlueprint(t){this.surface.spawn(t);const e=t.getTile();this.surface.getEntityTiles(e.getX(),e.getY(),t.getScale()).forEach(s=>this.blueprints.set(s.getHash(),t))}freeBlueprint(t){this.surface.despawn(t);const e=t.getTile();this.surface.getEntityTiles(e.getX(),e.getY(),t.getScale()).forEach(s=>this.blueprints.delete(s.getHash()))}spawn(t){this.surface.getEntityTiles(t).forEach(e=>{it.surfacesRequiringFoundation.has(e.getBaseType())&&this.surface.setTile(new Q(e.getX(),e.getY(),f.Stone))}),this.surface.spawnStatic(t)}static get Instance(){return this.instance}static deserialize(t,e){const s=new it(t);return s.freeTiles=new Set(e.freeTiles),s.ignoredEntities=new Set(e.ignoredEntities),s.clearableEntities=new Set(e.clearableEntities),s}};let q=it;a(q,"instance"),a(q,"towersPerPart",2),a(q,"baseParts",new Set([c.Barracks,c.Armory,c.Radar,c.Market,c.PowerPlant])),a(q,"surfacesRequiringFoundation",new Set([f.Water,f.Ice,f.Spore,f.Bridge]));var st=(n=>(n.Shift="Shift",n.Control="Control",n.Meta="Meta",n.Plus="+",n.Minus="-",n.Equals="=",n.Up="ArrowUp",n.Left="ArrowLeft",n.Right="ArrowRight",n.Down="ArrowDown",n.Escape="Escape",n.W="w",n.A="a",n.S="s",n.D="d",n.Z="z",n.Q="q",n.B="b",n.E="e",n.F="f",n))(st||{}),Ia=(n=>(n.Single="single",n.Line="line",n.StraightLine="straightLine",n.grid="grid",n))(Ia||{});const uc=new Set(Object.values(st));function fn(n){return uc.has(n)}const Gi=class{constructor(){a(this,"mouseDownX",0);a(this,"mouseDownY",0);a(this,"mouseX",0);a(this,"mouseY",0);a(this,"pressedKeys",{});a(this,"touches",0);a(this,"canBuild",!0);a(this,"eventHandlers",new Map);a(this,"surface");a(this,"selectedPlacable",Me);a(this,"previousSelectedPlacable",Oi);a(this,"buildMenuOpen",!1);a(this,"isPaused",!1);Gi.instance=this}initialize(t){this.surface=t}getPlacable(){return this.selectedPlacable}setPlaceable(t){this.selectedPlacable=t,A.Instance.triggerEvent(E.SelectPlaceable,{placeable:t})}mouseDown(t,e){this.mouseDownX=t,this.mouseDownY=e,this.mouseX=t,this.mouseY=e,this.touches++,this.touches>1&&(this.canBuild=!1)}mouseMove(t,e){this.mouseX=t,this.mouseY=e}getSelection(){var i,r,o,h;if(this.touches===0||!this.canBuild)return[];let t=this.mouseX,e=this.mouseY;if(this.pressedKeys.Control||this.pressedKeys.Meta){let l=[];return this.surface.forRect(this.mouseDownX,this.mouseDownY,t,e,p=>{p.isDiscovered()&&l.push(p)},{scale:((r=(i=this.selectedPlacable)==null?void 0:i.entity)==null?void 0:r.scale)||1}),l}this.pressedKeys.Shift&&(Math.abs(t-this.mouseDownX)>Math.abs(e-this.mouseDownY)?e=this.mouseDownY:t=this.mouseDownX);let s=[];return this.surface.forLine(this.mouseDownX,this.mouseDownY,t,e,l=>{l.isDiscovered()&&s.push(l)},{scale:((h=(o=this.selectedPlacable)==null?void 0:o.entity)==null?void 0:h.scale)||1}),s}mouseUp(t,e,s){if(!this.selectedPlacable){this.touches--;return}if(this.touches===1)if(this.canBuild){const i=this.getSelection();q.Instance.build(i,this.selectedPlacable)}else this.canBuild=!0;this.touches--,s&&(this.mouseX=0,this.mouseY=0)}keyDown(t){fn(t)&&(this.pressedKeys[t]=!0)}keyUp(t){var e;if(fn(t)){if(this.pressedKeys[t]=!1,this.isPaused&&t!=="Escape")return;if((e=this.eventHandlers.get(t))==null||e.forEach(s=>s()),(t==="b"||t==="e")&&this.toggleBuildMenu(),t==="f")if(this.selectedPlacable!==Me)this.previousSelectedPlacable=this.selectedPlacable,this.setPlaceable(Me);else{const s=this.previousSelectedPlacable;this.previousSelectedPlacable=this.selectedPlacable,this.setPlaceable(s)}}}toggleBuildMenu(){this.buildMenuOpen=!this.buildMenuOpen,this.buildMenuOpen?A.Instance.triggerEvent(E.OpenBuildMenu):A.Instance.triggerEvent(E.CloseBuildMenu)}isKeyDown(t){return this.pressedKeys[t]??!1}addKeyListener(t,e){return this.eventHandlers.has(t)?this.eventHandlers.get(t).add(e):this.eventHandlers.set(t,new Set([e])),()=>this.removeKeyListener(t,e)}removeKeyListener(t,e){var s;(s=this.eventHandlers.get(t))==null||s.delete(e)}isMouseDown(){return this.touches>0}getMouse(t){var s,i;const e=t||((i=(s=this.selectedPlacable)==null?void 0:s.entity)==null?void 0:i.scale)||1;return[Math.floor(this.mouseX/e)*e,Math.floor(this.mouseY/e)*e]}getMode(){return this.touches===0?"single":this.pressedKeys.Control||this.pressedKeys.Meta?"grid":this.pressedKeys.Shift?"straightLine":"line"}pause(){this.isPaused=!0}unpause(){this.isPaused=!1}static get Instance(){return this.instance}};let Xt=Gi;a(Xt,"instance");const Ls=(n,t,e)=>new Promise(s=>{const i=A.Instance.addEventListener(t,(...r)=>{(!e||e(...r))&&(i(),s())})}).then(()=>n),ba=(n,t,e)=>new Promise(s=>{const i=A.Instance.addEventListeners(t,r=>{(!e||e(r))&&(i(),s())})}).then(()=>n),qs=(n,...t)=>e=>ba(u.Instance.showMessage(n,{override:e,expires:0}),t),dc=qs("Welcome to Open Tower Defense! Open the build menu by pressing {key: e}. You can also quickly select the most basic tower by pressing {key: f}.",E.OpenBuildMenu,E.StartWave),gc=n=>new Promise(t=>{if(u.Instance.getIsStarted()){Ls(n,E.EndWave).then(t);return}Ls(u.Instance.showMessage("Here you can choose which defenses to build. Consider picking the basic tower to beat the first wave. Towers in the 2nd and 3rd row can be unlocked later in the game.",{override:n,expires:0}),E.SurfaceChange,({affectedTiles:e})=>!!e.size).then(t)}),pc=n=>new Promise(t=>{const e=u.Instance.getDifficulty();if(e===$.Hard){t(n);return}ba(u.Instance.showMessage(`If you're new to the game you can click the {key: 🎯} button to view tower sight lines${e===$.Easy||e===$.Practice?" and enemy paths":" "} to check how effective your layout is.`,{override:n,expires:0}),[E.ToggleShowCoverage,E.StartWave]).then(t)}),fc=n=>new Promise(t=>{if(u.Instance.getIsStarted()){Ls(n,E.EndWave).then(t);return}Ls(u.Instance.showMessage("Start the wave when you are ready. Good luck!",{override:n,expires:0}),E.EndWave).then(t)}),mc=qs("Good job defeating the first wave! Things will quickly become more difficult from here on out! After every wave your visible radius will increase. When enemy spawn points are discovered they are disabled and you receive a point to unlock new technologies.",E.Discover),yc=qs("You gained a wave point by discovering a spawn point! Open the build menu in order to spend it.",E.OpenBuildMenu),wc=qs("There are both defensive and offensive upgrades, read the descriptions to understand their strengths! You can also trade wave points for bonuses in the last column.",E.CloseBuildMenu),mn=[dc,gc,pc,fc,mc,yc,wc];class vc{constructor(){a(this,"promise");a(this,"reject");a(this,"previousId",-1)}async start(){this.promise=new Promise(async(t,e)=>{this.reject=e,await Promise.resolve();for(let s=0;s<mn.length;s++){const i=mn[s];try{this.previousId=await Promise.race([i(this.previousId),this.promise])}catch{return}}t(-1)});try{await this.promise}catch{}}stop(){var t;(t=this.reject)==null||t.call(this),this.reject=void 0,this.promise=void 0}get isStarted(){return!!this.promise}}const wi=(n,t,e)=>{const s=Number(n);return isNaN(s)||t&&s<t?t??0:e&&s>e?e:s},Sc=(n,t)=>n!==""?wi(t):t,Ec=(n,t)=>t,Ic=(n,t)=>t,bc=(n,t)=>t;var Ts=(n=>(n[n.Growing=0]="Growing",n[n.Fixed=1]="Fixed",n))(Ts||{});class si{constructor(t,e=0,s=10){a(this,"size");a(this,"freeEntities",[]);a(this,"usedEntities",new Map);this.initializer=t,this.type=e,this.size=s;for(let i=0;i<s;i++)this.freeEntities.push(t(!1))}get(t){let e=this.usedEntities.get(t);if(e)return e;if(this.freeEntities.length===0){if(this.type===1)throw new Error("Pool is empty");this.size++}return e=this.initializer(!0,this.freeEntities.pop(),t),this.usedEntities.set(t,e),e}free(t){if(!this.usedEntities.has(t))return;let e=this.usedEntities.get(t);return this.usedEntities.delete(t),this.freeEntities.push(e),e}getSize(){return this.size}getUsed(){return this.usedEntities}}const Mc=(n,t,e)=>{const s=t.entity,i=s.getX(),r=s.getY(),o=Math.sqrt((i-t.targetX)**2+(r-t.targetY)**2);e.style.transformOrigin="0 0",e.style.opacity=`${1-.9*(t.time/Di)}`,e.style.transform=`translate(${i*n.xStep}px, ${r*n.yStep}px) rotate(${s.getRotation()}deg) scale(${o}, 0.1)`},Tc=(n,t,e)=>{const s=t.entity;e.style.opacity=`${1-.9*(t.time/pi)}`,e.style.transform=`translate(${(s.getX()+Math.random()*.3-.15)*n.xStep}px, ${(s.getY()+Math.random()*.3-.15)*n.yStep}px) rotate(${-s.getRotation()+180+Math.random()*10-5}deg)`},yn=1/4,$e=(n,t,e)=>{const s=t.entity,i=s.getId()%13/26-yn,r=(s.getId()+5)%17/34-yn,o=n.getTime()%13/3;let h=s.getRotation();t.AI.isAttacking()&&(h+=Math.sin(n.getTime()%Z/Z*5)*20),t.getStatus()===T.OnFire?(e.style.color="transparent",e.style.textShadow=`${Math.random()-.5}px ${Math.random()-.5}px ${o+2}px #E25822`):t.getStatus()===T.Normal&&(e.style.color="initial",e.style.textShadow="none"),e.style.transform=`translate(${(t.getOffsetX()+i)*n.xStep}px, ${(t.getOffsetY()+r)*n.yStep}px) rotate(${h}deg) scale(${t.getScale()})`},xc=1/4,Ac=1/8,kc=.0015,Pc=(n,t,e)=>{const s=t.entity,i=kc*(1+s.getId()%13/13),r=Math.sin((n.getTime()+s.getId())*i)/4-Ac,o=Math.cos((n.getTime()+s.getId())*i)/2-xc,h=n.getTime()%13/3,l=(s.getRotation()+360)%360,p=l>0&&l<180?-1:1;let g=0;t.AI.isBusy()&&(g+=Math.sin(n.getTime()%Z/Z*5)*20),t.getStatus()===T.OnFire?(e.style.color="transparent",e.style.textShadow=`${Math.random()-.5}px ${Math.random()-.5}px ${h+2}px #E25822`):t.getStatus()===T.Normal&&(e.style.color="initial",e.style.textShadow="none"),e.style.transform=`translate(${(s.getX()+r)*n.xStep}px, ${(s.getY()+o)*n.yStep}px) rotate(${g}deg) scale(${p},1)`},Cc=(n,t,e)=>{const s=t.entity;e.children[0].textContent=n.getStaticEntityEmoji(t.getPlaceable().entityType),e.style.transformOrigin="0 0",e.style.opacity="0.5",e.style.filter="grayscale(0.6)",e.style.transform=`translate(${s.getX()*n.xStep}px, ${s.getY()*n.yStep}px) rotate(${s.getRotation()}deg) scale(${t.getScale()})`},_c=(n,t,e)=>{const s=t.entity,i=s.getX(),r=s.getY(),o=Math.sqrt((i-t.targetX)**2+(r-t.targetY)**2);e.style.color="transparent",e.style.textShadow="0 0 0 #E25822",e.style.transformOrigin="0 0",e.style.opacity=`${1-.9*(t.time/Rs)}`,e.style.transform=`translate(${i*n.xStep}px, ${r*n.yStep}px) rotate(${s.getRotation()}deg) scale(${o}, 0.1)`},ii=(n,t,e)=>{const s=t.entity;e.style.transform=`translate(${(s.getX()-.5)*n.xStep}px, ${(s.getY()-.5)*n.yStep}px) rotate(${s.getRotation()}deg)`},Bc={[c.Rail]:Mc,[c.Flame]:Tc,[c.Slime]:$e,[c.Runner]:$e,[c.Flier]:Pc,[c.Tank]:$e,[c.Blueprint]:Cc,[c.LaserBeam]:_c,[c.Bullet]:ii,[c.Rocket]:ii,[c.Shockwave]:ii,[c.Behemoth]:$e,[c.Bore]:$e},Rc=5e3,Dc=at({__name:"Key",props:{char:{},area:{}},setup(n){const t=n,e=t.char>"A"&&t.char<"z";return(s,i)=>(x(),_("div",{class:ct({key:!0,emoji:!Y(e)}),style:Ke({gridArea:t.area})},F(t.char),7))}});const ht=(n,t)=>{const e=n.__vccOpts||n;for(const[s,i]of t)e[s]=i;return e},j=ht(Dc,[["__scopeId","data-v-8be0d2b3"]]),Lc=at({__name:"mouse",props:{button:{}},setup(n){const t=n;return(e,s)=>(x(),_("div",{class:ct(`mouse button-${t.button}`)},null,2))}});const xs=ht(Lc,[["__scopeId","data-v-135d4a7c"]]),Oc=at({__name:"TextWithControls",props:{text:{}},setup(n){const t=n,e={0:"left",1:"right",3:"middle"},s=R(t.text),i=R(""),r=R(""),o=R("");return ja(()=>t.text,h=>{const p=/^(?<left>.*?){(?<control>key|mouse): (?<type>.*?)}(?<right>.*)$/.exec(h);p?(s.value=p.groups.left,i.value=p.groups.control,r.value=p.groups.type,o.value=p.groups.right):(s.value=h,i.value="",r.value="",o.value="")},{immediate:!0}),(h,l)=>{const p=Ka("TextWithControls",!0);return x(),_(At,null,[L(F(s.value)+" ",1),i.value==="key"?(x(),ee(j,{key:0,char:r.value},null,8,["char"])):nt("",!0),i.value==="mouse"?(x(),ee(xs,{key:1,button:e[r.value]},null,8,["button"])):nt("",!0),o.value?(x(),ee(p,{key:2,text:o.value},null,8,["text"])):nt("",!0)],64)}}}),Fc={class:"message-wrapper"},Yc={class:"message-inner"},Xc=["onClick"],$c=at({__name:"SimpleMessage",props:{register:{type:Function}},setup(n){const t=n;let e=1;const s=()=>({id:e++,content:"",closable:!0,open:!1,removing:!1}),i=R([s()]),r=R(new Map),o=Yn(),h=(p,g)=>{let d,w=-1;if(g!=null&&g.override&&(w=i.value.findIndex(I=>I.id===g.override)),w!==-1){const I=i.value[w].id;window.clearTimeout(r.value.get(I)),r.value.delete(I),d=i.value[w]}else d=i.value.at(-1),i.value.push(s());d.closable=(g==null?void 0:g.closable)??!0,d.open=!0,d.content=p;const S=(g==null?void 0:g.expires)??Rc;if(S){const I=window.setTimeout(()=>{l(d)},S);r.value.set(d.id,I)}return Promise.resolve(d.id)},l=p=>{p.open=!1,p.removing=!0,o.proxy.$forceUpdate(),window.setTimeout(()=>{const g=i.value.indexOf(p);g>-1&&i.value.splice(g,1)},700)};return ke(()=>{t.register(h)}),(p,g)=>(x(),_("div",Fc,[(x(!0),_(At,null,ne(i.value,d=>(x(),_("div",{key:d.id,class:ct({message:!0,"message--visible":d.open,"message--removing":d.removing})},[y("div",Yc,[d.closable?(x(),_("button",{key:0,class:"close-button",onClick:()=>l(d)}," ✖ ",8,Xc)):nt("",!0),D(Oc,{text:d.content},null,8,["text"])])],2))),128))]))}});const Ma=ht($c,[["__scopeId","data-v-9cad4ea4"]]),et=navigator.appVersion.indexOf("Win")!=-1,Nc=42,Uc=4,zc=20;let he=!1,Yi=class{constructor(t){a(this,"pool");a(this,"selectionPool");a(this,"scaledTilesPool");a(this,"messageFn");a(this,"resolveMessageFn");a(this,"removeEventListeners");a(this,"surface");a(this,"xStep",0);a(this,"yStep",0);a(this,"offsetX",0);a(this,"offsetY",0);a(this,"time",0);a(this,"fontSize",zc);a(this,"hasMoved",!1);a(this,"_showCoverage",!1);a(this,"target",null);a(this,"app");a(this,"appContainer");a(this,"world",null);a(this,"rows",[]);a(this,"alertRanges",[]);a(this,"coverageMap",null);a(this,"coverageRows",[]);a(this,"showMessage",async(...t)=>(await this.messageFn)(...t));a(this,"getEmoji",t=>{const e=he||u.Instance.getIsBaseDestroyed();if(t.getDiscoveryStatus()===U.Pending&&!e)return"🔍";if(!t.isDiscovered()&&!e)return"&nbsp;";if(t.hasStaticEntity()&&$t(t.getStaticEntity().getAgent())!==2)return this.getStaticEntityEmoji(t.getStaticEntity().getAgent().getType());switch(t.getBaseType()){case f.Water:return"🟦";case f.Stone:return"⬜";case f.Grass:return"🟩";case f.Spore:return"🟪";case f.Bridge:return"📜";case f.Sand:return"🟨";case f.Snow:return"🌫️";case f.Dirt:return"🟫";case f.Ice:return"🧊";case f.Freezer:return"🦠";default:return"&nbsp;"}});this.controller=t,this.pool=new si((e,s,i)=>{if(s)return s.style.display="block",s.style.opacity="1",s.style.transformOrigin="50% 50%",s.style.filter="none",s.style.color="initial",s.style.textShadow="none",s.children[0].textContent=this.getEntityEmoji(i),s;const r=document.createElement("span");return r.appendChild(document.createElement("span")),et&&(r.children[0].style.margin="-0.35ch"),r.children[0].textContent=i?this.getEntityEmoji(i):"",r.style.position="absolute",r.style.top=et?"-.125ch":"-.075ch",r.style.left=et?".35ch":"0",r.style.display=e?"block":"none",r.style.willChange="transform",this.world.appendChild(r),r},Ts.Growing,0),this.selectionPool=new si((e,s)=>{if(s)return s.style.display="block",s;const i=document.createElement("span");return i.appendChild(document.createElement("span")),et&&(i.children[0].style.margin="-0.35ch"),i.children[0].textContent="🟧",i.style.transformOrigin="0 0",i.style.opacity="0.7",i.style.position="absolute",i.style.top=et?"-.125ch":"-.075ch",i.style.left=et?".35ch":"0",i.style.display=e?"block":"none",i.style.willChange="transform",this.world.appendChild(i),i},Ts.Growing,0),this.scaledTilesPool=new si((e,s,i)=>{if(s)return s.style.display="block",s.children[0].textContent=this.getStaticEntityEmoji(i.getAgent().getType()),s;const r=document.createElement("span");return r.appendChild(document.createElement("span")),et&&(r.children[0].style.margin="-0.35ch"),r.children[0].textContent=i?this.getStaticEntityEmoji(i.getAgent().getType()):"",r.style.transformOrigin="0 0",r.style.position="absolute",r.style.top=et?"-.125ch":"-.075ch",r.style.left=et?".35ch":"0",r.style.display=e?"block":"none",r.style.willChange="transform",this.world.appendChild(r),r},Ts.Growing,0),this.messageFn=new Promise(e=>this.resolveMessageFn=e),window.debug=()=>{he=!he,this.renderTiles()}}mount(t,e){this.surface=t,this.target=e,this.appContainer=e.appendChild(document.createElement("div")),this.app=Ei(Ma,{register:this.resolveMessageFn}),this.app.mount(this.appContainer),this.world=e.appendChild(document.createElement("div")),this.world.className="scrollable",this.world.style.lineHeight=et?"1.86ch":"1ch",this.world.style.whiteSpace="nowrap",this.world.style.cursor="crosshair",this.world.style.userSelect="none",this.world.style.position="relative",this.world.style.fontFamily='"Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Android Emoji","EmojiOne Mozilla","Twemoji Mozilla","Noto Emoji","Segoe UI Symbol",EmojiSymbols',this.world.style.backgroundColor="#000",et&&(this.world.style.letterSpacing="-0.7ch",this.world.style.wordSpacing="2.04ch"),this.renderTiles(),this.zoom();const{width:s,height:i}=this.world.getBoundingClientRect(),r=u.Instance.getBase().getTile();this.world.scrollLeft=r.getX()*this.xStep-s/2,this.world.scrollTop=r.getY()*this.yStep-i/2,this.rerender(0),this.registerEventHandlers(this.world)}zoom(){const t=(this.world.scrollLeft+this.world.clientWidth/2)/this.world.scrollWidth,e=(this.world.scrollTop+this.world.clientHeight/2)/this.world.scrollHeight;this.world.style.fontSize=`${this.fontSize}px`;const{width:s,height:i,x:r,y:o}=this.world.getBoundingClientRect(),h=this.world.scrollWidth,l=this.world.scrollHeight;this.xStep=h/this.surface.getWidth(),this.yStep=l/this.surface.getHeight(),this.offsetX=r,this.offsetY=o,this.world.scrollLeft=t*h-s/2,this.world.scrollTop=e*l-i/2}rerender(t){this.time+=t,this.surface.isDirty()&&this.renderTiles(),(this.surface.isDirty()||this.hasMoved)&&(this.renderStaticAgents(),this.renderAlertRanges());const e=this.surface.getEntities();for(let i of e){const r=Bc[i.getAgent().getType()];if(!this.getEntityEmoji(i)&&!r)continue;const o=this.pool.get(i);o.style.display=i.getAgent().isVisible()?"block":"none",r?r(this,i.getAgent(),o):o.style.transform=`translate(${i.getX()*this.xStep}px, ${i.getY()*this.yStep}px) rotate(${i.getRotation()}deg)`}this.surface.getDeletedEntities().forEach(i=>{const r=this.pool.free(i);r&&(r.style.display="none")}),this.renderSelection(),this.surface.markPristine()}showCoverage(){this._showCoverage=!0,this.renderTiles()}hideCoverage(){this._showCoverage=!1,this.renderTiles()}renderTiles(){const t=this.surface.getHeight();for(let e=0;e<t;e++){let s=this.rows[e];s||(s=document.createElement("div"),et&&(s.style.letterSpacing="-0.7ch"),this.rows[e]=s,this.world.appendChild(s));const i=this.surface.getRow(e).map(this.getEmoji).join("");s.innerHTML=i}this.renderCoverage()}renderStaticAgents(){const t=this.surface.getEntitiesForCategory(k.Player);for(let s of t){const i=s.getAgent();if(ui(i)&&$t(i)===2){const r=this.scaledTilesPool.get(s);r.style.transform=`translate(${s.getX()*this.xStep}px, ${s.getY()*this.yStep}px) scale(2)`}}this.surface.getDeletedEntities().forEach(s=>{const i=this.scaledTilesPool.free(s);i&&(i.style.display="none")})}async renderCoverage(){const t=he||u.Instance.getIsBaseDestroyed(),e=[];K.Instance.getSpawnGroups().forEach(o=>{e.push(o.getAsyncSpawnPoints())});const s=[];if((await Promise.all(e)).forEach(o=>s.push(o[0])),this.coverageMap||(this.coverageMap=document.createElement("div"),this.coverageMap.style.opacity="0.5",this.coverageMap.style.position="absolute",this.coverageMap.style.top="0",this.coverageMap.style.left=et?"-0.125ch":"0",et&&(this.coverageMap.style.letterSpacing="-0.7ch",this.coverageMap.style.wordSpacing="2.04ch"),this.world.appendChild(this.coverageMap)),this._showCoverage)this.coverageMap.style.display="block";else{this.coverageMap.style.display="none";return}const i=new Set;u.Instance.getDifficulty()===$.Easy&&s.forEach(o=>o.getTiles().forEach(h=>i.add(h)));const r=this.surface.getHeight();for(let o=0;o<r;o++){let h=this.coverageRows[o];h||(h=document.createElement("div"),this.coverageRows[o]=h,this.coverageMap.appendChild(h));const l=this.surface.getRow(o).map(p=>{if(!p.isDiscovered()&&!t)return"&nbsp;";const g=p.isCoveredByTower();return i.has(p)?g?"⚔️":"🐾":g?"🎯":"&nbsp;"}).join("");h.innerHTML=l}}renderSelection(){var i,r;const t=this.selectionPool.getUsed();let e=this.controller.getSelection();e.length===1&&(e=[]);const s=((r=(i=this.controller.getPlacable())==null?void 0:i.entity)==null?void 0:r.scale)||1;e.forEach((o,h)=>{const l=t.has(h)?t.get(h):this.selectionPool.get(h);l.style.transform=`translate(${o.getX()*this.xStep}px, ${o.getY()*this.yStep}px) scale(${s})`});for(let o=t.size-1;o>=e.length;o--){const h=this.selectionPool.free(o);h&&(h.style.display="none")}}renderAlertRanges(){const[t,e]=pt(u.Instance.getBase()),s=20*this.xStep,i=20*this.yStep,r=u.Instance.getIsStarted()?[]:K.Instance.getSpawnAlertRanges();r.forEach((o,h)=>{const l=o.getLength(),p=o.getCenter(),g=l/360;let d=this.alertRanges[h];if(!d){this.alertRanges[h]=d=document.createElementNS("http://www.w3.org/2000/svg","svg");const S=document.createElementNS("http://www.w3.org/2000/svg","circle");S.setAttribute("cx","50%"),S.setAttribute("cy","50%"),S.setAttribute("r","45%"),S.setAttribute("stroke","url(#alert)"),S.setAttribute("stroke-linecap","round"),S.setAttribute("fill","none"),d.appendChild(S);const I=document.createElementNS("http://www.w3.org/2000/svg","text");I.setAttribute("text-anchor","middle"),I.setAttribute("dominant-baseline","middle"),I.classList.add("alert"),d.appendChild(I),d.style.position="absolute",d.style.top=et?"-.125ch":"-.075ch",d.style.left=et?".35ch":"0",d.style.transformOrigin="50%",this.world.appendChild(d)}d.style.display="block",d.children[0].setAttribute("stroke-width",`${this.fontSize}`),d.children[1].style.transform=`translate(90%, 50%) rotate(-${p}deg)`,d.children[1].setAttribute("direction",p>270||p<90?"rtl":"ltr"),d.children[1].innerHTML="⚠️"+o.getUnits().map(this.getEntityTypeEmoji).join("");const w=s*.9*Math.PI;d.children[0].setAttribute("stroke-dasharray",`${w*g/2} ${w*(1-g)} ${w*g/2} 0`),d.style.width=`${s}px`,d.style.height=`${i}px`,d.style.transform=`translate(${t*this.xStep-s/2}px,${e*this.yStep-i/2}px) rotate(${p}deg)`});for(let o=r.length;o<this.alertRanges.length;o++)this.alertRanges[o].style.display="none"}unmount(){this.app&&(this.app.unmount(),this.target.removeChild(this.appContainer),this.target.removeChild(this.world),this.removeEventListeners(),this.messageFn=new Promise(t=>this.resolveMessageFn=t))}getTime(){return this.time}canMove(t,e){if(he||u.Instance.getIsBaseDestroyed())return!0;const i=this.getBBox(),r=J.Instance.getBBox();if(Math.abs(t)>Math.abs(e)){if(t<0&&i[0][0]<=r[0][0]||t>0&&i[1][0]>=r[1][0])return!1}else if(e<0&&i[0][1]<=r[0][1]||e>0&&i[1][1]>=r[1][1])return!1;return!0}registerEventHandlers(t){const e=g=>(g.preventDefault(),!1);t.addEventListener("contextmenu",e);const s=(g,d,w)=>{he||u.Instance.getIsBaseDestroyed()||(this.getBBox(),J.Instance.getBBox(),this.canMove(g,d)||w.preventDefault())},i=g=>{s(g.deltaX,g.deltaY,g)};t.addEventListener("wheel",i,{passive:!1});const r=g=>{const d=Math.floor((g.pageX-this.offsetX+this.world.scrollLeft)/this.xStep),w=Math.floor((g.pageY-this.offsetY+this.world.scrollTop)/this.yStep);this.controller.mouseDown(d,w)};t.addEventListener("pointerdown",r);const o=g=>{const d=Math.floor((g.pageX-this.offsetX+this.world.scrollLeft)/this.xStep),w=Math.floor((g.pageY-this.offsetY+this.world.scrollTop)/this.yStep);this.controller.mouseMove(d,w)};t.addEventListener("pointermove",o);const h=g=>{const d=Math.floor((g.pageX-this.offsetX+this.world.scrollLeft)/this.xStep),w=Math.floor((g.pageY-this.offsetY+this.world.scrollTop)/this.yStep);this.controller.mouseUp(d,w,g.pointerType==="touch")};t.addEventListener("pointerup",h);const l=g=>{this.controller.keyDown(g.key),g.preventDefault()};window.addEventListener("keydown",l);const p=g=>{this.controller.keyUp(g.key),g.preventDefault()};window.addEventListener("keyup",p),this.removeEventListeners=()=>{t.removeEventListener("contextmenu",e),t.removeEventListener("wheel",i),t.removeEventListener("pointerdown",r),t.removeEventListener("pointermove",o),t.removeEventListener("pointerup",h),window.removeEventListener("keydown",l),window.removeEventListener("keyup",p)}}move({x:t=0,y:e=0,zoom:s}){(t||e)&&this.canMove(t,e)&&(this.world.scrollLeft+=t*this.fontSize/2,this.world.scrollTop+=e*this.fontSize/2),s&&(s<0?this.fontSize=Math.max(Uc,this.fontSize*.9):this.fontSize=Math.min(Nc,this.fontSize*1.1),this.zoom(),this.hasMoved=!0)}getStaticEntityEmoji(t){switch(t){case c.Tower:return"🗼";case c.Wall:return"🧱";case c.Mortar:return"🛰️";case c.Flamethrower:return"🧯";case c.Railgun:return"🌡️";case c.ElectricFence:return"⚡";case c.Fence:return"🥅";case c.Freezer:return"🦠";case c.Base:return"⛺";case c.Tree:return"🌳";case c.Pine:return"🌲";case c.Cactus:return"🌵";case c.Stump:return"🪵";case c.Rock:case c.Rock2:case c.Rock3:return"🪨";case c.Radar:return"📡";case c.PowerPlant:return"🏭";case c.None:return"❌";case c.Armory:case c.Barracks:return"🏰";case c.Market:return"🏪";case c.SpeedBeacon:return"⏰";case c.DamageBeacon:return"🚨";case c.Laser:return"🔭";case c.Tesla:return"💡";default:return"❓"}}getEntityEmoji(t){return this.getEntityTypeEmoji(t.getAgent().getType())}getEntityTypeEmoji(t){switch(t){case c.Slime:return"🐞";case c.Bullet:case c.Rocket:return"▪";case c.Rail:case c.LaserBeam:return"⬛";case c.Flame:return"🔥";case c.Shockwave:return"🌀";case c.Runner:return"🪳";case c.Flier:return"🐝";case c.Tank:return"🦀";case c.WavePoint:return"🪙";case c.Spark:return"⚡️";case c.Behemoth:return"🦎";case c.Bore:return"🐙";default:return""}}getBBox(){const t=this.world.scrollTop/this.yStep,e=this.world.scrollLeft/this.xStep,s=this.world.clientHeight/this.yStep,i=this.world.clientWidth/this.xStep;return[[e,t],[e+i,t+s]]}};const ds=new Tt;ds.name="Floor";const Qs=new as(void 0,{position:!1},void 0,!0);Qs.name="Static";const Lt=new Tt;Lt.name="Base";const Ae=new Tt;Ae.name="Foliage";const ae=new Tt;ae.name="Projectiles";const Dt=new Tt;Dt.name="Towers";const zt=new Tt;zt.name="UI";const wn=[ds,Qs,Lt,Ae,ae,Dt,zt],m=32,vn=20,Wc=3,Hc=.5,vi=1,C="atlas";var v=(n=>(n.SporeParticle="atlas5.png",n.ActiveCoverage="atlas1.png",n.Coverage="atlas2.png",n.Alert="atlas3.png",n.Entity="atlas4.png",n.None="atlas0.png",n.Coin="atlas6.png",n.Runner="atlas7.png",n.Regular="atlas8.png",n.Flier="atlas9.png",n.Tank="atlas10.png",n.Behemoth="atlas11.png",n.Bore="atlas12.png",n.Fence="fence-00000000",n.ElectricFence="fence-00000000",n.Wall="wall-00000000",n.Tar="buildings11.png",n.DamageBeacon="buildings5.png",n.SpeedBeacon="buildings6.png",n.Base="buildings0.png",n.Barracks="buildings1.png",n.PowerPlant="buildings2.png",n.Radar="buildings3.png",n.Market="buildings4.png",n.Bullet="projectiles0.png",n.Fire="projectiles1.png",n.Rocket="projectiles2.png",n.Laser="projectiles3.png",n.Rail="projectiles4.png",n.Shockwave="projectiles5.png",n.Pine="foliage0.png",n.Tree="foliage1.png",n.Stump="foliage2.png",n.Cactus="foliage3.png",n.Rock="foliage5.png",n.RockAlt="foliage7.png",n.Lightning="lightning0.png",n.Frame="buildings10.png",n.FrameSpeed="buildings8.png",n.FrameDamage="buildings9.png",n.FrameSpeedDamage="buildings7.png",n.BarracksBlueprint="buildings12.png",n.PowerPlantBlueprint="buildings13.png",n.RadarBlueprint="buildings14.png",n.MarketBlueprint="buildings15.png",n.TowerBlueprint="buildings16.png",n.FlamethrowerBlueprint="buildings17.png",n.LaserBlueprint="buildings18.png",n.MortarBlueprint="buildings19.png",n.RailgunBlueprint="buildings20.png",n.TeslaBlueprint="buildings21.png",n.WallBlueprint="buildings22.png",n.FenceBlueprint="atlas13.png",n))(v||{});const Gc="base-1111",Vc=new Map([[c.DamageBeacon,v.DamageBeacon],[c.SpeedBeacon,v.SpeedBeacon],[c.Freezer,v.Tar]]);class Ta extends z{constructor(t,e){super(e.assets[C].textures[Vc.get(t.getType())??Gc]),this.data=t}sync(){this.position.set(this.data.entity.getX()*m,this.data.entity.getY()*m),this.angle=this.data.entity.getRotation()}}a(Ta,"layer",Lt);const Sn=new Map([[c.Armory,[C,v.BarracksBlueprint]],[c.Barracks,[C,v.BarracksBlueprint]],[c.PowerPlant,[C,v.PowerPlantBlueprint]],[c.Radar,[C,v.RadarBlueprint]],[c.Market,[C,v.MarketBlueprint]],[c.DamageBeacon,[C,v.DamageBeacon]],[c.SpeedBeacon,[C,v.SpeedBeacon]],[c.Freezer,[C,v.Tar]],[c.Fence,[C,v.FenceBlueprint]],[c.Wall,[C,v.WallBlueprint]],[c.ElectricFence,[C,v.FenceBlueprint]],[c.Tower,[C,v.TowerBlueprint]],[c.Flamethrower,[C,v.FlamethrowerBlueprint]],[c.Mortar,[C,v.MortarBlueprint]],[c.Laser,[C,v.LaserBlueprint]],[c.Railgun,[C,v.RailgunBlueprint]],[c.Tesla,[C,v.TeslaBlueprint]],[c.None,[C,v.None]]]);class xa extends z{constructor(t,e){const s=t.getPlaceable().entityType;if(!Sn.has(s))throw new Error(`Missing blueprint sprite for ${s}`);const[i,r]=Sn.get(s);super(e.assets[i].textures[r]),this.data=t,s===c.None&&this.scale.set(t.getScale()),this.alpha=.7,this.position.set(this.data.entity.getX()*m,this.data.entity.getY()*m)}sync(){}}a(xa,"layer",Ae);const En=20;class jc extends z{constructor(){super(...arguments);a(this,"speed",0);a(this,"lifetime",0);a(this,"direction",0)}}class Aa extends as{constructor(t,e){super(En,{position:!0,scale:!0,rotation:!0,alpha:!0}),this.data=t;for(let s=0;s<En;s++){const i=new jc(e.assets[C].textures[v.Fire]);i.anchor.set(.5),i.scale.set(1+Math.random()*.3),i.speed=(4+Math.random()*2)*.0017,i.alpha=.8,i.lifetime=Math.floor(Math.random()*25),i.x=this.data.sourceX*m,i.y=this.data.sourceY*m,i.direction=(this.data.entity.getRotation()+20-Math.random()*40)*Math.PI/180,this.addChild(i)}}sync(t){this.children.forEach(e=>{e.x+=Math.sin(e.direction)*e.speed*t*m,e.y+=Math.cos(e.direction)*e.speed*t*m,e.lifetime+=1,e.lifetime>25&&(this.data.renderData.update?(e.lifetime=0,e.x=this.data.sourceX*m,e.y=this.data.sourceY*m,e.direction=(this.data.entity.getRotation()+20-Math.random()*40)*Math.PI/180,e.alpha=.8):(e.lifetime=Math.floor(Math.random()*25),e.alpha=0))}),this.data.renderData.update=!1}}a(Aa,"layer",ae);const Kc="explosion",qc=.2;class Nt extends Ht{constructor(t,e,s,i=1){super(Object.values(t.assets[Kc].textures)),this.anchor.set(.5),this.animationSpeed=qc,this.loop=!1,this.position.set(e*m,s*m),this.scale.set(i),Dt.addChild(this),this.onComplete=()=>{Dt.removeChild(this)},this.play()}}const Ft=class{constructor(t,e,s){a(this,"ref");a(this,"promise");this.alias=t,this.filter=e;const i=Pt.play(t,{...s,filters:[e],complete:()=>Ft.soundInstanceCountMap.set(t,Ft.soundInstanceCountMap.get(t)-1)});i instanceof Promise?(i.then(r=>this.ref=r),this.promise=i):this.ref=i}static rateLimitSound(t){const e=this.soundInstanceCountMap.get(t)||0,s=this.soundPlaytimeMap.get(t)||0;if(e>this.MAX_INSTANCES)return!0;const i=performance.now();return s+this.MIN_INTERVAL>i?!0:(this.soundInstanceCountMap.set(t,e+1),this.soundPlaytimeMap.set(t,i),!1)}static getSoundOptions(t){const{x:e,y:s,width:i,height:r,scale:o}=ot.Instance.getViewport(),h=(t.getX()*m-e)/(i/2),l=(t.getY()*m-s)/(r/2),p=1/(1+(Math.max(0,Math.abs(h)-1)+Math.max(0,Math.abs(l)-1))*3),g=Math.min(o,vi)/vi*p,d=Math.min(1,Math.max(0,Math.abs(h)-.5))*Math.sign(h);return{volume:g,pan:d}}static fromEntity(t,e,s){const{volume:i,pan:r}=Ft.getSoundOptions(t);if(!(i<.25)&&!this.rateLimitSound(e))return new Ft(e,new er(r),{...s,volume:i})}destroy(){var t;this.ref?(t=this.ref)==null||t.destroy():this.promise.then(e=>e.destroy()),Ft.soundInstanceCountMap.set(this.alias,Ft.soundInstanceCountMap.get(this.alias)-1)}update(t){if(this.ref){const{volume:e,pan:s}=Ft.getSoundOptions(t);this.ref.volume=e,this.filter.pan=s}}fade(t,e=500){return this.ref?(this.ref.volume-=t/e*.8,this.ref.volume<.2?(this.destroy(),!0):!1):!1}};let G=Ft;a(G,"soundInstanceCountMap",new Map),a(G,"soundPlaytimeMap",new Map),a(G,"MAX_INSTANCES",3),a(G,"MIN_INTERVAL",100);var N=(n=>(n.Notification="notificationSnd",n.Shot="shotSnd",n.Laser="laserSnd",n.Flamethrower="flamethrowerSnd",n.Mortar="mortarSnd",n.Railgun="railgunSnd",n.Explosion="explosionSnd",n.Firework="fireworkSnd",n.Place="placeSnd",n.Destroy="destroySnd",n.Hit="hitSnd",n.Sonar="sonarSnd",n.Thunder="thunderSnd",n.Bush="bushSnd",n.Tank="tankSnd",n.Drill="drillSnd",n.Lock="lockSnd",n))(N||{});const Qc={notificationSnd:"/open-td/sounds/notification.mp3",shotSnd:"/open-td/sounds/shot.wav",laserSnd:"/open-td/sounds/laser.mp3",flamethrowerSnd:"/open-td/sounds/flamethrower.wav",mortarSnd:"/open-td/sounds/mortar.wav",railgunSnd:"/open-td/sounds/railgun.mp3",explosionSnd:"/open-td/sounds/explosion.wav",fireworkSnd:"/open-td/sounds/firework.wav",placeSnd:"/open-td/sounds/place.wav",destroySnd:"/open-td/sounds/destroy.wav",hitSnd:"/open-td/sounds/hit.wav",sonarSnd:"/open-td/sounds/sonar.wav",thunderSnd:"/open-td/sounds/thunder.wav",bushSnd:"/open-td/sounds/bush.mp3",tankSnd:"/open-td/sounds/tank.wav",drillSnd:"/open-td/sounds/drill.wav",lockSnd:"/open-td/sounds/lock.mp3"},yt=(n,t)=>{Pt.volume(n,t)},Zc=()=>{yt("shotSnd",.7),yt("laserSnd",.5),yt("flamethrowerSnd",.1),yt("mortarSnd",.7),yt("railgunSnd",.7),yt("placeSnd",.7),yt("destroySnd",.7),yt("sonarSnd",.7),yt("thunderSnd",.7),yt("tankSnd",.4),yt("lockSnd",1)},Jc=(n,t,e)=>A.Instance.addEventListener(n,()=>Pt.play(t,e));var Gt=(n=>(n[n.small=8]="small",n[n.medium=16]="medium",n[n.large=32]="large",n))(Gt||{});const re=n=>{const t=new rs;return t.fill.color=0,t.fill.alpha=.4,t.fill.visible=!0,t.drawCircle(0,0,n),ds.addChild(t),t},oe=n=>{ds.removeChild(n)},th=.2,eh=1/4,sh=1/8,ih=.0015,Vi=class extends Ht{constructor(e,s){super(Object.values(s.assets[Vi.atlas].textures));a(this,"shadow");a(this,"flames",[]);a(this,"oldOffset",0);this.data=e,this.container=s,this.anchor.set(.5),this.animationSpeed=th,this.shadow=re(Gt.small),this.play(),this.on("removed",()=>{oe(this.shadow),e.AI.hp<=0&&new Nt(s,e.entity.getX()+.5,e.entity.getY()+.5)})}sync(){const e=ih*(1+this.data.entity.getId()%13/13),s=.5+Math.sin((ot.Instance.getTime()+this.data.entity.getId())*e)/4-sh,i=.5+Math.cos((ot.Instance.getTime()+this.data.entity.getId())*e)/2-eh;if(this.position.set((this.data.entity.getX()+s)*m,(this.data.entity.getY()+i)*m),this.shadow.position.set((this.data.entity.getX()+.5)*m,(this.data.entity.getY()+.5)*m),this.angle=this.data.entity.getRotation(),this.data.AI.isBusy()){const o=this.angle;this.angle+=Math.sin(ot.Instance.getTime()%Z/Z*5)*20,Math.sign(this.angle)!==Math.sign(o)&&G.fromEntity(this.data.entity,N.Hit)}if(this.angle=this.data.entity.getRotation(),this.data.AI.isAttacking()){const o=Math.sin(ot.Instance.getTime()%Z/Z*5)*20;this.angle+=o,Math.sign(o)===1&&Math.sign(this.oldOffset)===-1&&G.fromEntity(this.data.entity,N.Hit),this.oldOffset=o}else this.oldOffset=0;const r=m/2;if(this.flames.forEach(o=>{o.angle=-this.data.entity.getRotation(),o.position.set(Math.random()*r-r/2,Math.random()*r-r/2)}),this.data.getStatus()===T.OnFire&&!this.flames.length){this.tint=14833698;for(let o=0;o<2;o++){const h=new z(this.container.assets[C].textures[v.Fire]);h.alpha=.8,h.anchor.set(.5),h.position.set(Math.random()*r-r/2,Math.random()*r-r/2),this.addChild(h),this.flames.push(h)}}else this.data.getStatus()!==T.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[])}};let Ne=Vi;a(Ne,"layer",Dt),a(Ne,"atlas","flier");const ni=16;class ka extends bi{constructor(e,s){super(s.assets[C].textures[v.Laser],ni,ni);a(this,"tileOffset",0);this.data=e,this.pivot={x:ni/2,y:0}}sync(){this.tilePosition.y=this.tileOffset,this.tileOffset+=.5;const e=this.data.entity.getX(),s=this.data.entity.getY(),i=Math.sqrt((e-this.data.targetX)**2+(s-this.data.targetY)**2);this.height=i*m,this.alpha=Math.min(1,1-this.data.time/Rs+.1),this.position.set(this.data.entity.getX()*m,this.data.entity.getY()*m),this.angle=this.data.entity.getRotation()-90}}a(ka,"layer",ae);const ai=16;class Pa extends bi{constructor(t,e){super(e.assets[C].textures[v.Rail],ai,ai),this.data=t,this.pivot={x:ai/2,y:0}}sync(){const t=this.data.entity.getX(),e=this.data.entity.getY(),s=Math.sqrt((t-this.data.targetX)**2+(e-this.data.targetY)**2);this.height=s*m,this.alpha=Math.min(1,1-this.data.time/Di+.1),this.position.set(this.data.entity.getX()*m,this.data.entity.getY()*m),this.angle=this.data.entity.getRotation()-90}}a(Pa,"layer",ae);const nh=.1,In=1/4,ji=class extends Ht{constructor(e,s){super(Object.values(s.assets[ji.atlas].textures));a(this,"shadow");a(this,"flames",[]);a(this,"oldOffset",0);this.data=e,this.container=s,this.anchor.set(.5),this.animationSpeed=nh,this.shadow=re(Gt.medium),this.on("removed",()=>{oe(this.shadow),e.AI.hp<=0&&new Nt(s,e.entity.getX()+.5,e.entity.getY()+.5)}),this.play()}sync(){const e=.5+this.data.entity.getId()%13/26-In,s=.5+(this.data.entity.getId()+5)%17/34-In;if(this.position.set((this.data.entity.getX()+e)*m,(this.data.entity.getY()+s)*m),this.shadow.position.copyFrom(this.position),this.angle=this.data.entity.getRotation(),this.data.AI.isAttacking()){const r=Math.sin(ot.Instance.getTime()%Z/Z*5)*20;this.angle+=r,Math.sign(r)===1&&Math.sign(this.oldOffset)===-1&&G.fromEntity(this.data.entity,N.Hit),this.oldOffset=r}this.data.AI.isBusy()===this.playing&&(this.playing?this.stop():(this.play(),this.oldOffset=0));const i=m/2;if(this.flames.forEach(r=>{r.angle=-this.data.entity.getRotation(),r.position.set(Math.random()*i-i/2,Math.random()*i-i/2)}),this.data.getStatus()===T.OnFire&&!this.flames.length){this.tint=14833698;for(let r=0;r<2;r++){const o=new z(this.container.assets[C].textures[v.Fire]);o.alpha=.8,o.anchor.set(.5),o.position.set(Math.random()*i-i/2,Math.random()*i-i/2),this.addChild(o),this.flames.push(o)}}else this.data.getStatus()!==T.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[])}};let Ue=ji;a(Ue,"layer",Lt),a(Ue,"atlas","regular");const ah=.1,bn=1/4,Ki=class extends Ht{constructor(e,s){super(Object.values(s.assets[Ki.atlas].textures));a(this,"shadow");a(this,"flames",[]);a(this,"oldOffset",0);this.data=e,this.container=s,this.anchor.set(.5),this.animationSpeed=ah,this.shadow=re(Gt.medium),this.on("removed",()=>{oe(this.shadow),e.AI.hp<=0&&new Nt(s,e.entity.getX()+.5,e.entity.getY()+.5)}),this.play()}sync(){const e=.5+this.data.entity.getId()%13/26-bn,s=.5+(this.data.entity.getId()+5)%17/34-bn;if(this.position.set((this.data.entity.getX()+e)*m,(this.data.entity.getY()+s)*m),this.shadow.position.copyFrom(this.position),this.angle=this.data.entity.getRotation(),this.data.AI.isAttacking()){const r=Math.sin(ot.Instance.getTime()%Z/Z*5)*20;this.angle+=r,Math.sign(r)===1&&Math.sign(this.oldOffset)===-1&&G.fromEntity(this.data.entity,N.Hit),this.oldOffset=r}this.data.AI.isBusy()===this.playing&&(this.playing?this.stop():(this.play(),this.oldOffset=0));const i=m/2;if(this.flames.forEach(r=>{r.angle=-this.data.entity.getRotation(),r.position.set(Math.random()*i-i/2,Math.random()*i-i/2)}),this.data.getStatus()===T.OnFire&&!this.flames.length){this.tint=14833698;for(let r=0;r<2;r++){const o=new z(this.container.assets[C].textures[v.Fire]);o.alpha=.8,o.anchor.set(.5),o.position.set(Math.random()*i-i/2,Math.random()*i-i/2),this.addChild(o),this.flames.push(o)}}else this.data.getStatus()!==T.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[])}};let ze=Ki;a(ze,"layer",Lt),a(ze,"atlas","runner");const rh=v.Bullet,oh=new Map([[c.Bullet,v.Bullet],[c.Flame,v.Fire],[c.Rocket,v.Rocket],[c.Shockwave,v.Shockwave]]);class Os extends z{constructor(t,e){super(e.assets[C].textures[oh.get(t.getType())??rh]),this.data=t,this.pivot={x:8,y:8}}sync(){this.position.set(this.data.entity.getX()*m,this.data.entity.getY()*m),this.angle=this.data.entity.getRotation()}}a(Os,"layer",ae);const ch=.1,Mn=1/4,qi=class extends Ht{constructor(e,s){super(Object.values(s.assets[qi.atlas].textures));a(this,"shadow");a(this,"flames",[]);a(this,"oldOffset",0);this.data=e,this.container=s,this.anchor.set(.5),this.animationSpeed=ch,this.shadow=re(Gt.medium),this.on("removed",()=>{oe(this.shadow),e.AI.hp<=0&&new Nt(s,e.entity.getX()+.5,e.entity.getY()+.5)}),this.play()}sync(){const e=.5+this.data.entity.getId()%13/26-Mn,s=.5+(this.data.entity.getId()+5)%17/34-Mn;if(this.position.set((this.data.entity.getX()+e)*m,(this.data.entity.getY()+s)*m),this.shadow.position.copyFrom(this.position),this.angle=this.data.entity.getRotation(),this.data.AI.isAttacking()){const r=Math.sin(ot.Instance.getTime()%Z/Z*5)*20;this.angle+=r,Math.sign(r)===1&&Math.sign(this.oldOffset)===-1&&G.fromEntity(this.data.entity,N.Hit),this.oldOffset=r}this.data.AI.isBusy()===this.playing&&(this.playing?this.stop():(this.play(),this.oldOffset=0));const i=m/2;if(this.flames.forEach(r=>{r.angle=-this.data.entity.getRotation(),r.position.set(Math.random()*i-i/2,Math.random()*i-i/2)}),this.data.getStatus()===T.OnFire&&!this.flames.length){this.tint=14833698;for(let r=0;r<2;r++){const o=new z(this.container.assets[C].textures[v.Fire]);o.alpha=.8,o.anchor.set(.5),o.position.set(Math.random()*i-i/2,Math.random()*i-i/2),this.addChild(o),this.flames.push(o)}}else this.data.getStatus()!==T.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[])}};let We=qi;a(We,"layer",Lt),a(We,"atlas","tank");const hh=new Map([[c.Tower,"turret"],[c.Flamethrower,"flamethrower"],[c.Laser,"laser"],[c.Mortar,"mortar"],[c.Railgun,"railgun"],[c.Tesla,"tesla"]]),Tn=new Map([[c.Tower,N.Shot],[c.Flamethrower,N.Flamethrower],[c.Laser,N.Laser],[c.Mortar,N.Mortar],[c.Railgun,N.Railgun],[c.Tesla,N.Thunder]]),lh=new Set([c.Flamethrower,c.Laser]),uh=.1,dh=.6,xn=(n,t)=>n?t?v.FrameSpeedDamage:v.FrameSpeed:t?v.FrameDamage:v.Frame;class Kt extends z{constructor(e,s){super(s.assets[C].textures[xn(e.isSpeedBoosted(),e.isDamageBoosted())]);a(this,"turret");a(this,"sound");this.data=e,this.container=s;const[i,r]=pt(e);this.position.set(i*m,r*m),this.pivot={x:m,y:m},this.createTurret(),this.on("removed",()=>{e.renderData.destroyed&&(ot.Instance.shake(),new Nt(s,...pt(e),2)),Dt.removeChild(this.turret),this.sound&&this.sound.destroy()})}createTurret(){const e=hh.get(this.data.getType());this.turret=new Ht(Object.values(this.container.assets[e].textures)),this.turret.position.set(this.x,this.y),this.turret.pivot={x:m,y:m},this.turret.animationSpeed=uh,this.turret.loop=!1,this.turret.onComplete=()=>{this.turret.gotoAndStop(0)},Dt.addChild(this.turret)}sync(e,s){s&&(this.texture=this.container.assets[C].textures[xn(this.data.isSpeedBoosted(),this.data.isDamageBoosted())]),this.turret.angle=_o(this.turret.angle,this.data.entity.getRotation(),dh*e),this.data.renderData.fired?(this.data.renderData.fired=!1,this.turret.play(),lh.has(this.data.getType())?this.sound?this.sound.update(this.data.entity):this.sound=G.fromEntity(this.data.entity,Tn.get(this.data.getType()),{loop:!0}):G.fromEntity(this.data.entity,Tn.get(this.data.getType()))):this.sound&&this.sound.fade(e)&&(this.sound=void 0)}}a(Kt,"layer",Lt);class Ca extends Os{constructor(e,s){super(e,s);a(this,"shadow");this.data=e,this.shadow=re(Gt.small),this.on("removed",()=>{oe(this.shadow),new Nt(s,e.entity.getX(),e.entity.getY(),2),G.fromEntity(e.entity,N.Explosion)})}sync(){super.sync(),this.shadow.position.set(this.data.entity.getX()*m,this.data.straightY*m);const e=1-Math.abs(this.data.getPercentage()-.5)*.8;this.shadow.scale.set(e)}}a(Ca,"layer",Dt);const An=75,kn=1e3;class gh extends z{constructor(){super(...arguments);a(this,"speed",Math.random()*.002)}}var ci;let ph=(ci=class extends Tt{constructor(e,s){super();a(this,"container");a(this,"sprite");a(this,"time",0);if(this.data=e,this.sprite=new z(s.assets[C].textures[v.Coin]),this.sprite.anchor.set(.5),e.amount>1){const i=new z(s.assets[C].textures[v.Coin]);i.anchor.set(.25),this.sprite.addChild(i)}this.container=new as(An,{alpha:!0});for(let i=0;i<An;i++){const r=new gh(s.assets[C].textures[v.SporeParticle]),o=i%25/25*Math.PI*2,h=Math.floor(i/25)*.75+.25;r.anchor.set(.5),r.alpha=.9,r.x=(this.data.sourceX+Math.sin(o)*h)*m,r.y=(this.data.sourceY+Math.cos(o)*h)*m,this.container.addChild(r)}this.addChild(this.sprite,this.container),G.fromEntity(this.data.entity,N.Firework)}sync(e){this.sprite.position.set(this.data.entity.getX()*m,this.data.entity.getY()*m),this.sprite.angle=this.data.entity.getRotation(),this.container.children.forEach((s,i)=>{const r=i%25/25*Math.PI*2;s.x+=Math.sin(r)*s.speed*e*m,s.y+=Math.cos(r)*s.speed*e*m,s.alpha=.9-this.time/kn*.8}),this.time+=e,this.time>kn&&this.removeChild(this.container)}},a(ci,"layer",zt),ci);const Pn=32,fh=96;class _a extends Tt{constructor(e,s){super();a(this,"sprites",[]);this.data=e;let i=e.entity.getX(),r=e.entity.getY();for(let o of this.data.getChain()){const h=o.entity.getX()+.5,l=o.entity.getY()+.5,p=new bi(s.assets[C].textures[v.Lightning],Pn,fh);p.pivot={x:Pn/2,y:0};const g=Math.sqrt((i-h)**2+(r-l)**2);p.height=g*m,p.position.set(i*m,r*m),p.rotation=Math.atan2(r-l,i-h)+Math.PI/2,i=h,r=l,this.addChild(p),this.sprites.push(p)}}sync(){this.alpha=Math.min(1,1-this.data.time/fi+.1),this.sprites.forEach(e=>e.tilePosition.y=Math.floor(this.data.time/fi*5)*32)}}a(_a,"layer",ae);const wt=class extends z{constructor(e,s){super();a(this,"_x");a(this,"_y");a(this,"entityScale");a(this,"prefix");this.container=s,this._x=e.entity.getAlignedX(),this._y=e.entity.getAlignedY(),this.entityScale=$t(e),this.prefix=wt.entityMap.get(e.getType()),this.position.set(this._x*m-wt.padding*this.entityScale,this._y*m-wt.padding*this.entityScale)}sync(e,s){s&&this.updateTexture()}updateTexture(){const e=u.Instance.getSurface(),s=new Array(8);for(let i=0;i<8;i+=2){const r=e.getTile(this._x+wt.neighbors[i][0]*this.entityScale,this._y+wt.neighbors[i][1]*this.entityScale);s[i]=r&&wt.types.has(r.getType())&&$t(r.getStaticEntity().getAgent())===this.entityScale?"1":"0"}for(let i=1;i<8;i+=2){if(s[(i+1)%8]==="1"||s[(i+7)%8]==="1"){s[i]="0";continue}const r=e.getTile(this._x+wt.neighbors[i][0]*this.entityScale,this._y+wt.neighbors[i][1]*this.entityScale);s[i]=r&&wt.types.has(r.getType())&&$t(r.getStaticEntity().getAgent())===this.entityScale?"1":"0"}this.texture=this.container.assets[C].textures[this.prefix+s.join("")]}};let Ct=wt;a(Ct,"layer",Qs),a(Ct,"entityMap",new Map([[c.Wall,"wall-"],[c.Fence,"fence-"],[c.ElectricFence,"fence-"]])),a(Ct,"neighbors",[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]]),a(Ct,"padding",4),a(Ct,"types",new Set([f.Fence,f.Wall,f.ElectricFence]));const Zt=class extends z{constructor(e,s,i){super(e);a(this,"direction");a(this,"velocity",0);a(this,"bounceForce",10);a(this,"time",0);a(this,"tick",e=>{if(this.time+=e,this.time>Zt.lifetime){Dt.removeChild(this),en.shared.remove(this.tick);return}this.time>Zt.fadeTime&&(this.alpha=1-(this.time-Zt.fadeTime)/Zt.fadeTime),this.bounceForce>2&&(this.velocity+=this.direction,this.rotation+=this.velocity,(this.rotation>Math.PI/2||this.rotation<-Math.PI/2)&&(this.velocity=-this.direction*this.bounceForce,this.bounceForce/=2))});this.anchor.set(.5,1),this.position.set((s+.5)*m,(i+1)*m),this.direction=Math.sign(Math.random()-.5)/80,this.velocity=0,en.shared.add(this.tick,void 0,sr.LOW),Dt.addChild(this)}};let He=Zt;a(He,"lifetime",40),a(He,"fadeTime",Zt.lifetime*.8);const Us=class extends z{constructor(t,e){super(e.assets[C].textures[Us.entityMap.get(t.getType())[t.renderData.subType||0]]),this.position.set(t.entity.getX()*m,(t.entity.getY()+Us.verticalOffset)*m),this.on("removed",()=>{t.renderData.chopped&&(t.getType()===c.Tree||t.getType()===c.Pine)&&(G.fromEntity(t.entity,N.Bush),new He(this.texture,t.entity.getX(),t.entity.getY()))})}sync(){}};let bt=Us;a(bt,"layer",Ae),a(bt,"entityMap",new Map([[c.Tree,[v.Tree,v.Pine,v.Cactus]],[c.Pine,[v.Tree,v.Pine,v.Cactus]],[c.Cactus,[v.Tree,v.Pine,v.Cactus]],[c.Stump,[v.Stump]],[c.Rock,[v.Rock,v.RockAlt]],[c.Rock2,[v.Rock,v.RockAlt]],[c.Rock3,[v.Rock,v.RockAlt]]])),a(bt,"verticalOffset",-.5);var te;let mh=(te=class extends z{constructor(t,e){super(e.assets[C].textures[v.Stump]),this.position.set(t.entity.getX()*m,(t.entity.getY()+te.verticalOffset)*m)}sync(){}},a(te,"layer",Qs),a(te,"verticalOffset",-.5),te);const ss=class extends z{constructor(e,s){super();a(this,"_x");a(this,"_y");this.container=s,this._x=e.entity.getAlignedX(),this._y=e.entity.getAlignedY();const i=ss.entityToAtlasMap.get(e.getType());if(i){const r=new z(this.container.assets[C].textures[i]);r.anchor.set(.5),r.position.set(m,m),this.addChild(r)}this.position.set(this._x*m,this._y*m),this.updateTexture()}sync(e,s){s&&this.updateTexture()}updateTexture(){const e=u.Instance.getSurface();let s="base-";for(let i=0;i<4;i++){const r=e.getTile(this._x+ss.neighbors[i][0],this._y+ss.neighbors[i][1]);s+=r!=null&&r.hasStaticEntity()&&hs.has(r.getStaticEntity().getAgent().getType())?"0":"1"}this.texture=this.container.assets[C].textures[s]}};let de=ss;a(de,"layer",Lt),a(de,"neighbors",[[0,-2],[2,0],[0,2],[-2,0]]),a(de,"entityToAtlasMap",new Map([[c.Base,v.Base],[c.Armory,v.Barracks],[c.Barracks,v.Barracks],[c.PowerPlant,v.PowerPlant],[c.Radar,v.Radar],[c.Market,v.Market]]));const yh=.075,Cn=1/4,Qi=class extends Ht{constructor(e,s){super(Object.values(s.assets[Qi.atlas].textures));a(this,"shadow");a(this,"flames",[]);a(this,"oldOffset",0);this.data=e,this.container=s,this.anchor.set(.5),this.animationSpeed=yh,this.shadow=re(Gt.large),this.scale.set(2),this.on("removed",()=>{oe(this.shadow),e.AI.hp<=0&&new Nt(s,e.entity.getX()+1,e.entity.getY()+1,2)}),this.play()}sync(){const e=1+this.data.entity.getId()%13/26-Cn,s=1+(this.data.entity.getId()+5)%17/34-Cn;if(this.position.set((this.data.entity.getX()+e)*m,(this.data.entity.getY()+s)*m),this.shadow.position.copyFrom(this.position),this.angle=this.data.entity.getRotation(),this.data.AI.isAttacking()){const r=Math.sin(ot.Instance.getTime()%Z/Z*5)*20;this.angle+=r,Math.sign(r)===1&&Math.sign(this.oldOffset)===-1&&G.fromEntity(this.data.entity,N.Hit),this.oldOffset=r}this.data.AI.isBusy()===this.playing&&(this.playing?this.stop():(this.play(),this.oldOffset=0));const i=m/2;if(this.flames.forEach(r=>{r.angle=-this.data.entity.getRotation(),r.position.set(Math.random()*i-i/2,Math.random()*i-i/2)}),this.data.getStatus()===T.OnFire&&!this.flames.length){this.tint=14833698;for(let r=0;r<2;r++){const o=new z(this.container.assets[C].textures[v.Fire]);o.alpha=.8,o.anchor.set(.5),o.position.set(Math.random()*i-i/2,Math.random()*i-i/2),this.addChild(o),this.flames.push(o)}}else this.data.getStatus()!==T.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[])}};let Ge=Qi;a(Ge,"layer",Lt),a(Ge,"atlas","runner");class wh extends rs{constructor(t){super(),this.enemy=t,this.fill.alpha=.6,this.fill.visible=!0,zt.addChild(this)}update(t,e){const s=this.enemy.getScale();this.fill.color=0,this.drawRect(0,0,32*s,6*s),this.fill.color=16711680,this.drawRect(1,1,(32*s-2)*this.enemy.AI.getHpPercent(),6*s-2),this.position.set(t-16*s,e-16*s)}remove(){zt.removeChild(this)}}const vh=.075,_n=1/4,Zi=class extends Ht{constructor(e,s){super(Object.values(s.assets[Zi.atlas].textures));a(this,"shadow");a(this,"flames",[]);a(this,"sound");a(this,"wasAttacking",!1);a(this,"healthBar");this.data=e,this.container=s,this.anchor.set(.5),this.animationSpeed=vh,this.shadow=re(Gt.large),this.scale.set(2),this.sound=G.fromEntity(this.data.entity,N.Tank,{loop:!0}),this.on("removed",()=>{var i,r;(i=this.sound)==null||i.destroy(),oe(this.shadow),(r=this.healthBar)==null||r.remove(),e.AI.hp<=0&&new Nt(s,e.entity.getX()+1,e.entity.getY()+1,2)}),this.play()}sync(){var o;this.sound&&this.sound.update(this.data.entity),this.data.AI.isAttacking()&&!this.wasAttacking&&((o=this.sound)==null||o.destroy(),G.fromEntity(this.data.entity,N.Drill)),!this.data.AI.isAttacking()&&this.wasAttacking&&!u.Instance.getIsBaseDestroyed()&&(this.sound=G.fromEntity(this.data.entity,N.Tank,{loop:!0})),this.wasAttacking=this.data.AI.isAttacking();const e=this.data.AI.isAttacking()?Math.sin(ot.Instance.getTime()%200/200*5)*.05:0,s=1+this.data.entity.getId()%13/26-_n+Math.cos(this.rotation+Math.PI/2)*e,i=1+(this.data.entity.getId()+5)%17/34-_n+Math.sin(this.rotation+Math.PI/2)*e;this.position.set((this.data.entity.getX()+s)*m,(this.data.entity.getY()+i)*m),this.shadow.position.copyFrom(this.position),this.angle=this.data.entity.getRotation();const r=m/2;if(this.flames.forEach(h=>{h.angle=-this.data.entity.getRotation(),h.position.set(Math.random()*r-r/2,Math.random()*r-r/2)}),this.data.getStatus()===T.OnFire&&!this.flames.length){this.tint=14833698;for(let h=0;h<2;h++){const l=new z(this.container.assets[C].textures[v.Fire]);l.alpha=.8,l.anchor.set(.5),l.position.set(Math.random()*r-r/2,Math.random()*r-r/2),this.addChild(l),this.flames.push(l)}}else this.data.getStatus()!==T.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[]);this.data.AI.getHpPercent()<1&&(this.healthBar||(this.healthBar=new wh(this.data)),this.healthBar.update(this.position.x,this.position.y))}};let Ve=Zi;a(Ve,"layer",Lt),a(Ve,"atlas","bore");const Sh={runner:"/open-td/animations/runner.json",regular:"/open-td/animations/regular.json",flier:"/open-td/animations/flier.json",tank:"/open-td/animations/tank.json",turret:"/open-td/animations/turret.json",flamethrower:"/open-td/animations/flamethrower.json",laser:"/open-td/animations/laser.json",mortar:"/open-td/animations/mortar.json",railgun:"/open-td/animations/railgun.json",explosion:"/open-td/animations/explosion.json",tesla:"/open-td/animations/tesla.json",bore:"/open-td/animations/bore.json"},Eh={[c.Runner]:ze,[c.Slime]:Ue,[c.Flier]:Ne,[c.Tank]:We,[c.Behemoth]:Ge,[c.Bore]:Ve,[c.Tower]:Kt,[c.Flamethrower]:Kt,[c.Laser]:Kt,[c.Mortar]:Kt,[c.Railgun]:Kt,[c.Bullet]:Os,[c.Flame]:Aa,[c.Rocket]:Ca,[c.Shockwave]:Os,[c.LaserBeam]:ka,[c.Rail]:Pa,[c.Fence]:Ct,[c.Wall]:Ct,[c.ElectricFence]:Ct,[c.Blueprint]:xa,[c.WavePoint]:ph,[c.Spark]:_a,[c.Tesla]:Kt,[c.Tree]:bt,[c.Pine]:bt,[c.Cactus]:bt,[c.Stump]:mh,[c.Rock]:bt,[c.Rock2]:bt,[c.Rock3]:bt,[c.Freezer]:null,...[...hs].reduce((n,t)=>({...n,[t]:de}),{})};class Ih extends z{constructor(t,e,s){super(s),this.offset=t,this.path=e;const{x:i,y:r}=this.path.getCoordinates(this.offset%this.path.getLength());this.position.set(i*m,r*m)}move(t){this.offset+=t/100/this.path.getScale();const{x:e,y:s}=this.path.getCoordinates(this.offset%this.path.getLength());this.position.set(e*m,s*m)}}class bh extends z{constructor(){super(...arguments);a(this,"originalAlpha",1)}}class Mh{constructor(t,e){a(this,"coverageContainer");a(this,"pathContainer");a(this,"towers",new Map);a(this,"hoveredTile");a(this,"visible",!1);this.container=t,this.surface=e,this.coverageContainer=new as(void 0,{uvs:!0,alpha:!0},void 0,!0),ds.addChild(this.coverageContainer),this.pathContainer=new as(void 0,{position:!0},void 0,!0),zt.addChild(this.pathContainer)}show(){this.visible=!0,this.render()}hide(){this.visible=!1,this.coverageContainer.removeChildren(),this.pathContainer.removeChildren()}render(){this.visible&&(this.renderCoverage(),u.Instance.getDifficulty()===$.Easy&&!u.Instance.getIsStarted()&&this.renderPaths())}renderCoverage(){this.coverageContainer.removeChildren(),this.towers.clear(),this.hoveredTile=void 0;const t=this.surface.getHeight();for(let e=0;e<t;e++)this.surface.getRow(e).forEach(s=>{const i=s.getTowers();if(i.length===0||!s.isDiscovered())return;const r=new bh(this.container.assets[C].textures[v.Coverage]);r.originalAlpha=Math.min(.15+.1*i.length,.55),r.alpha=r.originalAlpha,r.position.set(s.getX()*m,s.getY()*m),this.coverageContainer.addChild(r),i.forEach(o=>{const h=this.towers.get(o.getTile().getHash())||[];h.push(r),this.towers.set(o.getTile().getHash(),h)})})}async renderPaths(){this.pathContainer.removeChildren();const t=[];K.Instance.getSpawnGroups().forEach(s=>{t.push(s.getAsyncSpawnPoints())});const e=[];(await Promise.all(t)).forEach(s=>e.push(...s)),e.forEach((s,i)=>{const r=this.slicePath(s),o=Math.max(1,Math.floor(r.getLength()/5));for(let h=0;h<o;h++)this.pathContainer.addChild(new Ih(i*2+h*5,r,this.container.assets[C].textures[v.Entity]))})}slicePath(t){let e,s;for(let i=0;i<t.getLength();i++){const r=t.getTile(i);if(r.isDiscovered()||(e=i+1),r.hasStaticEntity()&&hs.has(r.getStaticEntity().getAgent().getType())){s=i;break}}return t.slice(e,s)}update(t){var r,o;if(!this.visible)return;u.Instance.getIsStarted()?this.pathContainer.removeChildren():this.pathContainer.children.forEach(h=>h.move(t));const[e,s]=Xt.Instance.getMouse(2),i=this.surface.getTile(e,s);i!==this.hoveredTile&&(this.hoveredTile&&((r=this.towers.get(this.hoveredTile.getHash()))==null||r.forEach(h=>{h.texture=this.container.assets[C].textures[v.Coverage],h.alpha=h.originalAlpha})),i&&((o=this.towers.get(i.getHash()))==null||o.forEach(h=>{h.texture=this.container.assets[C].textures[v.ActiveCoverage],h.alpha=.7})),this.hoveredTile=i)}}const Ee=class{constructor(t){a(this,"container");a(this,"alertSymbols",[]);a(this,"time",0);a(this,"permanent",!1);a(this,"removeEndWaveEventListener");this.assetsContainer=t,this.container=new Tt,zt.addChild(this.container),this.removeEndWaveEventListener=A.Instance.addEventListener(E.EndWave,()=>this.reset())}enable(){this.permanent=!0,this.container.alpha=1,this.time=Ee.displayDuration}disable(){this.permanent=!1,this.time=Ee.displayDuration}reset(){this.time=0,this.container.alpha=1}render(t,e){this.alertSymbols=[],this.container.removeChildren();const[s,i]=t,r=Math.PI/128;e.forEach(o=>{const[h,l]=o.getRange(),p=new Tt,g=new rs;g.lineStyle({width:10,color:16711680,cap:ir.ROUND,alpha:.6,alignment:.5}),g.arc(s*m,i*m,10*m,h*Math.PI/180+r,l*Math.PI/180-r);const d=new z(this.assetsContainer.assets[C].textures[v.Alert]);d.anchor.set(.5),d.scale.set(2),this.alertSymbols.push(d);const w=new Tt,S=o.getCenter(),I=S*Math.PI/180;w.position.set((s+Math.cos(I)*9.2)*m,(i+Math.sin(I)*9.2)*m),w.addChild(d),o.getUnits().forEach((M,B)=>{const O=new z(this.assetsContainer.assets[C].textures[Ee.enemySpriteMap.get(M)]),b=S>270||S<90?-1:1,P=b>0?16:-48;O.position.set(P+32*B*b,8),w.addChild(O)}),p.addChild(g,w),this.container.addChild(p)})}update(t,e){this.container.alpha<=0||((e||!this.permanent&&this.time>Ee.displayDuration)&&(this.container.alpha-=t/500),this.alertSymbols.forEach(s=>{s.alpha=Math.abs(Math.cos(this.time/300))}),this.time+=t)}unmount(){this.removeEndWaveEventListener()}};let je=Ee;a(je,"displayDuration",20*1e3),a(je,"enemySpriteMap",new Map([[c.Runner,v.Runner],[c.Slime,v.Regular],[c.Tank,v.Tank],[c.Flier,v.Flier],[c.Behemoth,v.Behemoth],[c.Bore,v.Bore]]));const Th=`varying vec2 vTextureCoord;
uniform sampler2D uSampler;

uniform vec2 thickness;
uniform vec4 outlineColor;
uniform vec4 filterClamp;

const float DOUBLE_PI = 3.14159265358979323846264 * 2.;

void main(void) {
    vec4 ownColor = texture2D(uSampler, vTextureCoord);
    vec4 curColor;
    float maxAlpha = 0.;
    vec2 displaced;
    for (float angle = 0.; angle <= DOUBLE_PI; angle += \${angleStep}) {
        displaced.x = vTextureCoord.x + thickness.x * cos(angle);
        displaced.y = vTextureCoord.y + thickness.y * sin(angle);
        curColor = texture2D(uSampler, clamp(displaced, filterClamp.xy, filterClamp.zw));
        maxAlpha = max(maxAlpha, curColor.a);
    }
    float resultAlpha = maxAlpha * step(ownColor.a, 0.0) > 0. ? 1. : 0.0;

    gl_FragColor = vec4(outlineColor.rgb * resultAlpha, resultAlpha);
}
`,is=class extends nr{constructor(e=1,s=0,i=.1){super(void 0,Th.replace(/\$\{angleStep\}/,is.getAngleStep(i)));a(this,"_thickness",1);this.uniforms.thickness=new Float32Array([0,0]),this.uniforms.outlineColor=new Float32Array([0,0,0,1]),Object.assign(this,{thickness:e,color:s,quality:i})}static getAngleStep(e){if(e===0)return(Math.PI/2).toFixed(7);const s=Math.max(e*is.MAX_SAMPLES,is.MIN_SAMPLES);return(Math.PI*2/s).toFixed(7)}apply(e,s,i,r){this.uniforms.thickness[0]=this._thickness/s._frame.width,this.uniforms.thickness[1]=this._thickness/s._frame.height,e.applyFilter(this,s,i,r)}get color(){return new sn(this.uniforms.outlineColor).toNumber()}set color(e){this.uniforms.outlineColor=new sn(e).toRgbArray()}get thickness(){return this._thickness}set thickness(e){this._thickness=e,this.padding=e}};let we=is;a(we,"MIN_SAMPLES",1),a(we,"MAX_SAMPLES",100);const xh=Intl.NumberFormat(void 0,{maximumFractionDigits:0});class Ah{constructor(){a(this,"container");a(this,"rangeGraphic");a(this,"text");a(this,"containerFilter");a(this,"oldMousePosition","");a(this,"oldMode",Ia.Line);a(this,"oldPlaceable",null);this.rangeGraphic=new rs,this.rangeGraphic.filters=[new we(2,0,0)],this.container=new rs,this.containerFilter=new we(2,0,0),this.container.filters=[this.containerFilter],this.text=new ar("",{fontFamily:"JupiterCrash",fontSize:24,fill:0,align:"left",dropShadow:!0,dropShadowColor:16777215,dropShadowDistance:2}),zt.addChild(this.rangeGraphic,this.container,this.text)}render(){var g;const t=Xt.Instance,e=t.getMouse(),s=t.getMode(),i=t.getPlacable();if(e.join(",")===this.oldMousePosition&&s===this.oldMode&&i===this.oldPlaceable)return;this.oldMousePosition=e.join(","),this.oldMode=s,this.oldPlaceable=i;const r=m*(((g=i==null?void 0:i.entity)==null?void 0:g.scale)||1);this.rangeGraphic.clear(),this.container.clear(),this.container.fill.visible=!0,this.containerFilter.color=i.entityType===c.None?16711680:0;const o=new Set,h=new Set,l=u.Instance.getSurface();let p;if(i!=null&&i.entity&&(p=i.entity.range),t.isMouseDown())t.getSelection().forEach(d=>{this.container.drawRect(d.getX()*m,d.getY()*m,r,r),p&&l.forCircle(d.getX()+1,d.getY()+1,p,w=>h.add(w)),d.hasStaticEntity()&&o.add(d.getStaticEntity().getAgent())});else{const[d,w]=t.getMouse();this.container.drawRect(d*m,w*m,r,r),p&&l.forCircle(d+1,w+1,p,I=>h.add(I));const S=l.getTile(d,w);S&&S.hasStaticEntity()&&o.add(S.getStaticEntity().getAgent())}this.rangeGraphic.clear().beginFill();for(let d of h)this.rangeGraphic.drawRect(d.getX()*m,d.getY()*m,m,m);if(this.rangeGraphic.endFill(),(i==null?void 0:i.entityType)===c.None){const d=[...o].reduce((w,S)=>w+H.Instance.getValue(S),0);d>0?this.text.text=`Sell for 🪙 ${xh.format(d)}`:this.text.text="",this.text.position.set(e[0]*m,e[1]*m-24)}else this.text.text=""}}const kh={[C]:"/open-td/atlas.json",terrain:"/open-td/tiles/terrain.png",mask:"/open-td/tiles/mask.png"};Nn.addBundle("assets",{...Qc,...kh,...Sh});let Ss;const Xi=()=>Ss||(Ss=Nn.loadBundle("assets"),Ss);class Ph{constructor(){a(this,"assets");a(this,"callback");Xi().then(t=>{this.assets=t,this.callback&&this.callback()})}onComplete(t){if(this.assets){t();return}this.callback=t}get loading(){return this.assets===void 0}}const Ch=`precision highp float;

varying vec2 vTextureCoord;

uniform sampler2D world;
uniform vec2 worldSize;

uniform sampler2D atlas;
uniform vec2 atlasSize;

uniform sampler2D mask;
uniform vec2 maskSize;

uniform float tileSize;

uniform float time;
uniform float bridgeId; // Bridges should not get blended
 
void main(void) {
    // Get position in mask texture.
    float maskRepeat = float(worldSize.x) * tileSize;
    float mx = mod(floor(vTextureCoord.x * maskRepeat), maskSize.x);
    float my = mod(floor(vTextureCoord.y * maskRepeat), maskSize.y);

    // Look up the required offset in the mask texture.
    vec4 offset = texture2D(mask, vec2(mx / maskSize.x, my / maskSize.y)) - 0.5;
    float x = vTextureCoord.x *  worldSize.x + offset.r;
    float y = vTextureCoord.y *  worldSize.y + offset.g;
    vec4 source = texture2D(world, vec2(x / worldSize.x, y / worldSize.y));

    // Convert the source an atlasId (can't index using the vec4 using [] so using if checks)
    float atlasId;
    float frame = mod(time + floor(x) + floor(y), 3.0);
    if (frame < 1.0) {
        atlasId = source.r * 255.0;
    } else if (frame < 2.0) {
        atlasId = source.g * 255.0;
    } else {
        atlasId = source.b * 255.0;
    }
    
    // Ensure bridges are not blended.
    float unblentAtlasId = floor(texture2D(world, vTextureCoord).r * 255.0);

    if (unblentAtlasId == bridgeId) {
        atlasId = unblentAtlasId;
    }

    if (atlasId == bridgeId) {
        atlasId = unblentAtlasId;
    }

    // Get number of atlas columns and rows.
    float atlasColumns = atlasSize.x / tileSize;
    float atlasRows = atlasSize.y / tileSize;

    // Get position in atlas texture.
    float dx = mod(atlasId, atlasColumns) / atlasColumns;
    float dy = floor(atlasId / atlasColumns) / atlasRows;

    // This is probably working by accident.
    vec2 size = tileSize / atlasSize;
    gl_FragColor = texture2D(atlas, vec2(dx, dy) + (mod((vTextureCoord * worldSize), 1.0) * size));
}
`,_h=`attribute vec2 aVertexPosition;
attribute vec2 aTextureCoord;

uniform mat3 projectionMatrix;
uniform mat3 translationMatrix;
uniform mat3 uTextureMatrix;

varying vec2 vTextureCoord;

void main(void)
{
    gl_Position = vec4((projectionMatrix * translationMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);

    vTextureCoord = (uTextureMatrix * vec3(aTextureCoord, 1.0)).xy;
}
`;class Bh extends rr{constructor(e){super(li.EMPTY,{program:new or(_h,Ch),uniforms:{tileSize:m,bridgeId:f.Bridge,time:0,worldSize:[e.getWidth(),e.getHeight()],atlasSize:[160,192],maskSize:[192,192]}});a(this,"canvas");a(this,"context");a(this,"imageData");a(this,"getTileTypes",e=>{switch(e.getDiscoveryStatus()){case U.Discovered:return e.getAnimation();case U.Pending:return[dt.Static1,dt.Static2,dt.Static3];default:return[f.Obstructed]}});this.surface=e,this.canvas=new OffscreenCanvas(this.surface.getWidth(),this.surface.getHeight()),this.context=this.canvas.getContext("2d"),this.imageData=this.context.createImageData(this.surface.getWidth(),this.surface.getHeight()),this.uniforms.world=new li(new Mi(this.canvas)),Xi().then(s=>{this.uniforms.atlas=s.terrain.baseTexture,this.uniforms.mask=s.mask.baseTexture})}render(e=!1){this.surface.getTiles().forEach((s,i)=>{let r=e?s.getAnimation():this.getTileTypes(s);this.imageData.data[i*4]=r[0],this.imageData.data[i*4+1]=r[1]||r[0],this.imageData.data[i*4+2]=r[2]||r[0],this.imageData.data[i*4+3]=255}),this.context.putImageData(this.imageData,0,0),this.uniforms.world.update()}setTime(e){this.uniforms.time=e/600}}const Rh=10,Es=12,Bn=25,Dh=300,Lh=500,Oh=.3;let Is=!1;Mi.defaultOptions.scaleMode=cr.NEAREST;const Ji=class{constructor(t){a(this,"messageFn");a(this,"resolveMessageFn");a(this,"removeEventListeners");a(this,"intervalId",-1);a(this,"surface");a(this,"target");a(this,"app");a(this,"viewport");a(this,"vueApp");a(this,"sprites",new Map);a(this,"assets");a(this,"coverageRenderer");a(this,"alertRenderer");a(this,"cursorRenderer");a(this,"worldShader");a(this,"x",0);a(this,"y",0);a(this,"scale",vi);a(this,"width",0);a(this,"height",0);a(this,"time",0);a(this,"nextExplosionTime",0);a(this,"explosions",0);a(this,"lockedTowers",!1);a(this,"showMessage",async(...t)=>{const e=await this.messageFn;return Pt.play(N.Notification),e(...t)});this.controller=t,Ji.instance=this,this.messageFn=new Promise(e=>this.resolveMessageFn=e),this.assets=new Ph,Zc(),window.debug=()=>{Is=!Is,this.surface.forceRerender(),this.renderWorld()}}static get Instance(){return this.instance}mount(t,e){this.surface=t,this.target=e,this.lockedTowers=t.getTowers().size>=q.Instance.getMaxTowers(),this.worldShader=new Bh(t),this.app=new hr({resizeTo:window}),e.appendChild(this.app.view),this.width=this.surface.getWidth()*m,this.height=this.surface.getHeight()*m,this.viewport=new lr({screenWidth:window.innerWidth,screenHeight:window.innerHeight,worldWidth:this.width,worldHeight:this.height,events:this.app.renderer.events}).clamp({direction:"all",underflow:"center"}).drag({wheel:!0,clampWheel:!0,pressDrag:!1}).pinch().addListener("moved",({type:h})=>{h!=="animate"&&(this.x=this.viewport.center.x,this.y=this.viewport.center.y)}),this.app.stage.addChild(this.viewport);const s=new li(new Mi(void 0,{width:1,height:1})),i=new ur(s,2,2);i.width=this.surface.getWidth()*m,i.height=this.surface.getWidth()*m,i.shader=this.worldShader,this.viewport.addChild(i,...wn),this.coverageRenderer=new Mh(this.assets,this.surface),this.alertRenderer=new je(this.assets),this.cursorRenderer=new Ah,this.assets.onComplete(()=>this.renderWorld());const r=e.appendChild(document.createElement("div"));this.vueApp=Ei(Ma,{register:this.resolveMessageFn}),this.vueApp.mount(r);const o=u.Instance.getBase().getTile();this.x=o.getX()*m,this.y=o.getY()*m,this.viewport.animate({time:0,position:{x:this.x,y:this.y}}),this.registerEventHandlers(),this.updateSettings()}updateSettings(){const t=Wt("settings");Pt.volumeAll=((t==null?void 0:t.volume)??100)/100}renderWorld(){const t=Is||u.Instance.getIsBaseDestroyed();this.worldShader.render(t),this.coverageRenderer.render();const e=pt(u.Instance.getBase()),s=K.Instance.getSpawnAlertRanges();this.alertRenderer.render(e,s)}rerender(t){if(this.assets.loading)return;this.time+=t;const e=Is||u.Instance.getIsBaseDestroyed(),s=this.surface.isDirty();s&&this.renderWorld(),this.worldShader.setTime(this.time);const i=s?this.surface.getEntities():this.surface.getTickingEntities(),r=[...this.surface.getDeletedEntities()];let o=!1;for(let h of i){let l=this.sprites.get(h.getId());const p=h.getAgent().isVisible()||e;if(!l){const g=Eh[h.getAgent().getType()];if(g===null||!p)continue;const d=g||Ta;l=new d(h.getAgent(),this.assets),l.zIndex=h.getAlignedY(),d.layer.addChild(l),d.layer===Ae&&(o=!0),this.sprites.set(h.getId(),l)}p?l.sync(t,s):r.push(h)}if(r.forEach(h=>{const l=this.sprites.get(h.getId());l&&(this.sprites.delete(h.getId()),l.constructor.layer.removeChild(l))}),o&&Ae.sortChildren(),this.cursorRenderer.render(),this.coverageRenderer.update(t),this.alertRenderer.update(t,u.Instance.getIsStarted()),this.surface.markPristine(),u.Instance.getIsBaseDestroyed()&&this.time>this.nextExplosionTime&&this.explosions<Oh*u.Instance.getBase().getParts().size){const h=[...u.Instance.getBase().getParts()],l=h[Math.floor(Math.random()*h.length)];this.explosions++,this.nextExplosionTime=this.time+Dh+Lh/h.length,new Nt(this.assets,...pt(l),2),this.shake(),G.fromEntity(l.entity,N.Explosion)}}showCoverage(){this.coverageRenderer.show(),this.alertRenderer.enable()}hideCoverage(){this.coverageRenderer.hide(),this.alertRenderer.disable()}unmount(){this.app&&(this.vueApp.unmount(),this.app.destroy(!0),this.removeEventListeners(),wn.forEach(t=>t.removeChildren()),this.alertRenderer.unmount(),this.messageFn=new Promise(t=>this.resolveMessageFn=t))}getTime(){return this.time}registerEventHandlers(){const t=d=>(d.preventDefault(),!1);this.target.addEventListener("contextmenu",t);const e=d=>{const w=Math.floor((d.data.global.x/this.viewport.scale.x+this.viewport.left)/m),S=Math.floor((d.data.global.y/this.viewport.scale.y+this.viewport.top)/m);this.controller.mouseDown(w,S)};this.viewport.addListener("pointerdown",e);const s=d=>{const w=Math.floor((d.data.global.x/this.viewport.scale.x+this.viewport.left)/m),S=Math.floor((d.data.global.y/this.viewport.scale.y+this.viewport.top)/m);this.controller.mouseMove(w,S)};this.viewport.addListener("pointermove",s);const i=d=>{const w=Math.floor((d.data.global.x/this.viewport.scale.x+this.viewport.left)/m),S=Math.floor((d.data.global.y/this.viewport.scale.y+this.viewport.top)/m);this.controller.mouseUp(w,S,d.pointerType==="touch")};this.viewport.addListener("pointerup",i);const r=d=>{this.controller.keyDown(d.key),d.preventDefault()};window.addEventListener("keydown",r);const o=d=>{this.controller.keyUp(d.key),d.preventDefault()};window.addEventListener("keyup",o);const h=Jc(E.StartWave,N.Sonar),l=A.Instance.addEventListener(E.Buy,()=>{Pt.play(N.Place);const d=this.surface.getTowers().size>=q.Instance.getMaxTowers();d!==this.lockedTowers&&(window.setTimeout(()=>Pt.play(N.Lock),150),this.lockedTowers=d)}),p=A.Instance.addEventListener(E.Sell,()=>{Pt.play(N.Destroy);const d=this.surface.getTowers().size>=q.Instance.getMaxTowers();d!==this.lockedTowers&&(window.setTimeout(()=>Pt.play(N.Lock),150),this.lockedTowers=d)}),g=A.Instance.addEventListener(E.HitBase,()=>{Pt.play(N.Destroy),this.shake()});this.removeEventListeners=()=>{window.removeEventListener("contextmenu",t),this.viewport.removeListener("pointerdown",e),this.viewport.removeListener("pointermove",s),this.viewport.removeListener("pointerup",i),window.removeEventListener("keydown",r),window.removeEventListener("keyup",o),h(),l(),p(),g()}}move({x:t=0,y:e=0,zoom:s}){s&&(s<0?this.scale=Math.max(Hc,this.scale*.9):this.scale=Math.min(Wc,this.scale*1.1));const i=this.viewport.worldScreenWidth/2,r=this.viewport.worldScreenHeight/2;(t>0&&this.x<this.width-i||t<0&&this.x>i)&&(this.x+=t*vn/this.scale),(e>0&&this.y<this.height-r||e<0&&this.y>r)&&(this.y+=e*vn/this.scale),window.clearInterval(this.intervalId),this.viewport.animate({time:200,position:{x:this.x,y:this.y},scale:this.scale})}shake(){window.clearInterval(this.intervalId);let t=Rh;this.intervalId=window.setInterval(()=>{this.viewport.animate({time:Bn,position:{x:this.x+Math.floor(Math.random()*Es/2)-Es,y:this.y+Math.floor(Math.random()*Es/2)-Es}}),t--,t<=0&&(window.clearInterval(this.intervalId),this.intervalId=-1)},Bn)}getViewport(){var t,e;return{x:this.x,y:this.y,width:((t=this.viewport)==null?void 0:t.worldScreenWidth)||0,height:((e=this.viewport)==null?void 0:e.worldScreenHeight)||0,scale:this.scale}}};let As=Ji;a(As,"instance");const ot=As,Fh={True:!0,False:!1},Yh=(n,t,e)=>{var s;return((s=Object.entries(n).find(([i,r])=>t===r))==null?void 0:s[0])||e},Rn=(n,t,e)=>Object.values(n).find(s=>s===t)??e,Xh=(n,t)=>{if(n==="renderer"){const e={emojiRenderer:Yi,pixiRenderer:ot};return t in e?e[t]:e.pixiRenderer}return n==="difficulty"?Rn($,t):n==="showTutorial"?Rn(Fh,t):n==="volume"?wi(t,0,100):n==="simulation"?wi(t,1,3):t},$h=(n,t)=>n==="renderer"?Yh({emojiRenderer:Yi,pixiRenderer:ot},t,"pixiRenderer"):t,Nh={settings:Xh,achievements:Sc,save:Ic},Uh={settings:$h,achievements:Ec,save:bc},Wt=n=>{let t;try{t=localStorage.getItem(n)}catch{return null}if(!t)return null;t.startsWith("{")||(t=window.atob(t));try{return JSON.parse(t,Nh[n])}catch{return null}},gs=(n,t,e=!1)=>{const s=Wt(n)||{},i=JSON.stringify({...s,...t},Uh[n]);try{localStorage.setItem(n,e?window.btoa(i):i)}catch(r){console.warn("Failed to store data",r)}},zh=n=>!!localStorage.getItem(n),Wh=n=>{localStorage.removeItem(n)},Zs=n=>(Pe("data-v-443103e6"),n=n(),Ce(),n),Hh={class:"marketplace"},Gh={class:"inner"},Vh={class:"menu"},jh={class:"group"},Kh={class:"title"},qh={class:"items"},Qh={class:"item-wrapper"},Zh=["onClick"],Jh={class:"emoji"},tl={key:0},el=Zs(()=>y("span",{class:"emoji"},"🪙",-1)),sl={class:"detail"},il={class:"detail-name"},nl={class:"detail-summary"},al=["src"],rl={class:"hints"},ol={key:0},cl=Zs(()=>y("strong",null,"Ranged",-1)),hl={key:1},ll=Zs(()=>y("strong",null,"Powered",-1)),ul={key:2},dl=Zs(()=>y("strong",null,"Base",-1)),gl={class:"detail-description"},pl={class:"wavepoints"},fl=["disabled"],ml=at({__name:"Shop",props:{controller:{},unlocksController:{},eventSystem:{},visible:{type:Boolean}},setup(n){var S;const t=n,e={[c.Barracks]:"barracks.png",[c.Convert]:"convert.png",[c.DamageBeacon]:"damagebeacon.png",[c.Excavator]:"excavator.png",[c.Fence]:"fence.png",[c.Flamethrower]:"flamethrower.png",[c.Laser]:"laser.png",[c.Market]:"market.png",[c.Mortar]:"mortar.png",[c.PowerPlant]:"powerplant.png",[c.Radar]:"radar.png",[c.Railgun]:"railgun.png",[c.EmergencyRecharge]:"recharge.png",[c.EmergencyRepair]:"repair.png",[c.None]:"sell.png",[c.SpeedBeacon]:"speedbeacon.png",[c.Freezer]:"tar.png",[c.Terraform]:"terraform.png",[c.Tesla]:"tesla.png",[c.Tower]:"tower.png",[c.Wall]:"wall.png"},s={[c.Barracks]:"🏛️",[c.Convert]:"♻",[c.DamageBeacon]:"📈",[c.Excavator]:"⛏️",[c.Fence]:"🚧",[c.Flamethrower]:"🗼",[c.Laser]:"🗼",[c.Market]:"🏛️",[c.Mortar]:"🗼",[c.PowerPlant]:"🏛️",[c.Radar]:"🏛️",[c.Railgun]:"🗼",[c.EmergencyRecharge]:"♻",[c.EmergencyRepair]:"♻",[c.None]:"⛏️",[c.SpeedBeacon]:"📈",[c.Freezer]:"📉",[c.Terraform]:"⛏️",[c.Tesla]:"🗼",[c.Tower]:"🗼",[c.Wall]:"🚧"},i=R(t.controller.getPlacable()),r=Yn(),o=R((S=Wt("settings"))==null?void 0:S.showTutorial);let h;ke(()=>{h=t.eventSystem.addEventListener(E.SelectPlaceable,({placeable:I})=>i.value=I)}),Ws(()=>{h&&h()});const l=I=>{if(I===t.controller.getPlacable()){if(t.unlocksController.canUnlock(I)){g();return}if(t.unlocksController.isUnlocked(I)){t.controller.toggleBuildMenu();return}}t.controller.setPlaceable(I)},p=Object.values(Fi),g=()=>{t.unlocksController.unlock(i.value),r.proxy.$forceUpdate()},d=()=>{t.controller.toggleBuildMenu()},w=()=>{o.value=!o.value};return(I,M)=>(x(),_("div",{class:ct({"marketplace-wrapper":!0,"marketplace-wrapper--visible":t.visible})},[y("div",Hh,[y("button",{onClick:d,class:"close-button"},"✖"),y("button",{onClick:w,class:"view-mode-button"},F(o.value?"🍼":"👓"),1),y("div",Gh,[y("div",Vh,[(x(!0),_(At,null,ne(Y(p),B=>(x(),_("div",jh,[y("div",Kh,F(B),1),y("div",qh,[(x(!0),_(At,null,ne(Y(Ea)[B],O=>{var b;return x(),_("div",Qh,[!o.value||t.unlocksController.isUnlocked(O)||t.unlocksController.canUnlock(O)?(x(),_("button",{key:0,class:ct({item:!0,"item--locked":!t.unlocksController.isUnlocked(O),"item--selected":((b=i.value)==null?void 0:b.entityType)===O.entityType}),onClick:()=>l(O)},[y("span",null,[y("span",Jh,F(s[O.entityType]),1),L(" "+F(O.name),1)]),Y(Te)[O.entityType]?(x(),_("span",tl,[L(F(Y(Te)[O.entityType])+" ",1),el])):nt("",!0)],10,Zh)):nt("",!0)])}),256))])]))),256))]),y("div",sl,[y("h2",il,F(i.value.name),1),y("div",nl,[y("img",{src:"portraits/"+e[i.value.entityType]},null,8,al),y("div",rl,[i.value.entity&&i.value.entity.range?(x(),_("span",ol,[L("🎯 "),cl,L(" This building attacks enemies within "+F(i.value.entity.range)+" tiles.",1)])):nt("",!0),Y(mi)[i.value.entityType]?(x(),_("span",hl,[L("⚡ "),ll,L(" This building requires power to function. Be sure to build some power plants first.")])):nt("",!0),i.value.isBasePart?(x(),_("span",ul,[L("🏛️ "),dl,L(" This building is part of your base and must be built next to an adjacent base building. Be sure to protect it from enemies!")])):nt("",!0)])]),y("article",gl,F(i.value.description),1),y("aside",pl,[y("button",{disabled:!t.unlocksController.canUnlock(i.value),onclick:g},F(i.value.isRepeatable?"Activate":t.unlocksController.isUnlocked(i.value)?"Unlocked":"Unlock"),9,fl),L(" ("+F(t.unlocksController.getPoints())+" wave points remaining) ",1)])])])])],2))}});const yl=ht(ml,[["__scopeId","data-v-443103e6"]]),wl={class:"horizontal"},vl=["value"],Sl={class:"horizontal"},El={class:"horizontal"},Il={class:"horizontal"},bl=at({__name:"Settings",props:{setSubmitter:{type:Function}},setup(n){const{setSubmitter:t}=n,e=[{label:"Pixi renderer",value:ot},{label:"Emoji renderer",value:Yi}],s=Wt("settings"),i=R(s&&e.find(({value:p})=>p===s.renderer)||e[0]),r=R((s==null?void 0:s.showTutorial)??!0),o=R((s==null?void 0:s.volume)??50),h=R((s==null?void 0:s.simulation)??1);return t(()=>({...s,renderer:i.value.value,showTutorial:r.value,volume:o.value,simulation:h.value})),(p,g)=>(x(),_(At,null,[y("label",wl,[L(" Renderer "),ge(y("select",{"onUpdate:modelValue":g[0]||(g[0]=d=>i.value=d)},[(x(),_(At,null,ne(e,d=>y("option",{value:d},F(d.label),9,vl)),64))],512),[[Xn,i.value]])]),y("label",Sl,[L(" Show tutorial "),ge(y("input",{type:"checkbox","onUpdate:modelValue":g[1]||(g[1]=d=>r.value=d)},null,512),[[qa,r.value]])]),y("label",El,[L(" Volume "),ge(y("input",{type:"range",min:"0",max:"100","onUpdate:modelValue":g[2]||(g[2]=d=>o.value=d)},null,512),[[hi,o.value]])]),y("label",Il,[L(" Simulation speed "),ge(y("input",{type:"range",min:"1",max:"3","onUpdate:modelValue":g[3]||(g[3]=d=>h.value=d)},null,512),[[hi,h.value]])])],64))}});const Ba=ht(bl,[["__scopeId","data-v-0b0785e7"]]),Ra=n=>(Pe("data-v-3467493d"),n=n(),Ce(),n),Ml={class:"menu"},Tl=Ra(()=>y("h3",null,"Paused",-1)),xl=Ra(()=>y("span",{class:"divider"},null,-1)),Al=at({__name:"IngameMenu",props:{visible:{type:Boolean},mainMenu:{type:Function},resume:{type:Function}},setup(n){const{visible:t,mainMenu:e,resume:s}=n;let i;const r=h=>i=h,o=()=>{const h=i();gs("settings",h),s(h.renderer,h.showTutorial,h.simulation)};return(h,l)=>(x(),_("div",{class:ct({"menu-wrapper":!0,"menu-wrapper--visible":h.visible})},[y("div",Ml,[Tl,y("button",{onClick:l[0]||(l[0]=(...p)=>h.mainMenu&&h.mainMenu(...p))},"Main menu"),xl,D(Ba,{setSubmitter:r}),y("button",{onClick:o},"Save and resume")])],2))}});const kl=ht(Al,[["__scopeId","data-v-3467493d"]]),Pl=["is"],Cl=at({__name:"UiElement",props:{onClick:{type:Function},active:{type:Boolean},className:{},style:{}},setup(n){const t=n;return(e,s)=>(x(),_("button",{is:t.onClick?"button":"div",onClick:s[0]||(s[0]=(...i)=>e.onClick&&e.onClick(...i)),class:ct({"ui-element":!0,"ui-element--interactive":t.onClick,"ui-element--active":t.active,...t.className}),style:Ke(t.style)},[$n(e.$slots,"default",{},void 0,!0)],14,Pl))}});const Ut=ht(Cl,[["__scopeId","data-v-67b09611"]]),_l={class:"meta"},Bl={class:"positive"},Rl={class:"meta"},Dl={class:"positive"},Ll={class:"negative"},Ol={class:"meta"},Fl={class:"positive"},Yl={key:0,class:"negative"},Xl={key:1},$l=at({__name:"Stats",setup(n){const t=Intl.NumberFormat(void 0,{maximumFractionDigits:0}),e=Intl.NumberFormat(void 0,{maximumFractionDigits:2}),s=Intl.NumberFormat(void 0,{style:"percent",maximumFractionDigits:0}),i=R(0),r=R(0),o=R(0),h=R(0),l=R(0),p=R(!1),g=R(0),d=R(0),w=R(0),S=R(0),I=R(0),M=R(!0);function B(){M.value=!M.value}const O=P=>{i.value=P.money,r.value=P.moneyMultiplier,o.value=P.level,h.value=P.towers,l.value=P.maxTowers,p.value=P.inProgress,g.value=P.integrity,d.value=P.regeneration,w.value=P.power,S.value=P.production,I.value=P.consumption},b=Qa(()=>({stats:!0,"stats--collapsed":!M.value}));return ke(()=>{A.Instance.addEventListener(E.StatUpdate,O),u.Instance.triggerStatUpdate()}),Ws(()=>{A.Instance.removeEventListener(E.StatUpdate,O)}),(P,X)=>(x(),_("div",{class:ct(b.value)},[D(Ut,{onClick:B,"class-name":{circle:!0}},{default:Mt(()=>[L(" 🪙 "+F(Y(t).format(i.value))+" ",1),y("span",_l,[L("("),y("span",Bl,F(Y(s).format(r.value)),1),L(")")])]),_:1}),D(Ut,{"class-name":{"minor-stat":!0},style:{"--i":"145deg"}},{default:Mt(()=>[L(" 🔋 "+F(Y(t).format(w.value))+" ",1),y("span",Rl,[L("("),y("span",Dl,"+"+F(Y(e).format(S.value)),1),L("/"),y("span",Ll,"-"+F(Y(e).format(I.value)),1),L(")")])]),_:1}),D(Ut,{"class-name":{"minor-stat":!0},style:{"--i":"90deg"}},{default:Mt(()=>[L(" 🛡️ "+F(Y(t).format(g.value))+" ",1),y("span",Ol,[L("("),y("span",Fl,"+"+F(Y(e).format(d.value)),1),L(")")])]),_:1}),D(Ut,{"class-name":{"minor-stat":!0},style:{"--i":"35deg"}},{default:Mt(()=>[L(" 🗼 "),h.value>=l.value?(x(),_("span",Yl,F(h.value),1)):(x(),_("span",Xl,F(h.value),1)),L(" / "+F(l.value),1)]),_:1})],2))}});const Nl=ht($l,[["__scopeId","data-v-39d1faf6"]]),Ul={class:"hud"},zl={class:"group"},Wl={key:0,class:"emoji"},Hl={key:1,class:"emoji"},Gl={key:2,class:"wave-text"},Vl={key:3,class:"wave-text"},jl={key:4,class:"wave-text"},Kl={class:"sub-buttons"},ql=at({__name:"Hud",props:{renderer:{},controller:{},restart:{type:Function},toggleMenu:{type:Function}},setup(n){const t=n,e=R(0),s=R(!1),i=R(!1),r=R(0),o=R(!1),h=g=>{e.value=g.level,s.value=g.inProgress&&g.integrity>0,r.value=g.integrity,o.value=g.towers<=g.maxTowers};ke(()=>{A.Instance.addEventListener(E.StatUpdate,h),u.Instance.triggerStatUpdate()}),Ws(()=>{A.Instance.removeEventListener(E.StatUpdate,h)});function l(){r.value>0?u.Instance.start():t.restart()}function p(){i.value?t.renderer.hideCoverage():t.renderer.showCoverage(),A.Instance.triggerEvent(E.ToggleShowCoverage),i.value=!i.value}return(g,d)=>(x(),_("div",Ul,[D(Nl),y("div",zl,[D(Ut,{onClick:l,active:s.value||!o.value},{default:Mt(()=>[o.value?(x(),_("span",Wl,"⚔️")):(x(),_("span",Hl,"🔒")),!s.value&&r.value>0?(x(),_("span",Gl,"Start wave "+F(e.value+1),1)):!s.value&&r.value<=0?(x(),_("span",Vl,"Restart wave "+F(e.value),1)):(x(),_("span",jl,"Wave "+F(e.value),1))]),_:1},8,["active"]),y("div",Kl,[D(Ut,{onClick:d[0]||(d[0]=()=>t.controller.toggleBuildMenu()),"class-name":{circle:!0}},{default:Mt(()=>[L("🔧")]),_:1}),Y(u).Instance.getDifficulty()!==Y($).Hard?(x(),ee(Ut,{key:0,onClick:p,active:i.value,"class-name":{circle:!0}},{default:Mt(()=>[L("🎯")]),_:1},8,["active"])):nt("",!0),D(Ut,{onClick:t.toggleMenu,"class-name":{circle:!0}},{default:Mt(()=>[L("⚙️")]),_:1},8,["onClick"])])])]))}});const Ql=ht(ql,[["__scopeId","data-v-04582b90"]]);class Zl{constructor(t,e=0){a(this,"removeEventListeners");a(this,"done",!1);a(this,"steps");a(this,"highestProgress",0);a(this,"data",{});a(this,"initialProgress",0);a(this,"process",t=>{const e=Math.max(this.progress,this.initialProgress);this.progress=Math.max(this.definition.getProgress.call(this,t),this.progress),!this.isDone&&(this.updateProgress(),this.highestProgress>e&&(u.Instance.showMessage(`🏆 Achievement unlocked!
${this.title} - ${this.description}`),gs("achievements",{[Ii(this.definition.description)]:this.highestProgress},!0)))});this.definition=t,this.progress=e,this.initialProgress=e,this.steps=Object.keys(this.definition.thresholds).map(s=>parseFloat(s)),this.updateProgress()}get title(){return Object.values(this.definition.thresholds)[this.steps.indexOf(this.highestProgress)]}get description(){return this.definition.description}get thresholds(){return this.definition.thresholds}get stepValues(){return this.steps}get isDone(){return this.done}get internalProgress(){return this.progress}get completedThresholds(){return this.steps.indexOf(this.highestProgress)}get percentage(){const t=this.steps.at(-1);return this.progress/t}getPercentageForThreshold(t){const e=parseFloat(t),s=this.steps[this.steps.indexOf(e)-1]??0;return Math.min(Math.max(this.progress-s,0)/(e-s),1)}register(){this.removeEventListeners=A.Instance.addEventListeners(this.definition.triggers,this.process)}unRegister(){var t;(t=this.removeEventListeners)==null||t.call(this)}updateProgress(){for(let t=0;t<this.steps.length&&this.progress>=this.steps[t];t++)this.highestProgress=this.steps[t],t===this.steps.length-1&&(this.done=!0)}}const Jl=[{description:"Reach a certain wave.",thresholds:{1:"Lvl 1 Street thug",5:"Lvl 5 Enforcer",10:"Lvl 10 Consigliere",15:"Lvl 15 Underboss",20:"Lvl 20 Don",30:"Lvl 30 Godfather"},getProgress:()=>u.Instance.getLevel(),triggers:[E.EndWave]},{description:"Discover the map.",thresholds:{"10%":"Settler","20%":"Trailblazer","40%":"Homesteader","60%":"Adventurer","90%":"Frontier explorer"},getProgress:()=>{const n=u.Instance.getSurface(),[t,e]=n.getTiles().reduce((s,i)=>(i.getType()===f.Void||(s[1]++,i.isDiscovered()&&s[0]++),s),[0,0]);return t/e*100},triggers:[E.StartWave]},{description:"Defeat enemies.",thresholds:{30:"Bot basher",100:"Circuit smasher",500:"Metal mauler",1e3:"Robo rampage",5e3:"Mechanic menace",1e4:"Robotic ruler"},getProgress:function(){const n=this.data.lastKilledEnemies??0,t=this.internalProgress+u.Instance.getKilledEnemies()-n;return this.data.lastKilledEnemies=u.Instance.getKilledEnemies(),t},triggers:[E.Kill]},{description:"Discover the edge of the map.",thresholds:{1:"Edgelord"},getProgress:()=>J.Instance.isEdgeDiscovered()?1:0,triggers:[E.StartWave]},{description:"Reach level 10 on easy mode.",thresholds:{10:"Humble beginnings"},getProgress:()=>u.Instance.getDifficulty()===$.Easy?u.Instance.getLevel():0,triggers:[E.EndWave]},{description:"Reach level 10 on normal mode.",thresholds:{10:"Establishing dominance"},getProgress:()=>u.Instance.getDifficulty()===$.Normal?u.Instance.getLevel():0,triggers:[E.EndWave]},{description:"Reach level 10 on hard mode.",thresholds:{10:"A force to be reckoned with"},getProgress:()=>u.Instance.getDifficulty()===$.Hard?u.Instance.getLevel():0,triggers:[E.EndWave]},{description:"Build a wall of at least 30 tiles.",thresholds:{30:"Great wall of China"},getProgress:n=>{const t=n;return t.tiles[0].getType()!==f.Wall?0:lc(t.tiles[0],u.Instance.getSurface(),new Set([c.Wall]),!0)},triggers:[E.Buy]},{description:"Expand your base.",thresholds:{5:"Pompeii",12:"Alexandria",25:"Athens",50:"Rome"},getProgress:()=>u.Instance.getBase().getParts().size,triggers:[E.Buy]},{description:"Unlock new technologies.",thresholds:{2:"Innovator",5:"Visionary",8:"Groundbreaker",12:"Game-changer"},getProgress:()=>xt.Instance.getUnlockAmount(),triggers:[E.Unlock]},{description:"Hit enemies using a single mortar shell.",thresholds:{5:"Bomberman"},getProgress:n=>n.amount,triggers:[E.Bomb]},{description:"Hit enemies using a single tesla coil discharge.",thresholds:{10:"Thunderstruck"},getProgress:n=>n.amount,triggers:[E.Stun]},{description:"Pierce enemies using a single railgun shot.",thresholds:{15:"Penetrator"},getProgress:n=>n.amount,triggers:[E.Pierce]}],Da=()=>{const n=Wt("achievements");return Jl.map(t=>new Zl(t,(n==null?void 0:n[Ii(t.description)])??0)).sort((t,e)=>Number(e.isDone)-Number(t.isDone)||e.completedThresholds-t.completedThresholds||e.percentage-t.percentage)},zs=class{constructor(){a(this,"achievements");a(this,"unRegister",()=>{const t={};this.achievements.forEach(e=>{t[Ii(e.description)]=e.internalProgress,e.unRegister()}),gs("achievements",t,!0)});zs.instance=this,this.achievements=Da(),this.achievements.forEach(t=>t.register()),window.addEventListener("beforeunload",this.unRegister)}cleanup(){window.removeEventListener("beforeunload",this.unRegister),zs.instance=null}static get Instance(){return this.instance}};let Bt=zs;a(Bt,"instance");class tu{constructor(t,e=1){a(this,"entity");a(this,"category",k.Unknown);a(this,"renderData",{});a(this,"targetX",0);a(this,"targetY",0);a(this,"travelTime",0);a(this,"time",0);a(this,"sourceX",0);a(this,"sourceY",0);this.tile=t,this.amount=e,this.entity=new tt(t.getX()+.5,t.getY()+.5,this),this.sourceX=this.entity.getX(),this.sourceY=this.entity.getY()}tick(t){if(this.travelTime>0&&this.time<this.travelTime){this.time+=t;const e=Math.min(1,this.time/this.travelTime);this.entity.setX(Rt(this.tile.getX(),this.targetX,e)),this.entity.setY(Rt(this.tile.getY(),this.targetY,e)),this.time>=this.travelTime&&u.Instance.getSurface().despawn(this)}}discover(){const t=u.Instance.getBase(),[e,s]=pt(t);this.targetX=e,this.targetY=s,this.travelTime=Math.sqrt((e-this.tile.getX())**2+(s-this.tile.getY())**2)*60}getType(){return c.WavePoint}isVisible(){return this.travelTime>0}}const eu={apiKey:"AIzaSyCUua4XIvRX14AI5zAQe1OynmeSxe57f0A",authDomain:"open-td-ac8be.firebaseapp.com",projectId:"open-td-ac8be",storageBucket:"open-td-ac8be.appspot.com",messagingSenderId:"351731826193",appId:"1:351731826193:web:072686940fc4909b337bb0",measurementId:"G-D9LVZGMF6F"},su=Za(eu),iu=Ja(su),Si=(n,t)=>{tr(iu,n,t)};class La{constructor(t){a(this,"entity");a(this,"category",k.Unknown);a(this,"renderData",{});this.tile=t,this.entity=new V(t.getX(),t.getY(),this)}getType(){return c.Stump}getTile(){return this.tile}updateTile(t){this.tile=t}isVisible(){return this.tile.isDiscovered()}}a(La,"scale",1);class nu extends us{constructor(t){super(t),this.renderData.subType=Gs.Rock2}getType(){return c.Rock2}}const au={[c.Tower]:na,[c.Base]:Ks,[c.Wall]:aa,[c.Mortar]:_s,[c.Flamethrower]:me,[c.Railgun]:Bs,[c.ElectricFence]:Cs,[c.Fence]:Ai,[c.Freezer]:ki,[c.Tree]:ls,[c.Pine]:Wn,[c.Cactus]:zn,[c.Stump]:La,[c.Rock]:us,[c.Rock2]:nu,[c.Rock3]:Un,[c.Radar]:Bi,[c.PowerPlant]:Ci,[c.Armory]:xi,[c.Market]:Pi,[c.SpeedBeacon]:be,[c.DamageBeacon]:Ie,[c.Laser]:ye,[c.Barracks]:Li,[c.Tesla]:qt},ru=(n,t)=>{const e=au[n];return e?new e(t).entity:null},ns=class extends u{constructor(e,s,i,r){super(e,s,i,r);a(this,"killedEnemies",0);a(this,"lastKilledEnemies",0);a(this,"removeUnlockEventListener");a(this,"removeDiscoverEventListener");a(this,"removeLostEventListener");a(this,"showMessage",(...e)=>this.messageFn(...e));a(this,"onUnlock",({placeable:e})=>{const s=this.getIsStarted();e.entityType===c.EmergencyRecharge&&(W.Instance.emergencyRegenerate(s?1:Ds),this.triggerStatUpdate()),e.entityType===c.EmergencyRepair&&(this.base.hp+=(Ks.baseEmergencyRepair+this.base.getParts().size)*(s?1:Ds),this.triggerStatUpdate())});a(this,"onDiscover",e=>{const s=e.method===Ps.Base?2:1;xt.Instance.addPoints(s);const i=new tu(this.surface.getTile(e.x,e.y),s);this.surface.spawn(i),i.discover()});a(this,"onLose",()=>{this.surface.getEntitiesForCategory(k.Enemy).forEach(e=>{const s=e.getAgent();Sr(s)&&s.AI.cancel()})});s&&(this.surface.getEntityTiles(this.base).map(o=>{o.hasStaticEntity()&&this.surface.despawnStatic(o.getStaticEntity().getAgent())}),i.spawnStatic(this.base)),this.removeUnlockEventListener=A.Instance.addEventListener(E.Unlock,this.onUnlock),this.removeDiscoverEventListener=A.Instance.addEventListener(E.Discover,this.onDiscover),this.removeLostEventListener=A.Instance.addEventListener(E.Lose,()=>window.setTimeout(this.onLose,0)),console.log(this)}cleanup(){this.removeUnlockEventListener(),this.removeDiscoverEventListener(),this.removeLostEventListener()}tick(e){if(this.surface.processChangedTiles(),this.base.isDestroyed())return;const s=this.surface.getTickingEntities();for(let i of s)i.getAgent().tick(e);K.Instance.tick(e),this.lastKilledEnemies!==this.killedEnemies&&(this.lastKilledEnemies=this.killedEnemies,A.Instance.triggerEvent(E.Kill),this.triggerStatUpdate())}triggerStatUpdate(){const e=this.getSurface().getEntitiesForCategory(k.Enemy).size;A.Instance.triggerEvent(E.StatUpdate,{integrity:this.base.getHp(),regeneration:this.base.getRegenerationFactor(),level:this.level,money:H.Instance.getMoney(),moneyMultiplier:H.Instance.getMultiplier(),production:W.Instance.getProduction(),consumption:W.Instance.getConsumption(),power:W.Instance.getPower(),remainingEnemies:e,inProgress:this.getIsStarted(),towers:this.surface.getTowers().size,maxTowers:q.Instance.getMaxTowers()})}spawnEnemy(e){this.surface.spawn(e)}despawnEnemy(e){this.killedEnemies++,this.surface.despawn(e)&&K.Instance.processWave()&&this.end()}getKilledEnemies(){return this.killedEnemies}getIsStarted(){return K.Instance.isWaveInProgress()||K.Instance.getSpawnGroups().length===0}canBuy(e,s=1){if(this.difficulty===$.Practice)return!0;const i=(Te[e.entityType]??0)*s;return i>H.Instance.getMoney()?(this.showMessage(`You do not have enough money. This costs 🪙 ${i}`),!1):!0}start(){if(this.getIsStarted())throw new Error("Wave already in progress!");if(this.surface.getTowers().size>q.Instance.getMaxTowers()){u.Instance.showMessage(`Your current base can support up to ${q.Instance.getMaxTowers()} towers. Extend your base or sell towers before starting `);return}W.Instance.processPower(),H.Instance.clearRecents(),H.Instance.addWaveBudget(this.level),K.Instance.startNewWave(),J.Instance.commit(),this.level++,J.Instance.updateBaseRange(),A.Instance.triggerEvent(E.StartWave),this.triggerStatUpdate(),u.Instance.getSurface().forceRerender()}consume(e,s=1,i=1){return W.Instance.consume((mi[e.getType()]??0)+(s-1)*W.speedBeaconConsumption+(i-1)*W.damageBeaconConsumption)}consumeContinuous(e,s,i=1){return W.Instance.consume((mi[e.getType()]??0)*s+(i-1)*W.damageBeaconConsumption*s/160)}getDifficulty(){return this.difficulty}getIsBaseDestroyed(){return this.base.isDestroyed()}getDamageMultiplier(){let e=1;switch(this.difficulty){case $.Hard:e+=.2;case $.Normal:e+=.2}return e}serialize(){const e=this.base.getTile(),s=this.surface.serialize(!0);return{killedEnemies:this.killedEnemies,difficulty:this.difficulty,base:{x:e.getX(),y:e.getY(),hp:this.base.getHp()},level:this.level,surface:[...s.buffer].map(i=>String.fromCharCode(i+ns.serializeStartChar)).join("")}}end(){q.Instance.commit(),J.Instance.commit(),K.Instance.cleanupSpawnGroups(Ps.Base),this.base.regenerate(),this.triggerStatUpdate(),A.Instance.triggerEvent(E.EndWave),K.Instance.getSpawnGroups().length===0?this.showMessage("World conquered. You win!",{closable:!1,expires:0}):this.level===9?this.showMessage("Something is rumbling in the distance."):K.Instance.shouldAddSpawnGroup()&&(A.Instance.triggerEvent(E.Spawn),this.showMessage("Another spawn point has appeared!")),u.Instance.getSurface().forceRerender(),gs("save",cu()),Si("defeat_wave",{difficulty:this.difficulty,wave:this.level})}static deserialize(e,s){const i=new Yt(Uint8Array.from(s.surface.split("").map(h=>h.charCodeAt(0)-ns.serializeStartChar)),ru),r=new Gn(i),o=new ns(s.difficulty,null,r,e);return o.level=s.level,o.base=r.getTile(s.base.x,s.base.y).getStaticEntity().getAgent(),o.base.hp=s.base.hp,o}};let xe=ns;a(xe,"serializeStartChar","À".charCodeAt(0));const Oa="0.0.6",ou=(n,t,e,s)=>{new A,n!==$.Practice&&new Bt,new J(e);const i=new Ks(t),r=new xe(n,i,e,s);return new K(i,e),new W,new H(n===$.Practice?Number.POSITIVE_INFINITY:100,()=>i.getMoneyFactor()),new q(e),new xt,r},cu=()=>({version:Oa,manager:xe.Instance.serialize(),visibilityController:J.Instance.serialize(),waveController:K.Instance.serialize(),powerController:W.Instance.serialize(),moneyController:H.Instance.serialize(),buildController:q.Instance.serialize(),unlocksController:xt.Instance.serialize()}),Dn=(n,t)=>{A.Instance||new A;const e=xe.deserialize(n,t.manager),s=e.getSurface(),i=e.getBase();u.Instance.getDifficulty()===$.Practice?Bt.Instance&&Bt.Instance.cleanup():Bt.Instance||new Bt,J.deserialize(s,t.visibilityController),K.deserialize(s,i,t.waveController),W.deserialize(s,t.powerController),H.deserialize(()=>i.getMoneyFactor(),t.moneyController),q.deserialize(s,t.buildController),xt.deserialize(t.unlocksController),J.Instance.commit();const r=s.getEntitiesForCategory(k.Player);for(const o of r){const h=o.getAgent();if(di(h)){h.spawn();continue}q.baseParts.has(h.getType())&&i.addPart(h)}return e.triggerStatUpdate(),e},hu=n=>(Pe("data-v-54186e1f"),n=n(),Ce(),n),lu={class:"wrapper"},uu={height:"0",style:{position:"absolute"}},du=hu(()=>y("defs",null,[y("radialGradient",{id:"alert"},[y("stop",{offset:"0%","stop-color":"red","stop-opacity":"0"}),y("stop",{offset:"95%","stop-color":"red","stop-opacity":"0"}),y("stop",{offset:"100%","stop-color":"red","stop-opacity":"0.8"})])],-1)),gu=[du],pu={class:"canvas"},fu=at({__name:"Game",props:{seed:{},difficulty:{},renderer:{},showTutorial:{type:Boolean},initialSpeed:{},mainMenu:{type:Function}},setup(n){const t=n,e=R(null),s=R(!1),i=R(!1),r=R(t.initialSpeed),o=new Xt;let h=new t.renderer(o),l,p;if(t.seed){console.log(`Seed: ${t.seed}`),p=new Gn({width:160,height:160,generate:mr(t.seed,160,160)});const X=p.getTile(80,80);l=ou(t.difficulty,X,p,h.showMessage)}else console.log("Loading save"),l=Dn(h.showMessage,Wt("save")),p=l.getSurface();const g=new vc;t.showTutorial&&g.start();let d=!1,w,S,I,M;const B=()=>{s.value=!s.value,s.value?o.pause():o.unpause()};ke(()=>{d=!0,o.initialize(p),h.mount(p,e.value),S=o.addKeyListener(st.Escape,()=>{if(i.value){Xt.Instance.toggleBuildMenu();return}B()}),I=A.Instance.addEventListener(E.OpenBuildMenu,()=>i.value=!0),M=A.Instance.addEventListener(E.CloseBuildMenu,()=>i.value=!1);const X=rt=>{if(!d)return;const kt=+o.isKeyDown(st.Right)+ +o.isKeyDown(st.D)-+o.isKeyDown(st.Left)-+o.isKeyDown(st.A)-+o.isKeyDown(st.Q),ce=+o.isKeyDown(st.Down)+ +o.isKeyDown(st.S)-+o.isKeyDown(st.Up)-+o.isKeyDown(st.W)-+o.isKeyDown(st.Z),Vt=+o.isKeyDown(st.Plus)+ +o.isKeyDown(st.Equals)-+o.isKeyDown(st.Minus);(kt||ce||Vt)&&h.move({x:kt,y:ce,zoom:Vt});const fs=w?rt-w:16;s.value||l.tick(fs*r.value),h.rerender(fs),w=rt,window.requestAnimationFrame(X)};window.requestAnimationFrame(X)}),Ws(()=>{var X;h.unmount(),(X=Bt.Instance)==null||X.unRegister(),S(),I(),M(),d=!1,u.Instance.getBase().isDestroyed()&&Wh("save")});const O=(X,rt,kt)=>{X&&!(h instanceof X)?(h.unmount(),p.forceRerender(),h=new X(o),h.mount(p,e.value),l.update(h.showMessage)):h instanceof ot&&h.updateSettings(),!g.isStarted&&rt&&g.start(),g.isStarted&&rt===!1&&g.stop(),kt&&(r.value=kt),s.value=!1,o.unpause()},b=()=>{l=Dn(h.showMessage,Wt("save")),p=l.getSurface(),o.initialize(p),h.unmount(),h.mount(p,e.value)},P=()=>{var X;(X=Bt.Instance)==null||X.unRegister(),t.mainMenu()};return(X,rt)=>(x(),_("div",lu,[(x(),_("svg",uu,gu)),D(Ql,{renderer:Y(h),controller:Y(Xt).Instance,restart:b,toggleMenu:B},null,8,["renderer","controller"]),y("div",pu,[y("div",{class:"render-target",ref_key:"canvas",ref:e},null,512),D(yl,{controller:Y(Xt).Instance,unlocksController:Y(xt).Instance,eventSystem:Y(A).Instance,visible:i.value},null,8,["controller","unlocksController","eventSystem","visible"]),D(kl,{mainMenu:P,visible:s.value,resume:O},null,8,["visible"])])]))}});const mu=ht(fu,[["__scopeId","data-v-54186e1f"]]);const yu={},wu={class:"key-grid"};function vu(n,t){return x(),_("div",wu,[$n(n.$slots,"default",{},void 0,!0)])}const ri=ht(yu,[["render",vu],["__scopeId","data-v-ad6fcae2"]]),ps=n=>(Pe("data-v-52ee7b24"),n=n(),Ce(),n),Su=ps(()=>y("h3",null,"Build menu",-1)),Eu={class:"flex"},Iu=ps(()=>y("h3",null,"Building",-1)),bu={class:"flex flex-justify"},Mu={class:"key-combination"},Tu={class:"key-combination"},xu=ps(()=>y("h3",null,"Moving",-1)),Au={class:"flex flex-justify"},ku=ps(()=>y("h3",null,"Zooming",-1)),Pu={class:"flex"},Cu=ps(()=>y("h3",null,"Toggle selling",-1)),_u={class:"flex"},Bu=at({__name:"ControlsList",setup(n){return(t,e)=>(x(),_(At,null,[Su,y("div",Eu,[D(j,{char:"e"}),L(" / "),D(j,{char:"b"})]),Iu,y("div",bu,[D(xs,{button:"left"}),L(" / "),y("span",Mu,[D(j,{char:"⇧"}),L(" + "),D(xs,{button:"left"})]),L(" / "),y("span",Tu,[D(j,{char:"⌘"}),L(" + "),D(xs,{button:"left"})])]),xu,y("div",Au,[D(ri,null,{default:Mt(()=>[D(j,{char:"w",area:"up"}),D(j,{char:"a",area:"left"}),D(j,{char:"s",area:"down"}),D(j,{char:"d",area:"right"})]),_:1}),L(" / "),D(ri,null,{default:Mt(()=>[D(j,{char:"z",area:"up"}),D(j,{char:"q",area:"left"}),D(j,{char:"s",area:"down"}),D(j,{char:"d",area:"right"})]),_:1}),L(" / "),D(ri,null,{default:Mt(()=>[D(j,{char:"↑",area:"up"}),D(j,{char:"←",area:"left"}),D(j,{char:"↓",area:"down"}),D(j,{char:"→",area:"right"})]),_:1})]),ku,y("div",Pu,[D(j,{char:"-"}),D(j,{char:"+"})]),Cu,y("div",_u,[D(j,{char:"f"})])],64))}});const Ru=ht(Bu,[["__scopeId","data-v-52ee7b24"]]),Fa=n=>(Pe("data-v-55661321"),n=n(),Ce(),n),Du={class:"achievement-title"},Lu={class:"achievement-description"},Ou={key:0,class:"achievement-progress"},Fu={class:"achievement-line"},Yu=["title"],Xu=Fa(()=>y("span",{class:"line"},null,-1)),$u={class:"marker"},Nu=Fa(()=>y("span",{class:"achievement-line-segment"},[y("span",{class:"line"})],-1)),Uu=[Nu],zu={class:"achievement-percentage"},Wu="???????",Hu=at({__name:"Achievement",props:{achievement:{}},setup(n){const{achievement:t}=n,e=Intl.NumberFormat(void 0,{style:"percent",maximumFractionDigits:0}),s=t.stepValues.at(-1),i=t.percentage;return(r,o)=>(x(),_("div",{class:ct({achievement:!0,"achievement--complete":r.achievement.isDone})},[y("h2",Du,F(r.achievement.title??Wu),1),y("p",Lu,F(r.achievement.description),1),r.achievement.stepValues.length>1||Y(s)!==1?(x(),_("div",Ou,[y("span",Fu,[y("span",{class:"achievement-line-nominal",style:Ke({flex:Y(s)})},[(x(!0),_(At,null,ne(r.achievement.thresholds,(h,l)=>(x(),_("span",{class:ct({"achievement-line-segment":!0}),style:Ke({"--progress":`${r.achievement.getPercentageForThreshold(l)*100}%`}),title:r.achievement.internalProgress>=parseFloat(l)?h:r.achievement.internalProgress.toFixed()},[Xu,y("span",$u,F(l),1)],12,Yu))),256))],4),r.achievement.internalProgress>Y(s)?(x(),_("span",{key:0,class:"achievement-line-overflow",style:Ke({flex:r.achievement.internalProgress-Y(s)})},Uu,4)):nt("",!0)]),y("p",zu,F(Y(i)>1?r.achievement.internalProgress:Y(e).format(Y(i))),1)])):nt("",!0)],2))}});const Gu=ht(Hu,[["__scopeId","data-v-55661321"]]),Vu=at({__name:"AchievementsList",setup(n){const t=Da();return(e,s)=>(x(!0),_(At,null,ne(Y(t),i=>(x(),ee(Gu,{achievement:i},null,8,["achievement"]))),256))}}),Ln=["a","e","i","o","u"],On=["b","c","d","f","g","h","j","k","l","m","n","p","q","r","s","t","v","w","x","y","z"],Ya=()=>Ln[Math.floor(Math.random()*Ln.length)],Xa=()=>On[Math.floor(Math.random()*On.length)],$a=()=>Xa()+Ya(),ju=()=>$a()+Xa(),Fn=[Ya,$a,ju],Ku=()=>Fn[Math.floor(Math.random()*Fn.length)](),qu=()=>{const n=[],t=Math.random()>.5?3:2;for(let e=0;e<t;e++)n.push(Ku());return n.join("")},Qu="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAABMtJREFUeF7tm01IVUEUx8dVRCQIFZGlRBRCZCChRIGrFlG6sSioFgmBBmJQ0UIiJVpIBUaUgWCrokBbaNGilVCEES6EwLICNSMiEoKKVi/Os3OZN87HOTNz39N8d/PUOx/n/zv/OTP3vWeJWOZXyTLXL4oAig5YYgTu9d7MdP+6JcbPTkRxb5RB8smw+npVBueLASGvAA6cGU2Ct0F70lNnjQshLHoAVMEuB6lAYrogFQeECq+svqtlsufPdrGxfINom+xI7oe6ICqAtISjWgAAF0CAC0AsCgChwkGMKeuqFVQI9Y1NQUkM6gzBhYqnCjeBONbaFqQhqDNHvI/QI2v2ZXU//PbMWidvN9/x1uHdkSreRzioBfGfZj+LmtrL4utsb2oQvABwxYMYVxblFLftfJST8bFXF8WLFW+sLuhu2CtWrz3O1sPu4CP+6pZ2cf7DDTKEgdJ2MbK5PhFMcQA09oHgBABnbyw0VPFyVZ+ue5wIqRg96DrzJPdx/a8rbxVUB2BnjhOsAHzFIwAQgdnnugDGwIMPdfmAA7gQjABmTuxIzu0fD3dmC9L9t7WkDMqFD/dt6Civ46nxkzlj+RZLHEQWD3+jusAJAMTjVqQGbaLhEkMZxzWGPLcqnuMCLQBd9iF7lMBdpzrqGDq4DzomxYXh59liB6/f3zcLUTXfsuHnaPa18VAZaxlYAcjZx1EpAkzZs/UFcabr6JWtQnf/1NNtQkyIBAL079v/LmcY11KwFsGRocEMrH11D6ZAMImxCfUCAJ3+QQAXyA6g1ALnLqA7gPgA8BEOAiD7cOn6Dw3MieFVdckSUMVTaoEVwOn+lgXv4HDF+wrH4BGADgIC0GVedpNtGaQKIFS87ACTC1RQujmjAaBmnyJ87OVKUbP7t7HwyTdsy4DSzgtAiP1NAMCycOE7OvAzBQIXAELBOKC/6Y1W4xJQAVCzbytY1zp/ZGPr6ZvfvCniXYVQtZBcM+R7QQA44ikAoM25ztIFW5ZtG1SzSmn73wBQi6EJsin70L7gDoAgsAbAz6Y921YVbQJd1XRRAHAFSbnvCyGvAPBZAB9aYr7qlgMFXEEAQGCxxMsiuUU5qAb4TMZ5lqdkT23jE5O3A3wmg4DTguAbDxsAiJAPQ7tmhHi9SQh4HZzLfTvLlMU0IPgAsH3cznoYQgicIGJC4MxLOQRBGzIAHwdgECYI8pjgLtdVUAAQHMf+rmWhisffTf18xdt2AKcD5DrgY39bRpvKcr8EgfXF5ARf+K6v2zg/GVILIbUAuuxsA6BzB4ynzi2PYYorGAC6ILYDYFwqBITJBeAST1oC6jKI5QAdAJtruOJdax/nci4BbNjf1ZLhngO4y4AKQHWOLimU7JMdkNYyUIWYAKSVfRYAGYKuILmyrbtPAWATb4qDmn02AOgA3xGAg03IvowwuABiWp9dA+QMQj2IUQxdALjW52Q+CAA6wcf2ch8uANt8PuK9loAcBOcrM6bgTRA4DvMVHwwglhNCnBQiPgqAQkIIFR8NAGYwxpKguCGG8OAiaAs0LRAxhacKQHVE76X1lMRq27R2fTF+quM9qNSR/CwQY7LpuSnSv8xUlFXmLa68TRQDYBpjFAGkQXUpjVl0wFLKVhqxLnsH/AU7Wtlfb8AWCgAAAABJRU5ErkJgggAA",$i=n=>(Pe("data-v-570a61bf"),n=n(),Ce(),n),Zu={class:"wrapper"},Ju={class:"main-title"},td=["src"],ed={class:"menu"},sd={class:"menu-main"},id={class:"menu-main-inner"},nd=["value"],ad={class:"difficulty-description"},rd=$i(()=>y("button",{type:"submit"},"Start!",-1)),od={class:"menu-controls-inner"},cd={class:"menu-controls-inner"},hd={class:"menu-settings-inner"},ld={class:"footer"},ud=$i(()=>y("a",{class:"footer-link",href:"https://github.com/lorgan3/open-td/releases",target:"_blank",rel:"noopener noreferrer"},"Release notes",-1)),dd={key:0},gd=$i(()=>y("span",{class:"spinner"},"߷",-1)),pd=at({__name:"MainMenu",props:{onPlay:{type:Function}},setup(n){const t=n,e=R(0),s=R(qu()),i=R(null),r=R(!1);ke(()=>{window.setTimeout(()=>{r.value=zh("save")},0)});const o=Wt("settings"),h=R((o==null?void 0:o.difficulty)||$.Easy),l=R(!0);Xi().then(()=>l.value=!1);let p;const g=I=>p=I,d=I=>{var M;if(I===e.value){e.value=0;return}e.value=I,e.value===1&&((M=i.value)==null||M.select())},w=I=>{I.preventDefault();const M=p();gs("settings",{...M,difficulty:h.value}),t.onPlay(s.value,h.value,M.renderer,M.showTutorial,M.simulation),Si("play",{difficulty:h.value})},S=I=>{I.preventDefault();const M=p();t.onPlay(null,h.value,M.renderer,M.showTutorial,M.simulation),Si("play_save")};return(I,M)=>(x(),_("div",Zu,[y("h1",Ju,[y("img",{src:Y(Qu),alt:"Open Tower Defense"},null,8,td),L(" Open Tower Defense ")]),y("div",ed,[y("div",sd,[y("div",id,[r.value?(x(),_("button",{key:0,onClick:S},"Continue")):nt("",!0),y("button",{onClick:M[0]||(M[0]=B=>d(1))},"Play"),y("button",{onClick:M[1]||(M[1]=B=>d(2))},"Controls"),y("button",{onClick:M[2]||(M[2]=B=>d(3))},"Achievements"),y("button",{onClick:M[3]||(M[3]=B=>d(4))},"Settings")])]),y("div",{class:ct({"menu-play":!0,"menu--hidden":e.value!==1})},[y("form",{onSubmit:w,class:"menu-play-inner"},[y("label",null,[L(" Which world? "),ge(y("input",{ref_key:"seedInput",ref:i,"onUpdate:modelValue":M[4]||(M[4]=B=>s.value=B)},null,512),[[hi,s.value]])]),y("label",null,[L(" Difficulty "),ge(y("select",{"onUpdate:modelValue":M[5]||(M[5]=B=>h.value=B)},[(x(!0),_(At,null,ne(Y(rn),({label:B},O)=>(x(),_("option",{value:O},F(B),9,nd))),256))],512),[[Xn,h.value]])]),y("p",ad,F(Y(rn)[h.value].description),1),rd],32)],2),y("div",{class:ct({"menu-controls":!0,"menu--hidden":e.value!==2})},[y("div",od,[D(Ru)])],2),y("div",{class:ct({"menu-achievements":!0,"menu--hidden":e.value!==3})},[y("div",cd,[D(Vu)])],2),y("div",{class:ct({"menu-settings":!0,"menu--hidden":e.value!==4})},[y("div",hd,[D(Ba,{setSubmitter:g})])],2)]),y("div",ld,[y("span",null,F(Y(Oa)),1),ud,l.value?(x(),_("span",dd,[gd,L(" Loading assets")])):nt("",!0)])]))}});const fd=ht(pd,[["__scopeId","data-v-570a61bf"]]);window.OffscreenCanvas||(window.OffscreenCanvas=class{constructor(t,e){a(this,"canvas");return this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e,this.canvas.convertToBlob=()=>new Promise(s=>{this.canvas.toBlob(s)}),this.canvas}});const md=at({__name:"App",setup(n){const t=R(0),e=R(),s=R(),i=R(),r=R(),o=R(),h=(p,g,d,w,S)=>{t.value=1,e.value=p,s.value=g,i.value=d,r.value=w,o.value=S},l=()=>t.value=0;return(p,g)=>(x(),_(At,null,[t.value==0?(x(),ee(fd,{key:0,onPlay:h})):nt("",!0),t.value==1?(x(),ee(mu,{key:1,seed:e.value,difficulty:s.value,renderer:i.value,showTutorial:r.value,initialSpeed:o.value,mainMenu:l},null,8,["seed","difficulty","renderer","showTutorial","initialSpeed"])):nt("",!0)],64))}});Ei(md).mount("#app");
