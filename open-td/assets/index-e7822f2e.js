var va=Object.defineProperty;var Sa=(i,t,e)=>t in i?va(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var a=(i,t,e)=>(Sa(i,typeof t!="symbol"?t+"":t,e),e);import{A as Ea,c as Ma,H as Ia,d as it,o as x,b as A,t as F,n as j,u as R,g as hs,h as _,w as ba,i as B,j as le,k as Q,F as vt,l as xa,m as Ze,q as Ht,s as m,v as L,x as yn,y as ii,z as bs,B as zt,C as Vt,D as ie,E as wn,G as Ta,I as Ws,J as ka,K as ni,L as Pa,M as Bs}from"./vendor-de82b9c2.js";import{C as Mt,P as fe,S as X,A as Ot,q as je,x as _a,G as gs,T as ai,a as Li,U as Aa,L as Ca,F as Da,r as Ba,h as Ra,b as Oa,c as vn,M as La,d as Hs,e as Fa,B as ri,f as Ya,g as $a,i as Xa,j as Na}from"./pixi-8643c4d0.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();let Ua=1;class tt{constructor(t,e,s){a(this,"id");a(this,"rotation",0);this.x=t,this.y=e,this.agent=s,this.id=Ua++}getX(){return this.x}getAlignedX(){return this.x|0}getY(){return this.y}getAlignedY(){return this.y|0}getAgent(){return this.agent}getId(){return this.id}setX(t){this.x=t}setY(t){this.y=t}getRotation(){return this.rotation}setRotation(t){this.rotation=t}move(t,e,s){const n=(e.getX()-t.getX())*s+t.getX(),r=(e.getY()-t.getY())*s+t.getY();this.setX(n),this.setY(r),this.lookAt(e)}lookAt(t,e){let s,n;e!==void 0?(s=t-this.x,n=e-this.y):(s=t.getX()-this.x,n=t.getY()-this.y),(s||n)&&this.setRotation(Math.atan2(n,s)*180/Math.PI+90)}}const At=i=>i.constructor.scale,xt=i=>{const t=At(i),e=i.getTile();return[e.getX()+t/2,e.getY()+t/2]};function zs(i){return i?"getTile"in i:!1}class z extends tt{constructor(t,e,s){super(t,e,s)}getAgent(){return this.agent}}var k=(i=>(i[i.Unknown=0]="Unknown",i[i.Player=1]="Player",i[i.Enemy=2]="Enemy",i))(k||{}),h=(i=>(i[i.None=0]="None",i[i.Tower=1]="Tower",i[i.Slime=2]="Slime",i[i.Base=3]="Base",i[i.Bullet=4]="Bullet",i[i.Wall=5]="Wall",i[i.Mortar=6]="Mortar",i[i.Flamethrower=7]="Flamethrower",i[i.Flame=8]="Flame",i[i.Railgun=9]="Railgun",i[i.Rail=10]="Rail",i[i.ElectricFence=11]="ElectricFence",i[i.Fence=12]="Fence",i[i.Freezer=13]="Freezer",i[i.Tree=14]="Tree",i[i.Stump=15]="Stump",i[i.Rock=16]="Rock",i[i.Radar=17]="Radar",i[i.PowerPlant=18]="PowerPlant",i[i.Blueprint=19]="Blueprint",i[i.Shockwave=20]="Shockwave",i[i.Armory=21]="Armory",i[i.Market=22]="Market",i[i.SpeedBeacon=23]="SpeedBeacon",i[i.Runner=24]="Runner",i[i.DamageBeacon=25]="DamageBeacon",i[i.Laser=26]="Laser",i[i.LaserBeam=27]="LaserBeam",i[i.Flier=28]="Flier",i[i.Tank=29]="Tank",i[i.Rocket=30]="Rocket",i[i.WavePoint=31]="WavePoint",i[i.Barracks=32]="Barracks",i[i.Tesla=33]="Tesla",i[i.Spark=34]="Spark",i[i.Behemoth=35]="Behemoth",i[i.Bore=36]="Bore",i[i.Excavator=37]="Excavator",i[i.Convert=38]="Convert",i[i.Terraform=39]="Terraform",i[i.EmergencyRecharge=40]="EmergencyRecharge",i[i.EmergencyRepair=41]="EmergencyRepair",i))(h||{}),Xe=(i=>(i[i.Simple=0]="Simple",i[i.Pine=1]="Pine",i[i.Cactus=2]="Cactus",i))(Xe||{}),Vs=(i=>(i[i.Rock1=0]="Rock1",i[i.Rock2=1]="Rock2",i[i.Rock3=2]="Rock3",i))(Vs||{});const Je=new Set([3,17,18,21,22,32]),Wt=new Set([...Je,1,6,7,9,14,16,23,25,26,5,33]);var $=(i=>(i[i.Undiscovered=0]="Undiscovered",i[i.Pending=1]="Pending",i[i.Discovered=2]="Discovered",i))($||{}),f=(i=>(i[i.Void=0]="Void",i[i.Grass=1]="Grass",i[i.Stone=2]="Stone",i[i.Water=3]="Water",i[i.Obstructed=4]="Obstructed",i[i.Wall=5]="Wall",i[i.Spore=6]="Spore",i[i.ElectricFence=7]="ElectricFence",i[i.Fence=8]="Fence",i[i.Freezer=9]="Freezer",i[i.Bridge=10]="Bridge",i[i.Dirt=11]="Dirt",i[i.Snow=12]="Snow",i[i.Sand=13]="Sand",i[i.Ice=14]="Ice",i[i.PlayerBuilding=15]="PlayerBuilding",i[i.Tree=16]="Tree",i[i.Rock=17]="Rock",i[i.Base=18]="Base",i))(f||{}),ut=(i=>(i[i.WaterAlt=19]="WaterAlt",i[i.WaterStill=20]="WaterStill",i[i.GrassFlower=21]="GrassFlower",i[i.GrassAlt=22]="GrassAlt",i[i.GrassPlain=23]="GrassPlain",i[i.SandAlt=24]="SandAlt",i[i.SnowAlt=25]="SnowAlt",i[i.IceAlt=26]="IceAlt",i[i.Static1=27]="Static1",i[i.Static2=28]="Static2",i[i.Static3=29]="Static3",i))(ut||{});const Wa={[19]:3,[20]:3,[21]:1,[22]:1,[23]:1,[24]:13,[25]:12,[26]:14,[27]:0,[28]:0,[29]:0},oi=new Set([1,2,11,13,12]),ps=new Set([...oi,3,14,10,16,17]),Ha=new Set([...ps,9,7,8]),za={[h.Tower]:4,[h.Wall]:5,[h.Mortar]:4,[h.Flamethrower]:4,[h.Railgun]:4,[h.ElectricFence]:7,[h.Fence]:8,[h.Freezer]:9,[h.Radar]:18,[h.PowerPlant]:18,[h.Tree]:16,[h.Rock]:17,[h.Armory]:18,[h.Base]:18,[h.Market]:18,[h.SpeedBeacon]:4,[h.DamageBeacon]:4,[h.Laser]:4,[h.Barracks]:18,[h.Tesla]:4};class J{constructor(t,e,s=f.Void){a(this,"staticEntity",null);a(this,"hash");a(this,"actualType");a(this,"type");a(this,"towers",[]);a(this,"linkedAgents");a(this,"discoveryStatus",$.Undiscovered);this.x=t,this.y=e,this.altType=s,this.hash=`[${this.x}, ${this.y}]`,this.type=Wa[s]??s,this.actualType=this.type}serialize(){return{x:this.x,y:this.y,type:this.type}}getX(){return this.x}getY(){return this.y}getBaseType(){return this.type}getAltType(){return this.altType}getAnimation(){return this.type===f.Water?[f.Water,ut.WaterAlt,ut.WaterStill]:[this.altType]}getType(){return this.actualType}getStaticEntity(){return this.staticEntity}hasStaticEntity(){return this.staticEntity!==null}setStaticEntity(t){if(t===this.staticEntity)return;if(this.staticEntity!==null)throw new Error("A tile can only have 1 static entity.");const e=t.getAgent();zs(e)&&e.getTile().getHash()===this.getHash()&&(e.updateTile(this),this.linkedAgents&&e.updateLinkedAgents&&e.updateLinkedAgents(this.linkedAgents)),this.staticEntity=t,this.actualType=za[t.getAgent().getType()]||this.type}clearStaticEntity(){this.staticEntity=null,this.actualType=this.type}isStaticEntityRoot(){var t;return((t=this.staticEntity)==null?void 0:t.getAgent().getTile())===this}addTower(t){this.towers.includes(t)||this.towers.push(t)}setDiscoveryStatus(t){this.discoveryStatus=t}isDiscovered(){return this.discoveryStatus===$.Discovered}getDiscoveryStatus(){return this.discoveryStatus}isCoveredByTower(){return this.isDiscovered()&&this.towers.length>0}removeTower(t){this.towers.splice(this.towers.indexOf(t),1)}getAvailableTowers(){return this.towers.filter(t=>t.getCooldown()<=0)}getTowers(){return this.towers}addLinkedAgent(t){var s;this.linkedAgents||(this.linkedAgents=new Set),this.linkedAgents.add(t);const e=(s=this.staticEntity)==null?void 0:s.getAgent();e&&e.updateLinkedAgents&&e.updateLinkedAgents(this.linkedAgents)}removeLinkedAgent(t){var s;if(!this.linkedAgents)return;this.linkedAgents.delete(t);const e=(s=this.staticEntity)==null?void 0:s.getAgent();zs(e)&&e.updateLinkedAgents&&e.updateLinkedAgents(this.linkedAgents)}getLinkedAgents(){return this.linkedAgents}getHash(){return this.hash}sync(t){this.towers=t.towers,this.discoveryStatus=t.discoveryStatus}}const mi=class{constructor(){a(this,"eventHandlers");mi.instance=this,this.eventHandlers=new Map}addEventListener(t,e){return this.eventHandlers.has(t)?this.eventHandlers.get(t).add(e):this.eventHandlers.set(t,new Set([e])),()=>this.removeEventListener(t,e)}addEventListeners(t,e){const s=t.map(n=>this.addEventListener(n,e));return()=>s.forEach(n=>n())}removeEventListener(t,e){var s;(s=this.eventHandlers.get(t))==null||s.delete(e)}triggerEvent(t,...e){var s;(s=this.eventHandlers.get(t))==null||s.forEach(n=>n(...e))}static get Instance(){return this.instance}};let P=mi;a(P,"instance");const yi=class{constructor(t,e,s,n){a(this,"level",0);this.difficulty=t,this.base=e,this.surface=s,this.messageFn=n,yi.instance=this,new P}getSurface(){return this.surface}getBase(){return this.base}getLevel(){return this.level}update(t){this.messageFn=t}getDifficulty(){return this.difficulty}static get Instance(){return this.instance}};let u=yi;a(u,"instance");class Sn{constructor(t){a(this,"entity");a(this,"category",k.Unknown);a(this,"hp",30);a(this,"renderData",{});this.tile=t,this.entity=new z(t.getX(),t.getY(),this)}getType(){return h.Tree}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){this.hp-=t,this.hp<=0&&(this.renderData.chopped=!0,u.Instance.getSurface().despawnStatic(this))}isVisible(){return this.tile.isDiscovered()}}a(Sn,"scale",1);class En{constructor(t){a(this,"entity");a(this,"category",k.Unknown);a(this,"hp",30);a(this,"renderData",{});this.tile=t,this.entity=new z(t.getX(),t.getY(),this)}getType(){return h.Rock}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return this.tile.isDiscovered()}}a(En,"scale",1);const Va=(i,t,e)=>{const s=Ea(i),n=Ma(s),r=n(1,0)*193,o=n(0,1)*197,c=.048,l=.0077,g=.0025,p=.0194,d=.039,v=13,w=v*2,I=.1,Y=.95,D={top:[],right:[],bottom:[],left:[]};for(let E=0;E<t;E++){let C=0;E<w?C=(w-E)*I:E>t-w&&(C=(w-t+E)*I),D.top[E]=(n(E*d,0)+1+C)*v,D.bottom[E]=(n(E*d,e*d)+1+C)*v}for(let E=0;E<e;E++){let C=0;E<w?C=(w-E)*I:E>e-w&&(C=(w-e+E)*I),D.right[E]=(n(t*d,E*d)+1+C)*v,D.left[E]=(n(0,E*d)+1+C)*v}return(E,C)=>{if(C<D.top[E]||C>e-D.bottom[E]||E<D.left[C]||E>t-D.right[C])return new J(E,C,f.Void);const W=E+r,nt=C+o,Ft=n(W*c,nt*c),Zt=n(W*g,nt*g),Yt=Math.abs(Zt),ma=n(W*l,nt*l),Cs=1-Math.abs(ma),es=n(W*p,nt*p),Oi=Math.abs(es),gt=(Zt+es/3)*.83,ss=gt+Yt*9241%1/3,ya=Cs>Y+gt/10,wa=Cs+Ft/3+es-.4>Y+gt/2;if(ya||wa)return Zt+Yt*1811%1/7<-.6?new J(E,C,Yt*1439%1>.5?f.Ice:ut.IceAlt):new J(E,C,f.Water);if(Cs>Y+gt/15)return new J(E,C,f.Dirt);let Dt;if(gt>.3)Dt=new J(E,C,gt*1439%1>.3?f.Sand:ut.SandAlt);else if(gt<-.5)Dt=new J(E,C,gt*-1439%1>.3?f.Snow:ut.SnowAlt);else{const kt=Math.abs(gt)*4999%1;Dt=new J(E,C,kt<.05?ut.GrassFlower:kt<.1?ut.GrassAlt:kt<.6?ut.GrassPlain:f.Grass)}const Ds=(es+.5)*(Ft-.5)+Yt*5419%1/10;if(Ds<.07&&Ds>.04&&ss>-.4&&ss<.6){const kt=new Sn(Dt);kt.renderData.subType=gt>.3?Xe.Cactus:gt<-.4||Ds<.045?Xe.Pine:Xe.Simple,Dt.setStaticEntity(kt.entity)}else if((ss<-.5||ss>.7)&&Oi*2791%1>.99){const kt=new En(Dt);kt.renderData.subType=Oi>.5?Vs.Rock1:Vs.Rock3,Dt.setStaticEntity(kt.entity)}return Dt}};var M=(i=>(i[i.StatUpdate=0]="StatUpdate",i[i.SurfaceChange=1]="SurfaceChange",i[i.BlackOut=2]="BlackOut",i[i.OpenBuildMenu=3]="OpenBuildMenu",i[i.CloseBuildMenu=4]="CloseBuildMenu",i[i.SelectPlaceable=5]="SelectPlaceable",i[i.ToggleShowCoverage=6]="ToggleShowCoverage",i[i.StartWave=7]="StartWave",i[i.EndWave=8]="EndWave",i[i.Unlock=9]="Unlock",i[i.Discover=10]="Discover",i[i.Spawn=11]="Spawn",i[i.Buy=12]="Buy",i[i.Sell=13]="Sell",i[i.HitBase=14]="HitBase",i[i.Lose=15]="Lose",i[i.Kill=16]="Kill",i[i.Pierce=17]="Pierce",i[i.Bomb=18]="Bomb",i[i.Stun=19]="Stun",i))(M||{}),fs=(i=>(i[i.Base=0]="Base",i[i.Radar=1]="Radar",i))(fs||{});const Ss=class{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"hp",50);a(this,"renderData",{});this.tile=t,this.entity=new z(t.getX(),t.getY(),this)}spawn(){u.Instance.getSurface().getAdjacentTiles(this.tile,Ss.scale).forEach(t=>t.addLinkedAgent(this))}despawn(){u.Instance.getSurface().getAdjacentTiles(this.tile,Ss.scale).forEach(t=>t.removeLinkedAgent(this))}getType(){return h.DamageBeacon}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}};let Ne=Ss;a(Ne,"scale",2);const Es=class{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"hp",50);a(this,"renderData",{});this.tile=t,this.entity=new z(t.getX(),t.getY(),this)}spawn(){u.Instance.getSurface().getAdjacentTiles(this.tile,Es.scale).forEach(t=>t.addLinkedAgent(this))}despawn(){u.Instance.getSurface().getAdjacentTiles(this.tile,Es.scale).forEach(t=>t.removeLinkedAgent(this))}getType(){return h.SpeedBeacon}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}};let Ue=Es;a(Ue,"scale",2);function Fi(i){return"getCooldown"in i}const Ga=i=>i.constructor.range,ye=(i,t,e)=>{const s=u.Instance.getSurface(),n=new Set,r=()=>{const c=new Set(s.getEntityTiles(i));s.forCircle(i.entity.getX()+1,i.entity.getY()+1,t,l=>{s.forLine(i.entity.getX(),i.entity.getY(),l.getX(),l.getY(),g=>{if(g.addTower(i),n.add(g),!c.has(g)&&e&&e(g))return!1},{connected:!0})},{edgeOnly:!0})};r();const o=P.Instance.addEventListener(M.SurfaceChange,({affectedTiles:c})=>{for(const l of c)if(n.has(l)){n.forEach(g=>g.removeTower(i)),n.clear(),r();return}});return[()=>{n.forEach(c=>c.removeTower(i)),o()},n]},we=i=>{let t=1;return i.forEach(e=>{e instanceof Ue&&(t+=.5)}),t},ve=i=>{let t=1;return i.forEach(e=>{e instanceof Ne&&(t+=.5)}),t},Mn=[[1,0],[-1,0],[0,1],[0,-1]],ja=[...Mn,[1,1],[-1,-1],[-1,1],[1,-1]];class Ka{constructor(t){a(this,"map");a(this,"entities",[]);a(this,"deletedEntities",[]);a(this,"tickingEntities",[]);a(this,"entitiesMap",new Map);a(this,"towers",new Set);a(this,"width");a(this,"height");a(this,"dirty",!1);a(this,"_version",0);a(this,"changedTiles",new Set);a(this,"addedAgents",new Set);a(this,"removedAgents",new Set);this.width=t.width,this.height=t.height;const e="buffer"in t?t.buffer:t.generate;this.initialize(e??((s,n)=>new J(s,n)))}serialize(){const t=new Uint8Array(this.map.length*3);for(let e=0;e<this.map.length;e++){const s=this.map[e],n=e*3;t[n]=s.getX(),t[n+1]=s.getY(),t[n+2]=s.getType()}return{width:this.width,height:this.height,buffer:t}}initialize(t){if(this.entities=[],this.deletedEntities=[],this.entitiesMap.clear(),Object.values(k).filter(e=>typeof e!="string").forEach(e=>this.entitiesMap.set(e,new Set)),this.map=new Array(this.width*this.height),t instanceof Uint8Array)for(let e=0;e<this.map.length;e++){const s=e*3;this.map[e]=new J(t[s],t[s+1],t[s+2])}else{const e=[];for(let s=0;s<this.height;s++)for(let n=0;n<this.width;n++){const r=t(n,s);this.map[s*this.width+n]=r,r.hasStaticEntity()&&e.push(r.getStaticEntity())}for(let s of e)this.spawnStatic(s.getAgent())}}getTile(t,e,s=!1){return t>=this.width||t<0||e>=this.height||e<0?s?this.getTile(Math.max(Math.min(t,this.width-1),0),Math.max(Math.min(e,this.height-1),0)):void 0:this.map[e*this.width+t]}getEntityTiles(t,e,s){let n;if(e!==void 0)n=t;else{const r=t;n=r.getTile().getX(),e=r.getTile().getY(),s=At(r)}switch(s){case 1:return[this.map[e*this.width+n]];case 2:return[this.map[e*this.width+n],this.map[e*this.width+n+1],this.map[(e+1)*this.width+n],this.map[(e+1)*this.width+n+1]];default:throw new Error("Unsupported agent scale!")}}getAdjacentTiles(t,e=1,s=!1){return(s?ja:Mn).map(([n,r])=>this.getTile(t.getX()+n*e,t.getY()+r*e)).filter(n=>!!n)}setTile(t){this.setTileInternal(t)}setTiles(t){t.map(e=>this.setTileInternal(e))}setTileInternal(t){this.dirty=!0,this._version++;const e=this.map[t.getY()*this.width+t.getX()];return e.hasStaticEntity()&&!t.hasStaticEntity()?t.setStaticEntity(e.getStaticEntity()):e.hasStaticEntity()&&this.despawnStatic(e.getStaticEntity().getAgent()),t.sync(e),this.map[t.getY()*this.width+t.getX()]=t,this.changedTiles.add(e),e}processChangedTiles(){this.changedTiles.size&&(P.Instance.triggerEvent(M.SurfaceChange,{affectedTiles:this.changedTiles,addedStaticAgents:this.addedAgents,removedStaticAgents:this.removedAgents}),this.changedTiles.clear(),this.addedAgents.clear(),this.removedAgents.clear())}getRow(t){const e=t*this.width;return this.map.slice(e,e+this.width)}getColumn(t){const e=new Array(this.height);for(let s=0;s<this.height;s++)e[s]=this.getTile(t,s);return e}getWidth(){return this.width}getHeight(){return this.height}forLine(t,e,s,n,r,o){const c=(o==null?void 0:o.scale)??1;t=Math.floor(t/c)*c,e=Math.floor(e/c)*c,s=Math.floor(s/c)*c,n=Math.floor(n/c)*c;const l=Math.atan2(n-e,s-t);return this.forRay(t,e,l,(g,p)=>!(r(g,p)===!1)&&!(g.getX()===s&&g.getY()===n),o)}forRay(t,e,s,n,r){const o=(r==null?void 0:r.connected)??!1,c=(r==null?void 0:r.scale)??1,l=Math.cos(s),g=Math.sin(s),p=Math.abs(l)+Math.abs(g);let d=Math.abs(l/p),v=Math.abs(g/p),w=(1+(d>v?v/d:d/v))*c;d*=w*Math.sign(l),v*=w*Math.sign(g);let I,Y,D=0;for(;;){let O=!1;const E=Math.round(t/c)*c;let C=Math.round(e/c)*c;o&&I!==void 0&&Math.round(I/c)*c!==E&&Math.round(Y/c)*c!==C&&(C=Math.round(Y),O=!0);const W=this.getTile(E,C);if(!W||!n(W,D))break;O||(t+=d,e+=v),I=E,Y=C,D++}}forRect(t,e,s,n,r,o){const c=(o==null?void 0:o.scale)??1;t=Math.floor(t/c)*c,e=Math.floor(e/c)*c,s=Math.floor(s/c)*c,n=Math.floor(n/c)*c;const l=(p,d)=>{const v=this.getTile(p,d);v&&r(v)},g=p=>{if(s>t)for(let d=t;d<=s;d+=c)l(d,p);else for(let d=t;d>=s;d-=c)l(d,p)};if(n>e)for(let p=e;p<=n;p+=c)g(p);else for(let p=e;p>=n;p-=c)g(p)}forCircle(t,e,s,n,r){const o=(r==null?void 0:r.edgeOnly)??!1,c=(r==null?void 0:r.scale)??1;t=Math.floor(t/c),e=Math.floor(e/c);let l=s/2;const g=l*l,p=(l-1)*(l-1),d=(v,w,I=0)=>{const Y=v+I,D=w+I,O=Y*Y+D*D;if(O<g&&!(o&&O<p)){const E=this.getTile((t+v)*c,(e+w)*c,o);E&&n(E)}};if(s%2===0)for(let v=-l;v<l;v+=1)for(let w=-l;w<l;w+=1)d(w,v,.5);else{l=l|0;for(let v=-l;v<l+1;v+=1)for(let w=-l;w<l+1;w+=1)d(w,v)}}spawn(t){this.entities.push(t.entity),this.entitiesMap.get(t.category).add(t.entity),t.tick?this.tickingEntities.push(t.entity):this.dirty=!0,t.spawn&&t.spawn()}spawnStatic(t){this.getEntityTiles(t).forEach(s=>{s.setStaticEntity(t.entity),this.changedTiles.add(s)}),this.addedAgents.add(t),this.spawn(t),this.dirty=!0,Fi(t)&&Ga(t)>1&&this.towers.add(t)}despawn(t){const e=this.entities.indexOf(t.entity);e>=0&&(this.entities.splice(e,1),t.tick&&this.tickingEntities.splice(this.tickingEntities.indexOf(t.entity),1));const s=this.entitiesMap.get(t.category).delete(t.entity);return this.deletedEntities.push(t.entity),t.despawn&&t.despawn(),s}despawnStatic(t){this.getEntityTiles(t).forEach(s=>{s.clearStaticEntity(),this.changedTiles.add(s)}),this.removedAgents.add(t),this.despawn(t),this.dirty=!0,Fi(t)&&this.towers.delete(t)}getEntities(){return this.entities}getTickingEntities(){return this.tickingEntities}getEntitiesForCategory(t){return this.entitiesMap.get(t)}getDeletedEntities(){return this.deletedEntities}getTowers(){return this.towers}getTiles(){return this.map}markPristine(){this.dirty=!1,this.deletedEntities=[]}forceRerender(){this.dirty=!0}isDirty(){return this.dirty}get version(){return this._version}}const Se=(i,t)=>{const e=[],s=At(i),n=s===2?1:0;u.Instance.getSurface().forCircle(i.getTile().getX()+n,i.getTile().getY()+n,t*s,r=>{var o;if(ps.has(r.getBaseType())){const c=(o=r.getStaticEntity())==null?void 0:o.getAgent();c&&c.category!==k.Player&&(u.Instance.getSurface().despawnStatic(c),c.getType()===h.Tree&&(c.renderData.chopped=!0));const l=new J(r.getX(),r.getY(),f.Stone);e.push(l)}}),u.Instance.getSurface().setTiles(e)};class In{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"renderData",{});this.tile=t,this.entity=new z(t.getX(),t.getY(),this)}spawn(){u.Instance.getBase().addPart(this),Se(this,3)}despawn(){u.Instance.getBase().removePart(this)}getType(){return h.Armory}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){u.Instance.getBase().hit(t)}isVisible(){return!0}}a(In,"scale",2);const qa=.625;class Gs{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"isEnabled",!0);a(this,"renderData",{});this.tile=t,this.entity=new z(t.getX(),t.getY(),this),t.addTower(this)}getCooldown(){return this.isEnabled?0:1}fire(t,e){if(!u.Instance.consumeContinuous(this,e))return 0;const s=qa*e;return t.AI.hit(s),s}despawn(){this.tile.removeTower(this)}getType(){return h.ElectricFence}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.isEnabled=!1}isVisible(){return!0}isSpeedBoosted(){return!1}isDamageBoosted(){return!1}}a(Gs,"scale",1),a(Gs,"range",1);class bn{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"renderData",{});this.tile=t,this.entity=new z(t.getX(),t.getY(),this)}getType(){return h.Fence}getTile(){return this.tile}updateTile(t){this.tile=t}isVisible(){return!0}}a(bn,"scale",1);class xn{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"renderData",{});a(this,"originalTileTypes",[]);this.tile=t,this.entity=new z(t.getX(),t.getY(),this);const e=[];u.Instance.getSurface().getEntityTiles(this).forEach(s=>{e.push(new J(s.getX(),s.getY(),f.Freezer)),this.originalTileTypes.push(s.getAltType())}),u.Instance.getSurface().setTiles(e)}despawn(){const t=u.Instance.getSurface().getEntityTiles(this).map((e,s)=>new J(e.getX(),e.getY(),this.originalTileTypes[s]));u.Instance.getSurface().setTiles(t)}getType(){return h.Freezer}getTile(){return this.tile}updateTile(t){this.tile=t}isVisible(){return!0}}a(xn,"scale",2);class Tn{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"renderData",{});this.tile=t,this.entity=new z(t.getX(),t.getY(),this)}spawn(){u.Instance.getBase().addPart(this),Se(this,3)}despawn(){u.Instance.getBase().removePart(this)}getType(){return h.Market}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){u.Instance.getBase().hit(t)}isVisible(){return!0}}a(Tn,"scale",2);class kn{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"renderData",{});this.tile=t,this.entity=new z(t.getX(),t.getY(),this)}getType(){return h.PowerPlant}getTile(){return this.tile}updateTile(t){this.tile=t}spawn(){u.Instance.getBase().addPart(this),Se(this,3)}despawn(){u.Instance.getBase().removePart(this)}hit(t){u.Instance.getBase().hit(t)}isVisible(){return!0}}a(kn,"scale",2);const Za=i=>"AI"in i;var b=(i=>(i[i.Normal=0]="Normal",i[i.OnFire=1]="OnFire",i[i.Stunned=2]="Stunned",i))(b||{});class Ja{constructor(t){a(this,"isBlocking",!0);this.index=t}isCleared(t,e){const s=t[this.index];return e.getScale()===1?!s.hasStaticEntity()||!Wt.has(s.getStaticEntity().getAgent().getType()):!u.Instance.getSurface().getEntityTiles(s.getX(),s.getY(),e.getScale()).some(n=>n.hasStaticEntity()&&Wt.has(n.getStaticEntity().getAgent().getType()))}process(t,e,s){if(e.getScale()===1){e.AI.attack(t[this.index].getStaticEntity().getAgent());return}const n=u.Instance.getSurface().getEntityTiles(t[this.index].getX(),t[this.index].getY(),e.getScale());for(let r of n)if(!(!r.hasStaticEntity()||!Wt.has(r.getStaticEntity().getAgent().getType()))){e.AI.attack(r.getStaticEntity().getAgent());return}}}const Ee=(i=1,t=Wt)=>e=>{const s=u.Instance.getSurface(),n=[];for(let r=0;r<e.length;r++){const o=s.getEntityTiles(e[r].getX(),e[r].getY(),i);for(let c of o)if(c.hasStaticEntity()&&t.has(c.getStaticEntity().getAgent().getType())){n.push(new Ja(r));break}}return n},Ke=(i,t)=>({...i,...t}),Me={[f.Grass]:3,[f.Water]:20,[f.Stone]:4,[f.Wall]:3,[f.Spore]:2,[f.ElectricFence]:5,[f.Fence]:20,[f.Freezer]:6,[f.Obstructed]:3,[f.Bridge]:5,[f.Dirt]:2.5,[f.Sand]:3.5,[f.Snow]:3.5,[f.Ice]:10,[f.PlayerBuilding]:3,[f.Tree]:5,[f.Rock]:5,[f.Base]:Number.EPSILON},Ie={[f.Fence]:5,[f.ElectricFence]:40,[f.Wall]:500,[f.Freezer]:.5,[f.Obstructed]:500,[f.PlayerBuilding]:-10},Qa={[f.Grass]:3,[f.Water]:3,[f.Stone]:3,[f.Wall]:3,[f.Spore]:3,[f.ElectricFence]:3,[f.Fence]:3,[f.Freezer]:3,[f.Obstructed]:3,[f.Bridge]:3,[f.Dirt]:3,[f.Sand]:3,[f.Snow]:3,[f.Ice]:3,[f.PlayerBuilding]:3,[f.Tree]:3,[f.Rock]:3,[f.Base]:Number.EPSILON},tr={[f.Fence]:3,[f.ElectricFence]:3,[f.Wall]:5,[f.Tree]:4,[f.Rock]:3,[f.Obstructed]:5,[f.PlayerBuilding]:-10},Z=600;class be{constructor(t,e){a(this,"predictedHp");a(this,"cooldown",0);a(this,"visibilities",[]);a(this,"callback");this.enemy=t,this.hp=e,this.predictedHp=e;const s=u.Instance.getSurface();this.visibilities=t.getPath().getTiles().map(n=>t.getScale()===1?n.isDiscovered():s.getEntityTiles(n.getX(),n.getY(),t.getScale()).some(r=>r.isDiscovered()))}tick(t){if(this.cooldown<t&&this.callback&&(this.callback(),this.callback=void 0),this.cooldown=Math.max(0,this.cooldown-t),this.enemy.getPath().isPaused(this.enemy)&&!this.isBusy()){const e=this.enemy.getPath().getTile();this.enemy.entity.setX(e.getX()),this.enemy.entity.setY(e.getY());const s=this.enemy.getPath().getNextCheckpoint();s&&s.process(this.enemy.getPath().getTiles(),this.enemy,t)}if(this.isBusy())this.getTargeted(this.enemy.getPath().getCurrentTile(),t);else{this.isVisible()||this.enemy.getPath().fastForward(this.enemy);const{from:e,to:s,step:n}=this.enemy.getPath().performStep(this.enemy,t);this.enemy.entity.move(e,s,n),this.getTargeted(e,t)}}attack(t){t.hit&&this.cooldown===0&&(this.callback=()=>{t.hit(this.enemy.getDamage()*u.Instance.getDamageMultiplier())},this.cooldown=this.isVisible()?Z:0)}interact(t,e=Z){this.callback=t,this.cooldown===0&&this.isVisible()&&(this.cooldown=e)}cancel(){this.cooldown=0,this.callback=void 0}getTargeted(t,e){if(this.predictedHp>0&&this.isVisible()){if(this.enemy.getScale()===1){for(let n of t.getAvailableTowers())if(this.predictedHp-=n.fire(this.enemy,e),this.predictedHp<=0)return;return}const s=u.Instance.getSurface().getEntityTiles(t.getX(),t.getY(),this.enemy.getScale());for(let n of s)for(let r of n.getAvailableTowers())if(this.predictedHp-=r.fire(this.enemy,e),this.predictedHp<=0)return}}hit(t){this.hp-=t,this.hp<this.predictedHp&&(this.predictedHp=this.hp),this.hp<=0&&u.Instance.despawnEnemy(this.enemy)}miss(t){this.predictedHp+=t}isAttacking(){return this.cooldown!==0}isBusy(){return this.isAttacking()||this.enemy.getStatus()===b.Stunned}getFuturePosition(t){const e=this.enemy.getPath().getFuturePosition(t),s=this.enemy.getPath().getCheckpoints();for(let n=0;n<s.length;n++){let r=s[n];if(r.index>e)return e;if(r.isBlocking)return r.index-1}return e}isVisible(){return this.visibilities[this.enemy.getPath().getIndex()|0]??!0}}const Pn=new Set(Wt);Pn.delete(h.Tree);const er=Ee(1,Pn),sr=3e3,ir=1e3,nr=.01,ar=.025,rr=30;var ft;let ue=(ft=class{constructor(t,e){a(this,"entity");a(this,"category",k.Enemy);a(this,"status",b.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new tt(t.getX(),t.getY(),this),this.ai=new be(this,rr)}initializePath(){this.path.setSpeed(ar),this.path.setCheckpoints(er(this.path.getTiles()))}get AI(){return this.ai}getDamage(){return 4}getType(){return ft.type}getScale(){return ft.scale}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status!==b.Normal&&(this.statusDuration-=t,this.statusDuration<=0?this.status=b.Normal:this.status===b.OnFire&&this.ai.hit(nr*t)),this.ai.tick(t)}isVisible(){return this.ai.isVisible()}lightOnFire(){this.status=b.OnFire,this.statusDuration=sr}stun(){this.status=b.Stunned,this.statusDuration=ir}getOffsetX(){return this.entity.getX()}getOffsetY(){return this.entity.getY()}},a(ft,"pathCosts",Ke(Me,{[f.Tree]:3})),a(ft,"pathMultipliers",Ke(Ie,{[f.Water]:2})),a(ft,"type",h.Runner),a(ft,"cost",5),a(ft,"scale",1),ft);class Bt{constructor(t,e,s,n,r,o=[]){a(this,"index",0);a(this,"sectionIndex",0);a(this,"tileSet");this.pathfinder=t,this.tiles=e,this.sections=s,this.speed=n,this.costs=r,this.checkpoints=o,this.tileSet=new Set(e)}performStep(t,e){const s=this.index%1,n=this.index|0,r=this.tiles[n],o=this.speed*e/(this.costs[n]??1);let c=this.index+o|0;n===c&&c++,c>=this.tiles.length-1&&(c=this.tiles.length-1);const l=this.tiles[c];for(;this.checkpoints.length>0;){const p=this.checkpoints[0];if(p&&c>=p.index)if(p.isCleared(this.tiles,t))this.checkpoints.shift();else return this.index=p.index-1,{from:this.tiles[this.index],to:l,step:0};else break}const g=this.costs[c]??1;for(this.index=Math.min(this.index+this.speed*e/g,this.tiles.length-1);this.index>this.sections[this.sectionIndex].to;)this.sectionIndex++;return{from:r,to:l,step:s}}getFuturePosition(t){let e=this.index,s=this.sectionIndex;for(;t>0;){const n=this.sections[s],r=n.to-e,o=r/this.speed*n.cost;if(t>o?(e+=r,s++,t-=o):(e+=r*t/o,t=0),e>=this.tiles.length-1)return this.tiles.length-1}return e}fastForward(t){let e=this.checkpoints[0];for(let s=(this.index|0)+1;s<this.tiles.length;s++){if(e&&s>=e.index)if(e.isCleared(this.tiles,t))this.checkpoints.shift(),e=this.checkpoints[0];else break;if(this.getTile(s).isDiscovered())break;this.index=s}}clone(){return new Bt(this.pathfinder,this.tiles,this.sections,this.speed,this.costs,[...this.checkpoints])}slice(t=0,e=Number.MAX_VALUE){const s=this.tiles.slice(t,e),n=this.costs.slice(t,e),r=Bt.calculateSections(s,n),o=this.checkpoints.filter(c=>c.index>=t&&c.index<e);return new Bt(this.pathfinder,s,r,this.speed,n,o)}setIndex(t){this.index=Math.max(Math.min(t,this.tiles.length-1),0),this.sectionIndex=this.sections.findIndex(({from:e,to:s})=>this.index>=e&&this.index<s)}getIndex(){return this.index}getTile(t=this.index){return this.tiles[t|0]}getTiles(){return this.tiles}getLength(){return this.tiles.length}getCoordinates(t=this.index){if(t>=this.tiles.length-1){const r=this.tiles[this.tiles.length-1];return{x:r.getX(),y:r.getY()}}const e=t%1,s=this.tiles[t|0],n=this.tiles[(t|0)+1];return{x:(n.getX()-s.getX())*e+s.getX(),y:(n.getY()-s.getY())*e+s.getY()}}getSpeed(){return this.speed}setSpeed(t){this.speed=t}isDone(){return this.index===this.tiles.length-1}isPaused(t){if(this.isDone())return!0;const e=this.getNextCheckpoint();return e&&e.index===this.index+1&&!e.isCleared(this.tiles,t)}getNextCheckpoint(){return this.checkpoints[0]||null}getCheckpoints(){return this.checkpoints}setCheckpoints(t){this.checkpoints=t}getCurrentTile(){return this.tiles[this.index|0]}recompute(){const t=this.pathfinder.getSurface();let e;for(let s=0;s<this.tiles.length;s++){const n=this.tiles[s],r=t.getTile(n.getX(),n.getY());this.tiles[s]=r,this.costs[s]=this.pathfinder.getCost(r,e)??1,e=r,n!==r&&(this.tileSet.delete(n),this.tileSet.add(r))}this.sections=Bt.calculateSections(this.tiles,this.costs)}isAffectedByTiles(t){for(let e of t)if(this.tileSet.has(e))return!0;return!1}static calculateSections(t,e){return t.reduce((s,n,r)=>{const o=s[s.length-1],c=e[r];return o?(o.cost===c?o.to++:s.push({from:r,to:r+1,cost:c}),s):[{from:r,to:r+1,cost:c}]},[])}static fromTiles(t,e,s=1){const n=new Bt(t,e,[],s,[]);return n.recompute(),n}static fromMapAndCosts(t,e,s,n,r=1){let o=s;const c=[o];for(;o!==e;)o=n.get(o.getHash()),c.push(o);return this.fromTiles(t,c.reverse(),r)}}function or(){return new Worker("/open-td/assets/worker-b75c2413.js")}class hr{constructor(t,e,s){a(this,"paths");a(this,"promise");a(this,"worker");this.pathfinder=t,this.startPoints=e,this.target=s}getPaths(){return this.paths?this.paths:(this.promise||this.createPromise(),[])}getAsyncPaths(){return this.promise||this.createPromise(),this.promise}getPathsSync(){if(!this.paths){const t=this.startPoints.map(s=>this.pathfinder.getSurface().getTile(s.getX(),s.getY())),e=this.pathfinder.getSurface().getTile(this.target.getX(),this.target.getY());this.paths=this.pathfinder.getHivePath(t,e).filter(s=>!!s)}return this.promise=Promise.resolve(this.paths),this.paths}createPromise(){this.promise=new Promise(t=>{const e=this.pathfinder.getSurface(),{width:s,height:n,buffer:r}=e.serialize(),o={width:s,height:n,buffer:r.buffer,costs:this.pathfinder.costs,costMultiplier:this.pathfinder.costMultipliers,scale:this.pathfinder.scale,startPoints:this.startPoints.map(c=>c.serialize()),target:this.target.serialize()};this.worker=new or,this.worker.postMessage(o,[o.buffer]),this.worker.onmessage=({data:c})=>{this.paths=c.map(l=>Bt.fromTiles(this.pathfinder,l.map(({x:g,y:p})=>e.getTile(g,p)))),this.worker&&(this.worker.terminate(),this.worker=void 0),t(this.paths)}})}update(){this.paths=void 0,this.promise=void 0,this.worker&&(this.worker.terminate(),this.worker=void 0)}}const cr=[[0,-1],[-1,0],[1,0],[0,1],[-1,-1],[1,-1],[-1,1],[1,1]],lr=150;class ur{constructor(t,e=Ie,s=Me,n=1){a(this,"neighbors");a(this,"computedCosts");a(this,"computedMultipliers");a(this,"scaledWidth");a(this,"scaledHeight");a(this,"computedVersion",-1);this.surface=t,this.costMultipliers=e,this.costs=s,this.scale=n,this.neighbors=cr.map(([r,o])=>[r*n,o*n])}getPath(t,e,s){this.computedVersion!==this.surface.version&&this.computeCosts(),t=this.surface.getTile(Math.floor(t.getX()/this.scale)*this.scale,Math.floor(t.getY()/this.scale)*this.scale),e=this.surface.getTile(Math.floor(e.getX()/this.scale)*this.scale,Math.floor(e.getY()/this.scale)*this.scale);const n=s?w=>s(this.computedMultipliers[this.getIndex(w)],w):w=>this.computedMultipliers[this.getIndex(w)],r=new Set,c=(this.computedCosts[this.getIndex(t)]??1)*n(t),l=new Map;l.set(t.getHash(),c);const g=new Map;g.set(t.getHash(),c);const p=new Map;p.set(t.getHash(),c+this.heuristic(t,e));const d=new Ia((w,I)=>(p.get(w.getHash())??1/0)-(p.get(I.getHash())??1/0));d.push(t);const v=new Map;for(;!d.empty();){let w=d.pop();if(e===w)return Bt.fromMapAndCosts(this,t,e,v);const I=w.getHash(),Y=this.neighbors.map(([O,E])=>this.surface.getTile(O+w.getX(),E+w.getY())),D=[];this.setCostAndMultiplier(0,D,n,Y[0]),this.setCostAndMultiplier(1,D,n,Y[1]),this.setCostAndMultiplier(2,D,n,Y[2]),this.setCostAndMultiplier(3,D,n,Y[3]),this.setDiagonalCostAndMultiplier(4,0,1,D,n,Y[4]),this.setDiagonalCostAndMultiplier(5,0,2,D,n,Y[5]),this.setDiagonalCostAndMultiplier(6,1,3,D,n,Y[6]),this.setDiagonalCostAndMultiplier(7,2,3,D,n,Y[7]),Y.forEach((O,E)=>{if(!O)return;const C=D[E*2];if(!C||r.has(O))return;const W=O.getHash(),nt=g.get(I)+D[E*2+1];if(nt<(g.get(W)??1/0)){const Ft=l.get(I)+C;l.set(W,Ft),v.set(W,w),g.set(W,nt),p.set(W,nt+this.heuristic(O,e)),d.push(O),r.add(w)}})}}getHivePath(t,e){const s={},n=(r,o)=>(s[o.getHash()]??1)*r;return t.reduce((r,o,c)=>{const l=this.getPath(o,e,n);return r.push(l),l&&t.length>c-1&&l.getTiles().forEach(g=>{g.hasStaticEntity()&&(s[g.getHash()]=.85),s[g.getHash()]=s[g.getHash()]+.1||1.1}),r},[])}getCost(t,e){this.computedVersion!==this.surface.version&&this.computeCosts();const s=this.computedCosts[this.getIndex(t)];if(!e)return s;const n=this.computedCosts[this.getIndex(e)];if(!s||!n)return null;const r=(s+n)/2;return!s||!n||t.getX()===e.getX()||t.getY()==e.getY()?r:r+(this.computedCosts[(e.getY()/this.scale|0)*this.scaledWidth+(t.getX()/this.scale|0)]+this.computedCosts[(t.getY()/this.scale|0)*this.scaledWidth+(e.getX()/this.scale|0)])/4}getSurface(){return this.surface}heuristic(t,e){return Math.abs(t.getX()-e.getX())+Math.abs(t.getY()-e.getY())}setCostAndMultiplier(t,e,s,n){if(!n)return;const r=this.computedCosts[this.getIndex(n)];r&&(e[t*2]=r,e[t*2+1]=r*s(n))}setDiagonalCostAndMultiplier(t,e,s,n,r,o){if(!o||!n[e*2]||!n[s*2])return;const c=n[e*2+1]+n[s*2+1];if(c>lr)return;const l=this.computedCosts[this.getIndex(o)];l&&(n[t*2]=l+(n[e*2]+n[s*2])/4,n[t*2+1]=l*r(o)+c/4)}computeCosts(){this.computedVersion=this.surface.version;const t=this.scale**2;this.scaledWidth=Math.floor(this.surface.getWidth()/this.scale),this.scaledHeight=Math.floor(this.surface.getHeight()/this.scale);const e=this.scaledWidth*this.scaledHeight;this.computedCosts=new Array(e),this.computedMultipliers=new Array(e);for(let s=0;s<this.scaledWidth;s++)for(let n=0;n<this.scaledHeight;n++){const r=this.surface.getEntityTiles(s*this.scale,n*this.scale,this.scale);let o=0,c=0;for(let g=0;g<r.length;g++){let p=r[g].getType();if(!this.costs[p]){o=null,c=t;break}o+=this.costs[p],c+=this.costMultipliers[p]??1}const l=n*this.scaledWidth+s;this.computedCosts[l]=o===null?null:o/t,this.computedMultipliers[l]=c/t}}getIndex(t){return(t.getY()/this.scale|0)*this.scaledWidth+(t.getX()/this.scale|0)}}const Ms=class{constructor(t,e,s){a(this,"index",0);a(this,"pathData",new Map);a(this,"strength",0);a(this,"unit",ue);a(this,"energy",25);a(this,"spawnInterval",200);a(this,"spawnDelay",0);a(this,"burstSize",Number.POSITIVE_INFINITY);a(this,"burstInterval",1e3);a(this,"burst",0);a(this,"timer",0);a(this,"centerX",0);a(this,"centerY",0);this.spawnPoints=t,this.target=e,this.surface=s,t.forEach(n=>{this.centerX+=n.getX(),this.centerY+=n.getY()}),this.centerX/=t.length,this.centerY/=t.length}setUnit(t){this.unit=t}getUnitType(){return this.unit.type}setParameters(t,e,s,n,r){this.energy=t,this.spawnInterval=e,this.spawnDelay=s,this.burstSize=n,this.burstInterval=r,this.burst=0,this.timer=e}getEnergy(){return this.energy}tick(t){if(!(this.energy===0||!this.isReady())){if(this.timer+=t,this.spawnDelay>0)if(this.timer>this.spawnDelay)this.timer-=this.spawnDelay,this.spawnDelay=0;else return;if(this.burst>=this.burstSize)if(this.timer>=this.burstInterval)this.timer-=this.burstInterval,this.burst=0;else return;if(this.timer>=this.spawnInterval){this.timer-=this.spawnInterval,this.energy=Math.max(0,this.energy-this.unit.cost),this.burst++;const e=this.getNextUnit();u.Instance.spawnEnemy(e)}}}getCenter(){return[this.centerX,this.centerY]}getPathData(t){return this.pathData.has(t)||this.pathData.set(t,new hr(new ur(this.surface,this.unit.pathMultipliers,this.unit.pathCosts,this.unit.scale),this.spawnPoints,this.target)),this.pathData.get(t)}isReady(){return!!this.getPathData(this.unit.type).getPaths().length}getSpawnPoints(){return this.getPathData(this.unit.type).getPaths()}getAsyncSpawnPoints(){return this.getPathData(this.unit.type).getAsyncPaths()}getNextSpawnPoint(){const t=this.getSpawnPoints(),e=t[this.index];return this.index=(this.index+1)%t.length,e}getNextUnit(){const t=this.getNextSpawnPoint().clone(),e=new this.unit(t.getTile(),t);return e.initializePath(),e}grow(){this.strength++}getStrength(){return this.strength}isExposed(){let t=0,e=0;return this.surface.forCircle(this.centerX,this.centerY,Ms.size,s=>{t++,s.getDiscoveryStatus()!==$.Undiscovered&&e++}),e/t}rePath(){this.pathData.forEach(t=>t.update())}static fromTiles(t,e,s){return new Ms(t,e,s)}};let Rt=Ms;a(Rt,"size",5);var K=(i=>(i.Easy="easy",i.Normal="normal",i.Hard="hard",i))(K||{});const Yi={easy:{label:"Easy",description:"Allows checking which tiles are covered by tower sight lines. Shows the approximate path enemies will take and undiscovered nests do not become stronger."},normal:{label:"Normal",description:"Allows checking which tiles are covered by tower sight lines. Enemies are a bit stronger and undiscovered nests slowly gain more strength."},hard:{label:"Hard",description:"Checking tower sight lines is no longer possible, enemies are stronger and undiscovered nests gain strength more quickly."}};class ne{constructor(t,e,s=[]){this.min=t,this.max=e,this.units=s}getRange(){return[this.min,this.max]}getCenter(){return(this.min+this.max)/2}getLength(){return this.max-this.min}getUnits(){return this.units}addUnit(t){this.units.includes(t)||this.units.push(t),this.units.sort((e,s)=>s-e)}equals(t){return this.min===t.min&&this.max===t.max}toString(){return`[${this.min}, ${this.max}]`}static forSpawnGroup(t){const[e,s]=t.getCenter(),n=u.Instance.getBase().getTile(),r=e-n.getX(),o=s-n.getY(),c=(Math.atan2(o,r)*180/Math.PI+360)%360;switch(u.Instance.getDifficulty()){case K.Easy:return new ne(Math.floor(c/15)*15,Math.floor(c/15)*15+15,[t.getUnitType()]);case K.Normal:return new ne(Math.floor(c/45)*45,Math.floor(c/45)*45+45,[t.getUnitType()]);case K.Hard:return new ne(Math.floor(c/120)*120,Math.floor(c/120)*120+120,[t.getUnitType()])}}static forSpawnGroups(t){const e=new Map;return t.filter(s=>!s.isExposed()).forEach(s=>{const n=ne.forSpawnGroup(s),r=e.get(n.toString());r?r.addUnit(s.getUnitType()):e.set(n.toString(),n)}),[...e.values()]}}const dr=(i,t)=>{const e=new Array(t).fill(0).map(Math.random),s=e.reduce((n,r)=>n+r);return e.map(n=>n/s*i)},ae=()=>{let i=1-Math.random(),t=Math.random(),e=Math.sqrt(-2*Math.log(i))*Math.cos(2*Math.PI*t);return e=e/10+.5,e>1||e<0?ae():e},gr=Ee(1,Je),pr=3e3,fr=1e3,mr=.01,yr=.006,wr=50;var mt;let vr=(mt=class{constructor(t,e){a(this,"entity");a(this,"category",k.Enemy);a(this,"status",b.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new tt(t.getX(),t.getY(),this),this.ai=new be(this,wr)}initializePath(){this.path.setSpeed(yr),this.path.setCheckpoints(gr(this.path.getTiles()))}get AI(){return this.ai}getDamage(){return 5}getType(){return mt.type}getScale(){return mt.scale}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status!==b.Normal&&(this.statusDuration-=t,this.statusDuration<=0?this.status=b.Normal:this.status===b.OnFire&&this.ai.hit(mr*t)),this.ai.tick(t)}isVisible(){return this.ai.isVisible()}lightOnFire(){this.status=b.OnFire,this.statusDuration=pr}stun(){this.status=b.Stunned,this.statusDuration=fr}getOffsetX(){return this.entity.getX()}getOffsetY(){return this.entity.getY()}},a(mt,"pathCosts",Qa),a(mt,"pathMultipliers",tr),a(mt,"type",h.Flier),a(mt,"cost",12),a(mt,"scale",1),mt);const xs=(i,...t)=>{const e=[];return t.filter(Boolean).forEach(s=>e.push(...s(i))),e.sort((s,n)=>s.index-n.index),e},js=(i,t)=>{if(i>Math.random())return t},We=new Set([f.Grass,f.Snow]);class $i{constructor(t){a(this,"isBlocking",!1);this.index=t}isCleared(t,e){return e.getScale()===1?!We.has(t[this.index-1].getType()):u.Instance.getSurface().getEntityTiles(t[this.index-1].getX(),t[this.index-1].getY(),e.getScale()).every(s=>!We.has(s.getType()))}process(t,e,s){const n=u.Instance.getSurface(),r=t[this.index-1],o=u.Instance.getSurface().getEntityTiles(r.getX(),r.getY(),e.getScale());for(let c of o)We.has(c.getType())&&n.setTile(new J(c.getX(),c.getY(),f.Dirt))}}const hi=(i=1)=>t=>{const e=[];if(i>1){const r=u.Instance.getSurface();return t.forEach((o,c)=>{r.getEntityTiles(o.getX(),o.getY(),i).some(g=>We.has(g.getBaseType()))&&e.push(new $i(c+1))}),e}const s=Math.random()*t.length/10,n=t.filter(r=>We.has(r.getBaseType()));for(let r=0;r<s&&n.length;r++){const o=n.splice(Math.floor(Math.random()*n.length),1)[0];e.push(new $i(t.indexOf(o)+1))}return e};class Xi{constructor(t){a(this,"isBlocking",!0);this.index=t}isCleared(t,e){return!this.getTiles(t[this.index],e).length}process(t,e,s){const n=u.Instance.getSurface(),r=t[this.index],o=this.getTiles(r,e);if(o.length>0){const c=o[0];e.entity.lookAt(c),e.AI.interact(()=>{n.getTile(c.getX(),c.getY()).getType()===f.Water&&n.setTile(new J(c.getX(),c.getY(),f.Bridge))})}}getTiles(t,e){const s=u.Instance.getSurface(),n=[];return t.getType()===f.Water&&n.push(t),e.entity.getAlignedX()!==t.getX()&&e.entity.getAlignedY()!==t.getY()&&[[e.entity.getAlignedX(),t.getY()],[t.getX(),e.entity.getAlignedY()]].forEach(([r,o])=>{const c=s.getTile(r,o);(c==null?void 0:c.getType())===f.Water&&n.push(c)}),n}}const Sr=i=>{const t=[];for(let e=0;e<i.length;e++)i[e].getType()===f.Water&&(t.push(new Xi(e)),e+1<i.length&&i[e+1].getType()!==f.Water&&t.push(new Xi(e+1)));return t},Er=Ee(),Mr=hi(),Ir=3e3,br=1e3,xr=.01,Tr=.01,kr=100;var yt;let Pr=(yt=class{constructor(t,e){a(this,"entity");a(this,"category",k.Enemy);a(this,"status",b.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new tt(t.getX(),t.getY(),this),this.ai=new be(this,kr)}initializePath(){this.path.setSpeed(Tr),this.path.setCheckpoints(xs(this.path.getTiles(),Er,js(.5,Mr),js(.1,Sr)))}get AI(){return this.ai}getDamage(){return 6}getType(){return yt.type}getScale(){return yt.scale}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status!==b.Normal&&(this.statusDuration-=t,this.statusDuration<=0?this.status=b.Normal:this.status===b.OnFire&&this.ai.hit(xr*t)),this.ai.tick(t)}isVisible(){return this.ai.isVisible()}lightOnFire(){this.status=b.OnFire,this.statusDuration=Ir}stun(){this.status=b.Stunned,this.statusDuration=br}getOffsetX(){return this.entity.getX()}getOffsetY(){return this.entity.getY()}},a(yt,"pathCosts",Me),a(yt,"pathMultipliers",Ie),a(yt,"type",h.Slime),a(yt,"cost",7),a(yt,"scale",1),yt);const _r=Ee(),Ar=hi(),Cr=3e3,Dr=1e3,Br=.01,Rr=.008,Or=200;var wt;let Lr=(wt=class{constructor(t,e){a(this,"entity");a(this,"category",k.Enemy);a(this,"status",b.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new tt(t.getX(),t.getY(),this),this.ai=new be(this,Or)}initializePath(){this.path.setSpeed(Rr),this.path.setCheckpoints(xs(this.path.getTiles(),_r,js(.5,Ar)))}get AI(){return this.ai}getDamage(){return 8}getType(){return wt.type}getScale(){return wt.scale}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status!==b.Normal&&(this.statusDuration-=t,this.statusDuration<=0?this.status=b.Normal:this.status===b.OnFire&&this.ai.hit(Br*t)),this.ai.tick(t)}isVisible(){return this.ai.isVisible()}lightOnFire(){this.status=b.OnFire,this.statusDuration=Cr}stun(){this.status=b.Stunned,this.statusDuration=Dr}getOffsetX(){return this.entity.getX()}getOffsetY(){return this.entity.getY()}},a(wt,"pathCosts",Me),a(wt,"pathMultipliers",Ie),a(wt,"type",h.Tank),a(wt,"cost",20),a(wt,"scale",1),wt);class Fr{constructor(t){a(this,"isBlocking",!1);this.index=t}isCleared(t,e){const s=t[this.index];return!u.Instance.getSurface().getEntityTiles(s.getX(),s.getY(),e.getScale()).some(n=>n.hasStaticEntity()&&n.getStaticEntity().getAgent().getType()===h.Tree)}process(t,e,s){const n=u.Instance.getSurface().getEntityTiles(t[this.index].getX(),t[this.index].getY(),2);for(let r of n)r.hasStaticEntity()&&r.getStaticEntity().getAgent().getType()===h.Tree&&r.getStaticEntity().getAgent().hit(100)}}const _n=i=>{const t=u.Instance.getSurface(),e=[];for(let s=0;s<i.length;s++){const n=t.getEntityTiles(i[s].getX(),i[s].getY(),2);for(let r of n)if(r.hasStaticEntity()&&r.getStaticEntity().getAgent().getType()===h.Tree){e.push(new Fr(s));break}}return e},An=new Set(Wt);An.delete(h.Tree);const Yr=Ee(2,An),$r=3e3,Xr=1500,Nr=.01,Ur=.01,Wr=350;var ct;let Hr=(ct=class{constructor(t,e){a(this,"entity");a(this,"category",k.Enemy);a(this,"status",b.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new tt(t.getX(),t.getY(),this),this.ai=new be(this,Wr)}initializePath(){this.path.setSpeed(Ur/ct.scale),this.path.setCheckpoints(xs(this.path.getTiles(),_n,Yr))}get AI(){return this.ai}getDamage(){return 10}getType(){return ct.type}getScale(){return ct.scale}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status!==b.Normal&&(this.statusDuration-=t,this.statusDuration<=0?this.status=b.Normal:this.status===b.OnFire&&this.ai.hit(Nr*t)),this.ai.tick(t)}isVisible(){return this.ai.isVisible()}lightOnFire(){this.status=b.OnFire,this.statusDuration=$r}stun(){this.status=b.Stunned,this.statusDuration=Xr}getOffsetX(){return this.entity.getX()+.5}getOffsetY(){return this.entity.getY()+.5}},a(ct,"pathCosts",Me),a(ct,"pathMultipliers",Ke(Ie,{[f.Water]:2})),a(ct,"type",h.Behemoth),a(ct,"cost",32),a(ct,"scale",2),ct);const Cn=new Set(Wt);Cn.delete(h.Tree);const zr=Ee(2,Cn),Vr=hi(2),Gr=3e3,jr=500,Kr=.01,qr=.005,Zr=1e3;var lt;let Jr=(lt=class{constructor(t,e){a(this,"entity");a(this,"category",k.Enemy);a(this,"status",b.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new tt(t.getX(),t.getY(),this),this.ai=new be(this,Zr)}initializePath(){this.path.setSpeed(qr/lt.scale),this.path.setCheckpoints(xs(this.path.getTiles(),_n,zr,Vr))}get AI(){return this.ai}getDamage(){return 1e3}getType(){return lt.type}getScale(){return lt.scale}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status!==b.Normal&&(this.statusDuration-=t,this.statusDuration<=0?this.status=b.Normal:this.status===b.OnFire&&this.ai.hit(Kr*t)),this.ai.tick(t)}isVisible(){return this.ai.isVisible()}lightOnFire(){this.status=b.OnFire,this.statusDuration=Gr}stun(){this.status=b.Stunned,this.statusDuration=jr}getOffsetX(){return this.entity.getX()+.5}getOffsetY(){return this.entity.getY()+.5}},a(lt,"pathCosts",Ke(Me,{[f.Fence]:1,[f.Freezer]:8})),a(lt,"pathMultipliers",Ke(Ie,{[f.Obstructed]:4,[f.Wall]:30,[f.Fence]:1,[f.Water]:5,[f.Freezer]:.375})),a(lt,"type",h.Bore),a(lt,"cost",300),a(lt,"scale",2),lt);const Qr=4e3,to=150,eo=550,so=500,io=3e3,no=3,ao=12,ro=1.1,oo={[K.Easy]:0,[K.Normal]:1.5*ue.cost,[K.Hard]:3*ue.cost},ho={[h.Runner]:.8,[h.Slime]:1,[h.Flier]:1,[h.Tank]:1.2,[h.Behemoth]:1.6,[h.Bore]:10};class He{constructor(t){this.spawnGroups=t}isDone(){return!this.spawnGroups.find(t=>t.getEnergy()>0)}getSpawnGroups(){return this.spawnGroups}tick(t){this.spawnGroups.forEach(e=>e.tick(t))}static fromSpawnGroups(t,e){const s=(1+t**2)*ue.cost,n=dr(s,e.length),r=oo[u.Instance.getDifficulty()];return e.forEach((o,c)=>{const l=n[c]*ro+r*o.getStrength(),g=c===0||Math.random()>.5?0:ae()*Qr,p=Math.random()>.5?ae()*ao+no:Number.POSITIVE_INFINITY;o.setParameters(l,(ae()*eo/Math.max(1,t/3)+to)*ho[o.getUnitType()],g,p,ae()*io+so)}),new He(e)}static getUnitForLevel(t){if(t===0)return ue;if(t!==1&&(t+1)%10===0)return Jr;const e=Math.random();return e<.2-t/200?ue:t>=3&&e<.3?vr:t>=8&&e<.6?Hr:Math.random()>Math.min(.7,.1+t/30)?Pr:Lr}}const wi=class{constructor(t,e){a(this,"spawnGroups",[]);a(this,"nextSpawnGroup");a(this,"initialNextSpawnGroup");a(this,"direction",Math.random()*Math.PI*2);a(this,"nextUnit");a(this,"wave");a(this,"timeSinceLastExpansion",0);a(this,"onSurfaceChange",({affectedTiles:t,removedStaticAgents:e})=>{const s=this.isWaveInProgress();this.spawnGroups.forEach(r=>{s?r.getSpawnPoints().forEach(o=>{o.isAffectedByTiles(t)&&o.recompute()}):(e.size>0||r.getSpawnPoints().find(c=>c.isAffectedByTiles(t)))&&r.rePath()});const n=this.getNextSpawnGroup();!s&&n&&(e.size>0||n.getSpawnPoints().find(o=>o.isAffectedByTiles(t)))&&n.rePath()});this.base=t,this.surface=e,wi.instance=this,P.Instance.addEventListener(M.SurfaceChange,this.onSurfaceChange)}tick(t){this.wave&&this.wave.tick(t)}startNewWave(){const t=u.Instance.getLevel();at.Instance.hasPendingAgents()&&(this.timeSinceLastExpansion=0),this.spawnGroups.forEach(n=>{n.grow(),n.rePath()});const e=[],s=this.getNextSpawnGroup();s&&e.push(s),s!==this.initialNextSpawnGroup&&e.push(this.initialNextSpawnGroup),e.forEach(n=>{this.timeSinceLastExpansion=0;const[r,o]=n.getCenter(),c=[];this.surface.forCircle(r,o,Rt.size,l=>{ps.has(l.getType())&&(c.push(new J(l.getX(),l.getY(),f.Spore)),l.hasStaticEntity()&&this.surface.despawnStatic(l.getStaticEntity().getAgent()))}),this.surface.setTiles(c),this.spawnGroups.push(n)}),this.cleanupSpawnGroups(fs.Radar),this.nextUnit=void 0,this.nextSpawnGroup=void 0,this.initialNextSpawnGroup=void 0,this.wave=He.fromSpawnGroups(t,t===9?[this.spawnGroups[0]]:[...this.spawnGroups])}processWave(){return this.isWaveInProgress()?!1:(this.timeSinceLastExpansion++,this.spawnGroups.forEach(t=>t.setUnit(He.getUnitForLevel(u.Instance.getLevel()))),!0)}cleanupSpawnGroups(t){for(let e=this.spawnGroups.length-1;e>=0;e--){const s=this.spawnGroups[e];s.isExposed()>0&&(this.spawnGroups.splice(e,1),at.Instance.uncoverSpawnGroup(s,t))}}getWave(){return this.wave}getSpawnGroups(){const t=this.spawnGroups.filter(e=>e.isExposed()===0);if(!this.isWaveInProgress()){const e=this.getNextSpawnGroup();e&&t.push(e)}return u.Instance.getLevel()===9+(this.isWaveInProgress()?1:0)?[t[0]]:t}getSpawnAlertRanges(){return ne.forSpawnGroups(this.getSpawnGroups())}isWaveInProgress(){return this.wave&&!this.wave.isDone()?!0:this.surface.getEntitiesForCategory(k.Enemy).size>0}shouldAddSpawnGroup(){if(this.initialNextSpawnGroup&&!this.initialNextSpawnGroup.isExposed())return!0;const t=Math.ceil(2**this.spawnGroups.length/3),e=at.Instance.hasPendingAgents()?0:this.timeSinceLastExpansion;return this.spawnGroups.filter(n=>n.isExposed()===0).length===0||e>=t}getNextSpawnGroup(){if(!this.shouldAddSpawnGroup())return;if(this.nextSpawnGroup&&!this.nextSpawnGroup.isExposed())return this.nextSpawnGroup;if(this.initialNextSpawnGroup&&!this.initialNextSpawnGroup.isExposed())return this.nextSpawnGroup=this.initialNextSpawnGroup,this.nextSpawnGroup;const t=u.Instance.getLevel();this.nextUnit||(this.nextUnit=He.getUnitForLevel(t)),this.direction+=(Math.random()>.5?1:-1)*Math.max(Math.PI/6*ae()*Math.min(Math.PI*2,t+1));let e=!1,s=3;for(let n=0;n<20&&(this.surface.forRay(this.base.getTile().getX(),this.base.getTile().getY(),this.direction,r=>r.getDiscoveryStatus()!==$.Undiscovered?(s=4+Math.min(u.Instance.getLevel()/2,Math.floor(Math.random()*6)),!0):(s--,s>0?!0:(Math.random()>.66?!ps.has(r.getType()):!oi.has(r.getType()))?!(u.Instance.getLevel()===0&&n<10):(this.nextSpawnGroup=Rt.fromTiles([r,r,r,r],this.base.getTile(),this.surface),this.nextSpawnGroup.setUnit(this.nextUnit),e=!0,!1))),!e);n++)this.direction+=Math.PI/10;return this.initialNextSpawnGroup||(this.initialNextSpawnGroup=this.nextSpawnGroup),this.nextSpawnGroup}static get Instance(){return this.instance}};let q=wi;a(q,"instance");const Rs=i=>i.getType()===h.Base,vi=class{constructor(t){a(this,"discoveredSpawnGroups",new Set);a(this,"agents",new Set);a(this,"edgeMap",new Map);a(this,"pendingAgents",new Set);a(this,"base");a(this,"pendingRadius",0);a(this,"discoveredEdge",!1);a(this,"minX");a(this,"minY");a(this,"maxX");a(this,"maxY");this.surface=t,vi.instance=this}registerAgent(t){this.agents.add(t);let e=$.Pending;Rs(t)?(this.base=t,e=$.Discovered):this.pendingAgents.add(t);const s=this.getVisibilityRange(t),n=this.getVisibilityEdge(t);this.edgeMap.set(t.entity.getId(),n),this.updateVisibility(...n,s,e)}removeAgent(t){if(!this.agents.has(t))return;Rs(t)&&(this.base=void 0);const e=this.getVisibilityRange(t),s=this.edgeMap.get(t.entity.getId());this.surface.forCircle(...s,e,n=>n.setDiscoveryStatus($.Undiscovered)),this.agents.delete(t),this.pendingAgents.delete(t),this.edgeMap.delete(t.entity.getId()),this.update()}commit(){this.pendingAgents.clear(),this.pendingRadius=0,this.update()}update(){this.minX=void 0,this.minY=void 0,this.maxX=void 0,this.maxY=void 0,this.agents.forEach(s=>{const n=this.getVisibilityRange(s),r=this.edgeMap.get(s.entity.getId());this.surface.forCircle(...r,n,o=>o.setDiscoveryStatus($.Undiscovered))}),this.pendingRadius>0&&this.base&&this.updateVisibility(...this.getVisibilityEdge(this.base),this.pendingRadius,$.Pending),this.agents.forEach(s=>{const n=this.pendingAgents.has(s)?$.Pending:$.Discovered,r=this.getVisibilityRange(s),o=this.getVisibilityEdge(s);this.edgeMap.set(s.entity.getId(),o),this.updateVisibility(...o,r,n)});const t=[],e=q.Instance.getSpawnGroups();this.discoveredSpawnGroups.forEach(s=>{if(s.isExposed()===0){t.push(s);return}const n=s.getCenter();this.updateVisibility(...n,5,$.Discovered)}),e.forEach(s=>{const[n,r]=s.getCenter();this.surface.forCircle(n,r,Rt.size,o=>{o.getDiscoveryStatus()!==$.Undiscovered&&o.setDiscoveryStatus($.Undiscovered)})}),t.forEach(s=>this.discoveredSpawnGroups.delete(s))}updateBaseRange(){if(!this.base)throw new Error("Updating base range without a base");this.pendingRadius=this.getVisibilityRange(this.base),this.updateVisibility(...this.getVisibilityEdge(this.base),this.pendingRadius,$.Pending)}getBBox(){return[[this.minX,this.minY],[this.maxX,this.maxY]]}hasPendingAgents(){return this.pendingAgents.size>0}uncoverSpawnGroup(t,e){const s=q.Instance.getSpawnGroups();this.discoveredSpawnGroups.add(t);const[n,r]=t.getCenter();this.updateVisibility(n,r,Rt.size,$.Discovered),s.forEach(o=>{const[c,l]=o.getCenter();this.surface.forCircle(c,l,Rt.size,g=>{g.getDiscoveryStatus()!==$.Undiscovered&&g.setDiscoveryStatus($.Undiscovered)})}),P.Instance.triggerEvent(M.Discover,{x:n,y:r,method:e})}isEdgeDiscovered(){return this.discoveredEdge}getVisibilityRange(t){switch(t.getType()){case h.Base:return 35+(u.Instance.getLevel()-(this.pendingRadius>0?1:0))*2;case h.Radar:return 21;default:throw new Error("Entity has no visibility defined")}}getVisibilityEdge(t){if(Rs(t)||!this.base)return[t.entity.getAlignedX(),t.entity.getAlignedY()];let e;const s=Math.atan2(t.entity.getAlignedY()-this.base.entity.getAlignedY(),t.entity.getAlignedX()-this.base.entity.getAlignedX());return this.surface.forRay(this.base.entity.getAlignedX(),this.base.entity.getAlignedY(),s,n=>n.getDiscoveryStatus()===$.Undiscovered?!1:(e=n,!0)),e?[e.getX(),e.getY()]:[t.entity.getAlignedX(),t.entity.getAlignedY()]}updateVisibility(t,e,s,n){(!this.minX||t-s/2<this.minX)&&(this.minX=t-s/2),(!this.minY||e-s/2<this.minY)&&(this.minY=e-s/2),(!this.maxX||t+s/2>this.maxX)&&(this.maxX=t+s/2),(!this.maxY||e+s/2>this.maxY)&&(this.maxY=e+s/2),this.surface.forCircle(t,e,s,r=>{n===$.Pending&&r.isDiscovered()||(n===$.Discovered&&r.getType()===f.Void&&(this.discoveredEdge=!0),r.setDiscoveryStatus(n))})}static get Instance(){return this.instance}};let cs=vi;a(cs,"instance");const at=cs;class Dn{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"renderData",{});this.tile=t,this.entity=new z(t.getX(),t.getY(),this)}getType(){return h.Radar}getTile(){return this.tile}updateTile(t){this.tile=t}spawn(){at.Instance.registerAgent(this),u.Instance.getBase().addPart(this),Se(this,3)}despawn(){at.Instance.removeAgent(this),u.Instance.getBase().removePart(this)}hit(t){u.Instance.getBase().hit(t)}isVisible(){return!0}}a(Dn,"scale",2);const co=new Set([f.Obstructed,f.Wall,f.PlayerBuilding,f.Base]),xe=i=>co.has(i.getType()),Ks=250;let lo=class{constructor(t){a(this,"entity");a(this,"category",k.Unknown);a(this,"time",0);a(this,"renderData",{});a(this,"sourceX");a(this,"sourceY");this.source=t;const[e,s]=xt(t);this.entity=new tt(e,s,this),this.sourceX=e,this.sourceY=s}dealDamage(t,e){this.renderData.update=!0,this.time>Ks&&u.Instance.getSurface().spawn(this),this.time=0;const s=Math.atan2(t.getOffsetX()+.5-this.sourceX,t.getOffsetY()+.5-this.sourceY);this.entity.setRotation(s*180/Math.PI),this.source.entity.setRotation(-this.entity.getRotation()+180),this.entity.setX(t.entity.getAlignedX()),this.entity.setY(t.entity.getAlignedY()),t.AI.hit(e),t.lightOnFire&&t.lightOnFire()}tick(t){this.time+=t,this.time>Ks&&u.Instance.getSurface().despawn(this)}getType(){return h.Flame}isVisible(){return!0}};const Ni=1,uo=.04,Si=class{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"flame");a(this,"hp",160);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});this.tile=t,this.entity=new z(t.getX(),t.getY(),this)}tick(t){this.isEnabled&&(this.cooldown=Math.max(0,this.cooldown-t))}fire(t,e){this.cooldown=Ni;const s=u.Instance.consumeContinuous(this,e,this.damageMultiplier*this.speedMultiplier),n=uo*(s?this.damageMultiplier*this.speedMultiplier:1)*e;return this.flame||(this.flame=new lo(this),u.Instance.getSurface().spawn(this.flame)),this.flame.dealDamage(t,n),this.renderData.fired=!0,n}spawn(){[this.cleanupEventListener]=ye(this,Si.range,xe)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=we(t),this.damageMultiplier=ve(t)}getCooldown(){return this.cooldown}getType(){return h.Flamethrower}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=Ni,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}};let _e=Si;a(_e,"scale",2),a(_e,"range",6);class ci{constructor(){a(this,"source");a(this,"target");a(this,"sourceX");a(this,"sourceY");a(this,"targetX");a(this,"targetY");a(this,"travelTime")}}function Bn(i,t=0){const[e,s]=xt(this.source);this.sourceX=e,this.sourceY=s;const n=e-this.target.getOffsetX()+.5,r=s-this.target.getOffsetY()+.5,o=Math.sqrt(n*n+r*r)+t;this.travelTime=o/i;const c=this.target.AI.getFuturePosition(this.travelTime),{x:l,y:g}=this.target.getPath().getCoordinates(c);this.targetX=l+this.target.getScale()/2,this.targetY=g+this.target.getScale()/2}function Rn(i,t){const e=i.getOffsetX()-this.entity.getX(),s=i.getOffsetY()-this.entity.getY();return e*e+s*s<=t}const On=(i,t)=>(i%t+t)%t,It=(i,t,e)=>i+(t-i)*e,go=(i,t,e)=>{if(i===t)return t;const s=On(t-i+180,360)-180;return s<0?(i-Math.min(-s,e)+360)%360:i+Math.min(s,e)},po=.01,Ui=5,Wi=2,fo=Wi*Wi;let mo=class extends ci{constructor(e,s,n){super();a(this,"entity");a(this,"category",k.Unknown);a(this,"renderData",{});a(this,"time",0);a(this,"prevX");a(this,"prevY");a(this,"straightY",0);this.source=e,this.target=s,this.damage=n,Bn.call(this,po,Ui*2),this.entity=new tt(this.sourceX,this.sourceY,this),this.entity.lookAt(this.targetX,this.targetY),this.source.entity.setRotation(this.entity.getRotation()),this.entity=new tt(this.sourceX,this.sourceY,this),this.entity.lookAt(this.targetX,this.targetY),this.source.entity.setRotation(this.entity.getRotation())}tick(e){if(this.time>=this.travelTime){u.Instance.getSurface().despawn(this);let r=!1;const o=[...u.Instance.getSurface().getEntitiesForCategory(k.Enemy)].filter(c=>Rn.call(this,c.getAgent(),fo));o.forEach(c=>{c.getAgent().AI.hit(this.damage),c.getAgent()===this.target&&(r=!0)}),o.length>qs.maxBombedEnemies&&(qs.maxBombedEnemies=o.length,P.Instance.triggerEvent(M.Bomb,{amount:o.length})),r||this.target.AI.miss(this.damage)}this.time=Math.min(this.time+e,this.travelTime);const s=this.time/this.travelTime,n=Math.sin(s*Math.PI)*Ui;if(this.straightY=It(this.sourceY,this.targetY,s),this.entity.setX(It(this.sourceX,this.targetX,s)),this.entity.setY(this.straightY-n),this.prevX&&this.prevY){const r=this.entity.getX()-this.prevX,o=this.entity.getY()-this.prevY;this.entity.setRotation(Math.atan2(o,r)*180/Math.PI+90)}this.prevX=this.entity.getX(),this.prevY=this.entity.getY()}getType(){return h.Rocket}isVisible(){return!0}getPercentage(){return this.time/this.travelTime}};const Hi=5e3,yo=50,Ei=class{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"hp",80);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});this.tile=t,this.entity=new z(t.getX(),t.getY(),this)}tick(t){!this.isEnabled||this.cooldown<=0||(this.cooldown-=t*this.speedMultiplier)}fire(t){if(this.cooldown+=Hi,!u.Instance.consume(this,this.speedMultiplier,this.damageMultiplier))return 0;const e=yo*this.damageMultiplier,s=new mo(this,t,e);return u.Instance.getSurface().spawn(s),this.renderData.fired=!0,e}spawn(){[this.cleanupEventListener]=ye(this,Ei.range)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=we(t),this.damageMultiplier=ve(t)}getCooldown(){return this.cooldown}getType(){return h.Mortar}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=Hi,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}};let Qt=Ei;a(Qt,"scale",2),a(Qt,"range",30),a(Qt,"maxBombedEnemies",0);const qs=Qt,wo=(i,t,e,s,n)=>{const r=Math.atan2(n-t,s-i);let o=On(r-e+Math.PI,Math.PI*2)-Math.PI;return Math.abs(o)>=Math.PI?Number.POSITIVE_INFINITY:Math.abs(Math.cos(e)*(t-n)-Math.sin(e)*(i-s))},qe=(i,t,e,s)=>(i-e)**2+(t-s)**2,li=1500;let vo=class{constructor(t,e,s){a(this,"entity");a(this,"category",k.Unknown);a(this,"renderData",{});a(this,"targetX");a(this,"targetY");a(this,"time",0);this.source=t,this.damage=s;const[n,r]=xt(t);this.entity=new tt(n,r,this);const o=Math.atan2(e.getOffsetY()+.5-this.entity.getY(),e.getOffsetX()+.5-this.entity.getX());this.entity.setRotation(o*180/Math.PI),this.source.entity.setRotation(this.entity.getRotation()+90),u.Instance.getSurface().forRay(e.entity.getX(),e.entity.getY(),o,g=>(this.targetX=g.getX(),this.targetY=g.getY(),!xe(g)));const c=qe(this.entity.getX(),this.entity.getY(),this.targetX,this.targetY),l=[...u.Instance.getSurface().getEntitiesForCategory(k.Enemy)].filter(g=>qe(this.entity.getX(),this.entity.getY(),g.getX()+.5,g.getY()+.5)<=c+1).filter(g=>wo(this.entity.getX(),this.entity.getY(),o,g.getX()+.5,g.getY()+.5)<=.5);l.forEach(g=>{g.getAgent().AI.hit(this.damage)}),l.length>Zs.maxPierceEnemies&&(Zs.maxPierceEnemies=l.length,P.Instance.triggerEvent(M.Pierce,{amount:l.length}))}tick(t){this.time+=t,this.time>li&&u.Instance.getSurface().despawn(this)}getType(){return h.Rail}isVisible(){return!0}};const zi=5e3,So=70,Mi=class{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"hp",80);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});this.tile=t,this.entity=new z(t.getX(),t.getY(),this)}tick(t){!this.isEnabled||this.cooldown<=0||(this.cooldown-=t*this.speedMultiplier)}fire(t){if(this.cooldown+=zi,!u.Instance.consume(this,this.speedMultiplier,this.damageMultiplier))return 0;const e=So*this.damageMultiplier,s=new vo(this,t,e);return u.Instance.getSurface().spawn(s),this.renderData.fired=!0,e}spawn(){[this.cleanupEventListener]=ye(this,Mi.range,xe)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=we(t),this.damageMultiplier=ve(t)}getCooldown(){return this.cooldown}getType(){return h.Railgun}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=zi,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}};let te=Mi;a(te,"scale",2),a(te,"range",30),a(te,"maxPierceEnemies",0);const Zs=te,Eo=.015;class Mo extends ci{constructor(e,s,n){super();a(this,"entity");a(this,"category",k.Unknown);a(this,"renderData",{});a(this,"time",0);this.source=e,this.target=s,this.damage=n,Bn.call(this,Eo),this.entity=new tt(this.sourceX,this.sourceY,this),this.entity.lookAt(this.targetX,this.targetY),this.source.entity.setRotation(this.entity.getRotation())}tick(e){this.time>=this.travelTime&&(u.Instance.getSurface().despawn(this),this.target.AI.hit(this.damage)),this.time=Math.min(this.time+e,this.travelTime);const s=this.time/this.travelTime;this.entity.setX(It(this.sourceX,this.targetX,s)),this.entity.setY(It(this.sourceY,this.targetY,s))}getType(){return h.Bullet}isVisible(){return!0}}const Vi=500,Io=10;var Ut;let bo=(Ut=class{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"hp",50);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});this.tile=t,this.entity=new z(t.getX(),t.getY(),this)}tick(t){!this.isEnabled||this.cooldown<=0||(this.cooldown-=t*this.speedMultiplier)}fire(t){this.cooldown+=Vi;const e=u.Instance.consume(this,this.speedMultiplier,this.damageMultiplier),s=Io*(e?this.damageMultiplier:1),n=new Mo(this,t,s);return u.Instance.getSurface().spawn(n),this.renderData.fired=!0,s}spawn(){[this.cleanupEventListener]=ye(this,Ut.range,xe)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=we(t),this.damageMultiplier=ve(t)}getCooldown(){return this.cooldown}getType(){return h.Tower}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=Vi,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}},a(Ut,"scale",2),a(Ut,"range",10),Ut);var Ns;let xo=(Ns=class{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"hp",50);a(this,"renderData",{});this.tile=t,this.entity=new z(t.getX(),t.getY(),this)}getType(){return h.Wall}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}},a(Ns,"scale",2),Ns);const ms=250;let To=class{constructor(t){a(this,"entity");a(this,"category",k.Unknown);a(this,"renderData",{});a(this,"time",0);a(this,"targetX",0);a(this,"targetY",0);this.source=t;const[e,s]=xt(t);this.entity=new tt(e,s,this)}dealDamage(t,e){this.time>ms&&u.Instance.getSurface().spawn(this),this.time=0,this.targetX=t.getOffsetX()+.5,this.targetY=t.getOffsetY()+.5;const s=Math.atan2(this.targetY-this.entity.getY(),this.targetX-this.entity.getX());this.entity.setRotation(s*180/Math.PI),this.source.entity.setRotation(this.entity.getRotation()+90),t.AI.hit(e),t.lightOnFire&&t.lightOnFire()}tick(t){this.time+=t,this.time>ms&&u.Instance.getSurface().despawn(this)}getType(){return h.LaserBeam}isVisible(){return!0}};const Gi=1,ko=.06,Po=500,Ii=class{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"laserBeam");a(this,"hp",80);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});a(this,"lastTarget");this.tile=t,this.entity=new z(t.getX(),t.getY(),this)}tick(t){!this.isEnabled||this.cooldown<=0||(!this.laserBeam&&this.lastTarget&&this.entity.lookAt(this.lastTarget.entity),this.cooldown=Math.max(0,this.cooldown-t))}fire(t,e){if(this.lastTarget!==t)return this.lastTarget=t,this.cooldown=Po,0;if(this.cooldown=Gi,!u.Instance.consumeContinuous(this,e,this.damageMultiplier*this.speedMultiplier))return 0;const s=ko*this.damageMultiplier*this.speedMultiplier*e;return this.laserBeam||(this.laserBeam=new To(this),u.Instance.getSurface().spawn(this.laserBeam)),this.laserBeam.dealDamage(t,s),this.renderData.fired=!0,s}spawn(){[this.cleanupEventListener]=ye(this,Ii.range,xe)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=we(t),this.damageMultiplier=ve(t)}getCooldown(){return this.cooldown}getType(){return h.Laser}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=Gi,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}};let Ae=Ii;a(Ae,"scale",2),a(Ae,"range",16);class Ln{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"renderData",{});this.tile=t,this.entity=new z(t.getX(),t.getY(),this)}spawn(){u.Instance.getBase().addPart(this),Se(this,3)}despawn(){u.Instance.getBase().removePart(this)}getType(){return h.Barracks}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){u.Instance.getBase().hit(t)}isVisible(){return!0}}a(Ln,"scale",2);const _o=.01,Js=800;let Ao=class extends ci{constructor(e,s,n){super();a(this,"entity");a(this,"category",k.Unknown);a(this,"renderData",{});a(this,"time",0);a(this,"sectionTime",0);a(this,"index",-1);this.source=e,this.chain=s;const[r,o]=xt(e);this.sourceX=r,this.sourceY=o,s.forEach(c=>{c.AI.hit(n),c.stun&&c.stun()}),this.entity=new tt(this.sourceX,this.sourceY,this),this.nextTarget()}nextTarget(){this.index++,this.index>=this.chain.length&&(this.entity.setX(this.sourceX),this.entity.setY(this.sourceY),this.index=0);const e=this.chain[this.index];this.targetX=e.getOffsetX(),this.targetY=e.getOffsetY(),this.travelTime=Math.sqrt(qe(this.entity.getX(),this.entity.getY(),this.targetX,this.targetY))/_o,this.sectionTime=0,this.entity.lookAt(this.targetX,this.targetY)}tick(e){this.time>=Js&&u.Instance.getSurface().despawn(this),this.time+=e,this.sectionTime+=e,this.sectionTime>this.travelTime&&this.nextTarget();const s=this.sectionTime/this.travelTime;this.entity.setX(It(this.sourceX,this.targetX,s)),this.entity.setY(It(this.sourceY,this.targetY,s))}getChain(){return this.chain}getType(){return h.Spark}isVisible(){return!0}};const Os=4e3,Co=700,Do=50,ze=class{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"coveredTiles");a(this,"hp",160);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});a(this,"charging",!1);this.tile=t,this.entity=new z(t.getX(),t.getY(),this)}tick(t){if(!(!this.isEnabled||this.cooldown<=0)&&(this.cooldown-=t*(this.charging?1:this.speedMultiplier),this.charging&&Os-this.cooldown>Co)){this.charging=!1;const e=u.Instance.getSurface(),s=[...u.Instance.getSurface().getEntitiesForCategory(k.Enemy)].filter(c=>this.coveredTiles.has(e.getTile(c.getAlignedX(),c.getAlignedY())));s.length>ze.maxStunnedEnemies&&(ze.maxStunnedEnemies=s.length,P.Instance.triggerEvent(M.Stun,{amount:s.length}));const n=new Map;s.forEach(c=>n.set(c.getId(),qe(c.getX(),c.getY(),...xt(this))));const r=[];s.sort((c,l)=>n.get(c.getId())-n.get(l.getId())).forEach(c=>{let l=n.get(c.getId()),g;r.forEach(p=>{const d=p[p.length-1],v=qe(c.getX(),c.getY(),d.getX(),d.getY());v<l&&(l=v,g=p)}),g?g.push(c):r.push([this.entity,c])});const o=Do*this.damageMultiplier;r.forEach(c=>{const l=new Ao(this,c.slice(1,c.length).map(g=>g.getAgent()),o);u.Instance.getSurface().spawn(l)})}}fire(){return this.cooldown+=Os,u.Instance.consume(this,this.speedMultiplier,this.damageMultiplier)&&(this.charging=!0,this.renderData.fired=!0),0}spawn(){[this.cleanupEventListener,this.coveredTiles]=ye(this,ze.range,xe)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=we(t),this.damageMultiplier=ve(t)}getCooldown(){return this.cooldown}getType(){return h.Tesla}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=Os,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}};let ee=ze;a(ee,"scale",2),a(ee,"range",8),a(ee,"maxStunnedEnemies",0);const Qs={[h.ElectricFence]:.05,[h.Laser]:.003,[h.Railgun]:5,[h.Tesla]:4,[h.Mortar]:2},oe=class{constructor(){a(this,"generators",new Set);a(this,"consumption",0);a(this,"blackout",!1);a(this,"power",0);oe.instance=this}registerGenerator(t){this.generators.add(t)}removeGenerator(t){this.generators.delete(t)}getProduction(){return u.Instance.getBase().getPartsCount(h.PowerPlant)*oe.powerMultiplier}getConsumption(){return this.consumption}consume(t){return t===0?!0:this.blackout?!1:(this.power-=t,this.power<0?(this.power=0,this.blackout=!0,P.Instance.triggerEvent(M.BlackOut),u.Instance.triggerStatUpdate(),!1):(this.consumption+=t,!0))}processPower(){this.power=this.power+this.getProduction(),this.blackout=!1,this.power<0&&P.Instance.triggerEvent(M.BlackOut),u.Instance.getIsStarted()||(this.consumption=0)}emergencyRegenerate(t=1){this.power=this.power+(oe.baseEmergencyRegenerate+u.Instance.getBase().getParts().size*oe.emergencyRegenerateMultiplier)*t,this.blackout=!1}getPower(){return this.power}static get Instance(){return this.instance}};let U=oe;a(U,"speedBeaconConsumption",1.1),a(U,"damageBeaconConsumption",1.2),a(U,"instance"),a(U,"powerMultiplier",5),a(U,"baseEmergencyRegenerate",30),a(U,"emergencyRegenerateMultiplier",2);const Bo=.002;class Ro{constructor(t,e,s){a(this,"entity");a(this,"category",k.Unknown);a(this,"renderData",{});a(this,"time",0);a(this,"travelTime");this.tile=t,this.target=e,this.damage=s,this.entity=new tt(t.getX()+.5,t.getY()+.5,this);const n=t.getX()-e.getX(),r=t.getY()-e.getY(),o=Math.sqrt(n*n+r*r);this.travelTime=o/Bo,this.time=this.travelTime/4,this.entity.lookAt(e)}tick(t){this.time>=this.travelTime&&(u.Instance.getSurface().despawn(this),[...u.Instance.getSurface().getEntitiesForCategory(k.Enemy)].filter(s=>Rn.call(this,s.getAgent(),1)).forEach(s=>{s.getAgent().AI.hit(this.damage)})),this.time=Math.min(this.time+t,this.travelTime);const e=this.time/this.travelTime;this.entity.setX(It(this.tile.getX(),this.target.getX(),e)+.5),this.entity.setY(It(this.tile.getY(),this.target.getY(),e)+.5)}getType(){return h.Shockwave}getTile(){return this.tile}isVisible(){return!0}}const Oo=1e3,Lo=200,Fo=[[0,0],[1,0],[1,1],[0,1]],Yo=[[[-1,0],[-1,-1],[0,-1]],[[0,-1],[1,-1],[1,0]],[[1,0],[1,1],[0,1]],[[0,1],[-1,1],[-1,0]]];var os;let ui=(os=class{constructor(t){a(this,"entity");a(this,"category",k.Player);a(this,"hp",30);a(this,"invincibleTime",0);a(this,"renderData",{});a(this,"baseParts",new Set);a(this,"basePartsByType",new Map);this.tile=t,this.entity=new z(t.getX(),t.getY(),this),this.baseParts.add(this)}tick(t){this.invincibleTime=Math.max(0,this.invincibleTime-t)}getType(){return h.Base}getTile(){return this.tile}updateTile(t){this.tile=t}getHp(){return this.hp}spawn(){at.Instance.registerAgent(this),Se(this,4)}despawn(){at.Instance.removeAgent(this)}hit(t){this.invincibleTime>0||this.hp<=0||(this.hp-=t,this.hp<=0?(u.Instance.showMessage("You lose!",{closable:!1,expires:0}),u.Instance.getSurface().forceRerender(),P.Instance.triggerEvent(M.Lose)):(this.invincibleTime=Oo,this.shockwave()),u.Instance.triggerStatUpdate(),P.Instance.triggerEvent(M.HitBase))}regenerate(t=1){this.hp+=this.getRegenerationFactor()*t}isVisible(){return!0}isDestroyed(){return this.hp<=0}addPart(t){this.baseParts.add(t),this.basePartsByType.set(t.getType(),(this.basePartsByType.get(t.getType())??0)+1)}removePart(t){this.baseParts.delete(t),this.basePartsByType.set(t.getType(),this.basePartsByType.get(t.getType())-1)}getParts(){return this.baseParts}getPartsCount(t){return this.basePartsByType.get(t)??0}getRegenerationFactor(){const t=this.getPartsCount(h.Armory),e=this.getPartsCount(h.Barracks);return t*50/(t+25)+e*50/(e+25)}getMoneyFactor(){const t=this.getPartsCount(h.Market);return 1+t*2.5/(t+25)}shockwave(){const t=u.Instance.getSurface(),e=new Map;this.baseParts.forEach(s=>{Fo.forEach(([n,r],o)=>{const c=t.getTile(s.getTile().getX()+n,s.getTile().getY()+r);Yo[o].forEach(([l,g])=>{const p=t.getTile(s.getTile().getX()+n+l,s.getTile().getY()+r+g);p&&!e.has(p.getHash())&&Ha.has(p.getType())&&e.set(p.getHash(),[c,p])})})}),e.forEach(([s,n])=>{const r=new Ro(s,n,Lo);t.spawn(r)})}},a(os,"scale",2),a(os,"baseEmergencyRepair",15),os);const Fn={name:"Fence",description:"A simple fence that land-based enemies have to walk around. If the fence becomes too long however, they will climb over it. Fences are low to towers can shoot over them.",entity:bn,entityType:h.Fence,htmlElement:"🥅"},Yn={name:"Wall",description:"A large solid wall that land-based enemies have to walk around. A wall is equivalent to a tower that does not shoot meaning enemies will avoid them but will destroy them if left with no other option.",entity:xo,entityType:h.Wall,htmlElement:"🚧"},$o={name:"Electric fence",description:"Electric fences are similar to their normal counterpart but enemies are far less likely to climb over them. If they do they will also continuously receive damage, given that you have enough power stored.",entity:Gs,entityType:h.ElectricFence,htmlElement:"⚡"},$n={name:"Tar",description:"A large area of sticky goo that slows down land-based enemies that walk over it. The area does not repel or attract enemies so they still have to be guided to walk over it.",entity:xn,entityType:h.Freezer,htmlElement:"🦠"},di={name:"Tower",description:"The cheapest and most basic tower. It has poor range and deals little damage.",entity:bo,entityType:h.Tower,htmlElement:"🗼"},Xn={name:"Mortar",description:"A powerful tower with a large range that can shoot over obstacles. It also deals splash damage, hurting all enemies near the impact. Reload speed and travel time of the projectile is slow though.",entity:qs,entityType:h.Mortar,htmlElement:"🛰️"},Nn={name:"Flamethrower",description:"A turret intended for close range combat. It continuously hurts a single enemy within range. Enemies that were lit on fire will also keep burning for a while.",entity:_e,entityType:h.Flamethrower,htmlElement:"🧯"},Un={name:"Railgun",description:"A powerful tower with a large range that can pierce enemies. It shoots relatively fast and deals massive damage to an enemy and all enemies behind it at the cost of consuming power.",entity:Zs,entityType:h.Railgun,htmlElement:"🌡️"},de={name:"Sell",description:"Sell parts or blueprints. Blueprints and parts placed before the start of a wave are fully refunded. Other parts give back half their original cost when sold, but this can be improved by placing markets.",entityType:h.None,htmlElement:"❌"},Wn={name:"Radar",description:"A part of your base that exposes a large area in the direction that it was placed in. Exposed enemy bases are immediately neutralized when exposed by a radar.",entity:Dn,entityType:h.Radar,htmlElement:"📡",isBasePart:!0},Hn={name:"Power plant",description:"A part of your base that generates an amount power at the start of every wave. Power can be stored across waves and is consumed by various towers. More power plants will generate more power but there are diminishing returns.",entity:kn,entityType:h.PowerPlant,htmlElement:"🏭",isBasePart:!0},Xo={name:"Armory",description:"A part of your base that regenerates hit points at the end of every wave. More armories will regenerate more hit points but there are diminishing returns.",entity:In,entityType:h.Armory,htmlElement:"🏰",isBasePart:!0},zn={name:"Barracks",description:"A part of your base mainly intended for being able to place more turrets. It also regenerates a bit of hit points at the end of every wave. More barracks will regenerate more hit points but there are diminishing returns.",entity:Ln,entityType:h.Barracks,htmlElement:"🏰",isBasePart:!0},Vn={name:"Market",description:"A part of your base that increases the amount of money you get per wave and increases the percentage you get back when selling a part. More markets will increase the multiplier but there are diminishing returns.",entity:Tn,entityType:h.Market,htmlElement:"🏪",isBasePart:!0},Gn={name:"Speed Beacon",description:"A building that increases the reload speed of cardinally adjacent towers at the cost of some power for every shot fired. If there is no power (left) the towers will continue working as normal without a speed boost. Keep in mind that the beacon also blocks tower sight lines.",entity:Ue,entityType:h.SpeedBeacon,htmlElement:"⏰"},jn={name:"Damage Beacon",description:"A building that increases the damage of cardinally adjacent towers at the cost of some power for every shot fired. If there is no power (left) the towers will continue working as normal without a damage boost. Keep in mind that the beacon also blocks tower sight lines.",entity:Ne,entityType:h.DamageBeacon,htmlElement:"🚨"},Kn={name:"Laser",description:"A reasonably powerful tower that lights enemies on fire, similar to the flamethrower. It has a larger range but consumes power in order to fire.",entity:Ae,entityType:h.Laser,htmlElement:"🔭"},qn={name:"Tesla",description:"A tower that starts charging when an enemy comes near and then damages and stuns all enemies within its range.",entity:ee,entityType:h.Tesla,htmlElement:"💡"},No={name:"Excavator",description:"Allows building over trees and rocks.",entityType:h.Excavator,htmlElement:"🚜",cost:1},Uo={name:"Terraform",description:"Allows building over water, ice and enemy structures. Keep in mind a stone foundation is also built which replaces the original surface.",entityType:h.Terraform,htmlElement:"🏗️",cost:1},Zn=100,Wo={name:"Convert",description:`Convert a wave point in a flat ${Zn} gold.`,entityType:h.Convert,htmlElement:"🪙",isRepeatable:!0,cost:1},ys=1.5,Ho={name:"Emerg. recharge",description:`Generate power ${U.baseEmergencyRegenerate} power + ${U.emergencyRegenerateMultiplier} power for every base tile built. This can also be done during a wave, but doing it between waves is ${ys} as efficient.`,entityType:h.EmergencyRecharge,htmlElement:"🔌",isRepeatable:!0,cost:1},zo={name:"Emerg. repair",description:`Regenerate ${ui.baseEmergencyRepair} health + 1 health for every base tile built. This can also be done during a wave, but doing it between waves is ${ys} as efficient.`,entityType:h.EmergencyRepair,htmlElement:"🛠",isRepeatable:!0,cost:1};var gi=(i=>(i.Construction="Construction",i.Defensive="Defensive buildings",i.BasicBuildings="Basic buildings",i.PoweredBuildings="Powered Buildings",i.BaseBuildings="Base Buildings",i.WildcardBuildings="Wildcard Buildings",i.Abilities="Abilities",i))(gi||{});const Jn={Construction:[de,No,Uo],["Defensive buildings"]:[Fn,Yn,qn],["Basic buildings"]:[di,Nn,Xn],["Powered Buildings"]:[Hn,Kn,Un],["Base Buildings"]:[zn,Wn,Vn],["Wildcard Buildings"]:[$n,Gn,jn],Abilities:[Wo,Ho,zo]},Vo=[de,Fn,Yn,$o,$n,di,Xn,Nn,Un,Wn,Hn,Xo,Vn,Gn,jn,Kn,zn,qn],ji=new Set(Vo.map(i=>i.entityType));let ti=class{constructor(t,e,s){a(this,"entity");a(this,"category",k.Player);a(this,"renderData",{});this.tile=t,this.placeable=e,this.scaleOverride=s,this.entity=new tt(t.getX(),t.getY(),this)}getType(){return h.Blueprint}getTile(){return this.tile}isVisible(){return!0}getPlaceable(){return this.placeable}getScale(){var t;return((t=this.placeable.entity)==null?void 0:t.scale)||this.scaleOverride||1}isDelete(){return this.placeable.entityType===h.None}isBasePart(){return!!this.placeable.isBasePart}};const Go=i=>i.getType()===h.Blueprint,is=(i,t,e,s)=>{const n=e.getTile(),r=new Set([n]),o=s.getAdjacentTiles(n,2);for(;o.length>0;){const c=o.pop();i.has(c)||r.has(c)||!t.has(c)&&(!c.hasStaticEntity()||!e.getParts().has(c.getStaticEntity().getAgent()))||(r.add(c),s.getAdjacentTiles(c,2).forEach(l=>o.push(l)))}return r.size===e.getParts().size+t.size-i.size},jo=(i,t,e,s=!1)=>{const n=new Set([i]),r=t.getAdjacentTiles(i,2,s);for(;r.length>0;){const o=r.pop();n.has(o)||!o.hasStaticEntity()||!e.has(o.getStaticEntity().getAgent().getType())||(n.add(o),t.getAdjacentTiles(o,2,s).forEach(c=>r.push(c)))}return n.size},ge={[h.Fence]:1,[h.Wall]:3,[h.ElectricFence]:9,[h.Freezer]:6,[h.Tower]:12,[h.Flamethrower]:18,[h.Mortar]:40,[h.Railgun]:60,[h.Radar]:20,[h.PowerPlant]:20,[h.Armory]:50,[h.Market]:30,[h.SpeedBeacon]:50,[h.DamageBeacon]:40,[h.Laser]:25,[h.Barracks]:15,[h.Tesla]:50},he=class{constructor(t=0,e=()=>1){a(this,"recentlyBought",new Set);this.money=t,this.multiplier=e,he.instance=this,P.Instance.addEventListener(M.Unlock,({placeable:s})=>{s.entityType===h.Convert&&(this.addMoney(Zn),u.Instance.triggerStatUpdate())})}setMoney(t){this.money=t}addMoney(t){this.money+=t}removeMoney(t){if(t>this.money)throw new Error("Not enough money!");this.money-=t}addWaveBudget(t){this.addMoney(Math.ceil((he.waveBudget+he.waveBudget*t/3)*this.multiplier()))}buy(t){let e=t.getType();Go(t)&&(e=t.getPlaceable().entityType);const s=ge[e]??0;if(s>this.money)throw new Error("Not enough money!");this.removeMoney(s),this.recentlyBought.add(t)}replaceBlueprint(t,e){this.recentlyBought.has(t)&&(this.recentlyBought.delete(t),this.recentlyBought.add(e))}sell(t){t instanceof ti?this.addMoney(ge[t.getPlaceable().entityType]??0):this.addMoney(this.getValue(t))}getMoney(){return this.money}getMultiplier(){return this.multiplier()}clearRecents(){this.recentlyBought.clear()}isRecent(t){return this.recentlyBought.has(t)}getValue(t){const e=Math.min(.9,he.sellMultiplier*u.Instance.getBase().getMoneyFactor()),s=ge[t.getType()]??0;return Math.ceil(s*(this.recentlyBought.has(t)?1:e))}static get Instance(){return this.instance}};let V=he;a(V,"waveBudget",20),a(V,"sellMultiplier",.5),a(V,"instance");const bi=class{constructor(){a(this,"unlockedTowers");a(this,"availableUnlocks");a(this,"unlockLinkedMap");a(this,"points",0);a(this,"unlockedAmount",0);bi.instance=this,this.unlockedTowers=new Set,this.availableUnlocks=new Set,this.unlockLinkedMap=new Map,Object.values(gi).forEach(t=>{const e=Jn[t];e.forEach((s,n)=>{if(n===0){this.unlockedTowers.add(s.entityType),s.isRepeatable&&this.availableUnlocks.add(s.entityType);return}this.unlockedTowers.has(e[n-1].entityType)&&(this.availableUnlocks.add(s.entityType),s.isRepeatable&&this.unlockedTowers.add(s.entityType)),e.length>n+1&&this.unlockLinkedMap.set(s.entityType,e[n+1])})})}addPoints(t=1){this.points+=t}getPoints(){return this.points}canUnlock(t){return this.availableUnlocks.has(t.entityType)&&this.points>=(t.cost??1)}isUnlocked(t){return this.unlockedTowers.has(t.entityType)}getUnlockAmount(){return this.unlockedAmount}unlock(t){if(!this.canUnlock(t))throw new Error(`Can't unlock ${t.entityType}`);this.points-=t.cost??1,this.makeAvailable(t),P.Instance.triggerEvent(M.Unlock,{placeable:t})}makeAvailable(t){this.unlockedTowers.add(t.entityType),t.isRepeatable||(this.availableUnlocks.delete(t.entityType),this.unlockedAmount++);const e=this.unlockLinkedMap.get(t.entityType);e&&(this.availableUnlocks.add(e.entityType),e.isRepeatable&&this.makeAvailable(e))}static get Instance(){return this.instance}};let Ct=bi;a(Ct,"instance");const rt=class{constructor(t){a(this,"blueprints",new Map);a(this,"pendingBaseAdditions",[]);a(this,"pendingBaseRemovals",[]);a(this,"freeTiles");a(this,"ignoredEntities");a(this,"clearableEntities");this.surface=t,rt.instance=this,this.freeTiles=new Set(oi),this.ignoredEntities=new Set,this.clearableEntities=new Set(ji),P.Instance.addEventListener(M.Unlock,({placeable:e})=>{e.entityType===h.Excavator&&(this.ignoredEntities.add(h.Tree),this.ignoredEntities.add(h.Rock),this.ignoredEntities.add(h.Stump),this.clearableEntities.add(h.Tree),this.clearableEntities.add(h.Rock),this.clearableEntities.add(h.Stump)),e.entityType===h.Terraform&&(this.freeTiles.add(f.Water),this.freeTiles.add(f.Ice),this.freeTiles.add(f.Spore),this.freeTiles.add(f.Bridge))})}getMaxTowers(){return 1+(u.Instance.getBase().getParts().size+1)*rt.towersPerPart}build(t,e){if(e.entityType===h.None||e.entityType===h.Excavator){u.Instance.getIsStarted()?this.sellBlueprints(t):this.sellEntities(t);return}if(!u.Instance.getIsStarted()&&e.entityType===h.Terraform&&Ct.Instance.isUnlocked(e)){const s=t.map(n=>{var o;const r=(o=n.getStaticEntity())==null?void 0:o.getAgent();return r&&r.category!==k.Player&&(u.Instance.getSurface().despawnStatic(r),r.getType()===h.Tree&&(r.renderData.chopped=!0)),new J(n.getX(),n.getY(),f.Stone)});u.Instance.getSurface().setTiles(s);return}!ji.has(e.entityType)||!Ct.Instance.isUnlocked(e)||(u.Instance.getIsStarted()?this.placeBlueprints(t,e):this.placeEntities(t,e))}commit(){const t=[];this.blueprints.forEach(e=>{const s=e.getTile(),n=this.surface.getEntityTiles(s.getX(),s.getY(),e.getScale());if(this.surface.despawn(e),n.forEach(c=>{if(!c.hasStaticEntity())return;const l=c.getStaticEntity().getAgent();V.Instance.sell(l),this.surface.despawnStatic(l),l.getType()===h.Tree&&(l.renderData.chopped=!0)}),e.isDelete())return;const r=e.getPlaceable().entity,o=new r(s);this.spawn(o),V.Instance.replaceBlueprint(e,o),t.push(s)}),this.pendingBaseAdditions=[],this.pendingBaseRemovals=[],this.blueprints.size!==0&&(this.blueprints.clear(),u.Instance.triggerStatUpdate(),t.length>0&&P.Instance.triggerEvent(M.Buy,{tiles:t}))}placeBlueprints(t,e){const s=t.filter(n=>this.checkIsFree(n,e.entity.scale,!0));if(e.isBasePart){const{pendingBaseAdditions:n,pendingBaseRemovals:r}=this.getPendingTiles(t);if(!is(r,n,u.Instance.getBase(),this.surface)){u.Instance.showMessage("Not all tiles connect to the base");return}}s.length===0||!u.Instance.canBuy(e,s.length)||(s.forEach(n=>{this.surface.getEntityTiles(n.getX(),n.getY(),e.entity.scale).forEach(c=>{const l=this.blueprints.get(c.getHash());l&&(V.Instance.sell(l),this.freeBlueprint(l),l.isBasePart()?this.pendingBaseAdditions.splice(this.pendingBaseAdditions.indexOf(l),1):c.hasStaticEntity()&&rt.baseParts.has(c.getStaticEntity().getAgent().getType())&&this.pendingBaseRemovals.splice(this.pendingBaseRemovals.indexOf(l),1),l.isDelete()&&c.hasStaticEntity()&&rt.baseParts.has(c.getStaticEntity().getAgent().getType())&&this.pendingBaseRemovals.splice(this.pendingBaseRemovals.indexOf(l),1))});const o=new ti(n,e);V.Instance.buy(o),this.reserveBlueprint(o),e.isBasePart&&(!n.hasStaticEntity()||!rt.baseParts.has(n.getStaticEntity().getAgent().getType()))&&this.pendingBaseAdditions.push(o)}),u.Instance.triggerStatUpdate())}sellBlueprints(t){const e=t.find(o=>this.blueprints.has(o.getHash()));let s=t.filter(o=>e?!!this.blueprints.has(o.getHash()):!!(o.hasStaticEntity()&&this.clearableEntities.has(o.getStaticEntity().getAgent().getType())));const{baseTiles:n,otherTiles:r}=this.splitTiles(s);if(n.length){const{pendingBaseAdditions:o,pendingBaseRemovals:c}=this.getPendingTiles(n,!0);is(c,o,u.Instance.getBase(),this.surface)||(s=r,u.Instance.showMessage("Not all base parts can be sold"))}s.length!==0&&(s.forEach(o=>{if(e){const c=this.blueprints.get(o.getHash());c&&(c.isDelete()||(V.Instance.sell(c),o.hasStaticEntity()&&rt.baseParts.has(o.getStaticEntity().getAgent().getType())&&this.pendingBaseRemovals.splice(this.pendingBaseRemovals.indexOf(c),1)),c.isBasePart()&&(!o.hasStaticEntity()||!rt.baseParts.has(o.getStaticEntity().getAgent().getType()))&&this.pendingBaseAdditions.splice(this.pendingBaseAdditions.indexOf(c),1),this.freeBlueprint(c),o.hasStaticEntity()&&rt.baseParts.has(o.getStaticEntity().getAgent().getType())&&this.pendingBaseRemovals.splice(this.pendingBaseRemovals.indexOf(c),1));return}if(o.hasStaticEntity()&&!this.blueprints.get(o.getHash())){const c=o.getStaticEntity().getAgent(),l=new ti(c.getTile(),de,At(c));this.reserveBlueprint(l),rt.baseParts.has(c.getType())&&this.pendingBaseRemovals.push(l)}}),u.Instance.triggerStatUpdate())}placeEntities(t,e){if(e.entity.range>1&&this.surface.getTowers().size>=this.getMaxTowers()){u.Instance.showMessage("The base needs to be extended to support additional towers");return}const n=t.filter(r=>this.checkIsFree(r,e.entity.scale));if(e.isBasePart&&!is(new Set,new Set(n),u.Instance.getBase(),this.surface)){u.Instance.showMessage("Not all tiles connect to the base");return}n.length===0||!u.Instance.canBuy(e,n.length)||(n.forEach(r=>{const o=new e.entity(r);this.surface.getEntityTiles(o).forEach(c=>{if(c.hasStaticEntity()){const l=c.getStaticEntity().getAgent();l.getType()===h.Tree&&(l.renderData.chopped=!0),this.surface.despawnStatic(l)}}),this.spawn(o),V.Instance.buy(o)}),u.Instance.triggerStatUpdate(),P.Instance.triggerEvent(M.Buy,{tiles:n}))}sellEntities(t){let e=t.filter(r=>!!(r.hasStaticEntity()&&this.clearableEntities.has(r.getStaticEntity().getAgent().getType())));const{baseTiles:s,otherTiles:n}=this.splitTiles(e);if(s.length){const{pendingBaseAdditions:r,pendingBaseRemovals:o}=this.getPendingTiles(s,!0);is(o,r,u.Instance.getBase(),this.surface)||(e=n,u.Instance.showMessage("Not all base parts can be sold"))}e.length!==0&&(e.forEach(r=>{if(r.hasStaticEntity()){const o=r.getStaticEntity().getAgent();this.surface.despawnStatic(o),V.Instance.sell(o),o.getType()===h.Tree&&(o.renderData.chopped=!0)}}),u.Instance.triggerStatUpdate(),P.Instance.triggerEvent(M.Sell))}splitTiles(t){const e=new Set,s=[];return t.forEach(n=>{const r=this.blueprints.get(n.getHash());if(r&&r.isBasePart()){e.add(r.getTile());return}n.hasStaticEntity()&&rt.baseParts.has(n.getStaticEntity().getAgent().getType())?e.add(n.getStaticEntity().getAgent().getTile()):s.push(n)}),{baseTiles:[...e],otherTiles:s}}getPendingTiles(t,e=!1){const s=new Set(this.pendingBaseAdditions.map(o=>this.surface.getTile(o.entity.getAlignedX(),o.entity.getAlignedY()))),n=new Set(this.pendingBaseRemovals.map(o=>this.surface.getTile(o.entity.getAlignedX(),o.entity.getAlignedY())));let r=o=>{s.delete(o)||n.delete(o)||n.add(o)};return t.forEach(o=>{if(e){r(o);return}const c=this.blueprints.get(o.getHash());if(c){if(c.isDelete()){n.delete(o);return}s.add(o);return}s.add(o)}),{pendingBaseAdditions:s,pendingBaseRemovals:n}}checkIsFree(t,e,s=!1){return!this.surface.getEntityTiles(t.getX(),t.getY(),e).find(r=>{if(!this.freeTiles.has(r.getBaseType())||r.hasStaticEntity()&&!this.ignoredEntities.has(r.getStaticEntity().getAgent().getType())&&(!s||!this.clearableEntities.has(r.getStaticEntity().getAgent().getType())))return!0})}reserveBlueprint(t){this.surface.spawn(t);const e=t.getTile();this.surface.getEntityTiles(e.getX(),e.getY(),t.getScale()).forEach(s=>this.blueprints.set(s.getHash(),t))}freeBlueprint(t){this.surface.despawn(t);const e=t.getTile();this.surface.getEntityTiles(e.getX(),e.getY(),t.getScale()).forEach(s=>this.blueprints.delete(s.getHash()))}spawn(t){this.surface.getEntityTiles(t).forEach(e=>{rt.surfacesRequiringFoundation.has(e.getBaseType())&&this.surface.setTile(new J(e.getX(),e.getY(),f.Stone))}),this.surface.spawnStatic(t)}static get Instance(){return this.instance}};let dt=rt;a(dt,"instance"),a(dt,"towersPerPart",2),a(dt,"baseParts",new Set([h.Armory,h.Radar,h.Market,h.PowerPlant])),a(dt,"surfacesRequiringFoundation",new Set([f.Water,f.Ice,f.Spore,f.Bridge]));var st=(i=>(i.Shift="Shift",i.Control="Control",i.Meta="Meta",i.Plus="+",i.Minus="-",i.Equals="=",i.Up="ArrowUp",i.Left="ArrowLeft",i.Right="ArrowRight",i.Down="ArrowDown",i.Escape="Escape",i.W="w",i.A="a",i.S="s",i.D="d",i.Z="z",i.Q="q",i.B="b",i.E="e",i.F="f",i))(st||{}),Qn=(i=>(i.Single="single",i.Line="line",i.StraightLine="straightLine",i.grid="grid",i))(Qn||{});const Ko=new Set(Object.values(st));function Ki(i){return Ko.has(i)}const xi=class{constructor(t){a(this,"mouseDownX",0);a(this,"mouseDownY",0);a(this,"mouseX",0);a(this,"mouseY",0);a(this,"pressedKeys",{});a(this,"_isMouseDown",!1);a(this,"eventHandlers",new Map);a(this,"selectedPlacable",de);a(this,"previousSelectedPlacable",di);a(this,"buildMenuOpen",!1);a(this,"isPaused",!1);this.surface=t,xi.instance=this}getPlacable(){return this.selectedPlacable}setPlaceable(t){this.selectedPlacable=t,P.Instance.triggerEvent(M.SelectPlaceable,{placeable:t})}mouseDown(t,e){this.mouseDownX=t,this.mouseDownY=e,this._isMouseDown=!0}mouseMove(t,e){this.mouseX=t,this.mouseY=e}getSelection(){var n,r,o,c;if(!this._isMouseDown)return[];let t=this.mouseX,e=this.mouseY;if(this.pressedKeys.Control||this.pressedKeys.Meta){let l=[];return this.surface.forRect(this.mouseDownX,this.mouseDownY,t,e,g=>{g.isDiscovered()&&l.push(g)},{scale:((r=(n=this.selectedPlacable)==null?void 0:n.entity)==null?void 0:r.scale)||1}),l}this.pressedKeys.Shift&&(Math.abs(t-this.mouseDownX)>Math.abs(e-this.mouseDownY)?e=this.mouseDownY:t=this.mouseDownX);let s=[];return this.surface.forLine(this.mouseDownX,this.mouseDownY,t,e,l=>{l.isDiscovered()&&s.push(l)},{scale:((c=(o=this.selectedPlacable)==null?void 0:o.entity)==null?void 0:c.scale)||1}),s}mouseUp(t,e){if(!this.selectedPlacable){this._isMouseDown=!1;return}const s=this.getSelection();dt.Instance.build(s,this.selectedPlacable),this._isMouseDown=!1}keyDown(t){Ki(t)&&(this.pressedKeys[t]=!0)}keyUp(t){var e;if(Ki(t)){if(this.pressedKeys[t]=!1,this.isPaused&&t!=="Escape")return;if((e=this.eventHandlers.get(t))==null||e.forEach(s=>s()),(t==="b"||t==="e")&&this.toggleBuildMenu(),t==="f")if(this.selectedPlacable!==de)this.previousSelectedPlacable=this.selectedPlacable,this.setPlaceable(de);else{const s=this.previousSelectedPlacable;this.previousSelectedPlacable=this.selectedPlacable,this.setPlaceable(s)}}}toggleBuildMenu(){this.buildMenuOpen=!this.buildMenuOpen,this.buildMenuOpen?P.Instance.triggerEvent(M.OpenBuildMenu):P.Instance.triggerEvent(M.CloseBuildMenu)}isKeyDown(t){return this.pressedKeys[t]??!1}addKeyListener(t,e){return this.eventHandlers.has(t)?this.eventHandlers.get(t).add(e):this.eventHandlers.set(t,new Set([e])),()=>this.removeKeyListener(t,e)}removeKeyListener(t,e){var s;(s=this.eventHandlers.get(t))==null||s.delete(e)}isMouseDown(){return this._isMouseDown}getMouse(t){var s,n;const e=t||((n=(s=this.selectedPlacable)==null?void 0:s.entity)==null?void 0:n.scale)||1;return[Math.floor(this.mouseX/e)*e,Math.floor(this.mouseY/e)*e]}getMode(){return this._isMouseDown?this.pressedKeys.Control||this.pressedKeys.Meta?"grid":this.pressedKeys.Shift?"straightLine":"line":"single"}pause(){this.isPaused=!0}unpause(){this.isPaused=!1}static get Instance(){return this.instance}};let _t=xi;a(_t,"instance");const ws=(i,t,e)=>new Promise(s=>{const n=P.Instance.addEventListener(t,(...r)=>{(!e||e(...r))&&(n(),s())})}).then(()=>i),ta=(i,t,e)=>new Promise(s=>{const n=P.Instance.addEventListeners(t,r=>{(!e||e(r))&&(n(),s())})}).then(()=>i),Ts=(i,...t)=>e=>ta(u.Instance.showMessage(i,{override:e,expires:0}),t),qo=Ts("Welcome to Open Tower Defense! Open the build menu by pressing {key: e}. You can also quickly select the most basic tower by pressing {key: f}.",M.OpenBuildMenu,M.StartWave),Zo=i=>new Promise(t=>{if(u.Instance.getIsStarted()){ws(i,M.EndWave).then(t);return}ws(u.Instance.showMessage("Here you can choose which defenses to build. Consider picking the basic tower to beat the first wave. Towers in the 2nd and 3rd row can be unlocked later in the game.",{override:i,expires:0}),M.SurfaceChange,({affectedTiles:e})=>!!e.size).then(t)}),Jo=i=>new Promise(t=>{const e=u.Instance.getDifficulty();if(e===K.Hard){t(i);return}ta(u.Instance.showMessage(`If you're new to the game you can click the {key: 🎯} button to view tower sight lines${e===K.Easy?" and enemy paths":" "} to check how effective your layout is.`,{override:i,expires:0}),[M.ToggleShowCoverage,M.StartWave]).then(t)}),Qo=i=>new Promise(t=>{if(u.Instance.getIsStarted()){ws(i,M.EndWave).then(t);return}ws(u.Instance.showMessage("Start the wave when you are ready. Good luck!",{override:i,expires:0}),M.EndWave).then(t)}),th=Ts("Good job defeating the first wave! Things will quickly become more difficult from here on out! After every wave your visible radius will increase. When enemy spawn points are discovered they are disabled and you receive a point to unlock new technologies.",M.Discover),eh=Ts("You gained a wave point by discovering a spawn point! Open the build menu in order to spend it.",M.OpenBuildMenu),sh=Ts("There are both defensive and offensive upgrades, read the descriptions to understand their strengths! You can also trade wave points for bonuses in the last column.",M.CloseBuildMenu),qi=[qo,Zo,Jo,Qo,th,eh,sh];class ih{constructor(){a(this,"promise");a(this,"reject");a(this,"previousId",-1)}async start(){this.promise=new Promise(async(t,e)=>{this.reject=e,await Promise.resolve();for(let s=0;s<qi.length;s++){const n=qi[s];try{this.previousId=await Promise.race([n(this.previousId),this.promise])}catch{return}}t(-1)});try{await this.promise}catch{}}stop(){var t;(t=this.reject)==null||t.call(this),this.reject=void 0,this.promise=void 0}get isStarted(){return!!this.promise}}const ei=(i,t,e)=>{const s=Number(i);return isNaN(s)||t&&s<t?t??0:e&&s>e?e:s},nh=(i,t)=>i!==""?ei(t):t,ah=(i,t)=>t;var ls=(i=>(i[i.Growing=0]="Growing",i[i.Fixed=1]="Fixed",i))(ls||{});class Ls{constructor(t,e=0,s=10){a(this,"size");a(this,"freeEntities",[]);a(this,"usedEntities",new Map);this.initializer=t,this.type=e,this.size=s;for(let n=0;n<s;n++)this.freeEntities.push(t(!1))}get(t){let e=this.usedEntities.get(t);if(e)return e;if(this.freeEntities.length===0){if(this.type===1)throw new Error("Pool is empty");this.size++}return e=this.initializer(!0,this.freeEntities.pop(),t),this.usedEntities.set(t,e),e}free(t){if(!this.usedEntities.has(t))return;let e=this.usedEntities.get(t);return this.usedEntities.delete(t),this.freeEntities.push(e),e}getSize(){return this.size}getUsed(){return this.usedEntities}}const rh=(i,t,e)=>{const s=t.entity,n=s.getX(),r=s.getY(),o=Math.sqrt((n-t.targetX)**2+(r-t.targetY)**2);e.style.transformOrigin="0 0",e.style.opacity=`${1-.9*(t.time/li)}`,e.style.transform=`translate(${n*i.xStep}px, ${r*i.yStep}px) rotate(${s.getRotation()}deg) scale(${o}, 0.1)`},oh=(i,t,e)=>{const s=t.entity;e.style.opacity=`${1-.9*(t.time/Ks)}`,e.style.transform=`translate(${(s.getX()+Math.random()*.3-.15)*i.xStep}px, ${(s.getY()+Math.random()*.3-.15)*i.yStep}px) rotate(${-s.getRotation()+180+Math.random()*10-5}deg)`},Zi=1/4,Pe=(i,t,e)=>{const s=t.entity,n=s.getId()%13/26-Zi,r=(s.getId()+5)%17/34-Zi,o=i.getTime()%13/3;let c=s.getRotation();t.AI.isAttacking()&&(c+=Math.sin(i.getTime()%Z/Z*5)*20),t.getStatus()===b.OnFire?(e.style.color="transparent",e.style.textShadow=`${Math.random()-.5}px ${Math.random()-.5}px ${o+2}px #E25822`):t.getStatus()===b.Normal&&(e.style.color="initial",e.style.textShadow="none"),e.style.transform=`translate(${(t.getOffsetX()+n)*i.xStep}px, ${(t.getOffsetY()+r)*i.yStep}px) rotate(${c}deg) scale(${t.getScale()})`},hh=1/4,ch=1/8,lh=.0015,uh=(i,t,e)=>{const s=t.entity,n=lh*(1+s.getId()%13/13),r=Math.sin((i.getTime()+s.getId())*n)/4-ch,o=Math.cos((i.getTime()+s.getId())*n)/2-hh,c=i.getTime()%13/3,l=(s.getRotation()+360)%360,g=l>0&&l<180?-1:1;let p=0;t.AI.isBusy()&&(p+=Math.sin(i.getTime()%Z/Z*5)*20),t.getStatus()===b.OnFire?(e.style.color="transparent",e.style.textShadow=`${Math.random()-.5}px ${Math.random()-.5}px ${c+2}px #E25822`):t.getStatus()===b.Normal&&(e.style.color="initial",e.style.textShadow="none"),e.style.transform=`translate(${(s.getX()+r)*i.xStep}px, ${(s.getY()+o)*i.yStep}px) rotate(${p}deg) scale(${g},1)`},dh=(i,t,e)=>{const s=t.entity;e.children[0].textContent=i.getStaticEntityEmoji(t.getPlaceable().entityType),e.style.transformOrigin="0 0",e.style.opacity="0.5",e.style.filter="grayscale(0.6)",e.style.transform=`translate(${s.getX()*i.xStep}px, ${s.getY()*i.yStep}px) rotate(${s.getRotation()}deg) scale(${t.getScale()})`},gh=(i,t,e)=>{const s=t.entity,n=s.getX(),r=s.getY(),o=Math.sqrt((n-t.targetX)**2+(r-t.targetY)**2);e.style.color="transparent",e.style.textShadow="0 0 0 #E25822",e.style.transformOrigin="0 0",e.style.opacity=`${1-.9*(t.time/ms)}`,e.style.transform=`translate(${n*i.xStep}px, ${r*i.yStep}px) rotate(${s.getRotation()}deg) scale(${o}, 0.1)`},Fs=(i,t,e)=>{const s=t.entity;e.style.transform=`translate(${(s.getX()-.5)*i.xStep}px, ${(s.getY()-.5)*i.yStep}px) rotate(${s.getRotation()}deg)`},ph={[h.Rail]:rh,[h.Flame]:oh,[h.Slime]:Pe,[h.Runner]:Pe,[h.Flier]:uh,[h.Tank]:Pe,[h.Blueprint]:dh,[h.LaserBeam]:gh,[h.Bullet]:Fs,[h.Rocket]:Fs,[h.Shockwave]:Fs,[h.Behemoth]:Pe,[h.Bore]:Pe},fh=5e3,mh=it({__name:"Key",props:{char:null,area:null},setup(i){const t=i,e=t.char>"A"&&t.char<"z";return(s,n)=>(x(),A("div",{class:j({key:!0,emoji:!R(e)}),style:hs({gridArea:t.area})},F(t.char),7))}});const ht=(i,t)=>{const e=i.__vccOpts||i;for(const[s,n]of t)e[s]=n;return e},H=ht(mh,[["__scopeId","data-v-8be0d2b3"]]),yh=it({__name:"mouse",props:{button:null},setup(i){const t=i;return(e,s)=>(x(),A("div",{class:j(`mouse button-${t.button}`)},null,2))}});const us=ht(yh,[["__scopeId","data-v-135d4a7c"]]),wh=it({__name:"TextWithControls",props:{text:null},setup(i){const t=i,e={0:"left",1:"right",3:"middle"},s=_(t.text),n=_(""),r=_(""),o=_("");return ba(()=>t.text,c=>{const g=/^(?<left>.*?){(?<control>key|mouse): (?<type>.*?)}(?<right>.*)$/.exec(c);g?(s.value=g.groups.left,n.value=g.groups.control,r.value=g.groups.type,o.value=g.groups.right):(s.value=c,n.value="",r.value="",o.value="")},{immediate:!0}),(c,l)=>{const g=xa("TextWithControls",!0);return x(),A(vt,null,[B(F(s.value)+" ",1),n.value==="key"?(x(),le(H,{key:0,char:r.value},null,8,["char"])):Q("",!0),n.value==="mouse"?(x(),le(us,{key:1,button:R(e)[r.value]},null,8,["button"])):Q("",!0),o.value?(x(),le(g,{key:2,text:o.value},null,8,["text"])):Q("",!0)],64)}}}),vh={class:"message-wrapper"},Sh={class:"message-inner"},Eh=["onClick"],Mh=it({__name:"SimpleMessage",props:{register:{type:Function}},setup(i){const t=i;let e=1;const s=()=>({id:e++,content:"",closable:!0,open:!1,removing:!1}),n=_([s()]),r=_(new Map),o=yn(),c=(g,p)=>{let d,v=-1;if(p!=null&&p.override&&(v=n.value.findIndex(I=>I.id===p.override)),v!==-1){const I=n.value[v].id;window.clearTimeout(r.value.get(I)),r.value.delete(I),d=n.value[v]}else d=n.value.at(-1),n.value.push(s());d.closable=(p==null?void 0:p.closable)??!0,d.open=!0,d.content=g;const w=(p==null?void 0:p.expires)??fh;if(w){const I=window.setTimeout(()=>{l(d)},w);r.value.set(d.id,I)}return Promise.resolve(d.id)},l=g=>{g.open=!1,g.removing=!0,o.proxy.$forceUpdate(),window.setTimeout(()=>{const p=n.value.indexOf(g);p>-1&&n.value.splice(p,1)},700)};return Ze(()=>{t.register(c)}),(g,p)=>(x(),A("div",vh,[(x(!0),A(vt,null,Ht(n.value,d=>(x(),A("div",{key:d.id,class:j({message:!0,"message--visible":d.open,"message--removing":d.removing})},[m("div",Sh,[d.closable?(x(),A("button",{key:0,class:"close-button",onClick:()=>l(d)}," ✖ ",8,Eh)):Q("",!0),L(wh,{text:d.content},null,8,["text"])])],2))),128))]))}});const ea=ht(Mh,[["__scopeId","data-v-3ec9490a"]]),et=navigator.appVersion.indexOf("Win")!=-1,Ih=42,bh=4,xh=20;let Jt=!1,pi=class{constructor(t,e){a(this,"pool");a(this,"selectionPool");a(this,"scaledTilesPool");a(this,"messageFn");a(this,"resolveMessageFn");a(this,"removeEventListeners");a(this,"xStep",0);a(this,"yStep",0);a(this,"offsetX",0);a(this,"offsetY",0);a(this,"time",0);a(this,"fontSize",xh);a(this,"hasMoved",!1);a(this,"_showCoverage",!1);a(this,"target",null);a(this,"app");a(this,"appContainer");a(this,"world",null);a(this,"rows",[]);a(this,"alertRanges",[]);a(this,"coverageMap",null);a(this,"coverageRows",[]);a(this,"showMessage",async(...t)=>(await this.messageFn)(...t));a(this,"getEmoji",t=>{const e=Jt||u.Instance.getIsBaseDestroyed();if(t.getDiscoveryStatus()===$.Pending&&!e)return"🔍";if(!t.isDiscovered()&&!e)return"&nbsp;";if(t.hasStaticEntity()&&At(t.getStaticEntity().getAgent())!==2)return this.getStaticEntityEmoji(t.getStaticEntity().getAgent().getType());switch(t.getBaseType()){case f.Water:return"🟦";case f.Stone:return"⬜";case f.Grass:return"🟩";case f.Spore:return"🟪";case f.Bridge:return"📜";case f.Sand:return"🟨";case f.Snow:return"🌫️";case f.Dirt:return"🟫";case f.Ice:return"🧊";case f.Freezer:return"🦠";default:return"&nbsp;"}});this.surface=t,this.controller=e,this.pool=new Ls((s,n,r)=>{if(n)return n.style.display="block",n.style.opacity="1",n.style.transformOrigin="50% 50%",n.style.filter="none",n.style.color="initial",n.style.textShadow="none",n.children[0].textContent=this.getEntityEmoji(r),n;const o=document.createElement("span");return o.appendChild(document.createElement("span")),et&&(o.children[0].style.margin="-0.35ch"),o.children[0].textContent=r?this.getEntityEmoji(r):"",o.style.position="absolute",o.style.top=et?"-.125ch":"-.075ch",o.style.left=et?".35ch":"0",o.style.display=s?"block":"none",o.style.willChange="transform",this.world.appendChild(o),o},ls.Growing,0),this.selectionPool=new Ls((s,n)=>{if(n)return n.style.display="block",n;const r=document.createElement("span");return r.appendChild(document.createElement("span")),et&&(r.children[0].style.margin="-0.35ch"),r.children[0].textContent="🟧",r.style.transformOrigin="0 0",r.style.opacity="0.7",r.style.position="absolute",r.style.top=et?"-.125ch":"-.075ch",r.style.left=et?".35ch":"0",r.style.display=s?"block":"none",r.style.willChange="transform",this.world.appendChild(r),r},ls.Growing,0),this.scaledTilesPool=new Ls((s,n,r)=>{if(n)return n.style.display="block",n.children[0].textContent=this.getStaticEntityEmoji(r.getAgent().getType()),n;const o=document.createElement("span");return o.appendChild(document.createElement("span")),et&&(o.children[0].style.margin="-0.35ch"),o.children[0].textContent=r?this.getStaticEntityEmoji(r.getAgent().getType()):"",o.style.transformOrigin="0 0",o.style.position="absolute",o.style.top=et?"-.125ch":"-.075ch",o.style.left=et?".35ch":"0",o.style.display=s?"block":"none",o.style.willChange="transform",this.world.appendChild(o),o},ls.Growing,0),this.messageFn=new Promise(s=>this.resolveMessageFn=s),window.debug=()=>{Jt=!Jt,this.renderTiles()}}mount(t){this.target=t,this.appContainer=t.appendChild(document.createElement("div")),this.app=ii(ea,{register:this.resolveMessageFn}),this.app.mount(this.appContainer),this.world=t.appendChild(document.createElement("div")),this.world.className="scrollable",this.world.style.lineHeight=et?"1.86ch":"1ch",this.world.style.whiteSpace="nowrap",this.world.style.cursor="crosshair",this.world.style.userSelect="none",this.world.style.position="relative",this.world.style.fontFamily='"Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Android Emoji","EmojiOne Mozilla","Twemoji Mozilla","Noto Emoji","Segoe UI Symbol",EmojiSymbols',this.world.style.backgroundColor="#000",et&&(this.world.style.letterSpacing="-0.7ch",this.world.style.wordSpacing="2.04ch"),this.renderTiles(),this.zoom();const{width:e,height:s}=this.world.getBoundingClientRect(),n=u.Instance.getBase().getTile();this.world.scrollLeft=n.getX()*this.xStep-e/2,this.world.scrollTop=n.getY()*this.yStep-s/2,this.rerender(0),this.registerEventHandlers(this.world)}zoom(){const t=(this.world.scrollLeft+this.world.clientWidth/2)/this.world.scrollWidth,e=(this.world.scrollTop+this.world.clientHeight/2)/this.world.scrollHeight;this.world.style.fontSize=`${this.fontSize}px`;const{width:s,height:n,x:r,y:o}=this.world.getBoundingClientRect(),c=this.world.scrollWidth,l=this.world.scrollHeight;this.xStep=c/this.surface.getWidth(),this.yStep=l/this.surface.getHeight(),this.offsetX=r,this.offsetY=o,this.world.scrollLeft=t*c-s/2,this.world.scrollTop=e*l-n/2}rerender(t){this.time+=t,this.surface.isDirty()&&this.renderTiles(),(this.surface.isDirty()||this.hasMoved)&&(this.renderStaticAgents(),this.renderAlertRanges());const e=this.surface.getEntities();for(let n of e){const r=ph[n.getAgent().getType()];if(!this.getEntityEmoji(n)&&!r)continue;const o=this.pool.get(n);o.style.display=n.getAgent().isVisible()?"block":"none",r?r(this,n.getAgent(),o):o.style.transform=`translate(${n.getX()*this.xStep}px, ${n.getY()*this.yStep}px) rotate(${n.getRotation()}deg)`}this.surface.getDeletedEntities().forEach(n=>{const r=this.pool.free(n);r&&(r.style.display="none")}),this.renderSelection(),this.surface.markPristine()}showCoverage(){this._showCoverage=!0,this.renderTiles()}hideCoverage(){this._showCoverage=!1,this.renderTiles()}renderTiles(){const t=this.surface.getHeight();for(let e=0;e<t;e++){let s=this.rows[e];s||(s=document.createElement("div"),et&&(s.style.letterSpacing="-0.7ch"),this.rows[e]=s,this.world.appendChild(s));const n=this.surface.getRow(e).map(this.getEmoji).join("");s.innerHTML=n}this.renderCoverage()}renderStaticAgents(){const t=this.surface.getEntitiesForCategory(k.Player);for(let s of t){const n=s.getAgent();if(zs(n)&&At(n)===2){const r=this.scaledTilesPool.get(s);r.style.transform=`translate(${s.getX()*this.xStep}px, ${s.getY()*this.yStep}px) scale(2)`}}this.surface.getDeletedEntities().forEach(s=>{const n=this.scaledTilesPool.free(s);n&&(n.style.display="none")})}async renderCoverage(){const t=Jt||u.Instance.getIsBaseDestroyed(),e=[];q.Instance.getSpawnGroups().forEach(o=>{e.push(o.getAsyncSpawnPoints())});const s=[];if((await Promise.all(e)).forEach(o=>s.push(o[0])),this.coverageMap||(this.coverageMap=document.createElement("div"),this.coverageMap.style.opacity="0.5",this.coverageMap.style.position="absolute",this.coverageMap.style.top="0",this.coverageMap.style.left=et?"-0.125ch":"0",et&&(this.coverageMap.style.letterSpacing="-0.7ch",this.coverageMap.style.wordSpacing="2.04ch"),this.world.appendChild(this.coverageMap)),this._showCoverage)this.coverageMap.style.display="block";else{this.coverageMap.style.display="none";return}const n=new Set;u.Instance.getDifficulty()===K.Easy&&s.forEach(o=>o.getTiles().forEach(c=>n.add(c)));const r=this.surface.getHeight();for(let o=0;o<r;o++){let c=this.coverageRows[o];c||(c=document.createElement("div"),this.coverageRows[o]=c,this.coverageMap.appendChild(c));const l=this.surface.getRow(o).map(g=>{if(!g.isDiscovered()&&!t)return"&nbsp;";const p=g.isCoveredByTower();return n.has(g)?p?"⚔️":"🐾":p?"🎯":"&nbsp;"}).join("");c.innerHTML=l}}renderSelection(){var n,r;const t=this.selectionPool.getUsed();let e=this.controller.getSelection();e.length===1&&(e=[]);const s=((r=(n=this.controller.getPlacable())==null?void 0:n.entity)==null?void 0:r.scale)||1;e.forEach((o,c)=>{const l=t.has(c)?t.get(c):this.selectionPool.get(c);l.style.transform=`translate(${o.getX()*this.xStep}px, ${o.getY()*this.yStep}px) scale(${s})`});for(let o=t.size-1;o>=e.length;o--){const c=this.selectionPool.free(o);c&&(c.style.display="none")}}renderAlertRanges(){const[t,e]=xt(u.Instance.getBase()),s=20*this.xStep,n=20*this.yStep,r=u.Instance.getIsStarted()?[]:q.Instance.getSpawnAlertRanges();r.forEach((o,c)=>{const l=o.getLength(),g=o.getCenter(),p=l/360;let d=this.alertRanges[c];if(!d){this.alertRanges[c]=d=document.createElementNS("http://www.w3.org/2000/svg","svg");const w=document.createElementNS("http://www.w3.org/2000/svg","circle");w.setAttribute("cx","50%"),w.setAttribute("cy","50%"),w.setAttribute("r","45%"),w.setAttribute("stroke","url(#alert)"),w.setAttribute("stroke-linecap","round"),w.setAttribute("fill","none"),d.appendChild(w);const I=document.createElementNS("http://www.w3.org/2000/svg","text");I.setAttribute("text-anchor","middle"),I.setAttribute("dominant-baseline","middle"),I.classList.add("alert"),d.appendChild(I),d.style.position="absolute",d.style.top=et?"-.125ch":"-.075ch",d.style.left=et?".35ch":"0",d.style.transformOrigin="50%",this.world.appendChild(d)}d.style.display="block",d.children[0].setAttribute("stroke-width",`${this.fontSize}`),d.children[1].style.transform=`translate(90%, 50%) rotate(-${g}deg)`,d.children[1].setAttribute("direction",g>270||g<90?"rtl":"ltr"),d.children[1].innerHTML="⚠️"+o.getUnits().map(this.getEntityTypeEmoji).join("");const v=s*.9*Math.PI;d.children[0].setAttribute("stroke-dasharray",`${v*p/2} ${v*(1-p)} ${v*p/2} 0`),d.style.width=`${s}px`,d.style.height=`${n}px`,d.style.transform=`translate(${t*this.xStep-s/2}px,${e*this.yStep-n/2}px) rotate(${g}deg)`});for(let o=r.length;o<this.alertRanges.length;o++)this.alertRanges[o].style.display="none"}unmount(){this.app&&(this.app.unmount(),this.target.removeChild(this.appContainer),this.target.removeChild(this.world),this.removeEventListeners())}getTime(){return this.time}canMove(t,e){if(Jt||u.Instance.getIsBaseDestroyed())return!0;const n=this.getBBox(),r=at.Instance.getBBox();if(Math.abs(t)>Math.abs(e)){if(t<0&&n[0][0]<=r[0][0]||t>0&&n[1][0]>=r[1][0])return!1}else if(e<0&&n[0][1]<=r[0][1]||e>0&&n[1][1]>=r[1][1])return!1;return!0}registerEventHandlers(t){const e=p=>(p.preventDefault(),!1);t.addEventListener("contextmenu",e);const s=(p,d,v)=>{Jt||u.Instance.getIsBaseDestroyed()||(this.getBBox(),at.Instance.getBBox(),this.canMove(p,d)||v.preventDefault())},n=p=>{s(p.deltaX,p.deltaY,p)};t.addEventListener("wheel",n,{passive:!1});const r=p=>{const d=Math.floor((p.pageX-this.offsetX+this.world.scrollLeft)/this.xStep),v=Math.floor((p.pageY-this.offsetY+this.world.scrollTop)/this.yStep);this.controller.mouseDown(d,v)};t.addEventListener("mousedown",r);const o=p=>{const d=Math.floor((p.pageX-this.offsetX+this.world.scrollLeft)/this.xStep),v=Math.floor((p.pageY-this.offsetY+this.world.scrollTop)/this.yStep);this.controller.mouseMove(d,v)};t.addEventListener("mousemove",o);const c=p=>{const d=Math.floor((p.pageX-this.offsetX+this.world.scrollLeft)/this.xStep),v=Math.floor((p.pageY-this.offsetY+this.world.scrollTop)/this.yStep);this.controller.mouseUp(d,v)};t.addEventListener("mouseup",c);const l=p=>{this.controller.keyDown(p.key),p.preventDefault()};window.addEventListener("keydown",l);const g=p=>{this.controller.keyUp(p.key),p.preventDefault()};window.addEventListener("keyup",g),this.removeEventListeners=()=>{t.removeEventListener("contextmenu",e),t.removeEventListener("wheel",n),t.removeEventListener("mousedown",r),t.removeEventListener("mousemove",o),t.removeEventListener("mouseup",c),window.removeEventListener("keydown",l),window.removeEventListener("keyup",g)}}move({x:t=0,y:e=0,zoom:s}){(t||e)&&this.canMove(t,e)&&(this.world.scrollLeft+=t*this.fontSize/2,this.world.scrollTop+=e*this.fontSize/2),s&&(s<0?this.fontSize=Math.max(bh,this.fontSize*.9):this.fontSize=Math.min(Ih,this.fontSize*1.1),this.zoom(),this.hasMoved=!0)}getStaticEntityEmoji(t){switch(t){case h.Tower:return"🗼";case h.Wall:return"🧱";case h.Mortar:return"🛰️";case h.Flamethrower:return"🧯";case h.Railgun:return"🌡️";case h.ElectricFence:return"⚡";case h.Fence:return"🥅";case h.Freezer:return"🦠";case h.Base:return"⛺";case h.Tree:return"🌲";case h.Stump:return"🪵";case h.Rock:return"🪨";case h.Radar:return"📡";case h.PowerPlant:return"🏭";case h.None:return"❌";case h.Armory:case h.Barracks:return"🏰";case h.Market:return"🏪";case h.SpeedBeacon:return"⏰";case h.DamageBeacon:return"🚨";case h.Laser:return"🔭";case h.Tesla:return"💡";default:return"❓"}}getEntityEmoji(t){return this.getEntityTypeEmoji(t.getAgent().getType())}getEntityTypeEmoji(t){switch(t){case h.Slime:return"🐞";case h.Bullet:case h.Rocket:return"▪";case h.Rail:case h.LaserBeam:return"⬛";case h.Flame:return"🔥";case h.Shockwave:return"🌀";case h.Runner:return"🪳";case h.Flier:return"🐝";case h.Tank:return"🦀";case h.WavePoint:return"🪙";case h.Spark:return"⚡️";case h.Behemoth:return"🦎";case h.Bore:return"🐙";default:return""}}getBBox(){const t=this.world.scrollTop/this.yStep,e=this.world.scrollLeft/this.xStep,s=this.world.clientHeight/this.yStep,n=this.world.clientWidth/this.xStep;return[[e,t],[e+n,t+s]]}};const Qe=new Mt;Qe.name="Floor";const ks=new fe(void 0,{position:!1},void 0,!0);ks.name="Static";const Tt=new Mt;Tt.name="Base";const me=new fe(void 0,{position:!1},void 0,!0);me.name="Foliage";const Gt=new Mt;Gt.name="Projectiles";const bt=new Mt;bt.name="Towers";const Te=new Mt;Te.name="UI";const Ji=[Qe,ks,Tt,me,Gt,bt,Te],y=32,Qi=20,Th=3,kh=.5,si=1,T="atlas";var S=(i=>(i.SporeParticle="atlas5.png",i.ActiveCoverage="atlas1.png",i.Coverage="atlas2.png",i.Alert="atlas3.png",i.Entity="atlas4.png",i.None="atlas0.png",i.Coin="atlas6.png",i.Runner="atlas7.png",i.Regular="atlas8.png",i.Flier="atlas9.png",i.Tank="atlas10.png",i.Behemoth="atlas11.png",i.Bore="atlas12.png",i.Fence="fence-00000000",i.ElectricFence="fence-00000000",i.Wall="wall-00000000",i.Tar="buildings11.png",i.DamageBeacon="buildings5.png",i.SpeedBeacon="buildings6.png",i.Base="buildings0.png",i.Barracks="buildings1.png",i.PowerPlant="buildings2.png",i.Radar="buildings3.png",i.Market="buildings4.png",i.Bullet="projectiles0.png",i.Fire="projectiles1.png",i.Rocket="projectiles2.png",i.Laser="projectiles3.png",i.Rail="projectiles4.png",i.Shockwave="projectiles5.png",i.Pine="foliage0.png",i.Tree="foliage1.png",i.Stump="foliage2.png",i.Cactus="foliage3.png",i.Rock="foliage5.png",i.RockAlt="foliage7.png",i.Lightning="lightning0.png",i.Frame="buildings10.png",i.FrameSpeed="buildings8.png",i.FrameDamage="buildings9.png",i.FrameSpeedDamage="buildings7.png",i.BarracksBlueprint="buildings12.png",i.PowerPlantBlueprint="buildings13.png",i.RadarBlueprint="buildings14.png",i.MarketBlueprint="buildings15.png",i.TowerBlueprint="buildings16.png",i.FlamethrowerBlueprint="buildings17.png",i.LaserBlueprint="buildings18.png",i.MortarBlueprint="buildings19.png",i.RailgunBlueprint="buildings20.png",i.TeslaBlueprint="buildings21.png",i.WallBlueprint="buildings22.png",i.FenceBlueprint="atlas13.png",i))(S||{});const Ph="base-1111",_h=new Map([[h.DamageBeacon,S.DamageBeacon],[h.SpeedBeacon,S.SpeedBeacon],[h.Freezer,S.Tar]]);class sa extends X{constructor(t,e){super(e.assets[T].textures[_h.get(t.getType())??Ph]),this.data=t}sync(){this.position.set(this.data.entity.getX()*y,this.data.entity.getY()*y),this.angle=this.data.entity.getRotation()}}a(sa,"layer",Tt);const tn=new Map([[h.Armory,[T,S.BarracksBlueprint]],[h.Barracks,[T,S.BarracksBlueprint]],[h.PowerPlant,[T,S.PowerPlantBlueprint]],[h.Radar,[T,S.RadarBlueprint]],[h.Market,[T,S.MarketBlueprint]],[h.DamageBeacon,[T,S.DamageBeacon]],[h.SpeedBeacon,[T,S.SpeedBeacon]],[h.Freezer,[T,S.Tar]],[h.Fence,[T,S.FenceBlueprint]],[h.Wall,[T,S.WallBlueprint]],[h.ElectricFence,[T,S.FenceBlueprint]],[h.Tower,[T,S.TowerBlueprint]],[h.Flamethrower,[T,S.FlamethrowerBlueprint]],[h.Mortar,[T,S.MortarBlueprint]],[h.Laser,[T,S.LaserBlueprint]],[h.Railgun,[T,S.RailgunBlueprint]],[h.Tesla,[T,S.TeslaBlueprint]],[h.None,[T,S.None]]]);class ia extends X{constructor(t,e){const s=t.getPlaceable().entityType;if(!tn.has(s))throw new Error(`Missing blueprint sprite for ${s}`);const[n,r]=tn.get(s);super(e.assets[n].textures[r]),this.data=t,s===h.None&&this.scale.set(t.getScale()),this.alpha=.7,this.position.set(this.data.entity.getX()*y,this.data.entity.getY()*y)}sync(){}}a(ia,"layer",me);const en=20;class Ah extends X{constructor(){super(...arguments);a(this,"speed",0);a(this,"lifetime",0);a(this,"direction",0)}}class na extends fe{constructor(t,e){super(en,{position:!0,scale:!0,rotation:!0,alpha:!0}),this.data=t;for(let s=0;s<en;s++){const n=new Ah(e.assets[T].textures[S.Fire]);n.anchor.set(.5),n.scale.set(1+Math.random()*.3),n.speed=(4+Math.random()*2)*.0017,n.alpha=.8,n.lifetime=Math.floor(Math.random()*25),n.x=this.data.sourceX*y,n.y=this.data.sourceY*y,n.direction=(this.data.entity.getRotation()+20-Math.random()*40)*Math.PI/180,this.addChild(n)}}sync(t){this.children.forEach(e=>{e.x+=Math.sin(e.direction)*e.speed*t*y,e.y+=Math.cos(e.direction)*e.speed*t*y,e.lifetime+=1,e.lifetime>25&&(this.data.renderData.update?(e.lifetime=0,e.x=this.data.sourceX*y,e.y=this.data.sourceY*y,e.direction=(this.data.entity.getRotation()+20-Math.random()*40)*Math.PI/180,e.alpha=.8):(e.lifetime=Math.floor(Math.random()*25),e.alpha=0))}),this.data.renderData.update=!1}}a(na,"layer",Gt);const Ch="explosion",Dh=.2;class jt extends Ot{constructor(t,e,s,n=1){super(Object.values(t.assets[Ch].textures)),this.anchor.set(.5),this.animationSpeed=Dh,this.loop=!1,this.position.set(e*y,s*y),this.scale.set(n),bt.addChild(this),this.onComplete=()=>{bt.removeChild(this)},this.play()}}const Pt=class{constructor(t,e,s){a(this,"ref");a(this,"promise");this.alias=t,this.filter=e;const n=je.play(t,{...s,filters:[e],complete:()=>Pt.soundInstanceCountMap.set(t,Pt.soundInstanceCountMap.get(t)-1)});n instanceof Promise?(n.then(r=>this.ref=r),this.promise=n):this.ref=n}static rateLimitSound(t){const e=this.soundInstanceCountMap.get(t)||0,s=this.soundPlaytimeMap.get(t)||0;if(e>this.MAX_INSTANCES)return!0;const n=performance.now();return s+this.MIN_INTERVAL>n?!0:(this.soundInstanceCountMap.set(t,e+1),this.soundPlaytimeMap.set(t,n),!1)}static getSoundOptions(t){const{x:e,y:s,width:n,height:r,scale:o}=ot.Instance.getViewport(),c=(t.getX()*y-e)/(n/2),l=(t.getY()*y-s)/(r/2),g=1/(1+(Math.max(0,Math.abs(c)-1)+Math.max(0,Math.abs(l)-1))*3),p=Math.min(o,si)/si*g,d=Math.min(1,Math.max(0,Math.abs(c)-.5))*Math.sign(c);return{volume:p,pan:d}}static fromEntity(t,e,s){const{volume:n,pan:r}=Pt.getSoundOptions(t);if(!(n<.25)&&!this.rateLimitSound(e))return new Pt(e,new _a.StereoFilter(r),{...s,volume:n})}destroy(){var t;this.ref?(t=this.ref)==null||t.destroy():this.promise.then(e=>e.destroy()),Pt.soundInstanceCountMap.set(this.alias,Pt.soundInstanceCountMap.get(this.alias)-1)}update(t){if(this.ref){const{volume:e,pan:s}=Pt.getSoundOptions(t);this.ref.volume=e,this.filter.pan=s}}fade(t,e=500){return this.ref?(this.ref.volume-=t/e*.8,this.ref.volume<.2?(this.destroy(),!0):!1):!1}};let G=Pt;a(G,"soundInstanceCountMap",new Map),a(G,"soundPlaytimeMap",new Map),a(G,"MAX_INSTANCES",3),a(G,"MIN_INTERVAL",100);var N=(i=>(i.Notification="notificationSnd",i.Shot="shotSnd",i.Laser="laserSnd",i.Flamethrower="flamethrowerSnd",i.Mortar="mortarSnd",i.Railgun="railgunSnd",i.Explosion="explosionSnd",i.Firework="fireworkSnd",i.Place="placeSnd",i.Destroy="destroySnd",i.Hit="hitSnd",i.Sonar="sonarSnd",i.Thunder="thunderSnd",i.Bush="bushSnd",i.Tank="tankSnd",i.Drill="drillSnd",i))(N||{});const Bh={notificationSnd:"/open-td/sounds/notification.ogg",shotSnd:"/open-td/sounds/shot.wav",laserSnd:"/open-td/sounds/laser.mp3",flamethrowerSnd:"/open-td/sounds/flamethrower.wav",mortarSnd:"/open-td/sounds/mortar.wav",railgunSnd:"/open-td/sounds/railgun.mp3",explosionSnd:"/open-td/sounds/explosion.wav",fireworkSnd:"/open-td/sounds/firework.wav",placeSnd:"/open-td/sounds/place.wav",destroySnd:"/open-td/sounds/destroy.wav",hitSnd:"/open-td/sounds/hit.wav",sonarSnd:"/open-td/sounds/sonar.wav",thunderSnd:"/open-td/sounds/thunder.wav",bushSnd:"/open-td/sounds/bush.mp3",tankSnd:"/open-td/sounds/tank.wav",drillSnd:"/open-td/sounds/drill.wav"},St=(i,t)=>{je.volume(i,t)},Rh=()=>{St("shotSnd",.7),St("laserSnd",.5),St("flamethrowerSnd",.1),St("mortarSnd",.7),St("railgunSnd",.7),St("placeSnd",.7),St("destroySnd",.7),St("sonarSnd",.7),St("thunderSnd",.7),St("tankSnd",.4)},ns=(i,t,e)=>P.Instance.addEventListener(i,()=>je.play(t,e));var Lt=(i=>(i[i.small=8]="small",i[i.medium=16]="medium",i[i.large=32]="large",i))(Lt||{});const Kt=i=>{const t=new gs;return t.fill.color=0,t.fill.alpha=.4,t.fill.visible=!0,t.drawCircle(0,0,i),Qe.addChild(t),t},qt=i=>{Qe.removeChild(i)},Oh=.2,Lh=1/4,Fh=1/8,Yh=.0015,Ti=class extends Ot{constructor(e,s){super(Object.values(s.assets[Ti.atlas].textures));a(this,"shadow");a(this,"flames",[]);a(this,"oldOffset",0);this.data=e,this.container=s,this.anchor.set(.5),this.animationSpeed=Oh,this.shadow=Kt(Lt.small),this.play(),this.on("removed",()=>{qt(this.shadow),new jt(s,e.entity.getX()+.5,e.entity.getY()+.5)})}sync(){const e=Yh*(1+this.data.entity.getId()%13/13),s=.5+Math.sin((ot.Instance.getTime()+this.data.entity.getId())*e)/4-Fh,n=.5+Math.cos((ot.Instance.getTime()+this.data.entity.getId())*e)/2-Lh;if(this.position.set((this.data.entity.getX()+s)*y,(this.data.entity.getY()+n)*y),this.shadow.position.set((this.data.entity.getX()+.5)*y,(this.data.entity.getY()+.5)*y),this.angle=this.data.entity.getRotation(),this.data.AI.isBusy()){const o=this.angle;this.angle+=Math.sin(ot.Instance.getTime()%Z/Z*5)*20,Math.sign(this.angle)!==Math.sign(o)&&G.fromEntity(this.data.entity,N.Hit)}if(this.angle=this.data.entity.getRotation(),this.data.AI.isAttacking()){const o=Math.sin(ot.Instance.getTime()%Z/Z*5)*20;this.angle+=o,Math.sign(o)===1&&Math.sign(this.oldOffset)===-1&&G.fromEntity(this.data.entity,N.Hit),this.oldOffset=o}else this.oldOffset=0;const r=y/2;if(this.flames.forEach(o=>{o.angle=-this.data.entity.getRotation(),o.position.set(Math.random()*r-r/2,Math.random()*r-r/2)}),this.data.getStatus()===b.OnFire&&!this.flames.length){this.tint=14833698;for(let o=0;o<2;o++){const c=new X(this.container.assets[T].textures[S.Fire]);c.alpha=.8,c.anchor.set(.5),c.position.set(Math.random()*r-r/2,Math.random()*r-r/2),this.addChild(c),this.flames.push(c)}}else this.data.getStatus()!==b.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[])}};let Ce=Ti;a(Ce,"layer",bt),a(Ce,"atlas","flier");const Ys=16;class aa extends ai{constructor(e,s){super(s.assets[T].textures[S.Laser],Ys,Ys);a(this,"tileOffset",0);this.data=e,this.pivot={x:Ys/2,y:0}}sync(){this.tilePosition.y=this.tileOffset,this.tileOffset+=.5;const e=this.data.entity.getX(),s=this.data.entity.getY(),n=Math.sqrt((e-this.data.targetX)**2+(s-this.data.targetY)**2);this.height=n*y,this.alpha=Math.min(1,1-this.data.time/ms+.1),this.position.set(this.data.entity.getX()*y,this.data.entity.getY()*y),this.angle=this.data.entity.getRotation()-90}}a(aa,"layer",Gt);const $s=16;class ra extends ai{constructor(t,e){super(e.assets[T].textures[S.Rail],$s,$s),this.data=t,this.pivot={x:$s/2,y:0}}sync(){const t=this.data.entity.getX(),e=this.data.entity.getY(),s=Math.sqrt((t-this.data.targetX)**2+(e-this.data.targetY)**2);this.height=s*y,this.alpha=Math.min(1,1-this.data.time/li+.1),this.position.set(this.data.entity.getX()*y,this.data.entity.getY()*y),this.angle=this.data.entity.getRotation()-90}}a(ra,"layer",Gt);const $h=.1,sn=1/4,ki=class extends Ot{constructor(e,s){super(Object.values(s.assets[ki.atlas].textures));a(this,"shadow");a(this,"flames",[]);a(this,"oldOffset",0);this.data=e,this.container=s,this.anchor.set(.5),this.animationSpeed=$h,this.shadow=Kt(Lt.medium),this.on("removed",()=>{qt(this.shadow),new jt(s,e.entity.getX()+.5,e.entity.getY()+.5)}),this.play()}sync(){const e=.5+this.data.entity.getId()%13/26-sn,s=.5+(this.data.entity.getId()+5)%17/34-sn;if(this.position.set((this.data.entity.getX()+e)*y,(this.data.entity.getY()+s)*y),this.shadow.position.copyFrom(this.position),this.angle=this.data.entity.getRotation(),this.data.AI.isAttacking()){const r=Math.sin(ot.Instance.getTime()%Z/Z*5)*20;this.angle+=r,Math.sign(r)===1&&Math.sign(this.oldOffset)===-1&&G.fromEntity(this.data.entity,N.Hit),this.oldOffset=r}this.data.AI.isBusy()===this.playing&&(this.playing?this.stop():(this.play(),this.oldOffset=0));const n=y/2;if(this.flames.forEach(r=>{r.angle=-this.data.entity.getRotation(),r.position.set(Math.random()*n-n/2,Math.random()*n-n/2)}),this.data.getStatus()===b.OnFire&&!this.flames.length){this.tint=14833698;for(let r=0;r<2;r++){const o=new X(this.container.assets[T].textures[S.Fire]);o.alpha=.8,o.anchor.set(.5),o.position.set(Math.random()*n-n/2,Math.random()*n-n/2),this.addChild(o),this.flames.push(o)}}else this.data.getStatus()!==b.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[])}};let De=ki;a(De,"layer",Tt),a(De,"atlas","regular");const Xh=.1,nn=1/4,Pi=class extends Ot{constructor(e,s){super(Object.values(s.assets[Pi.atlas].textures));a(this,"shadow");a(this,"flames",[]);a(this,"oldOffset",0);this.data=e,this.container=s,this.anchor.set(.5),this.animationSpeed=Xh,this.shadow=Kt(Lt.medium),this.on("removed",()=>{qt(this.shadow),new jt(s,e.entity.getX()+.5,e.entity.getY()+.5)}),this.play()}sync(){const e=.5+this.data.entity.getId()%13/26-nn,s=.5+(this.data.entity.getId()+5)%17/34-nn;if(this.position.set((this.data.entity.getX()+e)*y,(this.data.entity.getY()+s)*y),this.shadow.position.copyFrom(this.position),this.angle=this.data.entity.getRotation(),this.data.AI.isAttacking()){const r=Math.sin(ot.Instance.getTime()%Z/Z*5)*20;this.angle+=r,Math.sign(r)===1&&Math.sign(this.oldOffset)===-1&&G.fromEntity(this.data.entity,N.Hit),this.oldOffset=r}this.data.AI.isBusy()===this.playing&&(this.playing?this.stop():(this.play(),this.oldOffset=0));const n=y/2;if(this.flames.forEach(r=>{r.angle=-this.data.entity.getRotation(),r.position.set(Math.random()*n-n/2,Math.random()*n-n/2)}),this.data.getStatus()===b.OnFire&&!this.flames.length){this.tint=14833698;for(let r=0;r<2;r++){const o=new X(this.container.assets[T].textures[S.Fire]);o.alpha=.8,o.anchor.set(.5),o.position.set(Math.random()*n-n/2,Math.random()*n-n/2),this.addChild(o),this.flames.push(o)}}else this.data.getStatus()!==b.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[])}};let Be=Pi;a(Be,"layer",Tt),a(Be,"atlas","runner");const Nh=S.Bullet,Uh=new Map([[h.Bullet,S.Bullet],[h.Flame,S.Fire],[h.Rocket,S.Rocket],[h.Shockwave,S.Shockwave]]);class vs extends X{constructor(t,e){super(e.assets[T].textures[Uh.get(t.getType())??Nh]),this.data=t,this.pivot={x:8,y:8}}sync(){this.position.set(this.data.entity.getX()*y,this.data.entity.getY()*y),this.angle=this.data.entity.getRotation()}}a(vs,"layer",Gt);const Wh=.1,an=1/4,_i=class extends Ot{constructor(e,s){super(Object.values(s.assets[_i.atlas].textures));a(this,"shadow");a(this,"flames",[]);a(this,"oldOffset",0);this.data=e,this.container=s,this.anchor.set(.5),this.animationSpeed=Wh,this.shadow=Kt(Lt.medium),this.on("removed",()=>{qt(this.shadow),new jt(s,e.entity.getX()+.5,e.entity.getY()+.5)}),this.play()}sync(){const e=.5+this.data.entity.getId()%13/26-an,s=.5+(this.data.entity.getId()+5)%17/34-an;if(this.position.set((this.data.entity.getX()+e)*y,(this.data.entity.getY()+s)*y),this.shadow.position.copyFrom(this.position),this.angle=this.data.entity.getRotation(),this.data.AI.isAttacking()){const r=Math.sin(ot.Instance.getTime()%Z/Z*5)*20;this.angle+=r,Math.sign(r)===1&&Math.sign(this.oldOffset)===-1&&G.fromEntity(this.data.entity,N.Hit),this.oldOffset=r}this.data.AI.isBusy()===this.playing&&(this.playing?this.stop():(this.play(),this.oldOffset=0));const n=y/2;if(this.flames.forEach(r=>{r.angle=-this.data.entity.getRotation(),r.position.set(Math.random()*n-n/2,Math.random()*n-n/2)}),this.data.getStatus()===b.OnFire&&!this.flames.length){this.tint=14833698;for(let r=0;r<2;r++){const o=new X(this.container.assets[T].textures[S.Fire]);o.alpha=.8,o.anchor.set(.5),o.position.set(Math.random()*n-n/2,Math.random()*n-n/2),this.addChild(o),this.flames.push(o)}}else this.data.getStatus()!==b.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[])}};let Re=_i;a(Re,"layer",Tt),a(Re,"atlas","tank");const Hh=new Map([[h.Tower,"turret"],[h.Flamethrower,"flamethrower"],[h.Laser,"laser"],[h.Mortar,"mortar"],[h.Railgun,"railgun"],[h.Tesla,"tesla"]]),rn=new Map([[h.Tower,N.Shot],[h.Flamethrower,N.Flamethrower],[h.Laser,N.Laser],[h.Mortar,N.Mortar],[h.Railgun,N.Railgun],[h.Tesla,N.Thunder]]),zh=new Set([h.Flamethrower,h.Laser]),Vh=.1,Gh=.6,on=(i,t)=>i?t?S.FrameSpeedDamage:S.FrameSpeed:t?S.FrameDamage:S.Frame;class $t extends X{constructor(e,s){super(s.assets[T].textures[on(e.isSpeedBoosted(),e.isDamageBoosted())]);a(this,"turret");a(this,"sound");this.data=e,this.container=s;const[n,r]=xt(e);this.position.set(n*y,r*y),this.pivot={x:y,y},this.createTurret()}createTurret(){const e=Hh.get(this.data.getType());this.turret=new Ot(Object.values(this.container.assets[e].textures)),this.turret.position.set(this.x,this.y),this.turret.pivot={x:y,y},this.turret.animationSpeed=Vh,this.turret.loop=!1,this.turret.onComplete=()=>{this.turret.gotoAndStop(0)},bt.addChild(this.turret),this.on("removed",()=>{bt.removeChild(this.turret),this.sound&&this.sound.destroy()})}sync(e,s){s&&(this.texture=this.container.assets[T].textures[on(this.data.isSpeedBoosted(),this.data.isDamageBoosted())]),this.turret.angle=go(this.turret.angle,this.data.entity.getRotation(),Gh*e),this.data.renderData.fired?(this.data.renderData.fired=!1,this.turret.play(),zh.has(this.data.getType())?this.sound?this.sound.update(this.data.entity):this.sound=G.fromEntity(this.data.entity,rn.get(this.data.getType()),{loop:!0}):G.fromEntity(this.data.entity,rn.get(this.data.getType()))):this.sound&&this.sound.fade(e)&&(this.sound=void 0)}}a($t,"layer",Tt);class oa extends vs{constructor(e,s){super(e,s);a(this,"shadow");this.data=e,this.shadow=Kt(Lt.small),this.on("removed",()=>{qt(this.shadow),new jt(s,e.entity.getX(),e.entity.getY(),2),G.fromEntity(e.entity,N.Explosion)})}sync(){super.sync(),this.shadow.position.set(this.data.entity.getX()*y,this.data.straightY*y);const e=1-Math.abs(this.data.getPercentage()-.5)*.8;this.shadow.scale.set(e)}}a(oa,"layer",bt);const hn=75,cn=1e3;class jh extends X{constructor(){super(...arguments);a(this,"speed",Math.random()*.002)}}var Us;let Kh=(Us=class extends Mt{constructor(e,s){super();a(this,"container");a(this,"sprite");a(this,"time",0);if(this.data=e,this.sprite=new X(s.assets[T].textures[S.Coin]),this.sprite.anchor.set(.5),e.amount>1){const n=new X(s.assets[T].textures[S.Coin]);n.anchor.set(.25),this.sprite.addChild(n)}this.container=new fe(hn,{alpha:!0});for(let n=0;n<hn;n++){const r=new jh(s.assets[T].textures[S.SporeParticle]),o=n%25/25*Math.PI*2,c=Math.floor(n/25)*.75+.25;r.anchor.set(.5),r.alpha=.9,r.x=(this.data.sourceX+Math.sin(o)*c)*y,r.y=(this.data.sourceY+Math.cos(o)*c)*y,this.container.addChild(r)}this.addChild(this.sprite,this.container),G.fromEntity(this.data.entity,N.Firework)}sync(e){this.sprite.position.set(this.data.entity.getX()*y,this.data.entity.getY()*y),this.sprite.angle=this.data.entity.getRotation(),this.container.children.forEach((s,n)=>{const r=n%25/25*Math.PI*2;s.x+=Math.sin(r)*s.speed*e*y,s.y+=Math.cos(r)*s.speed*e*y,s.alpha=.9-this.time/cn*.8}),this.time+=e,this.time>cn&&this.removeChild(this.container)}},a(Us,"layer",Te),Us);const ln=32,qh=96;class ha extends Mt{constructor(e,s){super();a(this,"sprites",[]);this.data=e;let n=e.entity.getX(),r=e.entity.getY();for(let o of this.data.getChain()){const c=o.entity.getX()+.5,l=o.entity.getY()+.5,g=new ai(s.assets[T].textures[S.Lightning],ln,qh);g.pivot={x:ln/2,y:0};const p=Math.sqrt((n-c)**2+(r-l)**2);g.height=p*y,g.position.set(n*y,r*y),g.rotation=Math.atan2(r-l,n-c)+Math.PI/2,n=c,r=l,this.addChild(g),this.sprites.push(g)}}sync(){this.alpha=Math.min(1,1-this.data.time/Js+.1),this.sprites.forEach(e=>e.tilePosition.y=Math.floor(this.data.time/Js*5)*32)}}a(ha,"layer",Gt);const pt=class extends X{constructor(e,s){super();a(this,"_x");a(this,"_y");a(this,"entityScale");a(this,"prefix");this.container=s,this._x=e.entity.getAlignedX(),this._y=e.entity.getAlignedY(),this.entityScale=At(e),this.prefix=pt.entityMap.get(e.getType()),this.position.set(this._x*y-pt.padding*this.entityScale,this._y*y-pt.padding*this.entityScale)}sync(e,s){s&&this.updateTexture()}updateTexture(){const e=u.Instance.getSurface(),s=new Array(8);for(let n=0;n<8;n+=2){const r=e.getTile(this._x+pt.neighbors[n][0]*this.entityScale,this._y+pt.neighbors[n][1]*this.entityScale);s[n]=r&&pt.types.has(r.getType())&&At(r.getStaticEntity().getAgent())===this.entityScale?"1":"0"}for(let n=1;n<8;n+=2){if(s[(n+1)%8]==="1"||s[(n+7)%8]==="1"){s[n]="0";continue}const r=e.getTile(this._x+pt.neighbors[n][0]*this.entityScale,this._y+pt.neighbors[n][1]*this.entityScale);s[n]=r&&pt.types.has(r.getType())&&At(r.getStaticEntity().getAgent())===this.entityScale?"1":"0"}this.texture=this.container.assets[T].textures[this.prefix+s.join("")]}};let Et=pt;a(Et,"layer",ks),a(Et,"entityMap",new Map([[h.Wall,"wall-"],[h.Fence,"fence-"],[h.ElectricFence,"fence-"]])),a(Et,"neighbors",[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]]),a(Et,"padding",4),a(Et,"types",new Set([f.Fence,f.Wall,f.ElectricFence]));const Nt=class extends X{constructor(e,s,n){super(e);a(this,"direction");a(this,"velocity",0);a(this,"bounceForce",10);a(this,"time",0);a(this,"tick",e=>{if(this.time+=e,this.time>Nt.lifetime){bt.removeChild(this),Li.shared.remove(this.tick);return}this.time>Nt.fadeTime&&(this.alpha=1-(this.time-Nt.fadeTime)/Nt.fadeTime),this.bounceForce>2&&(this.velocity+=this.direction,this.rotation+=this.velocity,(this.rotation>Math.PI/2||this.rotation<-Math.PI/2)&&(this.velocity=-this.direction*this.bounceForce,this.bounceForce/=2))});this.anchor.set(.5,1),this.position.set((s+.5)*y,(n+1)*y),this.direction=Math.sign(Math.random()-.5)/80,this.velocity=0,Li.shared.add(this.tick,void 0,Aa.LOW),bt.addChild(this)}};let Oe=Nt;a(Oe,"lifetime",40),a(Oe,"fadeTime",Nt.lifetime*.8);const Is=class extends X{constructor(t,e){super(e.assets[T].textures[Is.entityMap.get(t.getType())[t.renderData.subType||0]]),this.position.set(t.entity.getX()*y,(t.entity.getY()+Is.verticalOffset)*y),this.on("removed",()=>{t.renderData.chopped&&t.getType()===h.Tree&&t.renderData.subType!==Xe.Cactus&&(G.fromEntity(t.entity,N.Bush),new Oe(this.texture,t.entity.getX(),t.entity.getY()))})}sync(){}};let Xt=Is;a(Xt,"layer",me),a(Xt,"entityMap",new Map([[h.Tree,[S.Tree,S.Pine,S.Cactus]],[h.Stump,[S.Stump]],[h.Rock,[S.Rock,S.RockAlt]]])),a(Xt,"verticalOffset",-.5);const Ai=class extends X{constructor(t,e){super(e.assets[T].textures[S.Stump]),this.position.set(t.entity.getX()*y,(t.entity.getY()+Ai.verticalOffset)*y)}sync(){}};let Le=Ai;a(Le,"layer",ks),a(Le,"verticalOffset",-.5);const Ve=class extends X{constructor(e,s){super();a(this,"_x");a(this,"_y");this.container=s,this._x=e.entity.getAlignedX(),this._y=e.entity.getAlignedY();const n=Ve.entityToAtlasMap.get(e.getType());if(n){const r=new X(this.container.assets[T].textures[n]);r.anchor.set(.5),r.position.set(y,y),this.addChild(r)}this.position.set(this._x*y,this._y*y),this.updateTexture()}sync(e,s){s&&this.updateTexture()}updateTexture(){const e=u.Instance.getSurface();let s="base-";for(let n=0;n<4;n++){const r=e.getTile(this._x+Ve.neighbors[n][0],this._y+Ve.neighbors[n][1]);s+=r!=null&&r.hasStaticEntity()&&Je.has(r.getStaticEntity().getAgent().getType())?"0":"1"}this.texture=this.container.assets[T].textures[s]}};let se=Ve;a(se,"layer",Tt),a(se,"neighbors",[[0,-2],[2,0],[0,2],[-2,0]]),a(se,"entityToAtlasMap",new Map([[h.Base,S.Base],[h.Armory,S.Barracks],[h.Barracks,S.Barracks],[h.PowerPlant,S.PowerPlant],[h.Radar,S.Radar],[h.Market,S.Market]]));const Zh=.075,un=1/4,Ci=class extends Ot{constructor(e,s){super(Object.values(s.assets[Ci.atlas].textures));a(this,"shadow");a(this,"flames",[]);a(this,"oldOffset",0);this.data=e,this.container=s,this.anchor.set(.5),this.animationSpeed=Zh,this.shadow=Kt(Lt.large),this.scale.set(2),this.on("removed",()=>{qt(this.shadow),new jt(s,e.entity.getX()+1,e.entity.getY()+1)}),this.play()}sync(){const e=1+this.data.entity.getId()%13/26-un,s=1+(this.data.entity.getId()+5)%17/34-un;if(this.position.set((this.data.entity.getX()+e)*y,(this.data.entity.getY()+s)*y),this.shadow.position.copyFrom(this.position),this.angle=this.data.entity.getRotation(),this.data.AI.isAttacking()){const r=Math.sin(ot.Instance.getTime()%Z/Z*5)*20;this.angle+=r,Math.sign(r)===1&&Math.sign(this.oldOffset)===-1&&G.fromEntity(this.data.entity,N.Hit),this.oldOffset=r}this.data.AI.isBusy()===this.playing&&(this.playing?this.stop():(this.play(),this.oldOffset=0));const n=y/2;if(this.flames.forEach(r=>{r.angle=-this.data.entity.getRotation(),r.position.set(Math.random()*n-n/2,Math.random()*n-n/2)}),this.data.getStatus()===b.OnFire&&!this.flames.length){this.tint=14833698;for(let r=0;r<2;r++){const o=new X(this.container.assets[T].textures[S.Fire]);o.alpha=.8,o.anchor.set(.5),o.position.set(Math.random()*n-n/2,Math.random()*n-n/2),this.addChild(o),this.flames.push(o)}}else this.data.getStatus()!==b.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[])}};let Fe=Ci;a(Fe,"layer",Tt),a(Fe,"atlas","runner");const Jh=.075,dn=1/4,Di=class extends Ot{constructor(e,s){super(Object.values(s.assets[Di.atlas].textures));a(this,"shadow");a(this,"flames",[]);a(this,"sound");a(this,"wasAttacking",!1);this.data=e,this.container=s,this.anchor.set(.5),this.animationSpeed=Jh,this.shadow=Kt(Lt.large),this.scale.set(2),this.sound=G.fromEntity(this.data.entity,N.Tank,{loop:!0}),this.on("removed",()=>{var n;(n=this.sound)==null||n.destroy(),qt(this.shadow),new jt(s,e.entity.getX()+1,e.entity.getY()+1)}),this.play()}sync(){this.sound&&this.sound.update(this.data.entity),this.data.AI.isAttacking()&&!this.wasAttacking&&G.fromEntity(this.data.entity,N.Drill),this.wasAttacking=this.data.AI.isAttacking();const e=1+this.data.entity.getId()%13/26-dn,s=1+(this.data.entity.getId()+5)%17/34-dn;this.position.set((this.data.entity.getX()+e)*y,(this.data.entity.getY()+s)*y),this.shadow.position.copyFrom(this.position),this.angle=this.data.entity.getRotation();const n=y/2;if(this.flames.forEach(r=>{r.angle=-this.data.entity.getRotation(),r.position.set(Math.random()*n-n/2,Math.random()*n-n/2)}),this.data.getStatus()===b.OnFire&&!this.flames.length){this.tint=14833698;for(let r=0;r<2;r++){const o=new X(this.container.assets[T].textures[S.Fire]);o.alpha=.8,o.anchor.set(.5),o.position.set(Math.random()*n-n/2,Math.random()*n-n/2),this.addChild(o),this.flames.push(o)}}else this.data.getStatus()!==b.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[])}};let Ye=Di;a(Ye,"layer",Tt),a(Ye,"atlas","bore");const Qh={runner:"/open-td/animations/runner.json",regular:"/open-td/animations/regular.json",flier:"/open-td/animations/flier.json",tank:"/open-td/animations/tank.json",turret:"/open-td/animations/turret.json",flamethrower:"/open-td/animations/flamethrower.json",laser:"/open-td/animations/laser.json",mortar:"/open-td/animations/mortar.json",railgun:"/open-td/animations/railgun.json",explosion:"/open-td/animations/explosion.json",tesla:"/open-td/animations/tesla.json",bore:"/open-td/animations/bore.json"},tc={[h.Runner]:Be,[h.Slime]:De,[h.Flier]:Ce,[h.Tank]:Re,[h.Behemoth]:Fe,[h.Bore]:Ye,[h.Tower]:$t,[h.Flamethrower]:$t,[h.Laser]:$t,[h.Mortar]:$t,[h.Railgun]:$t,[h.Bullet]:vs,[h.Flame]:na,[h.Rocket]:oa,[h.Shockwave]:vs,[h.LaserBeam]:aa,[h.Rail]:ra,[h.Fence]:Et,[h.Wall]:Et,[h.ElectricFence]:Et,[h.Blueprint]:ia,[h.WavePoint]:Kh,[h.Spark]:ha,[h.Tesla]:$t,[h.Tree]:Xt,[h.Stump]:Le,[h.Rock]:Xt,[h.Freezer]:null,...[...Je].reduce((i,t)=>({...i,[t]:se}),{})};class ec extends X{constructor(t,e,s){super(s),this.offset=t,this.path=e;const{x:n,y:r}=this.path.getCoordinates(this.offset%this.path.getLength());this.position.set(n*y,r*y)}move(){this.offset+=.1;const{x:t,y:e}=this.path.getCoordinates(this.offset%this.path.getLength());this.position.set(t*y,e*y)}}class sc extends X{constructor(){super(...arguments);a(this,"originalAlpha",1)}}class ic{constructor(t,e){a(this,"coverageContainer");a(this,"pathContainer");a(this,"towers",new Map);a(this,"hoveredTile");a(this,"visible",!1);this.container=t,this.surface=e,this.coverageContainer=new fe(void 0,{uvs:!0,alpha:!0},void 0,!0),Qe.addChild(this.coverageContainer),this.pathContainer=new fe(void 0,{position:!0},void 0,!0),Te.addChild(this.pathContainer)}show(){this.visible=!0,this.render()}hide(){this.visible=!1,this.coverageContainer.removeChildren(),this.pathContainer.removeChildren()}render(){this.visible&&(this.renderCoverage(),u.Instance.getDifficulty()===K.Easy&&!u.Instance.getIsStarted()&&this.renderPaths())}renderCoverage(){this.coverageContainer.removeChildren(),this.towers.clear(),this.hoveredTile=void 0;const t=this.surface.getHeight();for(let e=0;e<t;e++)this.surface.getRow(e).forEach(s=>{const n=s.getTowers();if(n.length===0||!s.isDiscovered())return;const r=new sc(this.container.assets[T].textures[S.Coverage]);r.originalAlpha=Math.min(.15+.1*n.length,.55),r.alpha=r.originalAlpha,r.position.set(s.getX()*y,s.getY()*y),this.coverageContainer.addChild(r),n.forEach(o=>{const c=this.towers.get(o.getTile().getHash())||[];c.push(r),this.towers.set(o.getTile().getHash(),c)})})}async renderPaths(){this.pathContainer.removeChildren();const t=[];q.Instance.getSpawnGroups().forEach(s=>{t.push(s.getAsyncSpawnPoints())});const e=[];(await Promise.all(t)).forEach(s=>e.push(...s)),e.forEach((s,n)=>{const r=this.slicePath(s),o=Math.max(1,Math.floor(r.getLength()/5));for(let c=0;c<o;c++)this.pathContainer.addChild(new ec(n*2+c*5,r,this.container.assets[T].textures[S.Entity]))})}slicePath(t){let e,s;for(let n=0;n<t.getLength();n++){const r=t.getTile(n);if(r.isDiscovered()||(e=n+1),r.hasStaticEntity()&&Je.has(r.getStaticEntity().getAgent().getType())){s=n;break}}return t.slice(e,s)}update(){var n,r;if(!this.visible)return;u.Instance.getIsStarted()?this.pathContainer.removeChildren():this.pathContainer.children.forEach(o=>o.move());const[t,e]=_t.Instance.getMouse(2),s=this.surface.getTile(t,e);s!==this.hoveredTile&&(this.hoveredTile&&((n=this.towers.get(this.hoveredTile.getHash()))==null||n.forEach(o=>{o.texture=this.container.assets[T].textures[S.Coverage],o.alpha=o.originalAlpha})),s&&((r=this.towers.get(s.getHash()))==null||r.forEach(o=>{o.texture=this.container.assets[T].textures[S.ActiveCoverage],o.alpha=.7})),this.hoveredTile=s)}}const ce=class{constructor(t){a(this,"container");a(this,"alertSymbols",[]);a(this,"time",0);a(this,"permanent",!1);this.assetsContainer=t,this.container=new Mt,Te.addChild(this.container),P.Instance.addEventListener(M.EndWave,()=>this.reset())}enable(){this.permanent=!0,this.container.alpha=1,this.time=ce.displayDuration}disable(){this.permanent=!1,this.time=ce.displayDuration}reset(){this.time=0,this.container.alpha=1}render(t,e){this.alertSymbols=[],this.container.removeChildren();const[s,n]=t,r=Math.PI/128;e.forEach(o=>{const[c,l]=o.getRange(),g=new Mt,p=new gs;p.lineStyle({width:10,color:267386880,cap:Ca.ROUND,alpha:.8,alignment:.5}),p.arc(s*y,n*y,10*y,c*Math.PI/180+r,l*Math.PI/180-r);const d=new X(this.assetsContainer.assets[T].textures[S.Alert]);d.anchor.set(.5),d.scale.set(2),this.alertSymbols.push(d);const v=new Mt,w=o.getCenter(),I=w*Math.PI/180;v.position.set((s+Math.cos(I)*9.2)*y,(n+Math.sin(I)*9.2)*y),v.addChild(d),o.getUnits().forEach((Y,D)=>{const O=new X(this.assetsContainer.assets[T].textures[ce.enemySpriteMap.get(Y)]),E=w>270||w<90?-1:1,C=E>0?16:-48;O.position.set(C+32*D*E,8),v.addChild(O)}),g.addChild(p,v),this.container.addChild(g)})}update(t,e){this.container.alpha<=0||((e||!this.permanent&&this.time>ce.displayDuration)&&(this.container.alpha-=t/500),this.alertSymbols.forEach(s=>{s.alpha=Math.abs(Math.cos(this.time/300))}),this.time+=t)}};let $e=ce;a($e,"displayDuration",20*1e3),a($e,"enemySpriteMap",new Map([[h.Runner,S.Runner],[h.Slime,S.Regular],[h.Tank,S.Tank],[h.Flier,S.Flier],[h.Behemoth,S.Behemoth],[h.Bore,S.Bore]]));const nc=`varying vec2 vTextureCoord;
uniform sampler2D uSampler;

uniform vec2 thickness;
uniform vec4 outlineColor;
uniform vec4 filterClamp;

const float DOUBLE_PI = 3.14159265358979323846264 * 2.;

void main(void) {
    vec4 ownColor = texture2D(uSampler, vTextureCoord);
    vec4 curColor;
    float maxAlpha = 0.;
    vec2 displaced;
    for (float angle = 0.; angle <= DOUBLE_PI; angle += \${angleStep}) {
        displaced.x = vTextureCoord.x + thickness.x * cos(angle);
        displaced.y = vTextureCoord.y + thickness.y * sin(angle);
        curColor = texture2D(uSampler, clamp(displaced, filterClamp.xy, filterClamp.zw));
        maxAlpha = max(maxAlpha, curColor.a);
    }
    float resultAlpha = maxAlpha * step(ownColor.a, 0.0) > 0. ? 1. : 0.0;

    gl_FragColor = vec4(outlineColor.rgb * resultAlpha, resultAlpha);
}
`,Ge=class extends Da{constructor(e=1,s=0,n=.1){super(void 0,nc.replace(/\$\{angleStep\}/,Ge.getAngleStep(n)));a(this,"_thickness",1);this.uniforms.thickness=new Float32Array([0,0]),this.uniforms.outlineColor=new Float32Array([0,0,0,1]),Object.assign(this,{thickness:e,color:s,quality:n})}static getAngleStep(e){if(e===0)return(Math.PI/2).toFixed(7);const s=Math.max(e*Ge.MAX_SAMPLES,Ge.MIN_SAMPLES);return(Math.PI*2/s).toFixed(7)}apply(e,s,n,r){this.uniforms.thickness[0]=this._thickness/s._frame.width,this.uniforms.thickness[1]=this._thickness/s._frame.height,e.applyFilter(this,s,n,r)}get color(){return Ba(this.uniforms.outlineColor)}set color(e){Ra(e,this.uniforms.outlineColor)}get thickness(){return this._thickness}set thickness(e){this._thickness=e,this.padding=e}};let re=Ge;a(re,"MIN_SAMPLES",1),a(re,"MAX_SAMPLES",100);const ac=Intl.NumberFormat(void 0,{maximumFractionDigits:0});class rc{constructor(){a(this,"container");a(this,"rangeGraphic");a(this,"text");a(this,"oldMousePosition","");a(this,"oldMode",Qn.Line);a(this,"oldPlaceable",null);this.rangeGraphic=new gs,this.rangeGraphic.filters=[new re(2,0,0)],this.container=new gs,this.container.filters=[new re(2,0,0)],this.text=new Oa("",{fontFamily:"JupiterCrash",fontSize:24,fill:0,align:"left",dropShadow:!0,dropShadowColor:16777215,dropShadowDistance:2}),Te.addChild(this.rangeGraphic,this.container,this.text)}render(){var p;const t=_t.Instance,e=t.getMouse(),s=t.getMode(),n=t.getPlacable();if(e.join(",")===this.oldMousePosition&&s===this.oldMode&&n===this.oldPlaceable)return;this.oldMousePosition=e.join(","),this.oldMode=s,this.oldPlaceable=n;const r=y*(((p=n==null?void 0:n.entity)==null?void 0:p.scale)||1);this.rangeGraphic.clear(),this.container.clear(),this.container.fill.visible=!0;const o=new Set,c=new Set,l=u.Instance.getSurface();let g;if(n!=null&&n.entity&&(g=n.entity.range),t.isMouseDown())t.getSelection().forEach(d=>{this.container.drawRect(d.getX()*y,d.getY()*y,r,r),g&&l.forCircle(d.getX()+1,d.getY()+1,g,v=>c.add(v)),d.hasStaticEntity()&&o.add(d.getStaticEntity().getAgent())});else{const[d,v]=t.getMouse();this.container.drawRect(d*y,v*y,r,r),g&&l.forCircle(d+1,v+1,g,I=>c.add(I));const w=l.getTile(d,v);w&&w.hasStaticEntity()&&o.add(w.getStaticEntity().getAgent())}this.rangeGraphic.clear().beginFill();for(let d of c)this.rangeGraphic.drawRect(d.getX()*y,d.getY()*y,y,y);if(this.rangeGraphic.endFill(),(n==null?void 0:n.entityType)===h.None){const d=[...o].reduce((v,w)=>v+V.Instance.getValue(w),0);d>0?this.text.text=`Sell for 🪙 ${ac.format(d)}`:this.text.text="",this.text.position.set(e[0]*y,e[1]*y-24)}else this.text.text=""}}const oc={[T]:"/open-td/atlas.json",terrain:"/open-td/tiles/terrain.png",mask:"/open-td/tiles/mask.png"};vn.addBundle("assets",{...Bh,...oc,...Qh});let as;const fi=()=>as||(as=vn.loadBundle("assets"),as);class hc{constructor(){a(this,"assets");a(this,"callback");fi().then(t=>{this.assets=t,this.callback&&this.callback()})}onComplete(t){if(this.assets){t();return}this.callback=t}get loading(){return this.assets===void 0}}const cc=`#version 300 es

precision highp float;

in vec2 vTextureCoord;
uniform sampler2D world;
uniform sampler2D atlas;
uniform sampler2D mask;

uniform float tileSize;
uniform bool textured;
uniform bool blended;
uniform float time;

uniform int bridgeId; // Bridges should not get blended

out vec4 fragmentColor;

void main(){
    // Get dimemsions of all textures.
	highp ivec2 worldSize = textureSize(world, 0);
    highp ivec2 maskSize = textureSize(mask, 0);
    highp ivec2 atlasSize = textureSize(atlas, 0);

    // Get number of atlas columns and rows.
    int atlasColumns = atlasSize.x / int(tileSize);
    int atlasRows = atlasSize.y / int(tileSize);

    // Get position in world texture.
    float wx = vTextureCoord.x * float(worldSize.x);
    float wy = vTextureCoord.y * float(worldSize.y);
    
    // Get position in mask texture.
    float maskRepeat = float(worldSize.x) * tileSize;

    vec4 maskTexel = vec4(0.5);
    if (blended) {
        int mx = int(floor(vTextureCoord.x * maskRepeat)) % maskSize.x;
        int my = int(floor(vTextureCoord.y * maskRepeat)) % maskSize.y;
        maskTexel = texelFetch(mask, ivec2(mx, my), 0);
    }

    // Get atlas id from word texture: world position + mask offset.
    int x = int(floor(wx + (maskTexel.r - 0.5)));
	int y = int(floor(wy + (maskTexel.g - 0.5)));
	int atlasId = int(texelFetch(world, ivec2(x, y), 0)[int(mod(time + float(x) + float(y), 3.0))] * 255.0);

    int unblentAtlasId = int(texelFetch(world, ivec2(int(floor(wx)), int(floor(wy))), 0)[int(mod(time + float(x) + float(y), 3.0))] * 255.0);

    if (unblentAtlasId == bridgeId) {
        atlasId = unblentAtlasId;
    }

    if (atlasId == bridgeId) {
        atlasId = unblentAtlasId;
    }

    if (!textured) {
         wx = floor(wx / tileSize) * tileSize;
         wy = floor(wy / tileSize) * tileSize;
    }

    // Get position in atlas texture.
    float dx = (mod(wx, 1.0) + float(atlasId % atlasColumns)) / float(atlasColumns);
    float dy = (mod(wy, 1.0) + float(atlasId / atlasColumns)) / float(atlasRows);
    ivec2 atlasPos = ivec2(int(dx * float(atlasSize.x)), int(dy * float(atlasSize.y)));

    fragmentColor = texelFetch(atlas, atlasPos, 0);
}
`,lc=`#version 300 es
  
precision highp float;

in vec2 aVertexPosition;
in vec2 aTextureCoord;

uniform mat3 projectionMatrix;
uniform mat3 translationMatrix;
uniform mat3 uTextureMatrix;

out vec2 vTextureCoord;

void main(void) 
{
	gl_Position = vec4((projectionMatrix * translationMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);

	vTextureCoord = (uTextureMatrix * vec3(aTextureCoord, 1.0)).xy; 
}
`;class uc extends La{constructor(e,s=!0,n=!0){super(Hs.EMPTY,{program:new Fa(lc,cc),uniforms:{tileSize:y,bridgeId:f.Bridge,time:0,textured:s,blended:n}});a(this,"canvas");a(this,"context");a(this,"imageData");a(this,"getTileTypes",e=>{switch(e.getDiscoveryStatus()){case $.Discovered:return e.getAnimation();case $.Pending:return[ut.Static1,ut.Static2,ut.Static3];default:return[f.Obstructed]}});this.surface=e,this.canvas=new OffscreenCanvas(this.surface.getWidth(),this.surface.getHeight()),this.context=this.canvas.getContext("2d"),this.imageData=this.context.createImageData(this.surface.getWidth(),this.surface.getHeight()),this.uniforms.world=new Hs(new ri(this.canvas)),fi().then(r=>{this.uniforms.atlas=r.terrain.baseTexture,this.uniforms.mask=r.mask.baseTexture})}render(e=!1){this.surface.getTiles().forEach((s,n)=>{let r=e?s.getAnimation():this.getTileTypes(s);this.imageData.data[n*4]=r[0],this.imageData.data[n*4+1]=r[1]||r[0],this.imageData.data[n*4+2]=r[2]||r[0],this.imageData.data[n*4+3]=255}),this.context.putImageData(this.imageData,0,0),this.uniforms.world.update()}setBlended(e){this.uniforms.blended=e}setTextured(e){this.uniforms.textured=e}setTime(e){this.uniforms.time=e/600}}let rs=!1;ri.defaultOptions.scaleMode=Ya.NEAREST;const Bi=class{constructor(t,e){a(this,"messageFn");a(this,"resolveMessageFn");a(this,"removeEventListeners");a(this,"target");a(this,"app");a(this,"viewport");a(this,"vueApp");a(this,"sprites",new Map);a(this,"assets");a(this,"coverageRenderer");a(this,"alertRenderer");a(this,"cursorRenderer");a(this,"worldShader");a(this,"x",0);a(this,"y",0);a(this,"scale",si);a(this,"width",0);a(this,"height",0);a(this,"time",0);a(this,"showMessage",async(...t)=>{const e=await this.messageFn;return je.play(N.Notification),e(...t)});this.surface=t,this.controller=e,Bi.instance=this,this.messageFn=new Promise(s=>this.resolveMessageFn=s),this.assets=new hc,this.worldShader=new uc(this.surface,!0,!0),Rh(),window.debug=()=>{rs=!rs,this.surface.forceRerender(),this.renderWorld()}}static get Instance(){return this.instance}mount(t){this.target=t,this.app=new $a({resizeTo:window}),t.appendChild(this.app.view),this.width=this.surface.getWidth()*y,this.height=this.surface.getHeight()*y,this.viewport=new Xa({screenWidth:window.innerWidth,screenHeight:window.innerHeight,worldWidth:this.width,worldHeight:this.height,events:this.app.renderer.events}).clamp({direction:"all",underflow:"center"}).drag({wheel:!0,clampWheel:!0,pressDrag:!1}).addListener("moved",({type:o})=>{o!=="animate"&&(this.x=this.viewport.center.x,this.y=this.viewport.center.y)}),this.app.stage.addChild(this.viewport);const e=new Hs(new ri(void 0,{width:1,height:1})),s=new Na(e,2,2);s.width=this.surface.getWidth()*y,s.height=this.surface.getWidth()*y,s.shader=this.worldShader,this.viewport.addChild(s,...Ji),this.coverageRenderer=new ic(this.assets,this.surface),this.alertRenderer=new $e(this.assets),this.cursorRenderer=new rc,this.assets.onComplete(()=>this.renderWorld());const n=t.appendChild(document.createElement("div"));this.vueApp=ii(ea,{register:this.resolveMessageFn}),this.vueApp.mount(n);const r=u.Instance.getBase().getTile();this.x=r.getX()*y,this.y=r.getY()*y,this.viewport.animate({time:0,position:{x:this.x,y:this.y}}),this.registerEventHandlers(),this.updateSettings()}updateSettings(){const t=ke("settings");je.volumeAll=((t==null?void 0:t.volume)??100)/100}renderWorld(){const t=rs||u.Instance.getIsBaseDestroyed();this.worldShader.render(t),this.coverageRenderer.render();const e=xt(u.Instance.getBase()),s=q.Instance.getSpawnAlertRanges();this.alertRenderer.render(e,s)}rerender(t){if(this.assets.loading)return;this.time+=t;const e=rs||u.Instance.getIsBaseDestroyed(),s=this.surface.isDirty();s&&this.renderWorld(),this.worldShader.setTime(this.time);const n=s?this.surface.getEntities():this.surface.getTickingEntities(),r=[...this.surface.getDeletedEntities()];let o=!1;for(let c of n){let l=this.sprites.get(c.getId());const g=c.getAgent().isVisible()||e;if(!l){const p=tc[c.getAgent().getType()];if(p===null||!g)continue;const d=p||sa;l=new d(c.getAgent(),this.assets),l.zIndex=c.getAlignedY(),d.layer.addChild(l),d.layer===me&&(o=!0),this.sprites.set(c.getId(),l)}g?l.sync(t,s):r.push(c)}r.forEach(c=>{const l=this.sprites.get(c.getId());l&&(this.sprites.delete(c.getId()),l.constructor.layer.removeChild(l))}),o&&me.sortChildren(),this.cursorRenderer.render(),this.coverageRenderer.update(),this.alertRenderer.update(t,u.Instance.getIsStarted()),this.surface.markPristine()}showCoverage(){this.coverageRenderer.show(),this.alertRenderer.enable()}hideCoverage(){this.coverageRenderer.hide(),this.alertRenderer.disable()}unmount(){this.app&&(this.vueApp.unmount(),this.app.destroy(!0),this.removeEventListeners(),Ji.forEach(t=>t.removeChildren()))}getTime(){return this.time}registerEventHandlers(){const t=d=>(d.preventDefault(),!1);this.target.addEventListener("contextmenu",t);const e=d=>{const v=Math.floor((d.data.global.x/this.viewport.scale.x+this.viewport.left)/y),w=Math.floor((d.data.global.y/this.viewport.scale.y+this.viewport.top)/y);this.controller.mouseDown(v,w)};this.viewport.addListener("mousedown",e);const s=d=>{const v=Math.floor((d.data.global.x/this.viewport.scale.x+this.viewport.left)/y),w=Math.floor((d.data.global.y/this.viewport.scale.y+this.viewport.top)/y);this.controller.mouseMove(v,w)};this.viewport.addListener("mousemove",s);const n=d=>{const v=Math.floor((d.data.global.x/this.viewport.scale.x+this.viewport.left)/y),w=Math.floor((d.data.global.y/this.viewport.scale.y+this.viewport.top)/y);this.controller.mouseUp(v,w)};this.viewport.addListener("mouseup",n);const r=d=>{this.controller.keyDown(d.key),d.preventDefault()};window.addEventListener("keydown",r);const o=d=>{this.controller.keyUp(d.key),d.preventDefault()};window.addEventListener("keyup",o);const c=ns(M.StartWave,N.Sonar),l=ns(M.Buy,N.Place),g=ns(M.Sell,N.Destroy),p=ns(M.HitBase,N.Destroy);this.removeEventListeners=()=>{window.removeEventListener("contextmenu",t),this.viewport.removeListener("mousedown",e),this.viewport.removeListener("mousemove",s),this.viewport.removeListener("mouseup",n),window.removeEventListener("keydown",r),window.removeEventListener("keyup",o),c(),l(),g(),p()}}move({x:t=0,y:e=0,zoom:s}){s&&(s<0?this.scale=Math.max(kh,this.scale*.9):this.scale=Math.min(Th,this.scale*1.1));const n=this.viewport.worldScreenWidth/2,r=this.viewport.worldScreenHeight/2;(t>0&&this.x<this.width-n||t<0&&this.x>n)&&(this.x+=t*Qi/this.scale),(e>0&&this.y<this.height-r||e<0&&this.y>r)&&(this.y+=e*Qi/this.scale),this.viewport.animate({time:200,position:{x:this.x,y:this.y},scale:this.scale})}getViewport(){var t,e;return{x:this.x,y:this.y,width:((t=this.viewport)==null?void 0:t.worldScreenWidth)||0,height:((e=this.viewport)==null?void 0:e.worldScreenHeight)||0,scale:this.scale}}};let ds=Bi;a(ds,"instance");const ot=ds,dc={True:!0,False:!1},gc=(i,t,e)=>{var s;return((s=Object.entries(i).find(([n,r])=>t===r))==null?void 0:s[0])||e},gn=(i,t,e)=>Object.values(i).find(s=>s===t)??e,pc=(i,t)=>{if(i==="renderer"){const e={emojiRenderer:pi,pixiRenderer:ot};return t in e?e[t]:e.pixiRenderer}return i==="difficulty"?gn(K,t):i==="showTutorial"?gn(dc,t):i==="volume"?ei(t,0,100):i==="simulation"?ei(t,1,3):t},fc=(i,t)=>i==="renderer"?gc({emojiRenderer:pi,pixiRenderer:ot},t,"pixiRenderer"):t,mc={settings:pc,achievements:nh},yc={settings:fc,achievements:ah},ke=i=>{let t;try{t=localStorage.getItem(i)}catch{return null}if(!t)return null;t.startsWith("{")||(t=window.atob(t));try{return JSON.parse(t,mc[i])}catch{return null}},Ps=(i,t,e=!1)=>{const s=ke(i)||{},n=JSON.stringify({...s,...t},yc[i]);try{localStorage.setItem(i,e?window.btoa(n):n)}catch(r){console.warn("Failed to store data",r)}},_s=i=>(zt("data-v-443103e6"),i=i(),Vt(),i),wc={class:"marketplace"},vc={class:"inner"},Sc={class:"menu"},Ec={class:"group"},Mc={class:"title"},Ic={class:"items"},bc={class:"item-wrapper"},xc=["onClick"],Tc={class:"emoji"},kc={key:0},Pc=_s(()=>m("span",{class:"emoji"},"🪙",-1)),_c={class:"detail"},Ac={class:"detail-name"},Cc={class:"detail-summary"},Dc=["src"],Bc={class:"hints"},Rc={key:0},Oc=_s(()=>m("strong",null,"Ranged",-1)),Lc={key:1},Fc=_s(()=>m("strong",null,"Powered",-1)),Yc={key:2},$c=_s(()=>m("strong",null,"Base",-1)),Xc={class:"detail-description"},Nc={class:"wavepoints"},Uc=["disabled"],Wc=it({__name:"Shop",props:{controller:null,unlocksController:null,eventSystem:null,visible:{type:Boolean}},setup(i){var w;const t=i,e={[h.Barracks]:"barracks.png",[h.Convert]:"convert.png",[h.DamageBeacon]:"damagebeacon.png",[h.Excavator]:"excavator.png",[h.Fence]:"fence.png",[h.Flamethrower]:"flamethrower.png",[h.Laser]:"laser.png",[h.Market]:"market.png",[h.Mortar]:"mortar.png",[h.PowerPlant]:"powerplant.png",[h.Radar]:"radar.png",[h.Railgun]:"railgun.png",[h.EmergencyRecharge]:"recharge.png",[h.EmergencyRepair]:"repair.png",[h.None]:"sell.png",[h.SpeedBeacon]:"speedbeacon.png",[h.Freezer]:"tar.png",[h.Terraform]:"terraform.png",[h.Tesla]:"tesla.png",[h.Tower]:"tower.png",[h.Wall]:"wall.png"},s={[h.Barracks]:"🏛️",[h.Convert]:"♻",[h.DamageBeacon]:"📈",[h.Excavator]:"⛏️",[h.Fence]:"🚧",[h.Flamethrower]:"🗼",[h.Laser]:"🗼",[h.Market]:"🏛️",[h.Mortar]:"🗼",[h.PowerPlant]:"🏛️",[h.Radar]:"🏛️",[h.Railgun]:"🗼",[h.EmergencyRecharge]:"♻",[h.EmergencyRepair]:"♻",[h.None]:"⛏️",[h.SpeedBeacon]:"📈",[h.Freezer]:"📉",[h.Terraform]:"⛏️",[h.Tesla]:"🗼",[h.Tower]:"🗼",[h.Wall]:"🚧"},n=_(t.controller.getPlacable()),r=yn(),o=_((w=ke("settings"))==null?void 0:w.showTutorial);let c;Ze(()=>{c=t.eventSystem.addEventListener(M.SelectPlaceable,({placeable:I})=>n.value=I)}),bs(()=>{c&&c()});const l=I=>{if(I===t.controller.getPlacable()){if(t.unlocksController.canUnlock(I)){p();return}if(t.unlocksController.isUnlocked(I)){t.controller.toggleBuildMenu();return}}t.controller.setPlaceable(I)},g=Object.values(gi),p=()=>{t.unlocksController.unlock(n.value),r.proxy.$forceUpdate()},d=()=>{t.controller.toggleBuildMenu()},v=()=>{o.value=!o.value};return(I,Y)=>(x(),A("div",{class:j({"marketplace-wrapper":!0,"marketplace-wrapper--visible":t.visible})},[m("div",wc,[m("button",{onClick:d,class:"close-button"},"✖"),m("button",{onClick:v,class:"view-mode-button"},F(o.value?"🍼":"👓"),1),m("div",vc,[m("div",Sc,[(x(!0),A(vt,null,Ht(R(g),D=>(x(),A("div",Ec,[m("div",Mc,F(D),1),m("div",Ic,[(x(!0),A(vt,null,Ht(R(Jn)[D],O=>{var E;return x(),A("div",bc,[!o.value||t.unlocksController.isUnlocked(O)||t.unlocksController.canUnlock(O)?(x(),A("button",{key:0,class:j({item:!0,"item--locked":!t.unlocksController.isUnlocked(O),"item--selected":((E=n.value)==null?void 0:E.entityType)===O.entityType}),onClick:()=>l(O)},[m("span",null,[m("span",Tc,F(s[O.entityType]),1),B(" "+F(O.name),1)]),R(ge)[O.entityType]?(x(),A("span",kc,[B(F(R(ge)[O.entityType])+" ",1),Pc])):Q("",!0)],10,xc)):Q("",!0)])}),256))])]))),256))]),m("div",_c,[m("h2",Ac,F(n.value.name),1),m("div",Cc,[m("img",{src:"portraits/"+e[n.value.entityType]},null,8,Dc),m("div",Bc,[n.value.entity&&n.value.entity.range?(x(),A("span",Rc,[B("🎯 "),Oc,B(" This building attacks enemies within "+F(n.value.entity.range)+" tiles.",1)])):Q("",!0),R(Qs)[n.value.entityType]?(x(),A("span",Lc,[B("⚡ "),Fc,B(" This building requires power to function. Be sure to build some power plants first.")])):Q("",!0),n.value.isBasePart?(x(),A("span",Yc,[B("🏛️ "),$c,B(" This building is part of your base and must be built next to an adjacent base building. Be sure to protect it from enemies!")])):Q("",!0)])]),m("article",Xc,F(n.value.description),1),m("aside",Nc,[m("button",{disabled:!t.unlocksController.canUnlock(n.value),onclick:p},F(n.value.isRepeatable?"Activate":t.unlocksController.isUnlocked(n.value)?"Unlocked":"Unlock"),9,Uc),B(" ("+F(t.unlocksController.getPoints())+" wave points remaining) ",1)])])])])],2))}});const Hc=ht(Wc,[["__scopeId","data-v-443103e6"]]),zc={class:"horizontal"},Vc=["value"],Gc={class:"horizontal"},jc={class:"horizontal"},Kc={class:"horizontal"},qc=it({__name:"Settings",props:{setSubmitter:{type:Function}},setup(i){const{setSubmitter:t}=i,e=[{label:"Pixi renderer",value:ot},{label:"Emoji renderer",value:pi}],s=ke("settings"),n=_(s&&e.find(({value:g})=>g===s.renderer)||e[0]),r=_((s==null?void 0:s.showTutorial)??!0),o=_((s==null?void 0:s.volume)??50),c=_((s==null?void 0:s.simulation)??1);return t(()=>({...s,renderer:n.value.value,showTutorial:r.value,volume:o.value,simulation:c.value})),(g,p)=>(x(),A(vt,null,[m("label",zc,[B(" Renderer "),ie(m("select",{"onUpdate:modelValue":p[0]||(p[0]=d=>n.value=d)},[(x(),A(vt,null,Ht(e,d=>m("option",{value:d},F(d.label),9,Vc)),64))],512),[[wn,n.value]])]),m("label",Gc,[B(" Show tutorial "),ie(m("input",{type:"checkbox","onUpdate:modelValue":p[1]||(p[1]=d=>r.value=d)},null,512),[[Ta,r.value]])]),m("label",jc,[B(" Volume "),ie(m("input",{type:"range",min:"0",max:"100","onUpdate:modelValue":p[2]||(p[2]=d=>o.value=d)},null,512),[[Ws,o.value]])]),m("label",Kc,[B(" Simulation speed "),ie(m("input",{type:"range",min:"1",max:"3","onUpdate:modelValue":p[3]||(p[3]=d=>c.value=d)},null,512),[[Ws,c.value]])])],64))}});const ca=ht(qc,[["__scopeId","data-v-0b0785e7"]]),la=i=>(zt("data-v-73d00ed9"),i=i(),Vt(),i),Zc={class:"menu"},Jc=la(()=>m("h3",null,"Paused",-1)),Qc=la(()=>m("span",{class:"divider"},null,-1)),tl=it({__name:"IngameMenu",props:{visible:{type:Boolean},mainMenu:{type:Function},resume:{type:Function}},setup(i){const{visible:t,mainMenu:e,resume:s}=i;let n;const r=c=>n=c,o=()=>{const c=n();Ps("settings",c),s(c.renderer,c.showTutorial,c.simulation)};return(c,l)=>(x(),A("div",{class:j({"menu-wrapper":!0,"menu-wrapper--visible":i.visible})},[m("div",Zc,[Jc,m("button",{onClick:l[0]||(l[0]=(...g)=>i.mainMenu&&i.mainMenu(...g))},"Main menu"),Qc,L(ca,{setSubmitter:r}),m("button",{onClick:o},"Save and resume")])],2))}});const el=ht(tl,[["__scopeId","data-v-73d00ed9"]]),sl={class:"stats"},il={class:"meta"},nl={class:"positive"},al={class:"meta"},rl={class:"positive"},ol={class:"negative"},hl={class:"meta"},cl={class:"positive"},ll={key:0,class:"negative"},ul={key:1},dl=it({__name:"Stats",props:{expanded:{type:Boolean}},setup(i){const t=i,e=Intl.NumberFormat(void 0,{maximumFractionDigits:0}),s=Intl.NumberFormat(void 0,{maximumFractionDigits:2}),n=Intl.NumberFormat(void 0,{style:"percent",maximumFractionDigits:0}),r=_(0),o=_(0),c=_(0),l=_(0),g=_(0),p=_(!1),d=_(0),v=_(0),w=_(0),I=_(0),Y=_(0),D=E=>{r.value=E.money,o.value=E.moneyMultiplier,c.value=E.level,l.value=E.towers,g.value=E.maxTowers,p.value=E.inProgress,d.value=E.integrity,v.value=E.regeneration,w.value=E.power,I.value=E.production,Y.value=E.consumption},O=ka(()=>({stat:!0,"stat--expanded":t.expanded}));return Ze(()=>{P.Instance.addEventListener(M.StatUpdate,D),u.Instance.triggerStatUpdate()}),bs(()=>{P.Instance.removeEventListener(M.StatUpdate,D)}),(E,C)=>(x(),A("div",sl,[m("span",{class:j(R(O))},[B(" 🪙 "+F(R(e).format(r.value))+" ",1),m("span",il,[B("("),m("span",nl,F(R(n).format(o.value)),1),B(")")])],2),m("span",{class:j(R(O))},[B(" 🔋 "+F(R(e).format(w.value))+" ",1),m("span",al,[B("("),m("span",rl,"+"+F(R(s).format(I.value)),1),B("/"),m("span",ol,"-"+F(R(s).format(Y.value)),1),B(")")])],2),m("span",{class:j(R(O))},[B(" 🛡️ "+F(R(e).format(d.value))+" ",1),m("span",hl,[B("("),m("span",cl,"+"+F(R(s).format(v.value)),1),B(")")])],2),m("span",{class:j(R(O))},[B(" 🗼 "),l.value>g.value?(x(),A("span",ll,F(l.value),1)):(x(),A("span",ul,F(l.value),1)),B(" / "+F(g.value),1)],2)]))}});const gl=ht(dl,[["__scopeId","data-v-0a442d39"]]),pl=i=>(zt("data-v-661c9c6d"),i=i(),Vt(),i),fl={class:"hud"},ml={class:"hud-positioner"},yl={class:"group"},wl=pl(()=>m("span",{class:"emoji"},"⚔️",-1)),vl={key:0},Sl={key:1},El=it({__name:"Hud",props:{renderer:null,controller:null},setup(i){const t=i,e=_(0),s=_(!1),n=_(!1),r=_(!1),o=p=>{e.value=p.level,s.value=p.inProgress};Ze(()=>{P.Instance.addEventListener(M.StatUpdate,o),u.Instance.triggerStatUpdate()}),bs(()=>{P.Instance.removeEventListener(M.StatUpdate,o)});function c(){u.Instance.start()}function l(){r.value=!r.value}function g(){n.value?t.renderer.hideCoverage():t.renderer.showCoverage(),P.Instance.triggerEvent(M.ToggleShowCoverage),n.value=!n.value}return(p,d)=>(x(),A("div",fl,[m("div",ml,[L(gl,{expanded:r.value},null,8,["expanded"]),m("div",yl,[m("button",{class:j({"wave-toggle":!0,"wave-toggle--active":!s.value}),onClick:c},[wl,s.value?Q("",!0):(x(),A("span",vl,"Start wave "+F(e.value+1),1)),s.value?(x(),A("span",Sl,"Wave "+F(e.value),1)):Q("",!0)],2),m("button",{class:"toggle",onClick:d[0]||(d[0]=(...v)=>t.controller.toggleBuildMenu&&t.controller.toggleBuildMenu(...v))}," 🔧 "),m("button",{class:j({toggle:!0,"toggle-toggled":r.value}),onClick:l}," 🔎 ",2),R(u).Instance.getDifficulty()!==R(K).Hard?(x(),A("button",{key:0,class:j({toggle:!0,"toggle-toggled":n.value}),onClick:g}," 🎯 ",2)):Q("",!0)])])]))}});const Ml=ht(El,[["__scopeId","data-v-661c9c6d"]]);class Il{constructor(t,e=0){a(this,"removeEventListeners");a(this,"done",!1);a(this,"steps");a(this,"highestProgress",0);a(this,"data",{});a(this,"initialProgress",0);a(this,"process",t=>{const e=Math.max(this.progress,this.initialProgress);this.progress=Math.max(this.definition.getProgress.call(this,t),this.progress),!this.isDone&&(this.updateProgress(),this.highestProgress>e&&(u.Instance.showMessage(`🏆 Achievement unlocked!
${this.title} - ${this.description}`),Ps("achievements",{[ni(this.definition.description)]:this.highestProgress},!0)))});this.definition=t,this.progress=e,this.initialProgress=e,this.steps=Object.keys(this.definition.thresholds).map(s=>parseFloat(s)),this.updateProgress()}get title(){return Object.values(this.definition.thresholds)[this.steps.indexOf(this.highestProgress)]}get description(){return this.definition.description}get thresholds(){return this.definition.thresholds}get stepValues(){return this.steps}get isDone(){return this.done}get internalProgress(){return this.progress}get completedThresholds(){return this.steps.indexOf(this.highestProgress)}get percentage(){const t=this.steps.at(-1);return this.progress/t}getPercentageForThreshold(t){const e=parseFloat(t),s=this.steps[this.steps.indexOf(e)-1]??0;return Math.min(Math.max(this.progress-s,0)/(e-s),1)}register(){this.removeEventListeners=P.Instance.addEventListeners(this.definition.triggers,this.process)}unRegister(){var t;(t=this.removeEventListeners)==null||t.call(this)}updateProgress(){for(let t=0;t<this.steps.length&&this.progress>=this.steps[t];t++)this.highestProgress=this.steps[t],t===this.steps.length-1&&(this.done=!0)}}const bl=[{description:"Reach a certain wave.",thresholds:{1:"Lvl 1 Street thug",5:"Lvl 5 Enforcer",10:"Lvl 10 Consigliere",15:"Lvl 15 Underboss",20:"Lvl 20 Don",30:"Lvl 30 Godfather"},getProgress:()=>u.Instance.getLevel(),triggers:[M.EndWave]},{description:"Discover the map.",thresholds:{"10%":"Settler","20%":"Trailblazer","40%":"Homesteader","60%":"Adventurer","90%":"Frontier explorer"},getProgress:()=>{const i=u.Instance.getSurface(),[t,e]=i.getTiles().reduce((s,n)=>(n.getType()===f.Void||(s[1]++,n.isDiscovered()&&s[0]++),s),[0,0]);return t/e*100},triggers:[M.StartWave]},{description:"Defeat enemies.",thresholds:{30:"Bot basher",100:"Circuit smasher",500:"Metal mauler",1e3:"Robo rampage",5e3:"Mechanic menace",1e4:"Robotic ruler"},getProgress:function(){const i=this.data.lastKilledEnemies??0,t=this.internalProgress+u.Instance.getKilledEnemies()-i;return this.data.lastKilledEnemies=u.Instance.getKilledEnemies(),t},triggers:[M.Kill]},{description:"Discover the edge of the map.",thresholds:{1:"Edgelord"},getProgress:()=>at.Instance.isEdgeDiscovered()?1:0,triggers:[M.StartWave]},{description:"Reach level 10 on easy mode.",thresholds:{10:"Humble beginnings"},getProgress:()=>u.Instance.getDifficulty()===K.Easy?u.Instance.getLevel():0,triggers:[M.StartWave]},{description:"Reach level 10 on normal mode.",thresholds:{10:"Establishing dominance"},getProgress:()=>u.Instance.getDifficulty()===K.Normal?u.Instance.getLevel():0,triggers:[M.StartWave]},{description:"Reach level 10 on hard mode.",thresholds:{10:"A force to be reckoned with"},getProgress:()=>u.Instance.getDifficulty()===K.Hard?u.Instance.getLevel():0,triggers:[M.StartWave]},{description:"Build a wall of at least 30 tiles.",thresholds:{30:"Great wall of China"},getProgress:i=>{const t=i;return t.tiles[0].getType()!==f.Wall?0:jo(t.tiles[0],u.Instance.getSurface(),new Set([h.Wall]),!0)},triggers:[M.Buy]},{description:"Expand your base.",thresholds:{5:"Pompeii",12:"Alexandria",25:"Athens",50:"Rome"},getProgress:()=>u.Instance.getBase().getParts().size,triggers:[M.Buy]},{description:"Unlock new technologies.",thresholds:{2:"Innovator",5:"Visionary",8:"Groundbreaker",12:"Game-changer"},getProgress:()=>Ct.Instance.getUnlockAmount(),triggers:[M.Unlock]},{description:"Hit enemies using a single mortar shell.",thresholds:{5:"Bomberman"},getProgress:i=>i.amount,triggers:[M.Bomb]},{description:"Hit enemies using a single tesla coil discharge.",thresholds:{10:"Thunderstruck"},getProgress:i=>i.amount,triggers:[M.Stun]},{description:"Pierce enemies using a single railgun shot.",thresholds:{15:"Penetrator"},getProgress:i=>i.amount,triggers:[M.Pierce]}],ua=()=>{const i=ke("achievements");return bl.map(t=>new Il(t,(i==null?void 0:i[ni(t.description)])??0)).sort((t,e)=>Number(e.isDone)-Number(t.isDone)||e.completedThresholds-t.completedThresholds||e.percentage-t.percentage)},Ri=class{constructor(){a(this,"achievements");a(this,"unRegister",()=>{const t={};this.achievements.forEach(e=>{t[ni(e.description)]=e.internalProgress,e.unRegister()}),Ps("achievements",t,!0)});Ri.instance=this,this.achievements=ua(),this.achievements.forEach(t=>t.register()),window.addEventListener("beforeunload",this.unRegister)}static get Instance(){return this.instance}};let pe=Ri;a(pe,"instance");class xl{constructor(t,e=1){a(this,"entity");a(this,"category",k.Unknown);a(this,"renderData",{});a(this,"targetX",0);a(this,"targetY",0);a(this,"travelTime",0);a(this,"time",0);a(this,"sourceX",0);a(this,"sourceY",0);this.tile=t,this.amount=e,this.entity=new tt(t.getX()+.5,t.getY()+.5,this),this.sourceX=this.entity.getX(),this.sourceY=this.entity.getY()}tick(t){if(this.travelTime>0&&this.time<this.travelTime){this.time+=t;const e=Math.min(1,this.time/this.travelTime);this.entity.setX(It(this.tile.getX(),this.targetX,e)),this.entity.setY(It(this.tile.getY(),this.targetY,e)),this.time>=this.travelTime&&u.Instance.getSurface().despawn(this)}}discover(){const t=u.Instance.getBase(),[e,s]=xt(t);this.targetX=e,this.targetY=s,this.travelTime=Math.sqrt((e-this.tile.getX())**2+(s-this.tile.getY())**2)*60}getType(){return h.WavePoint}isVisible(){return this.travelTime>0}}class Tl extends u{constructor(e,s,n,r){super(e,s,n,r);a(this,"killedEnemies",0);a(this,"lastKilledEnemies",0);a(this,"showMessage",(...e)=>this.messageFn(...e));a(this,"onUnlock",({placeable:e})=>{const s=this.getIsStarted();e.entityType===h.EmergencyRecharge&&(U.Instance.emergencyRegenerate(s?1:ys),this.triggerStatUpdate()),e.entityType===h.EmergencyRepair&&(this.base.hp+=(ui.baseEmergencyRepair+this.base.getParts().size)*(s?1:ys),this.triggerStatUpdate())});a(this,"onDiscover",e=>{const s=e.method===fs.Base?2:1;Ct.Instance.addPoints(s);const n=new xl(this.surface.getTile(e.x,e.y),s);this.surface.spawn(n),n.discover()});a(this,"onLose",()=>{this.surface.getEntitiesForCategory(k.Enemy).forEach(e=>{const s=e.getAgent();Za(s)&&s.AI.cancel()})});this.surface.getEntityTiles(this.base).map(o=>{o.hasStaticEntity()&&this.surface.despawnStatic(o.getStaticEntity().getAgent())}),n.spawnStatic(this.base),P.Instance.addEventListener(M.Unlock,this.onUnlock),P.Instance.addEventListener(M.Discover,this.onDiscover),P.Instance.addEventListener(M.Lose,()=>window.setTimeout(this.onLose,0)),console.log(this)}tick(e){if(this.surface.processChangedTiles(),this.base.isDestroyed())return;const s=this.surface.getTickingEntities();for(let n of s)n.getAgent().tick(e);q.Instance.tick(e),this.lastKilledEnemies!==this.killedEnemies&&(this.lastKilledEnemies=this.killedEnemies,P.Instance.triggerEvent(M.Kill))}triggerStatUpdate(){const e=this.getSurface().getEntitiesForCategory(k.Enemy).size;P.Instance.triggerEvent(M.StatUpdate,{integrity:this.base.getHp(),regeneration:this.base.getRegenerationFactor(),level:this.level,money:V.Instance.getMoney(),moneyMultiplier:V.Instance.getMultiplier(),production:U.Instance.getProduction(),consumption:U.Instance.getConsumption(),power:U.Instance.getPower(),remainingEnemies:e,inProgress:this.getIsStarted(),towers:this.surface.getTowers().size,maxTowers:dt.Instance.getMaxTowers()})}spawnEnemy(e){this.surface.spawn(e)}despawnEnemy(e){this.killedEnemies++,this.surface.despawn(e)&&q.Instance.processWave()&&this.end()}getKilledEnemies(){return this.killedEnemies}getIsStarted(){return q.Instance.isWaveInProgress()||q.Instance.getSpawnGroups().length===0}canBuy(e,s=1){const n=(ge[e.entityType]??0)*s;return n>V.Instance.getMoney()?(this.showMessage(`You do not have enough money. This costs 🪙 ${n}`),!1):!0}start(){if(this.getIsStarted())throw new Error("Wave already in progress!");if(this.surface.getTowers().size>dt.Instance.getMaxTowers()){u.Instance.showMessage(`Your current base can support up to ${dt.Instance.getMaxTowers()} towers. Extend your base or sell towers before starting `);return}U.Instance.processPower(),V.Instance.clearRecents(),V.Instance.addWaveBudget(this.level),q.Instance.startNewWave(),at.Instance.commit(),this.level++,at.Instance.updateBaseRange(),P.Instance.triggerEvent(M.StartWave),this.triggerStatUpdate(),u.Instance.getSurface().forceRerender()}consume(e,s=1,n=1){return U.Instance.consume((Qs[e.getType()]??0)+(s-1)*U.speedBeaconConsumption+(n-1)*U.damageBeaconConsumption)}consumeContinuous(e,s,n=1){return U.Instance.consume((Qs[e.getType()]??0)*s+(n-1)*U.damageBeaconConsumption*s/160)}getDifficulty(){return this.difficulty}getIsBaseDestroyed(){return this.base.isDestroyed()}end(){dt.Instance.commit(),at.Instance.commit(),q.Instance.cleanupSpawnGroups(fs.Base),this.base.regenerate(),this.triggerStatUpdate(),P.Instance.triggerEvent(M.EndWave),q.Instance.getSpawnGroups().length===0?this.showMessage("World conquered. You win!",{closable:!1,expires:0}):this.level===9?this.showMessage("Something is rumbling in the distance."):q.Instance.shouldAddSpawnGroup()&&(P.Instance.triggerEvent(M.Spawn),this.showMessage("Another spawn point has appeared!")),u.Instance.getSurface().forceRerender()}getDamageMultiplier(){let e=1;switch(this.difficulty){case K.Hard:e+=.2;case K.Normal:e+=.2}return e}}const kl=(i,t,e,s)=>{new at(e);const n=new ui(t),r=new Tl(i,n,e,s);return new q(n,e),new U,new V(100,()=>n.getMoneyFactor()),new dt(e),new Ct,new pe,r},Pl=i=>(zt("data-v-f21cc5cd"),i=i(),Vt(),i),_l={class:"wrapper"},Al={height:"0",style:{position:"absolute"}},Cl=Pl(()=>m("defs",null,[m("radialGradient",{id:"alert"},[m("stop",{offset:"0%","stop-color":"red","stop-opacity":"0"}),m("stop",{offset:"95%","stop-color":"red","stop-opacity":"0"}),m("stop",{offset:"100%","stop-color":"red","stop-opacity":"0.8"})])],-1)),Dl=[Cl],Bl={class:"canvas"},Rl=it({__name:"Game",props:{seed:null,difficulty:null,renderer:null,showTutorial:{type:Boolean},initialSpeed:null,mainMenu:{type:Function}},setup(i){const t=i;console.log(`Seed: ${t.seed}`);const e=_(null),s=_(!1),n=_(!1),r=_(t.initialSpeed),o=new Ka({width:160,height:160,generate:Va(t.seed,160,160)}),c=new _t(o);let l=new t.renderer(o,c);const g=o.getTile(80,80),p=kl(t.difficulty,g,o,l.showMessage),d=new ih;t.showTutorial&&d.start();let v=!1,w,I,Y,D;Ze(()=>{v=!0,l.mount(e.value),I=c.addKeyListener(st.Escape,()=>{if(n.value){_t.Instance.toggleBuildMenu();return}s.value=!s.value,s.value?c.pause():c.unpause()}),Y=P.Instance.addEventListener(M.OpenBuildMenu,()=>n.value=!0),D=P.Instance.addEventListener(M.CloseBuildMenu,()=>n.value=!1);const C=W=>{if(!v)return;const nt=+c.isKeyDown(st.Right)+ +c.isKeyDown(st.D)-+c.isKeyDown(st.Left)-+c.isKeyDown(st.A)-+c.isKeyDown(st.Q),Ft=+c.isKeyDown(st.Down)+ +c.isKeyDown(st.S)-+c.isKeyDown(st.Up)-+c.isKeyDown(st.W)-+c.isKeyDown(st.Z),Zt=+c.isKeyDown(st.Plus)+ +c.isKeyDown(st.Equals)-+c.isKeyDown(st.Minus);(nt||Ft||Zt)&&l.move({x:nt,y:Ft,zoom:Zt});const Yt=w?W-w:16;s.value||p.tick(Yt*r.value),l.rerender(Yt),w=W,window.requestAnimationFrame(C)};window.requestAnimationFrame(C)}),bs(()=>{l.unmount(),pe.Instance.unRegister(),I(),Y(),D(),v=!1});const O=(C,W,nt)=>{C&&!(l instanceof C)?(l.unmount(),o.forceRerender(),l=new C(o,c),l.mount(e.value),p.update(l.showMessage)):l instanceof ot&&l.updateSettings(),!d.isStarted&&W&&d.start(),d.isStarted&&W===!1&&d.stop(),nt&&(r.value=nt),s.value=!1,c.unpause()},E=()=>{pe.Instance.unRegister(),t.mainMenu()};return(C,W)=>(x(),A("div",_l,[(x(),A("svg",Al,Dl)),L(Ml,{renderer:R(l),controller:R(_t).Instance},null,8,["renderer","controller"]),m("div",Bl,[m("div",{class:"render-target",ref_key:"canvas",ref:e},null,512),L(Hc,{controller:R(_t).Instance,unlocksController:R(Ct).Instance,eventSystem:R(P).Instance,visible:n.value},null,8,["controller","unlocksController","eventSystem","visible"]),L(el,{mainMenu:E,visible:s.value,resume:O},null,8,["visible"])])]))}});const Ol=ht(Rl,[["__scopeId","data-v-f21cc5cd"]]);const Ll={},Fl={class:"key-grid"};function Yl(i,t){return x(),A("div",Fl,[Pa(i.$slots,"default",{},void 0,!0)])}const Xs=ht(Ll,[["render",Yl],["__scopeId","data-v-ad6fcae2"]]),ts=i=>(zt("data-v-52ee7b24"),i=i(),Vt(),i),$l=ts(()=>m("h3",null,"Build menu",-1)),Xl={class:"flex"},Nl=ts(()=>m("h3",null,"Building",-1)),Ul={class:"flex flex-justify"},Wl={class:"key-combination"},Hl={class:"key-combination"},zl=ts(()=>m("h3",null,"Moving",-1)),Vl={class:"flex flex-justify"},Gl=ts(()=>m("h3",null,"Zooming",-1)),jl={class:"flex"},Kl=ts(()=>m("h3",null,"Toggle selling",-1)),ql={class:"flex"},Zl=it({__name:"ControlsList",setup(i){return(t,e)=>(x(),A(vt,null,[$l,m("div",Xl,[L(H,{char:"e"}),B(" / "),L(H,{char:"b"})]),Nl,m("div",Ul,[L(us,{button:"left"}),B(" / "),m("span",Wl,[L(H,{char:"⇧"}),B(" + "),L(us,{button:"left"})]),B(" / "),m("span",Hl,[L(H,{char:"⌘"}),B(" + "),L(us,{button:"left"})])]),zl,m("div",Vl,[L(Xs,null,{default:Bs(()=>[L(H,{char:"w",area:"up"}),L(H,{char:"a",area:"left"}),L(H,{char:"s",area:"down"}),L(H,{char:"d",area:"right"})]),_:1}),B(" / "),L(Xs,null,{default:Bs(()=>[L(H,{char:"z",area:"up"}),L(H,{char:"q",area:"left"}),L(H,{char:"s",area:"down"}),L(H,{char:"d",area:"right"})]),_:1}),B(" / "),L(Xs,null,{default:Bs(()=>[L(H,{char:"↑",area:"up"}),L(H,{char:"←",area:"left"}),L(H,{char:"↓",area:"down"}),L(H,{char:"→",area:"right"})]),_:1})]),Gl,m("div",jl,[L(H,{char:"-"}),L(H,{char:"+"})]),Kl,m("div",ql,[L(H,{char:"f"})])],64))}});const Jl=ht(Zl,[["__scopeId","data-v-52ee7b24"]]),da=i=>(zt("data-v-55661321"),i=i(),Vt(),i),Ql={class:"achievement-title"},tu={class:"achievement-description"},eu={key:0,class:"achievement-progress"},su={class:"achievement-line"},iu=["title"],nu=da(()=>m("span",{class:"line"},null,-1)),au={class:"marker"},ru=da(()=>m("span",{class:"achievement-line-segment"},[m("span",{class:"line"})],-1)),ou=[ru],hu={class:"achievement-percentage"},cu=it({__name:"Achievement",props:{achievement:null},setup(i){const{achievement:t}=i,e="???????",s=Intl.NumberFormat(void 0,{style:"percent",maximumFractionDigits:0}),n=t.stepValues.at(-1),r=t.percentage;return(o,c)=>(x(),A("div",{class:j({achievement:!0,"achievement--complete":i.achievement.isDone})},[m("h2",Ql,F(i.achievement.title??e),1),m("p",tu,F(i.achievement.description),1),i.achievement.stepValues.length>1||R(n)!==1?(x(),A("div",eu,[m("span",su,[m("span",{class:"achievement-line-nominal",style:hs({flex:R(n)})},[(x(!0),A(vt,null,Ht(i.achievement.thresholds,(l,g)=>(x(),A("span",{class:j({"achievement-line-segment":!0}),style:hs({"--progress":`${i.achievement.getPercentageForThreshold(g)*100}%`}),title:i.achievement.internalProgress>=parseFloat(g)?l:i.achievement.internalProgress.toFixed()},[nu,m("span",au,F(g),1)],12,iu))),256))],4),i.achievement.internalProgress>R(n)?(x(),A("span",{key:0,class:"achievement-line-overflow",style:hs({flex:i.achievement.internalProgress-R(n)})},ou,4)):Q("",!0)]),m("p",hu,F(R(r)>1?i.achievement.internalProgress:R(s).format(R(r))),1)])):Q("",!0)],2))}});const lu=ht(cu,[["__scopeId","data-v-55661321"]]),uu=it({__name:"AchievementsList",setup(i){const t=ua();return(e,s)=>(x(!0),A(vt,null,Ht(R(t),n=>(x(),le(lu,{achievement:n},null,8,["achievement"]))),256))}}),du="0.0.5",pn=["a","e","i","o","u"],fn=["b","c","d","f","g","h","j","k","l","m","n","p","q","r","s","t","v","w","x","y","z"],ga=()=>pn[Math.floor(Math.random()*pn.length)],pa=()=>fn[Math.floor(Math.random()*fn.length)],fa=()=>pa()+ga(),gu=()=>fa()+pa(),mn=[ga,fa,gu],pu=()=>mn[Math.floor(Math.random()*mn.length)](),fu=()=>{const i=[],t=Math.random()>.5?3:2;for(let e=0;e<t;e++)i.push(pu());return i.join("")},As=i=>(zt("data-v-a9a39c28"),i=i(),Vt(),i),mu={class:"wrapper"},yu=As(()=>m("h1",null,"Open Tower Defense 🗼",-1)),wu={class:"menu"},vu={class:"menu-main"},Su={class:"menu-main-inner"},Eu=["value"],Mu={class:"difficulty-description"},Iu=As(()=>m("button",{type:"submit"},"Start!",-1)),bu={class:"menu-controls-inner"},xu={class:"menu-controls-inner"},Tu={class:"menu-settings-inner"},ku={class:"footer"},Pu=As(()=>m("a",{class:"footer-link",href:"https://github.com/lorgan3/open-td/releases",target:"_blank",rel:"noopener noreferrer"},"Release notes",-1)),_u={key:0},Au=As(()=>m("span",{class:"spinner"},"߷",-1)),Cu=it({__name:"MainMenu",props:{onPlay:{type:Function}},setup(i){const t=i,e=_(0),s=_(fu()),n=_(null),r=ke("settings"),o=_((r==null?void 0:r.difficulty)||K.Easy),c=_(!0);fi().then(()=>c.value=!1);let l;const g=v=>l=v,p=v=>{var w;if(v===e.value){e.value=0;return}e.value=v,e.value===1&&((w=n.value)==null||w.select())},d=v=>{v.preventDefault();const w=l();Ps("settings",{...w,difficulty:o.value}),t.onPlay(s.value,o.value,w.renderer,w.showTutorial,w.simulation)};return(v,w)=>(x(),A("div",mu,[yu,m("div",wu,[m("div",vu,[m("div",Su,[m("button",{onClick:w[0]||(w[0]=I=>p(1))},"Play"),m("button",{onClick:w[1]||(w[1]=I=>p(2))},"Controls"),m("button",{onClick:w[2]||(w[2]=I=>p(3))},"Achievements"),m("button",{onClick:w[3]||(w[3]=I=>p(4))},"Settings")])]),m("div",{class:j({"menu-play":!0,"menu--hidden":e.value!==1})},[m("form",{onSubmit:d,class:"menu-play-inner"},[m("label",null,[B(" Which world? "),ie(m("input",{ref_key:"seedInput",ref:n,"onUpdate:modelValue":w[4]||(w[4]=I=>s.value=I)},null,512),[[Ws,s.value]])]),m("label",null,[B(" Difficulty "),ie(m("select",{"onUpdate:modelValue":w[5]||(w[5]=I=>o.value=I)},[(x(!0),A(vt,null,Ht(R(Yi),({label:I},Y)=>(x(),A("option",{value:Y},F(I),9,Eu))),256))],512),[[wn,o.value]])]),m("p",Mu,F(R(Yi)[o.value].description),1),Iu],32)],2),m("div",{class:j({"menu-controls":!0,"menu--hidden":e.value!==2})},[m("div",bu,[L(Jl)])],2),m("div",{class:j({"menu-achievements":!0,"menu--hidden":e.value!==3})},[m("div",xu,[L(uu)])],2),m("div",{class:j({"menu-settings":!0,"menu--hidden":e.value!==4})},[m("div",Tu,[L(ca,{setSubmitter:g})])],2)]),m("div",ku,[m("span",null,F(R(du)),1),Pu,c.value?(x(),A("span",_u,[Au,B(" Loading assets")])):Q("",!0)])]))}});const Du=ht(Cu,[["__scopeId","data-v-a9a39c28"]]),Bu=it({__name:"App",setup(i){const t=_(0),e=_(),s=_(),n=_(),r=_(),o=_(),c=(g,p,d,v,w)=>{t.value=1,e.value=g,s.value=p,n.value=d,r.value=v,o.value=w},l=()=>t.value=0;return(g,p)=>(x(),A(vt,null,[t.value==0?(x(),le(Du,{key:0,onPlay:c})):Q("",!0),t.value==1?(x(),le(Ol,{key:1,seed:e.value,difficulty:s.value,renderer:n.value,showTutorial:r.value,initialSpeed:o.value,mainMenu:l},null,8,["seed","difficulty","renderer","showTutorial","initialSpeed"])):Q("",!0)],64))}});ii(Bu).mount("#app");
