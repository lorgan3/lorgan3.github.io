var nn=Object.defineProperty;var an=(n,t,e)=>t in n?nn(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var a=(n,t,e)=>(an(n,typeof t!="symbol"?t+"":t,e),e);import{A as rn,c as on,H as cn,d as nt,a as I,b as A,g as y,t as L,h as C,j as Y,u as P,n as j,k as Jt,l as Qt,m as _,q as te,s as _e,F as ft,v as qt,w as k,x as Js,y as hn,z as ln,B as un,C as Ht,D as dn,E as Ze,G as gn,I as Ce,J as Yt,K as Ts,L as bs,M as pn}from"./vendor-d3c2e9ca.js";import{C as mt,S as J,P as ve,A as Bt,R as Zt,M as fn,T as Qs,G as Ne,L as mn,F as yn,r as wn,h as vn,a as Sn,s as En,b as Mn,c as In,d as Tn,V as bn}from"./pixi-516d0c86.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerpolicy&&(r.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?r.credentials="include":i.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();let _n=1;class q{constructor(t,e,s){a(this,"id");a(this,"rotation",0);this.x=t,this.y=e,this.agent=s,this.id=_n++}getX(){return this.x}getAlignedX(){return this.x|0}getY(){return this.y}getAlignedY(){return this.y|0}getAgent(){return this.agent}getId(){return this.id}setX(t){this.x=t}setY(t){this.y=t}getRotation(){return this.rotation}setRotation(t){this.rotation=t}move(t,e,s){const i=(e.getX()-t.getX())*s+t.getX(),r=(e.getY()-t.getY())*s+t.getY();this.setX(i),this.setY(r),this.lookAt(e)}lookAt(t,e){let s,i;e!==void 0?(s=t-this.x,i=e-this.y):(s=t.getX()-this.x,i=t.getY()-this.y),(s||i)&&this.setRotation(Math.atan2(i,s)*180/Math.PI+90)}}const yt=n=>n.constructor.scale,vt=n=>{const t=yt(n),e=n.getTile();return[e.getX()+t/2,e.getY()+t/2]};function Ue(n){return n?"getTile"in n:!1}class O extends q{constructor(t,e,s){super(t,e,s)}getAgent(){return this.agent}}var T=(n=>(n[n.Unknown=0]="Unknown",n[n.Player=1]="Player",n[n.Enemy=2]="Enemy",n))(T||{}),h=(n=>(n[n.None=0]="None",n[n.Tower=1]="Tower",n[n.Slime=2]="Slime",n[n.Base=3]="Base",n[n.Bullet=4]="Bullet",n[n.Wall=5]="Wall",n[n.Mortar=6]="Mortar",n[n.Flamethrower=7]="Flamethrower",n[n.Flame=8]="Flame",n[n.Railgun=9]="Railgun",n[n.Rail=10]="Rail",n[n.ElectricFence=11]="ElectricFence",n[n.Fence=12]="Fence",n[n.Freezer=13]="Freezer",n[n.Tree=14]="Tree",n[n.Rock=15]="Rock",n[n.Radar=16]="Radar",n[n.PowerPlant=17]="PowerPlant",n[n.Blueprint=18]="Blueprint",n[n.Shockwave=19]="Shockwave",n[n.Armory=20]="Armory",n[n.Market=21]="Market",n[n.SpeedBeacon=22]="SpeedBeacon",n[n.Runner=23]="Runner",n[n.DamageBeacon=24]="DamageBeacon",n[n.Laser=25]="Laser",n[n.LaserBeam=26]="LaserBeam",n[n.Flier=27]="Flier",n[n.Tank=28]="Tank",n[n.Rocket=29]="Rocket",n[n.WavePoint=30]="WavePoint",n[n.Excavator=31]="Excavator",n[n.Convert=32]="Convert",n[n.Terraform=33]="Terraform",n[n.EmergencyRecharge=34]="EmergencyRecharge",n[n.EmergencyRepair=35]="EmergencyRepair",n))(h||{});const Je=new Set([3,16,17,20,21]),ti=new Set([...Je,1,6,7,9,14,15,22,24,25,5]);var B=(n=>(n[n.Undiscovered=0]="Undiscovered",n[n.Pending=1]="Pending",n[n.Discovered=2]="Discovered",n))(B||{}),g=(n=>(n[n.Void=0]="Void",n[n.Grass=1]="Grass",n[n.Stone=2]="Stone",n[n.Water=3]="Water",n[n.Obstructed=4]="Obstructed",n[n.Wall=5]="Wall",n[n.Spore=6]="Spore",n[n.ElectricFence=7]="ElectricFence",n[n.Fence=8]="Fence",n[n.Freezer=9]="Freezer",n[n.Bridge=10]="Bridge",n[n.Dirt=11]="Dirt",n[n.Snow=12]="Snow",n[n.Sand=13]="Sand",n[n.Ice=14]="Ice",n[n.PlayerBuilding=15]="PlayerBuilding",n[n.Tree=16]="Tree",n[n.Rock=17]="Rock",n[n.Base=18]="Base",n))(g||{});const Qe=new Set([1,2,11,13,12]),ts=new Set([...Qe,3,14,10,16,17]),An=new Set([...ts,9,7,8]),xn={[h.Tower]:4,[h.Wall]:5,[h.Mortar]:4,[h.Flamethrower]:4,[h.Railgun]:4,[h.ElectricFence]:7,[h.Fence]:8,[h.Freezer]:9,[h.Radar]:18,[h.PowerPlant]:18,[h.Tree]:16,[h.Rock]:17,[h.Armory]:18,[h.Base]:18,[h.Market]:18,[h.SpeedBeacon]:4,[h.DamageBeacon]:4,[h.Laser]:4};class st{constructor(t,e,s=g.Void){a(this,"staticEntity",null);a(this,"hash");a(this,"actualType");a(this,"towers",[]);a(this,"linkedAgents");a(this,"discoveryStatus",B.Undiscovered);this.x=t,this.y=e,this.type=s,this.hash=`[${this.x}, ${this.y}]`,this.actualType=s}getX(){return this.x}getY(){return this.y}getBaseType(){return this.type}getType(){return this.actualType}getStaticEntity(){return this.staticEntity}hasStaticEntity(){return this.staticEntity!==null}setStaticEntity(t){if(this.staticEntity!==null)throw new Error("A tile can only have 1 static entity.");const e=t.getAgent();Ue(e)&&e.getTile().getHash()===this.getHash()&&(e.updateTile(this),this.linkedAgents&&e.updateLinkedAgents&&e.updateLinkedAgents(this.linkedAgents)),this.staticEntity=t,this.actualType=xn[t.getAgent().getType()]||this.type}clearStaticEntity(){this.staticEntity=null,this.actualType=this.type}isStaticEntityRoot(){var t;return((t=this.staticEntity)==null?void 0:t.getAgent().getTile())===this}addTower(t){this.towers.includes(t)||this.towers.push(t)}setDiscoveryStatus(t){this.discoveryStatus=t}isDiscovered(){return this.discoveryStatus===B.Discovered}getDiscoveryStatus(){return this.discoveryStatus}isCoveredByTower(){return this.isDiscovered()&&this.towers.length>0}removeTower(t){this.towers.splice(this.towers.indexOf(t),1)}getAvailableTowers(){return this.towers.filter(t=>t.getCooldown()<=0)}getTowers(){return this.towers}addLinkedAgent(t){var s;this.linkedAgents||(this.linkedAgents=new Set),this.linkedAgents.add(t);const e=(s=this.staticEntity)==null?void 0:s.getAgent();e&&e.updateLinkedAgents&&e.updateLinkedAgents(this.linkedAgents)}removeLinkedAgent(t){var s;if(!this.linkedAgents)return;this.linkedAgents.delete(t);const e=(s=this.staticEntity)==null?void 0:s.getAgent();Ue(e)&&e.updateLinkedAgents&&e.updateLinkedAgents(this.linkedAgents)}getLinkedAgents(){return this.linkedAgents}getHash(){return this.hash}sync(t){this.towers=t.towers,this.discoveryStatus=t.discoveryStatus}}const hs=class{constructor(){a(this,"eventHandlers");hs.instance=this,this.eventHandlers=new Map}addEventListener(t,e){return this.eventHandlers.has(t)?this.eventHandlers.get(t).add(e):this.eventHandlers.set(t,new Set([e])),()=>this.removeEventListener(t,e)}addEventListeners(t,e){const s=t.map(i=>this.addEventListener(i,e));return()=>s.forEach(i=>i())}removeEventListener(t,e){var s;(s=this.eventHandlers.get(t))==null||s.delete(e)}triggerEvent(t,...e){var s;(s=this.eventHandlers.get(t))==null||s.forEach(i=>i(...e))}static get Instance(){return this.instance}};let b=hs;a(b,"instance");const ls=class{constructor(t,e,s,i){a(this,"level",0);this.difficulty=t,this.base=e,this.surface=s,this.messageFn=i,ls.instance=this,new b}getSurface(){return this.surface}getBase(){return this.base}getLevel(){return this.level}getDifficulty(){return this.difficulty}static get Instance(){return this.instance}};let u=ls;a(u,"instance");class ei{constructor(t){a(this,"entity");a(this,"category",T.Unknown);a(this,"hp",30);a(this,"renderData",{});this.tile=t,this.entity=new O(t.getX(),t.getY(),this)}getType(){return h.Tree}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return this.tile.isDiscovered()}}a(ei,"scale",1);class si{constructor(t){a(this,"entity");a(this,"category",T.Unknown);a(this,"hp",30);a(this,"renderData",{});this.tile=t,this.entity=new O(t.getX(),t.getY(),this)}getType(){return h.Rock}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return this.tile.isDiscovered()}}a(si,"scale",1);const kn=n=>{const t=rn(n),e=on(t),s=e(1,0)*193,i=e(0,1)*197,r=.048,o=.0077,c=.0025,l=.0194,p=.95;return(d,w)=>{const v=d+s,S=w+i,E=e(v*r,S*r),D=e(v*c,S*c),x=Math.abs(D),G=e(v*o,S*o),at=1-Math.abs(G),Q=e(v*l,S*l),Ot=Math.abs(Q),lt=(D+Q/3)*.83,he=lt+x*9241%1/3,en=at>p+lt/10,sn=at+E/3+Q-.4>p+lt/2;if(en||sn)return D+x*1811%1/7<-.6?new st(d,w,g.Ice):new st(d,w,g.Water);if(at>p+lt/15)return new st(d,w,g.Dirt);let ut;lt>.3?ut=new st(d,w,g.Sand):lt<-.5?ut=new st(d,w,g.Snow):ut=new st(d,w,g.Grass);const Is=(Q+.5)*(E-.5)+x*5419%1/10;if(Is<.07&&Is>.04&&he>-.4&&he<.6){const De=new ei(ut);ut.setStaticEntity(De.entity)}else if((he<-.5||he>.7)&&Ot*2791%1>.99){const De=new si(ut);ut.setStaticEntity(De.entity)}return ut}};var M=(n=>(n[n.StatUpdate=0]="StatUpdate",n[n.SurfaceChange=1]="SurfaceChange",n[n.BlackOut=2]="BlackOut",n[n.OpenBuildMenu=3]="OpenBuildMenu",n[n.CloseBuildMenu=4]="CloseBuildMenu",n[n.ToggleShowCoverage=5]="ToggleShowCoverage",n[n.StartWave=6]="StartWave",n[n.EndWave=7]="EndWave",n[n.Unlock=8]="Unlock",n[n.Discover=9]="Discover",n[n.Spawn=10]="Spawn",n[n.Buy=11]="Buy",n[n.Sell=12]="Sell",n[n.HitBase=13]="HitBase",n[n.Lose=14]="Lose",n))(M||{});class Pn{constructor(t=50,e=25,s=(i,r)=>new st(i,r)){a(this,"map");a(this,"entities",[]);a(this,"deletedEntities",[]);a(this,"staticEntities",[]);a(this,"entitiesMap",new Map);a(this,"dirty",!1);a(this,"changedTiles",new Set);a(this,"addedAgents",new Set);a(this,"removedAgents",new Set);this.width=t,this.height=e,this.generate=s,this.initialize()}initialize(){this.map=new Array(this.width*this.height);for(let t=0;t<this.height;t++)for(let e=0;e<this.width;e++)this.map[t*this.width+e]=this.generate(e,t);this.entities=[],this.deletedEntities=[],this.staticEntities=[],this.entitiesMap.clear(),Object.values(T).filter(t=>typeof t!="string").forEach(t=>this.entitiesMap.set(t,new Set))}getTile(t,e,s=!1){return t>=this.width||t<0||e>=this.height||e<0?s?this.getTile(Math.max(Math.min(t,this.width-1),0),Math.max(Math.min(e,this.height-1),0)):void 0:this.map[e*this.width+t]}getEntityTiles(t,e,s){let i;if(e)i=t;else{const r=t;i=r.getTile().getX(),e=r.getTile().getY(),s=yt(r)}switch(s){case 1:return[this.map[e*this.width+i]];case 2:return[this.map[e*this.width+i],this.map[e*this.width+i+1],this.map[(e+1)*this.width+i],this.map[(e+1)*this.width+i+1]];default:throw new Error("Unsupported agent scale!")}}getAdjacentTiles(t,e=1){return[[1,0],[-1,0],[0,1],[0,-1]].map(([i,r])=>this.getTile(t.getX()+i*e,t.getY()+r*e)).filter(i=>!!i)}setTile(t){this.setTileInternal(t)}setTiles(t){t.map(e=>this.setTileInternal(e))}setTileInternal(t){this.dirty=!0;const e=this.map[t.getY()*this.width+t.getX()];return e.hasStaticEntity()&&!t.hasStaticEntity()?t.setStaticEntity(e.getStaticEntity()):e.hasStaticEntity()&&this.despawnStatic(e.getStaticEntity().getAgent()),t.sync(e),this.map[t.getY()*this.width+t.getX()]=t,this.changedTiles.add(e),e}processChangedTiles(){!this.changedTiles.size||(b.Instance.triggerEvent(M.SurfaceChange,{affectedTiles:this.changedTiles,addedStaticAgents:this.addedAgents,removedStaticAgents:this.removedAgents}),this.changedTiles.clear(),this.addedAgents.clear(),this.removedAgents.clear())}getRow(t){const e=t*this.width;return this.map.slice(e,e+this.width)}getColumn(t){const e=new Array(this.height);for(let s=0;s<this.height;s++)e[s]=this.getTile(t,s);return e}getWidth(){return this.width}getHeight(){return this.height}forLine(t,e,s,i,r,o){const c=(o==null?void 0:o.scale)??1;t=Math.floor(t/c)*c,e=Math.floor(e/c)*c,s=Math.floor(s/c)*c,i=Math.floor(i/c)*c;const l=Math.atan2(i-e,s-t);return this.forRay(t,e,l,(p,f)=>!(r(p,f)===!1)&&!(p.getX()===s&&p.getY()===i),o)}forRay(t,e,s,i,r){const o=(r==null?void 0:r.connected)??!1,c=(r==null?void 0:r.scale)??1,l=Math.cos(s),p=Math.sin(s),f=Math.abs(l)+Math.abs(p);let d=Math.abs(l/f),w=Math.abs(p/f),v=(1+(d>w?w/d:d/w))*c;d*=v*Math.sign(l),w*=v*Math.sign(p);let S,E,D=0;for(;;){let x=!1;const G=Math.round(t/c)*c;let at=Math.round(e/c)*c;o&&S!==void 0&&Math.round(S/c)*c!==G&&Math.round(E/c)*c!==at&&(at=Math.round(E),x=!0);const Q=this.getTile(G,at);if(!Q||!i(Q,D))break;x||(t+=d,e+=w),S=G,E=at,D++}}forRect(t,e,s,i,r,o){const c=(o==null?void 0:o.scale)??1;t=Math.floor(t/c)*c,e=Math.floor(e/c)*c,s=Math.floor(s/c)*c,i=Math.floor(i/c)*c;const l=(f,d)=>{const w=this.getTile(f,d);w&&r(w)},p=f=>{if(s>t)for(let d=t;d<=s;d+=c)l(d,f);else for(let d=t;d>=s;d-=c)l(d,f)};if(i>e)for(let f=e;f<=i;f+=c)p(f);else for(let f=e;f>=i;f-=c)p(f)}forCircle(t,e,s,i,r){const o=(r==null?void 0:r.edgeOnly)??!1,c=(r==null?void 0:r.scale)??1;t=Math.floor(t/c),e=Math.floor(e/c);let l=s/2;const p=l*l,f=(l-1)*(l-1),d=(w,v,S=0)=>{const E=w+S,D=v+S,x=E*E+D*D;if(x<p&&!(o&&x<f)){const G=this.getTile((t+w)*c,(e+v)*c,o);G&&i(G)}};if(s%2===0)for(let w=-l;w<l;w+=1)for(let v=-l;v<l;v+=1)d(v,w,.5);else{l=l|0;for(let w=-l;w<l+1;w+=1)for(let v=-l;v<l+1;v+=1)d(v,w)}}spawn(t){this.entities.push(t.entity),this.entitiesMap.get(t.category).add(t.entity),t.spawn&&t.spawn()}spawnStatic(t){this.getEntityTiles(t).forEach(s=>{s.setStaticEntity(t.entity),this.changedTiles.add(s)}),this.addedAgents.add(t),this.spawn(t),this.dirty=!0}despawn(t){const e=this.entities.indexOf(t.entity);e>=0&&this.entities.splice(e,1);const s=this.entitiesMap.get(t.category).delete(t.entity);return this.deletedEntities.push(t.entity),t.despawn&&t.despawn(),s}despawnStatic(t){this.getEntityTiles(t).forEach(s=>{s.clearStaticEntity(),this.changedTiles.add(s)}),this.removedAgents.add(t),this.despawn(t),this.dirty=!0}getEntities(){return this.entities}getEntitiesForCategory(t){return this.entitiesMap.get(t)}getDeletedEntities(){return this.deletedEntities}getStaticEntities(){return this.staticEntities}markPristine(){this.dirty=!1,this.deletedEntities=[]}forceRerender(){this.dirty=!0}isDirty(){return this.dirty}}const ee=(n,t)=>{const e=[],s=yt(n),i=s===2?1:0;u.Instance.getSurface().forCircle(n.getTile().getX()+i,n.getTile().getY()+i,t*s,r=>{if(ts.has(r.getBaseType())){r.hasStaticEntity()&&r.getStaticEntity().getAgent().category!==T.Player&&u.Instance.getSurface().despawnStatic(r.getStaticEntity().getAgent());const o=new st(r.getX(),r.getY(),g.Stone);e.push(o)}}),u.Instance.getSurface().setTiles(e)};class ii{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"renderData",{});this.tile=t,this.entity=new O(t.getX(),t.getY(),this)}spawn(){u.Instance.getBase().addPart(this),ee(this,3)}despawn(){u.Instance.getBase().removePart(this)}getType(){return h.Armory}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){u.Instance.getBase().hit(t)}isVisible(){return!0}}a(ii,"scale",2);const Ie=class{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"hp",50);a(this,"renderData",{});this.tile=t,this.entity=new O(t.getX(),t.getY(),this)}spawn(){u.Instance.getSurface().getAdjacentTiles(this.tile,Ie.scale).forEach(t=>t.addLinkedAgent(this))}despawn(){u.Instance.getSurface().getAdjacentTiles(this.tile,Ie.scale).forEach(t=>t.removeLinkedAgent(this))}getType(){return h.SpeedBeacon}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}};let Wt=Ie;a(Wt,"scale",2);const Rn=.625;class ni{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"isEnabled",!0);a(this,"renderData",{});this.tile=t,this.entity=new O(t.getX(),t.getY(),this),t.addTower(this)}getCooldown(){return this.isEnabled?0:1}fire(t,e){if(!u.Instance.consumeContinuous(this,e))return 0;const s=Rn*e;return t.AI.hit(s),s}despawn(){this.tile.removeTower(this)}getType(){return h.ElectricFence}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.isEnabled=!1}isVisible(){return!0}isSpeedBoosted(){return!1}isDamageBoosted(){return!1}}a(ni,"scale",1);class ai{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"renderData",{});this.tile=t,this.entity=new O(t.getX(),t.getY(),this)}getType(){return h.Fence}getTile(){return this.tile}updateTile(t){this.tile=t}isVisible(){return!0}}a(ai,"scale",1);class ri{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"renderData",{});this.tile=t,this.entity=new O(t.getX(),t.getY(),this)}getType(){return h.Freezer}getTile(){return this.tile}updateTile(t){this.tile=t}isVisible(){return!0}}a(ri,"scale",2);class oi{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"renderData",{});this.tile=t,this.entity=new O(t.getX(),t.getY(),this)}spawn(){u.Instance.getBase().addPart(this),ee(this,3)}despawn(){u.Instance.getBase().removePart(this)}getType(){return h.Market}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){u.Instance.getBase().hit(t)}isVisible(){return!0}}a(oi,"scale",2);class ci{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"renderData",{});this.tile=t,this.entity=new O(t.getX(),t.getY(),this)}getType(){return h.PowerPlant}getTile(){return this.tile}updateTile(t){this.tile=t}spawn(){u.Instance.getBase().addPart(this),ee(this,3)}despawn(){u.Instance.getBase().removePart(this)}hit(t){u.Instance.getBase().hit(t)}isVisible(){return!0}}a(ci,"scale",2);var R=(n=>(n[n.Normal=0]="Normal",n[n.OnFire=1]="OnFire",n))(R||{});class Dn{constructor(t){a(this,"isBlocking",!0);this.index=t}isCleared(t){return!t[this.index].hasStaticEntity()}process(t,e,s){e.AI.attack(t[this.index].getStaticEntity().getAgent())}}const Ae=(n=ti)=>t=>{const e=[];return t.forEach((s,i)=>{s.hasStaticEntity()&&n.has(s.getStaticEntity().getAgent().getType())&&e.push(new Dn(i))}),e},_s=(n,t)=>({...n,...t}),xe={[g.Grass]:3,[g.Water]:20,[g.Stone]:4,[g.Wall]:3,[g.Spore]:2,[g.ElectricFence]:5,[g.Fence]:20,[g.Freezer]:6,[g.Obstructed]:3,[g.Bridge]:5,[g.Dirt]:2.5,[g.Sand]:3.5,[g.Snow]:3.5,[g.Ice]:10,[g.PlayerBuilding]:3,[g.Tree]:5,[g.Rock]:5,[g.Base]:Number.EPSILON},ke={[g.Fence]:5,[g.ElectricFence]:40,[g.Wall]:500,[g.Freezer]:.5,[g.Obstructed]:500,[g.PlayerBuilding]:-10},Cn={[g.Grass]:3,[g.Water]:3,[g.Stone]:3,[g.Wall]:3,[g.Spore]:3,[g.ElectricFence]:3,[g.Fence]:3,[g.Freezer]:6,[g.Obstructed]:3,[g.Bridge]:3,[g.Dirt]:3,[g.Sand]:3,[g.Snow]:3,[g.Ice]:3,[g.PlayerBuilding]:3,[g.Tree]:3,[g.Rock]:3,[g.Base]:Number.EPSILON},Bn={[g.Fence]:3,[g.ElectricFence]:3,[g.Wall]:5,[g.Tree]:4,[g.Rock]:3,[g.Freezer]:.5,[g.Obstructed]:5,[g.PlayerBuilding]:-10},Z=600;class Pe{constructor(t,e){a(this,"predictedHp");a(this,"cooldown",0);a(this,"callback");this.enemy=t,this.hp=e,this.predictedHp=e}tick(t){if(this.cooldown<t&&this.callback&&(this.callback(),this.callback=void 0),this.cooldown=Math.max(0,this.cooldown-t),this.enemy.getPath().isPaused(this.enemy)&&!this.isBusy()){const e=this.enemy.getPath().getTile();this.enemy.entity.setX(e.getX()),this.enemy.entity.setY(e.getY());const s=this.enemy.getPath().getNextCheckpoint();s&&s.process(this.enemy.getPath().getTiles(),this.enemy,t)}if(this.isBusy())this.getTargeted(this.enemy.getPath().getCurrentTile(),t);else{this.enemy.isVisible()||this.enemy.getPath().fastForward(this.enemy);const{from:e,to:s,step:i}=this.enemy.getPath().performStep(this.enemy,t);this.enemy.entity.move(e,s,i),this.getTargeted(e,t)}}attack(t){t.hit&&this.cooldown===0&&(t.hit(this.enemy.getDamage()*u.Instance.getDamageMultiplier()),this.cooldown=this.enemy.isVisible()?Z:0)}interact(t,e=Z){this.callback=t,this.cooldown===0&&this.enemy.isVisible()&&(this.cooldown=e)}getTargeted(t,e){if(this.predictedHp>0&&this.enemy.isVisible()){for(let s of t.getAvailableTowers())if(this.predictedHp-=s.fire(this.enemy,e),this.predictedHp<=0)break}}hit(t){this.hp-=t,this.hp<this.predictedHp&&(this.predictedHp=this.hp),this.hp<=0&&u.Instance.despawnEnemy(this.enemy)}miss(t){this.predictedHp+=t}isBusy(){return this.cooldown!==0}getFuturePosition(t){const e=this.enemy.getPath().getFuturePosition(t),s=this.enemy.getPath().getCheckpoints();for(let i=0;i<s.length;i++){let r=s[i];if(r.index>e)return e;if(r.isBlocking)return r.index-1}return e}}const hi=new Set(ti);hi.delete(h.Tree);const Ln=Ae(hi),Fn=3e3,On=.01,Yn=.025,Xn=30;var bt;let Et=(bt=class{constructor(t,e){a(this,"entity");a(this,"category",T.Enemy);a(this,"status",R.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new q(t.getX(),t.getY(),this),this.ai=new Pe(this,Xn)}initializePath(){this.path.setSpeed(Yn),this.path.setCheckpoints(Ln(this.path.getTiles()))}get AI(){return this.ai}getDamage(){return 4}getType(){return Et.type}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status===R.OnFire&&(this.statusDuration-=t,this.statusDuration<=0?this.status=R.Normal:this.ai.hit(On*t)),this.ai.tick(t)}isVisible(){return this.path.getTile().isDiscovered()}lightOnFire(){this.status=R.OnFire,this.statusDuration=Fn}},a(bt,"pathCosts",_s(xe,{[g.Tree]:3})),a(bt,"pathMultipliers",_s(ke,{[g.Water]:2})),a(bt,"type",h.Runner),a(bt,"cost",5),bt);class $n{constructor(t,e,s){a(this,"paths");this.pathfinder=t,this.startPoints=e,this.target=s}getPaths(){if(!this.paths){const t=this.startPoints.map(s=>this.pathfinder.getSurface().getTile(s.getX(),s.getY())),e=this.pathfinder.getSurface().getTile(this.target.getX(),this.target.getY());this.paths=this.pathfinder.getHivePath(t,e).filter(s=>!!s)}return this.paths}update(){this.paths=void 0}}class St{constructor(t,e,s,i,r,o=[]){a(this,"index",0);a(this,"sectionIndex",0);a(this,"tileSet");this.pathfinder=t,this.tiles=e,this.sections=s,this.speed=i,this.costs=r,this.checkpoints=o,this.tileSet=new Set(e)}performStep(t,e){const s=this.index%1,i=this.index|0,r=this.tiles[i],o=this.speed*e/(this.costs[i]??1);let c=this.index+o|0;i===c&&c++,c>=this.tiles.length-1&&(c=this.tiles.length-1);const l=this.tiles[c];for(;this.checkpoints.length>0;){const f=this.checkpoints[0];if(f&&c>=f.index)if(f.isCleared(this.tiles,t))this.checkpoints.shift();else return this.index=f.index-1,{from:this.tiles[this.index],to:l,step:0};else break}const p=this.costs[c]??1;for(this.index=Math.min(this.index+this.speed*e/p,this.tiles.length-1);this.index>this.sections[this.sectionIndex].to;)this.sectionIndex++;return{from:r,to:l,step:s}}getFuturePosition(t){let e=this.index,s=this.sectionIndex;for(;t>0;){const i=this.sections[s],r=i.to-e,o=r/this.speed*i.cost;if(t>o?(e+=r,s++,t-=o):(e+=r*t/o,t=0),e>=this.tiles.length-1)return this.tiles.length-1}return e}fastForward(t){let e=this.checkpoints[0];for(let s=(this.index|0)+1;s<this.tiles.length;s++){if(e&&s>=e.index)if(e.isCleared(this.tiles,t))this.checkpoints.shift(),e=this.checkpoints[0];else break;if(this.getTile(s).isDiscovered())break;this.index=s}}clone(){return new St(this.pathfinder,this.tiles,this.sections,this.speed,this.costs,[...this.checkpoints])}slice(t=0,e=Number.MAX_VALUE){const s=this.tiles.slice(t,e),i=this.costs.slice(t,e),r=St.calculateSections(s,i),o=this.checkpoints.filter(c=>c.index>=t&&c.index<e);return new St(this.pathfinder,s,r,this.speed,i,o)}setIndex(t){this.index=Math.max(Math.min(t,this.tiles.length-1),0),this.sectionIndex=this.sections.findIndex(({from:e,to:s})=>this.index>=e&&this.index<s)}getIndex(){return this.index}getTile(t=this.index){return this.tiles[t|0]}getTiles(){return this.tiles}getLength(){return this.tiles.length}getCoordinates(t=this.index){if(t>=this.tiles.length-1){const r=this.tiles[this.tiles.length-1];return{x:r.getX(),y:r.getY()}}const e=t%1,s=this.tiles[t|0],i=this.tiles[(t|0)+1];return{x:(i.getX()-s.getX())*e+s.getX(),y:(i.getY()-s.getY())*e+s.getY()}}getSpeed(){return this.speed}setSpeed(t){this.speed=t}isDone(){return this.index===this.tiles.length-1}isPaused(t){if(this.isDone())return!0;const e=this.getNextCheckpoint();return e&&e.index===this.index+1&&!e.isCleared(this.tiles,t)}getNextCheckpoint(){return this.checkpoints[0]||null}getCheckpoints(){return this.checkpoints}setCheckpoints(t){this.checkpoints=t}getCurrentTile(){return this.tiles[this.index|0]}recompute(){const t=this.pathfinder.getSurface();let e;for(let s=0;s<this.tiles.length;s++){const i=this.tiles[s],r=t.getTile(i.getX(),i.getY());this.tiles[s]=r,this.costs[s]=this.pathfinder.getCost(r,e)??1,e=r,i!==r&&(this.tileSet.delete(i),this.tileSet.add(r))}this.sections=St.calculateSections(this.tiles,this.costs)}isAffectedByTiles(t){for(let e of t)if(this.tileSet.has(e))return!0;return!1}static calculateSections(t,e){return t.reduce((s,i,r)=>{const o=s[s.length-1],c=e[r];return o?(o.cost===c?o.to++:s.push({from:r,to:r+1,cost:c}),s):[{from:r,to:r+1,cost:c}]},[])}static fromTiles(t,e,s=1){const i=new St(t,e,[],s,[]);return i.recompute(),i}static fromMapAndCosts(t,e,s,i,r=1){let o=s;const c=[o];for(;o!==e;)o=i.get(o.getHash()),c.push(o);return this.fromTiles(t,c.reverse(),r)}}const Nn=[[0,-1],[-1,0],[1,0],[0,1],[-1,-1],[1,-1],[-1,1],[1,1]],Un=150;class Hn{constructor(t,e=ke,s=xe){a(this,"costFn");a(this,"costMultiplierFn");this.surface=t,this.costMultiplierFn=typeof e=="function"?e:i=>e[i.getType()]??1,this.costFn=typeof s=="function"?s:i=>s[i.getType()]??null}getPath(t,e,s){const i=s??this.costMultiplierFn,r=new Set,c=(this.costFn(t)??1)*i(t),l=new Map;l.set(t.getHash(),c);const p=new Map;p.set(t.getHash(),c);const f=new Map;f.set(t.getHash(),c+this.heuristic(t,e));const d=new cn((v,S)=>(f.get(v.getHash())??1/0)-(f.get(S.getHash())??1/0));d.push(t);const w=new Map;for(;!d.empty();){let v=d.pop();if(e===v)return St.fromMapAndCosts(this,t,e,w);const S=v.getHash(),E=Nn.map(([x,G])=>this.surface.getTile(x+v.getX(),G+v.getY())),D=[];this.setCostAndMultiplier(0,D,i,E[0]),this.setCostAndMultiplier(1,D,i,E[1]),this.setCostAndMultiplier(2,D,i,E[2]),this.setCostAndMultiplier(3,D,i,E[3]),this.setDiagonalCostAndMultiplier(4,0,1,D,i,E[4]),this.setDiagonalCostAndMultiplier(5,0,2,D,i,E[5]),this.setDiagonalCostAndMultiplier(6,1,3,D,i,E[6]),this.setDiagonalCostAndMultiplier(7,2,3,D,i,E[7]),E.forEach((x,G)=>{if(!x)return;const at=D[G*2];if(!at||r.has(x))return;const Q=x.getHash(),Ot=p.get(S)+D[G*2+1];if(Ot<(p.get(Q)??1/0)){const lt=l.get(S)+at;l.set(Q,lt),w.set(Q,v),p.set(Q,Ot),f.set(Q,Ot+this.heuristic(x,e)),d.push(x),r.add(v)}})}}getHivePath(t,e){const s={},i=r=>(s[r.getHash()]??1)*this.costMultiplierFn(r);return t.reduce((r,o,c)=>{const l=this.getPath(o,e,i);return r.push(l),l&&t.length>c-1&&l.getTiles().forEach(p=>{p.hasStaticEntity()&&(s[p.getHash()]=.85),s[p.getHash()]=s[p.getHash()]+.1||1.1}),r},[])}getCost(t,e){if(!e)return this.costFn(t);const s=this.costFn(t),i=this.costFn(e);if(!s||!i)return null;const r=(s+i)/2;return!s||!i||t.getX()===e.getX()||t.getY()==e.getY()?r:r+(this.costFn(this.surface.getTile(t.getX(),e.getY()))+this.costFn(this.surface.getTile(e.getX(),t.getY())))/4}getSurface(){return this.surface}heuristic(t,e){return Math.abs(t.getX()-e.getX())+Math.abs(t.getY()-e.getY())}setCostAndMultiplier(t,e,s,i){if(!i)return;const r=this.costFn(i);r&&(e[t*2]=r,e[t*2+1]=r*s(i))}setDiagonalCostAndMultiplier(t,e,s,i,r,o){if(!o||!i[e*2]||!i[s*2])return;const c=i[e*2+1]+i[s*2+1];if(c>Un)return;const l=this.costFn(o);l&&(i[t*2]=l+(i[e*2]+i[s*2])/4,i[t*2+1]=l*r(o)+c/4)}}const Te=class{constructor(t,e,s){a(this,"index",0);a(this,"pathData",new Map);a(this,"strength",0);a(this,"unit",Et);a(this,"energy",25);a(this,"spawnInterval",200);a(this,"spawnDelay",0);a(this,"burstSize",Number.POSITIVE_INFINITY);a(this,"burstInterval",1e3);a(this,"burst",0);a(this,"timer",0);a(this,"centerX",0);a(this,"centerY",0);this.spawnPoints=t,this.target=e,this.surface=s,t.forEach(i=>{this.centerX+=i.getX(),this.centerY+=i.getY()}),this.centerX/=t.length,this.centerY/=t.length}setUnit(t){this.unit=t}getUnitType(){return this.unit.type}setParameters(t,e,s,i,r){this.energy=t,this.spawnInterval=e,this.spawnDelay=s,this.burstSize=i,this.burstInterval=r,this.burst=0,this.timer=0}getEnergy(){return this.energy}tick(t){if(this.energy!==0){if(this.timer+=t,this.spawnDelay>0)if(this.timer>this.spawnDelay)this.timer-=this.spawnDelay,this.spawnDelay=0;else return;if(this.burst>=this.burstSize)if(this.timer>=this.burstInterval)this.timer-=this.burstInterval,this.burst=0;else return;if(this.timer>=this.spawnInterval){this.timer-=this.spawnInterval,this.energy=Math.max(0,this.energy-this.unit.cost);const e=this.getNextUnit();u.Instance.spawnEnemy(e)}}}getCenter(){return[this.centerX,this.centerY]}getPathData(t){return this.pathData.has(t)||this.pathData.set(t,new $n(new Hn(this.surface,this.unit.pathMultipliers,this.unit.pathCosts),this.spawnPoints,this.target)),this.pathData.get(t)}getSpawnPoints(){return this.getPathData(this.unit.type).getPaths()}getNextSpawnPoint(){const t=this.getSpawnPoints(),e=t[this.index];return this.index=(this.index+1)%t.length,e}getNextUnit(){const t=this.getNextSpawnPoint().clone(),e=new this.unit(t.getTile(),t);return e.initializePath(),e}grow(){this.strength++}getStrength(){return this.strength}isExposed(){let t=0,e=0;return this.surface.forCircle(this.centerX,this.centerY,Te.Radius,s=>{t++,s.getDiscoveryStatus()!==B.Undiscovered&&e++}),e/t}rePath(){this.pathData.forEach(t=>t.update())}static fromTiles(t,e,s){return new Te(t,e,s)}};let gt=Te;a(gt,"Radius",5);const li=(n,t)=>(n%t+t)%t,wt=(n,t,e)=>n+(t-n)*e,Wn=(n,t,e)=>{if(n===t)return t;const s=li(t-n+180,360)-180;return s<0?(n-Math.min(-s,e)+360)%360:n+Math.min(s,e)};let Vn=class{constructor(t){a(this,"entity");a(this,"category",T.Unknown);a(this,"renderData",{});a(this,"targetX",0);a(this,"targetY",0);a(this,"travelTime",0);a(this,"time",0);a(this,"sourceX",0);a(this,"sourceY",0);this.tile=t,this.entity=new q(t.getX()+.5,t.getY()+.5,this),this.sourceX=this.entity.getX(),this.sourceY=this.entity.getY()}tick(t){if(this.travelTime>0&&this.time<this.travelTime){this.time+=t;const e=Math.min(1,this.time/this.travelTime);this.entity.setX(wt(this.tile.getX(),this.targetX,e)),this.entity.setY(wt(this.tile.getY(),this.targetY,e)),this.time>=this.travelTime&&u.Instance.getSurface().despawn(this)}}discover(){const t=u.Instance.getBase(),[e,s]=vt(t);this.targetX=e,this.targetY=s,this.travelTime=Math.sqrt((e-this.tile.getX())**2+(s-this.tile.getY())**2)*60}getType(){return h.WavePoint}isVisible(){return this.travelTime>0}};var H=(n=>(n.Easy="easy",n.Normal="normal",n.Hard="hard",n))(H||{});const As={easy:{label:"Easy",description:"Allows checking which tiles are covered by tower sight lines. Shows the approximate path enemies will take and undiscovered nests do not become stronger."},normal:{label:"Normal",description:"Allows checking which tiles are covered by tower sight lines. Enemies are a bit stronger and undiscovered nests slowly gain more strength."},hard:{label:"Hard",description:"Checking tower sight lines is no longer possible, enemies are stronger and undiscovered nests gain strength more quickly"}};class Pt{constructor(t,e,s){this.min=t,this.max=e,this.unit=s}getRange(){return[this.min,this.max]}getCenter(){return(this.min+this.max)/2}getLength(){return this.max-this.min}getUnit(){return this.unit}equals(t){return this.min===t.min&&this.max===t.max}toString(){return`[${this.min}, ${this.max}]`}static forSpawnGroup(t){const[e,s]=t.getCenter(),i=u.Instance.getBase().getTile(),r=e-i.getX(),o=s-i.getY(),c=(Math.atan2(o,r)*180/Math.PI+360)%360;switch(u.Instance.getDifficulty()){case H.Easy:return new Pt(Math.floor(c/15)*15,Math.floor(c/15)*15+15,t.getUnitType());case H.Normal:return new Pt(Math.floor(c/45)*45,Math.floor(c/45)*45+45);case H.Hard:return new Pt(Math.floor(c/120)*120,Math.floor(c/120)*120+120)}}static forSpawnGroups(t){const e=new Map;return t.filter(s=>!s.isExposed()).forEach(s=>{const i=Pt.forSpawnGroup(s);e.set(i.toString(),i)}),[...e.values()]}}const jn=(n,t)=>{const e=new Array(t).fill(0).map(Math.random),s=e.reduce((i,r)=>i+r);return e.map(i=>i/s*n)},Rt=()=>{let n=1-Math.random(),t=Math.random(),e=Math.sqrt(-2*Math.log(n))*Math.cos(2*Math.PI*t);return e=e/10+.5,e>1||e<0?Rt():e},Gn=Ae(Je),zn=3e3,Kn=.01,qn=.006,Zn=80;var _t;let ui=(_t=class{constructor(t,e){a(this,"entity");a(this,"category",T.Enemy);a(this,"status",R.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new q(t.getX(),t.getY(),this),this.ai=new Pe(this,Zn)}initializePath(){this.path.setSpeed(qn),this.path.setCheckpoints(Gn(this.path.getTiles()))}get AI(){return this.ai}getDamage(){return 7}getType(){return ui.type}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status===R.OnFire&&(this.statusDuration-=t,this.statusDuration<=0?this.status=R.Normal:this.ai.hit(Kn*t)),this.ai.tick(t)}isVisible(){return this.path.getTile().isDiscovered()}lightOnFire(){this.status=R.OnFire,this.statusDuration=zn}},a(_t,"pathCosts",Cn),a(_t,"pathMultipliers",Bn),a(_t,"type",h.Flier),a(_t,"cost",12),_t);const di=(n,...t)=>{const e=[];return t.filter(Boolean).forEach(s=>e.push(...s(n))),e.sort((s,i)=>s.index-i.index),e},He=(n,t)=>{if(n>Math.random())return t},We=new Set([g.Grass,g.Snow]);class Jn{constructor(t){a(this,"isBlocking",!1);this.index=t}isCleared(t,e){return!We.has(t[this.index-1].getType())}process(t,e,s){const i=u.Instance.getSurface(),r=t[this.index-1];We.has(r.getType())&&i.setTile(new st(r.getX(),r.getY(),g.Dirt))}}const gi=n=>{const t=[],e=Math.random()*n.length/10,s=n.filter(i=>We.has(i.getType()));for(let i=0;i<e&&s.length;i++){const r=s.splice(Math.floor(Math.random()*s.length),1)[0];t.push(new Jn(n.indexOf(r)+1))}return t};class xs{constructor(t){a(this,"isBlocking",!0);this.index=t}isCleared(t,e){return!this.getTiles(t[this.index],e).length}process(t,e,s){const i=u.Instance.getSurface(),r=t[this.index],o=this.getTiles(r,e);if(o.length>0){const c=o[0];e.entity.lookAt(c),e.AI.interact(()=>{i.getTile(c.getX(),c.getY()).getType()===g.Water&&i.setTile(new st(c.getX(),c.getY(),g.Bridge))})}}getTiles(t,e){const s=u.Instance.getSurface(),i=[];return t.getType()===g.Water&&i.push(t),e.entity.getAlignedX()!==t.getX()&&e.entity.getAlignedY()!==t.getY()&&[[e.entity.getAlignedX(),t.getY()],[t.getX(),e.entity.getAlignedY()]].forEach(([r,o])=>{const c=s.getTile(r,o);(c==null?void 0:c.getType())===g.Water&&i.push(c)}),i}}const Qn=n=>{const t=[];for(let e=0;e<n.length;e++)n[e].getType()===g.Water&&(t.push(new xs(e)),e+1<n.length&&n[e+1].getType()!==g.Water&&t.push(new xs(e+1)));return t},ta=Ae(),ea=3e3,sa=.01,ia=.01,na=100;var At;let pi=(At=class{constructor(t,e){a(this,"entity");a(this,"category",T.Enemy);a(this,"status",R.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new q(t.getX(),t.getY(),this),this.ai=new Pe(this,na)}initializePath(){this.path.setSpeed(ia),this.path.setCheckpoints(di(this.path.getTiles(),ta,He(.5,gi),He(.1,Qn)))}get AI(){return this.ai}getDamage(){return 6}getType(){return pi.type}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status===R.OnFire&&(this.statusDuration-=t,this.statusDuration<=0?this.status=R.Normal:this.ai.hit(sa*t)),this.ai.tick(t)}isVisible(){return this.path.getTile().isDiscovered()}lightOnFire(){this.status=R.OnFire,this.statusDuration=ea}},a(At,"pathCosts",xe),a(At,"pathMultipliers",ke),a(At,"type",h.Slime),a(At,"cost",7),At);const aa=Ae(),ra=3e3,oa=.01,ca=.008,ha=200;var xt;let fi=(xt=class{constructor(t,e){a(this,"entity");a(this,"category",T.Enemy);a(this,"status",R.Normal);a(this,"statusDuration",0);a(this,"renderData",{});a(this,"ai");this.path=e,this.entity=new q(t.getX(),t.getY(),this),this.ai=new Pe(this,ha)}initializePath(){this.path.setSpeed(ca),this.path.setCheckpoints(di(this.path.getTiles(),aa,He(.5,gi)))}get AI(){return this.ai}getDamage(){return 9}getType(){return fi.type}getPath(){return this.path}getStatus(){return this.status}tick(t){this.status===R.OnFire&&(this.statusDuration-=t,this.statusDuration<=0?this.status=R.Normal:this.ai.hit(oa*t)),this.ai.tick(t)}isVisible(){return this.path.getTile().isDiscovered()}lightOnFire(){this.status=R.OnFire,this.statusDuration=ra}},a(xt,"pathCosts",xe),a(xt,"pathMultipliers",ke),a(xt,"type",h.Tank),a(xt,"cost",20),xt);const la=4e3,ua=200,da=500,ga=500,pa=3e3,fa=3,ma=12,ya=1.1,wa={[H.Easy]:0,[H.Normal]:1.5*Et.cost,[H.Hard]:3*Et.cost};class Vt{constructor(t){this.spawnGroups=t}isDone(){return!this.spawnGroups.find(t=>t.getEnergy()>0)}getSpawnGroups(){return this.spawnGroups}tick(t){this.spawnGroups.forEach(e=>e.tick(t))}static fromSpawnGroups(t,e){const s=(1+t**2)*Et.cost,i=jn(s,e.length),r=wa[u.Instance.getDifficulty()];return e.forEach((o,c)=>{const l=i[c]*ya+r*o.getStrength(),p=c===0||Math.random()>.5?0:Rt()*la,f=Math.random()>.5?Rt()*ma+fa:Number.POSITIVE_INFINITY;o.setParameters(l,Rt()*da+ua,p,f,Rt()*pa+ga)}),new Vt(e)}static getUnitForLevel(t){if(t===0)return Et;const e=Math.random();return e<Math.min(.2,.75-t**2/100)?Et:t>=3&&e>Math.max(.7,1-t/50)?ui:e>.1+t/25?pi:fi}}const us=class{constructor(t,e){a(this,"spawnGroups",[]);a(this,"nextSpawnGroup");a(this,"direction",Math.random()*Math.PI*2);a(this,"wave");a(this,"timeSinceLastExpansion",0);a(this,"onSurfaceChange",({affectedTiles:t,removedStaticAgents:e})=>{const s=this.isWaveInProgress();this.spawnGroups.forEach(r=>{s?r.getSpawnPoints().forEach(o=>{o.isAffectedByTiles(t)&&o.recompute()}):(e.size>0||!!r.getSpawnPoints().find(c=>c.isAffectedByTiles(t)))&&r.rePath()});const i=this.getNextSpawnGroup();!s&&i&&(e.size>0||!!i.getSpawnPoints().find(o=>o.isAffectedByTiles(t)))&&i.rePath()});this.base=t,this.surface=e,us.instance=this,b.Instance.addEventListener(M.SurfaceChange,this.onSurfaceChange)}tick(t){!this.wave||this.wave.tick(t)}startNewWave(){const t=u.Instance.getLevel();W.Instance.hasPendingAgents()&&(this.timeSinceLastExpansion=0),this.cleanupSpawnGroups(),this.spawnGroups.forEach(s=>{s.grow(),s.rePath()}),this.direction+=(Math.random()>.5?1:-1)*Math.max(Math.PI/6*Rt()*Math.min(Math.PI*2,(t+1)/1.5));const e=this.getNextSpawnGroup();if(e){this.timeSinceLastExpansion=0;const s=e.getSpawnPoints()[0].getTile(0),i=[];this.surface.forCircle(s.getX(),s.getY(),gt.Radius,r=>{ts.has(r.getType())&&i.push(new st(r.getX(),r.getY(),g.Spore))}),this.surface.setTiles(i),this.spawnGroups.push(e)}this.nextSpawnGroup=void 0,this.wave=Vt.fromSpawnGroups(t,this.spawnGroups)}processWave(){return this.isWaveInProgress()?!1:(this.timeSinceLastExpansion++,this.spawnGroups.forEach(t=>t.setUnit(Vt.getUnitForLevel(u.Instance.getLevel()))),!0)}cleanupSpawnGroups(){for(let t=this.spawnGroups.length-1;t>=0;t--){const e=this.spawnGroups[t];if(e.isExposed()>0){this.spawnGroups.splice(t,1),W.Instance.uncoverSpawnGroup(e);const s=new Vn(this.surface.getTile(...e.getCenter()));this.surface.spawn(s),s.discover()}}}getWave(){return this.wave}getSpawnGroups(){const t=this.spawnGroups.filter(e=>e.isExposed()===0);if(!this.isWaveInProgress()){const e=this.getNextSpawnGroup();e&&t.push(e)}return t}getSpawnAlertRanges(){return Pt.forSpawnGroups(this.getSpawnGroups())}isWaveInProgress(){return this.wave&&!this.wave.isDone()?!0:this.surface.getEntitiesForCategory(T.Enemy).size>0}shouldAddSpawnGroup(){const t=Math.ceil(2**this.spawnGroups.length/3),e=W.Instance.hasPendingAgents()?0:this.timeSinceLastExpansion;return this.spawnGroups.filter(i=>i.isExposed()===0).length===0||e>=t}getNextSpawnGroup(){if(!this.shouldAddSpawnGroup())return;if(this.nextSpawnGroup&&!this.nextSpawnGroup.isExposed())return this.nextSpawnGroup;let t=!1,e=3;for(let s=0;s<20&&(this.surface.forRay(this.base.getTile().getX(),this.base.getTile().getY(),this.direction,i=>i.getDiscoveryStatus()!==B.Undiscovered?(e=4+Math.min(u.Instance.getLevel(),Math.floor(Math.random()*4)),!0):(e--,e>0?!0:Qe.has(i.getType())?(this.nextSpawnGroup=gt.fromTiles([i,i,i,i],this.base.getTile(),this.surface),this.nextSpawnGroup.setUnit(Vt.getUnitForLevel(u.Instance.getLevel())),t=!0,!1):!(u.Instance.getLevel()===0&&s<10))),!t);s++)this.direction+=Math.PI/10;return this.nextSpawnGroup}static get Instance(){return this.instance}};let U=us;a(U,"instance");const Be=n=>n.getType()===h.Base,ds=class{constructor(t){a(this,"discoveredSpawnGroups",new Set);a(this,"agents",new Set);a(this,"edgeMap",new Map);a(this,"pendingAgents",new Set);a(this,"base");a(this,"pendingRadius",0);a(this,"minX");a(this,"minY");a(this,"maxX");a(this,"maxY");this.surface=t,ds.instance=this}registerAgent(t){this.agents.add(t);let e=B.Pending;Be(t)?(this.base=t,e=B.Discovered):this.pendingAgents.add(t);const s=this.getVisibilityRange(t),i=this.getVisibilityEdge(t);this.edgeMap.set(t.entity.getId(),i),this.updateVisibility(...i,s,e)}removeAgent(t){if(!this.agents.has(t))return;Be(t)&&(this.base=void 0);const e=this.getVisibilityRange(t),s=this.edgeMap.get(t.entity.getId());this.surface.forCircle(...s,e,i=>i.setDiscoveryStatus(B.Undiscovered)),this.agents.delete(t),this.pendingAgents.delete(t),this.edgeMap.delete(t.entity.getId()),this.update()}commit(){this.pendingAgents.clear(),this.pendingRadius=0,this.update()}update(){this.minX=void 0,this.minY=void 0,this.maxX=void 0,this.maxY=void 0,this.agents.forEach(s=>{const i=this.getVisibilityRange(s),r=this.edgeMap.get(s.entity.getId());this.surface.forCircle(...r,i,o=>o.setDiscoveryStatus(B.Undiscovered))}),this.pendingRadius>0&&this.base&&this.updateVisibility(...this.getVisibilityEdge(this.base),this.pendingRadius,B.Pending),this.agents.forEach(s=>{const i=this.pendingAgents.has(s)?B.Pending:B.Discovered,r=this.getVisibilityRange(s),o=this.getVisibilityEdge(s);this.edgeMap.set(s.entity.getId(),o),this.updateVisibility(...o,r,i)});const t=[],e=U.Instance.getSpawnGroups();this.discoveredSpawnGroups.forEach(s=>{if(s.isExposed()===0){t.push(s);return}const i=s.getCenter();this.updateVisibility(...i,5,B.Discovered)}),e.forEach(s=>{const[i,r]=s.getCenter();this.surface.forCircle(i,r,gt.Radius,o=>{o.getDiscoveryStatus()!==B.Undiscovered&&o.setDiscoveryStatus(B.Undiscovered)})}),t.forEach(s=>this.discoveredSpawnGroups.delete(s))}updateBaseRange(){if(!this.base)throw new Error("Updating base range without a base");this.pendingRadius=this.getVisibilityRange(this.base),this.updateVisibility(...this.getVisibilityEdge(this.base),this.pendingRadius,B.Pending)}getBBox(){return[[this.minX,this.minY],[this.maxX,this.maxY]]}hasPendingAgents(){return this.pendingAgents.size>0}uncoverSpawnGroup(t){const e=U.Instance.getSpawnGroups();this.discoveredSpawnGroups.add(t);const[s,i]=t.getCenter();this.updateVisibility(s,i,gt.Radius,B.Discovered),e.forEach(r=>{const[o,c]=r.getCenter();this.surface.forCircle(o,c,gt.Radius,l=>{l.getDiscoveryStatus()!==B.Undiscovered&&l.setDiscoveryStatus(B.Undiscovered)})}),b.Instance.triggerEvent(M.Discover,{x:s,y:i})}getVisibilityRange(t){switch(t.getType()){case h.Base:return 35+(u.Instance.getLevel()-(this.pendingRadius>0?1:0))*2;case h.Radar:return 17;default:throw new Error("Entity has no visibility defined")}}getVisibilityEdge(t){if(Be(t)||!this.base)return[t.entity.getAlignedX(),t.entity.getAlignedY()];let e;const s=Math.atan2(t.entity.getAlignedY()-this.base.entity.getAlignedY(),t.entity.getAlignedX()-this.base.entity.getAlignedX());return this.surface.forRay(this.base.entity.getAlignedX(),this.base.entity.getAlignedY(),s,i=>i.getDiscoveryStatus()===B.Undiscovered?!1:(e=i,!0)),e?[e.getX(),e.getY()]:[t.entity.getAlignedX(),t.entity.getAlignedY()]}updateVisibility(t,e,s,i){(!this.minX||t-s/2<this.minX)&&(this.minX=t-s/2),(!this.minY||e-s/2<this.minY)&&(this.minY=e-s/2),(!this.maxX||t+s/2>this.maxX)&&(this.maxX=t+s/2),(!this.maxY||e+s/2>this.maxY)&&(this.maxY=e+s/2),this.surface.forCircle(t,e,s,r=>{i===B.Pending&&r.isDiscovered()||r.setDiscoveryStatus(i)})}static get Instance(){return this.instance}};let W=ds;a(W,"instance");class mi{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"renderData",{});this.tile=t,this.entity=new O(t.getX(),t.getY(),this)}getType(){return h.Radar}getTile(){return this.tile}updateTile(t){this.tile=t}spawn(){W.Instance.registerAgent(this),u.Instance.getBase().addPart(this),ee(this,3)}despawn(){W.Instance.removeAgent(this),u.Instance.getBase().removePart(this)}hit(t){u.Instance.getBase().hit(t)}isVisible(){return!0}}a(mi,"scale",2);const be=class{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"hp",50);a(this,"renderData",{});this.tile=t,this.entity=new O(t.getX(),t.getY(),this)}spawn(){u.Instance.getSurface().getAdjacentTiles(this.tile,be.scale).forEach(t=>t.addLinkedAgent(this))}despawn(){u.Instance.getSurface().getAdjacentTiles(this.tile,be.scale).forEach(t=>t.removeLinkedAgent(this))}getType(){return h.DamageBeacon}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}};let jt=be;a(jt,"scale",2);const se=(n,t,e)=>{const s=u.Instance.getSurface(),i=new Set,r=()=>{const c=new Set(s.getEntityTiles(n));s.forCircle(n.entity.getX()+1,n.entity.getY()+1,t,l=>{s.forLine(n.entity.getX(),n.entity.getY(),l.getX(),l.getY(),p=>{if(p.addTower(n),i.add(p),!c.has(p)&&e&&e(p))return!1},{connected:!0})},{edgeOnly:!0})};r();const o=b.Instance.addEventListener(M.SurfaceChange,({affectedTiles:c})=>{for(const l of c)if(i.has(l)){i.forEach(p=>p.removeTower(n)),i.clear(),r();return}});return()=>{i.forEach(c=>c.removeTower(n)),o()}},ie=n=>{let t=1;return n.forEach(e=>{e instanceof Wt&&(t+=.5)}),t},ne=n=>{let t=1;return n.forEach(e=>{e instanceof jt&&(t+=.5)}),t},va=new Set([g.Obstructed,g.Wall,g.PlayerBuilding,g.Base]),ae=n=>va.has(n.getType()),Ve=250;let Sa=class{constructor(t){a(this,"entity");a(this,"category",T.Unknown);a(this,"time",0);a(this,"renderData",{});a(this,"sourceX");a(this,"sourceY");this.source=t;const[e,s]=vt(t);this.entity=new q(e,s,this),this.sourceX=e,this.sourceY=s}dealDamage(t,e){this.renderData.update=!0,this.time>Ve&&u.Instance.getSurface().spawn(this),this.time=0;const s=Math.atan2(t.entity.getX()+.5-this.sourceX,t.entity.getY()+.5-this.sourceY);this.entity.setRotation(s*180/Math.PI),this.source.entity.setRotation(-this.entity.getRotation()+180),this.entity.setX(t.entity.getAlignedX()),this.entity.setY(t.entity.getAlignedY()),t.AI.hit(e),t.lightOnFire&&t.lightOnFire()}tick(t){this.time+=t,this.time>Ve&&u.Instance.getSurface().despawn(this)}getType(){return h.Flame}isVisible(){return!0}};const ks=1,Ea=.04,gs=class{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"flame");a(this,"hp",160);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});this.tile=t,this.entity=new O(t.getX(),t.getY(),this)}tick(t){!this.isEnabled||(this.cooldown=Math.max(0,this.cooldown-t))}fire(t,e){this.cooldown=ks;const s=u.Instance.consumeContinuous(this,e,this.damageMultiplier*this.speedMultiplier),i=Ea*(s?this.damageMultiplier*this.speedMultiplier:1)*e;return this.flame||(this.flame=new Sa(this),u.Instance.getSurface().spawn(this.flame)),this.flame.dealDamage(t,i),this.renderData.fired=!0,i}spawn(){this.cleanupEventListener=se(this,gs.range,ae)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=ie(t),this.damageMultiplier=ne(t)}getCooldown(){return this.cooldown}getType(){return h.Flamethrower}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=ks,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}};let Xt=gs;a(Xt,"scale",2),a(Xt,"range",6);class yi{constructor(){a(this,"source");a(this,"target");a(this,"sourceX");a(this,"sourceY");a(this,"targetX");a(this,"targetY");a(this,"travelTime")}}function wi(n,t=0){const[e,s]=vt(this.source);this.sourceX=e,this.sourceY=s;const i=e-this.target.entity.getX()+.5,r=s-this.target.entity.getY()+.5,o=Math.sqrt(i*i+r*r)+t;this.travelTime=o/n;const c=this.target.AI.getFuturePosition(this.travelTime),{x:l,y:p}=this.target.getPath().getCoordinates(c);this.targetX=l+.5,this.targetY=p+.5}const Ma=.01,Ps=5,Rs=2,Ia=Rs*Rs;let Ta=class extends yi{constructor(e,s,i){super();a(this,"entity");a(this,"category",T.Unknown);a(this,"renderData",{});a(this,"time",0);a(this,"prevX");a(this,"prevY");this.source=e,this.target=s,this.damage=i,wi.call(this,Ma,Ps*2),this.entity=new q(this.sourceX,this.sourceY,this),this.entity.lookAt(this.targetX,this.targetY),this.source.entity.setRotation(this.entity.getRotation()),this.entity=new q(this.sourceX,this.sourceY,this),this.entity.lookAt(this.targetX,this.targetY),this.source.entity.setRotation(this.entity.getRotation())}tick(e){if(this.time>=this.travelTime){u.Instance.getSurface().despawn(this);let r=!1;[...u.Instance.getSurface().getEntitiesForCategory(T.Enemy)].filter(o=>{const c=o.getX()-this.entity.getX(),l=o.getY()-this.entity.getY();return c*c+l*l<Ia}).forEach(o=>{o.getAgent().AI.hit(this.damage),o.getAgent()===this.target&&(r=!0)}),r||this.target.AI.miss(this.damage)}this.time=Math.min(this.time+e,this.travelTime);const s=this.time/this.travelTime,i=Math.sin(s*Math.PI)*Ps;if(this.entity.setX(wt(this.sourceX,this.targetX,s)),this.entity.setY(wt(this.sourceY,this.targetY,s)-i),this.prevX&&this.prevY){const r=this.entity.getX()-this.prevX,o=this.entity.getY()-this.prevY;this.entity.setRotation(Math.atan2(o,r)*180/Math.PI+90)}this.prevX=this.entity.getX(),this.prevY=this.entity.getY()}getType(){return h.Rocket}isVisible(){return!0}};const Ds=5e3,ba=50,ps=class{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"hp",80);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});this.tile=t,this.entity=new O(t.getX(),t.getY(),this)}tick(t){!this.isEnabled||this.cooldown<=0||(this.cooldown-=t*this.speedMultiplier)}fire(t){this.cooldown+=Ds;const e=u.Instance.consume(this,this.speedMultiplier,this.damageMultiplier),s=ba*(e?this.damageMultiplier:0),i=new Ta(this,t,s);return u.Instance.getSurface().spawn(i),this.renderData.fired=!0,s}spawn(){this.cleanupEventListener=se(this,ps.range)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=ie(t),this.damageMultiplier=ne(t)}getCooldown(){return this.cooldown}getType(){return h.Mortar}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=Ds,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}};let $t=ps;a($t,"scale",2),a($t,"range",30);const _a=(n,t,e,s,i)=>{const r=Math.atan2(i-t,s-n);let o=li(r-e+Math.PI,Math.PI*2)-Math.PI;return Math.abs(o)>=Math.PI?Number.POSITIVE_INFINITY:Math.abs(Math.cos(e)*(t-i)-Math.sin(e)*(n-s))},Cs=(n,t,e,s)=>(n-e)**2+(t-s)**2,es=1500;let Aa=class{constructor(t,e,s){a(this,"entity");a(this,"category",T.Unknown);a(this,"renderData",{});a(this,"targetX");a(this,"targetY");a(this,"time",0);this.source=t,this.damage=s;const[i,r]=vt(t);this.entity=new q(i,r,this);const o=Math.atan2(e.entity.getY()+.5-this.entity.getY(),e.entity.getX()+.5-this.entity.getX());this.entity.setRotation(o*180/Math.PI),this.source.entity.setRotation(this.entity.getRotation()+90),u.Instance.getSurface().forRay(e.entity.getX(),e.entity.getY(),o,l=>(this.targetX=l.getX(),this.targetY=l.getY(),!ae(l)));const c=Cs(this.entity.getX(),this.entity.getY(),this.targetX,this.targetY);[...u.Instance.getSurface().getEntitiesForCategory(T.Enemy)].filter(l=>Cs(this.entity.getX(),this.entity.getY(),l.getX()+.5,l.getY()+.5)<=c+1).filter(l=>_a(this.entity.getX(),this.entity.getY(),o,l.getX()+.5,l.getY()+.5)<=.5).forEach(l=>{l.getAgent().AI.hit(this.damage)})}tick(t){this.time+=t,this.time>es&&u.Instance.getSurface().despawn(this)}getType(){return h.Rail}isVisible(){return!0}};const Bs=5e3,xa=70,fs=class{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"hp",80);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});this.tile=t,this.entity=new O(t.getX(),t.getY(),this)}tick(t){!this.isEnabled||this.cooldown<=0||(this.cooldown-=t*this.speedMultiplier)}fire(t){if(this.cooldown+=Bs,!u.Instance.consume(this,this.speedMultiplier,this.damageMultiplier))return 0;const e=xa*this.damageMultiplier,s=new Aa(this,t,e);return u.Instance.getSurface().spawn(s),this.renderData.fired=!0,e}spawn(){this.cleanupEventListener=se(this,fs.range,ae)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=ie(t),this.damageMultiplier=ne(t)}getCooldown(){return this.cooldown}getType(){return h.Railgun}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=Bs,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}};let Nt=fs;a(Nt,"scale",2),a(Nt,"range",30);const ka=.015;class Pa extends yi{constructor(e,s,i){super();a(this,"entity");a(this,"category",T.Unknown);a(this,"renderData",{});a(this,"time",0);this.source=e,this.target=s,this.damage=i,wi.call(this,ka),this.entity=new q(this.sourceX,this.sourceY,this),this.entity.lookAt(this.targetX,this.targetY),this.source.entity.setRotation(this.entity.getRotation())}tick(e){this.time>=this.travelTime&&(u.Instance.getSurface().despawn(this),this.target.AI.hit(this.damage)),this.time=Math.min(this.time+e,this.travelTime);const s=this.time/this.travelTime;this.entity.setX(wt(this.sourceX,this.targetX,s)),this.entity.setY(wt(this.sourceY,this.targetY,s))}getType(){return h.Bullet}isVisible(){return!0}}const Ls=500,Ra=10;var fe;let vi=(fe=class{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"hp",50);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});this.tile=t,this.entity=new O(t.getX(),t.getY(),this)}tick(t){!this.isEnabled||this.cooldown<=0||(this.cooldown-=t*this.speedMultiplier)}fire(t){this.cooldown+=Ls;const e=u.Instance.consume(this,this.speedMultiplier,this.damageMultiplier),s=Ra*(e?this.damageMultiplier:1),i=new Pa(this,t,s);return u.Instance.getSurface().spawn(i),this.renderData.fired=!0,s}spawn(){this.cleanupEventListener=se(this,vi.range,ae)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=ie(t),this.damageMultiplier=ne(t)}getCooldown(){return this.cooldown}getType(){return h.Tower}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=Ls,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}},a(fe,"scale",2),a(fe,"range",10),fe);class Si{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"hp",50);a(this,"renderData",{});this.tile=t,this.entity=new O(t.getX(),t.getY(),this)}getType(){return h.Wall}getTile(){return this.tile}updateTile(t){this.tile=t}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}}a(Si,"scale",2);const Se=250;let Da=class{constructor(t){a(this,"entity");a(this,"category",T.Unknown);a(this,"renderData",{});a(this,"time",0);a(this,"targetX",0);a(this,"targetY",0);this.source=t;const[e,s]=vt(t);this.entity=new q(e,s,this)}dealDamage(t,e){this.time>Se&&u.Instance.getSurface().spawn(this),this.time=0,this.targetX=t.entity.getX()+.5,this.targetY=t.entity.getY()+.5;const s=Math.atan2(this.targetY-this.entity.getY(),this.targetX-this.entity.getX());this.entity.setRotation(s*180/Math.PI),this.source.entity.setRotation(this.entity.getRotation()+90),t.AI.hit(e),t.lightOnFire&&t.lightOnFire()}tick(t){this.time+=t,this.time>Se&&u.Instance.getSurface().despawn(this)}getType(){return h.LaserBeam}isVisible(){return!0}};const Fs=1,Ca=.05,ms=class{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"cooldown",0);a(this,"cleanupEventListener");a(this,"laserBeam");a(this,"hp",80);a(this,"isEnabled",!0);a(this,"speedMultiplier",1);a(this,"damageMultiplier",1);a(this,"renderData",{});this.tile=t,this.entity=new O(t.getX(),t.getY(),this)}tick(t){!this.isEnabled||this.cooldown<=0||(this.cooldown=Math.max(0,this.cooldown-t))}fire(t,e){if(this.cooldown=Fs,!u.Instance.consumeContinuous(this,e,this.damageMultiplier*this.speedMultiplier))return 0;const s=Ca*this.damageMultiplier*this.speedMultiplier*e;return this.laserBeam||(this.laserBeam=new Da(this),u.Instance.getSurface().spawn(this.laserBeam)),this.laserBeam.dealDamage(t,s),this.renderData.fired=!0,s}spawn(){this.cleanupEventListener=se(this,ms.range,ae)}despawn(){var t;(t=this.cleanupEventListener)==null||t.call(this)}updateLinkedAgents(t){this.speedMultiplier=ie(t),this.damageMultiplier=ne(t)}getCooldown(){return this.cooldown}getType(){return h.Laser}hit(t){this.hp-=t,this.hp<=0&&u.Instance.getSurface().despawnStatic(this)}isVisible(){return!0}getTile(){return this.tile}updateTile(t){this.tile=t}enable(){this.isEnabled=!0}disable(){this.cooldown=Fs,this.isEnabled=!1}isSpeedBoosted(){return this.speedMultiplier>1}isDamageBoosted(){return this.damageMultiplier>1}};let Ut=ms;a(Ut,"scale",2),a(Ut,"range",16);const Ei={name:"Fence",description:"A simple fence that land-based enemies have to walk around. If the fence becomes too long however, they will climb over it. Fences are low to towers can shoot over them.",entity:ai,entityType:h.Fence,htmlElement:"🥅"},Mi={name:"Wall",description:"A large solid wall that land-based enemies have to walk around. A wall is equivalent to a tower that does not shoot meaning enemies will avoid them but will destroy them if left with no other option.",entity:Si,entityType:h.Wall,htmlElement:"🚧"},Ii={name:"Electric fence",description:"Electric fences are similar to their normal counterpart but enemies are far less likely to climb over them. If they do they will also continuously receive damage, given that you have enough power stored.",entity:ni,entityType:h.ElectricFence,htmlElement:"⚡"},Ti={name:"Freezer",description:"A large pad that slows down land-based enemies that walk over it. The pad does not repel or attract enemies so they still have to be guided to walk over it.",entity:ri,entityType:h.Freezer,htmlElement:"❄️"},bi={name:"Tower",description:"The cheapest and most basic tower. It has poor range and deals little damage.",entity:vi,entityType:h.Tower,htmlElement:"🗼"},_i={name:"Mortar",description:"A powerful tower with a large range that can shoot over obstacles. It also deals splash damage, hurting all enemies near the impact. Reload speed and travel time of the projectile is slow though.",entity:$t,entityType:h.Mortar,htmlElement:"🛰️"},Ai={name:"Flamethrower",description:"A turret intended for close range combat. It continuously hurts a single enemy within range. Enemies that were lit on fire will also keep burning for a while.",entity:Xt,entityType:h.Flamethrower,htmlElement:"🧯"},xi={name:"Railgun",description:"A powerful tower with a large range that can pierce enemies. It shoots relatively fast and deals massive damage to an enemy and all enemies behind it at the cost of consuming power.",entity:Nt,entityType:h.Railgun,htmlElement:"🌡️"},ss={name:"Sell",description:"Sell towers or blueprints. Blueprints and towers placed before the start of a wave are fully refunded. Other towers give back half their original cost when sold.",entityType:h.None,htmlElement:"❌"},ki={name:"Radar",description:"A part of your base that exposes a large area in the direction that it was placed in. Exposed enemy bases are immediately neutralized when exposed by a radar.",entity:mi,entityType:h.Radar,htmlElement:"📡",isBasePart:!0},Pi={name:"Power plant",description:"A part of your base that generates an amount power at the start of every wave. Power can be stored across waves and is consumed by various towers. More power plants will generate more power but there are diminishing returns.",entity:ci,entityType:h.PowerPlant,htmlElement:"🏭",isBasePart:!0},Ri={name:"Armory",description:"A part of your base that regenerates hit points at the start of every wave. More armories will regenerate more hit points but there are diminishing returns.",entity:ii,entityType:h.Armory,htmlElement:"🏰",isBasePart:!0},Di={name:"Market",description:"A part of your base that increases the amount of money you get per killed enemy. More markets will increase the multiplier but there are diminishing returns.",entity:oi,entityType:h.Market,htmlElement:"🏪",isBasePart:!0},Ci={name:"Speed Beacon",description:"A building that increases the reload speed of cardinally adjacent towers at the cost of some power for every shot fired. If there is no power (left) the towers will continue working as normal without a speed boost. Keep in mind that the beacon also blocks tower sight lines.",entity:Wt,entityType:h.SpeedBeacon,htmlElement:"⏰"},Bi={name:"Damage Beacon",description:"A building that increases the damage of cardinally adjacent towers at the cost of some power for every shot fired. If there is no power (left) the towers will continue working as normal without a damage boost. Keep in mind that the beacon also blocks tower sight lines.",entity:jt,entityType:h.DamageBeacon,htmlElement:"🚨"},Li={name:"Laser",description:"A reasonably powerful tower that lights enemies on fire, similar to the flamethrower. It has a larger range but consumes power in order to fire.",entity:Ut,entityType:h.Laser,htmlElement:"🔭"},Ba={name:"Excavator",description:"Allows building over trees and rocks.",entityType:h.Excavator,htmlElement:"🚜",cost:1},La={name:"Terraform",description:"Allows building over water, ice and enemy structures. Keep in mind a stone foundation is also built which replaces the original surface.",entityType:h.Terraform,htmlElement:"🏗️",cost:1},Fi=100,Fa={name:"Convert",description:`Convert a wave point in a flat ${Fi} gold.`,entityType:h.Convert,htmlElement:"🪙",isRepeatable:!0,cost:1},Ee=1.5,Oa={name:"Emerg. recharge",description:`Activate all existing power plants again to generate additional power. This can also be done during a wave, but doing it between waves is ${Ee} as efficient.`,entityType:h.EmergencyRecharge,htmlElement:"🔌",isRepeatable:!0,cost:1},Ya={name:"Emerg. repair",description:`Activate all existing armories again to generate additional base health. This can also be done during a wave, but doing it between waves is ${Ee} as efficient.`,entityType:h.EmergencyRepair,htmlElement:"🛠",isRepeatable:!0,cost:1};var is=(n=>(n.Construction="Construction",n.Walls="Walls",n.BasicBuildings="Basic buildings",n.PoweredBuildings="Powered Buildings",n.BaseBuildings="Base Buildings",n.WildcardBuildings="Wildcard Buildings",n.Abilities="Abilities",n))(is||{});const Oi={Construction:[ss,Ba,La],Walls:[Ei,Mi,Ii],["Basic buildings"]:[bi,Ai,_i],["Powered Buildings"]:[Pi,Li,xi],["Base Buildings"]:[Ri,ki,Di],["Wildcard Buildings"]:[Ti,Ci,Bi],Abilities:[Fa,Oa,Ya]},Xa=[ss,Ei,Mi,Ii,Ti,bi,_i,Ai,xi,ki,Pi,Ri,Di,Ci,Bi,Li],le=new Set(Xa.map(n=>n.entityType));let je=class{constructor(t,e,s){a(this,"entity");a(this,"category",T.Player);a(this,"renderData",{});this.tile=t,this.placeable=e,this.scaleOverride=s,this.entity=new q(t.getX(),t.getY(),this)}getType(){return h.Blueprint}getTile(){return this.tile}isVisible(){return!0}getPlaceable(){return this.placeable}getScale(){var t;return((t=this.placeable.entity)==null?void 0:t.scale)||this.scaleOverride||1}isDelete(){return this.placeable.entityType===h.None}isBasePart(){return!!this.placeable.isBasePart}};const $a=n=>n.getType()===h.Blueprint,ue=(n,t,e,s)=>{const i=e.getTile(),r=new Set([i]),o=s.getAdjacentTiles(i,2);for(;o.length>0;){const c=o.pop();n.has(c)||r.has(c)||!t.has(c)&&(!c.hasStaticEntity()||!e.getParts().has(c.getStaticEntity().getAgent()))||(r.add(c),s.getAdjacentTiles(c,2).forEach(l=>o.push(l)))}return r.size===e.getParts().size+t.size-n.size},Gt={[h.Fence]:1,[h.Wall]:6,[h.ElectricFence]:9,[h.Freezer]:6,[h.Tower]:14,[h.Flamethrower]:21,[h.Mortar]:50,[h.Railgun]:70,[h.Radar]:20,[h.PowerPlant]:25,[h.Armory]:50,[h.Market]:30,[h.SpeedBeacon]:70,[h.DamageBeacon]:60,[h.Laser]:40},Na=.5,ys=class{constructor(t=0,e=()=>1){a(this,"recentlyBought",new Set);this.money=t,this.multiplier=e,ys.instance=this,b.Instance.addEventListener(M.Unlock,({placeable:s})=>{s.entityType===h.Convert&&(this.addMoney(Fi),u.Instance.triggerStatUpdate())})}setMoney(t){this.money=t}addMoney(t){this.money+=t}removeMoney(t){if(t>this.money)throw new Error("Not enough money!");this.money-=t}registerEnemyKill(t){const e=this.getEnemyValue(t)*this.multiplier();this.money+=e}buy(t){let e=t.getType();$a(t)&&(e=t.getPlaceable().entityType);const s=Gt[e]??0;if(s>this.money)throw new Error("Not enough money!");this.removeMoney(s),this.recentlyBought.add(t)}replaceBlueprint(t,e){this.recentlyBought.has(t)&&(this.recentlyBought.delete(t),this.recentlyBought.add(e))}sell(t){t instanceof je?this.addMoney(Gt[t.getPlaceable().entityType]??0):this.addMoney(this.getValue(t))}getMoney(){return this.money}getMultiplier(){return this.multiplier()}clearRecents(){this.recentlyBought.clear()}isRecent(t){return this.recentlyBought.has(t)}getValue(t){return(Gt[t.getType()]??0)*(this.recentlyBought.has(t)?1:Na)}getEnemyValue(t){switch(t.getType()){case h.Slime:case h.Tank:return 5;case h.Runner:return 3;case h.Flier:return 6;default:throw new Error("Entity is not an enemy")}}static get Instance(){return this.instance}};let X=ys;a(X,"instance");const ws=class{constructor(){a(this,"unlockedTowers");a(this,"availableUnlocks");a(this,"unlockLinkedMap");a(this,"points",0);ws.instance=this,this.unlockedTowers=new Set,this.availableUnlocks=new Set,this.unlockLinkedMap=new Map,Object.values(is).forEach(t=>{const e=Oi[t];e.forEach((s,i)=>{if(i===0){this.availableUnlocks.add(s.entityType),this.unlockedTowers.add(s.entityType);return}this.unlockedTowers.has(e[i-1].entityType)&&(this.availableUnlocks.add(s.entityType),s.isRepeatable&&this.unlockedTowers.add(s.entityType)),e.length>i+1&&this.unlockLinkedMap.set(s.entityType,e[i+1])})})}addPoint(){this.points++}getPoints(){return this.points}canUnlock(t){return this.availableUnlocks.has(t.entityType)&&this.points>=(t.cost??1)}isUnlocked(t){return this.unlockedTowers.has(t.entityType)}unlock(t){if(!this.canUnlock(t))throw new Error(`Can't unlock ${t.entityType}`);this.points-=t.cost??1,this.makeAvailable(t),b.Instance.triggerEvent(M.Unlock,{placeable:t})}makeAvailable(t){this.unlockedTowers.add(t.entityType),t.isRepeatable||this.availableUnlocks.delete(t.entityType);const e=this.unlockLinkedMap.get(t.entityType);e&&(this.availableUnlocks.add(e.entityType),e.isRepeatable&&this.makeAvailable(e))}static get Instance(){return this.instance}};let Mt=ws;a(Mt,"instance");const dt=new Set([h.Armory,h.Radar,h.Market,h.PowerPlant]),Ua=new Set([g.Water,g.Ice,g.Spore,g.Bridge]),vs=class{constructor(t){a(this,"blueprints",new Map);a(this,"pendingBaseAdditions",[]);a(this,"pendingBaseRemovals",[]);a(this,"freeTiles");a(this,"ignoredEntities");this.surface=t,vs.instance=this,this.freeTiles=new Set(Qe),this.ignoredEntities=new Set,b.Instance.addEventListener(M.Unlock,({placeable:e})=>{e.entityType===h.Excavator&&(this.freeTiles.add(g.Tree),this.freeTiles.add(g.Rock),this.ignoredEntities.add(h.Tree),this.ignoredEntities.add(h.Rock)),e.entityType===h.Terraform&&(this.freeTiles.add(g.Water),this.freeTiles.add(g.Ice),this.freeTiles.add(g.Spore),this.freeTiles.add(g.Bridge))})}build(t,e){if(e.entityType===h.None){u.Instance.getIsStarted()?this.sellBlueprints(t):this.sellEntities(t);return}!le.has(e.entityType)||!Mt.Instance.isUnlocked(e)||(u.Instance.getIsStarted()?this.placeBlueprints(t,e):this.placeEntities(t,e))}commit(){this.blueprints.forEach(t=>{const e=t.getTile(),s=this.surface.getEntityTiles(e.getX(),e.getY(),t.getScale());if(this.surface.despawn(t),s.forEach(o=>{if(!o.hasStaticEntity())return;const c=o.getStaticEntity().getAgent();X.Instance.sell(c),this.surface.despawnStatic(c)}),t.isDelete())return;const i=t.getPlaceable().entity,r=new i(e);this.spawn(r),X.Instance.replaceBlueprint(t,r)}),this.pendingBaseAdditions=[],this.pendingBaseRemovals=[],this.blueprints.size!==0&&(this.blueprints.clear(),u.Instance.triggerStatUpdate(),b.Instance.triggerEvent(M.Buy))}placeBlueprints(t,e){const s=t.filter(i=>this.checkIsFree(i,e.entity.scale,!0));if(e.isBasePart){const{pendingBaseAdditions:i,pendingBaseRemovals:r}=this.getPendingTiles(t);if(!ue(r,i,u.Instance.getBase(),this.surface)){u.Instance.showMessage("Not all tiles connect to the base");return}}s.length===0||!u.Instance.canBuy(e,s.length)||(s.forEach(i=>{this.surface.getEntityTiles(i.getX(),i.getY(),e.entity.scale).forEach(c=>{const l=this.blueprints.get(c.getHash());!l||(X.Instance.sell(l),this.freeBlueprint(l),l.isBasePart()?this.pendingBaseAdditions.splice(this.pendingBaseAdditions.indexOf(l),1):c.hasStaticEntity()&&dt.has(c.getStaticEntity().getAgent().getType())&&this.pendingBaseRemovals.splice(this.pendingBaseRemovals.indexOf(l),1),l.isDelete()&&c.hasStaticEntity()&&dt.has(c.getStaticEntity().getAgent().getType())&&this.pendingBaseRemovals.splice(this.pendingBaseRemovals.indexOf(l),1))});const o=new je(i,e);X.Instance.buy(o),this.reserveBlueprint(o),e.isBasePart&&(!i.hasStaticEntity()||!dt.has(i.getStaticEntity().getAgent().getType()))&&this.pendingBaseAdditions.push(o)}),u.Instance.triggerStatUpdate())}sellBlueprints(t){const e=t.find(o=>this.blueprints.has(o.getHash()));let s=t.filter(o=>e?!!this.blueprints.has(o.getHash()):!!(o.hasStaticEntity()&&le.has(o.getStaticEntity().getAgent().getType())));const{baseTiles:i,otherTiles:r}=this.splitTiles(s);if(i.length){const{pendingBaseAdditions:o,pendingBaseRemovals:c}=this.getPendingTiles(i,!0);ue(c,o,u.Instance.getBase(),this.surface)||(s=r,u.Instance.showMessage("Not all base parts can be sold"))}s.length!==0&&(s.forEach(o=>{if(e){const c=this.blueprints.get(o.getHash());c&&(c.isDelete()||(X.Instance.sell(c),o.hasStaticEntity()&&dt.has(o.getStaticEntity().getAgent().getType())&&this.pendingBaseRemovals.splice(this.pendingBaseRemovals.indexOf(c),1)),c.isBasePart()&&(!o.hasStaticEntity()||!dt.has(o.getStaticEntity().getAgent().getType()))&&this.pendingBaseAdditions.splice(this.pendingBaseAdditions.indexOf(c),1),this.freeBlueprint(c),o.hasStaticEntity()&&dt.has(o.getStaticEntity().getAgent().getType())&&this.pendingBaseRemovals.splice(this.pendingBaseRemovals.indexOf(c),1));return}if(o.hasStaticEntity()&&!this.blueprints.get(o.getHash())){const c=o.getStaticEntity().getAgent(),l=new je(c.getTile(),ss,yt(c));this.reserveBlueprint(l),dt.has(c.getType())&&this.pendingBaseRemovals.push(l)}}),u.Instance.triggerStatUpdate())}placeEntities(t,e){const s=t.filter(i=>this.checkIsFree(i,e.entity.scale));if(e.isBasePart&&!ue(new Set,new Set(s),u.Instance.getBase(),this.surface)){u.Instance.showMessage("Not all tiles connect to the base");return}s.length===0||!u.Instance.canBuy(e,s.length)||(s.forEach(i=>{const r=new e.entity(i);this.surface.getEntityTiles(r).forEach(o=>{o.hasStaticEntity()&&this.surface.despawnStatic(o.getStaticEntity().getAgent())}),this.spawn(r),X.Instance.buy(r)}),u.Instance.triggerStatUpdate(),b.Instance.triggerEvent(M.Buy))}sellEntities(t){let e=t.filter(r=>!!(r.hasStaticEntity()&&le.has(r.getStaticEntity().getAgent().getType())));const{baseTiles:s,otherTiles:i}=this.splitTiles(e);if(s.length){const{pendingBaseAdditions:r,pendingBaseRemovals:o}=this.getPendingTiles(s,!0);ue(o,r,u.Instance.getBase(),this.surface)||(e=i,u.Instance.showMessage("Not all base parts can be sold"))}e.length!==0&&(e.forEach(r=>{if(r.hasStaticEntity()){const o=r.getStaticEntity().getAgent();this.surface.despawnStatic(o),X.Instance.sell(o)}}),u.Instance.triggerStatUpdate(),b.Instance.triggerEvent(M.Sell))}splitTiles(t){const e=new Set,s=[];return t.forEach(i=>{const r=this.blueprints.get(i.getHash());if(r&&r.isBasePart()){e.add(r.getTile());return}i.hasStaticEntity()&&dt.has(i.getStaticEntity().getAgent().getType())?e.add(i.getStaticEntity().getAgent().getTile()):s.push(i)}),{baseTiles:[...e],otherTiles:s}}getPendingTiles(t,e=!1){const s=new Set(this.pendingBaseAdditions.map(o=>this.surface.getTile(o.entity.getAlignedX(),o.entity.getAlignedY()))),i=new Set(this.pendingBaseRemovals.map(o=>this.surface.getTile(o.entity.getAlignedX(),o.entity.getAlignedY())));let r=o=>{s.delete(o)||i.delete(o)||i.add(o)};return t.forEach(o=>{if(e){r(o);return}const c=this.blueprints.get(o.getHash());if(c){if(c.isDelete()){i.delete(o);return}s.add(o);return}s.add(o)}),{pendingBaseAdditions:s,pendingBaseRemovals:i}}checkIsFree(t,e,s=!1){return!this.surface.getEntityTiles(t.getX(),t.getY(),e).find(r=>{if(!this.freeTiles.has(r.getBaseType())||r.hasStaticEntity()&&!this.ignoredEntities.has(r.getStaticEntity().getAgent().getType())&&(!s||!le.has(r.getStaticEntity().getAgent().getType())))return!0})}reserveBlueprint(t){this.surface.spawn(t);const e=t.getTile();this.surface.getEntityTiles(e.getX(),e.getY(),t.getScale()).forEach(s=>this.blueprints.set(s.getHash(),t))}freeBlueprint(t){this.surface.despawn(t);const e=t.getTile();this.surface.getEntityTiles(e.getX(),e.getY(),t.getScale()).forEach(s=>this.blueprints.delete(s.getHash()))}spawn(t){this.surface.getEntityTiles(t).forEach(e=>{Ua.has(e.getBaseType())&&this.surface.setTile(new st(e.getX(),e.getY(),g.Stone))}),this.surface.spawnStatic(t)}static get Instance(){return this.instance}};let Ct=vs;a(Ct,"instance");var V=(n=>(n.Shift="Shift",n.Control="Control",n.Meta="Meta",n.Plus="+",n.Minus="-",n.Equals="=",n.Up="ArrowUp",n.Left="ArrowLeft",n.Right="ArrowRight",n.Down="ArrowDown",n.W="w",n.A="a",n.S="s",n.D="d",n.Z="z",n.Q="q",n.B="b",n))(V||{}),Yi=(n=>(n.Single="single",n.Line="line",n.StraightLine="straightLine",n.grid="grid",n))(Yi||{});const Ha=new Set(Object.values(V));function Os(n){return Ha.has(n)}const Ss=class{constructor(t){a(this,"mouseDownX",0);a(this,"mouseDownY",0);a(this,"mouseX",0);a(this,"mouseY",0);a(this,"pressedKeys",{});a(this,"_isMouseDown",!1);a(this,"eventHandlers",new Map);a(this,"selectedPlacable",null);a(this,"buildMenuOpen",!1);this.surface=t,Ss.instance=this}getPlacable(){return this.selectedPlacable}setPlaceable(t){this.selectedPlacable=t}mouseDown(t,e){this.mouseDownX=t,this.mouseDownY=e,this._isMouseDown=!0}mouseMove(t,e){this.mouseX=t,this.mouseY=e}getSelection(){var i,r,o,c;if(!this._isMouseDown)return[];let t=this.mouseX,e=this.mouseY;if(this.pressedKeys.Control||this.pressedKeys.Meta){let l=[];return this.surface.forRect(this.mouseDownX,this.mouseDownY,t,e,p=>{p.isDiscovered()&&l.push(p)},{scale:((r=(i=this.selectedPlacable)==null?void 0:i.entity)==null?void 0:r.scale)||1}),l}this.pressedKeys.Shift&&(Math.abs(t-this.mouseDownX)>Math.abs(e-this.mouseDownY)?e=this.mouseDownY:t=this.mouseDownX);let s=[];return this.surface.forLine(this.mouseDownX,this.mouseDownY,t,e,l=>{l.isDiscovered()&&s.push(l)},{scale:((c=(o=this.selectedPlacable)==null?void 0:o.entity)==null?void 0:c.scale)||1}),s}mouseUp(t,e){if(!this.selectedPlacable){this._isMouseDown=!1;return}const s=this.getSelection();Ct.Instance.build(s,this.selectedPlacable),this._isMouseDown=!1}keyDown(t){Os(t)&&(this.pressedKeys[t]=!0)}keyUp(t){var e;Os(t)&&(this.pressedKeys[t]=!1,(e=this.eventHandlers.get(t))==null||e.forEach(s=>s()),t==="b"&&this.toggleBuildMenu())}toggleBuildMenu(){this.buildMenuOpen=!this.buildMenuOpen,this.buildMenuOpen?b.Instance.triggerEvent(M.OpenBuildMenu):b.Instance.triggerEvent(M.CloseBuildMenu)}isKeyDown(t){return this.pressedKeys[t]??!1}addKeyListener(t,e){return this.eventHandlers.has(t)?this.eventHandlers.get(t).add(e):this.eventHandlers.set(t,new Set([e])),()=>this.removeKeyListener(t,e)}removeKeyListener(t,e){var s;(s=this.eventHandlers.get(t))==null||s.delete(e)}isMouseDown(){return this._isMouseDown}getMouse(t){var s,i;const e=t||((i=(s=this.selectedPlacable)==null?void 0:s.entity)==null?void 0:i.scale)||1;return[Math.floor(this.mouseX/e)*e,Math.floor(this.mouseY/e)*e]}getMode(){return this._isMouseDown?this.pressedKeys.Control||this.pressedKeys.Meta?"grid":this.pressedKeys.Shift?"straightLine":"line":"single"}static get Instance(){return this.instance}};let pt=Ss;a(pt,"instance");const Ge=(n,t,e)=>new Promise(s=>{const i=b.Instance.addEventListener(t,(...r)=>{(!e||e(...r))&&(i(),s())})}).then(()=>n),Xi=(n,t,e)=>new Promise(s=>{const i=b.Instance.addEventListeners(t,r=>{(!e||e(r))&&(i(),s())})}).then(()=>n),ns=(n,...t)=>e=>Xi(u.Instance.showMessage(n,{override:e,expires:0}),t),Wa=ns("Welcome to Open Tower Defense! Open the build menu by clicking the {key: 🔧} button or by pressing {key: b}",M.OpenBuildMenu),Va=n=>Ge(u.Instance.showMessage("Build towers and walls near your base to protect it from enemies lurking in undiscovered areas",{override:n,expires:0}),M.SurfaceChange,({affectedTiles:t})=>!!t.size),ja=n=>new Promise(t=>{const e=u.Instance.getDifficulty();if(e===H.Hard){t(n);return}Xi(u.Instance.showMessage(`Click the {key: 🎯} button to view tower sight lines${e===H.Easy?" and enemy paths":" "} to check how effective your layout is`,{override:n,expires:0}),[M.ToggleShowCoverage,M.StartWave]).then(t)}),Ga=n=>new Promise(t=>{if(u.Instance.getIsStarted()){Ge(n,M.EndWave).then(t);return}Ge(u.Instance.showMessage("Start the wave when you are ready. Good luck!",{override:n,expires:0}),M.EndWave).then(t)}),za=ns("After every wave your visible radius will increase. When enemy spawn points are discovered they are disabled and you receive a point to unlock new technologies.",M.Discover),Ka=ns("You gained a wave point by discovering a spawn point! You can spend it in the build menu. You can build radars to discover spawn points more quickly.",M.OpenBuildMenu),Ys=[Wa,Va,ja,Ga,za,Ka];class qa{constructor(){a(this,"promise");a(this,"reject");a(this,"previousId",-1)}async start(){this.promise=new Promise(async(t,e)=>{this.reject=e;for(let s=0;s<Ys.length;s++){const i=Ys[s];this.previousId=await i(this.previousId)}t()}),await this.promise}stop(){var t;(t=this.reject)==null||t.call(this)}}const ze={[h.ElectricFence]:.05,[h.Railgun]:5,[h.Laser]:.004},Za=2,Xs=1.25,Es=class{constructor(){a(this,"generators",new Set);a(this,"consumption",0);a(this,"blackout",!1);a(this,"power",0);Es.instance=this}registerGenerator(t){this.generators.add(t)}removeGenerator(t){this.generators.delete(t)}getProduction(){return u.Instance.getBase().getPartsCount(h.PowerPlant)*5}getConsumption(){return this.consumption}consume(t){return t===0?!0:this.blackout?!1:(this.power-=t,this.power<0?(this.power=0,this.blackout=!0,b.Instance.triggerEvent(M.BlackOut),u.Instance.triggerStatUpdate(),!1):(this.consumption+=t,!0))}processPower(t=1){this.power=this.power+this.getProduction()*t,this.blackout=!1,this.power<0&&b.Instance.triggerEvent(M.BlackOut),u.Instance.getIsStarted()||(this.consumption=0)}getPower(){return this.power}static get Instance(){return this.instance}};let rt=Es;a(rt,"instance");const as=n=>(Jt("data-v-fd3cbd3e"),n=n(),Qt(),n),Ja={class:"sprite"},Qa={class:"name"},tr={key:0,class:"lock"},er={class:"data"},sr={key:0},ir=as(()=>y("span",{class:"emoji"},"🪙",-1)),nr={key:1},ar=as(()=>y("span",{class:"emoji"},"📐",-1)),rr={key:2},or={key:3},cr={key:4},hr={key:5},lr=as(()=>y("span",{class:"emoji"},"🚩",-1)),ur=nt({__name:"Placeable",props:{item:null,locked:{type:Boolean},onSelect:null,selected:{type:Boolean}},setup(n){const t=n,e=Gt[t.item.entityType],s=t.item.entity&&t.item.entity.range;return(i,r)=>(I(),A("button",{class:j({placeable:!0,"placeable--locked":t.locked,"placeable--selected":t.selected}),onClick:r[0]||(r[0]=o=>t.onSelect(n.item))},[y("span",Ja,L(t.item.htmlElement),1),y("span",Qa,[C(L(t.item.name)+" ",1),t.locked?(I(),A("span",tr,"🔒")):Y("",!0)]),y("ul",er,[P(e)?(I(),A("li",sr,[ir,C(" "+L(P(e)),1)])):Y("",!0),P(s)?(I(),A("li",nr,[ar,C(" "+L(P(s)),1)])):Y("",!0),P(ze)[t.item.entityType]?(I(),A("li",rr,"⚡")):Y("",!0),t.item.isBasePart?(I(),A("li",or,"🧱")):Y("",!0),t.item.isRepeatable?(I(),A("li",cr,"♻")):Y("",!0),t.item.cost?(I(),A("li",hr,[lr,C(" "+L(t.item.cost),1)])):Y("",!0)])],2))}});const ot=(n,t)=>{const e=n.__vccOpts||n;for(const[s,i]of t)e[s]=i;return e},dr=ot(ur,[["__scopeId","data-v-fd3cbd3e"]]),gr={class:"marketplace"},pr={class:"info"},fr={class:"description"},mr={class:"section"},yr=["disabled"],wr={class:"grid"},vr={class:"column"},Sr={class:"header"},Er={class:"item"},Mr=nt({__name:"Marketplace",props:{controller:null,unlocksController:null,eventSystem:null},setup(n){const t=n,e=_(t.controller.getPlacable()),s=_(!1),i=Js();let r,o;te(()=>{r=t.eventSystem.addEventListener(M.OpenBuildMenu,()=>s.value=!0),o=t.eventSystem.addEventListener(M.CloseBuildMenu,()=>s.value=!1)}),_e(()=>{r&&o&&(r(),o())});const c=d=>{e.value=d,t.controller.setPlaceable(d)},l=Object.values(is),p=()=>{t.unlocksController.unlock(e.value),i.proxy.$forceUpdate()},f=()=>{t.controller.toggleBuildMenu()};return(d,w)=>(I(),A("div",{class:j({"marketplace-wrapper":!0,"marketplace-wrapper--visible":s.value})},[y("div",gr,[y("div",pr,[y("p",fr,L(e.value?e.value.description:"Select a tower below."),1),y("div",mr,[C(L(t.unlocksController.getPoints())+" wave points ",1),e.value&&(!t.unlocksController.isUnlocked(e.value)||e.value.isRepeatable)?(I(),A("button",{key:0,disabled:!t.unlocksController.canUnlock(e.value),onClick:p}," Unlock "+L(e.value.name),9,yr)):Y("",!0)]),y("button",{onClick:f,class:"close-button"},"✖")]),y("div",wr,[(I(!0),A(ft,null,qt(P(l),v=>(I(),A("div",vr,[y("div",Sr,L(v),1),(I(!0),A(ft,null,qt(P(Oi)[v],S=>{var E;return I(),A("div",Er,[k(dr,{item:S,locked:!t.unlocksController.isUnlocked(S),selected:((E=e.value)==null?void 0:E.entityType)===S.entityType,onSelect:c},null,8,["item","locked","selected"])])}),256))]))),256))])])],2))}});const Ir=ot(Mr,[["__scopeId","data-v-89501f9e"]]),Tr={class:"stats"},br={class:"meta"},_r={class:"positive"},Ar={class:"meta"},xr={class:"positive"},kr={class:"negative"},Pr={class:"meta"},Rr={class:"positive"},Dr=nt({__name:"Stats",props:{expanded:{type:Boolean}},setup(n){const t=n,e=Intl.NumberFormat(void 0,{maximumFractionDigits:0}),s=Intl.NumberFormat(void 0,{maximumFractionDigits:2}),i=Intl.NumberFormat(void 0,{style:"percent",maximumFractionDigits:0}),r=_(0),o=_(0),c=_(0),l=_(0),p=_(!1),f=_(0),d=_(0),w=_(0),v=_(0),S=_(0),E=x=>{r.value=x.money,o.value=x.moneyMultiplier,c.value=x.level,l.value=x.remainingEnemies,p.value=x.inProgress,f.value=x.integrity,d.value=x.regeneration,w.value=x.power,v.value=x.production,S.value=x.consumption},D=hn(()=>({stat:!0,"stat--expanded":t.expanded}));return te(()=>{b.Instance.addEventListener(M.StatUpdate,E),u.Instance.triggerStatUpdate()}),_e(()=>{b.Instance.removeEventListener(M.StatUpdate,E)}),(x,G)=>(I(),A("div",Tr,[y("span",{class:j(P(D))},[C(" 🪙 "+L(P(e).format(r.value))+" ",1),y("span",br,[C("("),y("span",_r,L(P(i).format(o.value)),1),C(")")])],2),y("span",{class:j(P(D))},[C(" 🔋 "+L(P(e).format(w.value))+" ",1),y("span",Ar,[C("("),y("span",xr,"+"+L(P(s).format(v.value)),1),C("/"),y("span",kr,"-"+L(P(s).format(S.value)),1),C(")")])],2),y("span",{class:j(P(D))},[C(" 🛡️ "+L(P(e).format(f.value))+" ",1),y("span",Pr,[C("("),y("span",Rr,"+"+L(P(s).format(d.value)),1),C(")")])],2),y("span",{class:j(P(D))}," 👾 "+L(l.value),3)]))}});const Cr=ot(Dr,[["__scopeId","data-v-d34f0171"]]),Br=n=>(Jt("data-v-26b44444"),n=n(),Qt(),n),Lr={class:"hud"},Fr={class:"hud-positioner"},Or={class:"group"},Yr=Br(()=>y("span",{class:"emoji"},"⚔️",-1)),Xr={key:0},$r={key:1},Nr=nt({__name:"Hud",props:{renderer:null,controller:null},setup(n){const t=n,e=_(0),s=_(!1),i=_(!1),r=_(!1),o=f=>{e.value=f.level,s.value=f.inProgress};te(()=>{b.Instance.addEventListener(M.StatUpdate,o),u.Instance.triggerStatUpdate()}),_e(()=>{b.Instance.removeEventListener(M.StatUpdate,o)});function c(){u.Instance.start()}function l(){r.value=!r.value}function p(){i.value?t.renderer.hideCoverage():t.renderer.showCoverage(),b.Instance.triggerEvent(M.ToggleShowCoverage),i.value=!i.value}return(f,d)=>(I(),A("div",Lr,[y("div",Fr,[k(Cr,{expanded:r.value},null,8,["expanded"]),y("div",Or,[y("button",{class:j({"wave-toggle":!0,"wave-toggle--active":!s.value}),onClick:c},[Yr,s.value?Y("",!0):(I(),A("span",Xr,"Start wave "+L(e.value+1),1)),s.value?(I(),A("span",$r,"Wave "+L(e.value),1)):Y("",!0)],2),y("button",{class:"toggle",onClick:d[0]||(d[0]=(...w)=>t.controller.toggleBuildMenu&&t.controller.toggleBuildMenu(...w))}," 🔧 "),y("button",{class:j({toggle:!0,"toggle-toggled":r.value}),onClick:l}," 🔎 ",2),P(u).Instance.getDifficulty()!==P(H).Hard?(I(),A("button",{key:0,class:j({toggle:!0,"toggle-toggled":i.value}),onClick:p}," 🎯 ",2)):Y("",!0)])])]))}});const Ur=ot(Nr,[["__scopeId","data-v-26b44444"]]),Hr=.002;class Wr{constructor(t,e,s){a(this,"entity");a(this,"category",T.Unknown);a(this,"renderData",{});a(this,"time",0);a(this,"travelTime");this.tile=t,this.target=e,this.damage=s,this.entity=new q(t.getX()+.5,t.getY()+.5,this);const i=t.getX()-e.getX(),r=t.getY()-e.getY(),o=Math.sqrt(i*i+r*r);this.travelTime=o/Hr,this.time=this.travelTime/4,this.entity.lookAt(e)}tick(t){this.time>=this.travelTime&&(u.Instance.getSurface().despawn(this),[...u.Instance.getSurface().getEntitiesForCategory(T.Enemy)].filter(s=>s.getAlignedX()===this.target.getX()&&s.getAlignedY()===this.target.getY()).forEach(s=>{s.getAgent().AI.hit(this.damage)})),this.time=Math.min(this.time+t,this.travelTime);const e=this.time/this.travelTime;this.entity.setX(wt(this.tile.getX(),this.target.getX(),e)+.5),this.entity.setY(wt(this.tile.getY(),this.target.getY(),e)+.5)}getType(){return h.Shockwave}getTile(){return this.tile}isVisible(){return!0}}const Vr=1e3,jr=200,Gr=[[0,0],[1,0],[1,1],[0,1]],zr=[[[-1,0],[-1,-1],[0,-1]],[[0,-1],[1,-1],[1,0]],[[1,0],[1,1],[0,1]],[[0,1],[-1,1],[-1,0]]];class $i{constructor(t){a(this,"entity");a(this,"category",T.Player);a(this,"hp",30);a(this,"invincibleTime",0);a(this,"renderData",{});a(this,"baseParts",new Set);a(this,"basePartsByType",new Map);this.tile=t,this.entity=new O(t.getX(),t.getY(),this),this.baseParts.add(this)}tick(t){this.invincibleTime=Math.max(0,this.invincibleTime-t)}getType(){return h.Base}getTile(){return this.tile}updateTile(t){this.tile=t}getHp(){return this.hp}spawn(){W.Instance.registerAgent(this),ee(this,4)}despawn(){W.Instance.removeAgent(this)}hit(t){this.invincibleTime>0||this.hp<=0||(this.hp-=t,this.hp<=0?(u.Instance.showMessage("You lose!",{closable:!1,expires:0}),u.Instance.getSurface().forceRerender(),b.Instance.triggerEvent(M.Lose)):(this.invincibleTime=Vr,this.shockwave()),u.Instance.triggerStatUpdate(),b.Instance.triggerEvent(M.HitBase))}regenerate(t=1){this.hp+=this.getRegenerationFactor()*t}isVisible(){return!0}isDestroyed(){return this.hp<=0}addPart(t){this.baseParts.add(t),this.basePartsByType.set(t.getType(),(this.basePartsByType.get(t.getType())??0)+1)}removePart(t){this.baseParts.delete(t),this.basePartsByType.set(t.getType(),this.basePartsByType.get(t.getType())-1)}getParts(){return this.baseParts}getPartsCount(t){return this.basePartsByType.get(t)??0}getRegenerationFactor(){const t=this.getPartsCount(h.Armory);return t*50/(t+25)}getMoneyFactor(){const t=this.getPartsCount(h.Market);return 1+t*2.5/(t+25)}shockwave(){const t=u.Instance.getSurface(),e=new Map;this.baseParts.forEach(s=>{Gr.forEach(([i,r],o)=>{const c=t.getTile(s.getTile().getX()+i,s.getTile().getY()+r);zr[o].forEach(([l,p])=>{const f=t.getTile(s.getTile().getX()+i+l,s.getTile().getY()+r+p);f&&!e.has(f.getHash())&&An.has(f.getType())&&e.set(f.getHash(),[c,f])})})}),e.forEach(([s,i])=>{const r=new Wr(s,i,jr);t.spawn(r)})}}a($i,"scale",2);class Kr extends u{constructor(e,s,i,r){super(e,s,i,r);a(this,"showMessage",(...e)=>this.messageFn(...e));a(this,"onUnlock",({placeable:e})=>{const s=this.getIsStarted();e.entityType===h.EmergencyRecharge&&rt.Instance.processPower(s?1:Ee),e.entityType===h.EmergencyRepair&&this.base.regenerate(s?1:Ee)});a(this,"onDiscover",()=>{Mt.Instance.addPoint()});this.surface.getEntityTiles(this.base).map(o=>{o.hasStaticEntity()&&this.surface.despawnStatic(o.getStaticEntity().getAgent())}),i.spawnStatic(this.base),b.Instance.addEventListener(M.Unlock,this.onUnlock),b.Instance.addEventListener(M.Discover,this.onDiscover),console.log(this)}tick(e){if(this.surface.processChangedTiles(),this.base.isDestroyed())return;const s=this.surface.getEntities();for(let r of s)r.getAgent().tick&&r.getAgent().tick(e);const i=this.surface.getStaticEntities();for(let r of i)r.getAgent().tick&&r.getAgent().tick(e);U.Instance.tick(e)}triggerStatUpdate(){const e=this.getSurface().getEntitiesForCategory(T.Enemy).size;b.Instance.triggerEvent(M.StatUpdate,{integrity:this.base.getHp(),regeneration:this.base.getRegenerationFactor(),level:this.level,money:X.Instance.getMoney(),moneyMultiplier:X.Instance.getMultiplier(),production:rt.Instance.getProduction(),consumption:rt.Instance.getConsumption(),power:rt.Instance.getPower(),remainingEnemies:e,inProgress:this.getIsStarted()})}spawnEnemy(e){this.surface.spawn(e),this.triggerStatUpdate()}despawnEnemy(e){this.surface.despawn(e)&&(X.Instance.registerEnemyKill(e),U.Instance.processWave()?this.end():this.triggerStatUpdate())}getIsStarted(){return U.Instance.isWaveInProgress()}canBuy(e,s=1){const i=(Gt[e.entityType]??0)*s;return i>X.Instance.getMoney()?(this.showMessage(`You do not have enough money. This costs 🪙 ${i}`),!1):!0}start(){if(this.getIsStarted())throw new Error("Wave already in progress!");b.Instance.triggerEvent(M.StartWave),rt.Instance.processPower(),X.Instance.clearRecents(),U.Instance.startNewWave(),W.Instance.commit(),this.level++,W.Instance.updateBaseRange(),this.triggerStatUpdate(),u.Instance.getSurface().forceRerender()}consume(e,s=1,i=1){return rt.Instance.consume((ze[e.getType()]??0)+(s-1)*Za+(i-1)*Xs)}consumeContinuous(e,s,i=1){return rt.Instance.consume((ze[e.getType()]??0)*s+(i-1)*Xs*s/16)}getDifficulty(){return this.difficulty}getIsBaseDestroyed(){return this.base.isDestroyed()}end(){Ct.Instance.commit(),W.Instance.commit(),U.Instance.cleanupSpawnGroups(),this.base.regenerate(),this.triggerStatUpdate(),b.Instance.triggerEvent(M.EndWave),U.Instance.shouldAddSpawnGroup()&&(b.Instance.triggerEvent(M.Spawn),this.showMessage("Another spawn point has appeared!")),u.Instance.getSurface().forceRerender()}getDamageMultiplier(){let e=1;switch(this.difficulty){case H.Hard:e+=.2;case H.Normal:e+=.2}return e}}const qr=(n,t,e,s)=>{new W(e);const i=new $i(t),r=new Kr(n,i,e,s);return new U(i,e),new rt,new X(150,()=>Math.max(.5,i.getMoneyFactor()-r.getLevel()/120)),new Ct(e),new Mt,r},Zr=n=>(Jt("data-v-5999ea0c"),n=n(),Qt(),n),Jr={class:"wrapper"},Qr={height:"0",style:{position:"absolute"}},to=Zr(()=>y("defs",null,[y("radialGradient",{id:"alert"},[y("stop",{offset:"0%","stop-color":"red","stop-opacity":"0"}),y("stop",{offset:"95%","stop-color":"red","stop-opacity":"0"}),y("stop",{offset:"100%","stop-color":"red","stop-opacity":"0.8"})])],-1)),eo=[to],so={class:"canvas"},io=nt({__name:"Game",props:{seed:null,difficulty:null,renderer:null,showTutorial:{type:Boolean}},setup(n){const t=n,e=_(null),s=new Pn(200,200,kn(t.seed)),i=new pt(s),r=new t.renderer(s,i),o=s.getTile(100,100),c=qr(t.difficulty,o,s,r.showMessage);t.showTutorial&&new qa().start();let l=!1,p=0;return te(()=>{l=!0,r.mount(e.value);const f=d=>{const w=+i.isKeyDown(V.Right)+ +i.isKeyDown(V.D)-+i.isKeyDown(V.Left)-+i.isKeyDown(V.A)-+i.isKeyDown(V.Q),v=+i.isKeyDown(V.Down)+ +i.isKeyDown(V.S)-+i.isKeyDown(V.Up)-+i.isKeyDown(V.W)-+i.isKeyDown(V.Z),S=+i.isKeyDown(V.Plus)+ +i.isKeyDown(V.Equals)-+i.isKeyDown(V.Minus);(w||v||S)&&r.move({x:w,y:v,zoom:S});const E=d-p;c.tick(E),r.rerender(E),p=d,l&&window.requestAnimationFrame(f)};window.requestAnimationFrame(f)}),_e(()=>l=!1),(f,d)=>(I(),A("div",Jr,[(I(),A("svg",Qr,eo)),k(Ur,{renderer:P(r),controller:P(pt).Instance},null,8,["renderer","controller"]),y("div",so,[y("div",{class:"render-target",ref_key:"canvas",ref:e},null,512),k(Ir,{controller:P(pt).Instance,unlocksController:P(Mt).Instance,eventSystem:P(b).Instance},null,8,["controller","unlocksController","eventSystem"])])]))}});const no=ot(io,[["__scopeId","data-v-5999ea0c"]]);var me=(n=>(n[n.Growing=0]="Growing",n[n.Fixed=1]="Fixed",n))(me||{});class Le{constructor(t,e=0,s=10){a(this,"size");a(this,"freeEntities",[]);a(this,"usedEntities",new Map);this.initializer=t,this.type=e,this.size=s;for(let i=0;i<s;i++)this.freeEntities.push(t(!1))}get(t){let e=this.usedEntities.get(t);if(e)return e;if(this.freeEntities.length===0){if(this.type===1)throw new Error("Pool is empty");this.size++}return e=this.initializer(!0,this.freeEntities.pop(),t),this.usedEntities.set(t,e),e}free(t){if(!this.usedEntities.has(t))return;let e=this.usedEntities.get(t);return this.usedEntities.delete(t),this.freeEntities.push(e),e}getSize(){return this.size}getUsed(){return this.usedEntities}}const ao=(n,t,e)=>{const s=t.entity,i=s.getX(),r=s.getY(),o=Math.sqrt((i-t.targetX)**2+(r-t.targetY)**2);e.style.transformOrigin="0 0",e.style.opacity=`${1-.9*(t.time/es)}`,e.style.transform=`translate(${i*n.xStep}px, ${r*n.yStep}px) rotate(${s.getRotation()}deg) scale(${o}, 0.1)`},ro=(n,t,e)=>{const s=t.entity;e.style.opacity=`${1-.9*(t.time/Ve)}`,e.style.transform=`translate(${(s.getX()+Math.random()*.3-.15)*n.xStep}px, ${(s.getY()+Math.random()*.3-.15)*n.yStep}px) rotate(${-s.getRotation()+180+Math.random()*10-5}deg)`},$s=1/4,Fe=(n,t,e)=>{const s=t.entity,i=s.getId()%13/26-$s,r=(s.getId()+5)%17/34-$s,o=n.getTime()%13/3;let c=s.getRotation();t.AI.isBusy()&&(c+=Math.sin(n.getTime()%Z/Z*5)*20),t.getStatus()===R.OnFire?(e.style.color="transparent",e.style.textShadow=`${Math.random()-.5}px ${Math.random()-.5}px ${o+2}px #E25822`):t.getStatus()===R.Normal&&(e.style.color="initial",e.style.textShadow="none"),e.style.transform=`translate(${(s.getX()+i)*n.xStep}px, ${(s.getY()+r)*n.yStep}px) rotate(${c}deg)`},oo=1/4,co=1/8,ho=.0015,lo=(n,t,e)=>{const s=t.entity,i=ho*(1+s.getId()%13/13),r=Math.sin((n.getTime()+s.getId())*i)/4-co,o=Math.cos((n.getTime()+s.getId())*i)/2-oo,c=n.getTime()%13/3,l=(s.getRotation()+360)%360,p=l>0&&l<180?-1:1;let f=0;t.AI.isBusy()&&(f+=Math.sin(n.getTime()%Z/Z*5)*20),t.getStatus()===R.OnFire?(e.style.color="transparent",e.style.textShadow=`${Math.random()-.5}px ${Math.random()-.5}px ${c+2}px #E25822`):t.getStatus()===R.Normal&&(e.style.color="initial",e.style.textShadow="none"),e.style.transform=`translate(${(s.getX()+r)*n.xStep}px, ${(s.getY()+o)*n.yStep}px) rotate(${f}deg) scale(${p},1)`},uo=(n,t,e)=>{const s=t.entity;e.children[0].textContent=n.getStaticEntityEmoji(t.getPlaceable().entityType),e.style.transformOrigin="0 0",e.style.opacity="0.5",e.style.filter="grayscale(0.6)",e.style.transform=`translate(${s.getX()*n.xStep}px, ${s.getY()*n.yStep}px) rotate(${s.getRotation()}deg) scale(${t.getScale()})`},go=(n,t,e)=>{const s=t.entity,i=s.getX(),r=s.getY(),o=Math.sqrt((i-t.targetX)**2+(r-t.targetY)**2);e.style.color="transparent",e.style.textShadow="0 0 0 #E25822",e.style.transformOrigin="0 0",e.style.opacity=`${1-.9*(t.time/Se)}`,e.style.transform=`translate(${i*n.xStep}px, ${r*n.yStep}px) rotate(${s.getRotation()}deg) scale(${o}, 0.1)`},Oe=(n,t,e)=>{const s=t.entity;e.style.transform=`translate(${(s.getX()-.5)*n.xStep}px, ${(s.getY()-.5)*n.yStep}px) rotate(${s.getRotation()}deg)`},po={[h.Rail]:ao,[h.Flame]:ro,[h.Slime]:Fe,[h.Runner]:Fe,[h.Flier]:lo,[h.Tank]:Fe,[h.Blueprint]:uo,[h.LaserBeam]:go,[h.Bullet]:Oe,[h.Rocket]:Oe,[h.Shockwave]:Oe},fo=5e3,mo=nt({__name:"Key",props:{char:null,area:null},setup(n){const t=n,e=t.char>"A"&&t.char<"z";return(s,i)=>(I(),A("div",{class:j({key:!0,emoji:!P(e)}),style:ln({gridArea:t.area})},L(t.char),7))}});const F=ot(mo,[["__scopeId","data-v-8be0d2b3"]]),yo=nt({__name:"mouse",props:{button:null},setup(n){const t=n;return(e,s)=>(I(),A("div",{class:j(`mouse button-${t.button}`)},null,2))}});const ye=ot(yo,[["__scopeId","data-v-135d4a7c"]]),wo=nt({__name:"TextWithControls",props:{text:null},setup(n){const t=n,e={0:"left",1:"right",3:"middle"},s=_(t.text),i=_(""),r=_(""),o=_("");return un(()=>t.text,c=>{const p=/^(?<left>.*?){(?<control>key|mouse): (?<type>.*?)}(?<right>.*)$/.exec(c);p?(s.value=p.groups.left,i.value=p.groups.control,r.value=p.groups.type,o.value=p.groups.right):(s.value=c,i.value="",r.value="",o.value="")},{immediate:!0}),(c,l)=>{const p=dn("TextWithControls",!0);return I(),A(ft,null,[C(L(s.value)+" ",1),i.value==="key"?(I(),Ht(F,{key:0,char:r.value},null,8,["char"])):Y("",!0),i.value==="mouse"?(I(),Ht(ye,{key:1,button:P(e)[r.value]},null,8,["button"])):Y("",!0),o.value?(I(),Ht(p,{key:2,text:o.value},null,8,["text"])):Y("",!0)],64)}}}),vo={class:"message-wrapper"},So={class:"message-inner"},Eo=["onClick"],Mo=nt({__name:"SimpleMessage",props:{register:null},setup(n){const t=n;let e=1;const s=()=>({id:e++,content:"",closable:!0,open:!1,removing:!1}),i=_([s()]),r=_(new Map),o=Js(),c=(p,f)=>{let d,w=-1;if(f!=null&&f.override&&(w=i.value.findIndex(S=>S.id===f.override)),w!==-1){const S=i.value[w].id;window.clearTimeout(r.value.get(S)),r.value.delete(S),d=i.value[w]}else d=i.value.at(-1),i.value.push(s());d.closable=(f==null?void 0:f.closable)??!0,d.open=!0,d.content=p;const v=(f==null?void 0:f.expires)??fo;if(v){const S=window.setTimeout(()=>{l(d)},v);r.value.set(d.id,S)}return Promise.resolve(d.id)},l=p=>{p.open=!1,p.removing=!0,o.proxy.$forceUpdate(),window.setTimeout(()=>{i.value.splice(i.value.indexOf(p),1)},700)};return te(()=>{t.register(c)}),(p,f)=>(I(),A("div",vo,[(I(!0),A(ft,null,qt(i.value,d=>(I(),A("div",{key:d.id,class:j({message:!0,"message--visible":d.open,"message--removing":d.removing})},[y("div",So,[d.closable?(I(),A("button",{key:0,class:"close-button",onClick:()=>l(d)}," ✖ ",8,Eo)):Y("",!0),k(wo,{text:d.content},null,8,["text"])])],2))),128))]))}});const Ni=ot(Mo,[["__scopeId","data-v-fe3393c8"]]),N=navigator.appVersion.indexOf("Win")!=-1,Io=42,To=4,bo=20;let Tt=!1,rs=class{constructor(t,e){a(this,"pool");a(this,"selectionPool");a(this,"scaledTilesPool");a(this,"messageFn");a(this,"resolveMessageFn");a(this,"xStep",0);a(this,"yStep",0);a(this,"offsetX",0);a(this,"offsetY",0);a(this,"time",0);a(this,"fontSize",bo);a(this,"hasMoved",!1);a(this,"_showCoverage",!1);a(this,"target",null);a(this,"world",null);a(this,"rows",[]);a(this,"alertRanges",[]);a(this,"coverageMap",null);a(this,"coverageRows",[]);a(this,"showMessage",async(...t)=>(await this.messageFn)(...t));a(this,"getEmoji",t=>{const e=Tt||u.Instance.getIsBaseDestroyed();if(t.getDiscoveryStatus()===B.Pending&&!e)return"🔍";if(!t.isDiscovered()&&!e)return"&nbsp;";if(t.hasStaticEntity()&&yt(t.getStaticEntity().getAgent())!==2)return this.getStaticEntityEmoji(t.getStaticEntity().getAgent().getType());switch(t.getBaseType()){case g.Water:return"🟦";case g.Stone:return"⬜";case g.Grass:return"🟩";case g.Spore:return"🟪";case g.Bridge:return"📜";case g.Sand:return"🟨";case g.Snow:return"🌫️";case g.Dirt:return"🟫";case g.Ice:return"🧊";default:return"&nbsp;"}});this.surface=t,this.controller=e,this.pool=new Le((s,i,r)=>{if(i)return i.style.display="block",i.style.opacity="1",i.style.transformOrigin="50% 50%",i.style.filter="none",i.style.color="initial",i.style.textShadow="none",i.children[0].textContent=this.getEntityEmoji(r),i;const o=document.createElement("span");return o.appendChild(document.createElement("span")),N&&(o.children[0].style.margin="-0.35ch"),o.children[0].textContent=r?this.getEntityEmoji(r):"",o.style.position="absolute",o.style.top=N?"-.125ch":"-.075ch",o.style.left=N?".35ch":"0",o.style.display=s?"block":"none",o.style.willChange="transform",this.world.appendChild(o),o},me.Growing,0),this.selectionPool=new Le((s,i)=>{if(i)return i.style.display="block",i;const r=document.createElement("span");return r.appendChild(document.createElement("span")),N&&(r.children[0].style.margin="-0.35ch"),r.children[0].textContent="🟧",r.style.transformOrigin="0 0",r.style.opacity="0.7",r.style.position="absolute",r.style.top=N?"-.125ch":"-.075ch",r.style.left=N?".35ch":"0",r.style.display=s?"block":"none",r.style.willChange="transform",this.world.appendChild(r),r},me.Growing,0),this.scaledTilesPool=new Le((s,i,r)=>{if(i)return i.style.display="block",i.children[0].textContent=this.getStaticEntityEmoji(r.getAgent().getType()),i;const o=document.createElement("span");return o.appendChild(document.createElement("span")),N&&(o.children[0].style.margin="-0.35ch"),o.children[0].textContent=r?this.getStaticEntityEmoji(r.getAgent().getType()):"",o.style.transformOrigin="0 0",o.style.position="absolute",o.style.top=N?"-.125ch":"-.075ch",o.style.left=N?".35ch":"0",o.style.display=s?"block":"none",o.style.willChange="transform",this.world.appendChild(o),o},me.Growing,0),this.messageFn=new Promise(s=>this.resolveMessageFn=s),window.debug=()=>{Tt=!Tt,this.renderTiles()}}mount(t){this.target=t;const e=t.appendChild(document.createElement("div"));Ze(Ni,{register:this.resolveMessageFn}).mount(e),this.world=t.appendChild(document.createElement("div")),this.world.className="scrollable",this.world.style.lineHeight=N?"1.86ch":"1ch",this.world.style.whiteSpace="nowrap",this.world.style.cursor="crosshair",this.world.style.userSelect="none",this.world.style.position="relative",this.world.style.fontFamily='"Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Android Emoji","EmojiOne Mozilla","Twemoji Mozilla","Noto Emoji","Segoe UI Symbol",EmojiSymbols',this.world.style.backgroundColor="#000",N&&(this.world.style.letterSpacing="-0.7ch",this.world.style.wordSpacing="2.04ch"),this.renderTiles(),this.zoom();const{width:s,height:i}=this.world.getBoundingClientRect(),r=u.Instance.getBase().getTile();this.world.scrollLeft=r.getX()*this.xStep-s/2,this.world.scrollTop=r.getY()*this.yStep-i/2,this.rerender(0),this.registerEventHandlers(this.world)}zoom(){const t=(this.world.scrollLeft+this.world.clientWidth/2)/this.world.scrollWidth,e=(this.world.scrollTop+this.world.clientHeight/2)/this.world.scrollHeight;this.world.style.fontSize=`${this.fontSize}px`;const{width:s,height:i,x:r,y:o}=this.world.getBoundingClientRect(),c=this.world.scrollWidth,l=this.world.scrollHeight;this.xStep=c/this.surface.getWidth(),this.yStep=l/this.surface.getHeight(),this.offsetX=r,this.offsetY=o,this.world.scrollLeft=t*c-s/2,this.world.scrollTop=e*l-i/2}rerender(t){this.time+=t,this.surface.isDirty()&&this.renderTiles(),(this.surface.isDirty()||this.hasMoved)&&(this.renderStaticAgents(),this.renderAlertRanges());const e=this.surface.getEntities();for(let i of e){const r=po[i.getAgent().getType()];if(!this.getEntityEmoji(i)&&!r)continue;const o=this.pool.get(i);o.style.display=i.getAgent().isVisible()?"block":"none",r?r(this,i.getAgent(),o):o.style.transform=`translate(${i.getX()*this.xStep}px, ${i.getY()*this.yStep}px) rotate(${i.getRotation()}deg)`}this.surface.getDeletedEntities().forEach(i=>{const r=this.pool.free(i);r&&(r.style.display="none")}),this.renderSelection(),this.surface.markPristine()}showCoverage(){this._showCoverage=!0,this.renderTiles()}hideCoverage(){this._showCoverage=!1,this.renderTiles()}renderTiles(){const t=this.surface.getHeight();for(let e=0;e<t;e++){let s=this.rows[e];s||(s=document.createElement("div"),N&&(s.style.letterSpacing="-0.7ch"),this.rows[e]=s,this.world.appendChild(s));const i=this.surface.getRow(e).map(this.getEmoji).join("");s.innerHTML=i}this.renderCoverage()}renderStaticAgents(){const t=this.surface.getEntitiesForCategory(T.Player);for(let s of t){const i=s.getAgent();if(Ue(i)&&yt(i)===2){const r=this.scaledTilesPool.get(s);r.style.transform=`translate(${s.getX()*this.xStep}px, ${s.getY()*this.yStep}px) scale(2)`}}this.surface.getDeletedEntities().forEach(s=>{const i=this.scaledTilesPool.free(s);i&&(i.style.display="none")})}renderCoverage(){const t=Tt||u.Instance.getIsBaseDestroyed();if(this.coverageMap||(this.coverageMap=document.createElement("div"),this.coverageMap.style.opacity="0.5",this.coverageMap.style.position="absolute",this.coverageMap.style.top="0",this.coverageMap.style.left=N?"-0.125ch":"0",N&&(this.coverageMap.style.letterSpacing="-0.7ch",this.coverageMap.style.wordSpacing="2.04ch"),this.world.appendChild(this.coverageMap)),this._showCoverage)this.coverageMap.style.display="block";else{this.coverageMap.style.display="none";return}const e=new Set;u.Instance.getDifficulty()===H.Easy&&U.Instance.getSpawnGroups().forEach(i=>i.getSpawnPoints()[0].getTiles().forEach(r=>e.add(r)));const s=this.surface.getHeight();for(let i=0;i<s;i++){let r=this.coverageRows[i];r||(r=document.createElement("div"),this.coverageRows[i]=r,this.coverageMap.appendChild(r));const o=this.surface.getRow(i).map(c=>{if(!c.isDiscovered()&&!t)return"&nbsp;";const l=c.isCoveredByTower();return e.has(c)?l?"⚔️":"🐾":l?"🎯":"&nbsp;"}).join("");r.innerHTML=o}}renderSelection(){var i,r;const t=this.selectionPool.getUsed();let e=this.controller.getSelection();e.length===1&&(e=[]);const s=((r=(i=this.controller.getPlacable())==null?void 0:i.entity)==null?void 0:r.scale)||1;e.forEach((o,c)=>{const l=t.has(c)?t.get(c):this.selectionPool.get(c);l.style.transform=`translate(${o.getX()*this.xStep}px, ${o.getY()*this.yStep}px) scale(${s})`});for(let o=t.size-1;o>=e.length;o--){const c=this.selectionPool.free(o);c&&(c.style.display="none")}}renderAlertRanges(){const[t,e]=vt(u.Instance.getBase()),s=20*this.xStep,i=20*this.yStep,r=u.Instance.getIsStarted()?[]:U.Instance.getSpawnAlertRanges();r.forEach((o,c)=>{const l=o.getLength(),p=o.getCenter(),f=l/360;let d=this.alertRanges[c];if(!d){this.alertRanges[c]=d=document.createElementNS("http://www.w3.org/2000/svg","svg");const v=document.createElementNS("http://www.w3.org/2000/svg","circle");v.setAttribute("cx","50%"),v.setAttribute("cy","50%"),v.setAttribute("r","45%"),v.setAttribute("stroke","url(#alert)"),v.setAttribute("stroke-linecap","round"),v.setAttribute("fill","none"),d.appendChild(v);const S=document.createElementNS("http://www.w3.org/2000/svg","text");S.setAttribute("text-anchor","middle"),S.setAttribute("dominant-baseline","middle"),S.classList.add("alert"),S.innerHTML="⚠️",d.appendChild(S),d.style.position="absolute",d.style.top=N?"-.125ch":"-.075ch",d.style.left=N?".35ch":"0",d.style.transformOrigin="50%",this.world.appendChild(d)}d.style.display="block",d.children[0].setAttribute("stroke-width",`${this.fontSize}`),d.children[1].style.transform=`translate(90%, 50%) rotate(-${p}deg)`;const w=s*.9*Math.PI;d.children[0].setAttribute("stroke-dasharray",`${w*f/2} ${w*(1-f)} ${w*f/2} 0`),d.style.width=`${s}px`,d.style.height=`${i}px`,d.style.transform=`translate(${t*this.xStep-s/2}px,${e*this.yStep-i/2}px) rotate(${p}deg)`});for(let o=r.length;o<this.alertRanges.length;o++)this.alertRanges[o].style.display="none"}unmount(){throw new Error("Method not implemented.")}getTime(){return this.time}canMove(t,e){if(Tt||u.Instance.getIsBaseDestroyed())return!0;const i=this.getBBox(),r=W.Instance.getBBox();if(Math.abs(t)>Math.abs(e)){if(t<0&&i[0][0]<=r[0][0]||t>0&&i[1][0]>=r[1][0])return!1}else if(e<0&&i[0][1]<=r[0][1]||e>0&&i[1][1]>=r[1][1])return!1;return!0}registerEventHandlers(t){t.addEventListener("contextmenu",s=>(s.preventDefault(),!1));const e=(s,i,r)=>{Tt||u.Instance.getIsBaseDestroyed()||(this.getBBox(),W.Instance.getBBox(),this.canMove(s,i)||r.preventDefault())};t.addEventListener("wheel",s=>{e(s.deltaX,s.deltaY,s)},{passive:!1}),t.addEventListener("mousedown",s=>{const i=Math.floor((s.pageX-this.offsetX+this.world.scrollLeft)/this.xStep),r=Math.floor((s.pageY-this.offsetY+this.world.scrollTop)/this.yStep);this.controller.mouseDown(i,r)}),t.addEventListener("mousemove",s=>{const i=Math.floor((s.pageX-this.offsetX+this.world.scrollLeft)/this.xStep),r=Math.floor((s.pageY-this.offsetY+this.world.scrollTop)/this.yStep);this.controller.mouseMove(i,r)}),t.addEventListener("mouseup",s=>{const i=Math.floor((s.pageX-this.offsetX+this.world.scrollLeft)/this.xStep),r=Math.floor((s.pageY-this.offsetY+this.world.scrollTop)/this.yStep);this.controller.mouseUp(i,r)}),window.addEventListener("keydown",s=>{this.controller.keyDown(s.key),s.preventDefault()}),window.addEventListener("keyup",s=>{this.controller.keyUp(s.key),s.preventDefault()})}move({x:t=0,y:e=0,zoom:s}){(t||e)&&this.canMove(t,e)&&(this.world.scrollLeft+=t*this.fontSize/2,this.world.scrollTop+=e*this.fontSize/2),s&&(s<0?this.fontSize=Math.max(To,this.fontSize*.9):this.fontSize=Math.min(Io,this.fontSize*1.1),this.zoom(),this.hasMoved=!0)}getStaticEntityEmoji(t){switch(t){case h.Tower:return"🗼";case h.Wall:return"🧱";case h.Mortar:return"🛰️";case h.Flamethrower:return"🧯";case h.Railgun:return"🌡️";case h.ElectricFence:return"⚡";case h.Fence:return"🥅";case h.Freezer:return"❄️";case h.Base:return"⛺";case h.Tree:return"🌲";case h.Rock:return"🪨";case h.Radar:return"📡";case h.PowerPlant:return"🏭";case h.None:return"❌";case h.Armory:return"🏰";case h.Market:return"🏪";case h.SpeedBeacon:return"⏰";case h.DamageBeacon:return"🚨";case h.Laser:return"🔭";default:return"❓"}}getEntityEmoji(t){switch(t.getAgent().getType()){case h.Slime:return"🐞";case h.Bullet:case h.Rocket:return"▪";case h.Rail:case h.LaserBeam:return"⬛";case h.Flame:return"🔥";case h.Shockwave:return"🌀";case h.Runner:return"🪳";case h.Flier:return"🐝";case h.Tank:return"🦀";case h.WavePoint:return"🪙";default:return""}}getBBox(){const t=this.world.scrollTop/this.yStep,e=this.world.scrollLeft/this.xStep,s=this.world.clientHeight/this.yStep,i=this.world.clientWidth/this.xStep;return[[e,t],[e+i,t+s]]}};const it="atlas";var K=(n=>(n.Grass="atlas4.png",n.Sand="atlas7.png",n.Water="atlas10.png",n.WaterAlt="atlas11.png",n.Tree="atlas8.png",n.Rock="atlas9.png",n.Ice="atlas2.png",n.Snow="atlas3.png",n.Dirt="atlas1.png",n.Stone="atlas12.png",n.Spore="atlas13.png",n.SporeParticle="atlas30.png",n.Up="atlas14.png",n.Left="atlas15.png",n.Down="atlas16.png",n.Right="atlas17.png",n.UpRight="atlas18.png",n.UpLeft="atlas19.png",n.DownLeft="atlas20.png",n.DownRight="atlas21.png",n.Multi="atlas22.png",n.ActiveCoverage="atlas23.png",n.Coverage="atlas24.png",n.Alert="atlas25.png",n.Fence="atlas26.png",n.ElectricFence="atlas27.png",n.Entity="atlas28.png",n.Unknown="atlas29.png",n.Bridge="atlas5.png",n.None="atlas0.png",n.Coin="atlas31.png",n))(K||{});const _o={[g.Grass]:"atlas4.png",[g.Sand]:"atlas7.png",[g.Water]:"atlas10.png",[g.Ice]:"atlas2.png",[g.Snow]:"atlas3.png",[g.Dirt]:"atlas1.png",[g.Tree]:"atlas8.png",[g.Rock]:"atlas9.png",[g.Stone]:"atlas12.png",[g.Spore]:"atlas13.png",[g.Bridge]:"atlas5.png"},os=new mt;os.name="Floor";const ht=new mt;ht.name="Base";const Lt=new mt;Lt.name="Projectiles";const It=new mt;It.name="Towers";const Ft=new mt;Ft.name="UI";const Ao=[os,ht,Lt,It,Ft],m=32,Ns=20,xo=3,ko=.5,Ke=1,qe="buildings",Po="buildings0.png",Ro=new Map([[h.Base,"buildings0.png"],[h.Armory,"buildings1.png"],[h.PowerPlant,"buildings2.png"],[h.Radar,"buildings3.png"],[h.Market,"buildings4.png"],[h.DamageBeacon,"buildings5.png"],[h.SpeedBeacon,"buildings6.png"],[h.Freezer,"buildings12.png"]]);class Ui extends J{constructor(t,e){super(e.resources[qe].spritesheet.textures[Ro.get(t.getType())??Po]),this.data=t}sync(){this.position.set(this.data.entity.getX()*m,this.data.entity.getY()*m),this.angle=this.data.entity.getRotation()}}a(Ui,"layer",ht);const Us=new Map([[h.Armory,["buildings","buildings1.png"]],[h.PowerPlant,["buildings","buildings2.png"]],[h.Radar,["buildings","buildings3.png"]],[h.Market,["buildings","buildings4.png"]],[h.DamageBeacon,["buildings","buildings5.png"]],[h.SpeedBeacon,["buildings","buildings6.png"]],[h.Freezer,["buildings","buildings12.png"]],[h.Fence,[it,K.Fence]],[h.Wall,["buildings","buildings13.png"]],[h.ElectricFence,[it,K.ElectricFence]],[h.Tower,["turret","turret0.png"]],[h.Flamethrower,["flamethrower","flamethrower0.png"]],[h.Mortar,["mortar","mortar0.png"]],[h.Laser,["laser","laser0.png"]],[h.Railgun,["railgun","railgun0.png"]],[h.None,[it,K.None]]]);class Hi extends J{constructor(t,e){const s=t.getPlaceable().entityType;if(!Us.has(s))throw new Error(`Missing blueprint sprite for ${s}`);const[i,r]=Us.get(s);super(e.resources[i].spritesheet.textures[r]),this.data=t,s===h.None&&this.scale.set(t.getScale()),this.alpha=.7,this.position.set(this.data.entity.getX()*m,this.data.entity.getY()*m)}sync(){}}a(Hi,"layer",ht);const re="projectiles",oe="projectiles1.png",Hs=20;class Do extends J{constructor(){super(...arguments);a(this,"speed",0);a(this,"lifetime",0);a(this,"direction",0)}}class Wi extends ve{constructor(t,e){super(Hs,{position:!0,scale:!0,rotation:!0,alpha:!0}),this.data=t;for(let s=0;s<Hs;s++){const i=new Do(e.resources[re].spritesheet.textures[oe]);i.anchor.set(.5),i.scale.set(1+Math.random()*.3),i.speed=(4+Math.random()*2)*.0017,i.alpha=.8,i.lifetime=Math.floor(Math.random()*25),i.x=this.data.sourceX*m,i.y=this.data.sourceY*m,i.direction=(this.data.entity.getRotation()+20-Math.random()*40)*Math.PI/180,this.addChild(i)}}sync(t){this.children.forEach(e=>{e.x+=Math.sin(e.direction)*e.speed*t*m,e.y+=Math.cos(e.direction)*e.speed*t*m,e.lifetime+=1,e.lifetime>25&&(this.data.renderData.update?(e.lifetime=0,e.x=this.data.sourceX*m,e.y=this.data.sourceY*m,e.direction=(this.data.entity.getRotation()+20-Math.random()*40)*Math.PI/180,e.alpha=.8):(e.lifetime=Math.floor(Math.random()*25),e.alpha=0))}),this.data.renderData.update=!1}}a(Wi,"layer",Lt);const Co="explosion",Bo=.2;class ce extends Bt{constructor(t,e,s,i=1){super(Object.values(t.resources[Co].spritesheet.textures)),this.anchor.set(.5),this.animationSpeed=Bo,this.loop=!1,this.position.set(e*m,s*m),this.scale.set(i),It.addChild(this),this.onComplete=()=>{It.removeChild(this)},this.play()}}const ct=class{constructor(t,e,s){a(this,"ref");a(this,"promise");this.alias=t,this.filter=e;const i=Zt.play(t,{...s,filters:[e],complete:()=>ct.soundInstanceCountMap.set(t,ct.soundInstanceCountMap.get(t)-1)});i instanceof Promise?(i.then(r=>this.ref=r),this.promise=i):this.ref=i}static rateLimitSound(t){const e=this.soundInstanceCountMap.get(t)||0,s=this.soundPlaytimeMap.get(t)||0;if(e>this.MAX_INSTANCES)return!0;const i=performance.now();return s+this.MIN_INTERVAL>i?!0:(this.soundInstanceCountMap.set(t,e+1),this.soundPlaytimeMap.set(t,i),!1)}static getSoundOptions(t){const{x:e,y:s,width:i,height:r,scale:o}=tt.Instance.getViewport(),c=(t.getX()*m-e)/(i/2),l=(t.getY()*m-s)/(r/2),p=1/(1+(Math.max(0,Math.abs(c)-1)+Math.max(0,Math.abs(l)-1))*3),f=Math.min(o,Ke)/Ke*p,d=Math.min(1,Math.max(0,Math.abs(c)-.5))*Math.sign(c);return{volume:f,pan:d}}static fromEntity(t,e,s){const{volume:i,pan:r}=ct.getSoundOptions(t);if(!(i<.25)&&!this.rateLimitSound(e))return new ct(e,new fn.StereoFilter(r),{...s,volume:i})}destroy(){var t;this.ref?(t=this.ref)==null||t.destroy():this.promise.then(e=>e.destroy()),ct.soundInstanceCountMap.set(this.alias,ct.soundInstanceCountMap.get(this.alias)-1)}update(t){if(this.ref){const{volume:e,pan:s}=ct.getSoundOptions(t);this.ref.volume=e,this.filter.pan=s}}fade(t,e=500){return this.ref?(this.ref.volume-=t/e*.8,this.ref.volume<.2?(this.destroy(),!0):!1):!1}};let z=ct;a(z,"soundInstanceCountMap",new Map),a(z,"soundPlaytimeMap",new Map),a(z,"MAX_INSTANCES",3),a(z,"MIN_INTERVAL",100);var $=(n=>(n.Notification="notification",n.Shot="shot",n.Laser="laser",n.Flamethrower="flamethrower",n.Mortar="mortar",n.Railgun="railgun",n.Explosion="explosion",n.Firework="firework",n.Place="place",n.Destroy="destroy",n.Hit="hit",n.Sonar="sonar",n))($||{});const et=(n,t,e=1)=>{Zt.add(n,{url:`/open-td/${t}`,preload:!0,volume:e})},Lo=()=>{et("notification","sounds/notification.ogg"),et("shot","sounds/shot.wav",.7),et("laser","sounds/laser.flac",.5),et("flamethrower","sounds/flamethrower.wav",.2),et("mortar","sounds/mortar.wav",.7),et("railgun","sounds/railgun.mp3",.7),et("explosion","sounds/explosion.wav"),et("firework","sounds/firework.wav"),et("place","sounds/place.wav",.7),et("destroy","sounds/destroy.wav",.7),et("hit","sounds/hit.wav"),et("sonar","sounds/sonar.wav",.7)},de=(n,t,e)=>{b.Instance.addEventListener(n,()=>Zt.play(t,e))},Fo="flier",Oo=.2,Yo=1/4,Xo=1/8,$o=.0015;class Vi extends Bt{constructor(e,s){super(Object.values(s.resources[Fo].spritesheet.textures));a(this,"flames",[]);a(this,"isBusy",!1);this.data=e,this.loader=s,this.anchor.set(.5),this.animationSpeed=Oo,this.play(),this.on("removed",()=>new ce(s,e.entity.getX()+.5,e.entity.getY()+.5))}sync(){const e=$o*(1+this.data.entity.getId()%13/13),s=.5+Math.sin((tt.Instance.getTime()+this.data.entity.getId())*e)/4-Xo,i=.5+Math.cos((tt.Instance.getTime()+this.data.entity.getId())*e)/2-Yo;this.position.set((this.data.entity.getX()+s)*m,(this.data.entity.getY()+i)*m),this.angle=this.data.entity.getRotation(),this.data.AI.isBusy()&&(this.angle+=Math.sin(tt.Instance.getTime()%Z/Z*5)*20),this.data.AI.isBusy()!==this.isBusy&&(this.isBusy||z.fromEntity(this.data.entity,$.Hit),this.isBusy=this.data.AI.isBusy());const r=m/2;if(this.flames.forEach(o=>{o.angle=-this.data.entity.getRotation(),o.position.set(Math.random()*r-r/2,Math.random()*r-r/2)}),this.data.getStatus()===R.OnFire&&!this.flames.length){this.tint=14833698;for(let o=0;o<2;o++){const c=new J(this.loader.resources[re].spritesheet.textures[oe]);c.alpha=.8,c.anchor.set(.5),c.position.set(Math.random()*r-r/2,Math.random()*r-r/2),this.addChild(c),this.flames.push(c)}}else this.data.getStatus()!==R.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[])}}a(Vi,"layer",ht);const No="projectiles",Uo="projectiles3.png",Ye=16;class ji extends Qs{constructor(e,s){super(s.resources[No].spritesheet.textures[Uo],Ye,Ye);a(this,"tileOffset",0);this.data=e,this.pivot={x:Ye/2,y:0}}sync(){this.tilePosition.y=this.tileOffset,this.tileOffset+=.5;const e=this.data.entity.getX(),s=this.data.entity.getY(),i=Math.sqrt((e-this.data.targetX)**2+(s-this.data.targetY)**2);this.height=i*m,this.alpha=Math.min(1,1-this.data.time/Se+.1),this.position.set(this.data.entity.getX()*m,this.data.entity.getY()*m),this.angle=this.data.entity.getRotation()-90}}a(ji,"layer",Lt);const Ho="projectiles",Wo="projectiles4.png",Xe=16;class Gi extends Qs{constructor(t,e){super(e.resources[Ho].spritesheet.textures[Wo],Xe,Xe),this.data=t,this.pivot={x:Xe/2,y:0}}sync(){const t=this.data.entity.getX(),e=this.data.entity.getY(),s=Math.sqrt((t-this.data.targetX)**2+(e-this.data.targetY)**2);this.height=s*m,this.alpha=Math.min(1,1-this.data.time/es+.1),this.position.set(this.data.entity.getX()*m,this.data.entity.getY()*m),this.angle=this.data.entity.getRotation()-90}}a(Gi,"layer",Lt);const Vo="regular",jo=.1,Ws=1/4;class zi extends Bt{constructor(e,s){super(Object.values(s.resources[Vo].spritesheet.textures));a(this,"flames",[]);this.data=e,this.loader=s,this.anchor.set(.5),this.animationSpeed=jo,this.on("removed",()=>new ce(s,e.entity.getX()+.5,e.entity.getY()+.5)),this.play()}sync(){const e=.5+this.data.entity.getId()%13/26-Ws,s=.5+(this.data.entity.getId()+5)%17/34-Ws;this.position.set((this.data.entity.getX()+e)*m,(this.data.entity.getY()+s)*m),this.angle=this.data.entity.getRotation(),this.data.AI.isBusy()&&(this.angle+=Math.sin(tt.Instance.getTime()%Z/Z*5)*20),this.data.AI.isBusy()===this.playing&&(this.playing?this.stop():(z.fromEntity(this.data.entity,$.Hit),this.play()));const i=m/2;if(this.flames.forEach(r=>{r.angle=-this.data.entity.getRotation(),r.position.set(Math.random()*i-i/2,Math.random()*i-i/2)}),this.data.getStatus()===R.OnFire&&!this.flames.length){this.tint=14833698;for(let r=0;r<2;r++){const o=new J(this.loader.resources[re].spritesheet.textures[oe]);o.alpha=.8,o.anchor.set(.5),o.position.set(Math.random()*i-i/2,Math.random()*i-i/2),this.addChild(o),this.flames.push(o)}}else this.data.getStatus()!==R.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[])}}a(zi,"layer",ht);const Go="runner",zo=.1,Vs=1/4;class Ki extends Bt{constructor(e,s){super(Object.values(s.resources[Go].spritesheet.textures));a(this,"flames",[]);this.data=e,this.loader=s,this.anchor.set(.5),this.animationSpeed=zo,this.on("removed",()=>new ce(s,e.entity.getX()+.5,e.entity.getY()+.5)),this.play()}sync(){const e=.5+this.data.entity.getId()%13/26-Vs,s=.5+(this.data.entity.getId()+5)%17/34-Vs;this.position.set((this.data.entity.getX()+e)*m,(this.data.entity.getY()+s)*m),this.angle=this.data.entity.getRotation(),this.data.AI.isBusy()&&(this.angle+=Math.sin(tt.Instance.getTime()%Z/Z*5)*20),this.data.AI.isBusy()===this.playing&&(this.playing?this.stop():(z.fromEntity(this.data.entity,$.Hit),this.play()));const i=m/2;if(this.flames.forEach(r=>{r.angle=-this.data.entity.getRotation(),r.position.set(Math.random()*i-i/2,Math.random()*i-i/2)}),this.data.getStatus()===R.OnFire&&!this.flames.length){this.tint=14833698;for(let r=0;r<2;r++){const o=new J(this.loader.resources[re].spritesheet.textures[oe]);o.alpha=.8,o.anchor.set(.5),o.position.set(Math.random()*i-i/2,Math.random()*i-i/2),this.addChild(o),this.flames.push(o)}}else this.data.getStatus()!==R.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[])}}a(Ki,"layer",ht);const Ko="projectiles",qo="projectiles0.png",Zo=new Map([[h.Bullet,"projectiles0.png"],[h.Flame,"projectiles1.png"],[h.Rocket,"projectiles2.png"],[h.Shockwave,"projectiles5.png"]]);class Me extends J{constructor(t,e){super(e.resources[Ko].spritesheet.textures[Zo.get(t.getType())??qo]),this.data=t,this.pivot={x:8,y:8}}sync(){this.position.set(this.data.entity.getX()*m,this.data.entity.getY()*m),this.angle=this.data.entity.getRotation()}}a(Me,"layer",Lt);const Jo="tank",Qo=.1,js=1/4;class qi extends Bt{constructor(e,s){super(Object.values(s.resources[Jo].spritesheet.textures));a(this,"flames",[]);this.data=e,this.loader=s,this.anchor.set(.5),this.animationSpeed=Qo,this.on("removed",()=>new ce(s,e.entity.getX()+.5,e.entity.getY()+.5)),this.play()}sync(){const e=.5+this.data.entity.getId()%13/26-js,s=.5+(this.data.entity.getId()+5)%17/34-js;this.position.set((this.data.entity.getX()+e)*m,(this.data.entity.getY()+s)*m),this.angle=this.data.entity.getRotation(),this.data.AI.isBusy()&&(this.angle+=Math.sin(tt.Instance.getTime()%Z/Z*5)*20),this.data.AI.isBusy()===this.playing&&(this.playing?this.stop():(z.fromEntity(this.data.entity,$.Hit),this.play()));const i=m/2;if(this.flames.forEach(r=>{r.angle=-this.data.entity.getRotation(),r.position.set(Math.random()*i-i/2,Math.random()*i-i/2)}),this.data.getStatus()===R.OnFire&&!this.flames.length){this.tint=14833698;for(let r=0;r<2;r++){const o=new J(this.loader.resources[re].spritesheet.textures[oe]);o.alpha=.8,o.anchor.set(.5),o.position.set(Math.random()*i-i/2,Math.random()*i-i/2),this.addChild(o),this.flames.push(o)}}else this.data.getStatus()!==R.OnFire&&this.flames.length&&(this.tint=16777215,this.removeChildren(),this.flames=[])}}a(qi,"layer",ht);const tc=new Map([[h.Tower,"turret"],[h.Flamethrower,"flamethrower"],[h.Laser,"laser"],[h.Mortar,"mortar"],[h.Railgun,"railgun"]]),Gs=new Map([[h.Tower,$.Shot],[h.Flamethrower,$.Flamethrower],[h.Laser,$.Laser],[h.Mortar,$.Mortar],[h.Railgun,$.Railgun]]),ec=new Set([h.Flamethrower,h.Laser]),sc=.1,ic=.6,nc="buildings8.png",ac="buildings9.png",rc="buildings10.png",oc="buildings11.png",zs=(n,t)=>n?t?nc:ac:t?rc:oc;class kt extends J{constructor(e,s){super(s.resources[qe].spritesheet.textures[zs(e.isSpeedBoosted(),e.isDamageBoosted())]);a(this,"turret");a(this,"sound");this.data=e,this.loader=s;const[i,r]=vt(e);this.position.set(i*m,r*m),this.pivot={x:m,y:m},this.createTurret()}createTurret(){const e=tc.get(this.data.getType());this.turret=new Bt(Object.values(this.loader.resources[e].spritesheet.textures)),this.turret.position.set(this.x,this.y),this.turret.pivot={x:m,y:m},this.turret.animationSpeed=sc,this.turret.loop=!1,this.turret.onComplete=()=>{this.turret.gotoAndStop(0)},It.addChild(this.turret),this.on("removed",()=>It.removeChild(this.turret))}sync(e,s){s&&(this.texture=this.loader.resources[qe].spritesheet.textures[zs(this.data.isSpeedBoosted(),this.data.isDamageBoosted())]),this.turret.angle=Wn(this.turret.angle,this.data.entity.getRotation(),ic*e),this.data.renderData.fired?(this.data.renderData.fired=!1,this.turret.play(),ec.has(this.data.getType())?this.sound?this.sound.update(this.data.entity):this.sound=z.fromEntity(this.data.entity,Gs.get(this.data.getType()),{loop:!0}):z.fromEntity(this.data.entity,Gs.get(this.data.getType()))):this.sound&&this.sound.fade(e)&&(this.sound=void 0)}}a(kt,"layer",ht);class Zi extends Me{constructor(t,e){super(t,e),this.on("removed",()=>{new ce(e,t.entity.getX(),t.entity.getY(),2),z.fromEntity(t.entity,$.Explosion)})}}a(Zi,"layer",It);const Ks=75,qs=1e3;class cc extends J{constructor(){super(...arguments);a(this,"speed",Math.random()*.002)}}class Ji extends mt{constructor(e,s){super();a(this,"container");a(this,"sprite");a(this,"time",0);this.data=e,this.sprite=new J(s.resources[it].spritesheet.textures[K.Coin]),this.sprite.anchor.set(.5),this.container=new ve(Ks,{alpha:!0});for(let i=0;i<Ks;i++){const r=new cc(s.resources[it].spritesheet.textures[K.SporeParticle]),o=i%25/25*Math.PI*2,c=Math.floor(i/25)*.75+.25;r.anchor.set(.5),r.alpha=.9,r.x=(this.data.sourceX+Math.sin(o)*c)*m,r.y=(this.data.sourceY+Math.cos(o)*c)*m,this.container.addChild(r)}this.addChild(this.sprite,this.container),z.fromEntity(this.data.entity,$.Firework)}sync(e){this.sprite.position.set(this.data.entity.getX()*m,this.data.entity.getY()*m),this.sprite.angle=this.data.entity.getRotation(),this.container.children.forEach((s,i)=>{const r=i%25/25*Math.PI*2;s.x+=Math.sin(r)*s.speed*e*m,s.y+=Math.cos(r)*s.speed*e*m,s.alpha=.9-this.time/qs*.8}),this.time+=e,this.time>qs&&this.removeChild(this.container)}}a(Ji,"layer",Ft);const hc=n=>{n.add("runner","/open-td/animations/runner.json"),n.add("regular","/open-td/animations/regular.json"),n.add("flier","/open-td/animations/flier.json"),n.add("tank","/open-td/animations/tank.json"),n.add("buildings","/open-td/tiles/buildings.json"),n.add("turret","/open-td/animations/turret.json"),n.add("flamethrower","/open-td/animations/flamethrower.json"),n.add("laser","/open-td/animations/laser.json"),n.add("mortar","/open-td/animations/mortar.json"),n.add("railgun","/open-td/animations/railgun.json"),n.add("projectiles","/open-td/tiles/projectiles.json"),n.add("explosion","/open-td/animations/explosion.json")},lc={[h.Runner]:Ki,[h.Slime]:zi,[h.Flier]:Vi,[h.Tank]:qi,[h.Tower]:kt,[h.Flamethrower]:kt,[h.Laser]:kt,[h.Mortar]:kt,[h.Railgun]:kt,[h.Bullet]:Me,[h.Flame]:Wi,[h.Rocket]:Zi,[h.Shockwave]:Me,[h.LaserBeam]:ji,[h.Rail]:Gi,[h.Fence]:null,[h.Wall]:null,[h.ElectricFence]:null,[h.Blueprint]:Hi,[h.WavePoint]:Ji},uc={1:[[0,-1],[-1,0],[0,1],[1,0],[1,-1],[-1,-1],[-1,1],[1,1]],2:[[0,-1],[-1,0],[0,2],[2,0],[2,-1],[-1,-1],[-1,2],[2,2]]},ge=8,Qi=new Set([g.Fence,g.Wall,g.ElectricFence]);class dc{constructor(t,e,s){this.loader=t,this.tilemap=e,this.surface=s,t.add("fences","/open-td/tiles/fenceCombined.json"),t.add("wall","/open-td/tiles/bigWall.json")}getWallSprite(t,e){switch(t){case h.Fence:return this.loader.resources.fences.textures[`fenceCombined${e}.png`];case h.ElectricFence:return this.loader.resources.fences.textures[`fenceCombined${9+e}.png`];case h.Wall:return this.loader.resources.wall.textures[`bigWall${e}.png`];default:throw new Error("unknown wall type")}}render(t){const e=t.getStaticEntity().getAgent(),s=e.getType(),i=yt(e);let r=0,o=0,c=0,l=!1;uc[i].forEach(([p,f],d)=>{if(d>3&&(l||p===o||f===c))return;const w=this.surface.getTile(t.getX()+p,t.getY()+f);w&&Qi.has(w.getType())&&yt(w.getStaticEntity().getAgent())===i&&(d<=3&&(o&&p||c&&f?l=!0:(o=o||p,c=c||f)),this.tilemap.tile(this.getWallSprite(s,d),t.getX()*m-ge*i,t.getY()*m-ge*i),r++)}),r<2&&this.tilemap.tile(this.getWallSprite(s,8),t.getX()*m-ge*i,t.getY()*m-ge*i)}}class gc extends J{constructor(t,e,s){super(s),this.offset=t,this.path=e;const{x:i,y:r}=this.path.getCoordinates(this.offset%this.path.getLength());this.position.set(i*m,r*m)}move(){this.offset+=.1;const{x:t,y:e}=this.path.getCoordinates(this.offset%this.path.getLength());this.position.set(t*m,e*m)}}class pc{constructor(t,e){a(this,"coverageContainer");a(this,"pathContainer");a(this,"towers",new Map);a(this,"hoveredTile");a(this,"visible",!1);this.loader=t,this.surface=e,this.coverageContainer=new ve(void 0,{uvs:!0},void 0,!0),os.addChild(this.coverageContainer),this.pathContainer=new ve(void 0,{position:!0},void 0,!0),Ft.addChild(this.pathContainer)}show(){this.visible=!0,this.render()}hide(){this.visible=!1,this.coverageContainer.removeChildren(),this.pathContainer.removeChildren()}render(){!this.visible||(this.renderCoverage(),u.Instance.getDifficulty()===H.Easy&&this.renderPaths())}renderCoverage(){this.coverageContainer.removeChildren(),this.towers.clear(),this.hoveredTile=void 0;const t=this.surface.getHeight();for(let e=0;e<t;e++)this.surface.getRow(e).forEach(s=>{const i=s.getTowers();if(i.length===0||!s.isDiscovered())return;const r=new J(this.loader.resources[it].textures[K.Coverage]);r.alpha=Math.min(.1+.2*i.length,.8),r.position.set(s.getX()*m,s.getY()*m),this.coverageContainer.addChild(r),i.forEach(o=>{const c=this.towers.get(o.getTile().getHash())||[];c.push(r),this.towers.set(o.getTile().getHash(),c)})})}renderPaths(){this.pathContainer.removeChildren();const t=[];U.Instance.getSpawnGroups().forEach(e=>t.push(...e.getSpawnPoints())),t.forEach((e,s)=>{const i=this.slicePath(e),r=Math.max(1,Math.floor(i.getLength()/5));for(let o=0;o<r;o++)this.pathContainer.addChild(new gc(s*2+o*5,i,this.loader.resources[it].textures[K.Entity]))})}slicePath(t){let e,s;for(let i=0;i<t.getLength();i++){const r=t.getTile(i);if(r.isDiscovered()||(e=i+1),r.hasStaticEntity()&&Je.has(r.getStaticEntity().getAgent().getType())){s=i;break}}return t.slice(e,s)}update(){var i,r;if(!this.visible)return;u.Instance.getIsStarted()?this.pathContainer.removeChildren():this.pathContainer.children.forEach(o=>o.move());const[t,e]=pt.Instance.getMouse(2),s=this.surface.getTile(t,e);s!==this.hoveredTile&&(this.hoveredTile&&((i=this.towers.get(this.hoveredTile.getHash()))==null||i.forEach(o=>{o.texture=this.loader.resources[it].textures[K.Coverage]})),s&&((r=this.towers.get(s.getHash()))==null||r.forEach(o=>{o.texture=this.loader.resources[it].textures[K.ActiveCoverage]})),this.hoveredTile=s)}}const zt=class{constructor(t){a(this,"container");a(this,"alertSymbols",[]);a(this,"time",0);a(this,"permanent",!1);this.loader=t,this.container=new mt,Ft.addChild(this.container),b.Instance.addEventListener(M.EndWave,()=>this.reset())}enable(){this.permanent=!0,this.container.alpha=1,this.time=zt.DISPLAY_DURATION}disable(){this.permanent=!1,this.time=zt.DISPLAY_DURATION}reset(){this.time=0,this.container.alpha=1}render(t,e){this.alertSymbols=[],this.container.removeChildren();const[s,i]=t,r=Math.PI/128;e.forEach(o=>{const[c,l]=o.getRange(),p=new mt,f=new Ne;f.lineStyle({width:10,color:267386880,cap:mn.ROUND,alpha:.8,alignment:.5}),f.arc(s*m,i*m,10*m,c*Math.PI/180+r,l*Math.PI/180-r);const d=new J(this.loader.resources[it].textures[K.Alert]);d.anchor.set(.5);const w=o.getCenter()*Math.PI/180;d.position.set((s+Math.cos(w)*9.2)*m,(i+Math.sin(w)*9.2)*m),this.alertSymbols.push(d),p.addChild(f,d),this.container.addChild(p)})}update(t,e){this.container.alpha<=0||(!this.permanent&&(this.time>zt.DISPLAY_DURATION||e)&&(this.container.alpha-=t/500),this.alertSymbols.forEach(s=>{s.alpha=Math.abs(Math.cos(this.time/300))}),this.time+=t)}};let we=zt;a(we,"DISPLAY_DURATION",10*1e3);const fc=(n,t,e)=>{const s=Number(n);return isNaN(s)||t&&s<t?t??0:e&&s>e?e:s},mc={True:!0,False:!1},yc=(n,t,e)=>{var s;return((s=Object.entries(n).find(([i,r])=>t===r))==null?void 0:s[0])||e},Zs=(n,t,e)=>Object.values(n).find(s=>s===t)??e,wc=(n,t)=>{if(n==="renderer"){const e={emojiRenderer:rs,pixiRenderer:tt};return t in e?e[t]:e.pixiRenderer}return n==="difficulty"?Zs(H,t):n==="showTutorial"?Zs(mc,t):n==="volume"?fc(t,0,100):t},vc=(n,t)=>n==="renderer"?yc({emojiRenderer:rs,pixiRenderer:tt},t,"pixiRenderer"):t,Sc={settings:wc},Ec={settings:vc},cs=n=>{let t;try{t=localStorage.getItem(n)}catch{return null}if(!t)return null;try{return JSON.parse(t,Sc[n])}catch{return null}},Mc=(n,t)=>{const e=cs(n)||{},s=JSON.stringify({...e,...t},Ec[n]);try{localStorage.setItem(n,s)}catch(i){console.warn("Failed to store data",i)}},Ic=`varying vec2 vTextureCoord;
uniform sampler2D uSampler;

uniform vec2 thickness;
uniform vec4 outlineColor;
uniform vec4 filterClamp;

const float DOUBLE_PI = 3.14159265358979323846264 * 2.;

void main(void) {
    vec4 ownColor = texture2D(uSampler, vTextureCoord);
    vec4 curColor;
    float maxAlpha = 0.;
    vec2 displaced;
    for (float angle = 0.; angle <= DOUBLE_PI; angle += \${angleStep}) {
        displaced.x = vTextureCoord.x + thickness.x * cos(angle);
        displaced.y = vTextureCoord.y + thickness.y * sin(angle);
        curColor = texture2D(uSampler, clamp(displaced, filterClamp.xy, filterClamp.zw));
        maxAlpha = max(maxAlpha, curColor.a);
    }
    float resultAlpha = maxAlpha * step(ownColor.a, 0.0) > 0. ? 1. : 0.0;

    gl_FragColor = vec4(outlineColor.rgb * resultAlpha, resultAlpha);
}
`,Kt=class extends yn{constructor(e=1,s=0,i=.1){super(void 0,Ic.replace(/\$\{angleStep\}/,Kt.getAngleStep(i)));a(this,"_thickness",1);this.uniforms.thickness=new Float32Array([0,0]),this.uniforms.outlineColor=new Float32Array([0,0,0,1]),Object.assign(this,{thickness:e,color:s,quality:i})}static getAngleStep(e){if(e===0)return(Math.PI/2).toFixed(7);const s=Math.max(e*Kt.MAX_SAMPLES,Kt.MIN_SAMPLES);return(Math.PI*2/s).toFixed(7)}apply(e,s,i,r){this.uniforms.thickness[0]=this._thickness/s._frame.width,this.uniforms.thickness[1]=this._thickness/s._frame.height,e.applyFilter(this,s,i,r)}get color(){return wn(this.uniforms.outlineColor)}set color(e){vn(e,this.uniforms.outlineColor)}get thickness(){return this._thickness}set thickness(e){this._thickness=e,this.padding=e}};let Dt=Kt;a(Dt,"MIN_SAMPLES",1),a(Dt,"MAX_SAMPLES",100);const Tc=Intl.NumberFormat(void 0,{maximumFractionDigits:0});class bc{constructor(){a(this,"container");a(this,"rangeGraphic");a(this,"text");a(this,"oldMousePosition","");a(this,"oldMode",Yi.Line);this.rangeGraphic=new Ne,this.rangeGraphic.filters=[new Dt(2,0,0)],this.container=new Ne,this.container.filters=[new Dt(2,0,0)],this.text=new Sn("",{fontFamily:"JupiterCrash",fontSize:24,fill:0,align:"left",dropShadow:!0,dropShadowColor:16777215,dropShadowDistance:2}),Ft.addChild(this.rangeGraphic,this.container,this.text)}render(){var f;const t=pt.Instance,e=t.getMouse(),s=t.getMode();if(e.join(",")===this.oldMousePosition&&s===this.oldMode)return;this.oldMousePosition=e.join(","),this.oldMode=s;const i=t.getPlacable(),r=m*(((f=i==null?void 0:i.entity)==null?void 0:f.scale)||1);this.rangeGraphic.clear(),this.container.clear(),this.container.fill.visible=!0;const o=new Set,c=new Set,l=u.Instance.getSurface();let p;if(i!=null&&i.entity&&(p=i.entity.range),t.isMouseDown())t.getSelection().forEach(d=>{this.container.drawRect(d.getX()*m,d.getY()*m,r,r),p&&l.forCircle(d.getX()+1,d.getY()+1,p,w=>c.add(w)),d.hasStaticEntity()&&o.add(d.getStaticEntity().getAgent())});else{const[d,w]=t.getMouse();this.container.drawRect(d*m,w*m,r,r),p&&l.forCircle(d+1,w+1,p,S=>c.add(S));const v=l.getTile(d,w);v&&v.hasStaticEntity()&&o.add(v.getStaticEntity().getAgent())}this.rangeGraphic.clear().beginFill();for(let d of c)this.rangeGraphic.drawRect(d.getX()*m,d.getY()*m,m,m);if(this.rangeGraphic.endFill(),(i==null?void 0:i.entityType)===h.None){const d=[...o].reduce((w,v)=>w+X.Instance.getValue(v),0);d>0?this.text.text=`Sell for 🪙 ${Tc.format(d)}`:this.text.text="",this.text.position.set(e[0]*m,e[1]*m-24)}else this.text.text=""}}let pe=!1;En.use32bitIndex=!0;const Ms=class{constructor(t,e){a(this,"messageFn");a(this,"resolveMessageFn");a(this,"target");a(this,"app");a(this,"viewport");a(this,"tilemap");a(this,"sprites",new Map);a(this,"loader");a(this,"wallRenderer");a(this,"coverageRenderer");a(this,"alertRenderer");a(this,"cursorRenderer");a(this,"x",0);a(this,"y",0);a(this,"scale",Ke);a(this,"width",0);a(this,"height",0);a(this,"time",0);a(this,"showMessage",async(...t)=>{const e=await this.messageFn;return Zt.play($.Notification),e(...t)});this.surface=t,this.controller=e,Ms.instance=this,this.messageFn=new Promise(i=>this.resolveMessageFn=i),this.tilemap=new Mn,this.loader=new In,this.loader.add(it,"/open-td/tiles/atlas.json"),this.wallRenderer=new dc(this.loader,this.tilemap,this.surface),hc(this.loader),this.loader.load(),Lo(),window.debug=()=>{pe=!pe,this.renderTilemap()};const s=cs("settings");Zt.volumeAll=((s==null?void 0:s.volume)??100)/100}static get Instance(){return this.instance}mount(t){this.target=t,this.app=new Tn({width:window.innerWidth,height:window.innerHeight}),t.appendChild(this.app.view),this.width=this.surface.getWidth()*m,this.height=this.surface.getHeight()*m,this.viewport=new bn({screenWidth:window.innerWidth,screenHeight:window.innerHeight,worldWidth:this.width,worldHeight:this.height,interaction:this.app.renderer.plugins.interaction}).clamp({direction:"all",underflow:"center"}).drag({wheel:!0,clampWheel:!0,pressDrag:!1}).addListener("moved",({type:i})=>{i!=="animate"&&(this.x=this.viewport.center.x,this.y=this.viewport.center.y)}),this.app.stage.addChild(this.viewport),this.viewport.addChild(this.tilemap,...Ao),this.coverageRenderer=new pc(this.loader,this.surface),this.alertRenderer=new we(this.loader),this.cursorRenderer=new bc,this.loader.loading?this.loader.onComplete.add(()=>this.renderTilemap()):this.renderTilemap();const e=t.appendChild(document.createElement("div"));Ze(Ni,{register:this.resolveMessageFn}).mount(e);const s=u.Instance.getBase().getTile();this.x=s.getX()*m,this.y=s.getY()*m,this.viewport.animate({time:0,position:{x:this.x,y:this.y}}),this.registerEventHandlers()}renderTilemap(){this.tilemap.clear();const t=pe||u.Instance.getIsBaseDestroyed(),e=this.loader.resources[it],s=this.surface.getHeight(),i=[];for(let c=0;c<s;c++)this.surface.getRow(c).forEach(l=>{if(!t){if(l.getDiscoveryStatus()===B.Undiscovered)return;if(l.getDiscoveryStatus()===B.Pending){this.tilemap.tile(e.textures[K.Unknown],l.getX()*m,l.getY()*m);return}}let p=_o[l.getBaseType()];p&&(this.tilemap.tile(e.textures[p],l.getX()*m,l.getY()*m),l.getBaseType()===g.Water&&this.tilemap.tileAnimX(32,2)),l.hasStaticEntity()&&(l.getType()===g.Tree?this.tilemap.tile(e.textures[K.Tree],l.getX()*m,l.getY()*m):l.getType()===g.Rock?this.tilemap.tile(e.textures[K.Rock],l.getX()*m,l.getY()*m):Qi.has(l.getType())&&l.isStaticEntityRoot()&&i.push(l))});i.forEach(c=>this.wallRenderer.render(c)),this.coverageRenderer.render();const r=vt(u.Instance.getBase()),o=U.Instance.getSpawnAlertRanges();this.alertRenderer.render(r,o)}rerender(t){if(this.loader.loading)return;this.time+=t;const e=pe||u.Instance.getIsBaseDestroyed(),s=this.surface.isDirty();s&&this.renderTilemap(),this.app.renderer.plugins.tilemap.tileAnim[0]+=t/500;const i=this.surface.getEntities();for(let o of i){let c=this.sprites.get(o.getId());if(!c){const l=lc[o.getAgent().getType()];if(l===null)continue;const p=l||Ui;c=new p(o.getAgent(),this.loader),p.layer.addChild(c),this.sprites.set(o.getId(),c)}o.getAgent().isVisible()||e?(c.sync(t,s),c.visible=!0):c.visible=!1}this.surface.getDeletedEntities().forEach(o=>{const c=this.sprites.get(o.getId());c&&(this.sprites.delete(o.getId()),c.constructor.layer.removeChild(c))}),this.cursorRenderer.render(),this.coverageRenderer.update(),this.alertRenderer.update(t,u.Instance.getIsStarted()),this.surface.markPristine()}showCoverage(){this.coverageRenderer.show(),this.alertRenderer.enable()}hideCoverage(){this.coverageRenderer.hide(),this.alertRenderer.disable()}unmount(){throw new Error("Method not implemented.")}getTime(){return this.time}registerEventHandlers(){this.target.addEventListener("contextmenu",t=>(t.preventDefault(),!1)),this.viewport.addListener("mousedown",t=>{const e=Math.floor((t.data.global.x/this.viewport.scale.x+this.viewport.left)/m),s=Math.floor((t.data.global.y/this.viewport.scale.y+this.viewport.top)/m);this.controller.mouseDown(e,s)}),this.viewport.addListener("mousemove",t=>{const e=Math.floor((t.data.global.x/this.viewport.scale.x+this.viewport.left)/m),s=Math.floor((t.data.global.y/this.viewport.scale.y+this.viewport.top)/m);this.controller.mouseMove(e,s)}),this.viewport.addListener("mouseup",t=>{const e=Math.floor((t.data.global.x/this.viewport.scale.x+this.viewport.left)/m),s=Math.floor((t.data.global.y/this.viewport.scale.y+this.viewport.top)/m);this.controller.mouseUp(e,s)}),window.addEventListener("keydown",t=>{this.controller.keyDown(t.key),t.preventDefault()}),window.addEventListener("keyup",t=>{this.controller.keyUp(t.key),t.preventDefault()}),de(M.StartWave,$.Sonar),de(M.Buy,$.Place),de(M.Sell,$.Destroy),de(M.HitBase,$.Destroy)}move({x:t=0,y:e=0,zoom:s}){s&&(s<0?this.scale=Math.max(ko,this.scale*.9):this.scale=Math.min(xo,this.scale*1.1));const i=this.viewport.worldScreenWidth/2,r=this.viewport.worldScreenHeight/2;(t>0&&this.x<this.width-i||t<0&&this.x>i)&&(this.x+=t*Ns/this.scale),(e>0&&this.y<this.height-r||e<0&&this.y>r)&&(this.y+=e*Ns/this.scale),this.viewport.animate({time:200,position:{x:this.x,y:this.y},scale:this.scale})}getViewport(){var t,e;return{x:this.x,y:this.y,width:((t=this.viewport)==null?void 0:t.worldScreenWidth)||0,height:((e=this.viewport)==null?void 0:e.worldScreenHeight)||0,scale:this.scale}}};let tt=Ms;a(tt,"instance");const _c={},Ac={class:"key-grid"};function xc(n,t){return I(),A("div",Ac,[gn(n.$slots,"default",{},void 0,!0)])}const $e=ot(_c,[["render",xc],["__scopeId","data-v-ad6fcae2"]]),Re=n=>(Jt("data-v-1cf0af5a"),n=n(),Qt(),n),kc=Re(()=>y("h3",null,"Build menu",-1)),Pc={class:"flex"},Rc=Re(()=>y("h3",null,"Building",-1)),Dc={class:"flex flex-justify"},Cc={class:"key-combination"},Bc={class:"key-combination"},Lc=Re(()=>y("h3",null,"Moving",-1)),Fc={class:"flex flex-justify"},Oc=Re(()=>y("h3",null,"Zooming",-1)),Yc={class:"flex"},Xc=nt({__name:"ControlsList",setup(n){return(t,e)=>(I(),A(ft,null,[kc,y("div",Pc,[k(F,{char:"b"})]),Rc,y("div",Dc,[k(ye,{button:"left"}),C(" / "),y("span",Cc,[k(F,{char:"⇧"}),C(" + "),k(ye,{button:"left"})]),C(" / "),y("span",Bc,[k(F,{char:"⌘"}),C(" + "),k(ye,{button:"left"})])]),Lc,y("div",Fc,[k($e,null,{default:Ce(()=>[k(F,{char:"w",area:"up"}),k(F,{char:"a",area:"left"}),k(F,{char:"s",area:"down"}),k(F,{char:"d",area:"right"})]),_:1}),C(" / "),k($e,null,{default:Ce(()=>[k(F,{char:"z",area:"up"}),k(F,{char:"q",area:"left"}),k(F,{char:"s",area:"down"}),k(F,{char:"d",area:"right"})]),_:1}),C(" / "),k($e,null,{default:Ce(()=>[k(F,{char:"↑",area:"up"}),k(F,{char:"←",area:"left"}),k(F,{char:"↓",area:"down"}),k(F,{char:"→",area:"right"})]),_:1})]),Oc,y("div",Yc,[k(F,{char:"-"}),k(F,{char:"+"})])],64))}});const $c=ot(Xc,[["__scopeId","data-v-1cf0af5a"]]),tn=n=>(Jt("data-v-d3021af7"),n=n(),Qt(),n),Nc={class:"wrapper"},Uc=tn(()=>y("h1",null,"Open Tower Defense 🗼",-1)),Hc={class:"menu"},Wc={class:"menu-main"},Vc={class:"menu-main-inner"},jc=["value"],Gc={class:"difficulty-description"},zc=tn(()=>y("button",{type:"submit"},"Start!",-1)),Kc={class:"menu-controls-inner"},qc={class:"menu-settings-inner"},Zc=["value"],Jc={class:"horizontal"},Qc=nt({__name:"MainMenu",props:{onPlay:null},setup(n){const t=n,e=[{label:"Emoji renderer",value:rs},{label:"Pixi renderer",value:tt}],s=cs("settings"),i=_(0),r=_(""),o=_(null),c=_((s==null?void 0:s.difficulty)||H.Easy),l=_(s&&e.find(({value:v})=>v===s.renderer)||e[0]),p=_((s==null?void 0:s.showTutorial)??!0),f=_((s==null?void 0:s.volume)??100),d=v=>{var S;if(v===i.value){i.value=0;return}i.value=v,i.value===1&&((S=o.value)==null||S.focus())},w=v=>{v.preventDefault(),Mc("settings",{renderer:l.value.value,difficulty:c.value,showTutorial:p.value,volume:f.value}),t.onPlay(r.value,c.value,l.value.value,p.value)};return(v,S)=>(I(),A("div",Nc,[Uc,y("div",Hc,[y("div",Wc,[y("div",Vc,[y("button",{onClick:S[0]||(S[0]=E=>d(1))},"Play"),y("button",{onClick:S[1]||(S[1]=E=>d(2))},"Controls"),y("button",{onClick:S[2]||(S[2]=E=>d(3))},"Settings")])]),y("div",{class:j({"menu-play":!0,"menu--hidden":i.value!==1})},[y("form",{onSubmit:w,class:"menu-play-inner"},[y("label",null,[C(" Which planet? "),Yt(y("input",{ref_key:"seedInput",ref:o,"onUpdate:modelValue":S[3]||(S[3]=E=>r.value=E)},null,512),[[Ts,r.value]])]),y("label",null,[C(" Difficulty "),Yt(y("select",{"onUpdate:modelValue":S[4]||(S[4]=E=>c.value=E)},[(I(!0),A(ft,null,qt(P(As),({label:E},D)=>(I(),A("option",{value:D},L(E),9,jc))),256))],512),[[bs,c.value]])]),y("p",Gc,L(P(As)[c.value].description),1),zc],32)],2),y("div",{class:j({"menu-controls":!0,"menu--hidden":i.value!==2})},[y("div",Kc,[k($c)])],2),y("div",{class:j({"menu-settings":!0,"menu--hidden":i.value!==3})},[y("div",qc,[y("label",null,[C(" Renderer "),Yt(y("select",{"onUpdate:modelValue":S[5]||(S[5]=E=>l.value=E)},[(I(),A(ft,null,qt(e,E=>y("option",{value:E},L(E.label),9,Zc)),64))],512),[[bs,l.value]])]),y("label",Jc,[Yt(y("input",{type:"checkbox","onUpdate:modelValue":S[6]||(S[6]=E=>p.value=E)},null,512),[[pn,p.value]]),C(" Show tutorial ")]),y("label",null,[C(" Volume "),Yt(y("input",{type:"range",min:"0",max:"100","onUpdate:modelValue":S[7]||(S[7]=E=>f.value=E)},null,512),[[Ts,f.value]])])])],2)])]))}});const th=ot(Qc,[["__scopeId","data-v-d3021af7"]]),eh=nt({__name:"App",setup(n){const t=_(0),e=_(),s=_(),i=_(),r=_(),o=(c,l,p,f)=>{t.value=1,e.value=c,s.value=l,i.value=p,r.value=f};return(c,l)=>(I(),A(ft,null,[t.value==0?(I(),Ht(th,{key:0,onPlay:o})):Y("",!0),t.value==1?(I(),Ht(no,{key:1,seed:e.value,difficulty:s.value,renderer:i.value,showTutorial:r.value},null,8,["seed","difficulty","renderer","showTutorial"])):Y("",!0)],64))}});Ze(eh).mount("#app");
