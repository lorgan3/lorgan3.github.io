var W=Object.defineProperty;var N=(a,e,t)=>e in a?W(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var n=(a,e,t)=>(N(a,typeof e!="symbol"?e+"":e,t),t);import{$ as U,d as H,r as K,o as j,c as T,a as q,b as B}from"./vendor-149cfbaa.js";import{C as b,T as g,S as w,B as $,a as F,A as Y,b as I,h as J,c as X,d as S}from"./pixi-ba13f488.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(r){if(r.ep)return;r.ep=!0;const i=t(r);fetch(r.href,i)}})();class G extends b{constructor(t,s,r){super();n(this,"foreground");if(this.collisionMask=t,this.background=s,this.scale.set(6),r)this.foreground=r;else{const i=document.createElement("canvas");i.width=s.width,i.height=s.height,this.foreground=g.from(i)}this.addChild(new w(this.background),new w(this.foreground))}}class p{constructor(e,t,s){this.w=e,this.h=t,this.mask=s}static fromAlpha(e){const t=e.width,s=e.height,r=[];for(var i=0;i<s;++i){r[i]=new Uint32Array(Math.ceil(t/32));for(var o=0;o<t;o+=32){for(var c=0,h=0;h<32;++h)c=c<<1,o+h<t&&e.data[(i*e.width+o+h)*4+3]>5&&(c+=1);r[i][Math.floor(o/32)]=c}}return new p(t,s,r)}static fromColor(e){const t=e.width,s=e.height,r=[];for(var i=0;i<s;++i){r[i]=new Uint32Array(Math.ceil(t/32));for(var o=0;o<t;o+=32){for(var c=0,h=0;h<32;++h)c=c<<1,o+h<t&&e.data[(i*e.width+o+h)*4]===0&&(c+=1);r[i][Math.floor(o/32)]=c}}return new p(t,s,r)}static forRect(e,t){const s=e,r=t,i=[];for(var o=0;o<r;++o){i[o]=new Uint32Array(Math.ceil(s/32));for(var c=0;c<s;c+=32)c+32<s?i[o][Math.floor(c/32)]=2**32-1:i[o][Math.floor(c/32)]=2**32-1<<Math.floor(32-s+c)}return new p(s,r,i)}collidesWith(e,t,s){if(t<0)return e.collidesWith(this,-t,-s);if(t>this.w)return!1;var r,i;if(s<0){if(e.h<-s)return!1;r=0,i=Math.min(e.h+s,this.h)}else{if(this.h<s)return!1;r=s,i=Math.min(e.h+s,this.h)}var o=t,c=Math.min(this.w,e.w+t);const h=t%32,x=32-h,A=Math.floor(o/32),R=Math.ceil(c/32);for(var v=r;v<i;++v){const _=this.mask[v],L=e.mask[v-s];for(var y=A;y<R;++y){var V=_[y]<<h;if(x<32&&(V|=_[y+1]>>>x),L[y-A]&V)return!0}}return!1}}$.defaultOptions.scaleMode=F.NEAREST;const C=class{constructor(e){n(this,"app");n(this,"viewport");n(this,"terrain");n(this,"queue",[]);n(this,"activePlayer",0);n(this,"host",!1);C._instance=this,this.app=new Y({resizeTo:window}),e.appendChild(this.app.view),I.load("./arena_well.png").then(s=>{this.viewport=new J({screenWidth:window.innerWidth,screenHeight:window.innerHeight,worldWidth:s.width*6,worldHeight:s.height*6,events:this.app.renderer.events}).clamp({direction:"all",underflow:"center"}).drag({wheel:!0,clampWheel:!0,pressDrag:!1}).pinch(),this.app.stage.addChild(this.viewport);const r=document.createElement("canvas");r.width=600,r.height=200;const i=r.getContext("2d");i.fillStyle="#000000",i.fillRect(0,150,600,50),i.fillRect(50,140,50,50),i.moveTo(100,120),i.lineTo(50,120),i.stroke(),i.moveTo(100,140),i.lineTo(130,120),i.stroke(),i.moveTo(180,140),i.lineTo(100,70),i.stroke(),i.moveTo(50,80),i.lineTo(50,120),i.stroke(),this.terrain=new G(p.fromAlpha(i.getImageData(0,0,600,200)),s),this.viewport.addChild(this.terrain);const o=g.from(r),c=new w(o);c.scale.set(6),this.viewport.addChild(c),this.queue.length>0&&(this.viewport.addChild(...this.queue),this.queue=[])})}static get instance(){return C._instance}collidesWith(e,t,s){return this.terrain?this.terrain.collisionMask.collidesWith(e,t,s):!1}add(...e){if(!this.viewport){this.queue.push(...e);return}this.viewport.addChild(...e)}remove(...e){this.viewport.removeChild(...e)}};let d=C;n(d,"_instance");class k{constructor(e,t){n(this,"characters",[]);n(this,"active",0);n(this,"name","");this.controller=e,this.connection=t}destroy(){d.instance.remove(...this.characters)}tick(e){for(let t=0;t<this.characters.length;t++)this.characters[t].tick(e)}addCharacter(e){this.characters.push(e),d.instance.add(e)}removeCharacter(e){const t=this.characters.indexOf(e);this.active===t&&(this.active=-1),this.characters.splice(t,1),d.instance.remove(e)}get activeCharacter(){return this.characters[this.active]}serialize(){return{characters:this.characters.map(e=>e.serialize())}}deserialize(e){for(let t in this.characters)this.characters[t].deserialize(e.characters[t])}}var u=(a=>(a.Shift="Shift",a.Control="Control",a.Meta="Meta",a.Plus="+",a.Minus="-",a.Equals="=",a.Up="ArrowUp",a.Left="ArrowLeft",a.Right="ArrowRight",a.Down="ArrowDown",a.Escape="Escape",a.W="w",a.A="a",a.S="s",a.D="d",a.Z="z",a.Q="q",a.B="b",a.E="e",a.F="f",a))(u||{});const m=Object.values(u),Q=new Set(m);if(m.length>=32)throw new Error("Can only serialize up to 32 keys, this will need some fixing!");const f={};for(let a=0;a<m.length;a++)f[m[a]]=2**a;function E(a){return Q.has(a)}class O{constructor(){n(this,"pressedKeys",0)}destroy(){}isKeyDown(e){return!!(this.pressedKeys&f[e])}deserialize(e){this.pressedKeys=e}}const Z=.3,ee=.6,te=.88,M=.9,z=.01;class ie{constructor(e,t,s){n(this,"active",1);n(this,"xVelocity",0);n(this,"yVelocity",0);n(this,"x",0);n(this,"y",0);n(this,"_grounded",!1);n(this,"jumped",!1);n(this,"mask");this.level=e,this.mask=p.forRect(t,s)}serialize(){return[this.active,this.x,this.y,this.xVelocity,this.yVelocity]}deserialize(e){this.active=e[0],this.x=e[1],this.y=e[2],this.xVelocity=e[3],this.yVelocity=e[4]}walk(e){this.xVelocity+=.15*e*(this._grounded?1:ee),this.active=1}jump(){this.jumped||(this.yVelocity-=4,this.active=1,this.jumped=!0)}addVelocity(e,t){this.xVelocity+=e,this.yVelocity+=t,this.active=1}get grounded(){return this._grounded}tick(e){this.active&&(this._grounded=!1,this.jumped=!1,this.yVelocity+=Z*e,this.yVelocity>0?(this._grounded=this.level.collidesWith(this.mask,this.x|0,Math.ceil(this.y+this.yVelocity)),this._grounded?(this.yVelocity=0,this.y=Math.ceil(this.y),this.xVelocity*=te):this.xVelocity*=M):(this.level.collidesWith(this.mask,this.x|0,(this.y|0)-1)&&(this.yVelocity=0,this.y=Math.ceil(this.y)),this.xVelocity*=M),this.x+=this.xVelocity*e,this.y+=this.yVelocity*e,this.xVelocity!==0&&this.level.collidesWith(this.mask,Math.floor(this.x),Math.floor(this.y))&&(this.level.collidesWith(this.mask,Math.floor(this.x),Math.floor(this.y)-1)?(this.x=Math.round(this.x)-this.xVelocity,this.xVelocity=0):(this.y=Math.floor(this.y-1),this._grounded=!0)),this._grounded&&Math.abs(this.xVelocity)<z&&Math.abs(this.yVelocity)<z&&(this.xVelocity=0,this.yVelocity=0,this.active-=.2))}}class P extends b{constructor(t,s){super();n(this,"body");n(this,"sprite");this.body=new ie(d.instance,8,8),this.body.x=t,this.body.y=s,I.load("./atlas.json").then(i=>{this.sprite=new X(i.animations.wizard_walk),this.sprite.animationSpeed=.08,this.sprite.play(),this.sprite.anchor.set(.5,.6),this.sprite.x=25,this.sprite.scale.set(.4);const o=document.createElement("canvas");o.width=8,o.height=8;const c=o.getContext("2d");c.fillStyle="#000000",c.fillRect(0,0,8,8);const h=new w(g.from(o));h.anchor.set(0),h.scale.set(6),this.addChild(this.sprite,h)})}tick(t){this.body.tick(t),this.position.set(this.body.x*6,this.body.y*6)}control(t){this.body.grounded&&t.isKeyDown(u.Up)&&this.body.jump()}controlContinuous(t){this.control(t),t.isKeyDown(u.Left)&&(this.body.walk(-1),this.sprite.scale.x=-.4),t.isKeyDown(u.Right)&&(this.body.walk(1),this.sprite.scale.x=.4)}serialize(){return this.body.serialize()}deserialize(t){this.body.deserialize(t)}}class se{constructor(e){n(this,"peer");n(this,"connection");n(this,"controller");n(this,"players",[]);n(this,"activePlayer",null);n(this,"time",0);this.peer=new U(e)}tick(e){var s,r;(r=(s=this.activePlayer)==null?void 0:s.activeCharacter)==null||r.controlContinuous(this.activePlayer.controller);for(let i of this.players)i.tick(e);this.time+=e,(this.time|0)%3&&this.connection.send({type:l.InputState,data:this.controller.serialize()})}connect(e,t){this.controller=t,this.connection=this.peer.connect(e),this.connection.on("open",()=>{this.connection.send({type:l.Join,name:"Client"})}),this.connection.on("error",s=>{console.log("error",s)}),this.connection.on("data",s=>{this.handleMessage(s)}),this.connection.on("close",()=>{console.log("closed")})}handleMessage(e){var t;switch(e.type){case l.SyncPlayers:for(let s=0;s<e.players.length;s++){const r=e.players[s];if(((t=this.players[s])==null?void 0:t.name)===r.name)continue;const i=new k(r.you?this.controller:new O);i.name=r.name,r.characters.forEach(({x:o,y:c})=>{const h=new P(o,c);i.addCharacter(h)}),this.players.splice(s,0,i)}this.players=this.players.slice(0,e.players.length),d.instance.activePlayer=e.activePlayer,this.activePlayer=this.players[e.activePlayer],this.activePlayer.active=e.activeCharacter;break;case l.ActiveCharacter:d.instance.activePlayer=e.activePlayer,this.players[e.activePlayer].active=e.activeCharacter;break;case l.InputState:this.activePlayer.controller.deserialize(e.data),this.activePlayer.activeCharacter.control(this.activePlayer.controller);break;case l.ActiveUpdate:this.activePlayer.characters[this.activePlayer.active].deserialize(e.data);break}}}class re{constructor(e){n(this,"peer");n(this,"players",[]);n(this,"activePlayer",null);n(this,"time",0);this.peer=new U(e)}join(e){const t=new k(e);t.name="Host",this.players.push(t),t.addCharacter(new P(0,0)),this.activePlayer=t}tick(e){var s,r,i,o;(s=this.activePlayer)==null||s.activeCharacter.controlContinuous(this.activePlayer.controller);for(let c of this.players)c.tick(e);this.time+=e;const t=this.time|0;if(t%30===0){const c={type:l.EntityUpdate,players:this.players.map(h=>h.serialize())};for(let h of this.players)(r=h.connection)==null||r.send(c)}else if(t%10===0){const c={type:l.ActiveUpdate,data:this.activePlayer.activeCharacter.serialize()};for(let h of this.players)(i=h.connection)==null||i.send(c)}if(t%3===0&&this.players.indexOf(this.activePlayer)===0){const c=this.activePlayer.controller.serialize();for(let h of this.players)(o=h.connection)==null||o.send({type:l.InputState,data:c})}}listen(){console.log("server start ",this.peer),this.peer.on("connection",e=>{const t=new O,s=new k(t,e);e.on("open",()=>{console.log("open"),this.players.push(s)}),e.on("error",r=>{console.log("error",r)}),e.on("data",r=>{this.handleMessage(r,s,t)}),e.on("close",()=>{console.log("closed"),this.players.splice(this.players.indexOf(s)),this.activePlayer===s&&(this.activePlayer=this.players[0]),this.syncPlayers()})})}handleMessage(e,t,s){var r;switch(e.type){case l.Join:t.name=e.name;const i=new P(50,0);t.addCharacter(i),this.activePlayer=t,this.syncPlayers();break;case l.InputState:if(s.deserialize(e.data),t===this.activePlayer)for(let o of this.players)(r=o.connection)==null||r.send(e);break}}syncPlayers(){var t;const e=this.players.indexOf(this.activePlayer);for(let s of this.players){const r={type:l.SyncPlayers,players:this.players.map(i=>({name:i.name,you:i===s,characters:i.characters.map(o=>({x:o.body.x,y:o.body.y}))})),activeCharacter:this.activePlayer.active,activePlayer:e};(t=s.connection)==null||t.send(r)}}}class ae{constructor(e){n(this,"mouseX",0);n(this,"mouseY",0);n(this,"pressedKeys",0);n(this,"sentKeys",0);n(this,"touches",0);n(this,"eventHandlers",new Map);n(this,"handleKeyDown",e=>{this.keyDown(e.key),e.preventDefault()});n(this,"handleKeyUp",e=>{this.keyUp(e.key),e.preventDefault()});this.target=e,window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp)}destroy(){window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp)}mouseDown(e,t){this.mouseX=e,this.mouseY=t,this.touches++}mouseMove(e,t){this.mouseX=e,this.mouseY=t}mouseUp(e,t){this.touches--}keyDown(e){var t;E(e)&&(this.pressedKeys|=f[e],(t=this.eventHandlers.get(e))==null||t.forEach(s=>s()))}keyUp(e){E(e)&&(this.pressedKeys&=~f[e])}isKeyDown(e){return!!(this.sentKeys&f[e])}addKeyListener(e,t){return this.eventHandlers.has(e)?this.eventHandlers.get(e).add(t):this.eventHandlers.set(e,new Set([t])),()=>this.removeKeyListener(e,t)}removeKeyListener(e,t){var s;(s=this.eventHandlers.get(e))==null||s.delete(t)}isMouseDown(){return this.touches>0}getMouse(){return[this.mouseX,this.mouseY]}serialize(){return this.sentKeys=this.pressedKeys,this.pressedKeys}deserialize(e){}}const D="lorgan3";var l=(a=>(a[a.Initialize=0]="Initialize",a[a.InputState=1]="InputState",a[a.EntityUpdate=2]="EntityUpdate",a[a.ActiveUpdate=3]="ActiveUpdate",a[a.ActiveCharacter=4]="ActiveCharacter",a[a.SpawnCharacter=5]="SpawnCharacter",a[a.SyncPlayers=6]="SyncPlayers",a[a.Join=7]="Join",a))(l||{});const oe=a=>{new d(a);const e=new ae(a),t=new re(D);new Promise((r,i)=>{const o=window.setTimeout(r,500);t.peer.on("error",()=>{window.clearTimeout(o),i()})}).then(()=>{t.listen(),t.join(e),S.shared.add(r=>{t.tick(r)})}).catch(()=>{const r=new se;window.setTimeout(()=>{r.connect(D,e),S.shared.add(i=>{r.tick(i)})},300)})},ne=H({__name:"App",setup(a){const e=K(null);return j(()=>{oe(e.value)}),(t,s)=>(q(),T("div",{class:"render-target",ref_key:"canvas",ref:e},null,512))}});B(ne).mount("#app");
