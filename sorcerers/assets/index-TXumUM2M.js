var ct=Object.defineProperty;var lt=(r,e,t)=>e in r?ct(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var n=(r,e,t)=>(lt(r,typeof e!="symbol"?e+"":e,t),t);import{$ as tt,d as et,r as S,o as it,a as dt,b as x,c as b,f as w,F as X,g as W,n as L,t as N,u as ut,h as $,j as yt,k as pt}from"./vendor-ZtIOZcmU.js";import{C as Y,T as j,S as E,A as st,B as ft,a as mt,b as vt,h as wt,c as at,d as gt,e as U}from"./pixi-0GCzAsQE.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();class f{constructor(e,t,i){this.w=e,this.h=t,this.mask=i}static fromAlpha(e){const t=e.width,i=e.height,s=[];for(var a=0;a<i;++a){s[a]=new Uint32Array(Math.ceil(t/32));for(var o=0;o<t;o+=32){for(var h=0,c=0;c<32;++c)h=h<<1,o+c<t&&e.data[(a*e.width+o+c)*4+3]>128&&(h+=1);s[a][Math.floor(o/32)]=h}}return new f(t,i,s)}static fromColor(e){const t=e.width,i=e.height,s=[];for(var a=0;a<i;++a){s[a]=new Uint32Array(Math.ceil(t/32));for(var o=0;o<t;o+=32){for(var h=0,c=0;c<32;++c)h=h<<1,o+c<t&&e.data[(a*e.width+o+c)*4]===0&&(h+=1);s[a][Math.floor(o/32)]=h}}return new f(t,i,s)}static forRect(e,t){const i=e,s=t,a=[];for(var o=0;o<s;++o){a[o]=new Uint32Array(Math.ceil(i/32));for(var h=0;h<i;h+=32)h+32<i?a[o][Math.floor(h/32)]=2**32-1:a[o][Math.floor(h/32)]=2**32-1<<Math.floor(32-i+h)}return new f(i,s,a)}static deserialize(e){const t=e.mask.map(i=>new Uint32Array(i.buffer));return new f(e.width,e.height,t)}collidesWith(e,t,i){if(t<0)return e.collidesWith(this,-t,-i);if(t>this.w)return!1;let s,a;if(i<0){if(e.h<-i)return!1;s=0,a=Math.min(e.h+i,this.h)}else{if(this.h<i)return!1;s=i,a=Math.min(e.h+i,this.h)}const o=t%32,h=32-o,c=Math.floor(t/32),l=Math.ceil(Math.min(this.w,e.w+t)/32);for(let m=s;m<a;++m){const u=this.mask[m],g=e.mask[m-i];for(let v=c;v<l;++v){let p=u[v]<<o;if(h<32&&(p|=u[v+1]>>>h),g[v-c]&p)return!0}}return!1}add(e,t,i){const s=Math.max(t,0),a=Math.max(i,0),o=Math.min(e.h+a,this.h),h=s%32,c=32-h,l=Math.floor(s/32),m=Math.ceil(Math.min(this.w,e.w+s)/32);for(let u=a;u<o;++u){const g=this.mask[u],v=e.mask[u-a];for(let p=l;p<m;++p){let P=v[p-l-1]<<c;h<32&&(P|=v[p-l]>>>h),g[p]|=P}}}subtract(e,t,i){const s=Math.max(t,0),a=Math.max(i,0),o=Math.min(e.h+a,this.h),h=s%32,c=32-h,l=Math.floor(s/32),m=Math.ceil(Math.min(this.w,e.w+s)/32);for(let u=a;u<o;++u){const g=this.mask[u],v=e.mask[u-a];for(let p=l;p<m;++p){let P=v[p-l-1]<<c;h<32&&(P|=v[p-l]>>>h),g[p]&=~P}}}clone(){return new f(this.w,this.h,structuredClone(this.mask))}serialize(){return{width:this.w,height:this.h,mask:this.mask.map(e=>e.buffer)}}}class kt extends Y{constructor(t,i,s){super();n(this,"foreground");n(this,"backgroundCanvas");n(this,"backgroundCtx");n(this,"background");n(this,"characterMask");if(this.collisionMask=t,this.scale.set(6),this.characterMask=this.collisionMask.clone(),this.backgroundCanvas=new OffscreenCanvas(i.width,i.height),this.backgroundCtx=this.backgroundCanvas.getContext("2d"),this.backgroundCtx.drawImage(i.baseTexture.resource.source,0,0),this.backgroundCtx.globalCompositeOperation="destination-out",this.background=j.from(this.backgroundCanvas),s)this.foreground=s;else{const a=document.createElement("canvas");a.width=i.width,a.height=i.height,this.foreground=j.from(a)}this.addChild(new E(this.background),new E(this.foreground))}subtract(t,i,s,a){this.backgroundCtx.moveTo(t,i),this.backgroundCtx.ellipse(t,i,s,s,0,0,Math.PI*2),this.backgroundCtx.fill(),this.background.update(),this.collisionMask.subtract(a,t-s,i-s),this.characterMask.subtract(a,t-s,i-s)}serialize(){return{...this.collisionMask.serialize(),background:this.backgroundCtx.getImageData(0,0,this.backgroundCanvas.width,this.backgroundCanvas.height).data.buffer}}deserialize(t){this.collisionMask=f.deserialize(t),this.characterMask=this.collisionMask.clone(),this.backgroundCtx.globalCompositeOperation="multiply",this.backgroundCanvas.width=t.width,this.backgroundCanvas.height=t.height,this.backgroundCtx.putImageData(new ImageData(new Uint8ClampedArray(t.background),t.width,t.height),0,0),this.backgroundCtx.globalCompositeOperation="destination-out",this.background.update()}}const xt=""+new URL("Eternal-JGJEnY4H.ttf",import.meta.url).href;st.addBundle("assets",{atlas:"./atlas.json",map:"./arena_well.png",sky:"./sky.png",font:xt});let R;const bt=()=>R||(R=st.loadBundle("assets"),R),_=class _{constructor(){n(this,"assets");n(this,"callback");_._instance=this,bt().then(e=>{this.assets=e,this.callback&&this.callback()})}static get instance(){return _._instance}onComplete(e){if(this.assets){e();return}this.callback=e}get loading(){return this.assets===void 0}};n(_,"_instance");let M=_;ft.defaultOptions.scaleMode=mt.NEAREST;const D=class D{constructor(e){n(this,"app");n(this,"viewport");n(this,"terrain");n(this,"entities",new Set);n(this,"hurtables",new Set);n(this,"_server");D._instance=this,this.app=new vt({resizeTo:window}),e.appendChild(this.app.view);const t=M.instance.assets.map;this.viewport=new wt({screenWidth:window.innerWidth,screenHeight:window.innerHeight,worldWidth:t.width*6,worldHeight:t.height*6,events:this.app.renderer.events}).clamp({direction:"all",underflow:"center"}).drag({wheel:!0,clampWheel:!0,pressDrag:!1}).pinch(),this.app.stage.addChild(this.viewport);const i=M.instance.assets.sky,s=new E(i);s.scale.set(6),this.viewport.addChild(s);const a=document.createElement("canvas");a.width=600,a.height=200;const o=a.getContext("2d");o.fillStyle="#000000",o.fillRect(0,150,600,50),this.terrain=new kt(f.fromAlpha(o.getImageData(0,0,600,200)),t),this.viewport.addChild(this.terrain)}static get instance(){return D._instance}set server(e){this._server=e}collidesWith(e,t,i){return this.terrain?this.terrain.collisionMask.collidesWith(e,t,i):!1}tick(e){for(let t of this.entities)t.tick(e)}add(...e){this.viewport.addChild(...e);for(let t of e)"tick"in t&&this.entities.add(t),"hp"in t&&this.hurtables.add(t)}remove(...e){this.viewport.removeChild(...e);for(let t of e)"tick"in t&&this.entities.delete(t),"hp"in t&&this.hurtables.delete(t)}damage(e){this._server&&(this._server.syncDamage(e),e.damage())}withNearbyEntities(e,t,i,s){const a=i**2;for(let o of this.hurtables){const h=(o.x-e)**2+(o.y-t)**2;h<a&&s(o,Math.sqrt(h))}}};n(D,"_instance");let d=D;class F{constructor(e,t){n(this,"characters",[]);n(this,"active",0);n(this,"name","");this.controller=e,this.connection=t}destroy(){d.instance.remove(...this.characters)}addCharacter(e){this.characters.push(e),d.instance.add(e)}removeCharacter(e){const t=this.characters.indexOf(e);this.active===t&&(this.active=-1),this.characters.splice(t,1),d.instance.remove(e)}get activeCharacter(){return this.characters[this.active]}serialize(){return{characters:this.characters.map(e=>e.serialize())}}deserialize(e){for(let t in this.characters)this.characters[t].deserialize(e.characters[t])}}var k=(r=>(r.Shift="Shift",r.Control="Control",r.Meta="Meta",r.Plus="+",r.Minus="-",r.Equals="=",r.Up="ArrowUp",r.Left="ArrowLeft",r.Right="ArrowRight",r.Down="ArrowDown",r.Escape="Escape",r.W="w",r.A="a",r.S="s",r.D="d",r.Z="z",r.Q="q",r.B="b",r.E="e",r.F="f",r.M1="M1",r.M2="M2",r))(k||{});const O=Object.values(k),Mt=new Set(O);if(O.length>=32)throw new Error("Can only serialize up to 32 keys, this will need some fixing!");const C={};for(let r=0;r<O.length;r++)C[O[r]]=2**r;function B(r){return Mt.has(r)}class rt{constructor(){n(this,"pressedKeys",0);n(this,"mouseX",0);n(this,"mouseY",0)}destroy(){}isKeyDown(e){return!!(this.pressedKeys&C[e])}getMouse(){return[this.mouseX,this.mouseY]}deserialize(e){this.pressedKeys=e[0],this.mouseX=e[1],this.mouseY=e[2]}}const K=7,Ct=.3,Vt=.6,St=.88,Pt=.9,_t=.01,Dt=.15,zt=4;class At{constructor(e,{mask:t,gravity:i=Ct,airFriction:s=Pt,groundFriction:a=St,airControl:o=Vt,onCollide:h,roundness:c=0}){n(this,"active",1);n(this,"xVelocity",0);n(this,"yVelocity",0);n(this,"x",0);n(this,"y",0);n(this,"rX",0);n(this,"rY",0);n(this,"_grounded",!1);n(this,"jumped",!1);n(this,"mask");n(this,"gravity");n(this,"airFriction");n(this,"groundFriction");n(this,"airControl");n(this,"onCollide");n(this,"roundness");n(this,"lastRollDirection",0);this.surface=e,this.mask=t,this.gravity=i,this.airFriction=s,this.groundFriction=a,this.airControl=o,this.onCollide=h,this.roundness=c}serialize(){return[this.active,this.xVelocity,this.yVelocity,this.x,this.y]}deserialize(e){this.active=e[0],this.xVelocity=e[1],this.yVelocity=e[2],this.move(e[3],e[4])}walk(e,t){const i=Dt*t*(this._grounded?1:this.airControl)*e;this.addVelocity(i,0)}jump(){this.jumped||(this.yVelocity-=zt,this.active=1,this.jumped=!0)}addVelocity(e,t){this.xVelocity+=e,this.yVelocity+=t,this.active=1}move(e,t){this.x=e,this.y=t;const i=this.xVelocity>0?Math.ceil:a=>a|0,s=this.yVelocity>0?Math.ceil:a=>a|0;this.rX=i(this.x),this.rY=s(this.y)}tick(e){if(this.active===0)return!1;this.yVelocity+=this.gravity*e;const t=this.xVelocity>0?Math.ceil:s=>s|0,i=this.yVelocity>0?Math.ceil:s=>s|0;if(this.rX=t(this.x),this.rY=i(this.y),this._grounded=!1,this.surface.collidesWith(this.mask,this.rX,this.rY)&&(this.x=t(this.x)-Math.sign(this.xVelocity)),this.yVelocity>0)if(this._grounded=this.surface.collidesWith(this.mask,this.rX,i(this.y+this.yVelocity*e)),this._grounded){for(this.onCollide&&this.yVelocity>this.gravity*K&&this.onCollide(this.rX,this.rY);this.yVelocity*e>1;){this.yVelocity/=2;let s=this.yVelocity*e;this.surface.collidesWith(this.mask,this.rX,i(this.y+s))||(this.y+=s)}this.yVelocity=0,this.y=i(this.y),this.rY=this.y,this.roundness&&(this.lastRollDirection?this.surface.collidesWith(this.mask,this.rX+this.lastRollDirection,this.rY+1)||(this.xVelocity+=this.roundness*this.lastRollDirection*e):this.surface.collidesWith(this.mask,this.rX+1,this.rY+1)?this.surface.collidesWith(this.mask,this.rX-1,this.rY+1)||(this.lastRollDirection=-1,this.xVelocity-=this.roundness*e):(this.lastRollDirection=1,this.xVelocity+=this.roundness*e)),this.xVelocity*=Math.pow(this.groundFriction,e)}else this.xVelocity*=Math.pow(this.airFriction,e);else this.lastRollDirection=0,this.surface.collidesWith(this.mask,this.rX,i(this.y+this.yVelocity*e))&&(this.onCollide&&this.yVelocity<-this.gravity*K&&this.onCollide(this.rX,this.rY),this.yVelocity=0,this.y=i(this.y),this.rY=this.y),this.xVelocity*=Math.pow(this.airFriction,e);if(this.y+=this.yVelocity*e,this.rY=i(this.y),this.rX=t(this.x+this.xVelocity*e),this.xVelocity!==0&&this.surface.collidesWith(this.mask,this.rX,this.rY)){const s=Math.ceil(Math.abs(this.xVelocity));if(!this.surface.collidesWith(this.mask,this.rX,this.rY-s))this.y=this.rY-s,this.rY=this.y,this.yVelocity=0,this._grounded=!0;else{for(this.onCollide&&this.onCollide(this.rX,this.rY);Math.abs(this.xVelocity*e)>1;){this.xVelocity/=2;let a=this.xVelocity*e;this.surface.collidesWith(this.mask,t(this.x+a),this.rY)||(this.x+=a)}this.x=t(this.x),this.xVelocity=0}}return this.jumped=!1,this.x+=this.xVelocity*e,this.rX=t(this.x),this._grounded&&Math.abs(this.xVelocity)<_t&&(this.xVelocity=0,this.yVelocity=0,this.active=0),!0}get position(){return[this.rX,this.rY]}get precisePosition(){return[this.x,this.y]}get grounded(){return this._grounded}}const Et=.3,It=1,Lt=0;class Ut{constructor(e,{mask:t,gravity:i=Et,friction:s=It,bounciness:a=Lt,onCollide:o}){n(this,"xVelocity",0);n(this,"yVelocity",0);n(this,"x",0);n(this,"y",0);n(this,"gravity");n(this,"friction");n(this,"bounciness");n(this,"onCollide");n(this,"mask");this.surface=e,this.mask=t,this.gravity=i,this.friction=s,this.bounciness=a,this.onCollide=o}serialize(){return[this.x,this.y,this.xVelocity,this.yVelocity]}deserialize(e){this.x=e[1],this.y=e[2],this.xVelocity=e[3],this.yVelocity=e[4]}addVelocity(e,t){this.xVelocity+=e,this.yVelocity+=t}addAngularVelocity(e,t){this.xVelocity+=Math.cos(t)*e,this.yVelocity+=Math.sin(t)*e}tick(e){this.yVelocity+=this.gravity*e;const t=this.xVelocity>0?Math.ceil:c=>c|0,i=this.yVelocity>0?Math.ceil:c=>c|0;let s=t(this.x),a=i(this.y);this.xVelocity*=Math.pow(this.friction,e),this.yVelocity*=Math.pow(this.friction,e);let o,h;this.xVelocity!==0&&this.surface.collidesWith(this.mask,t(this.x+this.xVelocity),a)?(o=t(this.x+this.xVelocity),this.x=s,this.xVelocity*=this.bounciness):this.x+=this.xVelocity*e,this.yVelocity!==0&&this.surface.collidesWith(this.mask,s,i(this.y+this.yVelocity))?(h=i(this.y+this.yVelocity),this.y=a,this.yVelocity*=this.bounciness):this.y+=this.yVelocity*e,(o!==void 0||h!==void 0)&&this.onCollide&&this.onCollide(o||s,h||a)}get velocity(){return Math.sqrt(this.xVelocity**2+this.yVelocity**2)}}const T=(r,e=r)=>{const i=new OffscreenCanvas(r,e).getContext("2d");return i.fillStyle="#000000",i.ellipse(r/2,e/2,r/2,e/2,0,0,Math.PI*2),i.fill(),i.getImageData(0,0,r,e)},Rt=T(3),Ot=f.fromAlpha(Rt),Yt=T(9),Tt=f.fromAlpha(Yt),Xt=T(9,16),Wt=f.fromAlpha(Xt),Nt=T(32),Ft=f.fromAlpha(Nt),z=class z{constructor(e,t,i){this.x=e,this.y=t,this.range=i}damage(){d.instance.terrain.subtract(this.x,this.y,this.range,z.RangeToMaskMap[this.range]);const e=this.range*6;d.instance.withNearbyEntities(this.x*6,this.y*6,this.range*6,(t,i)=>{t.hp-=10+40*((e-i)/e)})}serialize(){return[this.x,this.y,this.range]}static deserialize(e){return new z(e[0],e[1],e[2])}};n(z,"RangeToMaskMap",{16:Ft,4:Tt});let I=z;class Ht extends Y{constructor(t,i){super();n(this,"body");n(this,"sprite");n(this,"bounces",5);n(this,"onCollide",(t,i)=>{this.bounces--;const s=!d.instance.terrain.collisionMask.collidesWith(this.body.mask,t,i);this.bounces===0||s?(d.instance.remove(this),d.instance.damage(new I(t,i,16))):d.instance.damage(new I(t,i,4))});this.body=new Ut(d.instance.terrain.characterMask,{mask:Ot,onCollide:this.onCollide,bounciness:-.9,friction:.96,gravity:.25}),this.body.x=t,this.body.y=i;const s=M.instance.assets.atlas;this.sprite=new at(s.animations.spells_fireball),this.sprite.scale.set(3),this.sprite.animationSpeed=.3,this.sprite.play(),this.sprite.anchor.set(.25,.25),this.addChild(this.sprite)}tick(t){this.body.tick(t),this.position.set(this.body.x*6,this.body.y*6)}serialize(){return this.body.serialize()}deserialize(t){this.body.deserialize(t)}}class $t extends Y{constructor(t,i,s=32){super();n(this,"indicator");n(this,"initialDist",0);n(this,"_power",0);this.pivot.set(-s,32),this.position.set(t,i),this.scale.set(2),this.visible=!1;const a=M.instance.assets.atlas.textures["spells_range.png"],o=new E(a);o.alpha=.5,this.indicator=new E(a),this.addChild(o,this.indicator)}update(t,i){const s=this.parent.position;this.visible||(this.visible=!0,this.initialDist=Math.sqrt((s.x-t)**2+(s.y-i)**2)-20),this.rotation=Math.atan2(i-s.y,t-s.x),this._power=Math.min(Math.max(0,(Math.sqrt((s.x-t)**2+(s.y-i)**2)-this.initialDist)/100),1),this.indicator.scale.set(this._power),this.indicator.position.y=32*(1-this._power)}stop(){const t=this.visible;return this.visible=!1,t}get power(){return this._power}}const A=class A{constructor(e){n(this,"players",[]);n(this,"activePlayer",null);n(this,"time",0);n(this,"windSpeed",7);n(this,"turnStartTime",0);n(this,"turnLength",45*1e3);n(this,"gameLength",10*60*1e3);this.peer=e,A._instance=this}static get instance(){return A._instance}endTurn(){this.turnStartTime=Math.min(this.time-this.turnLength+5e3,this.turnStartTime)}getHudData(){return console.log(Math.max(0,this.turnLength-(this.time-this.turnStartTime)),this.turnStartTime),{turnTime:Math.max(0,this.turnLength-(this.time-this.turnStartTime)),gameTime:Math.max(0,this.gameLength-this.time),windSpeed:this.windSpeed,players:this.players,activePlayer:this.activePlayer}}};n(A,"_instance");let V=A;class H extends Y{constructor(t,i,s){super();n(this,"body");n(this,"sprite");n(this,"namePlate");n(this,"range");n(this,"_hp",100);n(this,"attacked",!1);this.name=s,this.body=new At(d.instance.terrain.characterMask,{mask:Wt}),this.body.move(t,i),d.instance.terrain.characterMask.add(this.body.mask,...this.body.position);const a=M.instance.assets.atlas;this.sprite=new at(a.animations.wizard_walk),this.sprite.animationSpeed=.08,this.sprite.play(),this.sprite.anchor.set(.5,.5),this.sprite.position.set(26,32),this.sprite.scale.set(.4),this.range=new $t(27,50,14),this.namePlate=new gt(`${s} ${this._hp}`,{fontFamily:"Eternal",fontSize:32,fill:16777215,dropShadow:!0,dropShadowDistance:4,dropShadowAngle:45}),this.namePlate.anchor.set(.5),this.namePlate.position.set(25,-70),this.addChild(this.sprite,this.range,this.namePlate)}tick(t){this.body.active&&(d.instance.terrain.characterMask.subtract(this.body.mask,...this.body.position),this.body.tick(t),d.instance.terrain.characterMask.add(this.body.mask,...this.body.position));const[i,s]=this.body.precisePosition;this.position.set(i*6,s*6)}control(t){if(this.body.grounded&&t.isKeyDown(k.Up)&&this.body.jump(),!this.attacked){if(t.isKeyDown(k.M1))this.range.update(...t.getMouse());else if(this.range.stop()&&this.range.power>0){this.attacked=!0;const[i,s]=this.body.precisePosition,a=new Ht(i+3+Math.cos(this.range.rotation)*7,s+6.5+Math.sin(this.range.rotation)*10.5);a.body.addAngularVelocity(this.range.power*5,this.range.rotation),d.instance.add(a),V.instance.endTurn()}}}controlContinuous(t,i){this.control(i),i.isKeyDown(k.Left)&&(this.body.walk(t,-1),this.sprite.scale.x=-.4),i.isKeyDown(k.Right)&&(this.body.walk(t,1),this.sprite.scale.x=.4)}serialize(){return this.body.serialize()}deserialize(t){d.instance.terrain.characterMask.subtract(this.body.mask,...this.body.position),this.body.deserialize(t),d.instance.terrain.characterMask.add(this.body.mask,...this.body.position)}get hp(){return this._hp}set hp(t){this._hp=t,this.namePlate.text=`${this.name} ${Math.ceil(this._hp)}`,this.body.active=1}}class jt extends V{constructor(t){super(new tt(t));n(this,"connection");n(this,"controller")}tick(t,i){var a,o;(o=(a=this.activePlayer)==null?void 0:a.activeCharacter)==null||o.controlContinuous(t,this.activePlayer.controller),d.instance.tick(t),this.time+=i,(this.time|0)%3&&this.connection.send({type:y.InputState,data:this.controller.serialize()})}connect(t,i){this.controller=i,this.connection=this.peer.connect(t),this.connection.on("open",()=>{this.connection.send({type:y.Join,name:"Client"})}),this.connection.on("error",s=>{console.log("error",s)}),this.connection.on("data",s=>{this.handleMessage(s)}),this.connection.on("close",()=>{console.log("closed")})}handleMessage(t){var i;switch(t.type){case y.SyncPlayers:this.time=t.time;for(let a=0;a<t.players.length;a++){const o=t.players[a];if(((i=this.players[a])==null?void 0:i.name)===o.name)continue;const h=new F(o.you?this.controller:new rt);h.name=o.name,o.characters.forEach(({name:c,hp:l,x:m,y:u})=>{const g=new H(m,u,c);g.hp=l,h.addCharacter(g)}),this.players.splice(a,0,h)}this.players=this.players.slice(0,t.players.length),this.activePlayer=this.players[t.activePlayer],this.activePlayer.active=t.activeCharacter;break;case y.ActiveCharacter:this.activePlayer=this.players[t.activePlayer],this.players[t.activePlayer].active=t.activeCharacter,this.activePlayer.activeCharacter.attacked=!1,this.windSpeed=t.windSpeed,this.turnStartTime=t.turnStartTime;break;case y.InputState:this.activePlayer.controller.deserialize(t.data),this.activePlayer.activeCharacter.control(this.activePlayer.controller);break;case y.ActiveUpdate:this.activePlayer.characters[this.activePlayer.active].deserialize(t.data);break;case y.SyncDamage:I.deserialize(t.data).damage();break;case y.SyncMap:d.instance.terrain.deserialize(t);break}}}const q=["a","e","i","o","u"],G=["b","c","d","f","g","h","j","k","l","m","n","p","q","r","s","t","v","w","x","y","z"],nt=()=>q[Math.floor(Math.random()*q.length)],ot=()=>G[Math.floor(Math.random()*G.length)],ht=()=>ot()+nt(),Bt=()=>ht()+ot(),J=[nt,ht,Bt],Kt=()=>J[Math.floor(Math.random()*J.length)](),Q=()=>{const r=[],e=Math.random()>.5?3:2;for(let i=0;i<e;i++)r.push(Kt());const t=r.join("");return t[0].toUpperCase()+t.slice(1)};class qt extends V{constructor(t){super(new tt(t));n(this,"frames",0)}join(t){const i=new F(t);i.name="Host",this.players.push(i),i.addCharacter(new H(0,0,Q())),this.cycleActivePlayer()}tick(t,i){var s,a,o,h;if((s=this.activePlayer)==null||s.activeCharacter.controlContinuous(t,this.activePlayer.controller),d.instance.tick(t),this.time+=i,this.time-this.turnStartTime>this.turnLength&&this.cycleActivePlayer(),this.frames++,this.frames%30===0){const c={type:y.EntityUpdate,players:this.players.map(l=>l.serialize())};for(let l of this.players)(a=l.connection)==null||a.send(c)}else if(this.frames%10===0){const c={type:y.ActiveUpdate,data:this.activePlayer.activeCharacter.serialize()};for(let l of this.players)(o=l.connection)==null||o.send(c)}if(this.frames%3===0&&this.players.indexOf(this.activePlayer)===0){const c=this.activePlayer.controller.serialize();for(let l of this.players)(h=l.connection)==null||h.send({type:y.InputState,data:c})}}listen(){console.log("server start ",this.peer),this.peer.on("connection",t=>{const i=new rt,s=new F(i,t);t.on("open",()=>{console.log("open"),this.players.push(s)}),t.on("error",a=>{console.log("error",a)}),t.on("data",a=>{this.handleMessage(a,s,i)}),t.on("close",()=>{console.log("closed"),s.destroy(),this.players.splice(this.players.indexOf(s)),this.activePlayer===s&&(this.activePlayer=this.players[0]),this.syncPlayers()})})}syncDamage(t){var s;const i={type:y.SyncDamage,data:t.serialize()};for(let a of this.players)(s=a.connection)==null||s.send(i)}handleMessage(t,i,s){var a;switch(t.type){case y.Join:i.name=t.name;const o=new H(50,0,Q());i.addCharacter(o),i.connection.send({type:y.SyncMap,...d.instance.terrain.serialize()}),this.syncPlayers(),this.cycleActivePlayer();break;case y.InputState:if(s.deserialize(t.data),i===this.activePlayer)for(let h of this.players)(a=h.connection)==null||a.send(t);break}}syncPlayers(){var i;const t=this.players.indexOf(this.activePlayer);for(let s of this.players){const a={type:y.SyncPlayers,time:this.time,players:this.players.map(o=>({name:o.name,you:o===s,characters:o.characters.map(h=>{const[c,l]=h.body.precisePosition;return{name:h.name,hp:h.hp,x:c,y:l}})})),activeCharacter:this.activePlayer.active,activePlayer:t};(i=s.connection)==null||i.send(a)}}cycleActivePlayer(){var s;let t=0;this.activePlayer&&(this.activePlayer.active=(this.activePlayer.active+1)%this.activePlayer.characters.length,t=(this.players.indexOf(this.activePlayer)+1)%this.players.length),this.activePlayer=this.players[t],this.activePlayer.activeCharacter.attacked=!1,this.windSpeed=Math.round(Math.random()*16-8),this.turnStartTime=this.time;const i={type:y.ActiveCharacter,activePlayer:t,activeCharacter:this.activePlayer.active,windSpeed:this.windSpeed,turnStartTime:this.turnStartTime};for(let a of this.players)(s=a.connection)==null||s.send(i)}}class Gt{constructor(e){n(this,"mouseX",0);n(this,"mouseY",0);n(this,"pressedKeys",0);n(this,"sentKeys",0);n(this,"touches",0);n(this,"eventHandlers",new Map);n(this,"handleKeyDown",e=>{this.keyDown(e.key),e.preventDefault()});n(this,"handleKeyUp",e=>{this.keyUp(e.key),e.preventDefault()});n(this,"handleMouseMove",e=>{this.mouseMove(e.global.x+this.target.scale.x+this.target.left,e.global.y+this.target.scale.y+this.target.top)});n(this,"handleMouseDown",e=>{this.mouseDown(e.global.x+this.target.scale.x+this.target.left,e.global.y+this.target.scale.y+this.target.top)});n(this,"handleMouseUp",e=>{this.mouseUp(e.global.x+this.target.scale.x+this.target.left,e.global.y+this.target.scale.y+this.target.top)});this.target=e,window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp),this.target.addListener("pointermove",this.handleMouseMove),this.target.addListener("pointerdown",this.handleMouseDown),this.target.addListener("pointerup",this.handleMouseUp)}destroy(){window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp),this.target.removeEventListener("pointermove",this.handleMouseMove),this.target.removeEventListener("pointerdown",this.handleMouseDown),this.target.removeEventListener("pointerup",this.handleMouseUp)}mouseDown(e,t){var i;this.mouseX=e,this.mouseY=t,this.pressedKeys|=C[k.M1],(i=this.eventHandlers.get(k.M1))==null||i.forEach(s=>s())}mouseMove(e,t){this.mouseX=e,this.mouseY=t}mouseUp(e,t){this.pressedKeys&=~C[k.M1]}keyDown(e){var t;B(e)&&(this.pressedKeys|=C[e],(t=this.eventHandlers.get(e))==null||t.forEach(i=>i()))}keyUp(e){B(e)&&(this.pressedKeys&=~C[e])}isKeyDown(e){return!!(this.sentKeys&C[e])}addKeyListener(e,t){return this.eventHandlers.has(e)?this.eventHandlers.get(e).add(t):this.eventHandlers.set(e,new Set([t])),()=>this.removeKeyListener(e,t)}removeKeyListener(e,t){var i;(i=this.eventHandlers.get(e))==null||i.delete(t)}isMouseDown(){return this.touches>0}getMouse(){return[this.mouseX,this.mouseY]}serialize(){return this.sentKeys=this.pressedKeys,[this.pressedKeys,this.mouseX,this.mouseY]}deserialize(e){}}const Z="lorgan3";var y=(r=>(r[r.Initialize=0]="Initialize",r[r.InputState=1]="InputState",r[r.EntityUpdate=2]="EntityUpdate",r[r.ActiveUpdate=3]="ActiveUpdate",r[r.ActiveCharacter=4]="ActiveCharacter",r[r.SpawnCharacter=5]="SpawnCharacter",r[r.SyncPlayers=6]="SyncPlayers",r[r.Join=7]="Join",r[r.SyncDamage=8]="SyncDamage",r[r.SyncMap=9]="SyncMap",r))(y||{});const Jt=r=>{const e=new d(r),t=new Gt(e.viewport),i=new qt(Z);new Promise((a,o)=>{const h=window.setTimeout(a,500);i.peer.on("error",()=>{window.clearTimeout(h),o()})}).then(()=>{i.listen(),i.join(t),e.server=i,U.shared.add(a=>{i.tick(a,U.shared.deltaMS)})}).catch(()=>{const a=new jt;window.setTimeout(()=>{a.connect(Z,t),U.shared.add(o=>{a.tick(o,U.shared.deltaMS)})},300)})},Qt={class:"hud"},Zt={class:"players"},te={class:"player"},ee={class:"characters"},ie={class:"timer socket"},se={class:"clock socket"},ae={class:"wind socket"},re=et({__name:"Hud",setup(r){const e=new Intl.DateTimeFormat("en-GB",{minute:"2-digit",second:"2-digit"}),t=S(0),i=S(0),s=S(0),a=S([]),o=S(null),h=()=>{if(!V.instance)return;const l=V.instance.getHudData();t.value=l.windSpeed,i.value=l.turnTime,s.value=l.gameTime,a.value=l.players,o.value=l.activePlayer};let c=-1;return it(()=>c=window.setInterval(h,500)),dt(()=>window.clearInterval(c)),(l,m)=>(x(),b("div",Qt,[w("div",Zt,[w("ul",null,[(x(!0),b(X,null,W(a.value,u=>(x(),b("li",te,[w("span",{class:L({name:!0,active:o.value===u})},N(u.name),3),w("ul",ee,[(x(!0),b(X,null,W(u.characters,g=>(x(),b("li",null,[w("div",{class:"hp",style:$({width:`${Math.max(0,Math.ceil(g.hp/3))}px`})},null,4)]))),256))])]))),256))])]),w("div",ie,[w("span",{class:L({timeout:i.value<1e4&&i.value>0})},N(Math.ceil(i.value/1e3)),3)]),w("div",se,[w("span",{class:L({timeout:s.value<12e4&&s.value>0})},N(ut(e).format(s.value)),3)]),w("div",ae,[(x(!0),b(X,null,W(Math.abs(t.value),u=>(x(),b("span",{class:L({arrow:!0,left:t.value<0}),style:$({"--wind-index":u*Math.sign(t.value)})}," ➤ ",6))),256))])]))}}),ne=(r,e)=>{const t=r.__vccOpts||r;for(const[i,s]of e)t[i]=s;return t},oe=ne(re,[["__scopeId","data-v-1d4c469c"]]),he={class:"wrapper"},ce=et({__name:"App",setup(r){const e=S(null);return it(()=>{new M().onComplete(()=>{Jt(e.value)})}),(t,i)=>(x(),b("div",he,[w("div",{class:"render-target",ref_key:"canvas",ref:e},null,512),yt(oe)]))}});pt(ce).mount("#app");
